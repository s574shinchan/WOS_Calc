name: Deploy and Invalidate CloudFront

on:
  push:
    branches:
      - main
    paths:
      - '**.html'
      - '**.js'
      - '**.css'
      - '!README.md'
      - '!LICENSE'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      ###########################################
      # 1. Î≤ÑÏ†Ñ ÏùΩÍ≥† Îã§Ïùå Î≤ÑÏ†Ñ ÎßåÎì§Í∏∞
      ###########################################
      - name: Read and bump version
        id: version
        run: |
          VERSION=$(cat version.txt)
          BASE=$(echo "$VERSION" | cut -d. -f1,2)
          PATCH=$(echo "$VERSION" | cut -d. -f3)
          NEXT_PATCH=$((PATCH + 1))
          NEXT_VERSION="$BASE.$NEXT_PATCH"
          echo "$NEXT_VERSION" > version.txt
          echo "VERSION_TAG=$NEXT_VERSION" >> $GITHUB_ENV

      ###########################################
      # 2. index.html ÎÇ¥Î∂Ä Î≤ÑÏ†Ñ ÌÉúÍ∑∏ ÏÇΩÏûÖ
      ###########################################
      - name: Inject version into index.html
        run: |
          sed -i "s/main.js/main.js?v=${{ env.VERSION_TAG }}/g" index.html
          sed -i "s/style.css/style.css?v=${{ env.VERSION_TAG }}/g" index.html

      ###########################################
      # 3. S3Ïóê ÌååÏùº ÎèôÍ∏∞Ìôî
      ###########################################
      - name: Sync files to S3
        uses: jakejarvis/s3-sync-action@master
        with:
          args: --delete
        env:
          AWS_S3_BUCKET: ${{ secrets.S3_BUCKET_NAME }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          SOURCE_DIR: ./

      ###########################################
      # 4. CloudFront Ï∫êÏãú Î¨¥Ìö®Ìôî (Ï†ÑÏ≤¥ or ÏùºÎ∂Ä)
      ###########################################
      - name: Invalidate CloudFront Cache
        uses: chetan/invalidate-cloudfront-action@v2
        env:
          DISTRIBUTION: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}
          PATHS: "/index.html"  # ÏõêÌïòÎ©¥ "/*"Î°ú Î≥µÍµ¨ Í∞ÄÎä•
          AWS_REGION: ${{ secrets.AWS_REGION }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      ###########################################
      # 5. version.txt Ïª§Î∞ã & Ìë∏Ïãú
      ###########################################
      - name: Commit and push bumped version
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add version.txt
          git commit -m "üîÑ Bump version to $VERSION_TAG" || echo "No changes"
          git push
