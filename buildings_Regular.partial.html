<meta charset="utf-8" />  
<div class="max-w-[1500px] mx-auto bg-white rounded shadow p-2 flex flex-col sm:flex-row gap-2">
  <div class="flex-1 bg-white rounded p-2 space-y-4 shadow">
    <div class="bg-gray-100 p-2 font-sans text-sm">
      <div class="bg-white p-4 rounded-xl shadow-md space-y-4">
        <h1 class="text-2xl font-bold text-gray-800 mb-4">ğŸ—ï¸ ì¼ë°˜ ê±´ë¬¼ ê³„ì‚°ê¸°</h1>
        <!-- ì„¤ëª… -->
        <div class="text-gray-600 mb-4 text-sm">
          <div class="mb-4">
            <p>ê° ê±´ë¬¼ ì—…ê·¸ë ˆì´ë“œì— í•„ìš”í•œ ìì›(ê³ ê¸°, ë‚˜ë¬´, ì„íƒ„, ì² ê´‘)ê³¼ ê±´ì„¤ì‹œê°„ì„ ê³„ì‚°í•©ë‹ˆë‹¤.</p>
            <p>ê±´ë¬¼ë³„ë¡œ í˜„ì¬/ëª©í‘œ ë ˆë²¨ì„ ì§€ì •í•˜ë©´ ìë™ í•©ì‚°ë©ë‹ˆë‹¤.</p>
            <p>í•˜ë‹¨ì— ì´í•©ê³„ì— ê±´ë¬¼ì˜ í•„ìš”í•©ê³„ë“¤ì„ í•©ì‚°í•˜ì—¬ í‘œì‹œí•©ë‹ˆë‹¤.</p>
            <p>ê° ê±´ë¬¼ë³„ SVS ì ìˆ˜ëŠ” <span class="font-semibold text-blue-300">[ì†Œìš”ì‹œê°„ë§Œí¼ ê°€ì†ì•„ì´í…œì„ ì‚¬ìš©í•  ê²½ìš°]</span> ê³„ì‚°ëœ ì ìˆ˜ì…ë‹ˆë‹¤.</p>
            <p class="mt-2 text-xs text-amber-700 bg-amber-50 border border-amber-200 rounded-lg px-3 py-2">
              â€» ê²Œì„ ë‚´ ê±´ì„¤ì‹œê°„ì€ <b>ì•„ê·¸ë„¤ìŠ¤ ë‘ë²ˆì§¸ ìŠ¤í‚¬íš¨ê³¼(ê±´ì„¤ì‹œê°„ ê³ ì • ì‹œê°„ ì°¨ê°)</b>ê°€ ì ìš©ëœ ê°’ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤. 
              ê²Œì„ê³¼ ë™ì¼í•œ ì‹œê°„ì´ ë‚˜ì˜¤ë ¤ë©´ <b>ì•„ê·¸ë„¤ìŠ¤ ë ˆë²¨ì„ ë°˜ë“œì‹œ ì„ íƒ</b>í•˜ì„¸ìš”.
            </p>            
          </div>

          <!-- ìƒë‹¨ ê·¸ë¦¬ë“œ -->
          <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-7 gap-4">
            <div>
              <label class="block text-sm mb-1">ê±´ì„¤ì†ë„(%)</label>
              <input type="number" id="buildSpeed" min="0"
                     class="border rounded p-2 text-sm w-full text-right"
                     placeholder="0" />
            </div>

            <div>
              <label class="block text-sm mb-1">í« ìŠ¤í‚¬</label>
              <select id="buffSelect" class="w-full border rounded p-1 px-3 py-2">
								<option value="0">None</option>
								<option value="5">Lv1 (5%)</option>
								<option value="7">Lv2 (7%)</option>
								<option value="9">Lv3 (9%)</option>
								<option value="12">Lv4 (12%)</option>
								<option value="15">Lv5 (15%)</option>
              </select>
            </div>

            <div>
              <label class="block text-sm mb-1">ì•„ê·¸ë„¤ìŠ¤</label>
              <select id="chkExpertA" class="w-full rounded-md border px-3 py-2">
                <option>None</option>
                <option>Lv.1</option><option>Lv.2</option><option>Lv.3</option><option>Lv.4</option><option>Lv.5</option>
              </select>
            </div>
            <div>
              <label class="block text-sm mb-1">ë°œë ˆë¦¬ì•„</label>
              <select id="chkExpertV" class="w-full rounded-md border px-2 py-2">
                <option>None</option>
                <option>Lv.1</option><option>Lv.2</option><option>Lv.3</option><option>Lv.4</option><option>Lv.5</option>
                <option>Lv.6</option><option>Lv.7</option><option>Lv.8</option><option>Lv.9</option><option>Lv.10</option>
              </select>
            </div>

            <!-- ë¶€ì§‘í–‰ê´€ -->
            <div>
              <div class="text-sm font-medium mb-1">ë¶€ì§‘í–‰ê´€ ê´€ì§ ë²„í”„</div>
              <div class="flex flex-wrap gap-2">
                <button type="button" data-group="vp" data-vp="10"
                        class="w-[85px] vp-btn px-4 py-2 rounded-md border">
                  10%
                </button>
                <button type="button" data-group="vp" data-vp="15"
                        class="w-[85px] vp-btn px-4 py-2 rounded-md border">
                  15%
                </button>
              </div>
            </div>

            <!-- ì„œë²„ë²„í”„ -->
            <div>
              <div class="text-sm font-medium mb-1">ì„œë²„ë²„í”„ (10%)</div>
              <div class="flex flex-wrap gap-2">
                <button type="button" id="chkServerBuff"
                        class="w-full toggle-btn px-4 py-2 rounded-md border"
                        aria-pressed="false">
                  í™œì„±í™”
                </button>
              </div>
            </div>

            <!-- ì‹œì²­ë²„í”„ -->
            <div>
              <div class="inline-flex items-center font-semibold mb-1">ì‹œì²­ë²„í”„</div>
              <div class="flex flex-wrap gap-2">
                <button type="button" id="chkCityBuff"
                        class="w-full toggle-btn px-4 py-2 rounded-md border"
                        aria-pressed="false">
                  ê±´ì„¤ì‹œê°„ 20% ë‹¨ì¶•
                </button>
              </div>
            </div>       
          </div>
        </div>

        <!-- ê±´ë¬¼ ì¹´ë“œ ê·¸ë¦¬ë“œ -->    
        <div id="buildingGridBody" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 xl:grid-cols-2 gap-4"></div>

        <!-- ì´í•©ê³„ íŒ¨ë„ (ì •ì  DOM) -->
        <div id="summaryPanel" class="mt-4">
          <div class="grid grid-cols-1 lg:grid-cols-1 gap-3">
            <!-- ì´í•© -->
            <div class="rounded-xl border border-black/10 p-3">
              <div class="font-semibold mb-2">ì´í•©</div>
              <div class="grid grid-cols-2 gap-x-2 text-[13px] mb-1">
                <div class="flex items-center gap-12 text-gray-600">
                <img src="images/icon_Meet.webp" class="w-5 h-5" alt="ê³ ê¸°">
                  <span id="sum-ê³ ê¸°" class="tabular-nums">0</span>
                <img src="images/icon_Wood.webp" class="w-5 h-5" alt="ë‚˜ë¬´">
                  <span id="sum-ë‚˜ë¬´" class="tabular-nums">0</span>
                <img src="images/icon_Coal.webp" class="w-5 h-5" alt="ì„íƒ„">
                  <span id="sum-ì„íƒ„" class="tabular-nums">0</span>
                <img src="images/icon_Iron.webp" class="w-5 h-5 " alt="ì² ê´‘">
                  <span id="sum-ì² ê´‘" class="tabular-nums ">0</span>
                </div>            
                <div class="flex justify-between text-[13px] pt-1">
                  <span class="text-gray-600">ê±´ì„¤ì‹œê°„</span>
                  <span id="sum-ì‹œê°„">0</span>
                  <!-- ğŸ”¹ SVS ì ìˆ˜ -->
                  <span class="svs-score-label font-semibold">SVS Point</span>
                  <span id="sum-svs" class="svs-score-value tabular-nums font-medium">0</span>
                </div>
              </div>



            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){  
  // âœ… SPA ì¬ì§„ì…/ì¬ë¡œë“œ ì‹œ ì´ë²¤íŠ¸ ì¤‘ë³µ ë°”ì¸ë”© ë°©ì§€
  if (window.__REGULAR_INIT_BOUND__) {
    // ì´ë¯¸ ì´ˆê¸°í™”ëœ ìƒíƒœë©´ ê·¸ëƒ¥ ì‹¤í–‰ë§Œ(í•„ìš” ì‹œ)
    window.RegularInit?.();
    return;
  }
  window.__REGULAR_INIT_BOUND__ = true;
    
  window.RegularInit = function RegularInit(){  
  // âœ… í™œì„±/ë¹„í™œì„± ìŠ¤íƒ€ì¼ í´ë˜ìŠ¤(ê¸°ë³¸ í…Œë§ˆ ìœ ì§€)
  var ACTIVE = ['bg-blue-500','text-white','border-blue-500'];
  var INACTIVE = ['bg-white','text-gray-800','border-gray-300'];

  function setActive(el, on) {
    el.setAttribute('aria-pressed', on ? 'true' : 'false');
    el.classList.remove(...(on ? INACTIVE : ACTIVE));
    el.classList.add(...(on ? ACTIVE : INACTIVE));
  }

  // ì´ˆê¸° ìƒíƒœ ì •ë¦¬ (ëª¨ë“  í† ê¸€/ë²„íŠ¼ì— ë¹„í™œì„± ìŠ¤íƒ€ì¼ ë¶€ì—¬)
  document.querySelectorAll('.vp-btn, .toggle-btn').forEach(b => setActive(b, false));

  // âœ… ë¶€ì§‘í–‰ê´€(VP): ë¼ë””ì˜¤ì²˜ëŸ¼ ë™ì‘ + ê°™ì€ ë²„íŠ¼ ì¬í´ë¦­ ì‹œ í•´ì œ
  document.querySelectorAll('.vp-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      var group = btn.dataset.group || 'vp';
      var groupBtns = document.querySelectorAll(`.vp-btn[data-group="${group}"]`);
      var wasActive = btn.getAttribute('aria-pressed') === 'true';

      if (wasActive) {
        // ê°™ì€ ë²„íŠ¼ ë‹¤ì‹œ í´ë¦­ â†’ í•´ì œ
        setActive(btn, false);
      } else {
        // ë‹¤ë¥¸ ë²„íŠ¼ ì„ íƒ â†’ ë‚˜ë¨¸ì§€ í•´ì œ, ì´ ë²„íŠ¼ë§Œ í™œì„±
        groupBtns.forEach(b => setActive(b, false));
        setActive(btn, true);
      }
      // í•„ìš”í•˜ë©´ ê°’ ì‚¬ìš©: var vp = wasActive ? 0 : Number(btn.dataset.vp);
    });
  });

  // âœ… ì‹œì²­/ì„œë²„ ë²„í”„: ë‹¨ìˆœ í† ê¸€
  document.querySelectorAll('.toggle-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      var nowOn = btn.getAttribute('aria-pressed') !== 'true';
      setActive(btn, nowOn);
      // nowOn === true ë©´ í™œì„±í™”, false ë©´ ë¹„í™œì„±í™”
    });
  });

  // (ì˜µì…˜) í˜„ì¬ ì„ íƒê°’ ì–»ê¸° ì˜ˆì‹œ
  window.getBuffState = () => {
    var activeVp = document.querySelector('.vp-btn[aria-pressed="true"]');
    var vp = activeVp ? Number(activeVp.dataset.vp) : 0;
    var city = document.getElementById('chkCityBuff').getAttribute('aria-pressed') === 'true';
    var server = document.getElementById('chkServerBuff').getAttribute('aria-pressed') === 'true';
    return { vp, city, server };
  };

  var buildingList = ["ìš©ê´‘ë¡œ","ëŒ€ì‚¬ê´€","ì§€íœ˜ë¶€","ì˜ë¬´ì‹¤","ë°©íŒ¨ë³‘","ì°½ë³‘","ê¶ë³‘"];
  var resources = ["ê³ ê¸°","ë‚˜ë¬´","ì„íƒ„","ì² ê´‘","ë³€í™˜ì‹œê°„"];
  var buildingData = {};
  var buildingCards = []; // {name, maxIndex}

  // âœ… ê±´ë¬¼ëª…(í•œê¸€) -> ì´ë¯¸ì§€ íŒŒì¼ëª…(ì˜ë¬¸) ë§¤í•‘ (images/building/*)
  var BUILDING_IMG_EN = {
    "ìš©ê´‘ë¡œ": "Furnace",
    "ëŒ€ì‚¬ê´€": "Embassy",
    "ì§€íœ˜ë¶€": "CommandCenter",
    "ë°©íŒ¨ë³‘": "InfantryCamp",
    "ì˜ë¬´ì‹¤": "Infirmary",
    "ì°½ë³‘": "LancerCamp",
    "ê¶ë³‘": "MarksmanCamp"
  };

  function getBuildingImgWebp(name){
    var en = BUILDING_IMG_EN[name] || name;
    return `images/building/${en}.webp`;
  }
  function getBuildingImgPng(name){
    var en = BUILDING_IMG_EN[name] || name;
    return `images/building/${en}.png`;
  }

  var nf1 = new Intl.NumberFormat('ko-KR', { minimumFractionDigits: 0, maximumFractionDigits: 1 });

  // âœ… SVS ì ìˆ˜ ì „ìš© í¬ë§· (M/B, ì†Œìˆ˜ 2ìë¦¬)
  function formatSVS(value){
    var num = Number(value);
    if (!Number.isFinite(num)) return "0";
    if (num >= 1000000000) return (num / 1000000000).toFixed(2).replace(/\.00$/, '') + "B";
    if (num >= 1000000) return (num / 1000000).toFixed(2).replace(/\.00$/, '') + "M";
    return num.toLocaleString();
  }

  function formatValue(value){
    var num = Number(String(value ?? 0).replace(/,/g, ''));
    if (isNaN(num)) return value;
    var r1 = Math.round((num + Number.EPSILON) * 10) / 10;
    if (r1 >= 1000) return nf1.format(r1 / 1000) + "B";
    return nf1.format(r1) + "M";
  }

  function formatHourToTime(hours){
    if (!hours || isNaN(hours)) return "0 ë¶„";
    var totalMinutes = Math.round(hours*60);
    var d = Math.floor(totalMinutes/1440);
    var h = Math.floor((totalMinutes%1440)/60);
    var m = totalMinutes%60;
    return `${d?d+'ì¼ ':''}${h?h+'ì‹œê°„ ':''}${(m||(!d&&!h))?m+'ë¶„':''}`.trim();
  }

  function handleVPCheck(which){
    var v=document.getElementById("chkVP");
    var s=document.getElementById("chkSPVP");
    if(which==="chkVP" && v?.checked) s.checked=false;
    if(which==="chkSPVP" && s?.checked) v.checked=false;
    scheduleCalc();
  }

  // ======== ğŸ”· ì¶”ê°€: ë²„íŠ¼ í† ê¸€/í«ë²„í”„ íŒë… ìœ í‹¸ ========
  function isPressed(id){
    var el = document.getElementById(id);
    if (!el) return false;
    var pressed = el.getAttribute?.('aria-pressed');
    if (pressed === 'true') return true;
    if (pressed === 'false') return false;
    // í´ë°±: ì²´í¬ë°•ìŠ¤ í˜•íƒœì¼ ë•Œ
    return !!el.checked;
  }

  function getActiveVP(){
    var active = document.querySelector('.vp-btn[aria-pressed="true"]');
    return active ? Number(active.dataset.vp || 0) : 0; // 0 | 10 | 15
  }

	function getPetPercent(){
		var sel = document.getElementById('buffSelect');
		return sel ? Number(sel.value || 0) : 0;
	}

	function toHours(v){
		if (v == null) return 0;
		v = String(v).trim();
		if (!v) return 0;

		if (v.includes(':')) {
			const p = v.split(':').map(x => x.trim());
			const h = Number(p[0]) || 0;
			const m = Number(p[1]) || 0;
			const s = Number(p[2]) || 0;
			return h + (m/60) + (s/3600);
		}

		const n = Number(v);
		return Number.isFinite(n) ? n : 0;
	}

  // âœ… Expert(ì•„ê·¸ë„¤ìŠ¤) ê³ ì • ì°¨ê° ì‹œê°„(ì‹œê°„/ë‹¨ê³„) ë°˜í™˜
  function getExpertFlatHours(){
    var sel = document.getElementById('chkExpertA');
    if (!sel) return 0;
    var raw = (sel.value || sel.options[sel.selectedIndex]?.text || '').trim().toLowerCase();
    var asNum = Number(raw);
    var lv = (!Number.isNaN(asNum) && Number.isFinite(asNum)) ? asNum
             : (raw.includes('lv.5')||raw.includes('lv5')) ? 5
             : (raw.includes('lv.4')||raw.includes('lv4')) ? 4
             : (raw.includes('lv.3')||raw.includes('lv3')) ? 3
             : (raw.includes('lv.2')||raw.includes('lv2')) ? 2
             : (raw.includes('lv.1')||raw.includes('lv1')) ? 1 : 0;
    return lv === 1 ? 2 : lv === 2 ? 3 : lv === 3 ? 4 : lv === 4 ? 6 : lv === 5 ? 8 : 0;
  }
  // âœ… ë°œë ˆë¦¬ì•„(SVS ì ìˆ˜ ë³´ë„ˆìŠ¤)
  var EXPERT_BONUS = {
    "None":0,
    "Lv.1":0.02,"Lv.2":0.04,"Lv.3":0.06,"Lv.4":0.08,"Lv.5":0.10,
    "Lv.6":0.12,"Lv.7":0.14,"Lv.8":0.16,"Lv.9":0.18,"Lv.10":0.20
  };
  var EXPERT_DESC = {
    "Lv.1":  "+2%",
    "Lv.2":  "+4%",
    "Lv.3":  "+6%",
    "Lv.4":  "+8%",
    "Lv.5":  "+10%",
    "Lv.6":  "+12%",
    "Lv.7":  "+14%",
    "Lv.8":  "+16%",
    "Lv.9":  "+18%",
    "Lv.10": "+20%"
  };

  function getValeriaBonus(){
    var sel = document.getElementById("chkExpertV");
    if (!sel) return 0;
    var key = (sel.value || sel.options[sel.selectedIndex]?.text || "None").trim();
    return EXPERT_BONUS[key] ?? 0;
  }

  function getValeriaDesc(){
    var expertSel = document.getElementById("chkExpertV");
    var lv = expertSel.value;
    var text = EXPERT_DESC[lv]
      ? "SvS ì ìˆ˜ " + EXPERT_DESC[lv]
      : "SvS ì ìˆ˜";

    document.querySelectorAll(".svs-score-label").forEach(el => {
      el.textContent = text;
    });
  }
  // ===============================================

  async function fetchBuildingData(){
    for (var name of buildingList){
      var url = `https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/building/${name}.csv`;
      var res = await fetch(url);
      var text = await res.text();
      var lines = text.trim().split("\n");
      var headers = lines[0].split(",");
      var data = lines.slice(1).map(line=>{
        var obj = {};
        var values = line.split(",");
        headers.forEach((h,i)=> obj[h.trim()] = (values[i]?.trim() || "0"));
        return obj;
      });
      buildingData[name]=data;
    }
    renderBuildingSelectors();
    scheduleCalc();
  }

  function renderBuildingSelectors(){
    var container = document.getElementById("buildingGridBody");

    // âœ… ê¸°ì¡´ ì„ íƒê°’ ë³´ì¡´
    var prev = {};
    if (container && container.children.length) {
      [...container.querySelectorAll('.exp-card')].forEach(card => {
        var nameEl = card.querySelector('h3');
        if (!nameEl) return;
        var bname = nameEl.textContent.trim();
        var startSel = card.querySelector(`#start-${bname}`);
        var endSel   = card.querySelector(`#end-${bname}`);
        if (startSel && endSel) {
          prev[bname] = { start: startSel.value, end: endSel.value };
        }
      });
    }

    container.innerHTML = "";
    buildingCards = [];

    buildingList.forEach(name=>{
      var levelsFull = buildingData[name].map(d=> d["ë ˆë²¨"]); // ì›ë³¸ ëª¨ë“  ë¼ë²¨
      var filtered = filterLevelsWithIndex(levelsFull); // [{idx,label}] (ì™¸ë¶€ ì •ì˜ ê°€ì •)

      // âœ… ì˜µì…˜ì€ "í™”ë©´ ë¼ë²¨ì€ filtered.label" / "valueëŠ” ì›ë³¸ idx"
      var options = filtered
        .map(({idx, label}) => `<option value="${idx}">${label}</option>`)
        .join("");

      var maxLabel = filtered.length ? filtered[filtered.length-1].label : (levelsFull[levelsFull.length-1] || '');
      var card = document.createElement("div");
      card.className = "exp-card";
      card.innerHTML = `
        <div class="p-2">
          <div class="flex gap-2 items-stretch">

            <!-- LEFT: ì´ë¯¸ì§€ -->
            <div class="building-imgbox w-[170px] h-[160px] flex-shrink-0 rounded-2xl border overflow-hidden
                        bg-gray-100 dark:bg-[#1e1e1e] flex items-center justify-center">
              <img
                src="${getBuildingImgWebp(name)}"
                onerror="this.onerror=null; this.src='${getBuildingImgPng(name)}';"
                alt="${name}"
                class="w-full h-full object-contain"
              />
            </div>

            <!-- MID: ì´ë¦„/ìµœëŒ€ë ˆë²¨ + í˜„ì¬/ëª©í‘œ -->
            <div class="flex-1 min-w-[200px]">
              <h3 class="text-[15px] font-semibold text-gray-800">${name}</h3>
              <div class="muted mt-1">ìµœëŒ€ ë ˆë²¨: ${maxLabel}</div>

              <div class="mt-5 grid grid-cols-[46px_1fr] gap-y-3 items-center">
                <div class="text-sm text-gray-600">í˜„ì¬</div>
                <select id="start-${name}" class="border rounded-lg px-3 py-2 text-sm w-full">
                  ${options}
                </select>

                <div class="text-sm text-gray-600">ëª©í‘œ</div>
                <select id="end-${name}" class="border rounded-lg px-3 py-2 text-sm w-full">
                  ${options}
                </select>
              </div>
            </div>

            <!-- RIGHT: í•„ìš”ìì› íŒ¨ë„ (ê¸°ì¡´ id ê·¸ëŒ€ë¡œ) -->
            <div class="w-[480px] max-w-full rounded-2xl border p-4">
              <div class="grid grid-cols-4 gap-x-3 gap-y-3 items-center text-[13px]">
                <div class="flex items-center gap-1 text-gray-600">
                  <img src="images/icon_Meet.webp" class="w-5 h-5" alt="ê³ ê¸°">
                </div>
                <div id="sub-ê³ ê¸°-${name}" class="tabular-nums">0</div>

                <div class="flex items-center gap-1 text-gray-600">
                  <img src="images/icon_Wood.webp" class="w-5 h-5" alt="ë‚˜ë¬´">
                </div>
                <div id="sub-ë‚˜ë¬´-${name}" class="tabular-nums">0</div>

                <div class="flex items-center gap-1 text-gray-600">
                  <img src="images/icon_Coal.webp" class="w-5 h-5" alt="ì„íƒ„">
                </div>
                <div id="sub-ì„íƒ„-${name}" class="tabular-nums">0</div>

                <div class="flex items-center gap-1 text-gray-600">
                  <img src="images/icon_Iron.webp" class="w-5 h-5" alt="ì² ê´‘">
                </div>
                <div id="sub-ì² ê´‘-${name}" class="tabular-nums">0</div>
              </div>

              <div class="border-t border-gray-200 my-3"></div>

              <div class="grid grid-cols-1 gap-1 text-[13px]">
                <!-- ê±´ì„¤ì‹œê°„ -->
                <div class="flex justify-between items-center">
                  <span class="text-gray-600">ê±´ì„¤ì‹œê°„</span>
                  <span id="sub-ì‹œê°„-${name}" class="tabular-nums font-medium">0</span>
                </div>

                <!-- SVS -->
                <div class="flex justify-between items-center">
                  <span class="svs-score-label font-semibold">SVS ì ìˆ˜</span>
                  <div class="flex gap-2">
                    <span id="sub-ì ìˆ˜-${name}" class="svs-score-value tabular-nums font-medium">0</span>
                    <span id="sub-ì ìˆ˜A-${name}" class="svs-score-value tabular-nums font-medium">0</span>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>
      `;
      container.appendChild(card);

      // ì´ë²¤íŠ¸
      var startSel = card.querySelector(`#start-${name}`);
      var endSel   = card.querySelector(`#end-${name}`);

      // âœ… ì´ì „ ì„ íƒê°’ ë³µì› (ê°€ëŠ¥í•˜ë©´), ì•„ë‹ˆë©´ ê¸°ë³¸ê°’
      var saved = prev[name];
      if (saved) {
        if ([...startSel.options].some(o => o.value === saved.start)) startSel.value = saved.start;
        if ([...endSel.options].some(o => o.value === saved.end))     endSel.value   = saved.end;
      } else {
        endSel.value = startSel.value;
      }

      startSel.addEventListener("change", ()=>{
        endSel.value = startSel.value; // ê¸°ë³¸: ë™ì¼ë ˆë²¨ë¡œ ë§ì¶¤
        scheduleCalc();
      });
      endSel.addEventListener("change", scheduleCalc);

      var maxIndex = buildingData[name].length - 1; // ì›ë³¸ ê¸°ì¤€
      buildingCards.push({name, maxIndex});
    });
  }

  // ======== ğŸ”· ë³€ê²½: ë²„í”„ ê³„ìˆ˜ ê³„ì‚° ========
  function getFactorForTime(){
    var buildSpeed = parseFloat(document.getElementById("buildSpeed").value || 0);
    var factor = 1 + (isNaN(buildSpeed) ? 0 : buildSpeed/100);

    // ë¶€ì§‘í–‰ê´€ ë²„íŠ¼(10/15/ì—†ìŒ)
    var vp = getActiveVP();      // 0 | 10 | 15
    factor += vp/100;

    // ì„œë²„ë²„í”„ ë²„íŠ¼ (í™œì„± ì‹œ +10%)
    if (isPressed('chkServerBuff')) factor += 0.10;

    // í«ë²„í”„ (ì²´í¬ë°•ìŠ¤ ë¬´ì‹œ, None ì•„ë‹ˆë©´ % ë°˜ì˜)
    var petPct = getPetPercent();
    if (petPct) factor += petPct/100;

    return factor;
  }
  // ======================================

  function calculateAll(){
    // í•©ê³„
    var total = {"ê³ ê¸°":0, "ë‚˜ë¬´":0, "ì„íƒ„":0, "ì² ê´‘":0 };
    var totalHours = 0;
    var totalSvs = 0;

    // ì¹´ë“œë³„ í•„ìš” í•©ê³„ ì´ˆê¸°í™”
    buildingCards.forEach(({name})=>{
      ["ê³ ê¸°","ë‚˜ë¬´","ì„íƒ„","ì² ê´‘"].forEach(res=>{
        var el = document.getElementById(`sub-${res}-${name}`);
        if (el) el.textContent = "0";
      });

      var tEl = document.getElementById(`sub-ì‹œê°„-${name}`);
      if (tEl) tEl.textContent = "0";

      var sEl = document.getElementById(`sub-ì ìˆ˜-${name}`);
      if (sEl) sEl.textContent = "0";
    });

    var factor = getFactorForTime();
    // âœ… ì‹œì²­ë²„í”„ëŠ” í† ê¸€ ë²„íŠ¼ ìƒíƒœ ì‚¬ìš© (í´ë°±: ì²´í¬ë°•ìŠ¤)
    var cityBuff = isPressed('chkCityBuff');

    buildingCards.forEach(({name})=>{
      var start = parseInt(document.getElementById(`start-${name}`).value);
      var end   = parseInt(document.getElementById(`end-${name}`).value);

      // êµ¬ê°„ ë°ì´í„°
      var data = buildingData[name].slice(start+1, end+1);
      var sub = { "ë¶ˆìˆ˜ì •":0, "ì •ì œ":0, "ê³ ê¸°":0, "ë‚˜ë¬´":0, "ì„íƒ„":0, "ì² ê´‘":0 };
      var hours = 0; // ë³€í™˜ì‹œê°„(ì‹œê°„)

			data.forEach(row=>{
				resources.forEach(res=>{            
					if (res === "ë³€í™˜ì‹œê°„") {
						var v = toHours(row[res]);
						hours += (isNaN(v)?0:v);
					} else {
						var n = Number(String(row[res] ?? "0").replace(/,/g, "").trim());
						sub[res] += (Number.isFinite(n) ? n : 0);
					}
				});
			});
					
      // ì¹´ë“œ ìš°ì¸¡ â€˜í•„ìš” í•©ê³„â€™ ê°±ì‹ 
      document.getElementById(`sub-ê³ ê¸°-${name}`).textContent = formatValue(sub["ê³ ê¸°"]);
      document.getElementById(`sub-ë‚˜ë¬´-${name}`).textContent = formatValue(sub["ë‚˜ë¬´"]);
      document.getElementById(`sub-ì„íƒ„-${name}`).textContent = formatValue(sub["ì„íƒ„"]);
      document.getElementById(`sub-ì² ê´‘-${name}`).textContent = formatValue(sub["ì² ê´‘"]);

      var adjHours = hours / factor;
      if (cityBuff) adjHours *= 0.8;

      // âœ… ExpertBuff: ë‹¨ê³„ìˆ˜ì™€ ë¬´ê´€í•˜ê²Œ í•œ ë²ˆë§Œ ê³ ì • ì°¨ê° (ì˜ˆ: Lv5 â†’ 8ì‹œê°„)
      var expertFlat = getExpertFlatHours();        // 0 | 2 | 3 | 4 | 6 | 8
      adjHours = Math.max(0, adjHours - expertFlat);

      document.getElementById(`sub-ì‹œê°„-${name}`).textContent = formatHourToTime(adjHours);

      // âœ… SVS ì ìˆ˜
      var vBonus = getValeriaBonus(); // 0 ~ 0.20
      var tScore = Math.floor(((adjHours * 60) * 30) * (1 + vBonus));        
      var finalScore = tScore;

      var scoreEl = document.getElementById(`sub-ì ìˆ˜-${name}`);
      if (scoreEl) scoreEl.textContent = finalScore.toLocaleString();

      var scoreAEl = document.getElementById(`sub-ì ìˆ˜A-${name}`);
      if (scoreAEl) scoreAEl.textContent = formatSVS(finalScore);

      // ì²´í¬ëœ ì¹´ë“œë§Œ ì´í•© í¬í•¨ (í˜„ì¬/ëª©í‘œ ë‹¤ë¥´ë©´ í¬í•¨)
      if (start < end){
        Object.keys(total).forEach(k=> total[k] += sub[k]);
        totalHours += adjHours;
        totalSvs   += finalScore;
      }
    });

    document.getElementById("sum-ê³ ê¸°").textContent = formatValue(total["ê³ ê¸°"]);
    document.getElementById("sum-ë‚˜ë¬´").textContent = formatValue(total["ë‚˜ë¬´"]);
    document.getElementById("sum-ì„íƒ„").textContent = formatValue(total["ì„íƒ„"]);
    document.getElementById("sum-ì² ê´‘").textContent = formatValue(total["ì² ê´‘"]);
    document.getElementById("sum-ì‹œê°„").textContent = formatHourToTime(totalHours);

    // âœ… 3) ì´í•© SVS ì¶œë ¥
    var elLong  = document.getElementById("sum-svs");
    var elShort = document.getElementById("sum-svs-short"); // ìˆìœ¼ë©´ ê°™ì´ ì‚¬ìš©
    if (elLong)  elLong.textContent  = totalSvs.toLocaleString();
    if (elShort) elShort.textContent = formatSVS(totalSvs);

    sendHeightToParent();
  }

  // ìë™ ê³„ì‚°(ë””ë°”ìš´ìŠ¤)
  var calcTimer=null;
  function scheduleCalc(){
    if (calcTimer) clearTimeout(calcTimer);
    calcTimer = setTimeout(calculateAll, 120);
  }

  // ìƒë‹¨ í† ê¸€/ì…ë ¥ ì´ë²¤íŠ¸
  document.addEventListener("change",(e)=>{
    var id = e.target.id;

    switch(id){
      case "chkVP":
      case "chkSPVP":
        handleVPCheck(id);
        break;          
      case "chkServerBuff":
      case "chkCityBuff":
      case "buffSelect":
      case "chkExpertA":
        scheduleCalc();
        break;
      case "chkExpertV":
        getValeriaDesc();
        scheduleCalc();
        break;
      case "buildSpeed":
        scheduleCalc();
        break;
      default:
        break;
    }
  });
  ["buildSpeed"].forEach(id=>{
    var el=document.getElementById(id);
    if (el) el.addEventListener("input", scheduleCalc);
  });

  // ğŸ”· ë²„íŠ¼(í† ê¸€/VP) í´ë¦­ ì‹œì—ë„ ì¦‰ì‹œ ê³„ì‚° ë°˜ì˜
  document.querySelectorAll('.toggle-btn, .vp-btn').forEach(b=>{
    b.addEventListener('click', scheduleCalc);
  });

  // ë°ì´í„° ë¡œë“œ & ì´ˆê¸° ë Œë”
  fetchBuildingData();

  // ë ˆë²¨ ë¼ë²¨ í•„í„° â†’ ì›ë³¸ ì¸ë±ìŠ¤/ë¼ë²¨ ìŒ ë°˜í™˜
  function filterLevelsWithIndex(levelLabels) {
    // CSV ë¼ë²¨ ì •ì œ
    var labels = levelLabels.map(v => String(v ?? '').trim());
    var out = [];

    // í—¬í¼: íŠ¹ì • ë¼ë²¨ì„ "ëŒ€ì†Œë¬¸ì/ê³µë°± ë¬´ì‹œ"ë¡œ ì°¾ê¸°
    var findIdx = (want) =>
      labels.findIndex(lv => lv.replace(/\s+/g, '').toUpperCase() === want.toUpperCase());

    // í—¬í¼: ì›ë³¸ ìˆœì„œë¥¼ ìœ ì§€í•œ ì±„, ì •ê·œì‹ì— ë§ëŠ” ê²ƒë§Œ ì¶”ì¶œ
    var collectBy = (regex) => {
      labels.forEach((lv, i) => {
        var norm = lv.replace(/\s+/g, '').toUpperCase();
        if (regex.test(norm)) out.push({ idx: i, label: labels[i] });
      });
      return out;
    };

    // ì¼ë°˜ ëª¨ë“œ: 1~30ì´ ìˆìœ¼ë©´ ê·¸ ë²”ìœ„, ì—†ìœ¼ë©´ FC1~FC10 ë²”ìœ„
    var numeric = [];
    labels.forEach((lv, i) => {
      var m = lv.match(/^\s*(\d+)\s*$/);
      if (m) {
        var n = parseInt(m[1], 10);
        if (n >= 1 && n <= 30) numeric.push({ idx: i, label: lv });
      }
    });
    if (numeric.length) return numeric;

    // ìˆ«ì 1~30ì´ ì—†ë‹¤ë©´ FC1~FC10 ì‹œë„
    var s3 = labels.findIndex(lv => /^FC\s*0*1$/i.test(lv));
    var e3 = labels.findIndex(lv => /^FC\s*0*10$/i.test(lv));
    if (s3 !== -1 && e3 !== -1 && s3 <= e3) {
      var arr = [];
      for (var i = s3; i <= e3; i++) arr.push({ idx: i, label: labels[i] });
      return arr;
    }

    // ìµœí›„: ì›ë³¸ ì „ì²´(ì–´ë–¤ CSVë“  ìµœì†Œí•œ ì „ë¶€ ë…¸ì¶œ)
    return labels.map((lv, i) => ({ idx: i, label: lv }));
  }
   
 };
 window.RegularInit();
})();
</script>	
