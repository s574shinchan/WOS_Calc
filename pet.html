<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>í« ê³„ì‚°ê¸°</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
     /* âœ… ë‹¤í¬ëª¨ë“œ ì „ìš© */
    body.dark-mode {
      background-color: #121212;
      color: #f0f0f0;
    }
    
    .dark-mode .border { border-color: #444 !important; }
    .dark-mode .bg-white { background-color: #2c2c2c !important; color: #f0f0f0 !important; }
    .dark-mode .bg-gray-100 { background-color: #1e1e1e !important; }
  
    .dark-mode .text-gray-800,
    .dark-mode .text-gray-700,
    .dark-mode .text-gray-600 { color: #dddddd !important; }
  
    .dark-mode .text-blue-700 { color: #66b0ff !important; }
    .dark-mode .text-blue-600 { color: #80caff !important; }
    .dark-mode .text-orange-500 { color: #ffa94d !important; }
    .dark-mode .text-green-600 { color: #79e68c !important; }
    .dark-mode .text-red-500 { color: #ff8080 !important; }
    .dark-mode .text-gray-500 { color: #aaa !important; }    
    
    .dark-mode .text-gray-800, 
    .dark-mode .text-gray-600 { color: #e0e0e0 !important; }
    
    .dark-mode table { background-color: #2c2c2c; color: #f0f0f0; }
    .dark-mode th, .dark-mode td { border-color: #444 !important; }
    .dark-mode thead th { color: #000 !important; }
    
    .dark-mode .bg-amber-100,    
    .dark-mode .bg-green-100,
    .dark-mode .bg-indigo-100 { background-color: #3a3a3a !important; color: #f0f0f0 !important; }
    
    .dark-mode .bg-white { background-color: #2c2c2c !important; color: #f0f0f0 !important; }
    .dark-mode .bg-gray-100 { background-color: #1e1e1e !important; }
    
    .dark-mode .bg-amber-50,
    .dark-mode .bg-indigo-50 { background-color: #2d2d2d !important; }

    .dark-mode .bg-blue-100,
    .dark-mode .bg-blue-50,
    .dark-mode .bg-orange-50,
    .dark-mode .bg-purple-50,
    .dark-mode .bg-yellow-50,
    .dark-mode .bg-red-50 { background-color: #2e2e2e !important; }
    
    .dark-mode summary { background-color: #333 !important; color: #fff !important; }
    .dark-mode ul li { color: #ddd; }
    
    .dark-mode select option { color: #000 !important; }
    .dark-mode select { color: #000 !important; }
    .dark-mode input { color: #000 !important; }
  </style>

  <!-- âœ… ë‹¤í¬ëª¨ë“œ ìƒíƒœ ìœ ì§€ ìŠ¤í¬ë¦½íŠ¸ -->
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
      }
    });
  </script>
</head>
<body class="bg-gray-100 p-2 font-sans text-sm">
  <div class="max-w-6xl mx-auto bg-white p-2 rounded-xl shadow-md">
    <h1 class="text-2xl font-bold text-gray-800 mb-4">ğŸ¾ í« ê³„ì‚°ê¸°</h2>

    <!-- ì„¤ëª… ì¶”ê°€ -->
    <p class="text-gray-600 mb-6 text-center text-sm">
      í« ì¢…ë¥˜ë³„ë¡œ ëŒíŒŒ ë° ë ˆë²¨ì—…ì‹œ í•„ìš”í•œ ì¬ë£Œì†Œëª¨ëŸ‰ì„ ê³„ì‚°í•  ìˆ˜ ìˆëŠ” í˜ì´ì§€ì…ë‹ˆë‹¤.
    </p>
    
    <form id="petForm" class="space-y-4">
      <div id="petGrid" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
        <div><label class="block font-semibold">ë³´ìœ  í«ë¨¹ì´</label><input type="number" id="own-í«ë¨¹ì´" class="w-full border rounded p-2" placeholder="0" min="0" /></div>
        <div><label class="block font-semibold">ë³´ìœ  ì¡°ë ¨ë§¤ë‰´ì–¼</label><input type="number" id="own-ì¡°ë ¨ë§¤ë‰´ì–¼" class="w-full border rounded p-2" placeholder="0" min="0" /></div>
        <div><label class="block font-semibold">ë³´ìœ  í™œë ¥ì˜ì•½</label><input type="number" id="own-í™œë ¥ì˜ì•½" class="w-full border rounded p-2" placeholder="0" min="0" /></div>
        <div><label class="block font-semibold">ë³´ìœ  ê°•í™”í˜ˆì²­</label><input type="number" id="own-ê°•í™”í˜ˆì²­" class="w-full border rounded p-2" placeholder="0" min="0" /></div>
      </div>
      <button type="button" onclick="calculatePet()" class="w-full bg-pink-500 text-white py-2 rounded hover:bg-pink-600">ê³„ì‚°í•˜ê¸°</button>
    </form>
  </div>
  <script>
    function sendHeightToParent() {
      const height = document.body.scrollHeight + 10;
      window.parent.postMessage({ type: "FRAME_CHANGE", height }, "*");
    }

    // í˜ì´ì§€ ìµœì´ˆ ë¡œë“œ ì‹œ
    window.addEventListener("load", () => {
      setTimeout(sendHeightToParent, 100); // ì•½ê°„ì˜ ë Œë”ë§ ëŒ€ê¸°
    });
    
    function loadPage(page) {
      const isMobile = /android|iphone|ipad|ipod|blackberry|windows phone/i.test(ua);
      const height = isMobile ? "550px" : "345px"
        window.location.href = page;
      window.parent.postMessage({ type: "SET_FRAME_SIZE", height: height, width: "100%"}, "*");
    }
  </script>
  <script>
    const grades = ["ê¸°ê°„í† ", "ë§¤ë¨¸ë“œ", "í˜¸ë‘ì´", "ì½”ë¿”ì†Œ", "ê³ ë¦´ë¼", "ë™êµ´ì‚¬ì", 
                    "í‘í‘œë²”", "í°ë¿”ì‚¬ìŠ´", 
                    "í‹°íƒ€ë‹ˆìŠ¤", "í…Œì´í¼", 
                    "ì‚¬í–¥ì†Œ", "ë¶ê·¹ëŠ‘ëŒ€",
                    "í•˜ì´ì—ë‚˜"];
    const gradeLabels = {
      "ê¸°ê°„í† ": "SSR",
      "ë§¤ë¨¸ë“œ": "SSR",
      "í˜¸ë‘ì´": "SSR",
      "ì½”ë¿”ì†Œ": "SSR", 
      "ê³ ë¦´ë¼": "SSR", 
      "ë™êµ´ì‚¬ì": "SSR",
      "í‘í‘œë²”": "SR",
      "í°ë¿”ì‚¬ìŠ´": "SR",
      "í‹°íƒ€ë‹ˆìŠ¤": "R",
      "í…Œì´í¼": "R", 
      "ì‚¬í–¥ì†Œ": "N",
      "ë¶ê·¹ëŠ‘ëŒ€": "N",
      "í•˜ì´ì—ë‚˜": "UnKnown"
    };

    const petGrid = document.getElementById("petGrid");
    let petDataMap = {};

    async function fetchPetCSV(gradeKey) {
      const url = `https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Pet/Pet_${gradeKey}.csv`;
      const res = await fetch(url);
      const text = await res.text();
      const lines = text.trim().split("\n");
      const headers = lines[0].split(",");
      const data = lines.slice(1).map(line => {
        const values = line.split(",");
        const obj = {};
        headers.forEach((h, i) => obj[h.trim()] = values[i]?.trim() || "0");
        return obj;
      });
      return data;
    }

    async function loadPetUI() {
      for (let grade of grades) {
        const gradeKey = gradeLabels[grade];
        const displayGrade = gradeKey === "UnKnown" ? "í•˜ì´ì—ë‚˜" : grade;
        const data = await fetchPetCSV(gradeKey);
        if (!data || data.length === 0) continue;

        const petNames = [...new Set(data.map(d => d["ì´ë¦„"]))];
        petDataMap[grade] = data;

        petNames.forEach((petName, index) => {
          const petId = `${grade}-${index}`;
          const petLevels = data.filter(d => d["ì´ë¦„"] === petName).map(d => d["ë ˆë²¨"]);

          const wrapper = document.createElement("div");
          wrapper.className = "border p-2 rounded bg-purple-50 text-xs";
          wrapper.innerHTML = `
            <label class="flex items-center text-sm font-semibold mb-1">
              <input type="checkbox" id="pet-check-${petId}" class="mr-1 w-4 h-4 accent-pink-500" />
              ${displayGrade}
            </label>
            <div class="flex items-center gap-2 mb-1">
              <label class="text-sm whitespace-nowrap">í˜„ì¬</label>
              <select id="pet-cur-${petId}" class="w-full border rounded py-1 px-2 text-sm">
                ${petLevels.map(lv => `<option value="${lv}">${lv}</option>`).join("")}
              </select>
            </div>
            <div class="flex items-center gap-2">
              <label class="text-sm whitespace-nowrap">ëª©í‘œ</label>
              <select id="pet-tgt-${petId}" class="w-full border rounded py-1 px-2 text-sm">
                ${petLevels.map(lv => `<option value="${lv}">${lv}</option>`).join("")}
              </select>
            </div>
          `;
          petGrid.appendChild(wrapper);

          // í˜„ì¬ ì„ íƒ ì‹œ ëª©í‘œ ìë™ ì„¤ì •
          const curSelect = wrapper.querySelector(`#pet-cur-${petId}`);
          const tgtSelect = wrapper.querySelector(`#pet-tgt-${petId}`);
          if (curSelect && tgtSelect) {
            curSelect.addEventListener("change", () => {
              tgtSelect.value = curSelect.value;
            });
          }
        });
      }
    }
    
    async function calculatePet() {
      let total = { í«ë¨¹ì´: 0, ì¡°ë ¨ë§¤ë‰´ì–¼: 0, í™œë ¥ì˜ì•½: 0, ê°•í™”í˜ˆì²­: 0 };
      let rows = "";

      grades.forEach(grade => {
        const data = petDataMap[grade];
        if (!data) return;

        const petNames = [...new Set(data.map(d => d["ì´ë¦„"]))];

        petNames.forEach((petName, index) => {
          const petId = `${grade}-${index}`;
          const isChecked = document.getElementById(`pet-check-${petId}`)?.checked;
          if (!isChecked) return;

          const cur = document.getElementById(`pet-cur-${petId}`).value;
          const tgt = document.getElementById(`pet-tgt-${petId}`).value;
          const levels = data.filter(d => d["ì´ë¦„"] === petName).map(d => d["ë ˆë²¨"]);
          const filtered = data.filter(d => d["ì´ë¦„"] === petName);
          const start = levels.indexOf(cur);
          const end = levels.indexOf(tgt);

          if (start === -1 || end === -1 || start >= end) {
            rows += `<tr><td colspan="4" class="text-center border p-1">âš ï¸ ${grade} ì„ íƒ ì˜¤ë¥˜</td></tr>`;
            return;
          }

          const subtotal = { í«ë¨¹ì´: 0, ì¡°ë ¨ë§¤ë‰´ì–¼: 0, í™œë ¥ì˜ì•½: 0, ê°•í™”í˜ˆì²­: 0 };
          for (let i = start + 1; i <= end; i++) {
            subtotal["í«ë¨¹ì´"] += parseFloat(filtered[i]["í«ë¨¹ì´"] || "0");
            subtotal["ì¡°ë ¨ë§¤ë‰´ì–¼"] += parseFloat(filtered[i]["ì¡°ë ¨ë§¤ë‰´ì–¼"] || "0");
            subtotal["í™œë ¥ì˜ì•½"] += parseFloat(filtered[i]["í™œë ¥ì˜ì•½"] || 0);
            subtotal["ê°•í™”í˜ˆì²­"] += parseFloat(filtered[i]["ê°•í™”í˜ˆì²­"] || 0);
          }

          total["í«ë¨¹ì´"] += subtotal["í«ë¨¹ì´"];
          total["ì¡°ë ¨ë§¤ë‰´ì–¼"] += subtotal["ì¡°ë ¨ë§¤ë‰´ì–¼"];
          total["í™œë ¥ì˜ì•½"] += subtotal["í™œë ¥ì˜ì•½"];
          total["ê°•í™”í˜ˆì²­"] += subtotal["ê°•í™”í˜ˆì²­"];

          rows += `
            <tr class="text-center">
              <td class="border p-1">${grade}</td>
              <td class="border p-1">${cur} â†’ ${tgt}</td>
              <td class="border p-1">${subtotal["í«ë¨¹ì´"].toLocaleString()}</td>
              <td class="border p-1">${subtotal["ì¡°ë ¨ë§¤ë‰´ì–¼"].toLocaleString()}</td>
              <td class="border p-1">${subtotal["í™œë ¥ì˜ì•½"].toLocaleString()}</td>
              <td class="border p-1">${subtotal["ê°•í™”í˜ˆì²­"].toLocaleString()}</td>
            </tr>
          `;
        });
      });

      const own = {
        í«ë¨¹ì´: parseFloat(document.getElementById("own-í«ë¨¹ì´").value) || 0,
        ì¡°ë ¨ë§¤ë‰´ì–¼: parseFloat(document.getElementById("own-ì¡°ë ¨ë§¤ë‰´ì–¼").value) || 0,
        í™œë ¥ì˜ì•½: parseFloat(document.getElementById("own-í™œë ¥ì˜ì•½").value) || 0,
        ê°•í™”í˜ˆì²­: parseFloat(document.getElementById("own-ê°•í™”í˜ˆì²­").value) || 0,
      };

      rows += `
        <tr class="text-center font-bold bg-pink-100">
          <td class="border p-1" colspan="2">ì´í•©</td>
          <td class="border p-1">${total["í«ë¨¹ì´"].toLocaleString()}</td>
          <td class="border p-1">${total["ì¡°ë ¨ë§¤ë‰´ì–¼"].toLocaleString()}</td>
          <td class="border p-1">${total["í™œë ¥ì˜ì•½"].toLocaleString()}</td>
          <td class="border p-1">${total["ê°•í™”í˜ˆì²­"].toLocaleString()}</td>
        </tr>
        <tr class="text-center font-bold bg-orange-50">
          <td class="border p-1" colspan="2">ë³´ìœ ëŸ‰</td>
          <td class="border p-1">${own["í«ë¨¹ì´"].toLocaleString()}</td>
          <td class="border p-1">${own["ì¡°ë ¨ë§¤ë‰´ì–¼"].toLocaleString()}</td>
          <td class="border p-1">${own["í™œë ¥ì˜ì•½"].toLocaleString()}</td>
          <td class="border p-1">${own["ê°•í™”í˜ˆì²­"].toLocaleString()}</td>
        </tr>
        <tr class="text-center font-bold bg-red-50">
          <td class="border p-1" colspan="2">ê³¼ë¶€ì¡±</td>
          <td class="border p-1">${(own["í«ë¨¹ì´"] - total["í«ë¨¹ì´"]).toLocaleString()}</td>
          <td class="border p-1">${(own["ì¡°ë ¨ë§¤ë‰´ì–¼"] - total["ì¡°ë ¨ë§¤ë‰´ì–¼"]).toLocaleString()}</td>
          <td class="border p-1">${(own["í™œë ¥ì˜ì•½"] - total["í™œë ¥ì˜ì•½"]).toLocaleString()}</td>
          <td class="border p-1">${(own["ê°•í™”í˜ˆì²­"] - total["ê°•í™”í˜ˆì²­"]).toLocaleString()}</td>
        </tr>
      `;

      const resultHTML = `
      <table class="w-full table-auto border mt-4 text-sm text-center">
      <thead class="bg-gray-100">
      <tr>
      <th class="border p-1">ë“±ê¸‰</th>
      <th class="border p-1">ë ˆë²¨</th>
      <th class="border p-1">í«ë¨¹ì´</th>
      <th class="border p-1">ì¡°ë ¨ë§¤ë‰´ì–¼</th>
      <th class="border p-1">í™œë ¥ì˜ì•½</th>
      <th class="border p-1">ê°•í™”í˜ˆì²­</th>
      </tr>
      </thead>
      <tbody>${rows}</tbody>
      </table>
      `;

      window.parent.postMessage({ type: "RESULT_POPUP", html: resultHTML }, "*");
    }

    loadPetUI();
    sendHeightToParent();
  </script>
  <script>
    document.addEventListener("contextmenu", event => event.preventDefault());
    document.addEventListener("keydown", function (e) {
      if (e.key === "F12" ||
          (e.ctrlKey && e.shiftKey && (e.key === "I" || e.key === "J")) ||
          (e.ctrlKey && (e.key === "U" || e.key === "S")))
      {
        e.preventDefault();
      }
    });
  </script>
</body>
</html>
