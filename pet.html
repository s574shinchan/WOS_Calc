<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>í« ê³„ì‚°ê¸°</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4 font-sans text-sm">
  <div class="max-w-6xl mx-auto bg-white p-6 rounded-xl shadow-md">
    <!-- ë’¤ë¡œê°€ê¸° ë²„íŠ¼ -->
    <button onclick="loadPage('menu.html')" class="mb-4 flex items-center text-blue-600 hover:underline">
      <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
      </svg>
      ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°
    </button>
    <h1 class="text-2xl font-bold text-gray-800 mb-4">ğŸ¾ í« ê³„ì‚°ê¸°</h1>
    <form id="petForm" class="space-y-4">
      <div id="petGrid" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
        <div><label class="block font-semibold">ë³´ìœ  í«ë¨¹ì´</label><input type="number" id="own-í«ë¨¹ì´" class="w-full border rounded p-2" /></div>
        <div><label class="block font-semibold">ë³´ìœ  ì¡°ë ¨ë§¤ë‰´ì–¼</label><input type="number" id="own-ì¡°ë ¨ë§¤ë‰´ì–¼" class="w-full border rounded p-2" /></div>
        <div><label class="block font-semibold">ë³´ìœ  í™œë ¥ì˜ì•½</label><input type="number" id="own-í™œë ¥ì˜ì•½" class="w-full border rounded p-2" /></div>
        <div><label class="block font-semibold">ë³´ìœ  ê°•í™”í˜ˆì²­</label><input type="number" id="own-ê°•í™”í˜ˆì²­" class="w-full border rounded p-2" /></div>
      </div>
      <button type="button" onclick="calculatePet()" class="w-full bg-pink-500 text-white py-2 rounded hover:bg-pink-600">ê³„ì‚°í•˜ê¸°</button>
    </form>
  </div>

  <script>
    const grades = ["ê¸°ê°„í† ", "ë§¤ë¨¸ë“œ", "í˜¸ë‘ì´", "ì½”ë¿”ì†Œ", "ê³ ë¦´ë¼", "ë™êµ´ì‚¬ì", 
                    "í‘í‘œë²”", "í°ë¿”ì‚¬ìŠ´", 
                    "í‹°íƒ€ë‹ˆìŠ¤", "í…Œì´í¼", 
                    "ì‚¬í–¥ì†Œ", "ë¶ê·¹ëŠ‘ëŒ€",
                    "í•˜ì´ì—ë‚˜"];
    const gradeLabels = {
      "ê¸°ê°„í† ": "SSR",
      "ë§¤ë¨¸ë“œ": "SSR",
      "í˜¸ë‘ì´": "SSR",
      "ì½”ë¿”ì†Œ": "SSR", 
      "ê³ ë¦´ë¼": "SSR", 
      "ë™êµ´ì‚¬ì": "SSR",
      "í‘í‘œë²”": "SR",
      "í°ë¿”ì‚¬ìŠ´": "SR",
      "í‹°íƒ€ë‹ˆìŠ¤": "R",
      "í…Œì´í¼": "R", 
      "ì‚¬í–¥ì†Œ": "N",
      "ë¶ê·¹ëŠ‘ëŒ€": "N",
      "í•˜ì´ì—ë‚˜": "UnKnown"
    };

    const petGrid = document.getElementById("petGrid");
    let petDataMap = {};

    async function fetchPetCSV(gradeKey) {
      const url = `https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Pet/Pet_${gradeKey}.csv`;
      const res = await fetch(url);
      const text = await res.text();
      const lines = text.trim().split("n");
      const headers = lines[0].split(",");
      const data = lines.slice(1).map(line => {
        const values = line.split(",");
        const obj = {};
        headers.forEach((h, i) => obj[h.trim()] = values[i]?.trim() || "0");
        return obj;
      });
      return data;
    }

    async function loadPetUI() {
      for (let grade of grades) {
        const gradeKey = gradeLabels[grade];
        const displayGrade = gradeLabels[grade] === "UnKnown" ? "í•˜ì´ì—ë‚˜" : grade;
        const data = await fetchPetCSV(gradeKey);
        if (!data || data.length === 0) continue;

        const petNames = [...new Set(data.map(d => d["ì´ë¦„"]))];
        petDataMap[grade] = data;

        petNames.forEach((petName, index) => {
          const petId = `${grade}-${index}`;
          const petLevels = data.filter(d => d["ì´ë¦„"] === petName).map(d => d["ë ˆë²¨"]);

          petGrid.innerHTML += `
            <div class="border p-2 rounded bg-pink-50 text-xs w-full">
              <label class="flex items-center text-sm font-semibold mb-1">
                <input type="checkbox" id="pet-check-${petId}" class="mr-1 w-4 h-4 accent-pink-500" />
                ${displayGrade}
              </label>
              <div class="flex items-center gap-2 mb-1">
                <label class="text-sm whitespace-nowrap">í˜„ì¬</label>
                <select id="pet-cur-${petId}" class="w-full border rounded py-1 px-2 text-sm">
                  ${petLevels.map(lv => `<option value="${lv}">${lv}</option>`).join("")}
                </select>
              </div>
              <div class="flex items-center gap-2">
                <label class="text-sm whitespace-nowrap">ëª©í‘œ</label>
                <select id="pet-tgt-${petId}" class="w-full border rounded py-1 px-2 text-sm">
                  ${petLevels.map(lv => `<option value="${lv}">${lv}</option>`).join("")}
                </select>
              </div>
            </div>
          `;
        });
      }
    }

    function loadPage(page) {
      window.location.href = page;
      window.parent.postMessage({ type: "SET_FRAME_SIZE", height: "650px", width: "100%"}, "*");
    }

    loadPetUI();
  </script>
</body>
</html>
