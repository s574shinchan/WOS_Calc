<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì˜ì›…ì¥ë¹„[ë¯¸ìŠ¤ë¦´]</title>
  <script>
    (function () {
      try {
        const v = localStorage.getItem('darkMode');
        if (v === 'true') document.documentElement.classList.add('dark-mode');
      } catch (e) {}
    })();
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="css/common.css">
  <link rel="stylesheet" href="css/heroes.css">
  <script src="js/common.js"></script>
</head>

<body>
  <div class="max-w-[1500px] mx-auto bg-white rounded shadow p-2 flex flex-col sm:flex-row gap-2">
    <div class="flex-1 bg-white rounded p-2 space-y-4 shadow">
      <div class="bg-gray-100 p-2 font-sans text-sm">
        <div class="bg-white p-4 rounded-xl shadow-md space-y-4">
					<h1 class="text-2xl md:text-3xl font-extrabold tracking-tight text-gray-800">ğŸ§ ì˜ì›…ì¥ë¹„[ë¯¸ìŠ¤ë¦´]</h1>
					<div class="text-gray-600 text-sm mt-1 space-y-1">
						<p>í˜„ì¬ë ˆë²¨ê³¼ ëª©í‘œë ˆë²¨ì„ ì„ íƒí•˜ë©´, ì—…ê·¸ë ˆì´ë“œì— í•„ìš”í•œ ìì›(ë¯¸ìŠ¤ë¦´/ë ˆì „ë“œ ì¥ë¹„)ì„ ê³„ì‚°í•©ë‹ˆë‹¤.</p>
						<p>ê° í•­ëª©ì˜ â€˜í•„ìš” í•©ê³„â€™ëŠ” ë ˆë²¨ ì„ íƒ ì‹œ ìë™ ê°±ì‹ ë©ë‹ˆë‹¤.</p>
						<p>ê° í•­ëª©ë³„ë¡œ ì²´í¬ë¥¼ í•˜ë©´ ì²´í¬í•­ëª©ë³„ í•„ìš”í•©ê³„ë¥¼ ë”í•˜ì—¬ ì´í•©ê³„ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
					</div>
					
					<!-- ===================== ğŸ“• ë¯¸ìŠ¤ë¦´ ===================== -->
					<form id="heroEquipForm" class="space-y-3">
						<div class="flex flex-wrap items-center justify-start gap-2 w-full">
							<label class="text-sm font-medium whitespace-nowrap">ë°œë ˆë¦¬ì•„</label>
							<select id="chkExpertV" class="w-[120px] border rounded-md px-2 py-1.5">
								<option>None</option>
								<option>Lv.1</option><option>Lv.2</option><option>Lv.3</option><option>Lv.4</option><option>Lv.5</option>
								<option>Lv.6</option><option>Lv.7</option><option>Lv.8</option><option>Lv.9</option><option>Lv.10</option>
							</select>

							<!-- âœ… ë ˆë²¨ ì„¤ëª… í‘œì‹œ ì˜ì—­ -->
							<span id="expertDesc" class="svs-score-value text-sm font-semibold hidden px-4"></span>
						</div>

						<div id="heroEquipGridBody" class="grid grid-cols-1 md:grid-cols-4 gap-2"></div>

						<!-- ğŸ“• ë¯¸ìŠ¤ë¦´ ì´í•©ê³„ -->
						<div id="mithrilTotals">
						<div class="grid grid-cols-1 md:grid-cols-3 gap-3">

							<!-- ğŸ§® í•„ìš” ì´í•© -->
							<div class="rounded-xl border border-black/10 p-3">
								<div class="font-semibold text-gray-800 mb-2">í•„ìš” ì´í•©</div>
								<div class="grid items-center text-[12px]
														gap-x-3 gap-y-1
														grid-cols-[auto_minmax(0,1fr)_auto_minmax(0,1fr)]">

									<div class="text-gray-600">ê²½í—˜ì¹˜</div>
									<div id="tot-exp" class="text-right tabular-nums">0</div>
									<div class="text-gray-600">ë¯¸ìŠ¤ë¦´</div>
									<div id="tot-mith" class="text-right tabular-nums">0</div>

									<div class="text-gray-600">ë„ˆíŠ¸</div>
									<div id="tot-nut" class="text-right tabular-nums">0</div>
									<div class="text-gray-600">ë ˆì „ë“œì¥ë¹„</div>
									<div id="tot-leg" class="text-right tabular-nums">0</div>

									<div class="col-span-4 border-t border-gray-200 mt-1"></div>

									<div class="svs-score-label pt-1">SVS ì ìˆ˜</div>
									<span id="svs-long"  class="pt-1 svs-score-value text-right tabular-nums font-medium">0</span>
									<div></div>
									<span id="svs-short" class="pt-1 svs-score-value text-right tabular-nums font-medium">0</span>
								</div>
							</div>

							<div class="flex justify-end mt-2">
								<!-- âœ… ë²„íŠ¼ í´ë¦­ì‹œì—ë§Œ ì´í•© ê³„ì‚° -->
								<button id="btnCalc" type="button"
									class="w-full px-4 py-2 rounded-lg bg-blue-600 text-white text-sm hover:bg-blue-700">
									ì´í•©ê³„ì‚°
								</button>
							</div>
						</div>
						</div>
					</form>
				</div>				
			</div>
		</div>
	</div>

  <!-- ========== ê³µí†µ ìœ í‹¸ & í”„ë ˆì„ í†µì‹  ========== -->
  <script>
    function sendHeightToParent() {
      const height = document.body.scrollHeight + 10;
      window.parent?.postMessage?.({ type: "FRAME_CHANGE", height }, "*");
    }
    window.addEventListener("load", () => setTimeout(sendHeightToParent, 100));
  </script>

  <!-- ========== ğŸ“• ë¯¸ìŠ¤ë¦´ ë¡œì§ ========== -->
  <script>
    const slotNames = ["ê³ ê¸€", "ì¥ê°‘", "ë²¨íŠ¸", "ì‹ ë°œ"];
    const mithrilCsvUrl = "https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Hero/Mithril.csv";

    let stageList = [];
    let csvData = [];

    // âœ… ë°œë ˆë¦¬ì•„(SVS ì ìˆ˜ ë³´ë„ˆìŠ¤)
    const EXPERT_BONUS = {
      "None":0,
      "Lv.1":0.02,"Lv.2":0.04,"Lv.3":0.06,"Lv.4":0.08,"Lv.5":0.10,
      "Lv.6":0.12,"Lv.7":0.14,"Lv.8":0.16,"Lv.9":0.18,"Lv.10":0.20
    };
    const EXPERT_DESC = {
      "Lv.1":"+2%",
      "Lv.2":"+4%",
      "Lv.3":"+6%",
      "Lv.4":"+8%",
      "Lv.5":"+10%",
      "Lv.6":"+12%",
      "Lv.7":"+14%",
      "Lv.8":"+16%",
      "Lv.9":"+18%",
      "Lv.10":"+20%"
    };

    function getValeriaBonus(){
      const sel = document.getElementById("chkExpertV");
      if (!sel) return 0;
      const key = (sel.value || sel.options[sel.selectedIndex]?.text || "None").trim();
      return EXPERT_BONUS[key] ?? 0;
    }

    const expertSel  = document.getElementById('chkExpertV');
    const expertDesc = document.getElementById('expertDesc');

    function getValeriaDesc(){
      const lv = expertSel?.value ?? "None";

      if (EXPERT_DESC[lv]) {
        expertDesc.textContent = `SVS ì ìˆ˜ ${EXPERT_DESC[lv]}`;
        expertDesc.classList.remove('hidden');
      } else {
        expertDesc.textContent = "";
        expertDesc.classList.add('hidden');
      }
    }

    function formatSVS(value){
      const num = Number(value);
      if (!Number.isFinite(num)) return "0";
      if (num >= 1000000000) return (num / 1000000000).toFixed(2).replace(/\.00$/, '') + "B";
      if (num >= 1000000) return (num / 1000000).toFixed(2).replace(/\.00$/, '') + "M";
      return num.toLocaleString();
    }

    async function loadMithrilCSV() {
      try{
        const res = await fetch(mithrilCsvUrl, {cache:"no-store"});
        const text = await res.text();
        const lines = text.trim().split("\n").map(l => l.split(","));
        const headers = lines[0];
        csvData = lines.slice(1).map(row => {
          const obj = {};
          headers.forEach((h, i) => obj[h.trim()] = (row[i] ?? "").trim() || "0");
          return obj;
        });
        stageList = csvData.map(r => r["ë ˆë²¨"]);
      }catch(e){
        csvData = [
          {ë ˆë²¨:"1", ê²½í—˜ì¹˜:"0", ë„ˆíŠ¸:"0", ë¯¸ìŠ¤ë¦´:"0", ë ˆì „ë“œì¥ë¹„:"0"},
          {ë ˆë²¨:"2", ê²½í—˜ì¹˜:"100", ë„ˆíŠ¸:"5", ë¯¸ìŠ¤ë¦´:"8", ë ˆì „ë“œì¥ë¹„:"0"},
          {ë ˆë²¨:"3", ê²½í—˜ì¹˜:"220", ë„ˆíŠ¸:"12", ë¯¸ìŠ¤ë¦´:"18", ë ˆì „ë“œì¥ë¹„:"0"},
          {ë ˆë²¨:"4", ê²½í—˜ì¹˜:"360", ë„ˆíŠ¸:"20", ë¯¸ìŠ¤ë¦´:"30", ë ˆì „ë“œì¥ë¹„:"1"},
          {ë ˆë²¨:"5", ê²½í—˜ì¹˜:"520", ë„ˆíŠ¸:"30", ë¯¸ìŠ¤ë¦´:"45", ë ˆì „ë“œì¥ë¹„:"1"},
        ];
        stageList = csvData.map(r=>r["ë ˆë²¨"]);
      }
      renderHeroEquipUI();
      sendHeightToParent();
    }

    function renderHeroEquipUI() {
      const grid = document.getElementById("heroEquipGridBody");
      grid.innerHTML = "";

      slotNames.forEach((name, i) => {
        const options = stageList.map(stage => `<option value="${stage}">${stage}</option>`).join("");
        const card = document.createElement("div");
        card.className = "exp-card";
        card.innerHTML = `
          <div class="p-4 space-y-4">
            <div class="flex items-center gap-2 mb-2">
              <h3 class="text-[15px] font-semibold text-gray-800">${name}</h3>
            </div>

            <div class="grid grid-cols-2 gap-3 max-w-[360px]">
              <div>
                <div class="text-[12px] text-gray-600 mb-1">í˜„ì¬</div>
                <select id="start-${i}"
                        class="w-full border rounded-lg px-2 py-1 text-sm
                               bg-white dark:bg-[#2b2b2b] dark:border-gray-600">
                  ${options}
                </select>
              </div>
              <div>
                <div class="text-[12px] text-gray-600 mb-1">ëª©í‘œ</div>
                <select id="end-${i}"
                        class="w-full border rounded-lg px-2 py-1 text-sm
                               bg-white dark:bg-[#2b2b2b] dark:border-gray-600">
                  ${options}
                </select>
              </div>
            </div>

            <!-- âœ… ì¹´ë“œë³„ í•„ìš”í•©ê³„ ì œê±°: ë¡œì§ ë³´í˜¸ ìœ„í•´ DOMì€ ë‚¨ê¸°ë˜ hidden ì²˜ë¦¬ -->
            <div class="hidden">
              <div class="rounded-xl border border-black/10 p-3">
                <div class="font-semibold text-gray-800 mb-2">í•„ìš” í•©ê³„</div>
                <div class="grid items-center text-[12px]
                            gap-x-3 gap-y-1
                            grid-cols-[auto_minmax(0,1fr)_auto_minmax(0,1fr)]">

                  <div class="text-gray-600">ê²½í—˜ì¹˜</div>
                  <div class="text-right tabular-nums" id="m-sub-exp-${i}">0</div>
                  <div class="text-gray-600">ë¯¸ìŠ¤ë¦´</div>
                  <div class="text-right tabular-nums" id="m-sub-mith-${i}">0</div>

                  <div class="text-gray-600">ë„ˆíŠ¸</div>
                  <div class="text-right tabular-nums" id="m-sub-nut-${i}">0</div>
                  <div class="text-gray-600">ë ˆì „ë“œì¥ë¹„</div>
                  <div class="text-right tabular-nums" id="m-sub-legend-${i}">0</div>

                  <div class="col-span-4 border-t border-gray-200 dark:border-gray-200 mt-1"></div>

                  <div class="svs-score-label pt-1">SVS ì ìˆ˜</div>
                  <div id="sub-ì ìˆ˜A-${slotNames[i]}" class="svs-score-value text-right tabular-nums font-medium pt-1">0</div>
                  <div></div>
                  <div id="sub-ì ìˆ˜-${slotNames[i]}" class="svs-score-value text-right tabular-nums font-medium pt-1">0</div>
                </div>
              </div>
            </div>
          </div>
        `;

        grid.appendChild(card);

        const curSelect = card.querySelector(`#start-${i}`);
        const tgtSelect = card.querySelector(`#end-${i}`);

        // âœ… ëª©í‘œ ì˜µì…˜: í˜„ì¬+1ë¶€í„°ë§Œ í‘œì‹œ
        function refreshTargetOptions() {
          const curValue = curSelect.value;
          const curIdx = stageList.indexOf(curValue);

          // í˜„ì¬ ë‹¤ìŒ ë ˆë²¨ë¶€í„°
          const targets = stageList.slice(curIdx + 1);

          if (targets.length === 0) {
            // í˜„ì¬ê°€ ìµœëŒ€ë ˆë²¨ì´ë©´ ì„ íƒ ë¶ˆê°€(í‘œì‹œëŠ” í˜„ì¬ë§Œ)
            tgtSelect.innerHTML = `<option value="${curValue}">${curValue}</option>`;
            tgtSelect.value = curValue;
            tgtSelect.disabled = true;
          } else {
            tgtSelect.disabled = false;
            tgtSelect.innerHTML = targets
              .map(stage => `<option value="${stage}">${stage}</option>`)
              .join("");
            // ê¸°ë³¸ê°’ = í˜„ì¬+1
            tgtSelect.value = targets[0];
          }
        }
				
        // ì´ˆê¸° 1íšŒ: ëª©í‘œ ì˜µì…˜ì„ í˜„ì¬+1ë¶€í„°ë¡œ ì„¸íŒ…
        refreshTargetOptions();

        // í˜„ì¬ ë³€ê²½ ì‹œ: ëª©í‘œ ì˜µì…˜ ì¬êµ¬ì„± í›„ subtotal ê°±ì‹ 
        curSelect.addEventListener("change", () => {
          refreshTargetOptions();
        });        
      });

      // âœ… ë°œë ˆë¦¬ì•„ ë³€ê²½ ì‹œë„ ì¹´ë“œ subtotalë§Œ ê°±ì‹ (ì´í•© ìë™ ê°±ì‹  ê¸ˆì§€)
      document.getElementById("chkExpertV")?.addEventListener("change", () => {
        slotNames.forEach((_, i) => updateMithrilSubtotals(i));
        getValeriaDesc();
      });

      // âœ… ì´í•©ê³„ì‚° ë²„íŠ¼ í´ë¦­ì‹œì—ë§Œ ì´í•© ê³„ì‚°
			document.getElementById("btnCalc")?.addEventListener("click", function(e) {
				e.preventDefault();
				updateMithrilTotals();
			});
    }

    function updateMithrilSubtotals(i) {
      const cur = document.getElementById(`start-${i}`).value;
      const tgt = document.getElementById(`end-${i}`).value;
      const sIdx = stageList.indexOf(cur);
      const eIdx = stageList.indexOf(tgt);

      const sums = { exp:0, nut:0, mith:0, legend:0 };
      if (sIdx >= 0 && eIdx > sIdx) {
        for (let j = sIdx + 1; j <= eIdx; j++) {
          const r = csvData[j];
          sums.exp    += parseFloat(r["ê²½í—˜ì¹˜"] || "0");
          sums.nut    += parseFloat(r["ë„ˆíŠ¸"] || "0");
          sums.mith   += parseFloat(r["ë¯¸ìŠ¤ë¦´"] || "0");
          sums.legend += parseFloat(r["ë ˆì „ë“œì¥ë¹„"] || "0");
        }
      }

      document.getElementById(`m-sub-exp-${i}`).textContent    = sums.exp.toLocaleString();
      document.getElementById(`m-sub-nut-${i}`).textContent    = sums.nut.toLocaleString();
      document.getElementById(`m-sub-mith-${i}`).textContent   = sums.mith.toLocaleString();
      document.getElementById(`m-sub-legend-${i}`).textContent = sums.legend.toLocaleString();

      const valeriaBonus = getValeriaBonus();
      const baseSlot = sums.mith * 144000;
      const svsSlot  = Math.round(baseSlot * (1 + valeriaBonus));

      const id  = `sub-ì ìˆ˜-${slotNames[i]}`;
      const idA = `sub-ì ìˆ˜A-${slotNames[i]}`;
      const el  = document.getElementById(id);
      const elA = document.getElementById(idA);
      if (el)  el.textContent  = formatSVS(svsSlot);
      if (elA) elA.textContent = svsSlot.toLocaleString();
    }

    function updateMithrilTotals(){
      let total = { exp:0, nut:0, mith:0, leg:0 };
      slotNames.forEach((_, i)=>{
        const cur = document.getElementById(`start-${i}`).value;
        const tgt = document.getElementById(`end-${i}`).value;
        const sIdx = stageList.indexOf(cur);
        const eIdx = stageList.indexOf(tgt);
        if (sIdx < 0 || eIdx <= sIdx) return;

        for(let j=sIdx+1;j<=eIdx;j++){
          const r = csvData[j];
          total.exp += +(r["ê²½í—˜ì¹˜"]||0);
          total.nut += +(r["ë„ˆíŠ¸"]||0);
          total.mith+= +(r["ë¯¸ìŠ¤ë¦´"]||0);
          total.leg += +(r["ë ˆì „ë“œì¥ë¹„"]||0);
        }
      });


      document.getElementById("tot-exp").textContent  = total.exp.toLocaleString();
      document.getElementById("tot-nut").textContent  = total.nut.toLocaleString();
      document.getElementById("tot-mith").textContent = total.mith.toLocaleString();
      document.getElementById("tot-leg").textContent  = total.leg.toLocaleString();

      const valeriaBonus = getValeriaBonus();
      const baseTotal = total.mith * 144000;
      const svsTotal  = Math.round(baseTotal * (1 + valeriaBonus));

      document.getElementById("svs-long").textContent  = svsTotal.toLocaleString();
      document.getElementById("svs-short").textContent = formatSVS(svsTotal);
    }

    loadMithrilCSV();
  </script>

  <script>
    document.addEventListener("contextmenu", e => e.preventDefault());
    document.addEventListener("keydown", function (e) {
      if (e.key === "F12" || (e.ctrlKey && e.shiftKey && (e.key === "I" || e.key === "J")) ||
          (e.ctrlKey && (e.key === "U" || e.key === "S"))) {
        e.preventDefault();
      }
    });
  </script>
  <script>
    window.addEventListener('message', (e) => {
      if (e.data?.type === 'DARK_MODE') {
        document.body.classList.toggle('dark-mode', e.data.value);
      }
    });
  </script>
</body>
</html>
