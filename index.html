<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WOS ê³„ì‚°ê¸° í†µí•© | S574 ShinChan</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6 font-sans text-sm">
  <div class="max-w-6xl mx-auto">
    <!-- ìƒë‹¨ íƒ­ ë²„íŠ¼ -->
    <div class="mb-4 flex flex-wrap gap-2 justify-start">
      <button onclick="switchTab('building.html', this)" class="tab-btn bg-blue-300 text-blue-800 font-semibold py-2 px-4 rounded">ğŸ— ê±´ë¬¼</button>
      <button onclick="switchTab('gem.html', this)" class="tab-btn bg-gray-200 text-purple-800 font-semibold py-2 px-4 rounded">ğŸ’ ì˜ì£¼ë³´ì„</button>
      <button onclick="switchTab('equip.html', this)" class="tab-btn bg-gray-200 text-green-800 font-semibold py-2 px-4 rounded">ğŸ›¡ ì˜ì£¼ì¥ë¹„</button>
      <button onclick="switchTab('hero_equip.html', this)" class="tab-btn bg-gray-200 text-yellow-800 font-semibold py-2 px-4 rounded">ğŸ§ ì˜ì›…ì¥ë¹„</button>
      <button onclick="switchTab('guide.html', this)" class="tab-btn bg-gray-200 text-indigo-800 font-semibold py-2 px-4 rounded">ğŸ“˜ ê³µëµì§‘</button>
    </div>

    <!-- ê³„ì‚°ê¸° ì½˜í…ì¸ ê°€ ë“¤ì–´ì˜¬ ì˜ì—­ -->
    <div id="content" class="transition-all duration-300 ease-in-out"></div>
  </div>

  <!-- ê³µìš© íŒì—… -->
  <div id="globalPopupModal" class="fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center hidden z-50">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-5xl p-6 mx-4">
      <h3 class="text-xl font-bold mb-4 text-center">ğŸ“Š ê³„ì‚° ê²°ê³¼</h3>
      <div id="globalPopupContent" class="overflow-x-auto text-sm max-h-[65vh] overflow-y-auto"></div>
      <div class="text-center mt-4">
        <button onclick="document.getElementById('globalPopupModal').classList.add('hidden')" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">í™•ì¸</button>
      </div>
    </div>
  </div>

  <footer class="text-center text-xs text-gray-500 mt-10">â›” ë¬´ë‹¨ ë³µì œ ë° ë°°í¬ ê¸ˆì§€ | Â© S574 ShinChan</footer>

  <script>
    async function switchTab(page, button) {
      // íƒ­ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('bg-blue-300', 'bg-purple-300', 'bg-green-300', 'bg-yellow-300', 'bg-indigo-300');
        btn.classList.remove('text-blue-800', 'text-purple-800', 'text-green-800', 'text-yellow-800', 'text-indigo-800');
        btn.classList.add('bg-gray-200', 'text-gray-800');
      });

      // í˜„ì¬ íƒ­ì— ìƒ‰ ì ìš©
      button.classList.remove('bg-gray-200', 'text-gray-800');
      if (page.includes('building')) button.classList.add('bg-blue-300', 'text-blue-800');
      else if (page.includes('gem')) button.classList.add('bg-purple-300', 'text-purple-800');
      else if (page.includes('equip') && !page.includes('hero')) button.classList.add('bg-green-300', 'text-green-800');
      else if (page.includes('hero')) button.classList.add('bg-yellow-300', 'text-yellow-800');
      else if (page.includes('guide')) button.classList.add('bg-indigo-300', 'text-indigo-800');

      // ì™¸ë¶€ HTML fetch í›„ ì‚½ì…
      const res = await fetch(page);
      const text = await res.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(text, "text/html");
      const inner = doc.body.innerHTML;
      document.getElementById("content").innerHTML = inner;

      // ìŠ¤í¬ë¦½íŠ¸ ì¬ì‹¤í–‰
      const scripts = doc.querySelectorAll("script");
      scripts.forEach(oldScript => {
        const newScript = document.createElement("script");
        if (oldScript.src) {
          newScript.src = oldScript.src;
        } else {
          newScript.textContent = oldScript.textContent;
        }
        document.getElementById("content").appendChild(newScript);
      });
    }

    // iframe ë°©ì‹ì—ì„œ ì“°ë˜ íŒì—… ì—°ê²° ìœ ì§€
    window.addEventListener("message", function (e) {
      if (e.data?.type === "RESULT_POPUP") {
        document.getElementById("globalPopupContent").innerHTML = e.data.html;
        document.getElementById("globalPopupModal").classList.remove("hidden");
      }
    });

    // ê¸°ë³¸ íƒ­ ë¡œë”©
    window.onload = () => {
      const defaultBtn = document.querySelector(".tab-btn");
      if (defaultBtn) defaultBtn.click();
    };
  </script>
</body>
</html>

<div id="content">
<div class="max-w-6xl mx-auto bg-white p-6 rounded-xl shadow-md space-y-5">
<h1 class="text-2xl font-bold text-blue-600 mb-4">ğŸ—ï¸ ê±´ë¬¼ë³„ ë ˆë²¨ë³„ ìì› ê³„ì‚°ê¸°</h1>
<form class="space-y-6" id="calcForm">
<table class="w-full table-auto border border-gray-300">
<thead class="bg-blue-100">
<tr>
<th class="p-2 border">ê±´ë¬¼</th>
<th class="p-2 border">ì„ íƒ</th>
<th class="p-2 border">í˜„ì¬ ë ˆë²¨</th>
<th class="p-2 border">ëª©í‘œ ë ˆë²¨</th>
</tr>
</thead>
<tbody id="buildingTable"></tbody>
</table>
<div class="grid grid-cols-2 md:grid-cols-4 gap-4">
<div>
<label class="block font-semibold">ë³´ìœ  ë¶ˆìˆ˜ì •</label>
<input class="w-full border rounded p-2" id="owned-ë¶ˆìˆ˜ì •" placeholder="ìˆ«ì ì…ë ¥" type="number"/>
</div>
<div>
<label class="block font-semibold">ë³´ìœ  ì •ì œ</label>
<input class="w-full border rounded p-2" id="owned-ì •ì œ" placeholder="ìˆ«ì ì…ë ¥" type="number"/>
</div>
</div>
<button class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600" onclick="calculateAll()" type="button">
        ê³„ì‚°í•˜ê¸°
      </button>
<div class="mt-6 overflow-x-auto" id="resultContainer"></div>
</form>
</div>
<script>
    const sheetID = "1vtW4diWsB4OoSK70nYa6ve1nRPHrhWg-rf76NlsRM08";
    const buildings = ["ìš©ê´‘ë¡œ", "ëŒ€ì‚¬ê´€", "ì§€íœ˜ë¶€", "ì˜ë¬´ì‹¤", "ë°©íŒ¨ë³‘", "ì°½ë³‘", "ê¶ë³‘", "ì•„ì¹´ë°ë¯¸"];
    const buildingTable = document.getElementById("buildingTable");
    const resultContainer = document.getElementById("resultContainer");

    async function fetchLevelList(building) {
      const url = `https://opensheet.elk.sh/${sheetID}/${building}`;
      const res = await fetch(url);
      const data = await res.json();
      return data.map(d => d.ë ˆë²¨).filter(Boolean);
    }

    async function populateTable() {
      const sampleLevels = await fetchLevelList(buildings[0]);
      buildings.forEach((b, i) => {
        const options = sampleLevels.map(lv => `<option value="${lv}">${lv}</option>`).join("");
        buildingTable.innerHTML += `
          <tr class="text-center">
            <td class="border p-2">${b}</td>
            <td class="border p-2">
              <input type="checkbox" id="check-${i}" class="accent-blue-500 w-5 h-5">
            </td>
            <td class="border p-2">
              <select id="cur-${i}" class="border rounded px-2 py-1">${options}</select>
            </td>
            <td class="border p-2">
              <select id="tgt-${i}" class="border rounded px-2 py-1">${options}</select>
            </td>
          </tr>
        `;
      });
    }

    async function fetchData(building) {
      const url = `https://opensheet.elk.sh/${sheetID}/${building}`;
      const res = await fetch(url);
      return await res.json();
    }

    function round1(value) {
      return Math.round((value + Number.EPSILON) * 10) / 10;
    }

    async function calculateAll() {
      const owned = {
        ë¶ˆìˆ˜ì •: parseFloat(document.getElementById("owned-ë¶ˆìˆ˜ì •").value) || 0,
        ì •ì œ: parseFloat(document.getElementById("owned-ì •ì œ").value) || 0
      };
      const grandTotal = { ë¶ˆìˆ˜ì •: 0, ì •ì œ: 0, ê³ ê¸°: 0, ë‚˜ë¬´: 0, ì„íƒ„: 0, ì² ê´‘: 0 };
      const resultRows = [];

      for (let i = 0; i < buildings.length; i++) {
        if (!document.getElementById(`check-${i}`).checked) continue;
        const building = buildings[i];
        const cur = document.getElementById(`cur-${i}`).value;
        const tgt = document.getElementById(`tgt-${i}`).value;
        const data = await fetchData(building);
        const levels = data.map(d => d.ë ˆë²¨);
        const curIndex = levels.indexOf(cur);
        const tgtIndex = levels.indexOf(tgt);
        if (curIndex === -1 || tgtIndex === -1 || curIndex >= tgtIndex) {
          resultRows.push(`<tr><td class='border p-2 text-center' colspan='8'>âš ï¸ ${building}: ì˜ëª»ëœ ë ˆë²¨ ì„¤ì •</td></tr>`);
          continue;
        }

        const subtotal = { ë¶ˆìˆ˜ì •: 0, ì •ì œ: 0, ê³ ê¸°: 0, ë‚˜ë¬´: 0, ì„íƒ„: 0, ì² ê´‘: 0 };
        for (let j = curIndex + 1; j <= tgtIndex; j++) {
          const row = data[j];
          for (const key in subtotal) {
            subtotal[key] += parseFloat(row[key] || 0);
            grandTotal[key] += parseFloat(row[key] || 0);
          }
        }

        resultRows.push(`
          <tr class="text-center">
            <td class="border p-2">${building}</td>
            <td class="border p-2">${cur} â†’ ${tgt}</td>
            <td class="border p-2">${round1(subtotal.ë¶ˆìˆ˜ì •)}</td>
            <td class="border p-2">${round1(subtotal.ì •ì œ)}</td>
            <td class="border p-2">${round1(subtotal.ê³ ê¸°)}</td>
            <td class="border p-2">${round1(subtotal.ë‚˜ë¬´)}</td>
            <td class="border p-2">${round1(subtotal.ì„íƒ„)}</td>
            <td class="border p-2">${round1(subtotal.ì² ê´‘)}</td>
          </tr>
        `);
      }

      resultContainer.innerHTML = `
        <table class="w-full table-auto border mt-4 text-sm text-center">
          <thead class="bg-gray-100">
            <tr>
              <th class="border p-1">ê±´ë¬¼</th>
              <th class="border p-1">ë ˆë²¨</th>
              <th class="border p-1">ë¶ˆìˆ˜ì •</th>
              <th class="border p-1">ì •ì œ</th>
              <th class="border p-1">ê³ ê¸°</th>
              <th class="border p-1">ë‚˜ë¬´</th>
              <th class="border p-1">ì„íƒ„</th>
              <th class="border p-1">ì² ê´‘</th>
            </tr>
          </thead>
          <tbody>
            ${resultRows.join("")}
            <tr class="font-bold bg-blue-100">
              <td class="border p-1" colspan="2">ì´í•©</td>
              <td class="border p-1">${grandTotal.ë¶ˆìˆ˜ì •.toLocaleString()}</td>
              <td class="border p-1">${grandTotal.ì •ì œ.toLocaleString()}</td>
              <td class="border p-1">${grandTotal.ê³ ê¸°.toLocaleString()}</td>
              <td class="border p-1">${grandTotal.ë‚˜ë¬´.toLocaleString()}</td>
              <td class="border p-1">${grandTotal.ì„íƒ„.toLocaleString()}</td>
              <td class="border p-1">${grandTotal.ì² ê´‘.toLocaleString()}</td>
            </tr>
            <tr class="font-bold bg-red-100">
              <td class="border p-1" colspan="2">ê³¼ë¶€ì¡±</td>
              <td class="border p-1">${(owned.ë¶ˆìˆ˜ì • - grandTotal.ë¶ˆìˆ˜ì •).toLocaleString()}</td>
              <td class="border p-1">${(owned.ì •ì œ - grandTotal.ì •ì œ).toLocaleString()}</td>
              <td class="border p-1" colspan="4"></td>
            </tr>
          </tbody>
        </table>
      `;
    }

    populateTable();
  </script>
</div>
