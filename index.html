
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ê±´ë¬¼ & ë³´ì„ ê³„ì‚°ê¸° | S574 ShinChan</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6 font-sans">
  <div class="mb-4 flex space-x-4">
    <button onclick="switchTab('building')" class="tab-btn bg-blue-300 text-blue-800 font-semibold py-1 px-3 rounded">ğŸ— ê±´ë¬¼ ê³„ì‚°ê¸°</button>
    <button onclick="switchTab('gem')" class="tab-btn bg-gray-200 hover:bg-purple-200 text-purple-800 font-semibold py-1 px-3 rounded">ğŸ’ ë³´ì„ ê³„ì‚°ê¸°</button>
  </div>

  <div id="tab-building" class="tab-pane">
    <div class="max-w-6xl mx-auto bg-white p-6 rounded-xl shadow-md">
      <h1 class="text-2xl font-bold text-blue-600 mb-4">ğŸ—ï¸ ê±´ë¬¼ë³„ ë ˆë²¨ë³„ ìì› ê³„ì‚°ê¸°</h1>
      <form id="calcForm" class="space-y-6">
        <table class="w-full table-auto border border-gray-300">
          <thead class="bg-blue-100">
            <tr>
              <th class="p-2 border">ê±´ë¬¼</th>
              <th class="p-2 border">ì„ íƒ</th>
              <th class="p-2 border">í˜„ì¬ ë ˆë²¨</th>
              <th class="p-2 border">ëª©í‘œ ë ˆë²¨</th>
            </tr>
          </thead>
          <tbody id="buildingTable"></tbody>
        </table>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div>
            <label class="block font-semibold">ë³´ìœ  ë¶ˆìˆ˜ì •</label>
            <input type="number" id="owned-ë¶ˆìˆ˜ì •" class="w-full border rounded p-2" placeholder="ìˆ«ì ì…ë ¥" />
          </div>
          <div>
            <label class="block font-semibold">ë³´ìœ  ì •ì œ</label>
            <input type="number" id="owned-ì •ì œ" class="w-full border rounded p-2" placeholder="ìˆ«ì ì…ë ¥" />
          </div>
        </div>
        <button type="button" onclick="calculateAll()" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">ê³„ì‚°í•˜ê¸°</button>
        <div id="resultContainer" class="mt-6 overflow-x-auto"></div>
      </form>
    </div>
  </div>

  <div id="tab-gem" class="tab-pane hidden">
    <div class="bg-white p-6 rounded-xl shadow-md max-w-7xl mx-auto">
      <h2 class="text-2xl font-bold text-purple-600 mb-6">ğŸ’ ë³´ì„ ê³„ì‚°ê¸°</h2>
      <form id="gemForm" class="space-y-4">
        <div class="overflow-x-auto">
          <table class="table-auto w-full border border-gray-300 text-sm">
            <thead class="bg-purple-100 text-center">
              <tr>
                <th class="p-2 border">ì„ íƒ</th>
                <th class="p-2 border">ìŠ¬ë¡¯</th>
                <th class="p-2 border">í˜„ì¬ ë ˆë²¨</th>
                <th class="p-2 border">ëª©í‘œ ë ˆë²¨</th>
              </tr>
            </thead>
            <tbody id="gemTableBody"></tbody>
          </table>
        </div>
        <button type="button" onclick="calculateGems()" class="w-full bg-purple-500 text-white py-2 rounded hover:bg-purple-600">ê³„ì‚°í•˜ê¸°</button>
      </form>
      <div id="gemResult" class="mt-6"></div>
    </div>
  </div>

  <script>
    function switchTab(tab) {
      document.querySelectorAll('.tab-pane').forEach(el => el.classList.add('hidden'));
      document.getElementById('tab-' + tab).classList.remove('hidden');
      document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('bg-blue-300', 'bg-purple-300'));
      if (tab === 'building') {
        document.querySelectorAll('.tab-btn')[0].classList.add('bg-blue-300');
      } else {
        document.querySelectorAll('.tab-btn')[1].classList.add('bg-purple-300');
      }
    }

    const sheetID = "1vtW4diWsB4OoSK70nYa6ve1nRPHrhWg-rf76NlsRM08";
    const buildings = ["ìš©ê´‘ë¡œ", "ëŒ€ì‚¬ê´€", "ì§€íœ˜ë¶€", "ë°©íŒ¨ë³‘", "ì°½ë³‘", "ê¶ë³‘", "ì˜ë¬´ì‹¤", "ì•„ì¹´ë°ë¯¸"];
    const buildingTable = document.getElementById("buildingTable");
    const resultContainer = document.getElementById("resultContainer");

    async function fetchLevelList(building) {
      const url = `https://opensheet.elk.sh/${sheetID}/${building}`;
      const res = await fetch(url);
      const data = await res.json();
      return data.map(d => d.ë ˆë²¨).filter(Boolean);
    }

    async function populateTable() {
      const sampleLevels = await fetchLevelList(buildings[0]);
      buildings.forEach((b, i) => {
        const options = sampleLevels.map(lv => `<option value="${lv}">${lv}</option>`).join("");
        buildingTable.innerHTML += `
          <tr class="text-center">
            <td class="border p-2">${b}</td>
            <td class="border p-2">
              <input type="checkbox" name="check-${i}" class="accent-blue-500 w-5 h-5">
            </td>
            <td class="border p-2">
              <select name="current-${i}" class="border rounded px-2 py-1">${options}</select>
            </td>
            <td class="border p-2">
              <select name="target-${i}" class="border rounded px-2 py-1">${options}</select>
            </td>
          </tr>
        `;
      });
    }

    async function fetchData(building) {
      const url = `https://opensheet.elk.sh/${sheetID}/${building}`;
      const res = await fetch(url);
      return await res.json();
    }

    function round1(value) {
      return Math.round((value + Number.EPSILON) * 10) / 10;
    }

    async function calculateAll() {
      const form = document.getElementById("calcForm");
      const owned = {
        ë¶ˆìˆ˜ì •: parseFloat(document.getElementById("owned-ë¶ˆìˆ˜ì •").value) || 0,
        ì •ì œ: parseFloat(document.getElementById("owned-ì •ì œ").value) || 0
      };
      const grandTotal = { ë¶ˆìˆ˜ì •: 0, ì •ì œ: 0, ê³ ê¸°: 0, ë‚˜ë¬´: 0, ì„íƒ„: 0, ì² ê´‘: 0 };
      const resultRows = [];
      for (let i = 0; i < buildings.length; i++) {
        const building = buildings[i];
        const checked = form[`check-${i}`].checked;
        if (!checked) continue;
        const cur = form[`current-${i}`].value;
        const tgt = form[`target-${i}`].value;
        const data = await fetchData(building);
        const levels = data.map(d => d.ë ˆë²¨);
        const curIndex = levels.indexOf(cur);
        const tgtIndex = levels.indexOf(tgt);
        if (curIndex === -1 || tgtIndex === -1 || curIndex >= tgtIndex) {
          resultRows.push(`<tr><td class='border p-2 text-center' colspan='8'>âš ï¸ ${building}: ì˜ëª»ëœ ë ˆë²¨ ì„¤ì •</td></tr>`);
          continue;
        }
        const subtotal = { ë¶ˆìˆ˜ì •: 0, ì •ì œ: 0, ê³ ê¸°: 0, ë‚˜ë¬´: 0, ì„íƒ„: 0, ì² ê´‘: 0 };
        for (let j = curIndex + 1; j <= tgtIndex; j++) {
          const row = data[j];
          for (const key in subtotal) {
            subtotal[key] += parseFloat(row[key] || 0);
            grandTotal[key] += parseFloat(row[key] || 0);
          }
        }
        resultRows.push(`
          <tr class="text-center">
            <td class="border p-2">${building}</td>
            <td class="border p-2">${cur} â†’ ${tgt}</td>
            <td class="border p-2">${round1(subtotal.ë¶ˆìˆ˜ì •)}</td>
            <td class="border p-2">${round1(subtotal.ì •ì œ)}</td>
            <td class="border p-2">${round1(subtotal.ê³ ê¸°)}</td>
            <td class="border p-2">${round1(subtotal.ë‚˜ë¬´)}</td>
            <td class="border p-2">${round1(subtotal.ì„íƒ„)}</td>
            <td class="border p-2">${round1(subtotal.ì² ê´‘)}</td>
          </tr>
        `);
      }
      resultRows.push(`
        <tr class="text-center font-bold bg-blue-50">
          <td class="border p-2" colspan="2">ì´í•©</td>
          <td class="border p-2">${round1(grandTotal.ë¶ˆìˆ˜ì •)}</td>
          <td class="border p-2">${round1(grandTotal.ì •ì œ)}</td>
          <td class="border p-2">${round1(grandTotal.ê³ ê¸°)}</td>
          <td class="border p-2">${round1(grandTotal.ë‚˜ë¬´)}</td>
          <td class="border p-2">${round1(grandTotal.ì„íƒ„)}</td>
          <td class="border p-2">${round1(grandTotal.ì² ê´‘)}</td>
        </tr>
      `);
      const ë¶€ì¡±ë¶ˆìˆ˜ì • = round1(owned.ë¶ˆìˆ˜ì • - grandTotal.ë¶ˆìˆ˜ì •);
      const ë¶€ì¡±ì •ì œ = round1(owned.ì •ì œ - grandTotal.ì •ì œ);
      resultRows.push(`
        <tr class="text-center font-bold bg-red-100">
          <td class="border p-2" colspan="2">ê³¼ë¶€ì¡±</td>
          <td class="border p-2">${ë¶€ì¡±ë¶ˆìˆ˜ì • >= 0 ? '+' : ''}${ë¶€ì¡±ë¶ˆìˆ˜ì •}</td>
          <td class="border p-2">${ë¶€ì¡±ì •ì œ >= 0 ? '+' : ''}${ë¶€ì¡±ì •ì œ}</td>
          <td class="border p-2" colspan="4"></td>
        </tr>
      `);
      resultContainer.innerHTML = `
        <table class="w-full table-auto border border-gray-300 mt-4">
          <thead class="bg-gray-100">
            <tr class="text-center">
              <th class="p-2 border">ê±´ë¬¼</th>
              <th class="p-2 border">ë ˆë²¨ êµ¬ê°„</th>
              <th class="p-2 border">ë¶ˆìˆ˜ì •</th>
              <th class="p-2 border">ì •ì œ</th>
              <th class="p-2 border">ê³ ê¸°</th>
              <th class="p-2 border">ë‚˜ë¬´</th>
              <th class="p-2 border">ì„íƒ„</th>
              <th class="p-2 border">ì² ê´‘</th>
            </tr>
          </thead>
          <tbody>${resultRows.join('')}</tbody>
        </table>
      `;
    }

    populateTable();

    const slotNames = ["ë°©íŒ¨A", "ë°©íŒ¨B", "ë°©íŒ¨C", "ë°©íŒ¨D", "ë°©íŒ¨E", "ë°©íŒ¨F", 
		"ì°½ë³‘A", "ì°½ë³‘B", "ì°½ë³‘C", "ì°½ë³‘D", "ì°½ë³‘E", "ì°½ë³‘F",
		"ê¶ë³‘A", "ê¶ë³‘B", "ê¶ë³‘C", "ê¶ë³‘D", "ê¶ë³‘E", "ê¶ë³‘F"];
    function createGemUI() {
      const tbody = document.getElementById("gemTableBody");
      slotNames.forEach((slot, index) => {
        const options = Array.from({ length: 16 }, (_, i) => `<option value="${i+1}">Lv.${i+1}</option>`).join('');
        tbody.innerHTML += `
          <tr class="text-center">
            <td class="border p-1"><input type="checkbox" id="check-${index}" class="w-5 h-5 accent-purple-500"></td>
            <td class="border p-1">${slot}</td>
            <td class="border p-1"><select id="cur-${index}" class="border rounded p-1">${options}</select></td>
            <td class="border p-1"><select id="tgt-${index}" class="border rounded p-1">${options}</select></td>
          </tr>
        `;
      });
    }

    async function calculateGems() {
      const result = [];
      const total = { ë§¤ë‰´ì–¼: 0, ë„ë©´: 0, ë¹„ì „: 0 };
      const res = await fetch(`https://opensheet.elk.sh/${sheetID}/ì˜ì£¼ë³´ì„ì¬ë£Œ`);
      const data = await res.json();
      for (let i = 0; i < slotNames.length; i++) {
        if (!document.getElementById(`check-${i}`).checked) continue;
        const cur = parseInt(document.getElementById(`cur-${i}`).value);
        const tgt = parseInt(document.getElementById(`tgt-${i}`).value);
        if (cur >= tgt) continue;
        const startIdx = cur - 1;
        const endIdx = tgt - 1;
        let subtotal = { ë§¤ë‰´ì–¼: 0, ë„ë©´: 0, ë¹„ì „: 0 };
        for (let j = startIdx + 1; j <= endIdx; j++) {
          const row = data[j];
          subtotal.ë§¤ë‰´ì–¼ += parseFloat(row["ë§¤ë‰´ì–¼"] || 0);
          subtotal.ë„ë©´ += parseFloat(row["ë„ë©´"] || 0);
          subtotal.ë¹„ì „ += parseFloat(row["ë¹„ì „"] || 0);
        }
        total.ë§¤ë‰´ì–¼ += subtotal.ë§¤ë‰´ì–¼;
        total.ë„ë©´ += subtotal.ë„ë©´;
        total.ë¹„ì „ += subtotal.ë¹„ì „;
        result.push(`
          <tr class="text-center">
            <td class="border p-1">${slotNames[i]}</td>
            <td class="border p-1">Lv.${cur} â†’ Lv.${tgt}</td>
            <td class="border p-1">${subtotal.ë§¤ë‰´ì–¼}</td>
            <td class="border p-1">${subtotal.ë„ë©´}</td>
            <td class="border p-1">${subtotal.ë¹„ì „}</td>
          </tr>
        `);
      }
      result.push(`
        <tr class="bg-purple-100 font-bold text-center">
          <td class="border p-1" colspan="2">ì´í•©</td>
          <td class="border p-1">${total.ë§¤ë‰´ì–¼}</td>
          <td class="border p-1">${total.ë„ë©´}</td>
          <td class="border p-1">${total.ë¹„ì „}</td>
        </tr>
      `);
      document.getElementById("gemResult").innerHTML = `
        <table class="table-auto w-full border border-gray-300 mt-4 text-sm">
          <thead class="bg-gray-100 text-center">
            <tr>
              <th class="border p-1">ìŠ¬ë¡¯</th>
              <th class="border p-1">ë ˆë²¨ êµ¬ê°„</th>
              <th class="border p-1">ë³´ì„ ë§¤ë‰´ì–¼</th>
              <th class="border p-1">ë³´ì„ ë„ë©´</th>
              <th class="border p-1">ë³´ì„ ë¹„ì „</th>
            </tr>
          </thead>
          <tbody>${result.join('')}</tbody>
        </table>
      `;
    }

    createGemUI();
  </script>

  <footer class="text-center text-xs text-gray-500 mt-10">â›” ë¬´ë‹¨ ë³µì œ ë° ë°°í¬ ê¸ˆì§€ | Â© S574 ShinChan</footer>
</body>
</html>
