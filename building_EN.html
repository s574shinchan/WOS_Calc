<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Building Calculator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    /* Î™®Î∞îÏùº ÌéòÏù¥ÏßÄ Î∂ÑÍ∏∞(Ïõê ÏΩîÎìú Ïú†ÏßÄ Í∞ÄÎä•) */
    const ua = navigator.userAgent || navigator.vendor || window.opera;
    const width = window.innerWidth;
    const isMobile = /android|iphone|ipod|blackberry|windows phone/i.test(ua.toLowerCase()) && width <= 640;
    const isOnMobilePage = location.pathname.includes('building_m');
    if (isMobile && !isOnMobilePage) {
      // ÌïÑÏöî Ïãú Î™®Î∞îÏùº Ï†ÑÏö© ÌéòÏù¥ÏßÄÍ∞Ä ÏûàÎã§Î©¥ ÏÇ¨Ïö©
      // window.location.href = "building_m.html";
    }
  </script>
  <style>
    /* Îã§ÌÅ¨Î™®Îìú */
    body.dark-mode { background:#121212; color:#f0f0f0; }
    .dark-mode .border { border-color:#444 !important; }
    .dark-mode .bg-white { background:#2c2c2c !important; color:#f0f0f0 !important; }
    .dark-mode .bg-gray-100 { background:#1e1e1e !important; }
    .dark-mode .text-gray-800, .dark-mode .text-gray-700, .dark-mode .text-gray-600 { color:#dddddd !important; }
    .dark-mode table { background:#2c2c2c; color:#f0f0f0; }
    .dark-mode th, .dark-mode td { border-color:#444 !important; }
    .dark-mode select option, .dark-mode select, .dark-mode input { color:#000 !important; }
    .dark-mode #buffSelect, .dark-mode #buffSelect option, .dark-mode #buffSelect:disabled {
      color:#fff !important; background:#2c2c2c !important;
    }

    /* experts Ïä§ÌÉÄÏùº Ïπ¥Îìú */
    .exp-card{
      border:1px solid rgba(0,0,0,.08);
      border-radius:16px;
      background:#fff;
      box-shadow:0 6px 18px rgba(15,23,42,.06);
      transition: box-shadow .2s ease;
    }
    .exp-card:hover{ box-shadow:0 10px 26px rgba(15,23,42,.12); }
    .muted{ font-size:12px; color:#6b7280; }
    body.dark-mode .exp-card{ background:#2c2c2c !important; border-color:#444 !important; }
    body.dark-mode .muted{ color:#b7b7b7 !important; }
  </style>
  <script>
    /* Îã§ÌÅ¨Î™®Îìú Ïú†ÏßÄ */
    window.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
      }
    });
  </script>
</head>
<body class="bg-gray-100 p-2 font-sans text-sm">
  <div class="max-w-[1500px] mx-auto bg-white p-3 rounded-xl shadow-md">
    <h1 class="text-2xl font-bold text-gray-800 mb-4">üèóÔ∏è Building Calculator</h1>

    <!-- ÏÑ§Î™Ö -->
    <div class="text-gray-600 mb-4 text-sm">
      <!-- Î≤ÑÌîÑ/ÏÜçÎèÑ -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3">
        <label class="inline-flex items-center font-semibold">
          <input type="checkbox" id="chkVP" class="mr-2 w-4 h-4"> Vice President (10%)
        </label>
        <label class="inline-flex items-center font-semibold">
          <input type="checkbox" id="chkSPVP" class="mr-2 w-4 h-4"> Vice President (15%)
        </label>
        <label class="inline-flex items-center font-semibold">
          <input type="checkbox" id="chkServerBuff" class="mr-2 w-4 h-4"> Mercantilism (10%)
        </label>
        <div class="flex items-center">
          <span class="font-semibold">Construction Speed (%)</span>
          <input type="number" id="buildSpeed" min="0" class="ml-2 border rounded p-2 text-sm w-20 text-right" placeholder="0" />
        </div>
        <div class="flex items-center">
          <label class="inline-flex items-center font-semibold">
            <input type="checkbox" id="chkPetBuff" class="mr-2 w-4 h-4" /> Hyena Buff
          </label>
          <select id="buffSelect" class="ml-2 border rounded p-1 text-sm bg-gray-100 pointer-events-none" disabled>
            <option value="0">None</option>
            <option value="5">5%</option>
            <option value="7">7%</option>
            <option value="9">9%</option>
            <option value="12">12%</option>
            <option value="15">15%</option>
          </select>
        </div>
        <label class="inline-flex items-center font-semibold">
          <input type="checkbox" id="chkCityBuff" class="mr-2 w-4 h-4" /> Double Time Chief Order (20%)
        </label>
      </div>
    </div>

    <!-- Í±¥Î¨º Ïπ¥Îìú Í∑∏Î¶¨Îìú -->
    <div id="buildingGridBody" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4"></div>

    <!-- Î≥¥Ïú† ÏûêÏõê Ïπ¥Îìú -->
    <div class="exp-card mt-4">
      <div class="p-4">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-[15px] font-semibold text-gray-800">Owned Items</h3>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label for="owned-Î∂àÏàòÏ†ï" class="block text-[15px] text-gray-600 mb-1">Owned Fire Crystal</label>
            <input type="number" id="owned-Î∂àÏàòÏ†ï" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="0" min="0" inputmode="numeric" />
          </div>
          <div>
            <label for="owned-Ï†ïÏ†ú" class="block text-[15px] text-gray-600 mb-1">Owned Refind Fire Crystals</label>
            <input type="number" id="owned-Ï†ïÏ†ú" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="0" min="0" inputmode="numeric" />
          </div>
        </div>
      </div>
    </div>

    <!-- Ï¥ùÌï©Í≥Ñ Ìå®ÎÑê (Ï†úÎ™© Î¨∏Íµ¨ Ï†úÍ±∞) -->
    <div id="summaryPanel" class="exp-card mt-4">
      <div class="p-4">
        <!-- Ï†úÎ™© Ï†úÍ±∞ -->
        <div id="summaryBody"></div>
      </div>
    </div>
  </div>

  <script>
    /* Ïú†Ìã∏ */
    function sendHeightToParent(){ const h=document.body.scrollHeight+10; window.parent?.postMessage({type:"FRAME_CHANGE",height:h},"*"); }
    window.addEventListener("load", ()=> setTimeout(sendHeightToParent,100));

    const buildingList = ["Ïö©Í¥ëÎ°ú","ÎåÄÏÇ¨Í¥Ä","ÏßÄÌúòÎ∂Ä","Î∞©Ìå®Î≥ë","Ï∞ΩÎ≥ë","Í∂ÅÎ≥ë","ÏùòÎ¨¥Ïã§","ÏïÑÏπ¥Îç∞ÎØ∏"];
    const resources = ["Î∂àÏàòÏ†ï","Ï†ïÏ†ú","Í≥†Í∏∞","ÎÇòÎ¨¥","ÏÑùÌÉÑ","Ï≤†Í¥ë","Î≥ÄÌôòÏãúÍ∞Ñ"];
    const buildingData = {};
    const nameAliasMap = {
      "Ïö©Í¥ëÎ°ú": "Furnace",
      "ÎåÄÏÇ¨Í¥Ä": "Embassy",
      "ÏßÄÌúòÎ∂Ä": "Command Center",
      "ÏùòÎ¨¥Ïã§": "Infirmary",
      "Î∞©Ìå®Î≥ë": "Infantry Camp",
      "Ï∞ΩÎ≥ë": "Lancer Camp",
      "Í∂ÅÎ≥ë": "Marksman Camp",
      "ÏïÑÏπ¥Îç∞ÎØ∏": "War Academy"
    };
    let buildingCards = []; // {name, maxIndex}

    function formatValue(value){
      const num = parseFloat((value??0).toString().replace(/,/g,''));
      if (isNaN(num)) return value;
      // Ïõê ÏΩîÎìú Í∏∞Ï§Ä Ìè¨Îß∑ Ïú†ÏßÄ
      return num >= 1000 ? (num/1000).toFixed(1) + "B" : num + "M";
    }
    function formatHourToTime(hours){
      if (!hours || isNaN(hours)) return "0min";
      const totalMinutes = Math.round(hours*60);
      const d = Math.floor(totalMinutes/1440);
      const h = Math.floor((totalMinutes%1440)/60);
      const m = totalMinutes%60;
      return `${d?d+'d ':''}${h?h+'h ':''}${(m||(!d&&!h))?m+'min':''}`.trim();
    }

    function handleVPCheck(which){
      const v=document.getElementById("chkVP");
      const s=document.getElementById("chkSPVP");
      if(which==="chkVP" && v.checked) s.checked=false;
      if(which==="chkSPVP" && s.checked) v.checked=false;
      scheduleCalc();
    }
    function togglePetBuffSelect(){
      const cb=document.getElementById("chkPetBuff");
      const sel=document.getElementById("buffSelect");
      sel.disabled = !cb.checked;
      sel.classList.toggle("pointer-events-none",!cb.checked);
      sel.classList.toggle("bg-white",cb.checked);
      sel.classList.toggle("bg-gray-100",!cb.checked);
      scheduleCalc();
    }

    async function fetchBuildingData(){
      for (const name of buildingList){
        const url = `https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/building/${name}.csv`;
        const res = await fetch(url);
        const text = await res.text();
        const lines = text.trim().split("\n");
        const headers = lines[0].split(",");
        const data = lines.slice(1).map(line=>{
          const obj = {};
          const values = line.split(",");
          headers.forEach((h,i)=> obj[h.trim()] = (values[i]?.trim() || "0"));
          return obj;
        });
        buildingData[name]=data;
      }
      renderBuildingSelectors();
      scheduleCalc();
    }

    function renderBuildingSelectors(){
      const container = document.getElementById("buildingGridBody");
      container.innerHTML = "";
      buildingCards = [];

      buildingList.forEach(name=>{
        const displayName = nameAliasMap[name] || name
        const levels = buildingData[name].map(d=> d["Î†àÎ≤®"]);
        const options = levels.map((lv,i)=> `<option value="${i}">${lv}</option>`).join("");
        const maxIndex = levels.length-1;

        const card = document.createElement("div");
        card.className = "exp-card";
        card.innerHTML = `
          <div class="p-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <div class="flex items-center gap-2 mb-2">
                  <h3 class="text-[15px] font-semibold text-gray-800">${displayName}</h3>
                </div>
                <p class="muted mb-3">Level Range (Max ${levels[maxIndex]})</p>

                <!-- ‚úÖ ÌòÑÏû¨/Î™©Ìëú ÏÑ∏Î°ú Î∞∞Ïπò -->
                <div class="grid grid-cols-1 gap-2">
                  <div class="flex items-center justify-between gap-2">
                    <span class="text-gray-600">Current</span>
                    <select id="start-${name}" class="border rounded-lg px-2 py-1 text-sm min-w-[120px]">
                      ${options}
                    </select>
                  </div>
                  <div class="flex items-center justify-between gap-2">
                    <span class="text-gray-600">Target</span>
                    <select id="end-${name}" class="border rounded-lg px-2 py-1 text-sm min-w-[120px]">
                      ${options}
                    </select>
                  </div>
                </div>
              </div>

              <div class="md:pl-4">
                <div class="font-semibold text-gray-800 mb-2">Sub Total</div>
                <div class="grid grid-cols-[1fr_auto] gap-x-3 text-[13px]">
                  <div class="text-gray-600">Fire Crystal</div><div class="text-right tabular-nums" id="sub-Î∂àÏàòÏ†ï-${name}">0</div>
                  <div class="text-gray-600">Refind Fire Crystals</div><div class="text-right tabular-nums" id="sub-Ï†ïÏ†ú-${name}">0</div>
                  <div class="text-gray-600">Meet</div><div class="text-right tabular-nums" id="sub-Í≥†Í∏∞-${name}">0</div>
                  <div class="text-gray-600">Wood</div><div class="text-right tabular-nums" id="sub-ÎÇòÎ¨¥-${name}">0</div>
                  <div class="text-gray-600">Coal</div><div class="text-right tabular-nums" id="sub-ÏÑùÌÉÑ-${name}">0</div>
                  <div class="text-gray-600">Iron</div><div class="text-right tabular-nums" id="sub-Ï≤†Í¥ë-${name}">0</div>
                  <div class="text-gray-600">Estimated Time</div><div class="text-right tabular-nums" id="sub-ÏãúÍ∞Ñ-${name}">0</div>
                </div>
              </div>
            </div>
          </div>
        `;
        container.appendChild(card);

        // Ïù¥Î≤§Ìä∏
        const startSel = card.querySelector(`#start-${name}`);
        const endSel   = card.querySelector(`#end-${name}`);

        startSel.addEventListener("change", ()=>{
          endSel.value = startSel.value; // Í∏∞Î≥∏: ÎèôÏùºÎ†àÎ≤®Î°ú ÎßûÏ∂§
          scheduleCalc();
        });
        endSel.addEventListener("change", scheduleCalc);

        buildingCards.push({name, maxIndex});
      });
    }

    function getFactorForTime(){
      const buildSpeed = parseFloat(document.getElementById("buildSpeed").value || 0);
      let factor = (buildSpeed * 0.01) + 1;
      if (document.getElementById("chkVP").checked) factor += 0.10;
      if (document.getElementById("chkSPVP").checked) factor += 0.15;
      if (document.getElementById("chkServerBuff").checked) factor += 0.10;
      if (document.getElementById("chkPetBuff").checked){
        const petBuff = parseFloat(document.getElementById("buffSelect").value || "0");
        if (!isNaN(petBuff)) factor += (petBuff/100);
      }
      return factor;
    }

    function calculateAll(){
      // Ìï©Í≥Ñ
      const total = { "Î∂àÏàòÏ†ï":0, "Ï†ïÏ†ú":0, "Í≥†Í∏∞":0, "ÎÇòÎ¨¥":0, "ÏÑùÌÉÑ":0, "Ï≤†Í¥ë":0 };
      let totalHours = 0;

      // Ïπ¥ÎìúÎ≥Ñ ÌïÑÏöî Ìï©Í≥Ñ Ï¥àÍ∏∞Ìôî
      buildingCards.forEach(({name})=>{
        ["Î∂àÏàòÏ†ï","Ï†ïÏ†ú","Í≥†Í∏∞","ÎÇòÎ¨¥","ÏÑùÌÉÑ","Ï≤†Í¥ë"].forEach(res=>{
          const el = document.getElementById(`sub-${res}-${name}`);
          if (el) el.textContent = "0";
        });
        const tEl = document.getElementById(`sub-ÏãúÍ∞Ñ-${name}`);
        if (tEl) tEl.textContent = "0";
      });

      const factor = getFactorForTime();
      const cityBuff = document.getElementById("chkCityBuff").checked;

      buildingCards.forEach(({name})=>{
        const start = parseInt(document.getElementById(`start-${name}`).value);
        const end   = parseInt(document.getElementById(`end-${name}`).value);

        // Íµ¨Í∞Ñ Îç∞Ïù¥ÌÑ∞
        const data = buildingData[name].slice(start+1, end+1);
        const sub = { "Î∂àÏàòÏ†ï":0, "Ï†ïÏ†ú":0, "Í≥†Í∏∞":0, "ÎÇòÎ¨¥":0, "ÏÑùÌÉÑ":0, "Ï≤†Í¥ë":0 };
        let hours = 0; // Î≥ÄÌôòÏãúÍ∞Ñ(ÏãúÍ∞Ñ)

        data.forEach(row=>{
          resources.forEach(res=>{
            const v = parseFloat(row[res] || 0);
            if (res === "Î≥ÄÌôòÏãúÍ∞Ñ") hours += (isNaN(v)?0:v);
            else sub[res] += (isNaN(v)?0:v);
          });
        });

        // Ïπ¥Îìú Ïö∞Ï∏° ‚ÄòÌïÑÏöî Ìï©Í≥Ñ‚Äô Í∞±Ïã† (Ï≤¥ÌÅ¨ÏôÄ Î¨¥Í¥Ä / Ìï≠ÏÉÅ ÌëúÏãú)
        document.getElementById(`sub-Î∂àÏàòÏ†ï-${name}`).textContent = sub["Î∂àÏàòÏ†ï"].toLocaleString();
        document.getElementById(`sub-Ï†ïÏ†ú-${name}`).textContent   = sub["Ï†ïÏ†ú"].toLocaleString();
        document.getElementById(`sub-Í≥†Í∏∞-${name}`).textContent    = formatValue(sub["Í≥†Í∏∞"]);
        document.getElementById(`sub-ÎÇòÎ¨¥-${name}`).textContent    = formatValue(sub["ÎÇòÎ¨¥"]);
        document.getElementById(`sub-ÏÑùÌÉÑ-${name}`).textContent    = formatValue(sub["ÏÑùÌÉÑ"]);
        document.getElementById(`sub-Ï≤†Í¥ë-${name}`).textContent    = formatValue(sub["Ï≤†Í¥ë"]);

        let adjHours = hours / factor;
        if (cityBuff) adjHours *= 0.8;
        document.getElementById(`sub-ÏãúÍ∞Ñ-${name}`).textContent = formatHourToTime(adjHours);

        // Ï≤¥ÌÅ¨Îêú Ïπ¥ÎìúÎßå Ï¥ùÌï© Ìè¨Ìï®
        if (start < end){
          Object.keys(total).forEach(k=> total[k] += sub[k]);
          totalHours += adjHours;
        }
      });

      // Î≥¥Ïú†(Î∂àÏàòÏ†ï/Ï†ïÏ†ú)
      const owned = {
        "Î∂àÏàòÏ†ï": parseFloat(document.getElementById("owned-Î∂àÏàòÏ†ï").value || 0),
        "Ï†ïÏ†ú": parseFloat(document.getElementById("owned-Ï†ïÏ†ú").value || 0),
      };

      // ÌïòÎã® ÏöîÏïΩ(Ï¥ùÌï©/Î≥¥Ïú†/Í≥ºÎ∂ÄÏ°±) - Î™®Îì† ÏûêÏõê + ÏãúÍ∞Ñ
      const deficit = {
        "Î∂àÏàòÏ†ï": owned["Î∂àÏàòÏ†ï"] - total["Î∂àÏàòÏ†ï"],
        "Ï†ïÏ†ú": owned["Ï†ïÏ†ú"] - total["Ï†ïÏ†ú"],
        // ÎÇòÎ®∏ÏßÄ ÏûêÏõêÏùÄ Î≥¥Ïú†ÏπòÍ∞Ä ÏóÜÏúºÎØÄÎ°ú Í≥ºÎ∂ÄÏ°± ÎØ∏ÌëúÏãú(Ïõê ÏöîÏ≤≠ÎåÄÎ°ú Ï¥ùÌï©/Î≥¥Ïú†/Í≥ºÎ∂ÄÏ°±ÏùÄ Î∂àÏàòÏ†ï/Ï†ïÏ†ú Ï§ëÏã¨)
      };

      const summaryBody = `
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
          <!-- Ï¥ùÌï© -->
          <div class="rounded-xl border border-black/10 p-3">
            <div class="font-semibold mb-2">Total</div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">Fire Crystal</span><span>${total["Î∂àÏàòÏ†ï"].toLocaleString()}</span></div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">Refind Fire Crystals</span><span>${total["Ï†ïÏ†ú"].toLocaleString()}</span></div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">Meet</span><span>${formatValue(total["Í≥†Í∏∞"])}</span></div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">Wood</span><span>${formatValue(total["ÎÇòÎ¨¥"])}</span></div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">Coal</span><span>${formatValue(total["ÏÑùÌÉÑ"])}</span></div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">Iron</span><span>${formatValue(total["Ï≤†Í¥ë"])}</span></div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">Estimated Time</span><span>${formatHourToTime(totalHours)}</span></div>
          </div>

          <!-- Î≥¥Ïú†Îüâ -->
          <div class="rounded-xl border border-black/10 p-3">
            <div class="font-semibold mb-2">Stock</div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">Fire Crystal</span><span>${owned["Î∂àÏàòÏ†ï"].toLocaleString()}</span></div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">Refind Fire Crystals</span><span>${owned["Ï†ïÏ†ú"].toLocaleString()}</span></div>
          </div>

          <!-- Í≥ºÎ∂ÄÏ°± -->
          <div class="rounded-xl border border-black/10 p-3">
            <div class="font-semibold mb-2">Quantity required</div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">Fire Crystal</span><span class="${deficit["Î∂àÏàòÏ†ï"]<0?'text-red-600':''}">${deficit["Î∂àÏàòÏ†ï"].toLocaleString()}</span></div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">Refind Fire Crystals</span><span class="${deficit["Ï†ïÏ†ú"]<0?'text-red-600':''}">${deficit["Ï†ïÏ†ú"].toLocaleString()}</span></div>
          </div>
        </div>
      `;
      document.getElementById("summaryBody").innerHTML = summaryBody;

      sendHeightToParent();
    }

    // ÏûêÎèô Í≥ÑÏÇ∞(ÎîîÎ∞îÏö¥Ïä§)
    let calcTimer=null;
    function scheduleCalc(){
      if (calcTimer) clearTimeout(calcTimer);
      calcTimer = setTimeout(calculateAll, 120);
    }

    // ÏÉÅÎã® ÌÜ†Í∏Ä/ÏûÖÎ†• Ïù¥Î≤§Ìä∏
    document.addEventListener("change",(e)=>{
      const id = e.target.id;
      if (id==="chkVP") handleVPCheck("chkVP");
      else if (id==="chkSPVP") handleVPCheck("chkSPVP");
      else if (id==="chkServerBuff" || id==="chkCityBuff" || id==="buffSelect") scheduleCalc();
      else if (id==="buildSpeed" || id==="owned-Î∂àÏàòÏ†ï" || id==="owned-Ï†ïÏ†ú") scheduleCalc();
      else if (id==="chkPetBuff") togglePetBuffSelect();
    });
    ["buildSpeed","owned-Î∂àÏàòÏ†ï","owned-Ï†ïÏ†ú"].forEach(id=>{
      const el=document.getElementById(id);
      if (el) el.addEventListener("input", scheduleCalc);
    });

    // Îç∞Ïù¥ÌÑ∞ Î°úÎìú & Ï¥àÍ∏∞ Î†åÎçî
    fetchBuildingData();

    // (ÏÑ†ÌÉù) F12/Î≥µÏÇ¨ Î∞©ÏßÄ Ïú†ÏßÄ
    document.addEventListener("contextmenu", e=>e.preventDefault());
    document.addEventListener("keydown", function (e) {
      if (e.key === "F12" || (e.ctrlKey && e.shiftKey && (e.key === "I" || e.key === "J")) ||
          (e.ctrlKey && (e.key === "U" || e.key === "S"))) {
        e.preventDefault();
      }
    });
  </script>
</body>
</html>
