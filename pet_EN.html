<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üêæ Ìé´ Í≥ÑÏÇ∞Í∏∞</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* ===== Îã§ÌÅ¨Î™®Îìú ===== */
    body.dark-mode { background:#121212; color:#f0f0f0; }
    .dark-mode .border{ border-color:#444 !important; }
    .dark-mode .bg-white{ background:#2c2c2c !important; color:#f0f0f0 !important; }
    .dark-mode .bg-gray-100{ background:#1e1e1e !important; }
    .dark-mode .text-gray-800,.dark-mode .text-gray-700,.dark-mode .text-gray-600{ color:#dddddd !important; }
    .dark-mode select,.dark-mode input{ color:#000 !important; }
    .dark-mode table{ background:#2c2c2c; color:#f0f0f0; }
    .dark-mode th,.dark-mode td{ border-color:#444 !important; }

    /* ===== experts Ïπ¥Îìú ===== */
    .exp-card{
      border:1px solid rgba(0,0,0,.08);
      border-radius:16px;
      background:#fff;
      box-shadow:0 6px 18px rgba(15,23,42,.06);
      transition: box-shadow .2s ease;
    }
    .exp-card:hover{ box-shadow:0 10px 26px rgba(15,23,42,.12); }
    .muted{ font-size:12px; color:#6b7280; }

    body.dark-mode .exp-card{ background:#2c2c2c !important; border-color:#444 !important; }
    body.dark-mode .muted{ color:#b7b7b7 !important; }
  </style>

  <!-- Îã§ÌÅ¨Î™®Îìú ÏÉÅÌÉú Ïú†ÏßÄ -->
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
      }
    });
  </script>
</head>
<body class="bg-gray-100 p-2 font-sans text-sm">
  <div class="max-w-6xl mx-auto bg-white p-3 rounded-xl shadow-md space-y-5">
    <h1 class="text-2xl font-bold text-gray-800">üêæ Pet</h1>
    
    <!-- Ïπ¥Îìú Í∑∏Î¶¨Îìú -->
    <div id="petGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>

    <!-- Î≥¥Ïú† ÏûêÏõê Ïπ¥Îìú -->
    <div class="exp-card">
      <div class="p-4">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-[15px] font-semibold text-gray-800">Owned Items</h3>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-4 gap-4">
          <div>
            <label class="block text-[12px] text-gray-600 mb-1">Owned Pet Food</label>
            <input type="number" id="own-Ìé´Î®πÏù¥" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="0" min="0" inputmode="numeric"/>
          </div>
          <div>
            <label class="block text-[12px] text-gray-600 mb-1">Owned Manual</label>
            <input type="number" id="own-Ï°∞Î†®Îß§Îâ¥Ïñº" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="0" min="0" inputmode="numeric"/>
          </div>
          <div>
            <label class="block text-[12px] text-gray-600 mb-1">Owned Potion</label>
            <input type="number" id="own-ÌôúÎ†•ÏùòÏïΩ" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="0" min="0" inputmode="numeric"/>
          </div>
          <div>
            <label class="block text-[12px] text-gray-600 mb-1">Owned Serum</label>
            <input type="number" id="own-Í∞ïÌôîÌòàÏ≤≠" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="0" min="0" inputmode="numeric"/>
          </div>
        </div>
      </div>
    </div>

    <!-- ÌïòÎã® Ï¥ùÌï© Ìå®ÎÑê -->
    <div id="summaryPanel" class="exp-card">
      <div class="p-4">
        <div id="summaryBody"></div>
      </div>
    </div>
  </div>

  <!-- ===== Îç∞Ïù¥ÌÑ∞ & Î°úÏßÅ ===== -->
  <script>
    // Îì±Í∏â Î™©Î°ù Î∞è CSV ÎßµÌïë
    const grades = ["Í∏∞Í∞ÑÌÜ†","Îß§Î®∏Îìú","Ìò∏ÎûëÏù¥","ÏΩîÎøîÏÜå","Í≥†Î¶¥Îùº","ÎèôÍµ¥ÏÇ¨Ïûê","ÌùëÌëúÎ≤î","ÌÅ∞ÎøîÏÇ¨Ïä¥","Ìã∞ÌÉÄÎãàÏä§","ÌÖåÏù¥Ìçº","ÏÇ¨Ìñ•ÏÜå","Î∂ÅÍ∑πÎäëÎåÄ","ÌïòÏù¥ÏóêÎÇò"];
    const gradeLabels = {
      "Í∏∞Í∞ÑÌÜ†":"SSR",
      "Îß§Î®∏Îìú":"SSR",
      "Ìò∏ÎûëÏù¥":"SSR",
      "ÏΩîÎøîÏÜå":"SSR",
      "Í≥†Î¶¥Îùº":"SSR",
      "ÎèôÍµ¥ÏÇ¨Ïûê":"SSR",
      "ÌùëÌëúÎ≤î":"SR",
      "ÌÅ∞ÎøîÏÇ¨Ïä¥":"SR",
      "Ìã∞ÌÉÄÎãàÏä§":"R",
      "ÌÖåÏù¥Ìçº":"R",
      "ÏÇ¨Ìñ•ÏÜå":"N",
      "Î∂ÅÍ∑πÎäëÎåÄ":"N",
      "ÌïòÏù¥ÏóêÎÇò":"UnKnown" // Ï†ÄÏû•ÏÜåÏóê Ìï¥Îãπ CSVÍ∞Ä ÏóÜÏúºÎ©¥ Í±¥ÎÑàÎúÄ
    };
    
    const nameAlias = {
      "Í∏∞Í∞ÑÌÜ†": "Frost Gorilla",
      "Îß§Î®∏Îìú": "Mammoth",
      "Ìò∏ÎûëÏù¥": "Saber-tooth Tiger",
      "ÏΩîÎøîÏÜå": "Iron Rhino", 
      "Í≥†Î¶¥Îùº": "Snoe Ape", 
      "ÎèôÍµ¥ÏÇ¨Ïûê": "Cave Lion",
      "ÌùëÌëúÎ≤î": "Snow Leopard",
      "ÌÅ∞ÎøîÏÇ¨Ïä¥": "Giant Elk",
      "Ìã∞ÌÉÄÎãàÏä§": "Titan Roc",
      "ÌÖåÏù¥Ìçº": "Giant Tapir", 
      "ÏÇ¨Ìñ•ÏÜå": "Musk Ox",
      "Î∂ÅÍ∑πÎäëÎåÄ": "Arctic Wolf",
      "ÌïòÏù¥ÏóêÎÇò": "Cave Hyena"
    };
    
    const CSV_BASE = "https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Pet/";

    // Îì±Í∏âÎ≥Ñ CSV Îç∞Ïù¥ÌÑ∞ Ï∫êÏãú
    const petDataMap = {};  // grade -> Ï†ÑÏ≤¥Ìñâ[]
    const petNamesByGrade = {}; // grade -> Ïù¥Î¶Ñ Î™©Î°ù
    const levelsByPet = {}; // `${grade}|${name}` -> Î†àÎ≤® Î∞∞Ïó¥ (Ï†ïÎ†¨ Î≥¥Ïû•)

    // UI Î£®Ìä∏
    const grid = document.getElementById("petGrid");

    // util: ÏïàÏ†Ñ split Ï§ÑÎ∞îÍøà
    function splitLines(t){ return t.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n"); }

    async function fetchPetCSV(gradeKey) {
      const url = `${CSV_BASE}Pet_${gradeKey}.csv`;
      const res = await fetch(url);
      if (!res.ok) throw new Error("CSV not found: " + url);
      const text = await res.text();
      const lines = splitLines(text).filter(Boolean).map(row => row.split(","));
      const headers = lines[0].map(h=>h.trim());
      const rows = lines.slice(1).map(cols => {
        const obj = {};
        headers.forEach((h,i)=> obj[h] = (cols[i] ?? "").trim());
        return obj;
      });
      return rows;
    }

    async function loadAll() {
      // Îì±Í∏â ÌÇ§(SSR/SR/R/N/UnKnown) Í∏∞Ï§ÄÏúºÎ°ú ÌïúÎ≤àÏî©Îßå Î°úÎìú
      const uniqueKeys = [...new Set(Object.values(gradeLabels))];
      for (const key of uniqueKeys) {
        try {
          const data = await fetchPetCSV(key);
          // Ïù¥ keyÎ•º Ïì∞Îäî Î™®Îì† Îì±Í∏âÏóê Îç∞Ïù¥ÌÑ∞ Í≥µÏú†
          grades.filter(g => gradeLabels[g] === key).forEach(g => petDataMap[g] = data);
        } catch (e) {
          // ÏóÜÎäî CSVÎäî Ïä§ÌÇµ
          console.warn(key, e.message);
        }
      }

      // Îì±Í∏â/Ïù¥Î¶Ñ/Î†àÎ≤® ÌååÏÉù Ï†ïÎ≥¥ ÏÑ∏ÌåÖ
      grades.forEach(g => {
        const data = petDataMap[g];
        if (!data) return;
        const names = [...new Set(data.map(d => d["Ïù¥Î¶Ñ"]))];
        petNamesByGrade[g] = names;
        names.forEach(name => {
          const lvList = data.filter(d=>d["Ïù¥Î¶Ñ"]===name).map(d=>d["Î†àÎ≤®"]);
          // Î†àÎ≤®Ïù¥ Ïà´ÏûêÎ©¥ Ïà´Ïûê Ï†ïÎ†¨, ÏïÑÎãàÎ©¥ Î¨∏ÏûêÏó¥ Ï†ïÎ†¨
          const nums = lvList.map(v=>Number(v));
          const allNum = nums.every(n=>!Number.isNaN(n));
          levelsByPet[`${g}|${name}`] = allNum
            ? [...lvList].sort((a,b)=>Number(a)-Number(b))
            : [...lvList];
        });
      });

      renderCards();
      bindOwnedInputs();
      scheduleCalc();
    }

    function renderCards() {
      grid.innerHTML = "";
      grades.forEach(grade => {
        const data = petDataMap[grade];
        if (!data) return; // Ìï¥Îãπ Îì±Í∏â CSV ÏóÜÏúºÎ©¥ Ïä§ÌÇµ

        const names = petNamesByGrade[grade] || [];
        names.forEach((petName, idx) => {
          const key = `${grade}-${idx}`;
          const lvList = levelsByPet[`${grade}|${petName}`] || [];
          const options = lvList.map(lv=>`<option value="${lv}">${lv}</option>`).join("");
          const card = document.createElement("div");
          const displayName = nameAlias[grade] || grade;
          
          card.className = "exp-card";
          card.innerHTML = `
            <div class="p-4">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <div class="flex items-center gap-2 mb-2">
                    <h3 class="text-[15px] font-semibold text-gray-800">${displayName}</h3>
                  </div>
                  <!-- ÌòÑÏû¨/Î™©Ìëú ÏÑ∏Î°ú Î∞∞Ïπò -->
                  <div class="grid grid-cols-1 gap-2">
                    <div class="flex items-center justify-between gap-2">
                      <span class="text-[12px] text-gray-600">Current</span>
                      <select id="cur-${key}" class="border rounded-lg px-2 py-1 text-sm min-w-[120px]">${options}</select>
                    </div>
                    <div class="flex items-center justify-between gap-2">
                      <span class="text-[12px] text-gray-600">Target</span>
                      <select id="tgt-${key}" class="border rounded-lg px-2 py-1 text-sm min-w-[120px]">${options}</select>
                    </div>
                  </div>
                </div>
                <div class="md:pl-4">
                  <div class="font-semibold text-gray-800 mb-2">Sub Total</div>
                  <div class="grid grid-cols-[1fr_auto] gap-x-3 text-[13px]">
                    <div class="text-gray-600">Pet Food</div><div class="text-right tabular-nums" id="sub-food-${key}">0</div>
                    <div class="text-gray-600">Manual</div><div class="text-right tabular-nums" id="sub-manual-${key}">0</div>
                    <div class="text-gray-600">Potion</div><div class="text-right tabular-nums" id="sub-vital-${key}">0</div>
                    <div class="text-gray-600">Serum</div><div class="text-right tabular-nums" id="sub-serum-${key}">0</div>
                  </div>
                </div>
              </div>
            </div>
          `;
          grid.appendChild(card);

          const curSel = card.querySelector(`#cur-${key}`);
          const tgtSel = card.querySelector(`#tgt-${key}`);

          const onChange = () => { updateCardSubtotal(grade, petName, key); scheduleCalc(); };
          curSel.addEventListener("change", () => { tgtSel.value = curSel.value; onChange(); });
          tgtSel.addEventListener("change", onChange);

          // Ï¥àÍ∏∞ Í≥ÑÏÇ∞
          updateCardSubtotal(grade, petName, key);
        });
      });
    }

    function updateCardSubtotal(grade, petName, key) {
      const data = petDataMap[grade] || [];
      const list = data.filter(d => d["Ïù¥Î¶Ñ"] === petName);
      const lvArr = list.map(d => d["Î†àÎ≤®"]);
      const cur = document.getElementById(`cur-${key}`).value;
      const tgt = document.getElementById(`tgt-${key}`).value;

      const s = lvArr.indexOf(cur);
      const e = lvArr.indexOf(tgt);

      const sum = { food:0, manual:0, vital:0, serum:0 };
      if (s >= 0 && e > s) {
        for (let i = s + 1; i <= e; i++) {
          const r = list[i];
          sum.food   += parseFloat(r["Ìé´Î®πÏù¥"] || "0");
          sum.manual += parseFloat(r["Ï°∞Î†®Îß§Îâ¥Ïñº"] || "0");
          sum.vital  += parseFloat(r["ÌôúÎ†•ÏùòÏïΩ"] || "0");
          sum.serum  += parseFloat(r["Í∞ïÌôîÌòàÏ≤≠"] || "0");
        }
      }
      document.getElementById(`sub-food-${key}`).textContent   = sum.food.toLocaleString();
      document.getElementById(`sub-manual-${key}`).textContent = sum.manual.toLocaleString();
      document.getElementById(`sub-vital-${key}`).textContent  = sum.vital.toLocaleString();
      document.getElementById(`sub-serum-${key}`).textContent  = sum.serum.toLocaleString();
    }

    function calculateTotals() {
      const totals = { food:0, manual:0, vital:0, serum:0 };

      grades.forEach(grade => {
        const names = petNamesByGrade[grade] || [];
        names.forEach((petName, idx) => {
          const key = `${grade}-${idx}`;
          
          const data = petDataMap[grade] || [];
          const list = data.filter(d => d["Ïù¥Î¶Ñ"] === petName);
          const lvArr = list.map(d => d["Î†àÎ≤®"]);
          const cur = document.getElementById(`cur-${key}`).value;
          const tgt = document.getElementById(`tgt-${key}`).value;
          const s = lvArr.indexOf(cur);
          const e = lvArr.indexOf(tgt);
          if (s === -1 || e === -1 || s >= e) return;

          for (let i = s + 1; i <= e; i++) {
            const r = list[i];
            totals.food   += parseFloat(r["Ìé´Î®πÏù¥"] || "0");
            totals.manual += parseFloat(r["Ï°∞Î†®Îß§Îâ¥Ïñº"] || "0");
            totals.vital  += parseFloat(r["ÌôúÎ†•ÏùòÏïΩ"] || "0");
            totals.serum  += parseFloat(r["Í∞ïÌôîÌòàÏ≤≠"] || "0");
          }
        });
      });

      return totals;
    }

    function renderSummary() {
      const t = calculateTotals();
      const owned = {
        food:   parseFloat(document.getElementById("own-Ìé´Î®πÏù¥").value)||0,
        manual: parseFloat(document.getElementById("own-Ï°∞Î†®Îß§Îâ¥Ïñº").value)||0,
        vital:  parseFloat(document.getElementById("own-ÌôúÎ†•ÏùòÏïΩ").value)||0,
        serum:  parseFloat(document.getElementById("own-Í∞ïÌôîÌòàÏ≤≠").value)||0,
      };
      const deficit = {
        food: owned.food - t.food,
        manual: owned.manual - t.manual,
        vital: owned.vital - t.vital,
        serum: owned.serum - t.serum,
      };

      const html = `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div class="rounded-xl border border-black/10 p-3">
            <div class="font-semibold mb-2">Total</div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">Pet Food</span><span>${t.food.toLocaleString()}</span></div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">Manual</span><span>${t.manual.toLocaleString()}</span></div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">Potion</span><span>${t.vital.toLocaleString()}</span></div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">Serum</span><span>${t.serum.toLocaleString()}</span></div>
          </div>
          <div class="rounded-xl border border-black/10 p-3">
            <div class="font-semibold mb-2">Stock</div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">Pet Food</span><span>${owned.food.toLocaleString()}</span></div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">Manual</span><span>${owned.manual.toLocaleString()}</span></div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">Potion</span><span>${owned.vital.toLocaleString()}</span></div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">Serum</span><span>${owned.serum.toLocaleString()}</span></div>
          </div>
          <div class="rounded-xl border border-black/10 p-3">
            <div class="font-semibold mb-2">Quantity required</div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">Pet Food</span><span class="${deficit.food<0?'text-red-600':''}">${deficit.food.toLocaleString()}</span></div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">Manual</span><span class="${deficit.manual<0?'text-red-600':''}">${deficit.manual.toLocaleString()}</span></div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">Potion</span><span class="${deficit.vital<0?'text-red-600':''}">${deficit.vital.toLocaleString()}</span></div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">Serum</span><span class="${deficit.serum<0?'text-red-600':''}">${deficit.serum.toLocaleString()}</span></div>
          </div>
        </div>`;
      const el = document.getElementById("summaryBody");
      if (el) el.innerHTML = html;
    }

    // ÎîîÎ∞îÏö¥Ïä§
    let calcTimer = null;
    function scheduleCalc() {
      if (calcTimer) clearTimeout(calcTimer);
      calcTimer = setTimeout(renderSummary, 120);
    }

    function bindOwnedInputs() {
      ["own-Ìé´Î®πÏù¥","own-Ï°∞Î†®Îß§Îâ¥Ïñº","own-ÌôúÎ†•ÏùòÏïΩ","own-Í∞ïÌôîÌòàÏ≤≠"].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.addEventListener("input", scheduleCalc);
      });
    }

    // ÏãúÏûë
    loadAll();
    function sendHeightToParent() {
      const height = document.body.scrollHeight + 10;
      window.parent.postMessage({ type: "FRAME_CHANGE", height }, "*");
    }
    window.addEventListener("load", () => setTimeout(sendHeightToParent, 100));
  </script>
  <script>
    // F12, Ctrl+Shift+I, Ctrl+U Îì± Î∞©ÏßÄ
    document.onkeydown = function (e) {
      if (
        e.keyCode === 123 || // F12
        (e.ctrlKey && e.shiftKey && e.keyCode === 73) || // Ctrl+Shift+I
        (e.ctrlKey && e.shiftKey && e.keyCode === 74) || // Ctrl+Shift+J
        (e.ctrlKey && e.keyCode === 85) // Ctrl+U
      ) {
        e.preventDefault();
        return false;
      }
    };
  
    // Ïö∞ÌÅ¥Î¶≠ Î∞©ÏßÄ
    document.addEventListener("contextmenu", (e) => e.preventDefault());
  </script>
  <script>
    window.addEventListener('message', (e) => {
      if (e.data?.type === 'DARK_MODE') {
        document.body.classList.toggle('dark-mode', e.data.value);
      }
    });
  </script>  
</body>
</html>
