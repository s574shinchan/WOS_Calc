<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>í—¬ë¦¬ì˜¤ìŠ¤ ì—°êµ¬ ê³„ì‚°ê¸°</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* ========== ë‹¤í¬ëª¨ë“œ ê¸°ë³¸ ========== */
    body.dark-mode { background-color:#121212; color:#f0f0f0; }
    .dark-mode .border { border-color:#444 !important; }
    .dark-mode .bg-white { background-color:#2c2c2c !important; color:#f0f0f0 !important; }
    .dark-mode .bg-gray-100 { background-color:#1e1e1e !important; }
    .dark-mode .text-gray-800,
    .dark-mode .text-gray-700,
    .dark-mode .text-gray-600 { color:#dddddd !important; }
    .dark-mode .text-blue-700 { color:#66b0ff !important; }
    .dark-mode .text-blue-600 { color:#80caff !important; }
    .dark-mode .text-orange-500 { color:#ffa94d !important; }
    .dark-mode .text-green-600 { color:#79e68c !important; }
    .dark-mode .text-red-500 { color:#ff8080 !important; }
    .dark-mode .text-gray-500 { color:#aaa !important; }
    .dark-mode table { background-color:#2c2c2c; color:#f0f0f0; }
    .dark-mode th, .dark-mode td { border-color:#444 !important; }
    .dark-mode thead th { color:#000 !important; }
    .dark-mode summary { background-color:#333 !important; color:#fff !important; }
    .dark-mode ul li { color:#ddd; }

    /* âœ… íŒì—…ì—ì„œ select/input ê¸€ììƒ‰ */
    .dark-mode select option { color:#000 !important; }
    .dark-mode select { color:#000 !important; }
    .dark-mode input { color:#000 !important; }

    /* ========== experts ìŠ¤íƒ€ì¼ ì¹´ë“œ ========== */
    .exp-card{
      border:1px solid rgba(0,0,0,.08);
      border-radius:16px;
      background:#fff;
      box-shadow:0 6px 18px rgba(15,23,42,.06);
      transition: box-shadow .2s ease;
    }
    .exp-card:hover{ box-shadow:0 10px 26px rgba(15,23,42,.12); }
    .exp-divider{ border-color:rgba(0,0,0,.08); }
    .muted{ font-size:12px; color:#6b7280; }

    /* ë‹¤í¬ëª¨ë“œ ì¹´ë“œ ë³´ì • */
    body.dark-mode .exp-card{ background-color:#2c2c2c !important; border-color:#444 !important; }
    body.dark-mode .exp-divider{ border-color:#444 !important; }
    body.dark-mode .muted{ color:#b7b7b7 !important; }
    body.dark-mode .svs-score-label,
    body.dark-mode .svs-score-value {
      font-weight: 700;
      color: #16AC7A !important;
    }

    /* í† ê¸€ ë²„íŠ¼ */
    .toggle-btn{ transition:.12s ease; user-select:none; }
    .toggle-btn:active{ transform:scale(.98); }
    .toggle-btn{
      background: transparent;
      border-color: rgba(148,163,184,.65);
      color: inherit;
    }
    .toggle-btn.is-on{
      background: #2563eb;   /* blue-600 */
      border-color: #1d4ed8; /* blue-700 */
      color: #fff;
    }
    body.dark-mode .toggle-btn{ border-color:#444; }

    /* ì˜µì…˜ ìš”ì•½ ì¹© */
    .chip{
      display:inline-flex;
      align-items:center;
      gap:.35rem;
      padding:.3rem .55rem;
      border-radius:9999px;
      border:1px solid rgba(0,0,0,.1);
      font-size:12px;
      line-height:1;
      white-space:nowrap;
    }
    body.dark-mode .chip{ border-color:#444 !important; }

    /* íŒì—… */
    #opt-modal-backdrop{ z-index: 2000; }
  </style>

  <!-- âœ… ë‹¤í¬ëª¨ë“œ ìƒíƒœ ìœ ì§€ -->
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
      }
    });
  </script>
</head>

<body class="bg-gray-100 p-2 font-sans text-sm">
  <div id="appRoot" class="w-full mx-auto bg-white p-3 rounded-xl shadow-md">
    <h1 class="text-2xl font-bold text-gray-800 mb-3">ğŸ§ª í—¬ë¦¬ì˜¤ìŠ¤ ì—°êµ¬ ê³„ì‚°ê¸°</h1>

    <!-- âœ… ìƒë‹¨: ë³‘ì¢…ì„ íƒ(ë©”ì¸ ìœ ì§€) + ì˜µì…˜ ë²„íŠ¼(íŒì—…) -->
    <div class="mb-3">
      <div class="flex items-center justify-between gap-2">
        <button onclick="goBack()"
                class="text-sm font-semibold text-gray-600 hover:text-blue-600 flex items-center gap-1">
          â† ë’¤ë¡œê°€ê¸°
        </button>
        <button id="btn-open-options"
                type="button"
                class="px-3 py-2 rounded-xl border font-semibold text-sm hover:border-slate-400">
          âš™ ì˜µì…˜
        </button>
      </div>
      <div class="text-sm font-medium">ë³‘ì¢…ì„ íƒ</div>
      <div class="grid grid-cols-3 gap-2 mt-2">
        <button type="button"
                class="w-full px-3 py-2 rounded-xl border font-semibold text-sm toggle-btn"
                data-toggle="chkInf" data-group="troop" data-mode="single">
          ë°©íŒ¨ë³‘
        </button>
        <button type="button"
                class="w-full px-3 py-2 rounded-xl border font-semibold text-sm toggle-btn"
                data-toggle="chkLan" data-group="troop" data-mode="single">
          ì°½ë³‘
        </button>
        <button type="button"
                class="w-full px-3 py-2 rounded-xl border font-semibold text-sm toggle-btn"
                data-toggle="chkMask" data-group="troop" data-mode="single">
          ê¶ë³‘
        </button>

        <!-- âœ… ê¸°ì¡´ ë¡œì§ ê·¸ëŒ€ë¡œ ì“°ê¸° ìœ„í•œ ì²´í¬ë°•ìŠ¤(ìˆ¨ê¹€) -->
        <input type="checkbox" id="chkInf" checked hidden>
        <input type="checkbox" id="chkLan" hidden>
        <input type="checkbox" id="chkMask" hidden>
      </div>

      <!-- âœ… ì˜µì…˜ ìš”ì•½(ë©”ì¸) -->
      <div id="optionChips" class="mt-2 flex flex-wrap gap-2">
        <!-- JSë¡œ ì±„ì›€ -->
      </div>
    </div>

    <!-- ì¹´ë“œ ê·¸ë¦¬ë“œ -->
    <div id="researchGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-2 gap-2 mb-4"></div>

    <!-- âœ… ìµœí•˜ë‹¨ ì´í•©ê³„ íŒ¨ë„ -->
    <div id="summaryPanel" class="mt-4">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
        <!-- ì´í•© -->
        <div class="rounded-xl border border-black/10 p-3">
          <div class="font-semibold mb-2">ì´í•©</div>
          <div class="flex justify-between text-[13px]"><span class="text-gray-600">ë¶ˆìˆ˜ì¡°ê°</span><span id="sum-ê°€ë£¨">0</span></div>
          <div class="font-semibold mb-2"></div>
          <div class="flex justify-between text-[13px]"><span class="text-gray-600">ì² ê°•ì¬</span><span id="sum-ì² ê°•ì¬">0</span></div>
          <div class="font-semibold mb-2"></div>
          <div class="flex justify-between text-[13px]"><span class="text-gray-600">ì†Œìš”ì‹œê°„</span><span id="sum-ì‹œê°„">0ë¶„</span></div>
        </div>

        <!-- ë³´ìœ ëŸ‰ -->
        <div class="rounded-xl border border-black/10 p-3">
          <div class="font-semibold mb-2">ë³´ìœ ëŸ‰</div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label for="owned-ê°€ë£¨" class="block text-[13px] text-gray-600 mb-1">ë³´ìœ  ë¶ˆìˆ˜ì¡°ê°</label>
              <input type="number" id="owned-ê°€ë£¨" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="0" min="0" inputmode="numeric" />
            </div>
            <div>
              <label for="owned-ì² ê°•ì¬" class="block text-[13px] text-gray-600 mb-1">ë³´ìœ  ì² ê°•ì¬</label>
              <input type="number" id="owned-ì² ê°•ì¬" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="0" min="0" inputmode="numeric" />
            </div>
          </div>
        </div>

        <!-- ê³¼ë¶€ì¡± -->
        <div class="rounded-xl border border-black/10 p-3">
          <div class="font-semibold mb-2">ê³¼ë¶€ì¡±</div>
          <div class="flex justify-between text-[13px]"><span class="text-gray-600">ë¶ˆìˆ˜ì¡°ê°</span><span id="def-ê°€ë£¨">0</span></div>
          <div class="font-semibold mb-2"></div>
          <div class="flex justify-between text-[13px]"><span class="text-gray-600">ì² ê°•ì¬</span><span id="def-ì² ê°•ì¬">0</span></div>
        </div>
      </div>
    </div>

    <div class="flex justify-end mt-2">
      <button id="btn-calc-total" class="w-full px-4 py-2 rounded-lg bg-blue-600 text-white text-sm hover:bg-blue-700">ì´í•©ê³„ì‚°</button>
    </div>

    <!-- âœ… SVS í‘œì‹œ (ë²„íŠ¼ í´ë¦­ ì‹œì—ë§Œ ë…¸ì¶œ) -->
    <div id="svs" class="hidden mt-3">
      <label for="svspoint" class="block text-sm mb-1">SVS Point</label>
      <input type="text" id="svspoint" class="border rounded p-2 text-sm w-full text-right cursor-not-allowed" readonly tabindex="-1"/>
    </div>
  </div>

  <!-- =========================
       âœ… ì˜µì…˜ íŒì—… (ëª¨ë°”ì¼ìš©)
       ========================= -->
  <div id="opt-modal-backdrop" 
        class="fixed inset-0 z-[2000] hidden items-center justify-center">
    <div class="absolute inset-0 bg-black/50"></div>
      <div class="relative w-full max-w-xl rounded-2xl bg-white dark:bg-[#2c2c2c] p-5">
        <div class="flex items-center justify-between mb-4">
          <div class="text-[15px] font-semibold">âš™ ì˜µì…˜ ì„¤ì •</div>
          <button id="btn-close-options-x" class="px-2 py-1 rounded-lg border text-sm">ë‹«ê¸°</button>
        </div>

        <div class="p-4 space-y-4">
          <!-- VP -->
          <div>
            <div class="text-sm font-medium mb-2">ë¶€ì§‘í–‰ê´€ ê´€ì§ ë²„í”„</div>
            <div class="flex flex-wrap gap-2">
              <button type="button"
                      class="w-[110px] px-3 py-2 rounded-xl border font-semibold text-sm toggle-btn"
                      data-toggle="chkVP10" data-group="vp" data-mode="single">
                10%
              </button>
              <button type="button"
                      class="w-[110px] px-3 py-2 rounded-xl border font-semibold text-sm toggle-btn"
                      data-toggle="chkVP15" data-group="vp" data-mode="single">
                15%
              </button>
            </div>
            <input type="checkbox" id="chkVP10" hidden>
            <input type="checkbox" id="chkVP15" hidden>
          </div>

          <!-- ë°œë ˆë¦¬ì•„ -->
          <div>
            <label class="block text-sm font-medium mb-2">ë°œë ˆë¦¬ì•„</label>
            <select id="chkExpertV" class="w-full rounded-xl border px-3 py-3 text-sm">
              <option>None</option>
              <option>Lv.1</option><option>Lv.2</option><option>Lv.3</option><option>Lv.4</option><option>Lv.5</option>
              <option>Lv.6</option><option>Lv.7</option><option>Lv.8</option><option>Lv.9</option><option>Lv.10</option>
            </select>
            <div class="mt-1 text-[12px] text-gray-500" id="valeriaHint">SvS ì ìˆ˜</div>
          </div>

          <!-- ì„œë²„ë²„í”„ -->
          <div>
            <div class="text-sm font-medium mb-2">ì„œë²„ë²„í”„ (10%)</div>
            <div class="flex flex-wrap gap-2">
              <button type="button"
                      class="w-full px-3 py-3 rounded-xl border font-semibold text-sm toggle-btn"
                      data-toggle="chkServerBuff" data-group="server" data-mode="single">
                í™œì„±í™”
              </button>
            </div>
            <input type="checkbox" id="chkServerBuff" hidden>
          </div>

          <!-- ì—°êµ¬ì†ë„ -->
          <div>
            <label for="speedPercent" class="block text-sm font-medium mb-2">ì—°êµ¬ì†ë„ (%)</label>
            <input type="number" id="speedPercent"
                   class="border rounded-xl px-3 py-3 text-sm w-full text-right"
                   placeholder="0" min="0" />
            <div class="mt-1 text-[12px] text-gray-500">ì‹œê°„ ê³„ì‚°ì—ë§Œ ì ìš©</div>
          </div>
        </div>

        <div class="px-4 py-3 border-t border-black/10 flex gap-2">
          <button id="btn-close-options"
                  class="w-1/2 px-4 py-3 rounded-xl border font-semibold">
            ì·¨ì†Œ
          </button>
          <button id="btn-apply-options"
                  class="w-1/2 px-4 py-3 rounded-xl bg-blue-600 text-white font-semibold hover:bg-blue-700">
            ì ìš©
          </button>
        </div>
      </div>
  </div>

  <script>
    /* ========== ë°ì´í„° ========== */
    const researchData = {
      "I": [
        { level: 1, ê°€ë£¨: 16, ì² ê°•ì¬: 5000, ì‹œê°„: "0d 08:00:00" },
        { level: 2, ê°€ë£¨: 25, ì² ê°•ì¬: 8000, ì‹œê°„: "0d 12:48:00" },
        { level: 3, ê°€ë£¨: 41, ì² ê°•ì¬: 13000, ì‹œê°„: "0d 20:48:00" },
        { level: 4, ê°€ë£¨: 68, ì² ê°•ì¬: 21000, ì‹œê°„: "1d 10:24:00" },
        { level: 5, ê°€ë£¨: 102, ì² ê°•ì¬: 33000, ì‹œê°„: "2d 06:00:00" },
      ],
      "II-A": [
        { level: 1, ê°€ë£¨: 40, ì² ê°•ì¬: 10000, ì‹œê°„: "0d 20:00:00" },
        { level: 2, ê°€ë£¨: 56, ì² ê°•ì¬: 14000, ì‹œê°„: "1d 04:00:00" },
        { level: 3, ê°€ë£¨: 74, ì² ê°•ì¬: 18000, ì‹œê°„: "1d 13:00:00" },
        { level: 4, ê°€ë£¨: 102, ì² ê°•ì¬: 25000, ì‹œê°„: "2d 03:00:00" },
        { level: 5, ê°€ë£¨: 136, ì² ê°•ì¬: 24000, ì‹œê°„: "2d 20:00:00" },
        { level: 6, ê°€ë£¨: 184, ì² ê°•ì¬: 46000, ì‹œê°„: "3d 20:00:00" },
        { level: 7, ê°€ë£¨: 248, ì² ê°•ì¬: 62000, ì‹œê°„: "5d 04:00:00" },
        { level: 8, ê°€ë£¨: 334, ì² ê°•ì¬: 83000, ì‹œê°„: "6d 23:00:00" },
      ],
      "II-B": [
        { level: 1, ê°€ë£¨: 40, ì² ê°•ì¬: 10000, ì‹œê°„: "0d 20:00:00" },
        { level: 2, ê°€ë£¨: 56, ì² ê°•ì¬: 14000, ì‹œê°„: "1d 04:00:00" },
        { level: 3, ê°€ë£¨: 74, ì² ê°•ì¬: 18000, ì‹œê°„: "1d 13:00:00" },
        { level: 4, ê°€ë£¨: 102, ì² ê°•ì¬: 25000, ì‹œê°„: "2d 03:00:00" },
        { level: 5, ê°€ë£¨: 136, ì² ê°•ì¬: 24000, ì‹œê°„: "2d 20:00:00" },
        { level: 6, ê°€ë£¨: 184, ì² ê°•ì¬: 46000, ì‹œê°„: "3d 20:00:00" },
        { level: 7, ê°€ë£¨: 248, ì² ê°•ì¬: 62000, ì‹œê°„: "5d 04:00:00" },
        { level: 8, ê°€ë£¨: 334, ì² ê°•ì¬: 83000, ì‹œê°„: "6d 23:00:00" },
      ],
      "III": [
        { level: 1, ê°€ë£¨: 83, ì² ê°•ì¬: 23000, ì‹œê°„: "1d 05:20:17" },
        { level: 2, ê°€ë£¨: 102, ì² ê°•ì¬: 28000, ì‹œê°„: "1d 12:05:08" },
        { level: 3, ê°€ë£¨: 125, ì² ê°•ì¬: 34000, ì‹œê°„: "1d 20:00:25" },
        { level: 4, ê°€ë£¨: 150, ì² ê°•ì¬: 41000, ì‹œê°„: "2d 04:48:30" },
        { level: 5, ê°€ë£¨: 184, ì² ê°•ì¬: 51000, ì‹œê°„: "2d 16:32:37" },
        { level: 6, ê°€ë£¨: 225, ì² ê°•ì¬: 62000, ì‹œê°„: "3d 07:12:45" },
        { level: 7, ê°€ë£¨: 276, ì² ê°•ì¬: 76000, ì‹œê°„: "4d 00:58:56" },
        { level: 8, ê°€ë£¨: 334, ì² ê°•ì¬: 93000, ì‹œê°„: "4d 21:21:08" },
        { level: 9, ê°€ë£¨: 418, ì² ê°•ì¬: 110000, ì‹œê°„: "6d 02:41:25" },
        { level: 10, ê°€ë£¨: 502, ì² ê°•ì¬: 130000, ì‹œê°„: "7d 08:01:42" },
        { level: 11, ê°€ë£¨: 602, ì² ê°•ì¬: 160000, ì‹œê°„: "8d 19:14:02" },
        { level: 12, ê°€ë£¨: 744, ì² ê°•ì¬: 200000, ì‹œê°„: "10d 21:06:31" },
      ],
      "IV-A": [
        { level: 1, ê°€ë£¨: 54, ì² ê°•ì¬: 15000, ì‹œê°„: "0d 18:55:40" },
        { level: 2, ê°€ë£¨: 66, ì² ê°•ì¬: 18000, ì‹œê°„: "0d 23:16:52" },
        { level: 3, ê°€ë£¨: 81, ì² ê°•ì¬: 22000, ì‹œê°„: "1d 04:23:30" },
        { level: 4, ê°€ë£¨: 97, ì² ê°•ì¬: 27000, ì‹œê°„: "1d 10:04:12" },
        { level: 5, ê°€ë£¨: 118, ì² ê°•ì¬: 33000, ì‹œê°„: "1d 17:38:28" },
        { level: 6, ê°€ë£¨: 145, ì² ê°•ì¬: 40000, ì‹œê°„: "2d 03:06:18" },
        { level: 7, ê°€ë£¨: 178, ì² ê°•ì¬: 49000, ì‹œê°„: "2d 14:27:42" },
        { level: 8, ê°€ë£¨: 216, ì² ê°•ì¬: 60000, ì‹œê°„: "3d 03:42:20" },
        { level: 9, ê°€ë£¨: 270, ì² ê°•ì¬: 75000, ì‹œê°„: "3d 22:38:20" },
        { level: 10, ê°€ë£¨: 324, ì² ê°•ì¬: 90000, ì‹œê°„: "4d 17:34:00" },
        { level: 11, ê°€ë£¨: 388, ì² ê°•ì¬: 100000, ì‹œê°„: "5d 16:16:48" },
        { level: 12, ê°€ë£¨: 480, ì² ê°•ì¬: 130000, ì‹œê°„: "7d 00:27:26" },
      ],
      "IV-B": [
        { level: 1, ê°€ë£¨: 54, ì² ê°•ì¬: 15000, ì‹œê°„: "0d 18:55:40" },
        { level: 2, ê°€ë£¨: 66, ì² ê°•ì¬: 18000, ì‹œê°„: "0d 23:16:52" },
        { level: 3, ê°€ë£¨: 81, ì² ê°•ì¬: 22000, ì‹œê°„: "1d 04:23:30" },
        { level: 4, ê°€ë£¨: 97, ì² ê°•ì¬: 27000, ì‹œê°„: "1d 10:04:12" },
        { level: 5, ê°€ë£¨: 118, ì² ê°•ì¬: 33000, ì‹œê°„: "1d 17:38:28" },
        { level: 6, ê°€ë£¨: 145, ì² ê°•ì¬: 40000, ì‹œê°„: "2d 03:06:18" },
        { level: 7, ê°€ë£¨: 178, ì² ê°•ì¬: 49000, ì‹œê°„: "2d 14:27:42" },
        { level: 8, ê°€ë£¨: 216, ì² ê°•ì¬: 60000, ì‹œê°„: "3d 03:42:20" },
        { level: 9, ê°€ë£¨: 270, ì² ê°•ì¬: 75000, ì‹œê°„: "3d 22:38:20" },
        { level: 10, ê°€ë£¨: 324, ì² ê°•ì¬: 90000, ì‹œê°„: "4d 17:34:00" },
        { level: 11, ê°€ë£¨: 388, ì² ê°•ì¬: 100000, ì‹œê°„: "5d 16:16:48" },
        { level: 12, ê°€ë£¨: 480, ì² ê°•ì¬: 130000, ì‹œê°„: "7d 00:27:26" },
      ],
      "V": [
        { level: 1, ê°€ë£¨: 2236, ì² ê°•ì¬: 1000000, ì‹œê°„: "91d 08:15:00" },
      ],
      "Healing": [
        { level: 1, ê°€ë£¨: 102, ì² ê°•ì¬: 30000, ì‹œê°„: "2d 02:00:00" },
        { level: 2, ê°€ë£¨: 137, ì² ê°•ì¬: 40000, ì‹œê°„: "2d 19:30:00" },
        { level: 3, ê°€ë£¨: 188, ì² ê°•ì¬: 55000, ì‹œê°„: "3d 20:30:00" },
        { level: 4, ê°€ë£¨: 255, ì² ê°•ì¬: 75000, ì‹œê°„: "5d 05:00:00" },
        { level: 5, ê°€ë£¨: 341, ì² ê°•ì¬: 100000, ì‹œê°„: "6d 23:30:00" },
        { level: 6, ê°€ë£¨: 459, ì² ê°•ì¬: 130000, ì‹œê°„: "9d 09:00:00" },
        { level: 7, ê°€ë£¨: 612, ì² ê°•ì¬: 180000, ì‹œê°„: "12d 12:00:00" },
        { level: 8, ê°€ë£¨: 836, ì² ê°•ì¬: 240000, ì‹œê°„: "17d 02:00:00" },
        { level: 9, ê°€ë£¨: 1122, ì² ê°•ì¬: 330000, ì‹œê°„: "22d 22:00:00" },
        { level: 10, ê°€ë£¨: 1530, ì² ê°•ì¬: 450000, ì‹œê°„: "31d 06:00:00" },
      ],
      "Training": [
        { level: 1, ê°€ë£¨: 102, ì² ê°•ì¬: 30000, ì‹œê°„: "2d 02:00:00" },
        { level: 2, ê°€ë£¨: 137, ì² ê°•ì¬: 40000, ì‹œê°„: "2d 19:30:00" },
        { level: 3, ê°€ë£¨: 188, ì² ê°•ì¬: 55000, ì‹œê°„: "3d 20:30:00" },
        { level: 4, ê°€ë£¨: 255, ì² ê°•ì¬: 75000, ì‹œê°„: "5d 05:00:00" },
        { level: 5, ê°€ë£¨: 341, ì² ê°•ì¬: 100000, ì‹œê°„: "6d 23:30:00" },
        { level: 6, ê°€ë£¨: 459, ì² ê°•ì¬: 130000, ì‹œê°„: "9d 09:00:00" },
        { level: 7, ê°€ë£¨: 612, ì² ê°•ì¬: 180000, ì‹œê°„: "12d 12:00:00" },
        { level: 8, ê°€ë£¨: 836, ì² ê°•ì¬: 240000, ì‹œê°„: "17d 02:00:00" },
        { level: 9, ê°€ë£¨: 1122, ì² ê°•ì¬: 330000, ì‹œê°„: "22d 22:00:00" },
        { level: 10, ê°€ë£¨: 1530, ì² ê°•ì¬: 450000, ì‹œê°„: "31d 06:00:00" },
      ],
      "HealingTime": [
        { level: 1, ê°€ë£¨: 51, ì² ê°•ì¬: 15000, ì‹œê°„: "1d 01:00:00" },
        { level: 2, ê°€ë£¨: 68, ì² ê°•ì¬: 20000, ì‹œê°„: "1d 09:45:00" },
        { level: 3, ê°€ë£¨: 94, ì² ê°•ì¬: 27000, ì‹œê°„: "1d 22:15:00" },
        { level: 4, ê°€ë£¨: 127, ì² ê°•ì¬: 37000, ì‹œê°„: "2d 14:30:00" },
        { level: 5, ê°€ë£¨: 170, ì² ê°•ì¬: 50000, ì‹œê°„: "3d 11:45:00" },
        { level: 6, ê°€ë£¨: 229, ì² ê°•ì¬: 67000, ì‹œê°„: "4d 16:30:00" },
        { level: 7, ê°€ë£¨: 306, ì² ê°•ì¬: 90000, ì‹œê°„: "6d 06:00:00" },
        { level: 8, ê°€ë£¨: 418, ì² ê°•ì¬: 120000, ì‹œê°„: "8d 13:00:00" },
        { level: 9, ê°€ë£¨: 561, ì² ê°•ì¬: 160000, ì‹œê°„: "11d 11:00:00" },
        { level: 10, ê°€ë£¨: 765, ì² ê°•ì¬: 220000, ì‹œê°„: "15d 15:00:00" },
      ]
    };

    // âœ… ë°œë ˆë¦¬ì•„(SVS ì ìˆ˜ ë³´ë„ˆìŠ¤)
    const EXPERT_BONUS = {
      "None":0,
      "Lv.1":0.02,"Lv.2":0.04,"Lv.3":0.06,"Lv.4":0.08,"Lv.5":0.10,
      "Lv.6":0.12,"Lv.7":0.14,"Lv.8":0.16,"Lv.9":0.18,"Lv.10":0.20
    };
    const EXPERT_DESC = {
      "Lv.1":  "+2%","Lv.2":  "+4%","Lv.3":  "+6%","Lv.4":  "+8%","Lv.5":  "+10%",
      "Lv.6":  "+12%","Lv.7":  "+14%","Lv.8":  "+16%","Lv.9":  "+18%","Lv.10": "+20%"
    };

    function getValeriaBonus(){
      const sel = document.getElementById("chkExpertV");
      if (!sel) return 0;
      const key = (sel.value || sel.options[sel.selectedIndex]?.text || "None").trim();
      return EXPERT_BONUS[key] ?? 0;
    }

    function getValeriaDesc(){
      const expertSel = document.getElementById("chkExpertV");
      const lv = expertSel.value;
      const text = EXPERT_DESC[lv]
        ? "SvS ì ìˆ˜ " + EXPERT_DESC[lv]
        : "SvS ì ìˆ˜";

      document.querySelectorAll(".svs-score-label").forEach(el => {
        el.textContent = text;
      });

      // íŒì—… íŒíŠ¸ë„ ê°™ì´
      const hint = document.getElementById("valeriaHint");
      if (hint) hint.textContent = text;
    }
    
    function updateBottomVisibility(){
      const anyChecked = researchList.some(item => document.getElementById(`use-${item.key}`)?.checked);
      document.getElementById("summaryPanel")?.classList.toggle("hidden", !anyChecked);
      document.getElementById("btn-calc-total")?.classList.toggle("hidden", !anyChecked);
      if (!anyChecked) document.getElementById("svs")?.classList.add("hidden");
    }

    /* ========== ìƒíƒœ & ìœ í‹¸ ========== */
    let researchList = [];

    function parseTimeToSeconds(timeStr) {
      const [d, hms] = timeStr.split(" ");
      const [h, m, s] = hms.split(":").map(Number);
      return (parseInt(d)||0)*86400 + h*3600 + m*60 + s;
    }
    
    function formatTime(sec) {
      const d = Math.floor(sec / 86400);
      sec %= 86400;
      const h = Math.floor(sec / 3600);
      sec %= 3600;
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return `${d}d ${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }
    
    function createLevelOptions(max) {
      return Array.from({length:max+1}, (_,i)=>`<option value="${i}">${i}</option>`).join('');
    }

    function updateResearchList() {
      const chkInf = document.getElementById("chkInf");
      const chkLan = document.getElementById("chkLan");
      const chkMask = document.getElementById("chkMask");

      researchList = Object.entries(researchData).map(([key, value]) => {
        let label = {
          "I": "ë¶ˆê½ƒ ë¶€ëŒ€",
          "II-A": "íŒŒê´´ë ¥ ì—°êµ¬",
          "II-B" : "HP ì—°êµ¬",
          "III" : "ë¶ˆê½ƒ êµ°ë‹¨",
          "IV-A" : "ê³µê²©ë ¥ ì—°êµ¬",
          "IV-B" : "ë°©ì–´ë ¥ ì—°êµ¬",
          "V" : "í—¬ë¦¬ì˜¤ìŠ¤ ë³‘ì‚¬",
          "Healing" : "ì¹˜ë£Œ ì—°êµ¬",
          "Training" : "í›ˆë ¨ ì—°êµ¬",
          "HealingTime" : "êµ¬ê¸‰ ì—°êµ¬",
        }[key];

        switch (key) {
          case "II-A":
            if (chkInf.checked) label = "ë¶ˆê½ƒ ê³µê²©";
            else if (chkLan.checked) label = "ë¶ˆì˜ ëŒê²©";
            else if (chkMask.checked) label = "ìˆ˜ì •ì˜ ì‹œì•¼";
            break;
          case "II-B":
            if (chkInf.checked) label = "ë¶ˆê½ƒ ë°©íŒ¨";
            else if (chkLan.checked) label = "ë¶ˆì˜ ë°©ì–´";
            else if (chkMask.checked) label = "ìˆ˜ì • ê°‘ì˜·";
            break;
          case "IV-A":
            if (chkInf.checked) label = "ë¶ˆê½ƒ ë„ë¼";
            else if (chkLan.checked) label = "ë¶ˆì˜ ì°½";
            else if (chkMask.checked) label = "ìˆ˜ì • í™”ì‚´";
            break;
          case "IV-B":
            if (chkInf.checked) label = "ë¶ˆê½ƒ ìˆ˜í˜¸";
            else if (chkLan.checked) label = "ë¶ˆì˜ ìˆ˜í˜¸";
            else if (chkMask.checked) label = "ìˆ˜ì •ì˜ ê°€í˜¸";
            break;
        }
        return { key, label, max: Math.max(...value.map(v=>v.level)) };
      });
    }

    function getTroopCode(){
      if (document.getElementById("chkInf")?.checked) return "inf";   // ë°©íŒ¨
      if (document.getElementById("chkLan")?.checked) return "lan";   // ì°½
      if (document.getElementById("chkMask")?.checked) return "marsk"; // ê¶
      return "inf";
    }

    function renderResearchCards() {
      const container = document.getElementById("researchGrid");

      /* âœ… ëª¨ë°”ì¼ ìš°ì„ : 1ì—´ / í° í™”ë©´ì—ì„œë§Œ 2~3ì—´ */
      container.className = "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 mb-4";
      container.innerHTML = "";

      const POS = {
        "I": {r:1,c:2},
        "II-A": {r:2,c:1},
        "II-B": {r:2,c:3},
        "III": {r:3,c:2},
        "IV-A": {r:4,c:1},
        "IV-B": {r:4,c:3},
        "V": {r:5,c:2},
        "Healing": {r:6,c:1},
        "Training": {r:7,c:2},
        "HealingTime": {r:6,c:3}
      };

      researchList.forEach(item => {
        const wrap = document.createElement("div");
        wrap.className = "exp-card";

        /* âœ… ëª¨ë°”ì¼ì—ì„œëŠ” gridRow/Col ê°•ì œë°°ì¹˜ê°€ ì˜¤íˆë ¤ ê¹¨ì ¸ì„œ:
           - lg ì´ìƒì—ì„œë§Œ POS ì ìš© */
        if (window.matchMedia("(min-width: 1024px)").matches && POS[item.key]) {
          wrap.style.gridRowStart = POS[item.key].r;
          wrap.style.gridColumnStart = POS[item.key].c;
        }

        const curId = `current-${item.key}`;
        const tgtId = `target-${item.key}`;

        const troop = getTroopCode();
        const imgSrc = `images/helios/${troop}/${troop}-${item.key}.webp`;
        // renderResearchCards() ì•ˆì—ì„œ wrap.innerHTML ë¶€ë¶„
        const useId   = `use-${item.key}`;
        const panelId = `panel-${item.key}`;

        wrap.innerHTML = `
          <div class="p-3">
            <!-- âœ… ë¹Œë”©ì²˜ëŸ¼: 2ì»¬ëŸ¼ ê·¸ë¦¬ë“œ / ì•„ë˜ íŒ¨ë„ì€ ì „ì²´í­ -->
            <div class="grid grid-cols-[96px_1fr] gap-3 items-start">

              <!-- LEFT: ì´ë¯¸ì§€ -->
              <div class="w-[96px] h-[96px] flex-shrink-0 rounded-2xl border overflow-hidden
                          bg-gray-100 dark:bg-[#1e1e1e] flex items-center justify-center">
                <img src="${imgSrc}" class="w-full h-full object-contain" alt="card-icon" loading="lazy" />
              </div>

              <!-- RIGHT: ì œëª©/ìµœëŒ€ë ˆë²¨ -->
              <div class="min-w-0">
                <label class="flex items-center gap-2 cursor-pointer select-none">
                  <input type="checkbox" id="${useId}" class="w-4 h-4 accent-blue-600">
                  <span class="text-[15px] font-semibold text-gray-800 leading-tight">${item.label}</span>
                </label>
                <div class="mt-1 muted">ìµœëŒ€ Lv.${item.max}</div>
              </div>

              <!-- âœ… ì²´í¬ ì‹œì—ë§Œ ë³´ì—¬ì¤„ ì˜ì—­ (ì „ì²´í­ col-span-2) -->
              <div id="${panelId}" class="hidden col-span-2 w-full">
                <!-- í˜„ì¬/ëª©í‘œ -->
                <div class="mt-2 grid grid-cols-[auto_1fr_auto_1fr] gap-2 items-center">
                  <span class="text-[12px] text-gray-600">í˜„ì¬</span>
                  <select id="${curId}" class="border rounded-lg px-2 py-2 text-sm w-full">
                    ${createLevelOptions(item.max)}
                  </select>

                  <span class="text-[12px] text-gray-600">ëª©í‘œ</span>
                  <select id="${tgtId}" class="border rounded-lg px-2 py-2 text-sm w-full">
                    ${createLevelOptions(item.max)}
                  </select>
                </div>

                <!-- í•„ìš”í•©ê³„ -->
                <div class="mt-3 w-full rounded-xl border border-black/10 p-3">
                  <div class="font-semibold text-gray-800 mb-2">í•„ìš” í•©ê³„</div>

                  <div class="grid grid-cols-[1fr_auto] gap-x-3 gap-y-1 text-[13px]">
                    <div class="text-gray-600">ë¶ˆìˆ˜ì¡°ê°</div>
                    <div class="text-right tabular-nums" id="subtotal-dust-${item.key}">0</div>

                    <div class="text-gray-600">ì² ê°•ì¬</div>
                    <div class="text-right tabular-nums" id="subtotal-steel-${item.key}">0</div>

                    <div class="text-gray-600">ì†Œìš”ì‹œê°„</div>
                    <div class="text-right tabular-nums" id="subtotal-time-${item.key}">0</div>

                    <div class="col-span-2 border-t border-gray-200 dark:border-[#444] my-1"></div>

                    <div class="svs-score-label text-gray-600">SVS ì ìˆ˜</div>
                    <div id="sub-ì ìˆ˜-${item.label}" class="svs-score-value text-right tabular-nums font-medium">0</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        container.appendChild(wrap);

        const useChk  = wrap.querySelector(`#${useId}`);
        const panel   = wrap.querySelector(`#${panelId}`);
        const curSel  = wrap.querySelector(`#${curId}`);
        const tgtSel  = wrap.querySelector(`#${tgtId}`);

        // âœ… ì´ˆê¸°: ë¬´ì¡°ê±´ ì ‘í˜ + ë“œëë‹¤ìš´ ë¹„í™œì„±
        panel.classList.add("hidden");
        curSel.disabled = true;
        tgtSel.disabled = true;

        useChk.addEventListener("change", () => {
          const on = useChk.checked;

          // âœ… ì²´í¬ëœ ê²½ìš°ë§Œ íŒ¨ë„ í‘œì‹œ
          panel.classList.toggle("hidden", !on);

          // âœ… ì²´í¬ëœ ê²½ìš°ë§Œ ë“œëë‹¤ìš´ í™œì„±
          curSel.disabled = !on;
          tgtSel.disabled = !on;

          // ì²´í¬ ì¼°ì„ ë•Œ ê¸°ë³¸ ëª©í‘œ = í˜„ì¬+1
          if (on) {
            let nextValue = parseInt(curSel.value, 10) + 1;
            if (nextValue > item.max) nextValue = item.max;
            if (parseInt(tgtSel.value, 10) <= parseInt(curSel.value, 10)) {
              tgtSel.value = String(nextValue);
            }
          }

          scheduleCalc();
          updateBottomVisibility();  // ì•„ë˜ #2ì—ì„œ ì¶”ê°€
        });

        // âœ… ë“œëë‹¤ìš´ ì´ë²¤íŠ¸(ì²´í¬ëœ ìƒíƒœì—ì„œë§Œ)
        curSel.addEventListener("change", () => {
          if (!useChk.checked) return;
          let nextValue = parseInt(curSel.value,10) + 1;
          if (nextValue > item.max) nextValue = item.max;
          tgtSel.value = String(nextValue);
          scheduleCalc();
        });

        tgtSel.addEventListener("change", () => {
          if (!useChk.checked) return;
          scheduleCalc();
        });
      });
    }

    /* ========== ì˜µì…˜ í† ê¸€ ë¡œì§(ê¸°ì¡´ ìœ ì§€) ========== */
    function handleCheck(toggleId) {
      const chkInf = document.getElementById("chkInf");
      const chkLan = document.getElementById("chkLan");
      const chkMask = document.getElementById("chkMask");

      if (toggleId === "chkInf" && chkInf.checked) {
        chkLan.checked = false; chkMask.checked = false;
      } else if (toggleId === "chkLan" && chkLan.checked) {
        chkInf.checked = false; chkMask.checked = false;
      } else if (toggleId === "chkMask" && chkMask.checked) {
        chkInf.checked = false; chkLan.checked = false;
      }
      updateResearchList();
      renderResearchCards();
      scheduleCalc();
      renderOptionChips();
    }

    function handleVPCheck(toggleId) {
      const chkVP10 = document.getElementById("chkVP10");
      const chkVP15 = document.getElementById("chkVP15");
      if (toggleId === "chkVP10" && chkVP10.checked) chkVP15.checked = false;
      else if (toggleId === "chkVP15" && chkVP15.checked) chkVP10.checked = false;
      scheduleCalc();
      renderOptionChips();
    }

    /* ========== ì˜µì…˜ ì¹©(ìš”ì•½) ========== */
    function renderOptionChips(){
      const wrap = document.getElementById("optionChips");
      if (!wrap) return;

      const vp10 = document.getElementById("chkVP10")?.checked;
      const vp15 = document.getElementById("chkVP15")?.checked;
      const server = document.getElementById("chkServerBuff")?.checked;
      const speed = (parseFloat(document.getElementById("speedPercent")?.value) || 0);
      const val = document.getElementById("chkExpertV")?.value || "None";

      const chips = [];
      chips.push(`<span class="chip"><b>VP</b> ${vp15 ? "15%" : vp10 ? "10%" : "ì—†ìŒ"}</span>`);
      chips.push(`<span class="chip"><b>ë°œë ˆë¦¬ì•„</b> ${val}</span>`);
      chips.push(`<span class="chip"><b>ì„œë²„</b> ${server ? "ON" : "OFF"}</span>`);
      chips.push(`<span class="chip"><b>ì†ë„</b> ${speed ? (speed + "%") : "0%"}</span>`);

      wrap.innerHTML = chips.join("");
    }

    /* ========== íŒì—… ì—´ê¸°/ë‹«ê¸°/ì ìš© ========== */
    const modal = document.getElementById("opt-modal-backdrop");
    const btnOpen = document.getElementById("btn-open-options");
    const btnClose = document.getElementById("btn-close-options");
    const btnCloseX = document.getElementById("btn-close-options-x");
    const btnApply = document.getElementById("btn-apply-options");

    function openOptions(){
      modal.classList.remove("hidden");
      getValeriaDesc();

      // í† ê¸€ ë²„íŠ¼ ìƒíƒœ(ì²´í¬ë°•ìŠ¤ ê¸°ë°˜) ë™ê¸°í™”
      document.querySelectorAll('.toggle-btn').forEach(btn=>{
        const chk = document.getElementById(btn.dataset.toggle);
        if (chk) btn.classList.toggle('is-on', chk.checked);
      });

    }

    function closeOptions(){
      modal.classList.add("hidden");
    }

    function applyOptions(){
      // ì´ë¯¸ ë²„íŠ¼ í´ë¦­ìœ¼ë¡œ ì²´í¬ë°•ìŠ¤/ì¸í’‹ ê°’ì´ ë°”ë€Œì–´ ìˆìŒ â†’ ê·¸ëŒ€ë¡œ ì ìš©
      getValeriaDesc();
      renderOptionChips();
      scheduleCalc();
      closeOptions();
    }

    btnOpen?.addEventListener("click", openOptions);
    btnClose?.addEventListener("click", closeOptions);
    btnCloseX?.addEventListener("click", closeOptions);
    btnApply?.addEventListener("click", applyOptions);

    // ë°°ê²½ í´ë¦­ ë‹«ê¸°
    modal?.addEventListener("click", (e)=>{
      if (e.target === modal) closeOptions();
    });

    /* ===== í•µì‹¬: ë²„íŠ¼ â†’ ì²´í¬ë°•ìŠ¤ â†’ ê¸°ì¡´ ë¡œì§ ===== */
    function setBtn(btn,on){ btn.classList.toggle('is-on',on); }

    // toggle-btn í´ë¦­ ë°”ì¸ë”©
    document.querySelectorAll('.toggle-btn').forEach(btn=>{
      const chk = document.getElementById(btn.dataset.toggle);
      if (chk) btn.classList.toggle('is-on', chk.checked);

      btn.addEventListener('click', () => {
        const group = btn.dataset.group;

        if (group === 'troop') {
          document.querySelectorAll('.toggle-btn[data-group="troop"]').forEach(b=>{
            const c = document.getElementById(b.dataset.toggle);
            c.checked = false;
            b.classList.remove('is-on');
          });
          chk.checked = true;
          btn.classList.add('is-on');
        } else if (group === 'vp') {
          // VPëŠ” ë‹¨ì¼
          document.querySelectorAll('.toggle-btn[data-group="vp"]').forEach(b=>{
            const c = document.getElementById(b.dataset.toggle);
            c.checked = false;
            b.classList.remove('is-on');
          });
          chk.checked = true;
          btn.classList.add('is-on');
        } else {
          // server ë“± í† ê¸€
          chk.checked = !chk.checked;
          btn.classList.toggle('is-on', chk.checked);
        }

        chk.dispatchEvent(new Event('change', { bubbles:true }));
      });
    });

    /* ========== ì´ë²¤íŠ¸(ê¸°ì¡´ ìœ ì§€ + ì¹© ë°˜ì˜) ========== */
    document.addEventListener("change", (e) => {
      const id = e.target.id;

      if (id === "chkInf") handleCheck("chkInf");
      if (id === "chkLan") handleCheck("chkLan");
      if (id === "chkMask") handleCheck("chkMask");

      if (id === "chkVP10") handleVPCheck("chkVP10");
      if (id === "chkVP15") handleVPCheck("chkVP15");

      if (id === "chkServerBuff") { scheduleCalc(); renderOptionChips(); }
      if (id === "speedPercent") { scheduleCalc(); renderOptionChips(); }
      if (id === "chkExpertV") { getValeriaDesc(); scheduleCalc(); renderOptionChips(); }

      if (id === "owned-ê°€ë£¨" || id === "owned-ì² ê°•ì¬") scheduleCalc();
    });

    function goBack(){
      if (window.parent && typeof window.parent.loadPage === "function"){
        window.parent.loadPage("researchchoice.html");
      } else {
        location.href = "researchchoice.html";
      }
    }
    
    /* ========== ê³„ì‚° ë¡œì§(ì´í•© ë²„íŠ¼ í´ë¦­ ì „ìš©) ========== */
    function calculateTotals(){
      let total = { ê°€ë£¨: 0, ì² ê°•ì¬: 0, ì‹œê°„: 0 };

      let factor = (parseFloat(document.getElementById("speedPercent").value) || 0) * 0.01 + 1;
      if (document.getElementById("chkVP10").checked) factor += 0.10;
      if (document.getElementById("chkVP15").checked) factor += 0.15;
      if (document.getElementById("chkServerBuff").checked) factor += 0.10;

      researchList.forEach(item => {
        if (!document.getElementById(`use-${item.key}`)?.checked) return;

        const curEl = document.getElementById(`current-${item.key}`);
        const tgtEl = document.getElementById(`target-${item.key}`);
        if (!curEl || !tgtEl) return;

        const cur = parseInt(curEl.value, 10);
        const tgt = parseInt(tgtEl.value, 10);
        if (!Number.isFinite(cur) || !Number.isFinite(tgt) || cur >= tgt) return;

        const data = researchData[item.key] || [];
        for (let lv = cur + 1; lv <= tgt; lv++) {
          const row = data.find(r => r.level === lv);
          if (!row) continue;

          total.ê°€ë£¨ += row.ê°€ë£¨ || 0;
          total.ì² ê°•ì¬ += row.ì² ê°•ì¬ || 0;
          total.ì‹œê°„ += parseTimeToSeconds(row.ì‹œê°„) || 0;
        }
      });

      return { total, factor };
    }

    function renderSummary(){
      const { total, factor } = calculateTotals();

      const ownedDust  = parseFloat(document.getElementById("owned-ê°€ë£¨").value) || 0;
      const ownedSteel = parseFloat(document.getElementById("owned-ì² ê°•ì¬").value) || 0;

      const totalTime = Math.round(total.ì‹œê°„ / factor);

      document.getElementById("sum-ê°€ë£¨").textContent   = total.ê°€ë£¨.toLocaleString();
      document.getElementById("sum-ì² ê°•ì¬").textContent = total.ì² ê°•ì¬.toLocaleString();
      document.getElementById("sum-ì‹œê°„").textContent   = formatTime(totalTime);

      const defA = document.getElementById("def-ê°€ë£¨");
      const defB = document.getElementById("def-ì² ê°•ì¬");

      const vA = ownedDust - total.ê°€ë£¨;
      const vB = ownedSteel - total.ì² ê°•ì¬;

      defA.textContent = vA.toLocaleString();
      defB.textContent = vB.toLocaleString();

      defA.classList.toggle("text-red-600", vA < 0);
      defB.classList.toggle("text-red-600", vB < 0);

      // âœ… SVS í•©ì‚°(ë²„íŠ¼ í´ë¦­ ì‹œì—ë§Œ)
      let totalSVS = 0;
      researchList.forEach(item => {
        if (!document.getElementById(`use-${item.key}`)?.checked) return;

        const scoreEl = document.getElementById(`sub-ì ìˆ˜-${item.label}`);
        if (!scoreEl) return;
        const v = parseFloat(String(scoreEl.textContent || "0").replace(/,/g, "")) || 0;
        totalSVS += v;
      });

      const svsInput = document.getElementById("svspoint");
      if (svsInput) svsInput.value = Math.floor(totalSVS).toLocaleString();
    }

    document.getElementById("btn-calc-total")?.addEventListener("click", () => {
      document.getElementById("svs")?.classList.remove("hidden");
      renderSummary();
    });

    /* ========== ê³„ì‚° ë¡œì§(ìë™: ì¹´ë“œë³„ subtotalë§Œ) ========== */
    function calculateResearch() {
      let total = { ê°€ë£¨: 0, ì² ê°•ì¬: 0, ì‹œê°„: 0 };

      let factor = (parseFloat(document.getElementById("speedPercent").value) || 0) * 0.01 + 1;
      if (document.getElementById("chkVP10").checked) factor += 0.10;
      if (document.getElementById("chkVP15").checked) factor += 0.15;
      if (document.getElementById("chkServerBuff").checked) factor += 0.10;

      researchList.forEach(item => {
        const dEl = document.getElementById(`subtotal-dust-${item.key}`);
        const sEl = document.getElementById(`subtotal-steel-${item.key}`);
        const tEl = document.getElementById(`subtotal-time-${item.key}`);
        if (dEl) dEl.textContent = "0";
        if (sEl) sEl.textContent = "0";
        if (tEl) tEl.textContent = "0";
      });

      researchList.forEach(item => {
        const use = document.getElementById(`use-${item.key}`)?.checked;
        if (!use) {
          // ì²´í¬ ì•ˆëœ ì¹´ë“œëŠ” ê°’ë„ 0 ìœ ì§€
          const dEl = document.getElementById(`subtotal-dust-${item.key}`);
          const sEl = document.getElementById(`subtotal-steel-${item.key}`);
          const tEl = document.getElementById(`subtotal-time-${item.key}`);
          if (dEl) dEl.textContent = "0";
          if (sEl) sEl.textContent = "0";
          if (tEl) tEl.textContent = "0";
          const scoreEl = document.getElementById(`sub-ì ìˆ˜-${item.label}`);
          if (scoreEl) scoreEl.textContent = "0";
          return;
        }

        const curEl = document.getElementById(`current-${item.key}`);
        const tgtEl = document.getElementById(`target-${item.key}`);
        if (!curEl || !tgtEl) return;

        const cur = parseInt(curEl.value);
        const tgt = parseInt(tgtEl.value);
        const data = researchData[item.key];
        const subtotal = { ê°€ë£¨: 0, ì² ê°•ì¬: 0, ì‹œê°„: 0 };

        if (cur < tgt) {
          for (let lv = cur + 1; lv <= tgt; lv++) {
            const row = data.find(r => r.level === lv);
            if (!row) continue;
            subtotal.ê°€ë£¨ += row.ê°€ë£¨ || 0;
            subtotal.ì² ê°•ì¬ += row.ì² ê°•ì¬ || 0;
            subtotal.ì‹œê°„ += parseTimeToSeconds(row.ì‹œê°„) || 0;
          }
        }

        const dEl = document.getElementById(`subtotal-dust-${item.key}`);
        const sEl = document.getElementById(`subtotal-steel-${item.key}`);
        const tEl = document.getElementById(`subtotal-time-${item.key}`);
        if (dEl) dEl.textContent = subtotal.ê°€ë£¨.toLocaleString();
        if (sEl) sEl.textContent = subtotal.ì² ê°•ì¬.toLocaleString();
        if (tEl) tEl.textContent = formatTime(Math.round(subtotal.ì‹œê°„ / factor));

        // âœ… SVS ì ìˆ˜
        const shard = (subtotal.ê°€ë£¨ * 1000);
        const vBonus = getValeriaBonus();
        const sScore = Math.floor(shard * (1 + vBonus));
        const tScore = Math.floor((subtotal.ì‹œê°„/60) * (1 + vBonus));
        const finalScore = sScore + tScore;

        const scoreEl = document.getElementById(`sub-ì ìˆ˜-${item.label}`);
        if (scoreEl) scoreEl.textContent = finalScore.toLocaleString();

        if (cur < tgt) {
          total.ê°€ë£¨ += subtotal.ê°€ë£¨;
          total.ì² ê°•ì¬ += subtotal.ì² ê°•ì¬;
          total.ì‹œê°„ += subtotal.ì‹œê°„;
        }
      });

      sendHeightToParent();
    }

    let calcTimer = null;
    function scheduleCalc() {
      if (calcTimer) clearTimeout(calcTimer);
      calcTimer = setTimeout(calculateResearch, 120);
    }

    // ì´ˆê¸° ì„¸íŒ…
    updateResearchList();
    renderResearchCards();
    getValeriaDesc();
    renderOptionChips();
    updateBottomVisibility();
    scheduleCalc();

    // ìˆ«ì ì…ë ¥ ì¦‰ì‹œ ê³„ì‚°
    ["owned-ê°€ë£¨","owned-ì² ê°•ì¬","speedPercent"].forEach(id=>{
      const el = document.getElementById(id);
      if (el) el.addEventListener("input", scheduleCalc);
    });

    let __lastSentH = 0;

    function getContentHeight(){
      const root = document.getElementById("appRoot");
      if (!root) return document.documentElement.scrollHeight || document.body.scrollHeight || 0;

      // rootì˜ ì‹¤ì œ ì½˜í…ì¸  ë†’ì´(ë·°í¬íŠ¸ ìµœì†Œê°’ ì˜í–¥ ëœ ë°›ìŒ)
      const h = Math.ceil(root.getBoundingClientRect().height);
      return h;
    }

    function sendHeightToParent() {
      const height = getContentHeight() + 12; // ì•½ê°„ ì—¬ìœ 
      if (!height) return;

      // âœ… ê°™ì€ ê°’ ê³„ì† ë³´ë‚´ì§€ ì•Šê¸° (ë£¨í”„ ì°¨ë‹¨)
      if (Math.abs(height - __lastSentH) < 2) return;
      __lastSentH = height;

      window.parent.postMessage({ type: "FRAME_CHANGE", height }, "*");
    }

  </script>

  <script>
    // F12, Ctrl+Shift+I, Ctrl+U ë“± ë°©ì§€
    document.onkeydown = function (e) {
      if (
        e.keyCode === 123 || // F12
        (e.ctrlKey && e.shiftKey && e.keyCode === 73) || // Ctrl+Shift+I
        (e.ctrlKey && e.shiftKey && e.keyCode === 74) || // Ctrl+Shift+J
        (e.ctrlKey && e.keyCode === 85) // Ctrl+U
      ) {
        e.preventDefault();
        return false;
      }
    };
    document.addEventListener("contextmenu", (e) => e.preventDefault());
  </script>

  <script>
    window.addEventListener('message', (e) => {
      if (e.data?.type === 'DARK_MODE') {
        document.body.classList.toggle('dark-mode', e.data.value);
      }
    });
  </script>
</body>
</html>
