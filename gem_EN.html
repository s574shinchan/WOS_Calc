<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Charm Calculator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .muted{color:#6b7280}
    .inline-label{display:flex;align-items:center;gap:.5rem}
    .tabular-nums{font-variant-numeric: tabular-nums}
    .err{color:#b45309}

    /* Dark mode */
    body.dark-mode{background-color:#121212;color:#f0f0f0}
    .dark-mode .border{border-color:#444!important}
    .dark-mode .bg-white{background-color:#2c2c2c!important;color:#f0f0f0!important}
    .dark-mode .bg-gray-100{background-color:#1e1e1e!important}
    .dark-mode .text-gray-800,.dark-mode .text-gray-700,.dark-mode .text-gray-600{color:#f0f0f0!important}
    .dark-mode .muted{ color:#f0f0f0 !important; }
    .dark-mode select option{color:#000!important}
    .dark-mode select{color:#000!important}
    .dark-mode input{color:#000!important}
  </style>
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
      }
    });
  </script>
</head>

<body class="bg-gray-100 p-3 font-sans text-sm">
  <div class="max-w-[1500px] mx-auto bg-white p-2 rounded-xl shadow-md">

    <header class="p-4">
      <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight text-gray-800">
        üíé Charm Calculator
      </h1>
      <p class="text-sm muted mt-1">
        Calculate total <b>Charm Guide / Charm Design / Charm Secrets</b> required.
      </p>
      <p class="text-xs muted mt-1">
        Totals are calculated <b>only when clicking [üìä Calculate]</b>.
      </p>
      <p id="loadHint" class="text-xs muted mt-1"></p>
    </header>

    <!-- Input Sections -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-4" id="InputSections"></section>

    <!-- List / Result -->
    <div class="grid md:grid-cols-2 gap-3 mt-4">
      <!-- List -->
      <div class="bg-white border rounded-xl shadow-sm p-3">
        <div class="flex justify-between items-center mb-2">
          <h2 class="text-base font-bold text-gray-700">üìã Selected Items</h2>
          <div class="flex gap-x-2">
            <button id="calculateFromList" class="text-blue-500 text-sm hover:underline">
              üìä Calculate
            </button>
            <button id="clearList" class="text-sm text-red-600 hover:underline">
              üßπ Clear
            </button>
          </div>
        </div>
        <div class="space-y-1 text-sm" id="listContainer"></div>
        <div class="text-xs muted mt-2">Duplicates are allowed.</div>
      </div>

      <!-- Result -->
      <div class="bg-white border rounded-xl shadow-sm p-3">
        <h2 class="text-base font-bold text-gray-700">üìà Result</h2>
        <div id="resultContainer" class="mt-2 overflow-auto">
          <div class="text-sm text-gray-600">
            Add items and click <b>[üìä Calculate]</b>.
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ===================== iframe height report ===================== */
function sendHeightToParent() {
  const height = document.body.scrollHeight + 10;
  window.parent?.postMessage?.({ type: "FRAME_CHANGE", height }, "*");
}
window.addEventListener("load", () => setTimeout(sendHeightToParent, 120));

/* ===================== DATA ===================== */
const csvUrl = "https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/chief/Gem.csv";

let levels=[], stepGuide=[], stepDesign=[], stepSecrets=[], levelToIdx=new Map();
let items=[];

const fmt=n=>Number(n||0).toLocaleString();

/* ===================== CSV ===================== */
function parseCSV(text){
  const lines=text.split("\n").map(l=>l.trim()).filter(Boolean);
  const M=[],D=[],S=[],L=[];
  for(let i=1;i<lines.length;i++){
    const [lv,g,d,s]=lines[i].split(",");
    L.push(+lv); M.push(+g); D.push(+d); S.push(+s);
  }
  return {L,M,D,S};
}

/* ===================== INIT ===================== */
fetch(csvUrl)
  .then(r => {
    if(!r.ok) throw new Error("HTTP " + r.status);
    return r.text();
  })
  .then(t=>{
    const p=parseCSV(t);
    levels=p.L;

    for(let i=0;i<levels.length-1;i++){
      stepGuide[i]=p.M[i+1];
      stepDesign[i]=p.D[i+1];
      stepSecrets[i]=p.S[i+1];
      levelToIdx.set(levels[i],i);
    }
    createSections();
    renderList();
    document.getElementById("loadHint").textContent = "";
    sendHeightToParent();
  })
  .catch(err=>{
    console.error("CSV load failed:", err);
    document.getElementById("loadHint").textContent =
      "‚ö†Ô∏è Failed to load CSV. Check network/CSP or GitHub raw access.";
    document.getElementById("InputSections").innerHTML =
      `<div class="bg-white border rounded-xl p-3 text-sm err">
        Failed to load CSV. Please check network/CSP or GitHub raw access.
      </div>`;
    sendHeightToParent();
  });

/* ===================== UI ===================== */
function createSections(){
  const sec=[
    {k:"Infantry",l:"Infantry"},
    {k:"Lancer",l:"Lancer"},
    {k:"Marksman",l:"Marksman"},
  ];
  const wrap=document.getElementById("InputSections");
  wrap.innerHTML = "";

  sec.forEach(s=>{
    wrap.insertAdjacentHTML("beforeend",`
      <div class="bg-white border rounded-xl p-3">
        <div class="flex items-center justify-between mb-2">
          <h2 class="font-bold text-gray-700">[${s.l}]</h2>
          <span id="warn-${s.k}" class="text-xs err"></span>
        </div>

        <div class="grid grid-cols-[64px_1fr] gap-x-3 gap-y-2">
          <div class="text-[15px] text-gray-600 font-semibold self-center">Current</div>
          <select id="cur-${s.k}" class="border rounded p-2 text-sm w-full"></select>

          <div class="text-[15px] text-gray-600 font-semibold self-center">Target</div>
          <select id="tgt-${s.k}" class="border rounded p-2 text-sm w-full"></select>
        </div>

        <button class="w-full mt-3 bg-gray-200 p-2 rounded hover:bg-blue-300 text-black"
          onclick="addItem('${s.l}','${s.k}')">Add</button>
      </div>
    `);

    fillOptions(`cur-${s.k}`);
    document.getElementById(`tgt-${s.k}`).innerHTML = `<option value=""></option>`;

    const curEl = document.getElementById(`cur-${s.k}`);
    const tgtEl = document.getElementById(`tgt-${s.k}`);
    const warnEl = document.getElementById(`warn-${s.k}`);

    curEl.addEventListener("change", () => {
      warnEl.textContent = "";
      const cur = +curEl.value;
      if(!cur){
        tgtEl.innerHTML = `<option value=""></option>`;
        sendHeightToParent();
        return;
      }
      const filtered = levels.filter(lv => lv > cur);
      tgtEl.innerHTML = `<option value=""></option>` + filtered.map(lv => `<option value="${lv}">${lv}</option>`).join("");
      if (tgtEl.options.length > 1) tgtEl.selectedIndex = 1;
      sendHeightToParent();
    });

    tgtEl.addEventListener("change", ()=> {
      warnEl.textContent = "";
      sendHeightToParent();
    });
  });

  sendHeightToParent();
}

function fillOptions(id){
  const el=document.getElementById(id);
  el.innerHTML=`<option value=""></option>`+levels.map(l=>`<option value="${l}">${l}</option>`).join("");
}

/* ===================== LOGIC ===================== */
function addItem(label,key){
  const warnEl = document.getElementById(`warn-${key}`);
  warnEl.textContent = "";

  const f=+document.getElementById(`cur-${key}`).value;
  const t=+document.getElementById(`tgt-${key}`).value;

  if(!f || !t || t<=f){
    warnEl.textContent = "Select valid levels.";
    return;
  }

  // ‚úÖ duplicates allowed
  items.push({label,f,t});
  renderList();
  sendHeightToParent();
}

function sum(arr,f,t){
  let s=0;
  for(let lv=f; lv<t; lv++){
    const i=levelToIdx.get(lv);
    if(i!=null) s+=arr[i] || 0;
  }
  return s;
}

function calculate(){
  if(!items.length){
    alert("No items to calculate.");
    return;
  }

  let g=0,d=0,s=0,rows=[];
  items.forEach(it=>{
    const sg=sum(stepGuide,it.f,it.t);
    const sd=sum(stepDesign,it.f,it.t);
    const ss=sum(stepSecrets,it.f,it.t);
    g+=sg; d+=sd; s+=ss;

    rows.push(`
      <tr class="bg-white">
        <td class="border p-1 font-medium">${it.label}</td>
        <td class="border p-1">${it.f} ‚Üí ${it.t}</td>
        <td class="border p-1 tabular-nums text-right">${fmt(sg)}</td>
        <td class="border p-1 tabular-nums text-right">${fmt(sd)}</td>
        <td class="border p-1 tabular-nums text-right">${fmt(ss)}</td>
      </tr>
    `);
  });

  document.getElementById("resultContainer").innerHTML=`
    <table class="w-full border table-fixed text-sm text-center">
      <colgroup>
        <col style="width:20%"><col style="width:20%">
        <col style="width:20%"><col style="width:20%"><col style="width:20%">
      </colgroup>
      <thead class="bg-blue-100">
        <tr>
          <th class="border p-1">Type</th>
          <th class="border p-1">Level</th>
          <th class="border p-1">Charm Guide</th>
          <th class="border p-1">Charm Design</th>
          <th class="border p-1">Charm Secrets</th>
        </tr>
      </thead>
      <tbody>${rows.join("")}</tbody>
      <tfoot class="bg-gray-100 font-semibold">
        <tr>
          <td class="border p-1" colspan="2">Total</td>
          <td class="border p-1 tabular-nums text-right">${fmt(g)}</td>
          <td class="border p-1 tabular-nums text-right">${fmt(d)}</td>
          <td class="border p-1 tabular-nums text-right">${fmt(s)}</td>
        </tr>
      </tfoot>
    </table>`;

  sendHeightToParent();
}

function renderList(){
  const box = document.getElementById("listContainer");
  if(!items.length){
    box.innerHTML = `<div class="text-sm text-gray-500">No items added.</div>`;
    sendHeightToParent();
    return;
  }

  box.innerHTML = items.map((i,idx)=>`
    <div class="flex justify-between items-center p-2 rounded border">
      <span class="font-semibold">[${i.label}] ${i.f} ‚Üí ${i.t}</span>
      <button class="text-xs text-red-500 hover:underline" onclick="items.splice(${idx},1);renderList();sendHeightToParent()">Remove</button>
    </div>
  `).join("");

  sendHeightToParent();
}

/* ===================== BUTTONS ===================== */
document.getElementById("calculateFromList").addEventListener("click", calculate);
document.getElementById("clearList").addEventListener("click", ()=>{
  items=[];
  renderList();
  document.getElementById("resultContainer").innerHTML = `
    <div class="text-sm text-gray-600">
      Add items and click <b>[üìä Calculate]</b>.
    </div>`;
  sendHeightToParent();
});
</script>

  <!-- Right click / shortcut lock (keep) -->
  <script>
    document.addEventListener("contextmenu", e => e.preventDefault());
    document.addEventListener("keydown", function (e) {
      if (e.key === "F12" ||
          (e.ctrlKey && e.shiftKey && (e.key === "I" || e.key === "J")) ||
          (e.ctrlKey && (e.key === "U" || e.key === "S"))) {
        e.preventDefault();
      }
    });
  </script>

  <script>
    window.addEventListener('message', (e) => {
      if (e.data?.type === 'DARK_MODE') {
        document.body.classList.toggle('dark-mode', e.data.value);
        setTimeout(sendHeightToParent, 60);
      }
    });
  </script>
</body>
</html>
