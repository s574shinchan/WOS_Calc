<meta charset="UTF-8" />

<div class="max-w-[1500px] mx-auto bg-white rounded shadow p-2 flex flex-col sm:flex-row gap-2">
  <div class="flex-1 bg-white rounded p-2 space-y-4 shadow">
    <div class="bg-gray-100 p-2 font-sans text-sm">
      <div class="bg-white p-4 rounded-xl shadow-md space-y-4">
        <h1 class="text-2xl font-bold text-gray-800">ğŸ§ ì˜ì›…ì¥ë¹„[ë¯¸ìŠ¤ë¦´]</h1>

        <div class="text-gray-600 text-sm">
          <p>í˜„ì¬ë ˆë²¨ê³¼ ëª©í‘œë ˆë²¨ì„ ì„ íƒí•˜ë©´, ì—…ê·¸ë ˆì´ë“œì— í•„ìš”í•œ ìì›(ë¯¸ìŠ¤ë¦´/ë ˆì „ë“œ ì¥ë¹„)ì„ ê³„ì‚°í•©ë‹ˆë‹¤.</p>
          <p>ê° í•­ëª©ì˜ â€˜í•„ìš” í•©ê³„â€™ëŠ” ë ˆë²¨ ì„ íƒ ì‹œ ìë™ ê°±ì‹ ë©ë‹ˆë‹¤. </p>
          <p>ê° í•­ëª©ë³„ë¡œ ì²´í¬ë¥¼ í•˜ë©´ ì²´í¬í•­ëª©ë³„ í•„ìš”í•©ê³„ë¥¼ ë”í•˜ì—¬ ì´í•©ê³„ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
        </div>

        <!-- ===================== ğŸ“• ë¯¸ìŠ¤ë¦´ ===================== -->
        <div class="p-4">
          <form id="heroEquipForm" class="space-y-3">        
            <div class="mb-4 flex items-center justify-start gap-2 w-full">
              <label class="text-sm font-medium whitespace-nowrap">ë°œë ˆë¦¬ì•„</label>
              <select id="chkExpertV" class="w-[120px] border rounded-md px-2 py-1.5">
                <option>None</option>
                <option>Lv.1</option><option>Lv.2</option><option>Lv.3</option><option>Lv.4</option><option>Lv.5</option>
                <option>Lv.6</option><option>Lv.7</option><option>Lv.8</option><option>Lv.9</option><option>Lv.10</option>
              </select>
              <!-- âœ… ë ˆë²¨ ì„¤ëª… í‘œì‹œ ì˜ì—­ -->
              <span id="expertDesc" class="svs-score-value text-sm font-semibold hidden px-4"></span>
            </div>
            <div id="heroEquipGridBody" class="grid grid-cols-1 md:grid-cols-4 gap-2"></div>

            <!-- ğŸ“• ë¯¸ìŠ¤ë¦´ ì´í•©ê³„ -->
            <div id="mithrilTotals">
              <!-- 3ë“±ë¶„ -->
              <div class="grid grid-cols-1 md:grid-cols-3 gap-3">

                <!-- ğŸ§® í•„ìš” ì´í•© -->
                <div class="rounded-xl border border-black/10 p-3">
                  <div class="font-semibold text-gray-800 mb-2">í•„ìš” ì´í•©</div>
                  <div class="grid items-center text-[12px]
                              gap-x-3 gap-y-1
                              grid-cols-[auto_minmax(0,1fr)_auto_minmax(0,1fr)]">

                    <div class="text-gray-600">ê²½í—˜ì¹˜</div>
                    <div id="tot-exp" class="text-right tabular-nums">0</div>
                    <div class="text-gray-600">ë¯¸ìŠ¤ë¦´</div>
                    <div id="tot-mith" class="text-right tabular-nums">0</div>

                    <div class="text-gray-600">ë„ˆíŠ¸</div>
                    <div id="tot-nut" class="text-right tabular-nums">0</div>
                    <div class="text-gray-600">ë ˆì „ë“œì¥ë¹„</div>
                    <div id="tot-leg" class="text-right tabular-nums">0</div>

                    <div class="col-span-4 border-t border-gray-200 mt-1"></div>

                    <div class="svs-score-label pt-1">SVS ì ìˆ˜</div>
                    <span id="svs-long"  class="pt-1 svs-score-value text-right tabular-nums font-medium">0</span>                
                    <div></div>
                    <span id="svs-short" class="pt-1 svs-score-value text-right tabular-nums font-medium">0</span>
                  </div>
                </div>

                <!-- ğŸ§º ë³´ìœ ëŸ‰ (ê¸°ì¡´ ìœ ì§€) -->
                <div class="rounded-xl border border-black/10 dark:border-gray-700 p-3">
                  <div class="font-semibold text-gray-800 mb-2">ë³´ìœ ëŸ‰</div>
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div>
                      <label class="block text-[12px] text-gray-600 mb-1">ë³´ë¼ë„ˆíŠ¸</label>
                      <input type="number" id="own-ë„ˆíŠ¸" class="w-full border rounded-lg px-3 py-2 text-sm
                          bg-white dark:bg-[#2b2b2b] dark:border-gray-600"
                          placeholder="0" min="0" inputmode="numeric"/>
                    </div>
                    <div>
                      <label class="block text-[12px] text-gray-600 mb-1">ë¯¸ìŠ¤ë¦´</label>
                      <input type="number" id="own-ë¯¸ìŠ¤ë¦´" class="w-full border rounded-lg px-3 py-2 text-sm
                          bg-white dark:bg-[#2b2b2b] dark:border-gray-600"
                          placeholder="0" min="0" inputmode="numeric"/>
                    </div>
                    <div>
                      <label class="block text-[12px] text-gray-600 mb-1">ë ˆì „ë“œì¥ë¹„</label>
                      <input type="number" id="own-ë ˆì „ë“œì¥ë¹„" class="w-full border rounded-lg px-3 py-2 text-sm
                          bg-white dark:bg-[#2b2b2b] dark:border-gray-600"
                          placeholder="0" min="0" inputmode="numeric"/>
                    </div>
                  </div>
                </div>

                <!-- âš–ï¸ ê³¼ë¶€ì¡± -->
                <div class="rounded-xl border border-black/10 p-3">
                  <div class="font-semibold text-gray-800 mb-2">ê³¼ë¶€ì¡±</div>
                  <div class="grid items-center text-[12px]
                              gap-x-3 gap-y-1
                              grid-cols-[auto_minmax(0,1fr)_auto_minmax(0,1fr)]">

                    <div class="text-gray-600">ê²½í—˜ì¹˜</div>
                    <div id="def-exp" class="text-right tabular-nums">0</div>
                    <div class="text-gray-600">ë¯¸ìŠ¤ë¦´</div>
                    <div id="def-mith" class="text-right tabular-nums">0</div>

                    <div class="text-gray-600">ë„ˆíŠ¸</div>
                    <div id="def-nut" class="text-right tabular-nums">0</div>
                    <div class="text-gray-600">ë ˆì „ë“œì¥ë¹„</div>
                    <div id="def-leg" class="text-right tabular-nums">0</div>
                  </div>
                </div>

              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>    
</div>

<!-- ========== ğŸ“• ë¯¸ìŠ¤ë¦´ ë¡œì§ ========== -->
<script>
(function(){
  // âœ… SPA ì¬ì§„ì…/ì¬ë¡œë“œ ì‹œ ì´ë²¤íŠ¸ ì¤‘ë³µ ë°”ì¸ë”© ë°©ì§€
  if (window.__MITHRIL_INIT_BOUND__) {
    // ì´ë¯¸ ì´ˆê¸°í™”ëœ ìƒíƒœë©´ ê·¸ëƒ¥ ì‹¤í–‰ë§Œ(í•„ìš” ì‹œ)
    window.MithrillInit?.();
    return;
  }
  window.__MITHRIL_INIT_BOUND__ = true;
    
  window.MithrillInit = function MithrillInit(){
    var slotNames = ["ê³ ê¸€", "ì¥ê°‘", "ë²¨íŠ¸", "ì‹ ë°œ"];
    var mithrilCsvUrl = "https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Hero/Mithril.csv";

    let stageList = [];
    let csvData = [];

    // âœ… ë°œë ˆë¦¬ì•„(SVS ì ìˆ˜ ë³´ë„ˆìŠ¤)
    var EXPERT_BONUS = {
      "None":0,
      "Lv.1":0.02,"Lv.2":0.04,"Lv.3":0.06,"Lv.4":0.08,"Lv.5":0.10,
      "Lv.6":0.12,"Lv.7":0.14,"Lv.8":0.16,"Lv.9":0.18,"Lv.10":0.20
    };
    var EXPERT_DESC = {
      "Lv.1":"+2%",
      "Lv.2":"+4%",
      "Lv.3":"+6%",
      "Lv.4":"+8%",
      "Lv.5":"+10%",
      "Lv.6":"+12%",
      "Lv.7":"+14%",
      "Lv.8":"+16%",
      "Lv.9":"+18%",
      "Lv.10":"+20%"
    };

    function getValeriaBonus(){
      var sel = document.getElementById("chkExpertV");
      if (!sel) return 0;
      var key = (sel.value || sel.options[sel.selectedIndex]?.text || "None").trim();
      return EXPERT_BONUS[key] ?? 0;
    }

    var expertSel  = document.getElementById('chkExpertV');
    var expertDesc = document.getElementById('expertDesc');                   

    function getValeriaDesc(){
      var lv = expertSel?.value ?? "None";
      var bonusText = EXPERT_DESC[lv] ? ` ${EXPERT_DESC[lv]}` : "";

      // ìƒë‹¨ ì„¤ëª… ë°°ì§€
      if (EXPERT_DESC[lv]) {
        expertDesc.textContent = `SVS ì ìˆ˜ ${EXPERT_DESC[lv]}`;
        expertDesc.classList.remove('hidden');
      } else {
        expertDesc.textContent = "";
        expertDesc.classList.add('hidden');
      }
    }
    // âœ… SVS ì ìˆ˜ ì „ìš© í¬ë§· (M/B, ì†Œìˆ˜ 2ìë¦¬)
    function formatSVS(value){
      var num = Number(value);
      if (!Number.isFinite(num)) return "0";
      if (num >= 1000000000) return (num / 1000000000).toFixed(2).replace(/\.00$/, '') + "B";
      if (num >= 1000000) return (num / 1000000).toFixed(2).replace(/\.00$/, '') + "M";
      return num.toLocaleString();
    }

    async function loadMithrilCSV() {
      try{
        var res = await fetch(mithrilCsvUrl, {cache:"no-store"});
        var text = await res.text();
        var lines = text.trim().split("\n").map(l => l.split(","));
        var headers = lines[0];
        csvData = lines.slice(1).map(row => {
          var obj = {};
          headers.forEach((h, i) => obj[h.trim()] = (row[i] ?? "").trim() || "0");
          return obj;
        });
        stageList = csvData.map(r => r["ë ˆë²¨"]);
      }catch(e){
        // ê°„ë‹¨í•œ í´ë°± (ë ˆë²¨ 1~5)
        csvData = [
          {ë ˆë²¨:"1", ê²½í—˜ì¹˜:"0", ë„ˆíŠ¸:"0", ë¯¸ìŠ¤ë¦´:"0", ë ˆì „ë“œì¥ë¹„:"0"},
          {ë ˆë²¨:"2", ê²½í—˜ì¹˜:"100", ë„ˆíŠ¸:"5", ë¯¸ìŠ¤ë¦´:"8", ë ˆì „ë“œì¥ë¹„:"0"},
          {ë ˆë²¨:"3", ê²½í—˜ì¹˜:"220", ë„ˆíŠ¸:"12", ë¯¸ìŠ¤ë¦´:"18", ë ˆì „ë“œì¥ë¹„:"0"},
          {ë ˆë²¨:"4", ê²½í—˜ì¹˜:"360", ë„ˆíŠ¸:"20", ë¯¸ìŠ¤ë¦´:"30", ë ˆì „ë“œì¥ë¹„:"1"},
          {ë ˆë²¨:"5", ê²½í—˜ì¹˜:"520", ë„ˆíŠ¸:"30", ë¯¸ìŠ¤ë¦´:"45", ë ˆì „ë“œì¥ë¹„:"1"},
        ];
        stageList = csvData.map(r=>r["ë ˆë²¨"]);
      }
      renderHeroEquipUI();
      sendHeightToParent();
    }

    function renderHeroEquipUI() {
      var grid = document.getElementById("heroEquipGridBody");
      grid.innerHTML = "";

      slotNames.forEach((name, i) => {
        var options = stageList.map(stage => `<option value="${stage}">${stage}</option>`).join("");
        var card = document.createElement("div");
        card.className = "exp-card";
        card.innerHTML = `
          <div class="p-4 space-y-4">
            <!-- ìƒë‹¨: ì œëª© + í˜„ì¬/ëª©í‘œ -->
            <div class="flex items-center gap-2 mb-2">
              <h3 class="text-[15px] font-semibold text-gray-800">${name}</h3>
            </div>
            <!-- í˜„ì¬ / ëª©í‘œ : í•œ ì¤„(2ì»¬ëŸ¼). ê° ì¹¸ì€ ë¼ë²¨ ìœ„ + ì…€ë ‰íŠ¸ ì•„ë˜ -->
            <div class="grid grid-cols-2 gap-3 max-w-[360px]">
              <div>
                <div class="text-[12px] text-gray-600 mb-1">í˜„ì¬</div>
                <select id="start-${i}"
                        class="w-full border rounded-lg px-2 py-1 text-sm
                               bg-white dark:bg-[#2b2b2b] dark:border-gray-600">
                  ${options}
                </select>
              </div>
              <div>
                <div class="text-[12px] text-gray-600 mb-1">ëª©í‘œ</div>
                <select id="end-${i}"
                        class="w-full border rounded-lg px-2 py-1 text-sm
                               bg-white dark:bg-[#2b2b2b] dark:border-gray-600">
                  ${options}
                </select>
              </div>
            </div>

            <!-- í•˜ë‹¨: í•„ìš” í•©ê³„ -->
            <div>
              <div class="rounded-xl border border-black/10 p-3">
                <div class="font-semibold text-gray-800 mb-2">í•„ìš” í•©ê³„</div>

                <!-- ë¼ë²¨/ê°’ Ã— 2 ì„¸íŠ¸ (4ì»¬ëŸ¼) -->
                <div class="grid items-center text-[12px]
                            gap-x-3 gap-y-1
                            grid-cols-[auto_minmax(0,1fr)_auto_minmax(0,1fr)]">

                  <!-- 1í–‰ -->
                  <div class="text-gray-600">ê²½í—˜ì¹˜</div>
                  <div class="text-right tabular-nums" id="m-sub-exp-${i}">0</div>
                  <div class="text-gray-600">ë¯¸ìŠ¤ë¦´</div>
                  <div class="text-right tabular-nums" id="m-sub-mith-${i}">0</div>

                  <!-- 2í–‰ -->
                  <div class="text-gray-600">ë„ˆíŠ¸</div>
                  <div class="text-right tabular-nums" id="m-sub-nut-${i}">0</div>
                  <div class="text-gray-600">ë ˆì „ë“œì¥ë¹„</div>
                  <div class="text-right tabular-nums" id="m-sub-legend-${i}">0</div>

                  <!-- êµ¬ë¶„ì„  -->
                  <div class="col-span-4 border-t border-gray-200 dark:border-gray-200 mt-1"></div>

                  <!-- SVS ì ìˆ˜: ì™¼ìª½ì€ 3ì¹¸(ë¼ë²¨ í­), ê°’ì€ ë§ˆì§€ë§‰ ì¹¸ì— ìš°ì¸¡ì •ë ¬ -->
                  <div class="svs-score-label pt-1">SVS ì ìˆ˜</div>
                  <div id="sub-ì ìˆ˜A-${slotNames[i]}" class="svs-score-value text-right tabular-nums font-medium pt-1">0</div>
                  <div></div>
                  <div id="sub-ì ìˆ˜-${slotNames[i]}" class="svs-score-value text-right tabular-nums font-medium pt-1">0</div>
                </div>
              </div>
            </div>
          </div>
        `;

        grid.appendChild(card);

        var curSelect = card.querySelector(`#start-${i}`);
        var tgtSelect = card.querySelector(`#end-${i}`);

        var onChange = () => { updateMithrilSubtotals(i); updateMithrilTotals(); };
        curSelect.addEventListener("change", () => { tgtSelect.value = curSelect.value; onChange(); });
        tgtSelect.addEventListener("change", onChange);

        // ì´ˆê¸° 1íšŒ ê³„ì‚°
        updateMithrilSubtotals(i);
      });

      document.getElementById("chkExpertV")?.addEventListener("change", () => {
        slotNames.forEach((_, i) => updateMithrilSubtotals(i)); // ê° ì¹´ë“œ SVS ê°±ì‹ 
        getValeriaDesc(); 
        updateMithrilTotals();                                   // ì´í•© íŒ¨ë„ ê°±ì‹ 
      });

      // ë³´ìœ  ì…ë ¥ ë³€í™” ì‹œ ì´í•©ê³„ ê°±ì‹ 
      ["own-ë„ˆíŠ¸","own-ë¯¸ìŠ¤ë¦´","own-ë ˆì „ë“œì¥ë¹„"].forEach(id=>{
        document.getElementById(id)?.addEventListener("input", updateMithrilTotals);
      });

      updateMithrilTotals();
    }

    function updateMithrilSubtotals(i) {
      var cur = document.getElementById(`start-${i}`).value;
      var tgt = document.getElementById(`end-${i}`).value;
      var sIdx = stageList.indexOf(cur);
      var eIdx = stageList.indexOf(tgt);

      var sums = { exp:0, nut:0, mith:0, legend:0 };
      if (sIdx >= 0 && eIdx > sIdx) {
        for (let j = sIdx + 1; j <= eIdx; j++) {
          var r = csvData[j];
          sums.exp    += parseFloat(r["ê²½í—˜ì¹˜"] || "0");
          sums.nut    += parseFloat(r["ë„ˆíŠ¸"] || "0");
          sums.mith   += parseFloat(r["ë¯¸ìŠ¤ë¦´"] || "0");
          sums.legend += parseFloat(r["ë ˆì „ë“œì¥ë¹„"] || "0");
        }
      }

      document.getElementById(`m-sub-exp-${i}`).textContent    = sums.exp.toLocaleString();
      document.getElementById(`m-sub-nut-${i}`).textContent    = sums.nut.toLocaleString();
      document.getElementById(`m-sub-mith-${i}`).textContent   = sums.mith.toLocaleString();
      document.getElementById(`m-sub-legend-${i}`).textContent = sums.legend.toLocaleString();

      // âœ… ì´ ìŠ¬ë¡¯ë§Œì˜ SVS ê³„ì‚°/í‘œì‹œ
      var valeriaBonus = getValeriaBonus();
      // ê°€ì¤‘ì¹˜ëŠ” ë„¤ê°€ ì“°ëŠ” ê·œì¹™ìœ¼ë¡œ ë§ì¶°ì¤˜ (ì˜ˆì‹œëŠ” ë¯¸ìŠ¤ë¦´*4000 + ë ˆì „ë“œ*144000)
      var baseSlot = sums.mith * 144000;
      var svsSlot  = Math.round(baseSlot * (1 + valeriaBonus));

      var id  = `sub-ì ìˆ˜-${slotNames[i]}`;
      var idA = `sub-ì ìˆ˜A-${slotNames[i]}`; // ìˆìœ¼ë©´ ê°™ì´ í‘œê¸°
      var el  = document.getElementById(id);
      var elA = document.getElementById(idA);
      if (el)  el.textContent  = formatSVS(svsSlot);
      if (elA) elA.textContent = svsSlot.toLocaleString();
    }

    function updateMithrilTotals(){
      let total = { exp:0, nut:0, mith:0, leg:0 };
      slotNames.forEach((_, i)=>{
        var cur = document.getElementById(`start-${i}`).value;
        var tgt = document.getElementById(`end-${i}`).value;
        var sIdx = stageList.indexOf(cur);
        var eIdx = stageList.indexOf(tgt);
        if (sIdx < 0 || eIdx <= sIdx) return;

        for(let j=sIdx+1;j<=eIdx;j++){
          var r = csvData[j];
          total.exp += +(r["ê²½í—˜ì¹˜"]||0);
          total.nut += +(r["ë„ˆíŠ¸"]||0);
          total.mith+= +(r["ë¯¸ìŠ¤ë¦´"]||0);
          total.leg += +(r["ë ˆì „ë“œì¥ë¹„"]||0);
        }
      });

      var own = {
        nut: +(document.getElementById("own-ë„ˆíŠ¸")?.value || 0),
        mith:+(document.getElementById("own-ë¯¸ìŠ¤ë¦´")?.value || 0),
        leg: +(document.getElementById("own-ë ˆì „ë“œì¥ë¹„")?.value || 0),
      };

      // í‘œê¸°
      document.getElementById("tot-exp").textContent  = total.exp.toLocaleString();
      document.getElementById("tot-nut").textContent  = total.nut.toLocaleString();
      document.getElementById("tot-mith").textContent = total.mith.toLocaleString();
      document.getElementById("tot-leg").textContent  = total.leg.toLocaleString();

      document.getElementById("def-exp").textContent  = total.exp.toLocaleString(); // ê²½í—˜ì¹˜ëŠ” ë³´ìœ ì¹˜ ê°œë… ì—†ìŒ
      document.getElementById("def-nut").textContent  = (own.nut-total.nut).toLocaleString();
      document.getElementById("def-mith").textContent = (own.mith-total.mith).toLocaleString();
      document.getElementById("def-leg").textContent  = (own.leg-total.leg).toLocaleString();

      ["def-nut","def-mith","def-leg"].forEach(id=>{
        var el = document.getElementById(id);
        var n  = parseFloat(el.textContent.replace(/,/g,''));
        el.classList.toggle("text-red-600", n < 0);
      });

      // âœ… ì´í•© íŒ¨ë„ SVS (ì´í•© ê¸°ì¤€ìœ¼ë¡œ í•œ ë²ˆë§Œ)
      var valeriaBonus = getValeriaBonus();
      var baseTotal = total.mith * 144000; // ê·œì¹™ì— ë§ê²Œ
      var svsTotal  = Math.round(baseTotal * (1 + valeriaBonus));

      // ì´í•© íŒ¨ë„ ì•ˆì˜ svs-score-valueë§Œ ì—…ë°ì´íŠ¸ (ì¹´ë“œì˜ ê²ƒì€ ê±´ë“¤ì§€ ì•ŠìŒ)
      document.getElementById("svs-long").textContent  = svsTotal.toLocaleString();
      document.getElementById("svs-short").textContent = formatSVS(svsTotal);
    }

    // ìµœì´ˆ ë¡œë”©
    loadMithrilCSV();
   };
  window.MithrillInit();
})();
</script>