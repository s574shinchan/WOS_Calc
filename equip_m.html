<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì˜ì£¼ì¥ë¹„</title>
  <script>
    (function () {
      try {
        const v = localStorage.getItem('darkMode');
        if (v === 'true') document.documentElement.classList.add('dark-mode');
      } catch (e) {}
    })();
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="css/common.css">
  <link rel="stylesheet" href="css/heroes.css">
  <script src="js/common.js"></script>
</head>

<body>
  <div class="max-w-[1500px] mx-auto bg-white rounded shadow p-2 flex flex-col sm:flex-row gap-2">
    <div class="flex-1 bg-white rounded p-2 space-y-4 shadow">
      <div class="bg-gray-100 p-2 font-sans text-sm">
        <div class="bg-white p-4 rounded-xl shadow-md space-y-4">

          <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight text-gray-800">ğŸ›¡ï¸ ì¥ë¹„ ê³„ì‚°ê¸°</h1>

          <div class="text-gray-600 text-sm mt-1 space-y-1">
            <p>ì´ í˜ì´ì§€ëŠ” í˜„ì¬ ë³´ìœ  ì¤‘ì¸ ì˜ì£¼ì¥ë¹„ ë“±ê¸‰ê³¼ ëª©í‘œí•˜ëŠ” ë“±ê¸‰ì„ ì„ íƒí•˜ë©´,</p>
            <p>ì—…ê·¸ë ˆì´ë“œì— í•„ìš”í•œ ìì›(í•©ê¸ˆ, ì„¤ê³„ë„ë©´, ê´‘íƒì œ, ë‹¬ë¹›ì— ë²„ ë“±)ì˜ ì´ ìˆ˜ëŸ‰ì„ ê³„ì‚°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            <p>ì¥ë¹„ëŠ” ìµœëŒ€ 6ê°œê¹Œì§€ ì„ íƒì´ ê°€ëŠ¥í•˜ë©°, ì²´í¬í•œ ì¥ë¹„ë§Œ í•©ì‚°í•˜ì—¬ ì´í•©ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>
            <p>ê° í•­ëª©ì˜ â€˜í•„ìš” í•©ê³„â€™ëŠ” ë ˆë²¨ ì„ íƒ ì‹œ ìë™ ê°±ì‹ ë©ë‹ˆë‹¤. (í‘œì‹œëŠ” ìˆ¨ê¹€ ì²˜ë¦¬)</p>
            <p>ì´í•©ì€ â€œì´í•©ê³„ì‚°â€ ë²„íŠ¼ í´ë¦­ ì‹œì—ë§Œ ê³„ì‚°ë©ë‹ˆë‹¤.</p>
          </div>

          <form id="gearForm" class="space-y-3">
            <!-- âœ… ì¹´ë“œí˜• UI -->
            <div id="gearTableBody" class="grid grid-cols-1 md:grid-cols-3 gap-2"></div>

            <!-- âœ… ì´í•© íŒ¨ë„(ì½”ë“œ2 ìŠ¤íƒ€ì¼) -->
            <div id="gearTotals">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <div class="rounded-xl border border-black/10 p-3">
                  <div class="font-semibold text-gray-800 mb-2">í•„ìš” ì´í•©</div>
                  <div class="grid items-center text-[12px]
                              gap-x-3 gap-y-1
                              grid-cols-[auto_minmax(0,1fr)_auto_minmax(0,1fr)]">

                    <div class="text-gray-600">í•©ê¸ˆ</div>
                    <div id="tot-alloy" class="text-right tabular-nums">0</div>
                    <div class="text-gray-600">ì„¤ê³„ë„ë©´</div>
                    <div id="tot-blueprint" class="text-right tabular-nums">0</div>

                    <div class="text-gray-600">ê´‘íƒì œ</div>
                    <div id="tot-polish" class="text-right tabular-nums">0</div>
                    <div class="text-gray-600">ë‹¬ë¹›ì•°ë²„</div>
                    <div id="tot-amber" class="text-right tabular-nums">0</div>
                  </div>
                </div>

                <div class="flex justify-end mt-2">
                  <button id="btnCalc" type="button"
                          class="w-full px-4 py-2 rounded-lg bg-blue-600 text-white text-sm hover:bg-blue-700">
                    ì´í•©ê³„ì‚°
                  </button>
                </div>
              </div>
            </div>
          </form>

        </div>
      </div>
    </div>
  </div>

  <!-- ========== ê³µí†µ ìœ í‹¸ & í”„ë ˆì„ í†µì‹  ========== -->
  <script>
    function sendHeightToParent() {
      const height = document.body.scrollHeight + 10;
      window.parent?.postMessage?.({ type: "FRAME_CHANGE", height }, "*");
    }

    window.addEventListener("load", () => {
      setTimeout(sendHeightToParent, 100);
    });
  </script>

  <!-- ========== ì˜ì£¼ì¥ë¹„ ë¡œì§(ì½”ë“œ1 ê¸°ë°˜ + ì½”ë“œ2 UI íŒ¨í„´) ========== -->
  <script>
    const gearSlots = ["ì¥ë¹„1(ì°½)", "ì¥ë¹„2(ì°½)", "ì¥ë¹„3(ë°©)", "ì¥ë¹„4(ë°©)", "ì¥ë¹„5(ê¶)", "ì¥ë¹„6(ê¶)"];
    const csvUrl = 'https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/chief/Gear.csv';

    let gearLevels = [];
    let gearData = [];

    async function fetchCSVData() {
      const res = await fetch(csvUrl);
      const text = await res.text();
      const lines = text.trim().split("\n").map(l => l.split(","));
      const headers = lines[0];
      gearData = lines.slice(1).map(row => {
        const obj = {};
        headers.forEach((h, i) => obj[h.trim()] = row[i]?.trim() || "0");
        return obj;
      });
      gearLevels = gearData.map(r => r["ë‹¨ê³„"]);

      renderGearUI();
      sendHeightToParent();
    }

    function renderGearUI() {
      const grid = document.getElementById("gearTableBody");
      grid.innerHTML = "";

      gearSlots.forEach((name, i) => {
        const options = gearLevels.map(stage => `<option value="${stage}">${stage}</option>`).join("");

        const card = document.createElement("div");
        card.className = "exp-card";
        card.innerHTML = `
          <div class="p-4 space-y-4">
            <div class="flex items-center gap-2">
              <label class="flex items-center gap-2">
                <input type="checkbox" id="check-${i}" class="w-4 h-4" />
                <h3 class="text-[15px] font-semibold text-gray-800">${name}</h3>
              </label>
            </div>

            <div class="grid grid-cols-2 gap-3 max-w-[360px]">
              <div>
                <div class="text-[12px] text-gray-600 mb-1">í˜„ì¬</div>
                <select id="start-${i}"
                        class="w-full border rounded-lg px-2 py-1 text-sm
                               bg-white dark:bg-[#2b2b2b] dark:border-gray-600">
                  ${options}
                </select>
              </div>
              <div>
                <div class="text-[12px] text-gray-600 mb-1">ëª©í‘œ</div>
                <select id="end-${i}"
                        class="w-full border rounded-lg px-2 py-1 text-sm
                               bg-white dark:bg-[#2b2b2b] dark:border-gray-600">
                  ${options}
                </select>
              </div>
            </div>

            <!-- âœ… ì¹´ë“œë³„ í•„ìš”í•©ê³„: ì½”ë“œ2ì²˜ëŸ¼ DOMì€ ìœ ì§€í•˜ë˜ ìˆ¨ê¹€ -->
            <div class="hidden">
              <div class="rounded-xl border border-black/10 p-3">
                <div class="font-semibold text-gray-800 mb-2">í•„ìš” í•©ê³„</div>
                <div class="grid items-center text-[12px]
                            gap-x-3 gap-y-1
                            grid-cols-[auto_minmax(0,1fr)_auto_minmax(0,1fr)]">

                  <div class="text-gray-600">í•©ê¸ˆ</div>
                  <div class="text-right tabular-nums" id="g-sub-alloy-${i}">0</div>
                  <div class="text-gray-600">ì„¤ê³„ë„ë©´</div>
                  <div class="text-right tabular-nums" id="g-sub-blueprint-${i}">0</div>

                  <div class="text-gray-600">ê´‘íƒì œ</div>
                  <div class="text-right tabular-nums" id="g-sub-polish-${i}">0</div>
                  <div class="text-gray-600">ë‹¬ë¹›ì•°ë²„</div>
                  <div class="text-right tabular-nums" id="g-sub-amber-${i}">0</div>
                </div>
              </div>
            </div>
          </div>
        `;

        grid.appendChild(card);

        const curSelect = card.querySelector(`#start-${i}`);
        const tgtSelect = card.querySelector(`#end-${i}`);

        // âœ… ëª©í‘œ ì˜µì…˜: í˜„ì¬+1ë¶€í„°ë§Œ í‘œì‹œ(ì½”ë“œ2 ë™ì¼)
        function refreshTargetOptions() {
          const curValue = curSelect.value;
          const curIdx = gearLevels.indexOf(curValue);
          const targets = gearLevels.slice(curIdx + 1);

          if (targets.length === 0) {
            tgtSelect.innerHTML = `<option value="${curValue}">${curValue}</option>`;
            tgtSelect.value = curValue;
            tgtSelect.disabled = true;
          } else {
            tgtSelect.disabled = false;
            tgtSelect.innerHTML = targets.map(stage => `<option value="${stage}">${stage}</option>`).join("");
            tgtSelect.value = targets[0]; // ê¸°ë³¸ê°’ í˜„ì¬+1
          }
        }

        // ì´ˆê¸° ì„¸íŒ…
        refreshTargetOptions();
        updateGearSubtotals(i);

        // í˜„ì¬ ë³€ê²½ ì‹œ ëª©í‘œì˜µì…˜ ì¬êµ¬ì„± + subtotal ê°±ì‹ 
        curSelect.addEventListener("change", () => {
          refreshTargetOptions();
          updateGearSubtotals(i);
          sendHeightToParent();
        });

        // ëª©í‘œ ë³€ê²½ ì‹œ subtotal ê°±ì‹ 
        tgtSelect.addEventListener("change", () => {
          updateGearSubtotals(i);
          sendHeightToParent();
        });
      });

      // âœ… ì´í•©ê³„ì‚° ë²„íŠ¼ í´ë¦­ì‹œì—ë§Œ ì´í•© ê³„ì‚°(ì½”ë“œ2 ë™ì¼)
      document.getElementById("btnCalc")?.addEventListener("click", function(e) {
        e.preventDefault();
        updateGearTotalsAndPopup(); // ì´í•© + (ê¸°ì¡´ ê¸°ëŠ¥) íŒì—…ë„ ê°™ì´
      });
    }

    // âœ… ì¹´ë“œë³„ í•„ìš”í•©ê³„: ì„ íƒ ë³€ê²½ ì‹œ ìë™ ê°±ì‹ (í‘œì‹œëŠ” hidden)
    function updateGearSubtotals(i) {
      const cur = document.getElementById(`start-${i}`).value;
      const tgt = document.getElementById(`end-${i}`).value;

      const sIdx = gearLevels.indexOf(cur);
      const eIdx = gearLevels.indexOf(tgt);

      const sums = { alloy:0, blueprint:0, polish:0, amber:0 };

      if (sIdx >= 0 && eIdx > sIdx) {
        for (let j = sIdx + 1; j <= eIdx; j++) {
          const row = gearData[j];
          sums.alloy     += parseFloat(row["í•©ê¸ˆ"] || "0");
          sums.blueprint += parseFloat(row["ì„¤ê³„ë„ë©´"] || "0");
          sums.polish    += parseFloat(row["ê´‘íƒì œ"] || "0");
          sums.amber     += parseFloat(row["ë‹¬ë¹›ì•°ë²„"] || "0");
        }
      }

      const el1 = document.getElementById(`g-sub-alloy-${i}`);
      const el2 = document.getElementById(`g-sub-blueprint-${i}`);
      const el3 = document.getElementById(`g-sub-polish-${i}`);
      const el4 = document.getElementById(`g-sub-amber-${i}`);

      if (el1) el1.textContent = sums.alloy.toLocaleString();
      if (el2) el2.textContent = sums.blueprint.toLocaleString();
      if (el3) el3.textContent = sums.polish.toLocaleString();
      if (el4) el4.textContent = sums.amber.toLocaleString();
    }

    // âœ… ì´í•©: ì²´í¬ëœ ê²ƒë§Œ í•©ì‚°, ë²„íŠ¼ í´ë¦­ì‹œì—ë§Œ
    // âœ… + ê¸°ì¡´ ì½”ë“œ1 ê¸°ëŠ¥ ìœ ì§€: RESULT_POPUP ìƒì„¸ í…Œì´ë¸”ë„ ê°™ì´ ì „ì†¡
    function updateGearTotalsAndPopup() {
      let total = { alloy:0, blueprint:0, polish:0, amber:0 };
      let rows = "";

      gearSlots.forEach((name, i) => {
        const chk = document.getElementById(`check-${i}`);
        if (!chk || !chk.checked) return;

        const start = document.getElementById(`start-${i}`).value;
        const end   = document.getElementById(`end-${i}`).value;

        const sIdx = gearLevels.indexOf(start);
        const eIdx = gearLevels.indexOf(end);

        if (sIdx === -1 || eIdx === -1 || sIdx >= eIdx) {
          rows += `<tr><td class="border p-1 text-center" colspan="6">âš ï¸ ${name}: ì˜ëª»ëœ ë‹¨ê³„ ì„ íƒ</td></tr>`;
          return;
        }

        const subtotal = { alloy:0, blueprint:0, polish:0, amber:0 };
        for (let j = sIdx + 1; j <= eIdx; j++) {
          const row = gearData[j];
          subtotal.alloy     += parseFloat(row["í•©ê¸ˆ"] || "0");
          subtotal.blueprint += parseFloat(row["ì„¤ê³„ë„ë©´"] || "0");
          subtotal.polish    += parseFloat(row["ê´‘íƒì œ"] || "0");
          subtotal.amber     += parseFloat(row["ë‹¬ë¹›ì•°ë²„"] || "0");
        }

        total.alloy     += subtotal.alloy;
        total.blueprint += subtotal.blueprint;
        total.polish    += subtotal.polish;
        total.amber     += subtotal.amber;

        rows += `
          <tr class="text-center">
            <td class="border p-1">${name}</td>
            <td class="border p-1">${start} â†’ ${end}</td>
            <td class="border p-1">${subtotal.alloy.toLocaleString()}</td>
            <td class="border p-1">${subtotal.blueprint.toLocaleString()}</td>
            <td class="border p-1">${subtotal.polish.toLocaleString()}</td>
            <td class="border p-1">${subtotal.amber.toLocaleString()}</td>
          </tr>`;
      });

      // âœ… í™”ë©´ ì´í•© ì—…ë°ì´íŠ¸
      document.getElementById("tot-alloy").textContent     = total.alloy.toLocaleString();
      document.getElementById("tot-blueprint").textContent = total.blueprint.toLocaleString();
      document.getElementById("tot-polish").textContent    = total.polish.toLocaleString();
      document.getElementById("tot-amber").textContent     = total.amber.toLocaleString();
		
      sendHeightToParent();
    }

    fetchCSVData();
  </script>

  <script>
    document.addEventListener("contextmenu", event => event.preventDefault());
    document.addEventListener("keydown", function (e) {
      if (e.key === "F12" || (e.ctrlKey && e.shiftKey && (e.key === "I" || e.key === "J")) ||
          (e.ctrlKey && (e.key === "U" || e.key === "S"))) {
        e.preventDefault();
      }
    });
  </script>

  <script>
    window.addEventListener('message', (e) => {
      if (e.data?.type === 'DARK_MODE') {
        document.body.classList.toggle('dark-mode', e.data.value);
      }
    });
  </script>
</body>
</html>
