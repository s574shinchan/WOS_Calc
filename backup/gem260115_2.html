<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì˜ì£¼ë³´ì„ ê³„ì‚°ê¸°</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .muted{color:#6b7280}
    .pill{padding:.35rem .6rem;border:1px solid #d1d5db;border-radius:.75rem;background:#fff;color:#111827}
    .inline-label{display:flex;align-items:center;gap:.5rem}
    .tabular-nums{font-variant-numeric: tabular-nums}
    select.pill{height:32px}
    .err{color:#b45309}

    /* âœ… ë‹¤í¬ëª¨ë“œ */
    body.dark-mode { background-color:#121212; color:#f0f0f0; }
    .dark-mode .border{ border-color:#444 !important; }
    .dark-mode .bg-white{ background-color:#2c2c2c !important; color:#f0f0f0 !important; }
    .dark-mode .bg-gray-100{ background-color:#1e1e1e !important; }
    .dark-mode .text-gray-800,.dark-mode .text-gray-700,.dark-mode .text-gray-600{ color:#f0f0f0 !important; }
    .dark-mode .text-blue-700{ color:#66b0ff !important; }
    .dark-mode .text-green-700{ color:#79e68c !important; }
    .dark-mode .text-purple-700{ color:#bfa6ff !important; }
    .dark-mode table{ background-color:#2c2c2c; color:#f0f0f0; }
    .dark-mode th,.dark-mode td{ border-color:#444 !important; }
    .dark-mode thead th{ color:#f0f0f0 !important; }
    .dark-mode .bg-blue-100,.dark-mode .bg-gray-50{ background-color:#2e2e2e !important; }
    .dark-mode select option,.dark-mode select,.dark-mode input{ color:#000 !important; }
  </style>
  <script>
    // ë‹¤í¬ëª¨ë“œ ìœ ì§€
    window.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
      }
    });
  </script>
</head>
<body class="bg-gray-100 p-3 font-sans text-sm">
  <div class="max-w-[1500px] mx-auto bg-white p-2 rounded-xl shadow-md">
    <header class="flex items-center justify-between">
      <div class="p-4">
        <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight text-gray-800">ğŸ’ ì˜ì£¼ë³´ì„ ê³„ì‚°ê¸°</h1>
        <p class="text-sm muted mt-1">ë³´ì„ ì—…ê·¸ë ˆì´ë“œì— í•„ìš”í•œ <b>ë§¤ë‰´ì–¼ / ë„ë©´ / ë¹„ì „</b> í•©ê³„ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.</p>
        <p class="text-xs muted mt-1">â€» í•­ëª©ì„ ì¶”ê°€í•œ ë’¤ <b>[ğŸ“Š ê³„ì‚°í•˜ê¸°]</b> ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œë§Œ ì´í•©ì´ ê³„ì‚°ë©ë‹ˆë‹¤.</p>
      </div>
    </header>

    <!-- âœ… ì…ë ¥ ì¹´ë“œ 3ê°œ (ë°©íŒ¨/ì°½ë³‘/ê¶ë³‘) -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-4" id="InputSections">
      <!-- JSë¡œ ì±„ì›€ -->
    </section>

    <!-- âœ… ì¢Œ: ì„ íƒëª©ë¡ / ìš°: ê²°ê³¼ -->
    <div class="grid md:grid-cols-2 gap-3 mt-4">
      <!-- ëª©ë¡ -->
      <div class="bg-white border rounded-xl shadow-sm p-3" id="addedList">
        <div class="flex justify-between items-center mb-2">
          <h2 class="text-base font-bold text-gray-700">ğŸ“‹ ì„ íƒëœ ëª©ë¡</h2>
          <div class="flex gap-x-2">
            <button id="calculateFromList" class="text-blue-500 text-sm hover:underline">ğŸ“Š ê³„ì‚°í•˜ê¸°</button>
            <button id="clearList" class="text-sm text-red-600 hover:underline">ğŸ§¹ ëª©ë¡ ì´ˆê¸°í™”</button>
          </div>
        </div>
        <div class="space-y-1 text-sm" id="listContainer"></div>
      </div>

      <!-- ê²°ê³¼ -->
      <div class="bg-white border rounded-xl shadow-sm p-3" id="resultCard">
        <div class="flex items-center justify-between">
          <h2 class="text-base font-bold text-gray-700">ğŸ“ˆ ê³„ì‚° ê²°ê³¼</h2>
        </div>
        <div id="resultContainer" class="mt-2 overflow-auto">
          <div class="text-sm text-gray-600">í•­ëª©ì„ ì¶”ê°€í•˜ê³  <span class="font-semibold">[ğŸ“Š ê³„ì‚°í•˜ê¸°]</span>ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ====== ì„ë² ë“œ ë†’ì´ ë³´ê³  ======
    function sendHeightToParent() {
      const height = document.body.scrollHeight + 10;
      window.parent?.postMessage?.({ type: "FRAME_CHANGE", height }, "*");
    }
    window.addEventListener("load", () => setTimeout(sendHeightToParent, 120));
  </script>

  <script>
    // ====== ë°ì´í„° ì†ŒìŠ¤ ======
    const csvUrl = "https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/chief/Gem.csv";

    // ====== ìƒíƒœ ======
    let gemLevels = [];
    let levelToIdx = new Map();  // lv -> step index (lv -> lv+1)
    let stepM = [];
    let stepB = [];
    let stepV = [];

    // âœ… ëª©ë¡(ì¶”ê°€ëœ í•­ëª©)
    // item: { section: "ë°©íŒ¨|ì°½ë³‘|ê¶ë³‘", from: number, to: number }
    let addedItems = [];

    // âœ… ë§ˆì§€ë§‰ ê³„ì‚° ê²°ê³¼(ì´í•©) ì €ì¥: ë³´ìœ ê°’ ì…ë ¥ ì‹œ ê³¼ë¶€ì¡± ê³„ì‚°ìš©
    let lastTotal = { m: 0, b: 0, v: 0 };

    // ====== ìœ í‹¸ ======
    const fmt = (n) => Number(n || 0).toLocaleString("ko-KR");
    const detectDelim = (sample) => (sample.includes("\t") ? "\t" : (sample.includes(";") ? ";" : ","));
    const toNum = (s) => { const m = String(s||"").match(/-?\d+(\.\d+)?/); return m ? Number(m[0]) : 0; };
    const toInt = (s) => { const m = String(s||"").match(/\d+/); return m ? parseInt(m[0],10) : NaN; };

    function preprocessByLevel(text){
      let s = text.replace(/\uFEFF/g,"").replace(/\r/g,"");
      if (!s.includes("\n") && /Lv\.?\s*\d+/i.test(s)) {
        s = s.replace(/(Lv\.?\s*\d+)/gi, "\n$1");
      }
      return s;
    }

    // ====== CSV íŒŒì„œ ======
    function parseGemCSV(text){
      const pre = preprocessByLevel(text);
      const lines = pre.split("\n").filter(l => l.trim() !== "");
      if (!lines.length) return { levels:[], manual:[], blue:[], vision:[] };

      const delim = detectDelim(lines[0]);
      const hasHeader = /(ë ˆë²¨|lv|level|ë§¤ë‰´ì–¼|ë„ë©´|ë¹„ì „|manual|blue|vision|í•©ê³„|ëˆ„ì |total|cumulative)/i.test(lines[0]);
      const start = hasHeader ? 1 : 0;
      const headerLine = hasHeader ? lines[0] : "";
      const markCumulative = /(ëˆ„ì |í•©ê³„|total|cumulative)/i.test(headerLine);

      const M = new Map(), B = new Map(), V = new Map();
      const rawLevels = [];

      for (let i=start;i<lines.length;i++){
        const c = lines[i].split(delim);
        if (!c.length) continue;

        let lv, m, b, v;
        if (c.length >= 4){
          lv = toInt(c[0]); m = toNum(c[1]); b = toNum(c[2]); v = toNum(c[3]);
        }else{
          lv = (i - start) + 1;
          m = toNum(c[0]); b = toNum(c[1]); v = toNum(c[2] || 0);
        }
        if (!Number.isFinite(lv)) continue;

        rawLevels.push(lv);
        M.set(lv, m); B.set(lv, b); V.set(lv, v);
      }

      const levels = [...new Set(rawLevels)].sort((a,b)=>a-b);
      if (levels.length < 2) return { levels, manual:[], blue:[], vision:[] };

      const sM=[], sB=[], sV=[];
      for (let i=0;i<levels.length-1;i++){
        const a = levels[i], b = levels[i+1];
        if (markCumulative) {
          sM[i] = Math.max(0, (M.get(b)||0) - (M.get(a)||0));
          sB[i] = Math.max(0, (B.get(b)||0) - (B.get(a)||0));
          sV[i] = Math.max(0, (V.get(b)||0) - (V.get(a)||0));
        } else {
          sM[i] = Math.max(0, (M.get(b)||0));
          sB[i] = Math.max(0, (B.get(b)||0));
          sV[i] = Math.max(0, (V.get(b)||0));
        }
      }
      return { levels, manual:sM, blue:sB, vision:sV };
    }

    function renderOptions(selectEl, levels){
      const label = (lv)=>`Lv.${lv}`;
      const opts = ['<option value=""></option>'].concat(
        levels.map(lv => `<option value="${lv}">${label(lv)}</option>`)
      ).join("");
      selectEl.innerHTML = opts;
    }

    function renderTargetOptions(selectEl, levels, greaterThan){
      const label = (lv)=>`Lv.${lv}`;
      const filtered = levels.filter(lv => lv > greaterThan);
      const opts = ['<option value=""></option>'].concat(
        filtered.map(lv => `<option value="${lv}">${label(lv)}</option>`)
      ).join("");
      selectEl.innerHTML = opts;
    }

    // fromLvâ†’toLv í•©: (fromLv+1 ... toLv)
    function sumRange(steps, fromLv, toLv){
      if (!Array.isArray(steps) || steps.length === 0) return 0;
      let s = 0;
      for (let lv = fromLv; lv < toLv; lv++) {
        const idx = levelToIdx.get(lv);
        if (idx !== undefined && idx >= 0 && idx < steps.length) s += steps[idx] || 0;
      }
      return s;
    }

    // ====== UI ìƒì„±: ë°©íŒ¨/ì°½ë³‘/ê¶ë³‘ ì…ë ¥ ì¹´ë“œ 3ê°œ ======
    function createSectionCards(){
      const wrap = document.getElementById("InputSections");
      wrap.innerHTML = "";

      const sections = [
        { key:"shield", label:"ë°©íŒ¨", color:"text-blue-700" },
        { key:"spear",  label:"ì°½ë³‘", color:"text-green-700" },
        { key:"arch",   label:"ê¶ë³‘", color:"text-purple-700" },
      ];

      sections.forEach((s) => {
        const card = document.createElement("div");
        card.className = "bg-white border rounded-xl shadow-sm p-3";

        card.innerHTML = `
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-base font-bold ${s.color}">[${s.label}]</h2>
            <span id="warn-${s.key}" class="text-xs err"></span>
          </div>

          <div class="grid grid-cols-[64px_1fr] gap-x-3 gap-y-2">
            <div class="text-[15px] text-gray-600 font-semibold self-center">í˜„ì¬</div>
            <select class="border rounded p-2 text-sm w-full" id="cur-${s.key}"></select>

            <div class="text-[15px] text-gray-600 font-semibold self-center">ëª©í‘œ</div>
            <select class="border rounded p-2 text-sm w-full" id="tgt-${s.key}"></select>
          </div>

          <button type="button"
            class="w-full mt-3 bg-gray-200 text-sm px-3 py-2 rounded hover:bg-blue-300 text-black add-btn"
            data-section="${s.label}" data-key="${s.key}">ì¶”ê°€</button>

          <div class="mt-2 text-xs muted">ë ˆë²¨ ë²”ìœ„: <span id="cap-${s.key}"></span></div>
        `;

        wrap.appendChild(card);
      });
    }

    // ====== ëª©ë¡ ë Œë” ======
    function renderList(){
      const list = document.getElementById("listContainer");
      list.innerHTML = "";

      if (!addedItems.length) {
        list.innerHTML = `<div class="text-sm text-gray-500">ì¶”ê°€ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
        sendHeightToParent();
        return;
      }

      addedItems.forEach((item, idx) => {
        const row = document.createElement("div");
        row.className = "flex justify-between items-center p-2 rounded border";

        row.innerHTML = `
          <span class="font-semibold">[${item.section}] ${item.from} â†’ ${item.to}</span>
          <button class="text-xs text-red-500 hover:underline" data-remove="${idx}">ì‚­ì œ</button>
        `;

        row.querySelector("button[data-remove]").addEventListener("click", (e) => {
          const i = parseInt(e.currentTarget.getAttribute("data-remove"), 10);
          if (Number.isFinite(i)) {
            addedItems.splice(i, 1);
            renderList();
          }
        });

        list.appendChild(row);
      });

      sendHeightToParent();
    }

    // ====== ê³¼ë¶€ì¡±ë§Œ ê°±ì‹ (ì´í•©ì€ ë²„íŠ¼ì—ì„œë§Œ) ======
    function updateDeficitOnly(){
      const owned = {
        m: +(document.getElementById("own-ë§¤ë‰´ì–¼").value || 0),
        b: +(document.getElementById("own-ë„ë©´").value || 0),
        v: +(document.getElementById("own-ë¹„ì „").value || 0),
      };
      const def = { m: owned.m - lastTotal.m, b: owned.b - lastTotal.b, v: owned.v - lastTotal.v };

      const dM = document.getElementById("def-ë§¤ë‰´ì–¼");
      const dB = document.getElementById("def-ë„ë©´");
      const dV = document.getElementById("def-ë¹„ì „");

      dM.textContent = fmt(def.m);
      dB.textContent = fmt(def.b);
      dV.textContent = fmt(def.v);

      dM.classList.toggle("text-red-600", parseFloat(String(def.m)) < 0);
      dB.classList.toggle("text-red-600", parseFloat(String(def.b)) < 0);
      dV.classList.toggle("text-red-600", parseFloat(String(def.v)) < 0);

      sendHeightToParent();
    }

    // ====== ê³„ì‚°: ëª©ë¡ ê¸°ì¤€ìœ¼ë¡œë§Œ ê³„ì‚°(ë²„íŠ¼ í´ë¦­) ======
    function calculateFromList(){
      if (!addedItems.length) {
        alert("ê³„ì‚°í•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      let total = { m:0, b:0, v:0 };
      const rowsHtml = [];

      addedItems.forEach((item) => {
        const sM = sumRange(stepM, item.from, item.to);
        const sB = sumRange(stepB, item.from, item.to);
        const sV = sumRange(stepV, item.from, item.to);

        total.m += sM;
        total.b += sB;
        total.v += sV;

        rowsHtml.push(`
          <tr class="bg-white">
            <td class="border p-1 font-medium w-2/6">${item.section}</td>
            <td class="border p-1">${item.from} â†’ ${item.to}</td>
            <td class="border p-1 tabular-nums text-right">${fmt(sM)}</td>
            <td class="border p-1 tabular-nums text-right">${fmt(sB)}</td>
            <td class="border p-1 tabular-nums text-right">${fmt(sV)}</td>
          </tr>
        `);
      });

      // âœ… ê²°ê³¼ í…Œì´ë¸”
      const html = `
        <table class="w-full border text-sm text-center table-fixed">
          <colgroup>
            <col style="width:20%">
            <col style="width:20%">
            <col style="width:20%">
            <col style="width:20%">
            <col style="width:20%">
          </colgroup>
          <thead class="bg-blue-100">
            <tr>
              <th class="border p-1">êµ¬ë¶„</th>
              <th class="border p-1">ë ˆë²¨</th>
              <th class="border p-1">ë§¤ë‰´ì–¼</th>
              <th class="border p-1">ë„ë©´</th>
              <th class="border p-1">ë¹„ì „</th>
            </tr>
          </thead>
          <tbody>${rowsHtml.join("")}</tbody>
          <tfoot class="bg-gray-100 font-semibold">
            <tr>
              <td class="border p-1" colspan="2">ì´í•©</td>
              <td class="border p-1 tabular-nums text-right">${fmt(total.m)}</td>
              <td class="border p-1 tabular-nums text-right">${fmt(total.b)}</td>
              <td class="border p-1 tabular-nums text-right">${fmt(total.v)}</td>
            </tr>
          </tfoot>
        </table>
      `;
      document.getElementById("resultContainer").innerHTML = html;

      sendHeightToParent();
    }

    // ====== ì´ë²¤íŠ¸ ë°”ì¸ë”© ======
    function wireSectionEvents(){
      const sections = [
        { key:"shield", label:"ë°©íŒ¨" },
        { key:"spear",  label:"ì°½ë³‘" },
        { key:"arch",   label:"ê¶ë³‘" },
      ];

      // í˜„ì¬ ë³€ê²½ -> ëª©í‘œ ì˜µì…˜ ì¬êµ¬ì„± + ê¸°ë³¸ cur+1
      sections.forEach((s) => {
        const curEl = document.getElementById(`cur-${s.key}`);
        const tgtEl = document.getElementById(`tgt-${s.key}`);
        const warnEl = document.getElementById(`warn-${s.key}`);

        curEl.addEventListener("change", () => {
          warnEl.textContent = "";
          const cur = +curEl.value;
          if (!cur) {
            tgtEl.innerHTML = '<option value=""></option>';
          } else {
            renderTargetOptions(tgtEl, gemLevels, cur);
            if (tgtEl.options.length > 1) tgtEl.selectedIndex = 1; // ê¸°ë³¸ cur+1
          }
          sendHeightToParent();
        });

        tgtEl.addEventListener("change", () => {
          warnEl.textContent = "";
          sendHeightToParent();
        });
      });

      // ì¶”ê°€ ë²„íŠ¼
      document.querySelectorAll(".add-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const sectionLabel = btn.getAttribute("data-section");
          const key = btn.getAttribute("data-key");
          const warnEl = document.getElementById(`warn-${key}`);

          const curEl = document.getElementById(`cur-${key}`);
          const tgtEl = document.getElementById(`tgt-${key}`);

          const from = parseInt(curEl.value, 10);
          const to = parseInt(tgtEl.value, 10);

          warnEl.textContent = "";

          if (!from || !to || to <= from) {
            warnEl.textContent = "ìœ íš¨í•œ ë ˆë²¨ì„ ì„ íƒí•˜ì„¸ìš”.";
            return;
          }

          //// âœ… ì¤‘ë³µ ë°©ì§€ (ê°™ì€ ì„¹ì…˜ + ê°™ì€ from/to)
          //const exists = addedItems.some(x => x.section === sectionLabel && x.from === from && x.to === to);
          //if (exists) {
          //  warnEl.textContent = "ì´ë¯¸ ì¶”ê°€ëœ í•­ëª©ì…ë‹ˆë‹¤.";
          //  return;
          //}

          addedItems.push({ section: sectionLabel, from, to });
          renderList();
        });
      });

      // ëª©ë¡ ì´ˆê¸°í™”
      document.getElementById("clearList").addEventListener("click", () => {
        addedItems = [];
        renderList();

        // ê²°ê³¼ ì˜ì—­ ë¦¬ì…‹
        document.getElementById("resultContainer").innerHTML =
          `<div class="text-sm text-gray-500">í•­ëª©ì„ ì¶”ê°€í•˜ê³  <span class="font-semibold">[ğŸ“Š ê³„ì‚°í•˜ê¸°]</span>ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>`;

        // ì´í•© ë¦¬ì…‹(ì—°êµ¬ ë°©ì‹: ê³„ì‚° ë²„íŠ¼ë§Œ ë°˜ì˜)
        lastTotal = { m:0, b:0, v:0 };
        document.getElementById("sum-ë§¤ë‰´ì–¼").textContent = "0";
        document.getElementById("sum-ë„ë©´").textContent = "0";
        document.getElementById("sum-ë¹„ì „").textContent = "0";
        updateDeficitOnly();

        sendHeightToParent();
      });

      // ê³„ì‚° ë²„íŠ¼
      document.getElementById("calculateFromList").addEventListener("click", calculateFromList);
    }

    // ====== CSV 1íšŒ ë¡œë“œ/íŒŒì‹± í›„ UI ì´ˆê¸°í™” ======
    let gemParsedPromise = null;

    function fetchGemParsedOnce(){
      if (gemParsedPromise) return gemParsedPromise;
      gemParsedPromise = fetch(csvUrl, { cache:"no-store", mode:"cors", redirect:"follow", referrerPolicy:"no-referrer" })
        .then(res => {
          if (!res.ok) throw new Error("HTTP " + res.status);
          return res.text();
        })
        .then(text => parseGemCSV(text));
      return gemParsedPromise;
    }

    async function init(){
      try{
        const parsed = await fetchGemParsedOnce();
        gemLevels = parsed.levels;
        stepM = parsed.manual;
        stepB = parsed.blue;
        stepV = parsed.vision;

        levelToIdx = new Map(gemLevels.map((lv, i) => [lv, i]));

        // ì…ë ¥ì¹´ë“œ ìƒì„±
        createSectionCards();

        // ì˜µì…˜ ì±„ìš°ê¸° (í˜„ì¬ëŠ” ì „ì²´, ëª©í‘œëŠ” í˜„ì¬ ì„ íƒ í›„ í•„í„°)
        const sections = ["shield","spear","arch"];
        sections.forEach((k) => {
          const curEl = document.getElementById(`cur-${k}`);
          const tgtEl = document.getElementById(`tgt-${k}`);
          const capEl = document.getElementById(`cap-${k}`);

          renderOptions(curEl, gemLevels);
          tgtEl.innerHTML = '<option value=""></option>';
          capEl.textContent = gemLevels.length ? `ìµœëŒ€ Lv.${gemLevels[gemLevels.length-1]}` : "-";
        });

        // ëª©ë¡ ì´ˆê¸° ìƒíƒœ
        renderList();

        // ì´ë²¤íŠ¸ ì—°ê²°
        wireSectionEvents();

      } catch(err){
        console.error("CSV ë¡œë“œ ì‹¤íŒ¨:", err);
        document.getElementById("InputSections").innerHTML =
          '<div class="rounded-xl border border-black/10 bg-white px-4 py-3 shadow-lg text-sm err">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. CSV ê²½ë¡œë¥¼ í™•ì¸í•˜ì„¸ìš”.</div>';
      } finally {
        sendHeightToParent();
      }
    }

    init();
  </script>

  <!-- ì„ íƒ: ê°œë°œìë„êµ¬/ìš°í´ë¦­ ë°©ì§€ (ì› ì½”ë“œ ìœ ì§€) -->
  <script>
    document.onkeydown = function (e) {
      if (
        e.keyCode === 123 || // F12
        (e.ctrlKey && e.shiftKey && e.keyCode === 73) || // Ctrl+Shift+I
        (e.ctrlKey && e.shiftKey && e.keyCode === 74) || // Ctrl+Shift+J
        (e.ctrlKey && e.keyCode === 85) // Ctrl+U
      ) {
        e.preventDefault();
        return false;
      }
    };
    document.addEventListener("contextmenu", (e) => e.preventDefault());
  </script>

  <script>
    window.addEventListener('message', (e) => {
      if (e.data?.type === 'DARK_MODE') {
        document.body.classList.toggle('dark-mode', e.data.value);
      }
    });
  </script>
</body>
</html>
