<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WOS 전문가/스킬 레벨업 계산기</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card{background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:14px;padding:14px;box-shadow:0 6px 18px rgba(15,23,42,.06)}
    .muted{color:#6b7280}
    .input{width:5.2rem;padding:.25rem .5rem;border:1px solid #d1d5db;border-radius:.5rem;text-align:right;background:#fff;color:#111827}
  </style>
</head>
<body class="bg-gray-100 p-3 font-sans text-sm">

  <!-- 상단 한 장 카드 -->
  <section class="card max-w-5xl mx-auto">
    <div class="grid grid-cols-12 gap-6 items-center">
      <!-- 1) 전문가 선택 -->
      <div class="col-span-12 md:col-span-3">
        <div class="font-semibold mb-1">전문가 선택</div>
        <select id="selType" class="px-3 py-1.5 rounded-xl border w-full md:w-auto">
          <option value="Cyrille">키릴</option>
          <option value="Agnes">아그네스</option>
          <option value="Holger">홀게르</option>
          <option value="Romulus">로물루스</option>
        </select>
      </div>

      <!-- 2) 레벨 범위 -->
      <div class="col-span-12 md:col-span-5">
        <div class="font-semibold mb-1">레벨 범위</div>
        <div class="flex items-center gap-4">
          <label class="flex items-center gap-2">
            <span class="muted">현재</span>
            <input id="expertCur" type="number" min="1" max="99" value="1" class="input">
          </label>
          <label class="flex items-center gap-2">
            <span class="muted">목표</span>
            <input id="expertTgt" type="number" min="2" max="100" value="2" class="input">
          </label>
          <span id="expertCap" class="muted"></span>
        </div>
        <p id="expertWarn" class="text-xs text-amber-600 mt-1"></p>
      </div>

      <!-- 3) 필요 합계 + 초기화 버튼 -->
      <div class="col-span-12 md:col-span-4">
        <div class="flex items-center justify-between">
          <div class="font-semibold mb-1">필요 합계</div>
          <button id="btnReset"
            class="px-3 py-1.5 rounded-xl text-sm
                   border border-slate-300 hover:border-slate-400
                   bg-white hover:bg-slate-50">
            초기화
          </button>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="flex justify-between"><span class="muted">경험치</span><span id="expertExp">0</span></div>
          <div class="flex justify-between"><span class="muted">표식</span><span id="expertMark">0</span></div>
        </div>
      </div>
    </div>
  </section>

  <!-- 스킬/총합 (원하면 카드 제거해도 안전 동작) -->
  <main class="max-w-5xl mx-auto space-y-4 mt-4">
    <section class="grid md:grid-cols-2 gap-4">
      <div class="card">
        <h3 class="font-bold mb-2">스킬 1</h3>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <div class="text-sm font-semibold mb-1">레벨 범위</div>
            <div class="flex items-center gap-4">
              <label class="flex items-center gap-2"><span class="muted">현재</span><input id="s1Cur" type="number" min="0" max="99" value="0" class="input"></label>
              <label class="flex items-center gap-2"><span class="muted">목표</span><input id="s1Tgt" type="number" min="1" max="100" value="1" class="input"></label>
            </div>
            <p id="s1Warn" class="text-xs text-amber-600 mt-1"></p>
            <p id="s1Cap" class="text-xs muted mt-1"></p>
          </div>
          <div class="text-sm">
            <div class="font-semibold mb-1">필요 합계</div>
            <div class="flex justify-between"><span class="muted">스킬 경험치</span><span id="s1Exp">0</span></div>
            <div class="flex justify-between"><span class="muted">아이템</span><span id="s1Item">0</span></div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3 class="font-bold mb-2">스킬 2</h3>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <div class="text-sm font-semibold mb-1">레벨 범위</div>
            <div class="flex items-center gap-4">
              <label class="flex items-center gap-2"><span class="muted">현재</span><input id="s2Cur" type="number" min="0" max="99" value="0" class="input"></label>
              <label class="flex items-center gap-2"><span class="muted">목표</span><input id="s2Tgt" type="number" min="1" max="100" value="1" class="input"></label>
            </div>
            <p id="s2Warn" class="text-xs text-amber-600 mt-1"></p>
            <p id="s2Cap" class="text-xs muted mt-1"></p>
          </div>
          <div class="text-sm">
            <div class="font-semibold mb-1">필요 합계</div>
            <div class="flex justify-between"><span class="muted">스킬 경험치</span><span id="s2Exp">0</span></div>
            <div class="flex justify-between"><span class="muted">아이템</span><span id="s2Item">0</span></div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3 class="font-bold mb-2">스킬 3</h3>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <div class="text-sm font-semibold mb-1">레벨 범위</div>
            <div class="flex items-center gap-4">
              <label class="flex items-center gap-2"><span class="muted">현재</span><input id="s3Cur" type="number" min="1" max="99" value="1" class="input"></label>
              <label class="flex items-center gap-2"><span class="muted">목표</span><input id="s3Tgt" type="number" min="2" max="100" value="2" class="input"></label>
            </div>
            <p id="s3Warn" class="text-xs text-amber-600 mt-1"></p>
            <p id="s3Cap" class="text-xs muted mt-1"></p>
          </div>
          <div class="text-sm">
            <div class="font-semibold mb-1">필요 합계</div>
            <div class="flex justify-between"><span class="muted">스킬 경험치</span><span id="s3Exp">0</span></div>
            <div class="flex justify-between"><span class="muted">아이템</span><span id="s3Item">0</span></div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3 class="font-bold mb-2">스킬 4</h3>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <div class="text-sm font-semibold mb-1">레벨 범위</div>
            <div class="flex items-center gap-4">
              <label class="flex items-center gap-2"><span class="muted">현재</span><input id="s4Cur" type="number" min="1" max="99" value="1" class="input"></label>
              <label class="flex items-center gap-2"><span class="muted">목표</span><input id="s4Tgt" type="number" min="2" max="100" value="2" class="input"></label>
            </div>
            <p id="s4Warn" class="text-xs text-amber-600 mt-1"></p>
            <p id="s4Cap" class="text-xs muted mt-1"></p>
          </div>
          <div class="text-sm">
            <div class="font-semibold mb-1">필요 합계</div>
            <div class="flex justify-between"><span class="muted">스킬 경험치</span><span id="s4Exp">0</span></div>
            <div class="flex justify-between"><span class="muted">아이템</span><span id="s4Item">0</span></div>
          </div>
        </div>
      </div>
    </section>

    <!-- 총합 -->
    <section class="card">
      <h2 class="text-base font-bold mb-2">총합</h2>
      <div class="grid sm:grid-cols-4 gap-3 text-sm">
        <div>
          <div class="font-semibold mb-1">전문가</div>
          <div class="flex justify-between"><span class="muted">경험치</span><span id="sumExpertExp">0</span></div>
          <div class="flex justify-between"><span class="muted">표식</span><span id="sumExpertMark">0</span></div>
        </div>
        <div>
          <div class="font-semibold mb-1">스킬 합계</div>
          <div class="flex justify-between"><span class="muted">스킬 경험치</span><span id="sumSkillExp">0</span></div>
          <div class="flex justify-between"><span class="muted">아이템</span><span id="sumSkillItem">0</span></div>
        </div>
        <div class="sm:col-span-2">
          <div class="font-semibold mb-1">전체 합계</div>
          <div class="grid grid-cols-2 gap-2">
            <div class="flex justify-between"><span class="muted">총 경험치</span><span id="sumAllExp">0</span></div>
            <div class="flex justify-between"><span class="muted">총 소모 (표식+아이템)</span><span id="sumAllToken">0</span></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    /* ========== 1) CSV 경로/최대 레벨 ========== */
    const SETTINGS = {
      "Cyrille": {
        base:   { csv: "https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Expertise/Cyrille.csv", max: 100 },
        skills: [{csv:"",max:100},{csv:"",max:100},{csv:"",max:100},{csv:"",max:100}]
      },
      "Agnes":   { base:{csv:"",max:100}, skills:[{csv:"",max:100},{csv:"",max:100},{csv:"",max:100},{csv:"",max:100}] },
      "Holger":  { base:{csv:"",max:100}, skills:[{csv:"",max:100},{csv:"",max:100},{csv:"",max:100},{csv:"",max:100}] },
      "Romulus": { base:{csv:"",max:100}, skills:[{csv:"",max:100},{csv:"",max:100},{csv:"",max:100},{csv:"",max:100}] }
    };

    /* ========== 2) 유틸 ========== */
    const fmt = n => Number(n||0).toLocaleString("ko-KR");
    const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));

    function parseExpertCSV(text){
      const rows = text.replace(/\r/g,"").split("\n").filter(Boolean);
      if(!rows.length) return [[],[],2];
      const head = rows[0].split(/[,;\t]/).map(s=>s.trim());
      const hasHeader = /(레벨|Lv|LEVEL|level)/i.test(head[0]||"");
      const data = hasHeader ? rows.slice(1) : rows;

      const L=[], Eabs=[], Mabs=[];
      for(const line of data){
        const c=line.split(/[,;\t]/);
        const lv  = Number((c[0]??"").replace(/[^0-9.-]/g,""));
        const exp = Number((c[1]??"").replace(/[^0-9.-]/g,""));
        const mk  = Number((c[2]??"").replace(/[^0-9.-]/g,""));
        if(Number.isFinite(lv)) L.push(lv);
        Eabs.push(Number.isFinite(exp)?exp:0);
        Mabs.push(Number.isFinite(mk)?mk:0);
      }
      
      const idx=L.map((_,i)=>i).sort((a,b)=>L[a]-L[b]);
      const E = idx.map(i=>Eabs[i]);
      const M = idx.map(i=>Mabs[i]);

      function toSteps(abs){
        if(abs.length<=1) return [];
        let inc=0; for(let i=0;i<abs.length-1;i++) if(abs[i+1]-abs[i]>0) inc++;
        const cumulative = inc >= Math.max(1, Math.floor((abs.length-1)*0.6));
        if(!cumulative) return abs;
        const step=[]; for(let i=0;i<abs.length-1;i++) step.push(Math.max(0,abs[i+1]-abs[i]));
        return step; // Lv1→2가 step[0]
      }
      
      const expSteps  = toSteps(E);
      const markSteps = toSteps(M);
      const maxLevel  = Math.max(2, Math.min(L.length,100));
      return [expSteps, markSteps, maxLevel];
    }

    function parseCSV2Cols(text){
      const rows=text.replace(/\r/g,"").split("\n").filter(Boolean);
      const a=[],b=[];
      for(const line of rows){
        const c=line.split(/[,;\t]/);
        const v1=Number((c[0]??"").replace(/[^0-9.-]/g,""));
        const v2=Number((c[1]??"").replace(/[^0-9.-]/g,""));
        a.push(Number.isFinite(v1)?v1:0);
        b.push(Number.isFinite(v2)?v2:0);
      }
      return [a,b];
    }

    function sumRange(perLevel, fromLv, toLv, maxLv){
      const dataMax = Math.max(2, Math.min((perLevel?.length||0)+1, 100));
      const hardMax = Math.max(2, Math.min(maxLv ?? dataMax, dataMax));
      const F = Math.max(1, Math.min(fromLv, hardMax-1));
      const T = Math.max(2, Math.min(toLv,   hardMax));
      if(T<=F) return 0;
      let s=0; for(let lv=F; lv<T; lv++) s+= perLevel[lv-1]||0;
      return s;
    }

    async function fetchText(url){
      const res = await fetch(url, { cache:"no-store" });
      if(!res.ok) throw new Error("CSV 로드 실패: "+url+" ("+res.status+")");
      return await res.text();
    }

    /* ========== 3) 데이터 메모리 ========== */
    let expertExp=Array(100).fill(0), expertMark=Array(100).fill(0);
    let skillExp=[0,1,2,3].map(()=>Array(100).fill(0));
    let skillItem=[0,1,2,3].map(()=>Array(100).fill(0));

    /* ========== 4) DOM ========== */
    const selType=document.getElementById("selType");
    const expertCur=document.getElementById("expertCur");
    const expertTgt=document.getElementById("expertTgt");
    const expertWarn=document.getElementById("expertWarn");
    const expertCap=document.getElementById("expertCap");
    const outExpertExp=document.getElementById("expertExp");
    const outExpertMark=document.getElementById("expertMark");
    const btnReset=document.getElementById("btnReset");

    const skillRefs = [1,2,3,4].map(i=>{
      const cur  = document.getElementById(`s${i}Cur`);
      const tgt  = document.getElementById(`s${i}Tgt`);
      const warn = document.getElementById(`s${i}Warn`);
      const cap  = document.getElementById(`s${i}Cap`);
      const outExp  = document.getElementById(`s${i}Exp`);
      const outItem = document.getElementById(`s${i}Item`);
      if (!cur || !tgt) return null;
      return { cur, tgt, warn, cap, outExp, outItem };
    }).filter(Boolean);

    const sumExpertExp=document.getElementById("sumExpertExp");
    const sumExpertMark=document.getElementById("sumExpertMark");
    const sumSkillExp =document.getElementById("sumSkillExp");
    const sumSkillItem=document.getElementById("sumSkillItem");
    const sumAllExp   =document.getElementById("sumAllExp");
    const sumAllToken =document.getElementById("sumAllToken");

    /* ========== 5) 상한/정규화/초기화 ========== */
    function applyMaxCaps(type){
      const conf=SETTINGS[type];
      const baseMax=conf?.base?.max ?? Math.min(expertExp.length||100,100);
      expertCur.max=Math.max(1,baseMax-1);
      expertTgt.max=baseMax;
      expertCap.textContent=`(최대 레벨 ${baseMax})`;

      skillRefs.forEach((ref,i)=>{
        const m=conf?.skills?.[i]?.max ?? Math.min(skillExp[i].length||100,100);
        ref.cur.max=Math.max(+ref.cur.min||0, m-1);
        ref.tgt.max=m;
        if (ref.cap) ref.cap.textContent=`(최대 레벨 ${m})`;
      });
    }

    function normalizeInputs(type){
      const conf=SETTINGS[type];
      const baseMax=conf?.base?.max ?? Math.min(expertExp.length||100,100);
      expertCur.value=clamp(+expertCur.value||1,1,baseMax-1);
      expertTgt.value=clamp(+expertTgt.value||2,2,baseMax);
      if (+expertTgt.value<=+expertCur.value) expertTgt.value=Math.min(+expertCur.value+1,baseMax);

      skillRefs.forEach((ref,i)=>{
        const m=conf?.skills?.[i]?.max ?? Math.min(skillExp[i].length||100,100);
        const curMin=+ref.cur.min||0;
        ref.cur.value=clamp(+ref.cur.value||curMin,curMin,m-1);
        ref.tgt.value=clamp(+ref.tgt.value||curMin+1,curMin+1,m);
        if (+ref.tgt.value<=+ref.cur.value) ref.tgt.value=Math.min(+ref.cur.value+1,m);
      });
    }

    // ✅ 공통 초기화: 버튼 클릭/전문가 변경 시 둘 다 사용
    function resetInputs(type){
      const conf=SETTINGS[type];
      const baseMax=conf?.base?.max ?? Math.min(expertExp.length||100,100);
      expertCur.value=1;
      expertTgt.value=Math.min(2, baseMax);
      skillRefs.forEach((ref,i)=>{
        const m=conf?.skills?.[i]?.max ?? Math.min(skillExp[i].length||100,100);
        const curMin=+ref.cur.min||0; // 스킬 0레벨 시작 고려
        ref.cur.value=curMin;
        ref.tgt.value=Math.min(curMin+1, m);
      });
    }

    /* ========== 6) 계산 ========== */
    function calc(){
      const type=selType.value;
      const conf=SETTINGS[type];

      // 본체
      const baseMax=conf?.base?.max ?? Math.min(expertExp.length||100,100);
      const cur=+expertCur.value||1;
      const tgt=+expertTgt.value||2;
      expertWarn.textContent=(tgt<=cur)?"목표 레벨은 현재보다 커야 합니다.":"";
      const eExp = sumRange(expertExp, cur, tgt, baseMax);
      const eMark= sumRange(expertMark, cur, tgt, baseMax);
      outExpertExp.textContent=fmt(eExp);
      outExpertMark.textContent=fmt(eMark);

      // 스킬
      let tExp=0,tItem=0;
      skillRefs.forEach((ref,i)=>{
        const m=conf?.skills?.[i]?.max ?? Math.min(skillExp[i].length||100,100);
        const c=+ref.cur.value || (+ref.cur.min||0);
        const t=+ref.tgt.value || (c+1);
        ref.warn && (ref.warn.textContent=(t<=c)?"목표 레벨은 현재보다 커야 합니다.":"");
        const sE=sumRange(skillExp[i], c, t, m);
        const sI=sumRange(skillItem[i],c, t, m);
        ref.outExp && (ref.outExp.textContent=fmt(sE));
        ref.outItem && (ref.outItem.textContent=fmt(sI));
        tExp+=sE; tItem+=sI;
      });

      // 총합
      sumExpertExp.textContent=fmt(eExp);
      sumExpertMark.textContent=fmt(eMark);
      sumSkillExp.textContent=fmt(tExp);
      sumSkillItem.textContent=fmt(tItem);
      sumAllExp.textContent=fmt(eExp+tExp);
      sumAllToken.textContent=fmt(eMark+tItem);
    }

    /* ========== 7) CSV 로드 ========== */
    async function loadDataFor(type){
      const conf=SETTINGS[type];
      expertWarn.textContent="";

      // 본체
      if(conf.base?.csv){
        try{
          const txt=await fetchText(conf.base.csv);
          const [eStep,mStep,dataMax]=parseExpertCSV(txt);
          expertExp=eStep.slice(0,100);
          expertMark=mStep.slice(0,100);
          conf.base.max=Math.min(conf.base.max ?? dataMax, dataMax);
        }catch(e){
          console.warn(e);
          expertWarn.textContent="본체 CSV를 불러오지 못했습니다. 경로/CORS 확인";
          expertExp=Array(100).fill(0); expertMark=Array(100).fill(0);
        }
      }else{
        expertExp=Array(100).fill(0); expertMark=Array(100).fill(0);
      }

      // 스킬 1~4
      for(let i=0;i<4;i++){
        const s=conf.skills[i]||{};
        if(s.csv){
          try{
            const txt=await fetchText(s.csv);
            const [a,b]=parseCSV2Cols(txt);
            skillExp[i]=a.slice(0,100);
            skillItem[i]=b.slice(0,100);
            const dataMax=Math.max(2, Math.min(a.length+1,100));
            s.max=Math.min(s.max ?? dataMax, dataMax);
          }catch(e){
            console.warn(e);
            skillExp[i]=Array(100).fill(0);
            skillItem[i]=Array(100).fill(0);
          }
        }else{
          skillExp[i]=Array(100).fill(0);
          skillItem[i]=Array(100).fill(0);
        }
      }
    }

    /* ========== 8) 이벤트 & 초기화 ========== */
    // 초기화 버튼
    btnReset?.addEventListener("click", ()=>{
      const type = selType.value;
      resetInputs(type);   // ✅ 값 초기화
      calc();              // ✅ 즉시 재계산
    });

    // 전문가 변경 시: 로드 → 상한 → ✅초기화 → 계산
    selType?.addEventListener("change", async ()=>{
      await loadDataFor(selType.value);
      applyMaxCaps(selType.value);
      resetInputs(selType.value);   // ✅ 자동 초기화
      calc();
    });

    expertCur?.addEventListener("input", calc);
    expertTgt?.addEventListener("input", calc);
    skillRefs.forEach(ref=>{
      ref.cur?.addEventListener("input", calc);
      ref.tgt?.addEventListener("input", calc);
    });

    // 최초 실행
    (async function init(){
      await loadDataFor(selType.value);
      applyMaxCaps(selType.value);
      resetInputs(selType.value);   // ✅ 첫 진입도 초기화 상태로
      calc();                       // 현재=1, 목표=2 즉시 계산
      sendHeightToParent();
    })();
  });
  </script>
  <script>
    function sendHeightToParent() {
      const height = document.body.scrollHeight + 10;
      window.parent.postMessage({ type: "FRAME_CHANGE", height }, "*");
    }
  
    // 페이지 최초 로드 시
    window.addEventListener("load", () => {
      setTimeout(sendHeightToParent, 100); // 약간의 렌더링 대기
    });
    
    function loadPage(page) {
      const isMobile = window.innerWidth <= 768;
      const height = isMobile ? "550px" : "345px"
        window.location.href = page;
      window.parent.postMessage({ type: "SET_FRAME_SIZE", height: height, width: "100%"}, "*");
    }
  </script>
</body>
</html>
