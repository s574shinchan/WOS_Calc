<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WOS 전문가/스킬 레벨업 계산기 (자동 목표 = 현재+1)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .muted{color:#6b7280}
    .value{min-width:3rem;text-align:right}
    .pill{padding:.35rem .6rem;border:1px solid #d1d5db;border-radius:.75rem;background:#fff;color:#111827}
    @media (max-width: 900px){
      .toolbar{grid-template-columns: 1fr}
    }
    .inline-label{display:flex;align-items:center;gap:.5rem}
    select.pill{height:32px}
    .err{color:#b45309}
     /* ✅ 다크모드 전용 */
    body.dark-mode {
      background-color: #121212;
      color: #f0f0f0;
    }
    
    .dark-mode .border { border-color: #444 !important; }
    .dark-mode .bg-white { background-color: #2c2c2c !important; color: #f0f0f0 !important; }
    .dark-mode .bg-gray-100 { background-color: #1e1e1e !important; }
  
    .dark-mode .text-gray-800,
    .dark-mode .text-gray-700,
    .dark-mode .text-gray-600 { color: #dddddd !important; }
  
    .dark-mode .text-blue-700 { color: #66b0ff !important; }
    .dark-mode .text-blue-600 { color: #80caff !important; }
    .dark-mode .text-orange-500 { color: #ffa94d !important; }
    .dark-mode .text-green-600 { color: #79e68c !important; }
    .dark-mode .text-red-500 { color: #ff8080 !important; }
    .dark-mode .text-gray-500 { color: #aaa !important; }    
    
    .dark-mode .text-gray-800, 
    .dark-mode .text-gray-600 { color: #e0e0e0 !important; }
    
    .dark-mode table { background-color: #2c2c2c; color: #f0f0f0; }
    .dark-mode th, .dark-mode td { border-color: #444 !important; }
    .dark-mode thead th { color: #000 !important; }
    
    .dark-mode .bg-amber-100,    
    .dark-mode .bg-green-100,
    .dark-mode .bg-indigo-100 { background-color: #3a3a3a !important; color: #f0f0f0 !important; }
    
    .dark-mode .bg-white { background-color: #2c2c2c !important; color: #f0f0f0 !important; }
    .dark-mode .bg-gray-100 { background-color: #1e1e1e !important; }
    
    .dark-mode .bg-amber-50,
    .dark-mode .bg-indigo-50 { background-color: #2d2d2d !important; }

    .dark-mode .bg-blue-100,
    .dark-mode .bg-blue-50,
    .dark-mode .bg-orange-50,
    .dark-mode .bg-red-50 { background-color: #2e2e2e !important; }
    
    .dark-mode summary { background-color: #333 !important; color: #fff !important; }
    .dark-mode ul li { color: #ddd; }
    
    .dark-mode select option { color: #000 !important; }
    .dark-mode select { color: #000 !important; }
    .dark-mode input { color: #000 !important; }
  </style>
  <!-- ✅ 다크모드 상태 유지 스크립트 -->
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
      }
    });
  </script>
</head>
<body class="bg-gray-100 p-3 font-sans text-sm">
  <main class="max-w-[1500] mx-auto bg-white p-2 rounded-xl shadow-md">
    <header class="flex items-center justify-between">
      <div class ="p-4">
        <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight text-gray-800">WOS 전문가/스킬 레벨업 계산기</h1>
        <p class="text-sm muted mt-1">레벨을 선택하면 필요한 <b>경험치</b>와 <b>표식·학습의 책</b> 합계를 계산합니다.</p>
      </div>
    </header>

    <section class="mb-4 rounded-xl border border-black/10 bg-white px-4 py-3 shadow-lg">
      <div class="toolbar text-gray-800"
           style="display:grid;grid-template-columns:180px 1fr auto;gap:16px;align-items:center;">
        <div class="space-y-1">
          <div class="font-semibold">전문가 선택</div>
          <select id="selType" class="pill w-full">
            <option value="Cyrille">키릴</option>
            <option value="Agnes">아그네스</option>
            <option value="Holger">홀게르</option>
            <option value="Romulus">로물루스</option>
          </select>
        </div>

        <div class="space-y-1">
          <div class="font-semibold">레벨 범위 <span id="expertCap" class="muted"></span></div>
          <div class="flex flex-wrap items-center gap-6">
            <label class="inline-label"><span class="muted">현재</span>
              <select id="expertCur" class="pill w-28"></select></label>
            <label class="inline-label"><span class="muted">목표</span>
              <select id="expertTgt" class="pill w-28"></select></label>
          </div>
          <p id="expertWarn" class="text-xs err mt-1"></p>
        </div>

        <div class="text-right">
          <button id="btnReset" class="px-3 py-1.5 rounded-xl text-sm border border-slate-300 hover:border-slate-400 bg-white hover:bg-slate-50">초기화</button>
        </div>
      </div>
    </section>

    <section class="grid md:grid-cols-2 gap-4 mb-4">
      <div class="mb-4 rounded-xl border border-black/10 bg-white px-4 py-3 shadow-lg">
        <h3 class="text-base font-bold mb-3">스킬 1</h3>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <div class="text-sm font-semibold mb-1">레벨 범위 <span id="s1Cap" class="muted"></span></div>
            <div class="flex items-center gap-4">
              <label class="inline-label"><span class="muted">현재</span><select id="s1Cur" class="pill w-20"></select></label>
              <label class="inline-label"><span class="muted">목표</span><select id="s1Tgt" class="pill w-20"></select></label>
            </div>
            <p id="s1Warn" class="text-xs err mt-1"></p>
          </div>
          <div>
            <div class="text-sm font-semibold mb-1">필요 합계</div>
            <div class="space-y-1 text-sm">
              <div class="flex justify-between"><span class="muted">스킬 경험치</span><span id="s1Exp">0</span></div>
              <div class="flex justify-between"><span class="muted">학습의 책</span><span id="s1Item">0</span></div>
            </div>
          </div>
        </div>
      </div>

      <div class="mb-4 rounded-xl border border-black/10 bg-white px-4 py-3 shadow-lg">
        <h3 class="text-base font-bold mb-3">스킬 2</h3>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <div class="text-sm font-semibold mb-1">레벨 범위 <span id="s2Cap" class="muted"></span></div>
            <div class="flex items-center gap-4">
              <label class="inline-label"><span class="muted">현재</span><select id="s2Cur" class="pill w-20"></select></label>
              <label class="inline-label"><span class="muted">목표</span><select id="s2Tgt" class="pill w-20"></select></label>
            </div>
            <p id="s2Warn" class="text-xs err mt-1"></p>
          </div>
          <div>
            <div class="text-sm font-semibold mb-1">필요 합계</div>
            <div class="space-y-1 text-sm">
              <div class="flex justify-between"><span class="muted">스킬 경험치</span><span id="s2Exp">0</span></div>
              <div class="flex justify-between"><span class="muted">학습의 책</span><span id="s2Item">0</span></div>
            </div>
          </div>
        </div>
      </div>

      <div class="mb-4 rounded-xl border border-black/10 bg-white px-4 py-3 shadow-lg">
        <h3 class="text-base font-bold mb-3">스킬 3</h3>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <div class="text-sm font-semibold mb-1">레벨 범위 <span id="s3Cap" class="muted"></span></div>
            <div class="flex items-center gap-4">
              <label class="inline-label"><span class="muted">현재</span><select id="s3Cur" class="pill w-20"></select></label>
              <label class="inline-label"><span class="muted">목표</span><select id="s3Tgt" class="pill w-20"></select></label>
            </div>
            <p id="s3Warn" class="text-xs err mt-1"></p>
          </div>
          <div>
            <div class="text-sm font-semibold mb-1">필요 합계</div>
            <div class="space-y-1 text-sm">
              <div class="flex justify-between"><span class="muted">스킬 경험치</span><span id="s3Exp">0</span></div>
              <div class="flex justify-between"><span class="muted">학습의 책</span><span id="s3Item">0</span></div>
            </div>
          </div>
        </div>
      </div>

      <div class="mb-4 rounded-xl border border-black/10 bg-white px-4 py-3 shadow-lg">
        <h3 class="text-base font-bold mb-3">스킬 4</h3>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <div class="text-sm font-semibold mb-1">레벨 범위 <span id="s4Cap" class="muted"></span></div>
            <div class="flex items-center gap-4">
              <label class="inline-label"><span class="muted">현재</span><select id="s4Cur" class="pill w-20"></select></label>
              <label class="inline-label"><span class="muted">목표</span><select id="s4Tgt" class="pill w-20"></select></label>
            </div>
            <p id="s4Warn" class="text-xs err mt-1"></p>
          </div>
          <div>
            <div class="text-sm font-semibold mb-1">필요 합계</div>
            <div class="space-y-1 text-sm">
              <div class="flex justify-between"><span class="muted">스킬 경험치</span><span id="s4Exp">0</span></div>
              <div class="flex justify-between"><span class="muted">학습의 책</span><span id="s4Item">0</span></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <div class="mb-4 rounded-xl border border-black/10 bg-white px-4 py-3 shadow-lg">
      <h2 class="text-base font-bold mb-3">총합</h2>
      <div class="grid sm:grid-cols-2 gap-4 text-sm">
        <div>
          <div class="font-semibold mb-1">전문가</div>
          <div class="flex justify-between"><span class="muted">경험치</span><span id="sumExpertExp">0</span></div>
          <div class="flex justify-between"><span class="muted">표식</span><span id="sumExpertMark">0</span></div>
        </div>
        <div>
          <div class="font-semibold mb-1">스킬 합계</div>
          <div class="flex justify-between"><span class="muted">스킬 경험치</span><span id="sumSkillExp">0</span></div>
          <div class="flex justify-between"><span class="muted">학습의 책</span><span id="sumSkillItem">0</span></div>
        </div>
      </div>
    </div>
  </main>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const SETTINGS = {
      "Cyrille": {
        base: { csv: "https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Expertise/Cyrille.csv" },
        skills: [
          { csv:"https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Expertise/Cyrille_S1.csv" },
          { csv:"https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Expertise/Cyrille_S2.csv" },
          { csv:"https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Expertise/Cyrille_S3.csv" },
          { csv:"https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Expertise/Cyrille_S4.csv" },
        ]
      },
      "Agnes": {
        base: { csv: "https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Expertise/Agnes.csv" },
        skills: [
          { csv:"https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Expertise/Agnes_S1.csv" },
          { csv:"https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Expertise/Agnes_S2.csv" },
          { csv:"https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Expertise/Agnes_S3.csv" },
          { csv:"https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Expertise/Agnes_S4.csv" },
        ]
      },
      "Holger": {
        base: { csv: "https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Expertise/Holger.csv" },
        skills: [
          { csv:"https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Expertise/Holger_S1.csv" },
          { csv:"https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Expertise/Holger_S2.csv" },
          { csv:"https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Expertise/Holger_S3.csv" },
          { csv:"https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Expertise/Holger_S4.csv" },
        ]
      },
      "Romulus": {
        base: { csv: "https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Expertise/Romulus.csv" },
        skills: [
          { csv:"https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Expertise/Romulus_S1.csv" },
          { csv:"https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Expertise/Romulus_S2.csv" },
          { csv:"https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Expertise/Romulus_S3.csv" },
          { csv:"https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Expertise/Romulus_S4.csv" },
        ]
      },
    };

    // ===== STATE =====
    let expertLevels = [], expertExp = [], expertMark = [];
    const skillLevels = [[],[],[],[]];
    const skillExp  = [[],[],[],[]];
    const skillItem = [[],[],[],[]];

    // ===== DOM =====
    const $ = (id)=>document.getElementById(id);
    const selType = $("selType");
    const expertCur = $("expertCur");
    const expertTgt = $("expertTgt");
    const expertWarn = document.getElementById("expertWarn"); // 없을 수 있음
    const expertCap  = $("expertCap");
    const sumExpertExp  = $("sumExpertExp");
    const sumExpertMark = $("sumExpertMark");
    const btnReset = $("btnReset");

    const sRef = [1,2,3,4].map(i=>({
      cur:$(`s${i}Cur`), tgt:$(`s${i}Tgt`),
      warn:$(`s${i}Warn`), cap:$(`s${i}Cap`),
      outE:$(`s${i}Exp`), outI:$(`s${i}Item`)
    }));

    const sumSkillExp = $("sumSkillExp");
    const sumSkillItem = $("sumSkillItem");

    // ===== UTIL =====
    const fmt = n => Number(n||0).toLocaleString("ko-KR");
    const isFilled = v => v !== "" && v !== null && v !== undefined && !Number.isNaN(+v);

    function detectDelim(sample){
      if (sample.includes("\t")) return "\t";
      if (sample.includes(";"))  return ";";
      return ",";
    }

    // 한 줄 CSV를 'Lv.N' 앞에서 강제 줄바꿈 (본체/스킬 공통)
    function preprocessByLevel(text){
      let s = text.replace(/\uFEFF/g,"").replace(/\r/g,"");
      if (!s.includes("\n") && /Lv\.\s*\d+/i.test(s)) {
        s = s.replace(/(Lv\.\s*\d+)/gi, "\n$1");
      }
      return s;
    }

    // 본체 CSV 파서 (정수 레벨, 누적/구간 자동)
    function parseExpertCSV(text){
      const pre = preprocessByLevel(text);
      const lines = pre.split("\n").filter(l=>l.trim()!=="");
      if (!lines.length) return { levels:[], expSteps:[], markSteps:[] };

      const delim = detectDelim(lines[0]);
      const hasHeader = /(레벨|lv|level|경험치|exp)/i.test(lines[0]);
      const start = hasHeader ? 1 : 0;

      const EXP = new Map(), MARK = new Map();
      const rawLevels = [];
      const toInt = s => { const m = String(s||"").match(/\d+/); return m ? parseInt(m[0], 10) : NaN; };
      const toNum = s => { const m = String(s||"").match(/-?\d+(\.\d+)?/); return m ? Number(m[0]) : 0; };

      for (let i=start;i<lines.length;i++){
        const c  = lines[i].split(delim);
        const lv = toInt(c[0]);
        if (!Number.isFinite(lv)) continue;
        rawLevels.push(lv);
        const ex = toNum(c[1]);
        const mk = toNum(c[2]);
        EXP.set(lv, ex);
        MARK.set(lv, mk);
      }

      const levels = [...new Set(rawLevels)].sort((a,b)=>a-b);
      if (levels.length < 2) return { levels, expSteps:[], markSteps:[] };

      const isCum = (map)=>{
        let prev=null, nondec=0, pos=0;
        for (const lv of levels){
          const v = map.get(lv) ?? 0;
          if (prev!==null){ if (v>=prev) nondec++; if (v>prev) pos++; }
          prev = v;
        }
        return nondec >= (levels.length-1) && pos>0;
      };
      const cumExp  = isCum(EXP);
      const cumMark = isCum(MARK);

      const expSteps=[], markSteps=[];
      for (let i=0;i<levels.length-1;i++){
        const a=levels[i], b=levels[i+1];
        if (cumExp) {
          expSteps[i] = Math.max(0, (EXP.get(b)||0) - (EXP.get(a)||0));
        } else {
          // 비누적 CSV: '해당(목표) 레벨 비용'을 사용 (1→2 = Lv2의 값)
          expSteps[i] = Math.max(0, (EXP.get(b)||0));
        }
        if (cumMark) {
          markSteps[i] = Math.max(0, (MARK.get(b)||0) - (MARK.get(a)||0));
        } else {
          markSteps[i] = Math.max(0, (MARK.get(b)||0));
        }
      }
      return { levels, expSteps, markSteps };
    }

    // 스킬 CSV (2열/3열 자동)
    function parseSkillCSV(text){
      const pre = preprocessByLevel(text);
      const rows = pre.split("\n").filter(l=>l.trim()!=="");
      if (!rows.length) return { levels:[], expSteps:[], itemSteps:[] };
      const delim = detectDelim(rows[0]);
      const headerLooks = /(레벨|lv|level|exp|item|아이템|학습의 책|경험치)/i.test(rows[0]);
      const start = headerLooks ? 1 : 0;

      const exp=[], item=[], levelsFromFile=[];
      const toInt = s => { const m = String(s||"").match(/\d+/); return m ? parseInt(m[0],10) : NaN; };
      const toNum = s => { const m = String(s||"").match(/-?\d+(\.\d+)?/); return m ? Number(m[0]) : 0; };

      for (let i=start;i<rows.length;i++){
        const c = rows[i].split(delim);
        if (c.length >= 3){                 // Level,Exp,Item
          const lv = toInt(c[0]); if (Number.isFinite(lv)) levelsFromFile.push(lv);
          exp.push(toNum(c[1])); item.push(toNum(c[2]));
        }else{                              // Exp,Item
          exp.push(toNum(c[0])); item.push(toNum(c[1]));
        }
      }
      const L = Math.max(1, exp.length);
      let levels;
      if (levelsFromFile.length){
        const uniq = [...new Set(levelsFromFile)].sort((a,b)=>a-b);
        levels = uniq.length >= (L+1) ? uniq.slice(0, L+1) : Array.from({length:L+1}, (_,i)=>i);
      }else{
        levels = Array.from({length:L+1}, (_,i)=>i); // 0..L
      }
      return { levels, expSteps:exp, itemSteps:item };
    }

    // 옵션 렌더링 (Lv.포맷 지원)
    function renderOptions(selectEl, levels, useDot=false){
      const label = lv => useDot ? `Lv.${lv}` : `Lv${lv}`;
      const opts = ['<option value=""></option>']
        .concat(levels.map(lv => `<option value="${lv}">${label(lv)}</option>`))
        .join("");
      selectEl.innerHTML = opts;
    }
    function renderTargetOptions(selectEl, levels, greaterThan, useDot=false){
      const label = lv => useDot ? `Lv.${lv}` : `Lv${lv}`;
      const filtered = levels.filter(lv => lv > greaterThan);
      const opts = ['<option value=""></option>']
        .concat(filtered.map(lv => `<option value="${lv}">${label(lv)}</option>`))
        .join("");
      selectEl.innerHTML = opts;
    }

    // CORS 친화 fetch + 디버깅
    async function fetchText(url){
      try{
        const r = await fetch(url, { cache:"no-store", mode:"cors", redirect:"follow", referrerPolicy:"no-referrer" });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        return await r.text();
      }catch(err){
        console.error("네트워크/CORS 에러:", url, err);
        throw err;
      }
    }

    async function loadDataFor(type){
      const conf = SETTINGS[type];
      // 본체
      if (conf.base?.csv){
        try{
          const txt = await fetchText(conf.base.csv);
          const { levels, expSteps, markSteps } = parseExpertCSV(txt);
          expertLevels = levels;
          expertExp    = expSteps;
          expertMark   = markSteps;
          renderOptions(expertCur, levels, true);  // 현재: 전체
          renderTargetOptions(expertTgt, [], 0, true); // 목표: 비워두기
          if (expertWarn) expertWarn.textContent = "";
        }catch(e){
          if (expertWarn) expertWarn.textContent = "데이터를 불러오지 못했습니다. 경로/CORS 확인";
          expertLevels = []; expertExp=[]; expertMark=[];
          renderOptions(expertCur, [], true);
          renderOptions(expertTgt, [], true);
        }
      }
      // 스킬 1~4
      for (let i=0;i<4;i++){
        const s = conf.skills?.[i];
        const ref = sRef[i];
        if (!ref) continue;
        if (s && s.csv){
          try{
            const txt = await fetchText(s.csv);
            const { levels, expSteps, itemSteps } = parseSkillCSV(txt);
            skillLevels[i] = levels;
            skillExp[i]    = expSteps;
            skillItem[i]   = itemSteps;
            ref.cap.textContent = levels.length ? `(최대 레벨 Lv.${levels[levels.length-1]})` : "";
            renderOptions(ref.cur, levels, true);           // 현재: 전체
            renderTargetOptions(ref.tgt, [], 0, true);      // 목표: 비워두기
            ref.warn.textContent = "";
          }catch(e){
            console.warn("[CSV] 스킬 불러오기 실패", i+1, e);
            skillLevels[i]=[]; skillExp[i]=[]; skillItem[i]=[];
            ref.cap.textContent = "";
            renderOptions(ref.cur, [], true);
            renderOptions(ref.tgt, [], true);
            ref.warn.textContent = "스킬 로드 실패";
          }
        }else{
          skillLevels[i]=[]; skillExp[i]=[]; skillItem[i]=[];
          ref.cap.textContent = "";
          renderOptions(ref.cur, [], true);
          renderOptions(ref.tgt, [], true);
          ref.warn.textContent = "";
        }
        ref.outE.textContent = "0";
        ref.outI.textContent = "0";
      }
      // 총합 초기화
      if (sumExpertExp)  sumExpertExp.textContent  = "0";
      if (sumExpertMark) sumExpertMark.textContent = "0";
      sumSkillExp.textContent  = "0";
      sumSkillItem.textContent = "0";
      sendHeightToParent();
    }

    function sumRangeSteps(steps, fromLv, toLv){
      let s=0; for (let lv=fromLv; lv<toLv; lv++) s += steps[lv]||0; return s;
    }

    function calc(){
      // 본체
      let eExp=0, eMark=0;
      const curLv = +expertCur.value, tgtLv = +expertTgt.value;
      if (isFilled(curLv) && isFilled(tgtLv) && expertLevels.length>1){
        const fi = expertLevels.indexOf(curLv), ti = expertLevels.indexOf(tgtLv);
        if (expertWarn) {
          expertWarn.textContent = (ti<=fi) ? "목표 레벨은 현재보다 커야 합니다." : "";
        }
        if (fi>=0 && ti>fi){
          for (let i=fi; i<ti; i++){ eExp += (expertExp[i]||0); eMark += (expertMark[i]||0); }
        }
      } else {
        if (expertWarn) expertWarn.textContent = "";
      }
      if (sumExpertExp)  sumExpertExp.textContent  = fmt(eExp);
      if (sumExpertMark) sumExpertMark.textContent = fmt(eMark);

      // 스킬
      let tExp=0, tItem=0;
      sRef.forEach((ref,i)=>{
        let sE=0, sI=0;
        const cV = ref.cur.value, tV = ref.tgt.value;
        if (isFilled(cV) && isFilled(tV) && skillLevels[i].length>1){
          const c=+cV, t=+tV;
          ref.warn.textContent = (t<=c) ? "목표 레벨은 현재보다 커야 합니다." : "";
          if (t>c){ sE = sumRangeSteps(skillExp[i], c, t); sI = sumRangeSteps(skillItem[i], c, t); }
        } else {
          ref.warn.textContent = "";
        }
        ref.outE.textContent = fmt(sE);
        ref.outI.textContent = fmt(sI);
        tExp += sE; tItem += sI;
      });
      sumSkillExp.textContent  = fmt(tExp);
      sumSkillItem.textContent = fmt(tItem);
    }

    function clearAll(){
      expertCur.value = "";
      expertTgt.innerHTML = '<option value=""></option>';
      if (expertWarn) expertWarn.textContent = "";
      if (sumExpertExp)  sumExpertExp.textContent  = "0";
      if (sumExpertMark) sumExpertMark.textContent = "0";
      sRef.forEach(ref=>{
        ref.cur.value="";
        ref.tgt.innerHTML = '<option value=""></option>';
        ref.warn.textContent=""; ref.outE.textContent="0"; ref.outI.textContent="0";
      });
      sumSkillExp.textContent  = "0";
      sumSkillItem.textContent = "0";
    }

    // ====== 자동 목표 = 현재+1 ======
    expertCur.addEventListener("change", () => {
      const cur = +expertCur.value;
      if (!isFilled(cur)) { expertTgt.innerHTML = '<option value=""></option>'; return; }
      renderTargetOptions(expertTgt, expertLevels, cur, true);
      // 첫 유효 옵션(=cur+1)이 있으면 자동 선택
      if (expertTgt.options.length > 1) expertTgt.selectedIndex = 1;
      calc();
    });

    sRef.forEach((ref, i) => {
      ref.cur.addEventListener("change", () => {
        const cur = +ref.cur.value;
        if (!isFilled(cur)) { ref.tgt.innerHTML = '<option value=""></option>'; ref.warn.textContent=""; calc(); return; }
        renderTargetOptions(ref.tgt, skillLevels[i], cur, true);
        if (ref.tgt.options.length > 1) ref.tgt.selectedIndex = 1;
        ref.warn.textContent = "";
        calc();
      });
    });

    // 변동에 따른 계산
    [expertTgt].forEach(el=>{ el.addEventListener("change", calc); });
    sRef.forEach(ref=>{
      ref.tgt.addEventListener("change", calc);
    });

    selType.addEventListener("change", async ()=>{ await loadDataFor(selType.value); clearAll(); });
    btnReset.addEventListener("click", clearAll);

    (async function init(){ await loadDataFor(selType.value); })();
  });
  </script>
  <script>
    function sendHeightToParent() {
      const height = document.body.scrollHeight + 10;
      window.parent.postMessage({ type: "FRAME_CHANGE", height }, "*");
    }
    
    // 페이지 최초 로드 시
    window.addEventListener("load", () => {
      setTimeout(sendHeightToParent, 100); // 약간의 렌더링 대기
    });
    
    function loadPage(page) {
      const isMobile = window.innerWidth <= 768;
      const height = isMobile ? "550px" : "345px"
        window.location.href = page;
      window.parent.postMessage({ type: "SET_FRAME_SIZE", height: height, width: "100%"}, "*");
    }
  </script>
</body>
</html>
