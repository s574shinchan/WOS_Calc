<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì˜ì›… ì¥ë¹„ ê³„ì‚°ê¸°</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* ========== ë‹¤í¬ëª¨ë“œ ========== */
    body.dark-mode { background-color:#121212; color:#f0f0f0; }
    .dark-mode .border{ border-color:#444 !important; }
    .dark-mode .bg-white{ background-color:#2c2c2c !important; color:#f0f0f0 !important; }
    .dark-mode .bg-gray-100{ background-color:#1e1e1e !important; }
    .dark-mode .text-gray-800,.dark-mode .text-gray-700,.dark-mode .text-gray-600{ color:#dddddd !important; }
    .dark-mode select,.dark-mode input{ color:#000 !important; }
    .dark-mode table{ background:#2c2c2c; color:#f0f0f0; }
    .dark-mode th,.dark-mode td{ border-color:#444 !important; }

    /* ========== experts ì¹´ë“œ ìŠ¤íƒ€ì¼ ========== */
    .exp-card{
      border:1px solid rgba(0,0,0,.08);
      border-radius:16px;
      background:#fff;
      box-shadow:0 6px 18px rgba(15,23,42,.06);
      transition: box-shadow .2s ease;
    }
    .exp-card:hover{ box-shadow:0 10px 26px rgba(15,23,42,.12); }
    .muted{ font-size:12px; color:#6b7280; }

    body.dark-mode .exp-card{ background:#2c2c2c !important; border-color:#444 !important; }
    body.dark-mode .muted{ color:#b7b7b7 !important; }
    .tabular-nums{ font-variant-numeric: tabular-nums; }
  </style>

  <!-- ë‹¤í¬ëª¨ë“œ ìƒíƒœ ìœ ì§€ -->
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
      }
    });
  </script>
</head>
<body class="bg-gray-100 p-2 font-sans text-sm">
  <div class="max-w-[1500px] mx-auto bg-white p-3 rounded-xl shadow-md space-y-6">
    <h1 class="text-2xl font-bold text-gray-800">ğŸ§ è‹±é›„è£…å‚™</h1>

    <!-- ===================== ğŸ“• ë¯¸ìŠ¤ë¦´ ===================== -->
    <div class="exp-card">
      <div class="p-4">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-[16px] font-semibold text-yellow-700">ğŸ“• ãƒŸã‚¹ãƒªãƒ«</h2>
        </div>

        <form id="heroEquipForm" class="space-y-3">
          <div id="heroEquipGridBody" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>

          <!-- ë³´ìœ  ìì› -->
          <div class="exp-card">
            <div class="p-4">
              <div class="flex items-center justify-between mb-3">
                <h3 class="text-[15px] font-semibold text-gray-800">ä¿æœ‰è³‡æº (ãƒŸã‚¹ãƒªãƒ«)</h3>
              </div>
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <div>
                  <label class="block text-[15px] text-gray-600 mb-1">å¼·åŒ–çµŒé¨“å€¤ãƒ‘ãƒ¼ãƒ„ (100pt)ï¼ˆæ‰€æŒæ•°ï¼‰</label>
                  <input type="number" id="own-ë„ˆíŠ¸" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="0" min="0" inputmode="numeric"/>
                </div>
                <div>
                  <label class="block text-[15px] text-gray-600 mb-1">ãƒŸã‚¹ãƒªãƒ«ï¼ˆæ‰€æŒæ•°ï¼‰</label>
                  <input type="number" id="own-ë¯¸ìŠ¤ë¦´" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="0" min="0" inputmode="numeric"/>
                </div>
                <div>
                  <label class="block text-[15px] text-gray-600 mb-1">ä¼èª¬ãƒ’ãƒ¼ãƒ­ãƒ¼è£…å‚™ï¼ˆæ‰€æŒæ•°ï¼‰</label>
                  <input type="number" id="own-ë ˆì „ë“œì¥ë¹„" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="0" min="0" inputmode="numeric"/>
                </div>
              </div>
            </div>
          </div>

          <!-- ğŸ“• ë¯¸ìŠ¤ë¦´ ì´í•©ê³„ -->
          <div id="mithrilTotals" class="exp-card">
            <div class="p-4">
              <div class="font-semibold text-gray-800 mb-2">åˆè¨ˆ (ãƒŸã‚¹ãƒªãƒ«)</div>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <div class="rounded-xl border border-black/10 p-3">
                  <div class="font-semibold mb-2">å°è¨ˆ</div>
                  <div class="flex justify-between text-[13px]">
                    <span class="text-gray-600">çµŒé¨“å€¤</span><span id="tot-exp" class="tabular-nums">0</span>
                  </div>
                  <div class="flex justify-between text-[13px]">
                    <span class="text-gray-600">å¼·åŒ–çµŒé¨“å€¤ãƒ‘ãƒ¼ãƒ„ï¼ˆ100ptï¼‰</span><span id="tot-nut" class="tabular-nums">0</span>
                  </div>
                  <div class="flex justify-between text-[13px]">
                    <span class="text-gray-600">ãƒŸã‚¹ãƒªãƒ«</span><span id="tot-mith" class="tabular-nums">0</span>
                  </div>
                  <div class="flex justify-between text-[13px]">
                    <span class="text-gray-600">ä¼èª¬ãƒ’ãƒ¼ãƒ­ãƒ¼è£…å‚™</span><span id="tot-leg" class="tabular-nums">0</span>
                  </div>
                </div>
                <div class="rounded-xl border border-black/10 p-3">
                  <div class="font-semibold mb-2">æ‰€æŒæ•°</div>
                  <div class="flex justify-between text-[13px]"><span class="text-gray-600">å¼·åŒ–çµŒé¨“å€¤ãƒ‘ãƒ¼ãƒ„ï¼ˆ100ptï¼‰</span><span id="own-nut" class="tabular-nums">0</span></div>
                  <div class="flex justify-between text-[13px]"><span class="text-gray-600">ãƒŸã‚¹ãƒªãƒ«</span><span id="own-mith" class="tabular-nums">0</span></div>
                  <div class="flex justify-between text-[13px]"><span class="text-gray-600">ä¼èª¬ãƒ’ãƒ¼ãƒ­ãƒ¼è£…å‚™</span><span id="own-leg" class="tabular-nums">0</span></div>
                </div>
                <div class="rounded-xl border border-black/10 p-3">
                  <div class="font-semibold mb-2">éä¸è¶³</div>
                  <div class="flex justify-between text-[13px]"><span class="text-gray-600">çµŒé¨“å€¤</span><span id="def-exp" class="tabular-nums">0</span></div>
                  <div class="flex justify-between text-[13px]"><span class="text-gray-600">å¼·åŒ–çµŒé¨“å€¤ãƒ‘ãƒ¼ãƒ„ï¼ˆ100ptï¼‰</span><span id="def-nut" class="tabular-nums">0</span></div>
                  <div class="flex justify-between text-[13px]"><span class="text-gray-600">ãƒŸã‚¹ãƒªãƒ«</span><span id="def-mith" class="tabular-nums">0</span></div>
                  <div class="flex justify-between text-[13px]"><span class="text-gray-600">ä¼èª¬ãƒ’ãƒ¼ãƒ­ãƒ¼è£…å‚™</span><span id="def-leg" class="tabular-nums">0</span></div>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- ===================== ğŸ“™ ë§ˆìŠ¤í„°ë¦¬ ===================== -->
    <div class="exp-card">
      <div class="p-4">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-[16px] font-semibold text-yellow-700">ğŸ“™ ç²¾éŒ¬ã‚¨ãƒŠã‚¸ãƒ¼æºçŸ³</h2>
        </div>

        <form id="masteryForm" class="space-y-3">
          <div id="masteryGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>

          <!-- ë³´ìœ  ìì› -->
          <div class="exp-card">
            <div class="p-4">
              <div class="flex items-center justify-between mb-3">
                <h3 class="text-[15px] font-semibold text-gray-800">ä¿æœ‰è³‡æº (ç²¾éŒ¬ã‚¨ãƒŠã‚¸ãƒ¼æºçŸ³)</h3>
              </div>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label class="block text-[15px] text-gray-600 mb-1">ç²¾éŒ¬ã‚¨ãƒŠã‚¸ãƒ¼æºçŸ³ï¼ˆæ‰€æŒæ•°ï¼‰</label>
                  <input type="number" id="owned-ë§ˆìŠ¤í„°ë¦¬ì„" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="0" min="0" inputmode="numeric"/>
                </div>
                <div>
                  <label class="block text-[15px] text-gray-600 mb-1">ä¼èª¬ãƒ’ãƒ¼ãƒ­ãƒ¼è£…å‚™ï¼ˆæ‰€æŒæ•°ï¼‰</label>
                  <input type="number" id="owned-ë ˆì „ë“œì¥ë¹„" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="0" min="0" inputmode="numeric"/>
                </div>
              </div>
            </div>
          </div>

          <!-- ğŸ“™ ë§ˆìŠ¤í„°ë¦¬ ì´í•©ê³„ -->
          <div id="masteryTotals" class="exp-card">
            <div class="p-4">
              <div class="font-semibold text-gray-800 mb-2">ä¿æœ‰è³‡æº (ç²¾éŒ¬ã‚¨ãƒŠã‚¸ãƒ¼æºçŸ³)</div>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <div class="rounded-xl border border-black/10 p-3">
                  <div class="font-semibold mb-2">å°è¨ˆ</div>
                  <div class="flex justify-between text-[13px]">
                    <span class="text-gray-600">ç²¾éŒ¬ã‚¨ãƒŠã‚¸ãƒ¼æºçŸ³</span><span id="ms-tot-stone" class="tabular-nums">0</span>
                  </div>
                  <div class="flex justify-between text-[13px]">
                    <span class="text-gray-600">ä¼èª¬ãƒ’ãƒ¼ãƒ­ãƒ¼è£…å‚™</span><span id="ms-tot-leg" class="tabular-nums">0</span>
                  </div>
                </div>
                <div class="rounded-xl border border-black/10 p-3">
                  <div class="font-semibold mb-2">æ‰€æŒæ•°</div>
                  <div class="flex justify-between text-[13px]">
                    <span class="text-gray-600">ç²¾éŒ¬ã‚¨ãƒŠã‚¸ãƒ¼æºçŸ³</span><span id="ms-own-stone" class="tabular-nums">0</span>
                  </div>
                  <div class="flex justify-between text-[13px]">
                    <span class="text-gray-600">ä¼èª¬ãƒ’ãƒ¼ãƒ­ãƒ¼è£…å‚™</span><span id="ms-own-leg" class="tabular-nums">0</span>
                  </div>
                </div>
                <div class="rounded-xl border border-black/10 p-3">
                  <div class="font-semibold mb-2">éä¸è¶³</div>
                  <div class="flex justify-between text-[13px]">
                    <span class="text-gray-600">ç²¾éŒ¬ã‚¨ãƒŠã‚¸ãƒ¼æºçŸ³</span><span id="ms-def-stone" class="tabular-nums">0</span>
                  </div>
                  <div class="flex justify-between text-[13px]">
                    <span class="text-gray-600">ä¼èª¬ãƒ’ãƒ¼ãƒ­ãƒ¼è£…å‚™</span><span id="ms-def-leg" class="tabular-nums">0</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </form>
      </div>
    </div>
  </div>

  <!-- ========== ê³µí†µ ìœ í‹¸ & í”„ë ˆì„ í†µì‹  ========== -->
  <script>
    function sendHeightToParent() {
      const height = document.body.scrollHeight + 10;
      window.parent?.postMessage?.({ type: "FRAME_CHANGE", height }, "*");
    }
    window.addEventListener("load", () => setTimeout(sendHeightToParent, 100));
  </script>

  <!-- ========== ğŸ“• ë¯¸ìŠ¤ë¦´ ë¡œì§ ========== -->
  <script>
    const slotNames = ["ã‚´ãƒ¼ã‚°ãƒ«", "æ‰‹è¢‹", "ãƒ™ãƒ«ãƒˆ", "é´"];
    const mithrilCsvUrl = "https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Hero/Mithril.csv";

    let stageList = [];
    let csvData = [];

    async function loadMithrilCSV() {
      try{
        const res = await fetch(mithrilCsvUrl, {cache:"no-store"});
        const text = await res.text();
        const lines = text.trim().split("\n").map(l => l.split(","));
        const headers = lines[0];
        csvData = lines.slice(1).map(row => {
          const obj = {};
          headers.forEach((h, i) => obj[h.trim()] = (row[i] ?? "").trim() || "0");
          return obj;
        });
        stageList = csvData.map(r => r["ë ˆë²¨"]);
      }catch(e){
        // ê°„ë‹¨í•œ í´ë°± (ë ˆë²¨ 1~5)
        csvData = [
          {ë ˆë²¨:"1", ê²½í—˜ì¹˜:"0", ë„ˆíŠ¸:"0", ë¯¸ìŠ¤ë¦´:"0", ë ˆì „ë“œì¥ë¹„:"0"},
          {ë ˆë²¨:"2", ê²½í—˜ì¹˜:"100", ë„ˆíŠ¸:"5", ë¯¸ìŠ¤ë¦´:"8", ë ˆì „ë“œì¥ë¹„:"0"},
          {ë ˆë²¨:"3", ê²½í—˜ì¹˜:"220", ë„ˆíŠ¸:"12", ë¯¸ìŠ¤ë¦´:"18", ë ˆì „ë“œì¥ë¹„:"0"},
          {ë ˆë²¨:"4", ê²½í—˜ì¹˜:"360", ë„ˆíŠ¸:"20", ë¯¸ìŠ¤ë¦´:"30", ë ˆì „ë“œì¥ë¹„:"1"},
          {ë ˆë²¨:"5", ê²½í—˜ì¹˜:"520", ë„ˆíŠ¸:"30", ë¯¸ìŠ¤ë¦´:"45", ë ˆì „ë“œì¥ë¹„:"1"},
        ];
        stageList = csvData.map(r=>r["ë ˆë²¨"]);
      }
      renderHeroEquipUI();
      sendHeightToParent();
    }

    function renderHeroEquipUI() {
      const grid = document.getElementById("heroEquipGridBody");
      grid.innerHTML = "";

      slotNames.forEach((name, i) => {
        const options = stageList.map(stage => `<option value="${stage}">${stage}</option>`).join("");
        const card = document.createElement("div");
        card.className = "exp-card";
        card.innerHTML = `
          <div class="p-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <div class="flex items-center gap-2 mb-2">
                  <input type="checkbox" id="check-${i}" class="h-4 w-4 accent-purple-500" />
                  <h3 class="text-[15px] font-semibold text-gray-800">${name}</h3>
                </div>
                <!-- í˜„ì¬/ëª©í‘œ ì„¸ë¡œ ë°°ì¹˜ -->
                <div class="grid grid-cols-1 gap-2">
                  <div class="flex items-center justify-between gap-2">
                    <span class="text-gray-600">ç¾åœ¨</span>
                    <select id="start-${i}" class="border rounded-lg px-2 py-1 text-sm min-w-[120px]">${options}</select>
                  </div>
                  <div class="flex items-center justify-between gap-2">
                    <span class="text-gray-600">ç›®æ¨™</span>
                    <select id="end-${i}" class="border rounded-lg px-2 py-1 text-sm min-w-[120px]">${options}</select>
                  </div>
                </div>
              </div>
              <div class="md:pl-4">
                <div class="font-semibold text-gray-800 mb-2">å°è¨ˆ</div>
                <div class="grid grid-cols-[1fr_auto] gap-x-3 text-[13px]">
                  <div class="text-gray-600">çµŒé¨“å€¤</div><div class="text-right tabular-nums" id="m-sub-exp-${i}">0</div>
                  <div class="text-gray-600">å¼·åŒ–çµŒé¨“å€¤ãƒ‘ãƒ¼ãƒ„ï¼ˆ100ptï¼‰</div><div class="text-right tabular-nums" id="m-sub-nut-${i}">0</div>
                  <div class="text-gray-600">ãƒŸã‚¹ãƒªãƒ«</div><div class="text-right tabular-nums" id="m-sub-mith-${i}">0</div>
                  <div class="text-gray-600">ä¼èª¬ãƒ’ãƒ¼ãƒ­ãƒ¼è£…å‚™</div><div class="text-right tabular-nums" id="m-sub-legend-${i}">0</div>
                </div>
              </div>
            </div>
          </div>
        `;
        grid.appendChild(card);

        const curSelect = card.querySelector(`#start-${i}`);
        const tgtSelect = card.querySelector(`#end-${i}`);
        const chk       = card.querySelector(`#check-${i}`);

        const onChange = () => { updateMithrilSubtotals(i); updateMithrilTotals(); };
        curSelect.addEventListener("change", () => { tgtSelect.value = curSelect.value; onChange(); });
        tgtSelect.addEventListener("change", onChange);
        chk.addEventListener("change", onChange);

        // ì´ˆê¸° 1íšŒ ê³„ì‚°
        updateMithrilSubtotals(i);
      });

      // ë³´ìœ  ì…ë ¥ ë³€í™” ì‹œ ì´í•©ê³„ ê°±ì‹ 
      ["own-ë„ˆíŠ¸","own-ë¯¸ìŠ¤ë¦´","own-ë ˆì „ë“œì¥ë¹„"].forEach(id=>{
        document.getElementById(id)?.addEventListener("input", updateMithrilTotals);
      });

      updateMithrilTotals();
    }

    function updateMithrilSubtotals(i) {
      const cur = document.getElementById(`start-${i}`).value;
      const tgt = document.getElementById(`end-${i}`).value;
      const sIdx = stageList.indexOf(cur);
      const eIdx = stageList.indexOf(tgt);

      const sums = { exp:0, nut:0, mith:0, legend:0 };
      if (sIdx >= 0 && eIdx > sIdx) {
        for (let j = sIdx + 1; j <= eIdx; j++) {
          const r = csvData[j];
          sums.exp    += parseFloat(r["ê²½í—˜ì¹˜"] || "0");
          sums.nut    += parseFloat(r["ë„ˆíŠ¸"] || "0");
          sums.mith   += parseFloat(r["ë¯¸ìŠ¤ë¦´"] || "0");
          sums.legend += parseFloat(r["ë ˆì „ë“œì¥ë¹„"] || "0");
        }
      }
      document.getElementById(`m-sub-exp-${i}`).textContent    = sums.exp.toLocaleString();
      document.getElementById(`m-sub-nut-${i}`).textContent    = sums.nut.toLocaleString();
      document.getElementById(`m-sub-mith-${i}`).textContent   = sums.mith.toLocaleString();
      document.getElementById(`m-sub-legend-${i}`).textContent = sums.legend.toLocaleString();
    }

    function updateMithrilTotals(){
      let total = { exp:0, nut:0, mith:0, leg:0 };
      slotNames.forEach((_, i)=>{
        const checked = document.getElementById(`check-${i}`)?.checked;
        if(!checked) return;

        const cur = document.getElementById(`start-${i}`).value;
        const tgt = document.getElementById(`end-${i}`).value;
        const sIdx = stageList.indexOf(cur);
        const eIdx = stageList.indexOf(tgt);
        if (sIdx < 0 || eIdx <= sIdx) return;

        for(let j=sIdx+1;j<=eIdx;j++){
          const r = csvData[j];
          total.exp += +(r["ê²½í—˜ì¹˜"]||0);
          total.nut += +(r["ë„ˆíŠ¸"]||0);
          total.mith+= +(r["ë¯¸ìŠ¤ë¦´"]||0);
          total.leg += +(r["ë ˆì „ë“œì¥ë¹„"]||0);
        }
      });

      const own = {
        nut: +(document.getElementById("own-ë„ˆíŠ¸")?.value || 0),
        mith:+(document.getElementById("own-ë¯¸ìŠ¤ë¦´")?.value || 0),
        leg: +(document.getElementById("own-ë ˆì „ë“œì¥ë¹„")?.value || 0),
      };

      // í‘œê¸°
      document.getElementById("tot-exp").textContent  = total.exp.toLocaleString();
      document.getElementById("tot-nut").textContent  = total.nut.toLocaleString();
      document.getElementById("tot-mith").textContent = total.mith.toLocaleString();
      document.getElementById("tot-leg").textContent  = total.leg.toLocaleString();

      document.getElementById("own-nut").textContent  = own.nut.toLocaleString();
      document.getElementById("own-mith").textContent = own.mith.toLocaleString();
      document.getElementById("own-leg").textContent  = own.leg.toLocaleString();

      document.getElementById("def-exp").textContent  = total.exp.toLocaleString(); // ê²½í—˜ì¹˜ëŠ” ë³´ìœ ì¹˜ ê°œë… ì—†ìŒ
      document.getElementById("def-nut").textContent  = (own.nut-total.nut).toLocaleString();
      document.getElementById("def-mith").textContent = (own.mith-total.mith).toLocaleString();
      document.getElementById("def-leg").textContent  = (own.leg-total.leg).toLocaleString();
    }

    // ìµœì´ˆ ë¡œë”©
    loadMithrilCSV();
  </script>

  <!-- ========== ğŸ“™ ë§ˆìŠ¤í„°ë¦¬ ë¡œì§ ========== -->
  <script>
    const masteryUrl = "https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Hero/Mastery.csv";
    const masterySlots = ["ã‚´ãƒ¼ã‚°ãƒ«", "æ‰‹è¢‹", "ãƒ™ãƒ«ãƒˆ", "é´"];
    let masteryLevels = [];
    let masteryData = [];

    async function loadMasteryCSV() {
      try{
        const res = await fetch(masteryUrl, {cache:"no-store"});
        const text = await res.text();
        const lines = text.trim().split("\n").map(row => row.split(","));
        const headers = lines[0];
        masteryData = lines.slice(1).map(row => {
          const obj = {};
          headers.forEach((h, i) => obj[h.trim()] = (row[i] ?? "").trim() || "0");
          return obj;
        });
        masteryLevels = masteryData.map(r => r["ë ˆë²¨"]);
      }catch(e){
        // ê°„ë‹¨í•œ í´ë°± (ë ˆë²¨ 1~5)
        masteryData = [
          {ë ˆë²¨:"1", ë§ˆìŠ¤í„°ë¦¬ì„:"0", ë ˆì „ë“œì¥ë¹„:"0"},
          {ë ˆë²¨:"2", ë§ˆìŠ¤í„°ë¦¬ì„:"10", ë ˆì „ë“œì¥ë¹„:"0"},
          {ë ˆë²¨:"3", ë§ˆìŠ¤í„°ë¦¬ì„:"22", ë ˆì „ë“œì¥ë¹„:"0"},
          {ë ˆë²¨:"4", ë§ˆìŠ¤í„°ë¦¬ì„:"36", ë ˆì „ë“œì¥ë¹„:"1"},
          {ë ˆë²¨:"5", ë§ˆìŠ¤í„°ë¦¬ì„:"52", ë ˆì „ë“œì¥ë¹„:"1"},
        ];
        masteryLevels = masteryData.map(r=>r["ë ˆë²¨"]);
      }
      renderMasteryUI();
      sendHeightToParent();
    }

    function renderMasteryUI() {
      const grid = document.getElementById("masteryGrid");
      grid.innerHTML = "";

      masterySlots.forEach((name, i) => {
        const options = masteryLevels.map(lv => `<option value="${lv}">${lv}</option>`).join("");
        const card = document.createElement("div");
        card.className = "exp-card";
        card.innerHTML = `
          <div class="p-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <div class="flex items-center gap-2 mb-2">
                  <input type="checkbox" id="m-check-${i}" class="h-4 w-4 accent-yellow-500" />
                  <h3 class="text-[15px] font-semibold text-gray-800">${name}</h3>
                </div>
                <div class="grid grid-cols-1 gap-2">
                  <div class="flex items-center justify-between gap-2">
                    <span class="text-[12px] text-gray-600">ç¾åœ¨</span>
                    <select id="m-start-${i}" class="border rounded-lg px-2 py-1 text-sm min-w-[120px]">${options}</select>
                  </div>
                  <div class="flex items-center justify-between gap-2">
                    <span class="text-[12px] text-gray-600">ç›®æ¨™</span>
                    <select id="m-end-${i}" class="border rounded-lg px-2 py-1 text-sm min-w-[120px]">${options}</select>
                  </div>
                </div>
              </div>
              <div class="md:pl-4">
                <div class="font-semibold text-gray-800 mb-2">å°è¨ˆ</div>
                <div class="grid grid-cols-[1fr_auto] gap-x-3 text-[13px]">
                  <div class="text-gray-600">ç²¾éŒ¬ã‚¨ãƒŠã‚¸ãƒ¼æºçŸ³</div><div class="text-right tabular-nums" id="ms-sub-stone-${i}">0</div>
                  <div class="text-gray-600">ä¼èª¬ãƒ’ãƒ¼ãƒ­ãƒ¼è£…å‚™</div><div class="text-right tabular-nums" id="ms-sub-legend-${i}">0</div>
                </div>
              </div>
            </div>
          </div>`;
        grid.appendChild(card);

        const curSelect = card.querySelector(`#m-start-${i}`);
        const tgtSelect = card.querySelector(`#m-end-${i}`);
        const chk       = card.querySelector(`#m-check-${i}`);

        const onChange = () => { updateMasterySubtotals(i); updateMasteryTotals(); };
        curSelect.addEventListener("change", () => { tgtSelect.value = curSelect.value; onChange(); });
        tgtSelect.addEventListener("change", onChange);
        chk.addEventListener("change", onChange);

        updateMasterySubtotals(i);
      });

      ["owned-ë§ˆìŠ¤í„°ë¦¬ì„","owned-ë ˆì „ë“œì¥ë¹„"].forEach(id=>{
        document.getElementById(id)?.addEventListener("input", updateMasteryTotals);
      });

      updateMasteryTotals();
    }

    function updateMasterySubtotals(i) {
      const cur = document.getElementById(`m-start-${i}`).value;
      const tgt = document.getElementById(`m-end-${i}`).value;
      const sIdx = masteryLevels.indexOf(cur);
      const eIdx = masteryLevels.indexOf(tgt);

      const sums = { stone:0, legend:0 };
      if (sIdx >= 0 && eIdx > sIdx) {
        for (let j = sIdx + 1; j <= eIdx; j++) {
          const r = masteryData[j];
          sums.stone  += parseFloat(r["ë§ˆìŠ¤í„°ë¦¬ì„"] || "0");
          sums.legend += parseFloat(r["ë ˆì „ë“œì¥ë¹„"] || "0");
        }
      }
      document.getElementById(`ms-sub-stone-${i}`).textContent  = sums.stone.toLocaleString();
      document.getElementById(`ms-sub-legend-${i}`).textContent = sums.legend.toLocaleString();
    }

    function updateMasteryTotals(){
      let total = { stone:0, leg:0 };
      masterySlots.forEach((_, i)=>{
        const checked = document.getElementById(`m-check-${i}`)?.checked;
        if(!checked) return;

        const cur = document.getElementById(`m-start-${i}`).value;
        const tgt = document.getElementById(`m-end-${i}`).value;
        const sIdx = masteryLevels.indexOf(cur);
        const eIdx = masteryLevels.indexOf(tgt);
        if (sIdx < 0 || eIdx <= sIdx) return;

        for(let j=sIdx+1;j<=eIdx;j++){
          const r = masteryData[j];
          total.stone += +(r["ë§ˆìŠ¤í„°ë¦¬ì„"]||0);
          total.leg   += +(r["ë ˆì „ë“œì¥ë¹„"]||0);
        }
      });

      const own = {
        stone: +(document.getElementById("owned-ë§ˆìŠ¤í„°ë¦¬ì„")?.value || 0),
        leg:   +(document.getElementById("owned-ë ˆì „ë“œì¥ë¹„")?.value || 0),
      };

      document.getElementById("ms-tot-stone").textContent = total.stone.toLocaleString();
      document.getElementById("ms-tot-leg").textContent   = total.leg.toLocaleString();
      document.getElementById("ms-own-stone").textContent = own.stone.toLocaleString();
      document.getElementById("ms-own-leg").textContent   = own.leg.toLocaleString();
      document.getElementById("ms-def-stone").textContent = (own.stone-total.stone).toLocaleString();
      document.getElementById("ms-def-leg").textContent   = (own.leg-total.leg).toLocaleString();
    }

    // ìµœì´ˆ ë¡œë”©
    loadMasteryCSV();
  </script>
  <script>
    // F12, Ctrl+Shift+I, Ctrl+U ë“± ë°©ì§€
    document.onkeydown = function (e) {
      if (
        e.keyCode === 123 || // F12
        (e.ctrlKey && e.shiftKey && e.keyCode === 73) || // Ctrl+Shift+I
        (e.ctrlKey && e.shiftKey && e.keyCode === 74) || // Ctrl+Shift+J
        (e.ctrlKey && e.keyCode === 85) // Ctrl+U
      ) {
        e.preventDefault();
        return false;
      }
    };
  
    // ìš°í´ë¦­ ë°©ì§€
    document.addEventListener("contextmenu", (e) => e.preventDefault());
  </script>
  <script>
    setInterval(() => {
      const start = performance.now();
      debugger; // ê°œë°œìë„êµ¬ê°€ ì—´ë¦¬ë©´ ë¸Œë¼ìš°ì €ê°€ ì¼ì‹œì •ì§€ë¨
      const end = performance.now();
      if (end - start > 100) {
        alert("ê°œë°œì ë„êµ¬ ì ‘ê·¼ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.");
        location.reload();
      }
    }, 1000);
  </script>  
</body>
</html>
