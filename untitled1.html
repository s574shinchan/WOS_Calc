<meta charset="UTF-8" />

<div class="max-w-[1500px] mx-auto bg-white rounded shadow p-2 flex flex-col sm:flex-row gap-2">
  <div class="flex-1 bg-white rounded p-2 space-y-4 shadow">
    <div class="bg-gray-100 p-2 font-sans text-sm">
      <div class="bg-white p-4 rounded-xl shadow-md space-y-4">
        <!-- 헤더 -->
        <div class="flex items-center justify-between gap-3 mb-4">
          <div>
            <h1 class="text-xl md:text-2xl font-extrabold">세대별 영웅 정보</h1>
            <p class="text-sm">영웅 클릭 → 이미지 스타일 상세 카드</p>
          </div>
        </div>

        <div class="flex items-center gap-2 mb-4">
          <span class="text-sm">세대 선택</span>
          <select id="genSelect"
                  class="px-3 py-2 w-24 rounded-xl text-sm border shadow-sm bg-white focus:outline-none focus:ring-2 focus:ring-blue-400">
          </select>

          <div id="typeWrap" class="flex items-center gap-2">
            <span class="text-sm">병종 선택</span>
            <select id="selType"
                    class="px-3 py-2 w-24 rounded-xl text-sm border shadow-sm bg-white focus:outline-none focus:ring-2 focus:ring-blue-400">
              <option value="ALL">전체</option>
              <option value="INFANTRY">방패병</option>
              <option value="LANCER">창병</option>
              <option value="MARKSMAN">궁병</option>
            </select>
          </div>

          <div class="flex items-center gap-2 flex-1 min-w-[220px]">
            <span class="text-sm whitespace-nowrap">이름 검색</span>
            <div class="relative flex-1">
              <input id="heroSearch"
                     type="text"
                     class="w-[300px] px-3 py-2 rounded-xl text-sm border shadow-sm bg-white focus:outline-none focus:ring-2 focus:ring-blue-400" />
              <button id="heroSearchClear"
                      type="button"
                      class="px-3 py-2 rounded-xl text-sm border shadow-sm bg-white">
                지우기
              </button>
            </div>
          </div>
        </div>

        <!-- ✅ 비교 기능 바 (추가) -->
        <div class="flex items-center gap-3 mb-3">
          <label class="inline-flex items-center gap-2 text-sm">
            <input id="heroCompareMode" type="checkbox" class="w-4 h-4" />
            영웅 비교
          </label>

          <button id="compareBtn"
                  type="button"
                  class="px-3 py-2 rounded-xl text-sm border shadow-sm bg-white disabled:opacity-40 disabled:cursor-not-allowed"
                  disabled>
            비교하기
          </button>

          <div id="compareHint" class="text-xs text-gray-600 hidden">
            2명을 선택한 뒤 비교하기를 누르세요. (최대 2명)
          </div>
        </div>

        <!-- 영웅 카드 그리드 -->
        <div id="heroGrid" class="grid grid-cols-1 gap-3"></div>
      </div>

      <!-- ====== 상세 모달 ====== -->
      <div id="modalBackdrop" class="fixed inset-0 z-[2000] hidden">
        <div class="absolute inset-0 bg-black/60"></div>

        <div class="absolute inset-0 overflow-auto p-3 md:p-3">
          <div class="max-w-5xl mx-auto">
            <div class="rounded-2xl overflow-hidden shadow-2xl border bg-white">
              <div id="modalHeroHeader"
                   class="relative px-4 py-2 md:px-5 md:py-3 text-white"
                   style="background: linear-gradient(135deg,#0ea5e9,#2563eb);">
                <div class="flex items-start justify-between gap-3">
                  <div class="min-w-0">
                    <div class="flex items-center gap-2 text-sm md:text-xs opacity-90">
                      <span id="hdrClass" class="inline-flex items-center gap-1">
                        <span class="w-4 h-4 rounded bg-white/20 inline-flex items-center justify-center">
                          <img id="hdrClassIcon"
                               src=""
                               class="w-3.5 h-3.5 object-contain"
                               onerror="this.style.display='none'"
                               alt="ClassIcon"/>
                        </span>
                        <span>HERO CLASS: -</span>
                      </span>
                      <span class="opacity-60">•</span>
                      <span id="hdrType" class="inline-flex items-center gap-1">
                        <span class="w-4 h-4 rounded bg-white/20 inline-flex items-center justify-center">
                          <img id="expeditionIcon"
                               src=""
                               class="w-3.5 h-3.5 object-contain"
                               onerror="this.style.display='none'"
                               alt="Skills"/>
                        </span>
                        <span>EXPEDITION TYPE: -</span>
                      </span>
                    </div>

                    <div class="mt-2">
                      <div id="hdrName" class="text-3xl md:text-4xl font-black title-grit uppercase">
                        HERO
                      </div>
                      <div id="hdrGen" class="mt-1 text-xs opacity-90">Gen -</div>
                    </div>
                  </div>

                  <div class="flex items-center gap-2">
                    <button id="closeModal"
                            class="px-3 py-2 rounded-xl bg-white/15 hover:bg-white/25 border border-white/20 text-sm">
                      닫기
                    </button>
                  </div>
                </div>
              </div>

              <div class="relative p-4 md:p-3">
                <div class="grid grid-cols-12 gap-3">

                  <div class="lg:col-span-4">
                    <div class="rounded-2xl border p-3 md:p-4 h-full">
                      <h3 class="text-base md:text-lg font-extrabold">탐험 스킬</h3>
                      <div id="exploreSkills" class="mt-3 space-y-3"></div>
                    </div>
                  </div>

                  <div class="lg:col-span-4">
                    <div class="rounded-2xl border p-3 md:p-4 h-full flex flex-col">
                      <div class="flex items-center justify-between">
                        <div id="sourceText" class="text-[11px] text-gray-500"></div>
                      </div>

                      <div class="mt-3 flex-1 flex items-center justify-center">
                        <div class="w-full max-w-[300px] aspect-[3/4] overflow-hidden flex items-center justify-center">
                          <img id="heroImg"
                               src="/images/hero/thumb/Gen1/jeronimo.webp"
                               alt="hero"
                               class="w-full h-full object-contain"
                               loading="lazy"
                               onerror="this.onerror=null; this.style.display='none'; document.getElementById('heroImgFallback').classList.remove('hidden');" />
                          <div id="heroImgFallback" class="hidden text-sm text-gray-500 p-4 text-center">
                            hero image not found<br/>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="lg:col-span-4">
                    <div class="rounded-2xl border p-3 md:p-4 h-full">
                      <h3 class="text-base md:text-lg font-extrabold">원정 스킬</h3>
                      <div id="expeditionSkills" class="mt-3 space-y-3"></div>
                    </div>
                  </div>

                  <div id="traitCard" class="col-span-6 rounded-2xl border p-3 md:p-4">
                    <div class="font-extrabold text-base whitespace-nowrap">특성버프</div>
                    <div id="traitBuffArea" class="mt-3 space-y-3"></div>
                  </div>

                  <div id="weapon" class="col-span-6 rounded-2xl border bg-white p-3 md:p-4">
                    <div class="font-extrabold text-base whitespace-nowrap">전용무기</div>
                    <div id="weaponSkills" class="mt-3 space-y-3"></div>
                  </div>

                  <div class="col-span-12">
                    <div class="grid grid-cols-2 gap-3">
                      <div class="rounded-2xl border bg-white p-3 md:p-4">
                        <div class="flex flex-col grid grid-cols-2">
                          <div class="font-extrabold">전용무기속성</div> 
                          <div class="text-[11px] text-right text-gray-500">+10강 기준/해당 병종에 적용</div> 
                        </div>
                        <div id="statExplore" class="mt-2 grid grid-cols-2 gap-2 text-sm"></div>
                      </div>
                      <div class="rounded-2xl border bg-white p-3 md:p-4">
                        <div class="font-extrabold">영웅 속성 (원정)</div>
                        <div id="statExpedition" class="mt-2 grid grid-cols-2 gap-2 text-sm"></div>
                      </div>
                    </div>
                  </div>

                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ====== ✅ 비교 모달 (추가) ====== -->
      <div id="compareBackdrop" class="fixed inset-0 z-[2100] hidden">
        <div class="absolute inset-0 bg-black/60"></div>

        <div class="absolute inset-0 overflow-auto p-3 md:p-3">
          <div class="max-w-6xl mx-auto">
            <div class="rounded-2xl overflow-hidden shadow-2xl border bg-white">
              <div class="relative px-4 py-2 md:px-5 md:py-3 text-white"
                   style="background: linear-gradient(135deg,#9333ea,#2563eb);">
                <div class="flex items-center justify-between gap-3">
                  <div class="font-extrabold text-lg">영웅 비교</div>
                  <button id="closeCompare"
                          class="px-3 py-2 rounded-xl bg-white/15 hover:bg-white/25 border border-white/20 text-sm">
                    닫기
                  </button>
                </div>
              </div>

              <div class="p-4 md:p-4">
                <div id="compareWrap" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ====== ✅ 2명 제한 팝업 (추가) ====== -->
      <div id="limitBackdrop" class="fixed inset-0 z-[2200] hidden">
        <div class="absolute inset-0 bg-black/60"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
          <div class="w-full max-w-md rounded-2xl overflow-hidden shadow-2xl border bg-white">
            <div class="px-4 py-3 text-white font-extrabold"
                 style="background: linear-gradient(135deg,#ef4444,#f97316);">
              선택 제한
            </div>
            <div class="p-4">
              <div class="text-sm text-gray-800">
                <div class="font-bold mb-2">이미 2명이 선택되어 있습니다.</div>
                <div class="text-gray-700">선택된 영웅:</div>
                <div id="limitNames" class="mt-2 text-sm font-extrabold"></div>
                <div class="mt-3 text-gray-700">비교는 2명만 가능합니다.</div>
              </div>
              <div class="mt-4 flex justify-end">
                <button id="closeLimit"
                        class="px-4 py-2 rounded-xl border shadow-sm bg-white hover:bg-gray-50 text-sm">
                  확인
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
(function(){
  // SPA 재진입/재로드 시 이벤트 중복 바인딩 방지
  if (window.__HEROINFO_INIT_BOUND__) {
    window.HeroInfoInit?.();
    return;
  }
  window.__HEROINFO_INIT_BOUND__ = true;

  window.HeroInfoInit = function HeroInfoInit(){  
    // =========================
    // 데이터 (샘플)
    // =========================
    var HEROES = [];

    async function loadHeroes(){
      try{
        var url = new URL("data/heroes.json", window.location.href).toString();
        var res = await fetch(url, { cache: "no-store" });

        if(!res.ok){
          throw new Error(`heroes.json 로드 실패: ${res.status} ${res.statusText} / ${url}`);
        }

        HEROES = await res.json();

        // 렌더 순서 고정
        initTypeSelect();
        initSearch();
        renderGenTabs();

        // ✅ 비교 기능 초기화 (추가)
        initCompareUI();

        renderHeroGrid();

      }catch(err){
        console.error(err);

        var wrap = document.getElementById("heroGrid");
        if(wrap){
          wrap.className = "p-4 rounded-xl border bg-red-50 text-red-700 text-sm";
          wrap.innerHTML = `
            <div class="font-extrabold mb-1">영웅 데이터 로드 실패</div>
            <div>${String(err.message)}</div>
            <div class="mt-2 text-xs text-gray-600">
              heroes.json 파일이 이 페이지와 같은 폴더에 있는지 / 서버에서 열고 있는지(파일:// 아님) 확인
            </div>
          `;
        }
      }
    }

    loadHeroes();

    // =========================
    // 상태
    // =========================
    var currentGen = "ALL";
    var currentHero = null;
    var currentType = "ALL";
    var currentSearch = "";

    // =========================
    // ✅ 비교 상태 (추가)
    // =========================
    var compareMode = false;
    var compareSelectedKeys = []; // hero.key 2개

    // =========================
    // 유틸
    // =========================
    var $ = (id) => document.getElementById(id);
    var escapeHtml = (s) => (s ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    var fmt = (v) => typeof v === "number" ? v.toLocaleString("ko-KR") : String(v);

    // =========================
    // ✅ 비교 UI/로직 (추가)
    // - 최대 2명만 선택
    // - 3번째 선택 시 팝업으로 현재 선택된 영웅 이름 안내
    // - a/b 선택 후 a 재선택 시 b가 풀리는 현상 방지 (기존 선택 유지 + 클릭한 것만 토글)
    // =========================
    function initCompareUI(){
      var mode = $("heroCompareMode");
      var hint = $("compareHint");
      var btn  = $("compareBtn");

      if(!mode || !btn) return;

      mode.checked = false;
      compareMode = false;
      compareSelectedKeys = [];
      btn.disabled = true;
      if(hint) hint.classList.add("hidden");

      mode.onchange = () => {
        compareMode = !!mode.checked;
        compareSelectedKeys = [];
        btn.disabled = true;
        if(hint){
          if(compareMode) hint.classList.remove("hidden");
          else hint.classList.add("hidden");
        }
        renderHeroGrid();
      };

      btn.onclick = () => {
        if(compareSelectedKeys.length !== 2) return;
        openCompareModal(compareSelectedKeys[0], compareSelectedKeys[1]);
      };

      // 제한 팝업 닫기
      var closeLimit = $("closeLimit");
      if(closeLimit){
        closeLimit.onclick = () => {
          $("limitBackdrop").classList.add("hidden");
        };
      }

      // 비교 모달 닫기
      var closeCompare = $("closeCompare");
      if(closeCompare){
        closeCompare.onclick = closeCompareModal;
      }

      var compareBackdrop = $("compareBackdrop");
      if(compareBackdrop){
        compareBackdrop.addEventListener("click", (e)=>{
          if(e.target === compareBackdrop) closeCompareModal();
        });
      }

      var limitBackdrop = $("limitBackdrop");
      if(limitBackdrop){
        limitBackdrop.addEventListener("click", (e)=>{
          if(e.target === limitBackdrop) limitBackdrop.classList.add("hidden");
        });
      }

      window.addEventListener("keydown", (e)=>{
        if(e.key === "Escape"){
          if(!$("limitBackdrop").classList.contains("hidden")) $("limitBackdrop").classList.add("hidden");
          else if(!$("compareBackdrop").classList.contains("hidden")) closeCompareModal();
        }
      });
    }

    function updateCompareButton(){
      var btn = $("compareBtn");
      if(!btn) return;
      btn.disabled = compareSelectedKeys.length !== 2;
    }

    function heroByKey(key){
      return HEROES.find(h => h.key === key) || null;
    }

    function showLimitPopup(){
      var a = heroByKey(compareSelectedKeys[0]);
      var b = heroByKey(compareSelectedKeys[1]);
      var names = [
        a ? (a.nameKo || a.name || a.key) : compareSelectedKeys[0],
        b ? (b.nameKo || b.name || b.key) : compareSelectedKeys[1],
      ];

      var el = $("limitNames");
      if(el) el.textContent = names.join(" , ");

      $("limitBackdrop").classList.remove("hidden");
    }

    function toggleCompare(hero){
      var key = hero.key;
      var i = compareSelectedKeys.indexOf(key);

      // 이미 선택된 경우: 해당 것만 해제
      if(i >= 0){
        compareSelectedKeys.splice(i, 1);
        updateCompareButton();
        renderHeroGrid();
        return;
      }

      // 새로 선택: 최대 2명
      if(compareSelectedKeys.length >= 2){
        showLimitPopup();
        return;
      }

      compareSelectedKeys.push(key);
      updateCompareButton();
      renderHeroGrid();
    }

    function openCompareModal(k1, k2){
      var a = heroByKey(k1);
      var b = heroByKey(k2);
      if(!a || !b) return;

      var wrap = $("compareWrap");
      if(!wrap) return;

      wrap.innerHTML = `
        ${renderCompareCard(a)}
        ${renderCompareCard(b)}
      `;

      $("compareBackdrop").classList.remove("hidden");
      document.body.style.overflow = "hidden";
    }

    function closeCompareModal(){
      $("compareBackdrop").classList.add("hidden");
      document.body.style.overflow = "";
    }

    // 비교 카드 (필수항목: 이름, 세대, 병종, 이미지, 원정스킬 3개, 전용무기 2번째(ws2))
    function renderCompareCard(hero){
      var img = renderPortrait(hero) || renderHeroThumb(hero) || "";

      // 원정스킬 3개
      var expSkills = Array.isArray(hero.expeditionSkills) ? hero.expeditionSkills.slice(0,3) : [];

      // 전용무기 2번째 항목 (ws2)
      var ws2 = null;
      if(Array.isArray(hero.weaponSkills)){
        ws2 = hero.weaponSkills.find(s => String(s?.key || "").toLowerCase() === "ws2") || null;
      }

      var classIcon = CLASS_ICON_MAP[hero.heroClass] || "";
      var classText = hero.heroClass || "-";
      var genText = hero.gen ?? "-";
      var nameText = hero.nameKo || hero.name || "-";

      return `
        <div class="rounded-2xl border shadow-sm overflow-hidden">
          <div class="px-4 py-3 text-white"
               style="background: linear-gradient(135deg,#111827,#374151);">
            <div class="flex items-center gap-3">
              <div class="w-14 h-14 rounded-xl bg-white/10 border border-white/10 overflow-hidden flex items-center justify-center shrink-0">
                <img src="${escapeHtml(img)}" class="w-full h-full object-contain" loading="lazy" />
              </div>

              <div class="min-w-0 flex-1">
                <div class="flex items-center gap-2">
                  <div class="text-xl font-extrabold truncate">${escapeHtml(nameText)}</div>
                  ${classIcon ? `
                    <img src="${escapeHtml(classIcon)}"
                         class="w-5 h-5 object-contain opacity-90"
                         alt="${escapeHtml(classText)}"
                         loading="lazy" />
                  ` : ``}
                </div>
                <div class="mt-0.5 text-xs opacity-90">Gen ${escapeHtml(genText)} • ${escapeHtml(classText)}</div>
              </div>
            </div>
          </div>

          <div class="p-4 grid gap-3">
            <div class="rounded-xl border p-3">
              <div class="flex items-center justify-between mb-2">
                <div class="font-extrabold text-sm">원정 스킬 (3)</div>
              </div>

              <div class="grid gap-2">
                ${expSkills.map(sk => compareSkillRow(hero, sk)).join("") || `
                  <div class="text-xs text-gray-500">원정 스킬 데이터 없음</div>
                `}
              </div>
            </div>

            <div class="rounded-xl border p-3">
              <div class="flex items-center justify-between mb-2">
                <div class="font-extrabold text-sm">전용무기 (2번째)</div>
                <div class="text-[11px] text-gray-500">ws2</div>
              </div>

              ${ws2 ? `
                <div class="flex gap-3">
                  <div class="w-12 h-12 rounded-xl border overflow-hidden flex items-center justify-center shrink-0">
                    <img src="${escapeHtml(heroSkillIcon(hero, ws2.key))}"
                         class="w-full h-full object-contain"
                         loading="lazy" />
                  </div>
                  <div class="min-w-0 flex-1">
                    <div class="font-bold text-sm mb-1">${escapeHtml(ws2.title || "")}</div>
                    <div class="text-xs leading-relaxed text-gray-700">${escapeHtml(ws2.desc || "")}</div>
                  </div>
                </div>
              ` : `
                <div class="text-xs text-gray-500">ws2 데이터 없음</div>
              `}
            </div>
          </div>
        </div>
      `;
    }

    function compareSkillRow(hero, sk){
      if(!sk) return "";
      var iconSrc = hero ? heroSkillIcon(hero, sk.key) : (sk.icon || "");
      return `
        <div class="flex gap-3 rounded-xl border p-2">
          <div class="w-10 h-10 rounded-lg border overflow-hidden flex items-center justify-center shrink-0">
            <img src="${escapeHtml(iconSrc)}" class="w-full h-full object-contain" loading="lazy" />
          </div>
          <div class="min-w-0 flex-1">
            <div class="text-xs leading-relaxed text-gray-700">${escapeHtml(sk.desc || "")}</div>
          </div>
        </div>
      `;
    }

    // =========================
    // 렌더: 세대 드롭다운
    // =========================
    function renderGenTabs(){
      var gens = Array.from(new Set(HEROES.map(h => h.gen)))
        .sort((a, b) => a - b);

      var select = $("genSelect");
      select.innerHTML = "";

      var optAll = document.createElement("option");
      optAll.value = "ALL";
      optAll.textContent = "전체";
      select.appendChild(optAll);

      gens.forEach(g => {
        var opt = document.createElement("option");
        opt.value = g;
        opt.textContent = `${g}세대`;
        select.appendChild(opt);
      });

      select.value = currentGen ?? "ALL";

      select.onchange = () => {
        var v = select.value;
        currentGen = (v === "ALL") ? "ALL" : Number(v);
        renderHeroGrid();
      };
    }

    // =========================
    // 렌더: 영웅 리스트 카드
    // =========================
    var CLASS_ICON_MAP = {
      INFANTRY: "images/hero/icon_infantry.webp",
      LANCER: "images/hero/icon_lancer.webp",
      MARKSMAN: "images/hero/icon_marksman.webp"
    };

    function initTypeSelect(){
      var sel = $("selType");
      if(!sel) return;

      sel.value = currentType;

      sel.onchange = () => {
        if(currentGen !== "ALL"){
          currentType = "ALL";
          return;
        }

        currentType = sel.value;
        renderHeroGrid();
      };
    }

    function initSearch(){
      var input = $("heroSearch");
      var clear = $("heroSearchClear");
      if(!input) return;

      // 초기값 반영
      input.value = currentSearch || "";

      // 입력 시: 검색만 갱신
      input.oninput = () => {
        currentSearch = input.value || "";
        renderHeroGrid();
      };

      // 지우기 버튼: 항상 표시, 클릭 시 초기화
      if(clear){
        clear.onclick = () => {
          input.value = "";
          currentSearch = "";
          renderHeroGrid();
          input.focus();
        };
      }
    }

    function renderHeroGrid(){
      var wrap = $("heroGrid");
      var typeWrap = $("typeWrap") 
      wrap.innerHTML = "";

      if(currentGen !== "ALL"){
        typeWrap.classList.add("hidden")
      }
      else{
        typeWrap.classList.remove("hidden")
      }

      var q = (currentSearch || "").toString().trim().toLowerCase();

      // 세대 + 병종 + 이름 포함 검색
      var list = HEROES.filter(h => {
        var genOk  = (currentGen === "ALL") || (h.gen === currentGen);
        var typeOk = (currentGen !== "ALL") ? true : (currentType === "ALL") || (h.heroClass === currentType);

        var nameKo = (h.nameKo || "").toString().toLowerCase();
        var nameEn = (h.name || "").toString().toLowerCase();
        var nameOk = !q || nameKo.includes(q) || nameEn.includes(q);

        return genOk && typeOk && nameOk;
      });

      // 전체세대 + 병종 선택 시: Gen 섹션 없이 3컬럼으로 표시
      if(currentGen === "ALL" && currentType !== "ALL"){
        wrap.className = "grid grid-cols-3 gap-3";

        list.sort((a,b)=> (a.gen - b.gen) || String(a.nameKo||a.name).localeCompare(String(b.nameKo||b.name), "ko"));

        list.forEach(hero=>{
          var card = document.createElement("button");
          card.className = "text-left rounded-2xl border p-3 hover:shadow-md transition";
          card.onclick = () => {
            if(compareMode){
              toggleCompare(hero);
            }else{
              openHeroModal(hero);
            }
          };

          var img = renderHeroThumb(hero) || renderPortrait(hero) || "";
          var checked = compareSelectedKeys.includes(hero.key) ? "checked" : "";

          card.innerHTML = `
            ${compareMode ? `
              <div class="flex items-center justify-between mb-2">
                <label class="inline-flex items-center gap-2 text-xs text-gray-700" onclick="event.stopPropagation()">
                  <input type="checkbox"
                         class="hero-compare-check w-4 h-4"
                         data-key="${escapeHtml(hero.key)}"
                         ${checked}/>
                  비교 선택
                </label>
                <div class="text-[11px] text-gray-500">최대 2명</div>
              </div>
            ` : ``}

            <div class="flex items-center gap-3">
              <div class="w-16 h-16 rounded-2xl overflow-hidden flex items-center justify-center shrink-0">
                <img src="${escapeHtml(img)}" class="w-full h-full object-contain"
                     onerror="this.onerror=null; this.style.display='none';" />
              </div>

              <div class="min-w-0 flex-1">
                <div class="flex items-center gap-2">
                  <div class="text-lg font-extrabold truncate">${escapeHtml(hero.nameKo || hero.name)}</div>

                  <div class="shrink-0">
                    ${CLASS_ICON_MAP[hero.heroClass] ? `
                      <img src="${escapeHtml(CLASS_ICON_MAP[hero.heroClass])}"
                           class="w-5 h-5 object-contain opacity-90"
                           alt="${escapeHtml(hero.heroClass)}"
                           loading="lazy"
                           onerror="this.onerror=null; this.style.display='none';" />
                    ` : ``}
                  </div>
                </div>

                <div class="mt-0.5 text-xs truncate">
                  Gen ${hero.gen} • ${escapeHtml(hero.heroClass)} • ${escapeHtml(hero.expeditionType)}
                </div>
                <div class="mt-1 text-[11px] truncate">${escapeHtml(hero.source||"")}</div>
              </div>
            </div>
          `;
          wrap.appendChild(card);
        });

        // ✅ 비교 체크박스 change 이벤트는 카드 랜더링 후에 1회만 위임 바인딩
        if(compareMode){
          wrap.querySelectorAll(".hero-compare-check").forEach(chk=>{
            chk.onchange = (e)=>{
              e.stopPropagation();
              // ✅ 3번째 선택은 실제 체크되지 않도록 차단
              // (이미 2명이 선택되어 있고, 현재 체크가 '신규 선택'인 경우)
              var key = chk.getAttribute("data-key") || "";
              var already = compareSelectedKeys.includes(key);
              if(chk.checked && !already && compareSelectedKeys.length >= 2){
                chk.checked = false;
                showLimitPopup();
                return;
              }

              var hero = heroByKey(key);
              if(hero) toggleCompare(hero);
            };
          });
        }

        if(list.length === 0){
          wrap.className = "grid grid-cols-1 gap-3";
          wrap.innerHTML = `<div class="text-sm">표시할 영웅이 없습니다.</div>`;
        }
        return;
      }

      // 병종선택했다가 전체 병종할때 UX 깨져서 클래스네임 삭제
      if(currentGen !== "ALL"){
        wrap.classList.remove("grid-cols-3");
        wrap.classList.remove("grid-cols-2");
      } else {
        wrap.classList.remove("grid-cols-3");
        wrap.classList.add("grid-cols-2");  
      }

      // Gen 그룹핑
      var byGen = new Map();
      for(var h of list){
        if(!byGen.has(h.gen)) byGen.set(h.gen, []);
        byGen.get(h.gen).push(h);
      }

      var gens = Array.from(byGen.keys()).sort((a,b)=>a-b);
      var useAccordion = (currentGen === "ALL");

      gens.forEach(gen=>{
        var heroes = byGen.get(gen);

        var section = document.createElement(useAccordion ? "details" : "div");
        if(useAccordion){
          section.open = true;
          section.className = "rounded-2xl border overflow-hidden";
          section.innerHTML = `
            <summary class="cursor-pointer select-none px-4 py-3 font-extrabold flex items-center justify-between">
              <span>${gen}세대 (${heroes.length}명)</span>
            </summary>
            <div class="px-3 pb-3">
              <div class="gen-grid grid gap-3"></div>
            </div>
          `;

          var summary = section.querySelector("summary");
          summary.addEventListener("click", (e) => {
            e.preventDefault();
            section.open = true;
          });
        }else{
          section.className = "space-y-3";
          section.innerHTML = `
            <div class="flex items-center justify-between">
              <div class="text-lg font-extrabold">${gen}세대 영웅 (${heroes.length}명)</div>
            </div>
            <div class="gen-grid grid gap-3"></div>
          `;
        }

        var grid = section.querySelector(".gen-grid");
        var cols = (heroes.length >= 4) ? "grid-cols-2" : "grid-cols-3";
        grid.className = `gen-grid grid ${cols} gap-3`;

        heroes.forEach(hero=>{
          var card = document.createElement("button");
          card.className = "text-left rounded-2xl border p-3 hover:shadow-md transition";
          card.onclick = () => {
            if(compareMode){
              toggleCompare(hero);
            }else{
              openHeroModal(hero);
            }
          };

          var img = renderHeroThumb(hero) || renderPortrait(hero) || "";
          var checked = compareSelectedKeys.includes(hero.key) ? "checked" : "";

          card.innerHTML = `
            ${compareMode ? `
              <div class="flex items-center justify-between mb-2">
                <label class="inline-flex items-center gap-2 text-xs text-gray-700" onclick="event.stopPropagation()">
                  <input type="checkbox"
                         class="hero-compare-check w-4 h-4"
                         data-key="${escapeHtml(hero.key)}"
                         ${checked}/>
                  비교 선택
                </label>
                <div class="text-[11px] text-gray-500">최대 2명</div>
              </div>
            ` : ``}

            <div class="flex items-center gap-3">
              <div class="w-16 h-16 rounded-2xl overflow-hidden flex items-center justify-center shrink-0">
                <img src="${escapeHtml(img)}" class="w-full h-full object-contain"
                     onerror="this.onerror=null; this.style.display='none';" />
              </div>

              <div class="min-w-0 flex-1">
                <div class="flex items-center gap-2">
                  <div class="text-lg font-extrabold truncate">${escapeHtml(hero.nameKo || hero.name)}</div>
                  <div class="shrink-0">
                    ${CLASS_ICON_MAP[hero.heroClass] ? `
                      <img src="${escapeHtml(CLASS_ICON_MAP[hero.heroClass])}"
                           class="w-5 h-5 object-contain opacity-90"
                           alt="${escapeHtml(hero.heroClass)}"
                           loading="lazy"
                           onerror="this.onerror=null; this.style.display='none';" />
                    ` : ``}
                  </div>
                </div>

                <div class="mt-0.5 text-xs truncate">${escapeHtml(hero.heroClass)}</div>
                <div class="mt-1 text-[11px] truncate">${escapeHtml(hero.source||"")}</div>
              </div>
            </div>
          `;
          grid.appendChild(card);
        });

        // ✅ 비교 체크박스 change 이벤트 (섹션별)
        if(compareMode){
          section.querySelectorAll(".hero-compare-check").forEach(chk=>{
            chk.onchange = (e)=>{
              e.stopPropagation();
              // ✅ 3번째 선택은 실제 체크되지 않도록 차단
              // (이미 2명이 선택되어 있고, 현재 체크가 '신규 선택'인 경우)
              var key = chk.getAttribute("data-key") || "";
              var already = compareSelectedKeys.includes(key);
              if(chk.checked && !already && compareSelectedKeys.length >= 2){
                chk.checked = false;
                showLimitPopup();
                return;
              }

              var hero = heroByKey(key);
              if(hero) toggleCompare(hero);
            };
          });
        }

        wrap.appendChild(section);
      });

      if(list.length === 0){
        wrap.innerHTML = `<div class="text-sm">표시할 영웅이 없습니다.</div>`;
      }
    }

    // =========================
    // 렌더: 스킬 카드
    // =========================
    function renderSkills(targetEl, hero, skills){
      var wrap = $(targetEl);
      wrap.innerHTML = "";

      (skills || []).slice(0,3).forEach(sk=>{
        var lv = sk.level ?? 5;
        var val = sk.value ?? "-";

        var iconSrc = hero ? heroSkillIcon(hero, sk.key) : (sk.icon || "");

        var el = document.createElement("div");
        el.className = "rounded-xl border p-3";
        el.innerHTML = `
          <div class="flex gap-3">
            <div class="w-12 h-12 overflow-hidden flex items-center justify-center shrink-0">
              <img src="${escapeHtml(iconSrc)}"
                   class="w-full h-full object-contain"
                   loading="lazy"
                   onerror="this.onerror=null; this.style.display='none';" />
            </div>

            <div class="min-w-0 flex-1">
              <div class="mt-1 text-xs text-gray-700 leading-relaxed">
                ${escapeHtml(sk.desc||"")}
              </div>
            </div>
          </div>
        `;
        wrap.appendChild(el);
      });
    }

    function renderStats(){
      var s = currentHero?.stats || {};
      var ex = s.exploration || {};
      var ep = s.expedition || {};

      $("statExplore").innerHTML = Object.keys(ex).map(k => `
        <div class="rounded-xl border p-3">
          <div class="text-xs text-gray-700">${escapeHtml(k)}</div>
          <div class="text-base font-extrabold">${escapeHtml(fmt(ex[k]))}</div>
        </div>
      `).join("");

      $("statExpedition").innerHTML = Object.keys(ep).map(k => `
        <div class="rounded-xl border p-3">
          <div class="text-xs text-gray-700">${escapeHtml(k)}</div>
          <div class="text-base font-extrabold">${escapeHtml(fmt(ep[k]))}</div>
        </div>
      `).join("");
    }

    // 특성버프(= hero.exclusiveSkill) 렌더 + 12컬럼 레이아웃 토글
    function renderExclusiveSkill(hero, skills){
      var traitCard = $("traitCard");
      var body      = $("traitBuffArea");
      var weapon    = $("weapon");

      if(!traitCard || !body || !weapon) return;

      var hasTrait = Array.isArray(skills) && skills.length > 0;

      var setWeaponSpan = (span12) => {
        weapon.classList.remove("col-span-6", "col-span-12");
        weapon.classList.add(span12 ? "col-span-12" : "col-span-6");
      };

      var weaponSkills = $("weaponSkills");
      var setWeaponSkillsLayout = (twoCol) => {
        if(!weaponSkills) return;

        weaponSkills.classList.remove("space-y-3", "grid", "grid-cols-2", "gap-3");

        if(twoCol){
          weaponSkills.classList.add("grid", "grid-cols-2", "gap-3");
        }else{
          weaponSkills.classList.add("space-y-3");
        }
      };

      if(!hasTrait){
        traitCard.classList.add("hidden");
        setWeaponSpan(true);
        setWeaponSkillsLayout(true);
        body.innerHTML = "";
        return;
      }

      traitCard.classList.remove("hidden");
      traitCard.classList.remove("col-span-12");
      traitCard.classList.add("col-span-6");

      setWeaponSpan(false);
      setWeaponSkillsLayout(false);

      body.innerHTML = "";

      skills.forEach(sk => {
        var el = document.createElement("div");
        el.className = "flex items-start gap-3";

        var iconSrc = hero ? heroSkillIcon(hero, sk.key) : (sk.icon || "");

        el.innerHTML = `
          <div class="w-12 h-12 rounded-xl border overflow-hidden
                      flex items-center justify-center shrink-0">
            <img src="${escapeHtml(iconSrc)}"
                 class="w-full h-full object-contain"
                 loading="lazy"
                 onerror="this.onerror=null; this.style.display='none';" />
          </div>

          <div class="min-w-0 flex-1">
            <div class="font-bold text-sm mb-1">${escapeHtml(sk.title || "")}</div>
            <div class="text-xs leading-relaxed text-gray-700">
              ${escapeHtml(sk.desc || "")}
            </div>
          </div>
        `;
        body.appendChild(el);
      });
    }

    // 전용무기 스킬(weaponSkill) 렌더: ws1 ws2
    function renderWeaponSkills(hero, weaponSkill){
      var area = $("weaponSkills");

      area.innerHTML = "";
      var skills = Array.isArray(weaponSkill) ? weaponSkill : [];

      var order = ["ws1", "ws2"];
      var ordered = order
        .map(k => skills.find(s => (s?.key || "").toLowerCase() === k))
        .filter(Boolean);

      if(ordered.length === 0) return;

      ordered.forEach(sk => {
        var el = document.createElement("div");
        el.className = "flex items-start gap-3";

        var iconSrc = hero ? heroSkillIcon(hero, sk.key) : (sk.icon || "");

        el.innerHTML = `
          <div class="w-12 h-12 rounded-xl overflow-hidden
                      flex items-center justify-center shrink-0">
            <img src="${escapeHtml(iconSrc)}"
                 class="w-full h-full object-contain"
                 loading="lazy"
                 onerror="this.onerror=null; this.style.display='none';" />
          </div>

          <div class="min-w-0 flex-1">
            <div class="font-bold text-sm mb-1">${escapeHtml(sk.title || "")}</div>
            <div class="text-xs leading-relaxed text-gray-700">
              ${escapeHtml(sk.desc || "")}
            </div>
          </div>
        `;
        area.appendChild(el);
      });
    }

    function heroGen(hero){
      return String(hero.gen).padStart(2, "0");
    }

    function heroKey(hero){
      return hero.key;
    }

    function renderHeroThumb(hero){
      return `images/hero/Gen${heroGen(hero)}/thumb/${heroKey(hero)}.webp`;
    }

    function renderPortrait(hero){
      return `images/hero/Gen${heroGen(hero)}/body/${heroKey(hero)}.webp`;
    }

    function heroSkillIcon(hero, skillKey){
      return `images/hero/Gen${heroGen(hero)}/skills/${heroKey(hero)}/${skillKey}.webp`;
    }

    var EXPEDITION_TYPE_ICON = {
      COMBAT: "images/hero/combat.webp",
      varRUCTION: "images/hero/varRUCTION.webp",
    };

    function renderExpeditionType(type){
      var iconEl = document.getElementById("expeditionIcon");
      var textEl = document.querySelector("#hdrType span:last-child");
      if(!iconEl || !textEl) return;

      var t = (type || "").toUpperCase();
      var icon = EXPEDITION_TYPE_ICON[t];

      if(icon){
        iconEl.src = icon;
        iconEl.style.display = "";
      }else{
        iconEl.style.display = "none";
      }

      textEl.textContent = `${t || "-"}`;
    }

    var HERO_CLASS_TYPE_ICON = {
      INFANTRY: "images/hero/icon_infantry.webp",
      LANCER: "images/hero/icon_Lancer.webp",
      MARKSMAN: "images/hero/icon_marksman.webp",
    };

    function renderHeroClassType(type){
      var iconEl = document.getElementById("hdrClassIcon");
      var textEl = document.querySelector("#hdrClass  span:last-child");
      if(!iconEl || !textEl) return;

      var t = (type || "").toUpperCase();
      var icon = HERO_CLASS_TYPE_ICON[t];

      if(icon){
        iconEl.src = icon;
        iconEl.style.display = "";
      }else{
        iconEl.style.display = "none";
      }

      textEl.textContent = `${t || "-"}`;
    }

    // =========================
    // 모달 열기/닫기
    // =========================
    function openHeroModal(hero){
      currentHero = hero;

      $("hdrName").textContent = (hero.nameKo || "").toUpperCase();
      $("hdrGen").textContent = `Gen ${hero.gen} • ${hero.name || ""}`;
      $("hdrClass").lastElementChild.textContent = `${hero.heroClass || "-"}`;
      $("hdrType").lastElementChild.textContent = `${hero.expeditionType || "-"}`;
      $("sourceText").textContent = hero.source ? `획득처: ${hero.source}` : "";

      var g = hero.headerGradient || ["#0ea5e9","#2563eb"];
      $("modalHeroHeader").style.background = `linear-gradient(135deg, ${g[0]}, ${g[1]})`;

      var imgEl = $("heroImg");
      imgEl.style.display = "";
      $("heroImgFallback").classList.add("hidden");
      imgEl.src = renderPortrait(hero) || renderHeroThumb(hero) || "";

      renderHeroClassType(hero.heroClass);
      renderExpeditionType(hero.expeditionType);
      renderExclusiveSkill(hero, hero.exclusiveSkill);
      renderWeaponSkills(hero, hero.weaponSkills);

      renderSkills("exploreSkills", hero, hero.explorationSkills);
      renderSkills("expeditionSkills", hero, hero.expeditionSkills);
      renderStats();

      $("modalBackdrop").classList.remove("hidden");
      document.body.style.overflow = "hidden";
    }

    function closeHeroModal(){
      $("modalBackdrop").classList.add("hidden");
      document.body.style.overflow = "";
    }

    // =========================
    // 이벤트
    // =========================
    $("closeModal").onclick = closeHeroModal;
    $("modalBackdrop").addEventListener("click", (e)=>{
      if(e.target === $("modalBackdrop")) closeHeroModal();
    });
    window.addEventListener("keydown", (e)=>{
      if(e.key === "Escape" && !$("modalBackdrop").classList.contains("hidden")) closeHeroModal();
    });
  };
  window.HeroInfoInit();
})();
</script>
