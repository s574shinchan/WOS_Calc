<meta charset="UTF-8" />

<div style="max-width:1500px;margin:0 auto;background:#fff;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,.08);padding:12px;">
  <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:10px;">
    <b style="font-size:18px;">ğŸ“Š ì´ë¯¼íˆìŠ¤í† ë¦¬ (Sheets API ì§ì ‘)</b>

    <button data-year="2024" style="padding:6px 10px;border:1px solid #ddd;border-radius:8px;background:#f7f7f7;cursor:pointer;">2024</button>
    <button data-year="2025" style="padding:6px 10px;border:1px solid #ddd;border-radius:8px;background:#f7f7f7;cursor:pointer;">2025</button>
    <button data-year="2026" style="padding:6px 10px;border:1px solid #ddd;border-radius:8px;background:#f7f7f7;cursor:pointer;">2026</button>

    <span id="status" style="margin-left:auto;color:#666;font-size:12px;">ëŒ€ê¸°ì¤‘</span>
  </div>

  <div id="sheet-table" style="overflow:auto;border:1px solid #eee;border-radius:10px;padding:8px;">
    â³ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
  </div>
</div>

<script>
(function(){
  const API_KEY  = "AIzaSyApQgTHOnPFskqfq7y-vWBzHjgCxOHezDI";
  const SPREADSHEET_ID = "1a2j650rgwXEMR_sXRRpM2-L6o_b-uC7FdoixGi34oTw";

  const SHEET_IDS = {
    "2024": 28337220,
    "2025": 201834788,
    "2026": 1992769226,
  };

  const mount = document.getElementById("sheet-table");
  const statusEl = document.getElementById("status");

  function esc(s){
    return String(s ?? "")
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;");
  }

  function rgb(c, fallback){
    if (!c) return fallback;
    const r = Math.round((c.red ?? 0) * 255);
    const g = Math.round((c.green ?? 0) * 255);
    const b = Math.round((c.blue ?? 0) * 255);
    return `rgb(${r},${g},${b})`;
  }

  function textAlign(fmt){
    const a = (fmt?.horizontalAlignment ?? "").toString().toUpperCase();
    if (a === "CENTER") return "text-align:center;";
    if (a === "RIGHT")  return "text-align:right;";
    if (a === "LEFT")   return "text-align:left;";
    return "";
  }

  function vAlign(fmt){
    const v = (fmt?.verticalAlignment ?? "").toString().toUpperCase();
    if (v === "TOP") return "vertical-align:top;";
    if (v === "MIDDLE" || v === "CENTER") return "vertical-align:middle;";
    if (v === "BOTTOM") return "vertical-align:bottom;";
    return "";
  }

  function borderCss(b){
    if (!b?.color) return "";
    return `1px solid ${rgb(b.color, "#ccc")}`;
  }

  async function fetchSheet(sheetId){
    // âœ… fields ë¬¸ë²• ìˆ˜ì • (merges(...) ì•ˆì— startRowIndex ë“± ë“¤ì–´ê°)
    const fields = [
			"sheets(",
				"properties(sheetId,title),",
				"merges(startRowIndex,endRowIndex,startColumnIndex,endColumnIndex),",
				"data(rowData(values(",
					"formattedValue,",
					"effectiveValue,",
					"effectiveFormat(backgroundColor,horizontalAlignment,verticalAlignment,textFormat(foregroundColor,bold,fontSize)),",
					"userEnteredFormat(",
						"backgroundColor,",
						"borders(top(color),bottom(color),left(color),right(color)),",
						"textFormat(bold)",
					")",
				")))",
			")"
		].join("");

    const url =
      `https://sheets.googleapis.com/v4/spreadsheets/${encodeURIComponent(SPREADSHEET_ID)}` +
      `?includeGridData=true` +
      `&fields=${encodeURIComponent(fields)}` +
      `&key=${encodeURIComponent(API_KEY)}`;

    const res = await fetch(url, { cache:"no-store" });
    const txt = await res.text();

    if (!res.ok){
      console.error("Sheets API ì‹¤íŒ¨", res.status, txt);
      throw new Error(`Sheets API ì‹¤íŒ¨ (${res.status})`);
    }

    const data = JSON.parse(txt);
    const sheet = (data.sheets || []).find(s => s?.properties?.sheetId === sheetId);
    if (!sheet) throw new Error("sheetId(gid) ì‹œíŠ¸ë¥¼ ì°¾ì§€ ëª»í•¨: " + sheetId);

    return sheet;
  }

  function buildMergeMaps(merges){
    const mergeMap = {};
    const skip = new Set();

    for (const m of (merges || [])){
      const sr = m.startRowIndex ?? 0, er = m.endRowIndex ?? 0;
      const sc = m.startColumnIndex ?? 0, ec = m.endColumnIndex ?? 0;

      mergeMap[`${sr},${sc}`] = { rowspan: er - sr, colspan: ec - sc };

      for (let r = sr; r < er; r++){
        for (let c = sc; c < ec; c++){
          if (r !== sr || c !== sc) skip.add(`${r},${c}`);
        }
      }
    }
    return { mergeMap, skip };
  }

  function render(sheet){
    const merges = sheet.merges || [];
    const rows = sheet.data?.[0]?.rowData || [];
    const { mergeMap, skip } = buildMergeMaps(merges);

    let html = `<table style="width:100%; min-width:100%; border-collapse:collapse; font-size:12px;"><tbody>`;

    for (let ri=0; ri<rows.length; ri++){
      const cells = rows[ri].values || [];
      html += "<tr>";

      for (let ci=0; ci<cells.length; ci++){
        const key = `${ri},${ci}`;
        if (skip.has(key)) continue;

        const cell = cells[ci] || {};
        const eff = cell.effectiveFormat || {};
        const usr = cell.userEnteredFormat || {};

        const text = esc(cell.formattedValue ?? cell.effectiveValue?.stringValue ?? cell.effectiveValue?.numberValue ?? cell.effectiveValue?.boolValue ?? "");

        const bg = rgb(usr.backgroundColor ?? eff.backgroundColor, "#ffffff");
        const fg = rgb(eff.textFormat?.foregroundColor, "#000000");
        const bold = (eff.textFormat?.bold === true || usr.textFormat?.bold === true);

        const fs = eff.textFormat?.fontSize;
        const fsStyle = (Number.isFinite(fs) && fs > 0) ? `font-size:${fs}px;` : "";

        const aStyle = textAlign(eff) || textAlign(usr);
        const vStyle = vAlign(eff) || vAlign(usr);

        const b = usr.borders || {};
        const defaultBorder = "1px solid rgba(0,0,0,.12)";
        const bt = borderCss(b.top) || defaultBorder;
        const bb = borderCss(b.bottom) || defaultBorder;
        const bl = borderCss(b.left) || defaultBorder;
        const br = borderCss(b.right) || defaultBorder;

        const span = mergeMap[key];
        const rs = span?.rowspan ? ` rowspan="${span.rowspan}"` : "";
        const cs = span?.colspan ? ` colspan="${span.colspan}"` : "";

        html += `<td${rs}${cs} style="
          border-top:${bt};
          border-bottom:${bb};
          border-left:${bl};
          border-right:${br};
          padding:6px;
          background:${bg};
          color:${fg};
          font-weight:${bold ? "700":"400"};
          ${fsStyle}
          ${aStyle}
          ${vStyle}
        ">${text}</td>`;
      }

      html += "</tr>";
    }

    html += "</tbody></table>";
    return html;
  }

  async function loadYear(year){
    try{
      statusEl.textContent = `ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦ (${year})`;
      mount.innerHTML = "â³ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

      const sheetId = SHEET_IDS[year];
      const sheet = await fetchSheet(sheetId);

      mount.innerHTML = render(sheet);
      statusEl.textContent = `ì™„ë£Œ (${year})`;
    }catch(e){
      console.error(e);
      statusEl.textContent = "ì‹¤íŒ¨";
      mount.textContent = "âŒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (Console í™•ì¸)";
    }
  }

  document.querySelectorAll("button[data-year]").forEach(btn=>{
    btn.addEventListener("click", ()=>loadYear(btn.dataset.year));
  });

  loadYear("2026");
})();
</script>
