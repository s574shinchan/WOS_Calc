<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ§ª ì—°êµ¬ ê³„ì‚°ê¸°</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-2 font-sans text-sm">
  <div class="max-w-6xl mx-auto bg-white p-2 rounded-xl shadow-md">
    <h1 class="text-2xl font-bold text-gray-800 mb-4">ğŸ§ª ì—°êµ¬ ê³„ì‚°ê¸°</h1>
    
    <!-- ì—°êµ¬ì†ë„ ì„¤ì • -->
    <div class="grid grid-cols-2 md:flex md:flex-wrap md:items-center gap-4">
      <label class="inline-flex items-center font-semibold">
        <input type="checkbox" id="chkVP10" class="mr-2 w-4 h-4">ì¼ë°˜)ë¶€ì§‘í–‰ê´€ (10%)
      </label>
      <label class="inline-flex items-center font-semibold">
        <input type="checkbox" id="chkVP15" class="mr-2 w-4 h-4">ìµœì§‘)ë¶€ì§‘í–‰ê´€ (15%)
      </label>
      <label class="inline-flex items-center font-semibold">
        <input type="checkbox" id="chkServerBuff" class="mr-2 w-4 h-4">ì—°êµ¬ì„œë²„ë²„í”„ (10%)
      </label>
      <div class="flex items-center gap-2">
        <label for="speedPercent" class="font-semibold whitespace-nowrap">ì—°êµ¬ì†ë„ (%)</label>
        <input type="number" id="speedPercent" class="border rounded p-2 text-sm w-24 text-right" placeholder="0" min="0" />
      </div>
    </div>
    
    <!-- ì „íˆ¬ ì„¹ì…˜ -->
    <div class="mb-4">
      <h2 class="text-lg font-bold text-blue-700 mb-2">[ì „íˆ¬]</h2>
      <div class="grid grid-cols-3 gap-4 mb-1 text-xs text-gray-600 font-semibold">
        <label>ì—°êµ¬í•­ëª©</label><label>í˜„ì¬</label><label>ëª©í‘œ</label>
      </div>
      <div class="grid grid-cols-3 gap-4">
        <select class="border rounded p-2 text-sm" id="researchType"></select>
        <select class="border rounded p-2 text-sm" id="currentLevel"></select>
        <select class="border rounded p-2 text-sm" id="targetLevel"></select>
      </div>
      <div class="mt-2">
        <button type="button" class="w-full add-btn bg-gray-200 text-sm px-3 py-1 rounded hover:bg-blue-300" data-section="battle">ì¶”ê°€</button>
      </div>
    </div>

    <!-- ê²½ì œ ì„¹ì…˜ -->
    <div class="mb-4">
      <h2 class="text-lg font-bold text-green-700 mb-2">[ê²½ì œ]</h2>
      <div class="grid grid-cols-3 gap-4 mb-1 text-xs text-gray-600 font-semibold">
        <label>ì—°êµ¬í•­ëª©</label><label>í˜„ì¬</label><label>ëª©í‘œ</label>
      </div>
      <div class="grid grid-cols-3 gap-4">
        <select class="border rounded p-2 text-sm" id="economyType"></select>
        <select class="border rounded p-2 text-sm" id="economyCurrent"></select>
        <select class="border rounded p-2 text-sm" id="economyTarget"></select>
      </div>
      <div class="mt-2">
        <button type="button" class="w-full add-btn bg-gray-200 text-sm px-3 py-1 rounded hover:bg-blue-300" data-section="economy">ì¶”ê°€</button>
      </div>
    </div>

    <!-- ë°œì „ ì„¹ì…˜ -->
    <div class="mb-4">
      <h2 class="text-lg font-bold text-purple-700 mb-2">[ë°œì „]</h2>
      <div class="grid grid-cols-3 gap-4 mb-1 text-xs text-gray-600 font-semibold">
        <label>ì—°êµ¬í•­ëª©</label><label>í˜„ì¬</label><label>ëª©í‘œ</label>
      </div>
      <div class="grid grid-cols-3 gap-4">
        <select class="border rounded p-2 text-sm" id="growthType"></select>
        <select class="border rounded p-2 text-sm" id="growthCurrent"></select>
        <select class="border rounded p-2 text-sm" id="growthTarget"></select>
      </div>
      <div class="mt-2">
        <button type="button" class="w-full add-btn bg-gray-200 text-sm px-3 py-1 rounded hover:bg-blue-300" data-section="growth">ì¶”ê°€</button>
      </div>
    </div>

    <!-- ì„ íƒëœ ì—°êµ¬ ëª©ë¡ -->
    <div id="addedList" class="mt-8 bg-gray-50 border rounded p-4">
      <div class="flex justify-between items-center mb-2">
        <h2 class="text-lg font-bold text-gray-700">ğŸ“‹ ì„ íƒëœ ì—°êµ¬ ëª©ë¡</h2>
        <div class="flex gap-x-2">
          <button id="calculateFromList" class="text-blue-500 text-sm hover:underline">ğŸ“Š ê³„ì‚°í•˜ê¸°</button>
          <button id="clearList" class="text-sm text-red-600 hover:underline">ğŸ§¹ ëª©ë¡ ì´ˆê¸°í™”</button>
        </div>
      </div>
      <div class="space-y-1 text-sm mb-4" id="listContainer"></div>
    </div>
  </div>
  
  <!-- âœ… ê³µí†µ ê¸°ëŠ¥ -->
  <script>
    function sendHeightToParent() {
      const height = document.body.scrollHeight;
      window.parent.postMessage({ type: "FRAME_CHANGE", height }, "*");
    }

    // í˜ì´ì§€ ìµœì´ˆ ë¡œë“œ ì‹œ
    window.addEventListener("load", () => {
      setTimeout(sendHeightToParent, 100); // ì•½ê°„ì˜ ë Œë”ë§ ëŒ€ê¸°
    });
    
    function loadPage(page) {
      const isMobile = window.innerWidth <= 768;
      const height = isMobile ? "550px" : "345px"
        window.location.href = page;
      window.parent.postMessage({ type: "SET_FRAME_SIZE", height: height, width: "100%"}, "*");
    }

    function setupMutualExclusionCheckboxes(id1, id2) {
      const box1 = document.getElementById(id1);
      const box2 = document.getElementById(id2);
      box1.addEventListener("change", () => {
        if (box1.checked) box2.checked = false;
      });
      box2.addEventListener("change", () => {
        if (box2.checked) box1.checked = false;
      });
    }
  
    function setupAutoTargetLevel(currentId, targetId) {
      document.getElementById(currentId).addEventListener("change", () => {
        const currentVal = parseInt(document.getElementById(currentId).value, 10);
        const targetSelect = document.getElementById(targetId);
        const options = Array.from(targetSelect.options).map(opt => parseInt(opt.value, 10));
        const nextVal = options.find(val => val > currentVal);
        if (nextVal !== undefined) {
          targetSelect.value = nextVal;
        }
      });
    }

    function fetchResearchCSV(url, typeId, currentId, targetId) {
      const map = new Map();
      const selectType = document.getElementById(typeId);
      const selectCurrent = document.getElementById(currentId);
      const selectTarget = document.getElementById(targetId);
  
      fetch(url)
        .then(res => res.text())
        .then(text => {
          const lines = text.split("\n").map(l => l.trim()).filter(Boolean);
          const nameIdx = lines[0].split(",").indexOf("ì—°êµ¬");
  
          for (let i = 1; i < lines.length; i++) {
            const [fullName] = lines[i].split(",");
            if (!fullName.includes("-")) continue;
            const [type, levelStr] = fullName.split("-");
            const level = parseInt(levelStr, 10);
            if (!map.has(type)) map.set(type, []);
            const levels = map.get(type);
            if (!levels.includes(level)) levels.push(level);
          }
  
          map.forEach((_, type) => {
            const opt = new Option(type, type);
            selectType.appendChild(opt);
          });
  
          selectType.addEventListener("change", () => {
            const levels = (map.get(selectType.value) || []).sort((a, b) => a - b);
            [selectCurrent, selectTarget].forEach(sel => sel.innerHTML = "");
            levels.forEach(lv => {
              selectCurrent.appendChild(new Option(lv, lv));
              selectTarget.appendChild(new Option(lv, lv));
            });
          });
  
          selectType.dispatchEvent(new Event("change"));
        });
    }

    function cleanInt(str) {
      return parseInt((str || "0").replace(/,/g, ""), 10) || 0;
    }
  
    document.addEventListener("DOMContentLoaded", () => {
      setupMutualExclusionCheckboxes("chkVP10", "chkVP15");
    });
  </script>
  
  <!-- âœ… ì „íˆ¬ -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      fetchResearchCSV(
        "https://raw.githubusercontent.com/s574shinchan/WOS_Calc/refs/heads/main/data/research/Battle.csv",
        "researchType", "currentLevel", "targetLevel"
      );
      setupAutoTargetLevel("currentLevel", "targetLevel");
    });
  </script>

  <!-- âœ… ê²½ì œ -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      fetchResearchCSV(
        "https://raw.githubusercontent.com/s574shinchan/WOS_Calc/refs/heads/main/data/research/Economy.csv",
        "economyType", "economyCurrent", "economyTarget"
      );
      setupAutoTargetLevel("economyCurrent", "economyTarget");
    });
  </script>
  
  <!-- âœ… ë°œì „ -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      fetchResearchCSV(
        "https://raw.githubusercontent.com/s574shinchan/WOS_Calc/refs/heads/main/data/research/Growth.csv",
        "growthType", "growthCurrent", "growthTarget"
      );
      setupAutoTargetLevel("growthCurrent", "growthTarget");
    });
  </script>

  <script>
    function formatTime(sec) {
      const d = Math.floor(sec / 86400);
      sec %= 86400;
      const h = Math.floor(sec / 3600);
      sec %= 3600;
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return `${d}d ${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    }
  
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("calculateFromList").addEventListener("click", () => {
        const rows = document.querySelectorAll("#listContainer div");
        if (!rows.length) return alert("ê³„ì‚°í•  ì—°êµ¬ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.");
  
        let total = { ê³ ê¸°: 0, ëª©ì¬: 0, ì„íƒ„: 0, ì² ê´‘: 0, ì² ê°•ì¬: 0, ì‹œê°„: 0 };
        const resultRows = [];
  
        let factor = (parseFloat(document.getElementById("speedPercent").value) || 0) * 0.01 + 1;
        if (document.getElementById("chkVP10").checked) factor += 0.10;
        if (document.getElementById("chkVP15").checked) factor += 0.15;
        if (document.getElementById("chkServerBuff").checked) factor += 0.10;
  
        rows.forEach(row => {
          const text = row.querySelector("span")?.textContent || "";
          const match = text.match(/\[(.*?)\]\s(.*?)\s:\s(\d+)\sâ†’\s(\d+)/);
          if (!match) return;
  
          const [, section, type, start, end] = match;
          const s = parseInt(start), e = parseInt(end);
          const urlMap = {
            "ì „íˆ¬": "Battle.csv",
            "ê²½ì œ": "Economy.csv",
            "ë°œì „": "Growth.csv"
          };
          const url = `https://raw.githubusercontent.com/s574shinchan/WOS_Calc/refs/heads/main/data/research/${urlMap[section]}`;
  
          resultRows.push({ section, type, s, e, url });
        });
  
        Promise.all(resultRows.map(({ url, type, s, e }) =>
          fetch(url)
            .then(res => res.text())
            .then(text => {
              const lines = text.split("\n").map(l => l.trim()).filter(Boolean);
              const headers = lines[0].split(",");
              const idx = {
                ì—°êµ¬: headers.indexOf("ì—°êµ¬"), 
                ê³ ê¸°: headers.indexOf("ê³ ê¸°"),
                ëª©ì¬: headers.indexOf("ëª©ì¬"), 
                ì„íƒ„: headers.indexOf("ì„íƒ„"),
                ì² ê´‘: headers.indexOf("ì² ê´‘"), 
                ì² ê°•ì¬: headers.indexOf("ì² ê°•ì¬"), 
                ì‹œê°„: headers.indexOf("ì‹œê°„")
              };
  
              let sum = { ê³ ê¸°: 0, ëª©ì¬: 0, ì„íƒ„: 0, ì² ê´‘: 0, ì² ê°•ì¬: 0, ì‹œê°„: 0 };
  
              for (let i = 1; i < lines.length; i++) {
                const cols = lines[i].split(",");
                const name = cols[idx.ì—°êµ¬];
                if (!name || !name.includes(type)) continue;
                
                const [_, levelStr] = name.split("-");
                const level = parseInt(levelStr);
                
                if (level > s && level <= e) {
                //if (name === `${type}-${e}`) {
                  sum.ê³ ê¸° += cleanInt(cols[idx.ê³ ê¸°]) || 0;
                  sum.ëª©ì¬ += cleanInt(cols[idx.ëª©ì¬]) || 0;
                  sum.ì„íƒ„ += cleanInt(cols[idx.ì„íƒ„]) || 0;
                  sum.ì² ê´‘ += cleanInt(cols[idx.ì² ê´‘]) || 0;
                  sum.ì² ê°•ì¬ += cleanInt(cols[idx.ì² ê°•ì¬]) || 0;
                  sum.ì‹œê°„ += parseTimeToSeconds(cols[idx.ì‹œê°„]);
                }
              }
  
              total.ê³ ê¸° += sum.ê³ ê¸°;
              total.ëª©ì¬ += sum.ëª©ì¬;
              total.ì„íƒ„ += sum.ì„íƒ„;
              total.ì² ê´‘ += sum.ì² ê´‘;
              total.ì² ê°•ì¬ += sum.ì² ê°•ì¬;
              total.ì‹œê°„ += sum.ì‹œê°„;
  
              return `<tr class="bg-white">
                <td class="border p-1 font-medium">${type}</td>
                <td class="border p-1">${s} â†’ ${e}</td>
                <td class="border p-1">${formatResource(sum.ê³ ê¸°)}</td>
                <td class="border p-1">${formatResource(sum.ëª©ì¬)}</td>
                <td class="border p-1">${formatResource(sum.ì„íƒ„)}</td>
                <td class="border p-1">${formatResource(sum.ì² ê´‘)}</td>
                <td class="border p-1">${formatResource(sum.ì² ê°•ì¬)}</td>
                <td class="border p-1">${formatTime(sum.ì‹œê°„)}</td>
                <td class="border p-1">${formatTime(Math.round(sum.ì‹œê°„ / factor))}</td>
              </tr>`;
            })
        )).then(tableRows => {
          const html = `
            <table class="w-full border text-sm text-center table-auto">
              <thead class="bg-blue-100">
                <tr>
                  <th class="border p-1">ì—°êµ¬í•­ëª©</th>
                  <th class="border p-1">ë ˆë²¨</th>
                  <th class="border p-1">ê³ ê¸°</th>
                  <th class="border p-1">ëª©ì¬</th>
                  <th class="border p-1">ì„íƒ„</th>
                  <th class="border p-1">ì² ê´‘</th>
                  <th class="border p-1">ì² ê°•ì¬</th>
                  <th class="border p-1">ì—°êµ¬ì‹œê°„</th>
                  <th class="border p-1">ì ìš©ì‹œê°„</th>
                </tr>
              </thead>
              <tbody>${tableRows.join("")}</tbody>
              <tfoot class="bg-gray-100 font-semibold">
                <tr>
                  <td class="border p-1" colspan="2">ì´í•©</td>
                  <td class="border p-1">${formatResource(total.ê³ ê¸°)}</td>
                  <td class="border p-1">${formatResource(total.ëª©ì¬)}</td>
                  <td class="border p-1">${formatResource(total.ì„íƒ„)}</td>
                  <td class="border p-1">${formatResource(total.ì² ê´‘)}</td>
                  <td class="border p-1">${formatResource(total.ì² ê°•ì¬)}</td>
                  <td class="border p-1">${formatTime(total.ì‹œê°„)}</td>
                  <td class="border p-1">${formatTime(Math.round(total.ì‹œê°„ / factor))}</td>
                </tr>
              </tfoot>
            </table>
          `;
          // ë¶€ëª¨ ì°½ìœ¼ë¡œ ê²°ê³¼ HTML ì „ì†¡
          window.parent.postMessage({ type: "RESULT_POPUP", html }, "*");
        });
      });
  
    function formatResource(value) {
      if (value >= 1_000_000_000) {
        return (value / 1_000_000_000).toFixed(2).replace(/\.00$/, '') + 'B';
      } else if (value >= 1_000_000) {
        return (value / 1_000_000).toFixed(2).replace(/\.00$/, '') + 'M';
      } else if (value >= 1_000) {
        return value.toLocaleString();
      } else {
        return value.toString();
      }
    }
  
    function parseTimeToSeconds(timeStr) {
      const [d, hms] = timeStr.split(" ");
      const [h, m, s] = hms.split(":").map(Number);
      return (parseInt(d) || 0) * 86400 + h * 3600 + m * 60 + s;
    }
  });
  </script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      document.querySelectorAll(".add-btn").forEach(button => {
        button.addEventListener("click", () => {
          const section = button.dataset.section;
          let typeSelect, currentSelect, targetSelect, sectionLabel;
  
          if (section === "battle") {
            typeSelect = document.getElementById("researchType");
            currentSelect = document.getElementById("currentLevel");
            targetSelect = document.getElementById("targetLevel");
            sectionLabel = "ì „íˆ¬";
          } else if (section === "economy") {
            typeSelect = document.getElementById("economyType");
            currentSelect = document.getElementById("economyCurrent");
            targetSelect = document.getElementById("economyTarget");
            sectionLabel = "ê²½ì œ";
          } else if (section === "growth") {
            typeSelect = document.getElementById("growthType");
            currentSelect = document.getElementById("growthCurrent");
            targetSelect = document.getElementById("growthTarget");
            sectionLabel = "ë°œì „";
          } else {
            return;
          }
  
          const type = typeSelect.value;
          const current = currentSelect.value;
          const target = targetSelect.value;
  
          if (!type || !current || !target || parseInt(current) >= parseInt(target)) {
            alert("ìœ íš¨í•œ ì—°êµ¬ í•­ëª©ê³¼ ë ˆë²¨ì„ ì„ íƒí•˜ì„¸ìš”.");
            return;
          }
  
          // âœ… ì¤‘ë³µ í™•ì¸
          const existingItems = document.querySelectorAll("#listContainer span");
          for (const item of existingItems) {
            if (item.textContent === `[${sectionLabel}] ${type} : ${current} â†’ ${target}`) {
              alert('ì´ë¯¸ ì¶”ê°€ëœ í•­ëª©ì…ë‹ˆë‹¤.');
              return;
            }
          }
  
          const listItem = document.createElement("div");
          listItem.className = "flex justify-between items-center bg-white p-2 rounded border";
          listItem.innerHTML = `
            <span class="font-semibold">[${sectionLabel}] ${type} : ${current} â†’ ${target}</span>
            <button class="text-xs text-red-500 hover:underline remove-btn">ì‚­ì œ</button>
          `;
          document.getElementById("listContainer").appendChild(listItem);
  
          sendHeightToParent(); // âœ… ì¶”ê°€ í›„ í”„ë ˆì„ ë†’ì´ ì¡°ì •
  
          listItem.querySelector(".remove-btn").addEventListener("click", () => {
            listItem.remove();
            sendHeightToParent(); // âœ… ì‚­ì œ í›„ í”„ë ˆì„ ë†’ì´ ì¡°ì •
          });
        });
      });
      
      document.getElementById("clearList").addEventListener("click", () => {
        document.getElementById("listContainer").innerHTML = "";
        sendHeightToParent(); // âœ… ì „ì²´ ì´ˆê¸°í™” í›„ í”„ë ˆì„ ë†’ì´ ì¡°ì •
      });
    });
  </script>
  <script>
    document.addEventListener("contextmenu", event => event.preventDefault());
    document.addEventListener("keydown", function (e) {
      if (e.key === "F12" ||
          (e.ctrlKey && e.shiftKey && (e.key === "I" || e.key === "J")) ||
          (e.ctrlKey && (e.key === "U" || e.key === "S")))
      {
        e.preventDefault();
      }
    });
  </script>
</body>
</html>
