<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ§ª ì—°êµ¬ ê³„ì‚°ê¸° (Card UI)</title>
  <script src="https://cdn.tailwindcss.com"></script>
	<style>
    /* âœ… ë‹¤í¬ëª¨ë“œ */
    body.dark-mode { background-color:#121212; color:#f0f0f0; }
    .dark-mode .border{ border-color:#444 !important; }
    .dark-mode .bg-white{ background-color:#2c2c2c !important; color:#f0f0f0 !important; }
    .dark-mode .bg-gray-100{ background-color:#1e1e1e !important; }
    .dark-mode .text-gray-800,.dark-mode .text-gray-700,.dark-mode .text-gray-600{ color:#dddddd !important; }
    .dark-mode .text-blue-700{ color:#66b0ff !important; }
    .dark-mode .text-green-700{ color:#79e68c !important; }
    .dark-mode .text-purple-700{ color:#bfa6ff !important; }
    .dark-mode table{ background-color:#2c2c2c; color:#f0f0f0; }
    .dark-mode th,.dark-mode td{ border-color:#444 !important; }
    .dark-mode thead th{ color:#000 !important; }
    .dark-mode .bg-blue-100,.dark-mode .bg-gray-50{ background-color:#2e2e2e !important; }
    .dark-mode select option,.dark-mode select,.dark-mode input{ color:#000 !important; }
  </style>
  <script>
    // âœ… ë‹¤í¬ëª¨ë“œ ìœ ì§€
    window.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
      }
    });
  </script></head>
<body class="bg-gray-100 p-2 font-sans text-sm">
  <div class="max-w-6xl mx-auto space-y-3">
    <!-- í—¤ë” ì¹´ë“œ -->
    <div class="bg-white border rounded-xl shadow-sm p-3">
      <h1 class="text-xl md:text-2xl font-bold text-gray-800">ğŸ§ª ì—°êµ¬ ê³„ì‚°ê¸°</h1>
    </div>

    <!-- ì—°êµ¬ì†ë„/ë²„í”„ ì¹´ë“œ -->
    <div class="bg-white border rounded-xl shadow-sm p-3">
      <h2 class="text-base font-bold text-gray-800 mb-2">ì—°êµ¬ ì†ë„ / ë²„í”„</h2>
      <div class="grid grid-cols-2 md:flex md:flex-wrap md:items-center gap-3">
        <label class="inline-flex items-center font-semibold">
          <input type="checkbox" id="chkVP10" class="mr-2 w-4 h-4">ì¼ë°˜)ë¶€ì§‘í–‰ê´€ (10%)
        </label>
        <label class="inline-flex items-center font-semibold">
          <input type="checkbox" id="chkVP15" class="mr-2 w-4 h-4">ìµœì§‘)ë¶€ì§‘í–‰ê´€ (15%)
        </label>
        <label class="inline-flex items-center font-semibold">
          <input type="checkbox" id="chkServerBuff" class="mr-2 w-4 h-4">ì—°êµ¬ì„œë²„ë²„í”„ (10%)
        </label>
        <div class="flex items-center gap-2">
          <label for="speedPercent" class="font-semibold whitespace-nowrap">ì—°êµ¬ì†ë„ (%)</label>
          <input type="number" id="speedPercent" class="border rounded p-2 text-sm w-24 text-right" placeholder="0" min="0" />
        </div>
      </div>
    </div>

    <!-- ì „íˆ¬/ê²½ì œ/ë°œì „ ì¹´ë“œ 3ê°œ -->
    <div class="grid md:grid-cols-3 gap-3">
      <!-- ì „íˆ¬ -->
      <div class="bg-white border rounded-xl shadow-sm p-3">
        <h2 class="text-base font-bold text-blue-700 mb-2">[ì „íˆ¬]</h2>
        <div class="grid grid-cols-[64px_1fr] gap-x-3 gap-y-2">
          <div class="text-[15px] text-gray-600 font-semibold self-center">ì—°êµ¬í•­ëª©</div>
          <select class="border rounded p-2 text-sm w-full" id="researchType"></select>

          <div class="text-[15px] text-gray-600 font-semibold self-center">í˜„ì¬</div>
          <select class="border rounded p-2 text-sm w-full" id="currentLevel"></select>

          <div class="text-[15px] text-gray-600 font-semibold self-center">ëª©í‘œ</div>
          <select class="border rounded p-2 text-sm w-full" id="targetLevel"></select>
        </div>
        <button type="button"
          class="w-full add-btn mt-3 bg-gray-200 text-sm px-3 py-2 rounded hover:bg-blue-300"
          data-section="battle">ì¶”ê°€</button>
      </div>

      <!-- ê²½ì œ -->
      <div class="bg-white border rounded-xl shadow-sm p-3">
        <h2 class="text-base font-bold text-green-700 mb-2">[ê²½ì œ]</h2>
        <div class="grid grid-cols-[64px_1fr] gap-x-3 gap-y-2">
          <div class="text-[15px] text-gray-600 font-semibold self-center">ì—°êµ¬í•­ëª©</div>
          <select class="border rounded p-2 text-sm w-full" id="economyType"></select>

          <div class="text-[15px] text-gray-600 font-semibold self-center">í˜„ì¬</div>
          <select class="border rounded p-2 text-sm w-full" id="economyCurrent"></select>

          <div class="text-[15px] text-gray-600 font-semibold self-center">ëª©í‘œ</div>
          <select class="border rounded p-2 text-sm w-full" id="economyTarget"></select>
        </div>
        <button type="button"
          class="w-full add-btn mt-3 bg-gray-200 text-sm px-3 py-2 rounded hover:bg-blue-300"
          data-section="economy">ì¶”ê°€</button>
      </div>

      <!-- ë°œì „ -->
      <div class="bg-white border rounded-xl shadow-sm p-3">
        <h2 class="text-base font-bold text-purple-700 mb-2">[ë°œì „]</h2>
        <div class="grid grid-cols-[64px_1fr] gap-x-3 gap-y-2">
          <div class="text-[15px] text-gray-600 font-semibold self-center">ì—°êµ¬í•­ëª©</div>
          <select class="border rounded p-2 text-sm w-full" id="growthType"></select>

          <div class="text-[15px] text-gray-600 font-semibold self-center">í˜„ì¬</div>
          <select class="border rounded p-2 text-sm w-full" id="growthCurrent"></select>

          <div class="text-[15px] text-gray-600 font-semibold self-center">ëª©í‘œ</div>
          <select class="border rounded p-2 text-sm w-full" id="growthTarget"></select>
        </div>
        <button type="button"
          class="w-full add-btn mt-3 bg-gray-200 text-sm px-3 py-2 rounded hover:bg-blue-300"
          data-section="growth">ì¶”ê°€</button>
      </div>
    </div>

    <!-- ì¢Œ: ì„ íƒëª©ë¡ / ìš°: ê²°ê³¼ -->
    <div class="grid md:grid-cols-2 gap-3">
      <div class="bg-white border rounded-xl shadow-sm p-3" id="addedList">
        <div class="flex justify-between items-center mb-2">
          <h2 class="text-base font-bold text-gray-700">ğŸ“‹ ì„ íƒëœ ì—°êµ¬ ëª©ë¡</h2>
          <div class="flex gap-x-2">
            <button id="calculateFromList" class="text-blue-500 text-sm hover:underline">ğŸ“Š ê³„ì‚°í•˜ê¸°</button>
            <button id="clearList" class="text-sm text-red-600 hover:underline">ğŸ§¹ ëª©ë¡ ì´ˆê¸°í™”</button>
          </div>
        </div>
        <div class="space-y-1 text-sm" id="listContainer"></div>
      </div>

      <div class="bg-white border rounded-xl shadow-sm p-3" id="resultCard">
        <div class="flex items-center justify-between">
          <h2 class="text-base font-bold text-gray-700">ğŸ“ˆ ê³„ì‚° ê²°ê³¼</h2>
        </div>
        <div id="resultContainer" class="mt-2 overflow-auto">
          <div class="text-sm text-gray-500">í•­ëª©ì„ ì¶”ê°€í•˜ê³  <span class="font-semibold">[ğŸ“Š ê³„ì‚°í•˜ê¸°]</span>ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
        </div>
      </div>
    </div>
  </div>
	
	<!-- âœ… ê³µí†µ í•¨ìˆ˜ -->
  <script>
    function sendHeightToParent() {
      const height = document.body.scrollHeight;
      window.parent.postMessage({ type: "FRAME_CHANGE", height }, "*");
    }
    window.addEventListener("load", () => setTimeout(sendHeightToParent, 120));

    function setupMutualExclusionCheckboxes(id1, id2) {
      const a = document.getElementById(id1);
      const b = document.getElementById(id2);
      a.addEventListener("change", () => { if (a.checked) b.checked = false; });
      b.addEventListener("change", () => { if (b.checked) a.checked = false; });
    }

    function setupAutoTargetLevel(currentId, targetId) {
      document.getElementById(currentId).addEventListener("change", () => {
        const currentVal = parseInt(document.getElementById(currentId).value, 10);
        const targetSelect = document.getElementById(targetId);
        const options = Array.from(targetSelect.options).map(opt => parseInt(opt.value, 10));
        const nextVal = options.find(val => val > currentVal);
        if (nextVal !== undefined) targetSelect.value = nextVal;
      });
    }

    function fetchResearchCSV(url, typeId, currentId, targetId) {
      const map = new Map();
      const selectType = document.getElementById(typeId);
      const selectCurrent = document.getElementById(currentId);
      const selectTarget = document.getElementById(targetId);

      fetch(url)
        .then(res => res.text())
        .then(text => {
          const lines = text.split("\n").map(l => l.trim()).filter(Boolean);
          const nameIdx = lines[0].split(",").indexOf("ì—°êµ¬");
          for (let i = 1; i < lines.length; i++) {
            const cols = lines[i].split(",");
            const fullName = cols[nameIdx];
            if (!fullName || !fullName.includes("-")) continue;
            const [type, levelStr] = fullName.split("-");
            const level = parseInt(levelStr, 10);
            if (!map.has(type)) map.set(type, []);
            const levels = map.get(type);
            if (!levels.includes(level)) levels.push(level);
          }

          selectType.innerHTML = "";
          Array.from(map.keys()).forEach(type => selectType.appendChild(new Option(type, type)));

          function fillLevels() {
            const levels = (map.get(selectType.value) || []).sort((a,b)=>a-b);
            selectCurrent.innerHTML = "";
            selectTarget.innerHTML = "";
            levels.forEach(lv => {
              selectCurrent.appendChild(new Option(lv, lv));
              selectTarget.appendChild(new Option(lv, lv));
            });
          }
          selectType.addEventListener("change", fillLevels);
          selectType.dispatchEvent(new Event("change"));
        });
    }

    function cleanInt(str) {
      return parseInt((str || "0").replace(/,/g, ""), 10) || 0;
    }

    function formatResource(value) {
      if (value >= 1_000_000_000) return (value/1_000_000_000).toFixed(2).replace(/\.00$/,'')+'B';
      if (value >= 1_000_000)     return (value/1_000_000).toFixed(2).replace(/\.00$/,'')+'M';
      if (value >= 1_000)         return value.toLocaleString();
      return value.toString();
    }

    function parseTimeToSeconds(timeStr) {
      const [d, hms] = timeStr.split(" ");
      const [h, m, s] = (hms || "00:00:00").split(":").map(Number);
      return (parseInt(d)||0)*86400 + (h||0)*3600 + (m||0)*60 + (s||0);
    }

    function formatTime(sec) {
      sec = Math.max(0, Math.round(sec));
      const d = Math.floor(sec/86400); sec%=86400;
      const h = Math.floor(sec/3600);  sec%=3600;
      const m = Math.floor(sec/60);
      const s = sec%60;
      return `${d}d ${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }

    document.addEventListener("DOMContentLoaded", () => {
      setupMutualExclusionCheckboxes("chkVP10","chkVP15");
    });
  </script>

  <!-- âœ… ë°ì´í„° ë°”ì¸ë”© -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      fetchResearchCSV(
        "https://raw.githubusercontent.com/s574shinchan/WOS_Calc/refs/heads/main/data/research/Battle.csv",
        "researchType","currentLevel","targetLevel"
      );
      setupAutoTargetLevel("currentLevel","targetLevel");

      fetchResearchCSV(
        "https://raw.githubusercontent.com/s574shinchan/WOS_Calc/refs/heads/main/data/research/Economy.csv",
        "economyType","economyCurrent","economyTarget"
      );
      setupAutoTargetLevel("economyCurrent","economyTarget");

      fetchResearchCSV(
        "https://raw.githubusercontent.com/s574shinchan/WOS_Calc/refs/heads/main/data/research/Growth.csv",
        "growthType","growthCurrent","growthTarget"
      );
      setupAutoTargetLevel("growthCurrent","growthTarget");
    });
  </script>

	<!-- âœ… ëª©ë¡/ê³„ì‚°/ê²°ê³¼ -->
  <script>
		document.addEventListener("DOMContentLoaded", () => {
      // í•­ëª© ì¶”ê°€
      document.querySelectorAll(".add-btn").forEach(button => {
        button.addEventListener("click", () => {
          const section = button.dataset.section;
          let typeSelect, currentSelect, targetSelect, sectionLabel;

          if (section === "battle") {
            typeSelect = document.getElementById("researchType");
            currentSelect = document.getElementById("currentLevel");
            targetSelect = document.getElementById("targetLevel");
            sectionLabel = "ì „íˆ¬";
          } else if (section === "economy") {
            typeSelect = document.getElementById("economyType");
            currentSelect = document.getElementById("economyCurrent");
            targetSelect = document.getElementById("economyTarget");
            sectionLabel = "ê²½ì œ";
          } else if (section === "growth") {
            typeSelect = document.getElementById("growthType");
            currentSelect = document.getElementById("growthCurrent");
            targetSelect = document.getElementById("growthTarget");
            sectionLabel = "ë°œì „";
          } else return;

          const type = typeSelect.value;
          const current = currentSelect.value;
          const target = targetSelect.value;

          if (!type || !current || !target || parseInt(current) >= parseInt(target)) {
            alert("ìœ íš¨í•œ ì—°êµ¬ í•­ëª©ê³¼ ë ˆë²¨ì„ ì„ íƒí•˜ì„¸ìš”.");
            return;
          }

          // ì¤‘ë³µ ë°©ì§€
          const exists = Array.from(document.querySelectorAll("#listContainer span"))
            .some(el => el.textContent === `[${sectionLabel}] ${type} : ${current} â†’ ${target}`);
          if (exists) { alert("ì´ë¯¸ ì¶”ê°€ëœ í•­ëª©ì…ë‹ˆë‹¤."); return; }

          const row = document.createElement("div");
          // âœ… ë°°ê²½ ì œê±°
          row.className = "flex justify-between items-center p-2 rounded border";
          row.innerHTML = `
            <span class="font-semibold">[${sectionLabel}] ${type} : ${current} â†’ ${target}</span>
            <button class="text-xs text-red-500 hover:underline remove-btn">ì‚­ì œ</button>
          `;
          document.getElementById("listContainer").appendChild(row);

          row.querySelector(".remove-btn").addEventListener("click", () => {
            row.remove();
            sendHeightToParent();
          });

          sendHeightToParent();
        });
      });

      // ì´ˆê¸°í™”
      document.getElementById("clearList").addEventListener("click", () => {
        document.getElementById("listContainer").innerHTML = "";
        document.getElementById("resultContainer").innerHTML =
          `<div class="text-sm text-gray-500">í•­ëª©ì„ ì¶”ê°€í•˜ê³  <span class="font-semibold">[ğŸ“Š ê³„ì‚°í•˜ê¸°]</span>ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>`;
        sendHeightToParent();
      });

      // ê³„ì‚°
      document.getElementById("calculateFromList").addEventListener("click", () => {
        const rows = document.querySelectorAll("#listContainer div");
        if (!rows.length) { alert("ê³„ì‚°í•  ì—°êµ¬ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤."); return; }

        let total = { ê³ ê¸°:0, ëª©ì¬:0, ì„íƒ„:0, ì² ê´‘:0, ì² ê°•ì¬:0, ì‹œê°„:0 };
        const tasks = [];

        // ì†ë„(ì‹œê°„ ë‹¨ì¶•) ê³„ìˆ˜
        let factor = (parseFloat(document.getElementById("speedPercent").value) || 0) * 0.01 + 1;
        if (document.getElementById("chkVP10").checked) factor += 0.10;
        if (document.getElementById("chkVP15").checked) factor += 0.15;
        if (document.getElementById("chkServerBuff").checked) factor += 0.10;

        rows.forEach(row => {
          const text = row.querySelector("span")?.textContent || "";
          const m = text.match(/\[(.*?)\]\s(.*?)\s:\s(\d+)\sâ†’\s(\d+)/);
          if (!m) return;
          const [, section, type, start, end] = m;
          const s = parseInt(start), e = parseInt(end);

          const urlMap = { "ì „íˆ¬":"Battle.csv", "ê²½ì œ":"Economy.csv", "ë°œì „":"Growth.csv" };
          const url = `https://raw.githubusercontent.com/s574shinchan/WOS_Calc/refs/heads/main/data/research/${urlMap[section]}`;

          tasks.push(

            fetch(url).then(res=>res.text()).then(text=>{
              const lines = text.split("\n").map(l=>l.trim()).filter(Boolean);
              const headers = lines[0].split(",");
              const idx = {
                ì—°êµ¬: headers.indexOf("ì—°êµ¬"),
                ê³ ê¸°: headers.indexOf("ê³ ê¸°"),
                ëª©ì¬: headers.indexOf("ëª©ì¬"),
                ì„íƒ„: headers.indexOf("ì„íƒ„"),
                ì² ê´‘: headers.indexOf("ì² ê´‘"),
                ì² ê°•ì¬: headers.indexOf("ì² ê°•ì¬"),
                ì‹œê°„: headers.indexOf("ì‹œê°„")
              };

              let sum = { ê³ ê¸°:0, ëª©ì¬:0, ì„íƒ„:0, ì² ê´‘:0, ì² ê°•ì¬:0, ì‹œê°„:0 };

              for (let i=1;i<lines.length;i++){
                const cols = lines[i].split(",");
                const name = cols[idx.ì—°êµ¬];
                if (!name) continue;
                const m2 = name.match(/^(.*)-(\d+)$/);
                if (!m2) continue;
                const fullType = m2[1];
                const level = parseInt(m2[2],10);
                if (fullType !== type) continue;
                if (level > s && level <= e){
                  sum.ê³ ê¸° += cleanInt(cols[idx.ê³ ê¸°])||0;
                  sum.ëª©ì¬ += cleanInt(cols[idx.ëª©ì¬])||0;
                  sum.ì„íƒ„ += cleanInt(cols[idx.ì„íƒ„])||0;
                  sum.ì² ê´‘ += cleanInt(cols[idx.ì² ê´‘])||0;
                  sum.ì² ê°•ì¬ += cleanInt(cols[idx.ì² ê°•ì¬])||0;
                  sum.ì‹œê°„ += parseTimeToSeconds(cols[idx.ì‹œê°„]);
                }
              }

              total.ê³ ê¸° += sum.ê³ ê¸°;
              total.ëª©ì¬ += sum.ëª©ì¬;
              total.ì„íƒ„ += sum.ì„íƒ„;
              total.ì² ê´‘ += sum.ì² ê´‘;
              total.ì² ê°•ì¬ += sum.ì² ê°•ì¬;
              total.ì‹œê°„ += sum.ì‹œê°„;

              return `
                <tr class="bg-white">
                  <td class="border p-1 font-medium">${type}</td>
                  <td class="border p-1">${s} â†’ ${e}</td>
                  <td class="border p-1">${formatResource(sum.ê³ ê¸°)}</td>
                  <td class="border p-1">${formatResource(sum.ëª©ì¬)}</td>
                  <td class="border p-1">${formatResource(sum.ì„íƒ„)}</td>
                  <td class="border p-1">${formatResource(sum.ì² ê´‘)}</td>
                  <td class="border p-1">${formatResource(sum.ì² ê°•ì¬)}</td>
                  <td class="border p-1">${formatTime(sum.ì‹œê°„)}</td>
                  <td class="border p-1">${formatTime(Math.round(sum.ì‹œê°„ / factor))}</td>
                </tr>`;
            })
          );
        });

        Promise.all(tasks).then(tableRows => {
          const html = `
            <table class="w-full border text-sm text-center table-auto">
              <thead class="bg-blue-100">
                <tr>
                  <th class="border p-1">ì—°êµ¬í•­ëª©</th>
                  <th class="border p-1">ë ˆë²¨</th>
                  <th class="border p-1">ê³ ê¸°</th>
                  <th class="border p-1">ëª©ì¬</th>
                  <th class="border p-1">ì„íƒ„</th>
                  <th class="border p-1">ì² ê´‘</th>
                  <th class="border p-1">ì² ê°•ì¬</th>
                  <th class="border p-1">ì—°êµ¬ì‹œê°„</th>
                  <th class="border p-1">ì ìš©ì‹œê°„</th>
                </tr>
              </thead>
              <tbody>${tableRows.join("")}</tbody>
              <tfoot class="bg-gray-100 font-semibold">
                <tr>
                  <td class="border p-1" colspan="2">ì´í•©</td>
                  <td class="border p-1">${formatResource(total.ê³ ê¸°)}</td>
                  <td class="border p-1">${formatResource(total.ëª©ì¬)}</td>
                  <td class="border p-1">${formatResource(total.ì„íƒ„)}</td>
                  <td class="border p-1">${formatResource(total.ì² ê´‘)}</td>
                  <td class="border p-1">${formatResource(total.ì² ê°•ì¬)}</td>
                  <td class="border p-1">${formatTime(total.ì‹œê°„)}</td>
                  <td class="border p-1">${formatTime(Math.round(total.ì‹œê°„ / factor))}</td>
                </tr>
              </tfoot>
            </table>
          `;
          document.getElementById("resultContainer").innerHTML = html;
          sendHeightToParent();
        });
      });
    });
  </script>
	
	<script>
    function sendHeightToParent() {
      const height = document.body.scrollHeight + 10;
      window.parent.postMessage({ type: "FRAME_CHANGE", height }, "*");
    }
    
    // í˜ì´ì§€ ìµœì´ˆ ë¡œë“œ ì‹œ
    window.addEventListener("load", () => {
      setTimeout(sendHeightToParent, 100); // ì•½ê°„ì˜ ë Œë”ë§ ëŒ€ê¸°
    });
    
    function loadPage(page) {
      const isMobile = window.innerWidth <= 768;
      const height = isMobile ? "550px" : "345px"
        window.location.href = page;
      window.parent.postMessage({ type: "SET_FRAME_SIZE", height: height, width: "100%"}, "*");
    }
  </script>
  
	<!-- ìš°í´ë¦­/ë‹¨ì¶•í‚¤ ì œí•œ (ê¸°ì¡´ ìœ ì§€) -->
  <script>
    document.addEventListener("contextmenu", e => e.preventDefault());
    document.addEventListener("keydown", function (e) {
      if (e.key === "F12" ||
          (e.ctrlKey && e.shiftKey && (e.key === "I" || e.key === "J")) ||
          (e.ctrlKey && (e.key === "U" || e.key === "S"))) {
        e.preventDefault();
      }
    });
  </script>
</body>
</html>
