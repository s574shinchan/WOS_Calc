<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì—°êµ¬ ê³„ì‚°ê¸°</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-2 text-sm font-sans">
  <div class="max-w-5xl mx-auto bg-white p-2 rounded-xl shadow-md">
    <button onclick="loadPage('menu.html')" class="mb-4 flex items-center text-blue-600 hover:underline text-sm">
      <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
      </svg>
      ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°
    </button>
    <h1 class="text-2xl font-bold text-gray-800 mb-4">ğŸ§ª í—¬ë¦¬ì˜¤ìŠ¤ ê³„ì‚°ê¸°</h1>
    <form id="researchForm" class="space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="researchCards"></div>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 pt-4">
        <div><label class="block font-semibold text-gray-700">ë³´ìœ  ë¶ˆìˆ˜ê°€ë£¨</label>
          <input type="number" id="owned-ë¶ˆìˆ˜ê°€ë£¨" class="w-full border rounded p-2" value="0" />
        </div>
        <div><label class="block font-semibold text-gray-700">ë³´ìœ  ì² ê°•ì¬</label>
          <input type="number" id="owned-ì² ê°•ì¬" class="w-full border rounded p-2" value="0" />
        </div>
      </div>
        <button type="button" onclick="calcResearch()" class="w-full bg-orange-500 text-white py-2 rounded hover:bg-orange-600">ê³„ì‚°í•˜ê¸°</button>
      </div>
    </form>
  </div>

  <script>
    function loadPage(page) {
        window.location.href = page;
        window.parent.postMessage({ type: "SET_FRAME_SIZE", height: "550px", width: "100%"}, "*");
    }

    const researchList = [
      { key: 'I', label: 'ì—°êµ¬ I', max: 5 },
      { key: 'II-A', label: 'ì—°êµ¬ II (1)', max: 8 },
      { key: 'II-B', label: 'ì—°êµ¬ II (2)', max: 8 },
      { key: 'III', label: 'ì—°êµ¬ III', max: 12 },
      { key: 'IV-A', label: 'ì—°êµ¬ IV (1)', max: 12 },
      { key: 'IV-B', label: 'ì—°êµ¬ IV (2)', max: 12 },
      { key: 'V', label: 'ì—°êµ¬ V', max: 12 },
      { key: 'Healing', label: 'ì¹˜ìœ  ì—°êµ¬', max: 10 },
      { key: 'Training', label: 'í›ˆë ¨ ì—°êµ¬', max: 10 },
      { key: 'HealingTime', label: 'ì¹˜ìœ ì‹œê°„ ì—°êµ¬', max: 10 }
    ];

    const columnMap = {
      I: { red: 1, black: 2 }, 
      "II-A": { red: 3, black: 4 }, 
      "II-B": { red: 3, black: 4 },
      III: { red: 5, black: 6 },
      "IV-A": { red: 7, black: 8 }, 
      "IV-B": { red: 7, black: 8 },
      V: { red: 9, black: 10 },
      Healing: { red: 12, black: 13 },
      Training: { red: 14, black: 15 },
      HealingTime: { red: 16, black: 17 }
    };

    function generateOptions(min, max) {
      return Array.from({ length: max - min + 1 }, (_, i) => {
        const lv = i + min;
        return `<option value="${lv}">Lv.${lv}</option>`;
      }).join('');
    }

    function renderResearchCards() {
      const container = document.getElementById("researchCards");
      researchList.forEach((item, idx) => {
        container.innerHTML += `
          <div class="bg-orange-50 border rounded p-2 space-y-2">
            <label class="inline-flex items-center space-x-2 font-bold text-gray-700">
              <input type="checkbox" id="check-${item.key}" class="mr-1 w-4 h-4 accent-orange-500" />
              <span>${item.label}</span>
            </label>
            <div class="flex items-center gap-2">
              <label for="start-${item.key}" class="text-sm whitespace-nowrap">í˜„ì¬</label>
              <select class="flex-1 border rounded p-1" id="start-${item.key}">
                ${generateOptions(1, item.max - 1)}
              </select>
            </div>
            <div class="flex items-center gap-2">
              <label for="end-${item.key}" class="text-sm whitespace-nowrap">ëª©í‘œ</label>
              <select class="flex-1 border rounded p-1" id="end-${item.key}">
                ${generateOptions(2, item.max)}
              </select>
            </div>
          </div>
        `;
      });
    }

    async function fetchCSV(url) {
      const res = await fetch(url);
      const text = await res.text();
      return text.trim().split("\n").map(row => row.split(","));
    }

    async function calcResearch() {
      const data = await fetchCSV("https://raw.githubusercontent.com/s574shinchan/WOS_Calc/1e960927a7b4db6971bcb03227b5fa351ee9d04a/data/research_data.csv");

      let total = { "ë¶ˆìˆ˜ê°€ë£¨": 0, "ì² ê°•ì¬": 0 };
      let result = `
          <table class="w-full border text-sm text-center table-auto mt-4">
            <thead class="bg-orange-100">
              <tr>
                <th class="border p-1">í•­ëª©</th>
                <th class="border p-1">ë ˆë²¨</th>
                <th class="border p-1">ë¶ˆìˆ˜ê°€ë£¨</th>
                <th class="border p-1">ì² ê°•ì¬</th>
              </tr>
            </thead>
            <tbody>
        `;

      researchList.forEach(item => {
        if (!document.getElementById(`check-${item.key}`).checked) 
          return;
        
        const start = parseInt(document.getElementById(`start-${item.key}`).value);
        const end = parseInt(document.getElementById(`end-${item.key}`).value);
        const col = columnMap[item.key];

        let subtotal = { "ë¶ˆìˆ˜ê°€ë£¨": 0, "ì² ê°•ì¬": 0 };
        for (let i = start - 1; i < end - 1; i++) {
          const row = data[i + 1];
          if (!row) continue;
          subtotal["ë¶ˆìˆ˜ê°€ë£¨"] += parseInt(row[col.red]?.replace(/,/g, "") || 0);
          subtotal["ì² ê°•ì¬"] += parseInt(row[col.black]?.replace(/,/g, "") || 0);
        }

        total["ë¶ˆìˆ˜ê°€ë£¨"] += subtotal["ë¶ˆìˆ˜ê°€ë£¨"];
        total["ì² ê°•ì¬"] += subtotal["ì² ê°•ì¬"];

        row += `
        <tr class="text-center">
        <td class="border p-1">${item.label}</td>
        <td class="border p-1">${start} â†’ ${end}</td>
        <td class="border p-1">${subtotal.ë¶ˆìˆ˜ê°€ë£¨.toLocaleString()}</td>
        <td class="border p-1">${subtotal.ì² ê°•ì¬.toLocaleString()}</td>
        </tr>`;
      });

      const owned = {
        "ë¶ˆìˆ˜ê°€ë£¨": parseInt(document.getElementById("owned-ë¶ˆìˆ˜ê°€ë£¨").value || 0),
        "ì² ê°•ì¬": parseInt(document.getElementById("owned-ì² ê°•ì¬").value || 0)
      };

      result += `
        <tr class="bg-blue-50 font-bold">
          <td class="border p-1" colspan="2">ì´í•©</td>
          <td class="border p-1">${total["ë¶ˆìˆ˜ê°€ë£¨"].toLocaleString()}</td>
          <td class="border p-1">${total["ì² ê°•ì¬"].toLocaleString()}</td>
        </tr>
        <tr class="text-center font-bold bg-red-50">
          <td class="border p-1" colspan="2">ê³¼ë¶€ì¡±</td>
          <td class="border p-1">${(owned["ë¶ˆìˆ˜ê°€ë£¨"] - total["ë¶ˆìˆ˜ê°€ë£¨"]).toLocaleString()}</td>
          <td class="border p-1">${(owned["ì² ê°•ì¬"] - total["ì² ê°•ì¬"]).toLocaleString()}</td>
        </tr>
        </tbody></table>`;
      
      const resultHTML = `
      <table class="w-full table-auto border mt-4 text-sm text-center">
      <thead class="bg-gray-100">
      <tr>
      <th class="border p-1">í•­ëª©</th>
      <th class="border p-1">ë ˆë²¨</th>
      <th class="border p-1">ë¶ˆìˆ˜ê°€ë£¨</th>
      <th class="border p-1">ì² ê°•ì¬</th>
      </tr>
      </thead>
      <tbody>${rows}</tbody>
      </table>
      `;
      
      window.parent.postMessage({ type: "RESULT_POPUP", html: resultHTML }, "*");
    }

    renderResearchCards();
  </script>
</body>
</html>
