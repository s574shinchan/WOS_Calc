<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ¤ª ì—°êµ¬ ê³„ì‚°ê¸°</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4 font-sans text-sm">
  <div class="max-w-6xl mx-auto bg-white p-4 rounded-xl shadow-md">
    <h1 class="text-2xl font-bold text-gray-800 mb-6">ğŸ¤ª ì—°êµ¬ ê³„ì‚°ê¸°</h1>

    <!-- ì—°êµ¬ì†ë„ ì„¤ì • -->
    <div class="grid grid-cols-2 md:flex md:flex-wrap md:items-center gap-4">
        <label class="inline-flex items-center font-semibold">
          <input type="checkbox" id="chkVP10" class="mr-2 w-4 h-4">ì¼ë°˜)ë¶€ì§‘í–‰ê´€ (10%)
        </label>
        <label class="inline-flex items-center font-semibold">
          <input type="checkbox" id="chkVP15" class="mr-2 w-4 h-4">ìµœì§‘)ë¶€ì§‘í–‰ê´€ (15%)
        </label>
        <label class="inline-flex items-center font-semibold">
          <input type="checkbox" id="chkServerBuff" class="mr-2 w-4 h-4">ì—°êµ¬ì„œë²„ë²„í”„ (10%)
        </label>
        <div class="flex items-center gap-2">
          <label for="speedPercent" class="font-semibold whitespace-nowrap">ì—°êµ¬ì†ë„ (%)</label>
          <input type="number" id="speedPercent" class="border rounded p-2 text-sm w-24 text-right" placeholder="0" min="0" />
        </div>
      </div>

    <!-- ì „íˆ¬ ì„¹ì…˜ -->
    <div class="mb-4">
      <h2 class="text-lg font-bold text-blue-700 mb-2">[ì „íˆ¬]</h2>
      <div class="grid grid-cols-3 gap-4 mb-1 text-xs text-gray-600 font-semibold">
        <label>ì—°êµ¬í•­ëª©</label><label>í˜„ì¬</label><label>ëª©í‘œ</label>
      </div>
      <div class="grid grid-cols-3 gap-4">
        <select class="border rounded p-2 text-sm" id="researchType"></select>
        <select class="border rounded p-2 text-sm" id="currentLevel"></select>
        <select class="border rounded p-2 text-sm" id="targetLevel"></select>
      </div>
      <div class="mt-2">
        <button type="button" class="w-full add-btn bg-gray-200 text-sm px-3 py-1 rounded hover:bg-gray-300" data-section="battle">ì¶”ê°€</button>
      </div>
    </div>

    <!-- ê²½ì œ ì„¹ì…˜ -->
    <div class="mb-4">
      <h2 class="text-lg font-bold text-green-700 mb-2">[ê²½ì œ]</h2>
      <div class="grid grid-cols-3 gap-4 mb-1 text-xs text-gray-600 font-semibold">
        <label>ì—°êµ¬í•­ëª©</label><label>í˜„ì¬</label><label>ëª©í‘œ</label>
      </div>
      <div class="grid grid-cols-3 gap-4">
        <select class="border rounded p-2 text-sm" id="economy-type"></select>
        <select class="border rounded p-2 text-sm" id="economy-current"></select>
        <select class="border rounded p-2 text-sm" id="economy-target"></select>
      </div>
      <div class="mt-2">
        <button type="button" class="w-full add-btn bg-gray-200 text-sm px-3 py-1 rounded hover:bg-gray-300" data-section="economy">ì¶”ê°€</button>
      </div>
    </div>

    <!-- ë°œì „ ì„¹ì…˜ -->
    <div class="mb-4">
      <h2 class="text-lg font-bold text-purple-700 mb-2">[ë°œì „]</h2>
      <div class="grid grid-cols-3 gap-4 mb-1 text-xs text-gray-600 font-semibold">
        <label>ì—°êµ¬í•­ëª©</label><label>í˜„ì¬</label><label>ëª©í‘œ</label>
      </div>
      <div class="grid grid-cols-3 gap-4">
        <select class="border rounded p-2 text-sm" id="growth-type"></select>
        <select class="border rounded p-2 text-sm" id="growth-current"></select>
        <select class="border rounded p-2 text-sm" id="growth-target"></select>
      </div>
      <div class="mt-2">
        <button type="button" class="w-full add-btn bg-gray-200 text-sm px-3 py-1 rounded hover:bg-gray-300" data-section="growth">ì¶”ê°€</button>
      </div>
    </div>

    <!-- ì„ íƒëœ ì—°êµ¬ ëª©ë¡ -->
    <div id="addedList" class="mt-8 bg-gray-50 border rounded p-4">
      <div class="flex justify-between items-center mb-2">
        <h2 class="text-lg font-bold text-gray-700">ğŸ“‹ ì„ íƒëœ ì—°êµ¬ ëª©ë¡</h2>
        <div class="flex gap-x-2">
          <button id="calculateFromList" class="text-blue-500 text-sm hover:underline">ğŸ“Š ê³„ì‚°í•˜ê¸°</button>
          <button id="clearList" class="text-sm text-red-600 hover:underline">ğŸ§¹ ëª©ë¡ ì´ˆê¸°í™”</button>
        </div>
      </div>
      <div class="space-y-1 text-sm mb-4" id="listContainer"></div>
    </div>
  </div>

  <script>
    function sendHeightToParent() {
      const height = document.body.scrollHeight;
      window.parent.postMessage({ type: "FRAME_CHANGE", height }, "*");
    }

    const labelMap = {
      battle: { typeId: 'researchType', currentId: 'currentLevel', targetId: 'targetLevel', name: 'ì „íˆ¬' }
    };

    document.addEventListener("DOMContentLoaded", () => {

  // ë¶€ì§‘í–‰ê´€ ì²´í¬ë°•ìŠ¤ ìƒí˜¸ ë°°ì œ
  const chkVP10 = document.getElementById("chkVP10");
  const chkVP15 = document.getElementById("chkVP15");

  chkVP10.addEventListener("change", () => {
    if (chkVP10.checked) chkVP15.checked = false;
  });

  chkVP15.addEventListener("change", () => {
    if (chkVP15.checked) chkVP10.checked = false;
  });

      document.querySelectorAll('.add-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const section = btn.dataset.section;
          const ids = labelMap[section];
          const type = document.getElementById(ids.typeId).value;
          const current = document.getElementById(ids.currentId).value;
          const target = document.getElementById(ids.targetId).value;
          const identifier = `[${labelMap[section].name}] ${type} : ${current} â†’ ${target}`;

          const exists = Array.from(document.querySelectorAll('#listContainer span'))
            .some(span => span.textContent === identifier);
          if (exists) return alert('ì´ë¯¸ ì¶”ê°€ëœ í•­ëª©ì…ë‹ˆë‹¤.');

          const wrapper = document.createElement('div');
          wrapper.className = "flex justify-between items-center bg-white border rounded p-2";

          const span = document.createElement('span');
          span.textContent = identifier;

          const delBtn = document.createElement('button');
          delBtn.textContent = 'âŒ';
          delBtn.className = "text-red-500 text-xs ml-4 hover:underline";
          delBtn.addEventListener('click', () => {
            wrapper.remove();
            sendHeightToParent();
          });

          wrapper.append(span, delBtn);
          document.getElementById('listContainer').appendChild(wrapper);
          sendHeightToParent();
        });
      });

      document.getElementById('clearList').addEventListener('click', () => {
        document.getElementById('listContainer').innerHTML = '';
        sendHeightToParent();
      });

      const csvUrl = "https://raw.githubusercontent.com/s574shinchan/WOS_Calc/refs/heads/main/data/NormalResearch(Battle).csv";
const researchData = [];
const researchLevelsMap = new Map();

function parseTimeToSeconds(timeStr) {
  if (!timeStr || !timeStr.includes(" ")) return 0;

  const [dPart, hms] = timeStr.split(" ");
  const days = parseInt(dPart.replace("d", "")) || 0;
  const [hours, minutes, seconds] = hms.split(":").map(part => parseInt(part, 10) || 0);

  return days * 86400 + hours * 3600 + minutes * 60 + seconds;
}

function populateLevelSelect(id, levels) {
  const select = document.getElementById(id);
  select.innerHTML = "";
  levels.forEach(level => {
    const opt = document.createElement("option");
    opt.value = level;
    opt.textContent = level;
    select.appendChild(opt);
  });
}

async function fetchAndProcessCSV() {
  try {
    const response = await fetch(csvUrl);
    const text = await response.text();
    const lines = text.split("\n").map(line => line.trim()).filter(line => line);
    const headers = lines[0].split(",");

    const indexMap = {
      ì—°êµ¬: headers.indexOf("ì—°êµ¬"),
      ê³ ê¸°: headers.indexOf("ê³ ê¸°"),
      ëª©ì¬: headers.indexOf("ëª©ì¬"),
      ì„íƒ„: headers.indexOf("ì„íƒ„"),
      ì² ê´‘: headers.indexOf("ì² ê´‘"),
      ì² ê°•ì¬: headers.indexOf("ì² ê°•ì¬"),
      ì‹œê°„: headers.indexOf("ì‹œê°„"),
    };

    for (let i = 1; i < lines.length; i++) {
      const cols = lines[i].split(",");
      const name = cols[indexMap.ì—°êµ¬];
      if (!name || !name.includes("-")) continue;

      const [type, levelStr] = name.split("-");
      const level = parseInt(levelStr, 10);
      if (isNaN(level)) continue;

      researchData.push({
        name, type, level,
        ê³ ê¸°: parseInt(cols[indexMap.ê³ ê¸°]) || 0,
        ëª©ì¬: parseInt(cols[indexMap.ëª©ì¬]) || 0,
        ì„íƒ„: parseInt(cols[indexMap.ì„íƒ„]) || 0,
        ì² ê´‘: parseInt(cols[indexMap.ì² ê´‘]) || 0,
        ì² ê°•ì¬: parseInt(cols[indexMap.ì² ê°•ì¬]) || 0,
        ì‹œê°„: parseTimeToSeconds(cols[indexMap.ì‹œê°„]) || 0,
      });

      if (!researchLevelsMap.has(type)) researchLevelsMap.set(type, []);
      const levels = researchLevelsMap.get(type);
      if (!levels.includes(level)) levels.push(level);
    }

    const researchTypeSelect = document.getElementById("researchType");
    researchTypeSelect.innerHTML = "";

    for (const [type] of researchLevelsMap) {
      const opt = document.createElement("option");
      opt.value = type;
      opt.textContent = type;
      researchTypeSelect.appendChild(opt);
    }

   document.getElementById("currentLevel").addEventListener("change", () => {
  const currentVal = parseInt(document.getElementById("currentLevel").value, 10);
  const targetSelect = document.getElementById("targetLevel");
  const options = Array.from(targetSelect.options).map(opt => parseInt(opt.value, 10));
  const nextVal = options.find(val => val > currentVal);
  if (nextVal !== undefined) {
    targetSelect.value = nextVal;
  }
});

    researchTypeSelect.addEventListener("change", () => {
      const selected = researchTypeSelect.value;
      const levels = (researchLevelsMap.get(selected) || []).sort((a, b) => a - b);
      populateLevelSelect("currentLevel", levels);
      populateLevelSelect("targetLevel", levels);
    });

    researchTypeSelect.dispatchEvent(new Event("change"));

  } catch (error) {
    console.error("CSV ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
  }
}

fetchAndProcessCSV();

      document.getElementById("calculateFromList").addEventListener("click", () => {
        const rows = document.querySelectorAll("#listContainer div");
        const resultRows = [];
        let total = { ê³ ê¸°: 0, ëª©ì¬: 0, ì„íƒ„: 0, ì² ê´‘: 0, ì² ê°•ì¬: 0, ì‹œê°„: 0 };

        let reductionFactor = (parseFloat(document.getElementById("speedPercent").value) || 0) * 0.01 + 1;
        if (document.getElementById("chkVP10").checked) reductionFactor += 0.10;
        if (document.getElementById("chkVP15").checked) reductionFactor += 0.15;
        if (document.getElementById("chkServerBuff").checked) reductionFactor += 0.10;

        rows.forEach(row => {
          const text = row.querySelector("span")?.textContent || "";
          const match = text.match(/\[(.*?)\]\s(.*?)\s:\s(\d+)\sâ†’\s(\d+)/);
          if (!match) return;
          const [, , type, start, end] = match;
          const s = parseInt(start), e = parseInt(end);

          const items = researchData.filter(d => d.type === type && d.level > s && d.level <= e);
          let sub = { ê³ ê¸°: 0, ëª©ì¬: 0, ì„íƒ„: 0, ì² ê´‘: 0, ì² ê°•ì¬: 0, ì‹œê°„: 0 };
          items.forEach(i => {
            sub.ê³ ê¸° += i.ê³ ê¸°;
            sub.ëª©ì¬ += i.ëª©ì¬;
            sub.ì„íƒ„ += i.ì„íƒ„;
            sub.ì² ê´‘ += i.ì² ê´‘;
            sub.ì² ê°•ì¬ += i.ì² ê°•ì¬;
            sub.ì‹œê°„ += i.ì‹œê°„;
            total.ê³ ê¸° += i.ê³ ê¸°;
            total.ëª©ì¬ += i.ëª©ì¬;
            total.ì„íƒ„ += i.ì„íƒ„;
            total.ì² ê´‘ += i.ì² ê´‘;
            total.ì² ê°•ì¬ += i.ì² ê°•ì¬;
            total.ì‹œê°„ += i.ì‹œê°„;
          });

          resultRows.push(`
            <tr class="bg-white">
              <td class="border p-1 font-medium">${type}</td>
              <td class="border p-1">${s} â†’ ${e}</td>
              <td class="border p-1">${formatResource(sub.ê³ ê¸°)}</td>
              <td class="border p-1">${formatResource(sub.ëª©ì¬)}</td>
              <td class="border p-1">${formatResource(sub.ì„íƒ„)}</td>
              <td class="border p-1">${formatResource(sub.ì² ê´‘)}</td>
              <td class="border p-1">${formatResource(sub.ì² ê°•ì¬)}</td>
              <td class="border p-1">${formatTime(sub.ì‹œê°„)}</td>
              <td class="border p-1">${formatTime(Math.round(sub.ì‹œê°„ / reductionFactor))}</td>
            </tr>
          `);
        });

        if (!resultRows.length) return alert("ê³„ì‚°í•  ì—°êµ¬ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.");

        const resultHTML = `
          <table class="w-full border text-sm text-center table-auto">
            <thead class="bg-blue-100">
              <tr>
                <th class="border p-1">ì—°êµ¬í•­ëª©</th>
                <th class="border p-1">ë ˆë²¨</th>
                <th class="border p-1">ê³ ê¸°</th>
                <th class="border p-1">ëª©ì¬</th>
                <th class="border p-1">ì„íƒ„</th>
                <th class="border p-1">ì² ê´‘</th>
                <th class="border p-1">ì² ê°•ì¬</th>
                <th class="border p-1">ì—°êµ¬ì‹œê°„</th>
                <th class="border p-1">ì ìš©ì‹œê°„</th>
              </tr>
            </thead>
            <tbody>${resultRows.join("")}</tbody>
            <tfoot class="bg-gray-100 font-semibold">
              <tr>
                <td class="border p-1" colspan="2">ì´í•©</td>
                <td class="border p-1">${formatResource(total.ê³ ê¸°)}</td>
                <td class="border p-1">${formatResource(total.ëª©ì¬)}</td>
                <td class="border p-1">${formatResource(total.ì„íƒ„)}</td>
                <td class="border p-1">${formatResource(total.ì² ê´‘)}</td>
                <td class="border p-1">${formatResource(total.ì² ê°•ì¬)}</td>
                <td class="border p-1">${formatTime(total.ì‹œê°„)}</td>
                <td class="border p-1">${formatTime(Math.round(total.ì‹œê°„ / reductionFactor))}</td>
              </tr>
            </tfoot>
          </table>`;

        window.parent.postMessage({ type: "RESULT_POPUP", html: resultHTML }, "*");
      });

function formatResource(value) {
  if (value >= 1_000_000_000) {
    return (value / 1_000_000_000).toFixed(2).replace(/\.00$/, '') + 'B';
  } else if (value >= 1_000_000) {
    return (value / 1_000_000).toFixed(2).replace(/\.00$/, '') + 'M';
  } else if (value >= 1_000) {
    return value.toLocaleString();
  } else {
    return value.toString();
  }
}

      function formatTime(sec) {
        const d = Math.floor(sec / 86400);
        sec %= 86400;
        const h = Math.floor(sec / 3600);
        sec %= 3600;
        const m = Math.floor(sec / 60);
        const s = sec % 60;
        return `${d}d ${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
      }

      window.addEventListener("load", () => {
        setTimeout(sendHeightToParent, 100);
      });
    });
  </script>
  <script>
    function sendHeightToParent() {
      const height = document.body.scrollHeight;
      window.parent.postMessage({ type: "FRAME_CHANGE", height }, "*");
    }
    
    // í˜ì´ì§€ ìµœì´ˆ ë¡œë“œ ì‹œ
    window.addEventListener("load", () => {
      setTimeout(sendHeightToParent, 100); // ì•½ê°„ì˜ ë Œë”ë§ ëŒ€ê¸°
    });
    
    function loadPage(page) {
      const isMobile = window.innerWidth <= 768;
      const height = isMobile ? "550px" : "345px"
        window.location.href = page;
      window.parent.postMessage({ type: "SET_FRAME_SIZE", height: height, width: "100%"}, "*");
    }
  </script>
</body>
</html>
