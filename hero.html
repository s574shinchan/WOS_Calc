<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì˜ì›… ì¥ë¹„ ê³„ì‚°ê¸° (experts ìŠ¤íƒ€ì¼)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* ========== ë‹¤í¬ëª¨ë“œ ========== */
    body.dark-mode { background-color:#121212; color:#f0f0f0; }
    .dark-mode .border{ border-color:#444 !important; }
    .dark-mode .bg-white{ background-color:#2c2c2c !important; color:#f0f0f0 !important; }
    .dark-mode .bg-gray-100{ background-color:#1e1e1e !important; }
    .dark-mode .text-gray-800,.dark-mode .text-gray-700,.dark-mode .text-gray-600{ color:#dddddd !important; }
    .dark-mode select,.dark-mode input{ color:#000 !important; }
    .dark-mode table{ background:#2c2c2c; color:#f0f0f0; }
    .dark-mode th,.dark-mode td{ border-color:#444 !important; }

    /* ========== experts ì¹´ë“œ ìŠ¤íƒ€ì¼ ========== */
    .exp-card{
      border:1px solid rgba(0,0,0,.08);
      border-radius:16px;
      background:#fff;
      box-shadow:0 6px 18px rgba(15,23,42,.06);
      transition: box-shadow .2s ease;
    }
    .exp-card:hover{ box-shadow:0 10px 26px rgba(15,23,42,.12); }
    .muted{ font-size:12px; color:#6b7280; }

    body.dark-mode .exp-card{ background:#2c2c2c !important; border-color:#444 !important; }
    body.dark-mode .muted{ color:#b7b7b7 !important; }
    .tabular-nums{ font-variant-numeric: tabular-nums; }
  </style>

  <!-- ë‹¤í¬ëª¨ë“œ ìƒíƒœ ìœ ì§€ -->
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
      }
    });
  </script>
</head>
<body class="bg-gray-100 p-2 font-sans text-sm">
  <div class="max-w-[1500px] mx-auto bg-white p-3 rounded-xl shadow-md space-y-6">
    <h1 class="text-2xl font-bold text-gray-800">ğŸ§ ì˜ì›… ì¥ë¹„ ê³„ì‚°ê¸°</h1>

    <div class="text-gray-600 text-sm">
      <p>í˜„ì¬ë ˆë²¨ê³¼ ëª©í‘œë ˆë²¨ì„ ì„ íƒí•˜ë©´, ì—…ê·¸ë ˆì´ë“œì— í•„ìš”í•œ ìì›(ë¯¸ìŠ¤ë¦´/ë§ˆìŠ¤í„°ë¦¬ì„/ë ˆì „ë“œ ì¥ë¹„)ì„ ê³„ì‚°í•©ë‹ˆë‹¤.</p>
      <p>ê° í•­ëª©ì˜ â€˜í•„ìš” í•©ê³„â€™ëŠ” ë ˆë²¨ ì„ íƒ ì‹œ ìë™ ê°±ì‹ ë©ë‹ˆë‹¤. </p>
      <p>ê° í•­ëª©ë³„ë¡œ ì²´í¬ë¥¼ í•˜ë©´ ì²´í¬í•­ëª©ë³„ í•„ìš”í•©ê³„ë¥¼ ë”í•˜ì—¬ ì´í•©ê³„ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
    </div>

    <!-- ===================== ğŸ“• ë¯¸ìŠ¤ë¦´ ===================== -->
    <div class="exp-card">
      <div class="p-4">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-[16px] font-semibold text-yellow-700">ğŸ“• ë¯¸ìŠ¤ë¦´</h2>
        </div>

        <form id="heroEquipForm" class="space-y-3">
          <div id="heroEquipGridBody" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>

          <!-- ğŸ“• ë¯¸ìŠ¤ë¦´ ì´í•©ê³„ -->
          <div id="mithrilTotals" class="exp-card">
            <div class="p-4">
              <div class="font-semibold text-gray-800 mb-2">ì´í•©ê³„ (ë¯¸ìŠ¤ë¦´)</div>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <div class="rounded-xl border border-black/10 p-3">
                  <div class="font-semibold mb-2">í•„ìš” ì´í•©</div>
                  <div class="flex justify-between text-[13px]">
                    <span class="text-gray-600">ê²½í—˜ì¹˜</span><span id="tot-exp" class="tabular-nums">0</span>
                  </div>
                  <div class="flex justify-between text-[13px]">
                    <span class="text-gray-600">ë„ˆíŠ¸</span><span id="tot-nut" class="tabular-nums">0</span>
                  </div>
                  <div class="flex justify-between text-[13px]">
                    <span class="text-gray-600">ë¯¸ìŠ¤ë¦´</span><span id="tot-mith" class="tabular-nums">0</span>
                  </div>
                  <div class="flex justify-between text-[13px]">
                    <span class="text-gray-600">ë ˆì „ë“œì¥ë¹„</span><span id="tot-leg" class="tabular-nums">0</span>
                  </div>
                </div>
                <div class="rounded-xl border border-black/10 p-3">
                  <div class="font-semibold mb-2">ë³´ìœ ëŸ‰</div>
									<div class="grid grid-cols-1 md:grid-cols-3 gap-3">
										<div>
											<label class="block text-[12px] text-gray-600 mb-1">ë³´ë¼ë„ˆíŠ¸</label>
											<input type="number" id="own-ë„ˆíŠ¸" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="0" min="0" inputmode="numeric"/>
										</div>
										<div>
											<label class="block text-[12px] text-gray-600 mb-1">ë¯¸ìŠ¤ë¦´</label>
											<input type="number" id="own-ë¯¸ìŠ¤ë¦´" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="0" min="0" inputmode="numeric"/>
										</div>
										<div>
											<label class="block text-[12px] text-gray-600 mb-1">ë ˆì „ë“œì¥ë¹„</label>
											<input type="number" id="own-ë ˆì „ë“œì¥ë¹„" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="0" min="0" inputmode="numeric"/>
										</div>
									</div>
                </div>
                <div class="rounded-xl border border-black/10 p-3">
                  <div class="font-semibold mb-3">ê³¼ë¶€ì¡±</div>
                  <div class="flex justify-between text-[13px]"><span class="text-gray-600">ê²½í—˜ì¹˜</span><span id="def-exp" class="tabular-nums">0</span></div>
                  <div class="flex justify-between text-[13px]"><span class="text-gray-600">ë„ˆíŠ¸</span><span id="def-nut" class="tabular-nums">0</span></div>
									<div class="flex justify-between text-[13px]"><span class="text-gray-600">ë¯¸ìŠ¤ë¦´</span><span id="def-mith" class="tabular-nums">0</span></div>
									<div class="flex justify-between text-[13px]"><span class="text-gray-600">ë ˆì „ë“œì¥ë¹„</span><span id="def-leg" class="tabular-nums">0</span></div>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- ===================== ğŸ“™ ë§ˆìŠ¤í„°ë¦¬ ===================== -->
    <div class="exp-card">
      <div class="p-4">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-[16px] font-semibold text-yellow-700">ğŸ“™ ë§ˆìŠ¤í„°ë¦¬</h2>
        </div>

        <form id="masteryForm" class="space-y-3">
          <div id="masteryGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>

          <!-- ğŸ“™ ë§ˆìŠ¤í„°ë¦¬ ì´í•©ê³„ -->
          <div id="masteryTotals" class="exp-card">
            <div class="p-4">
              <div class="font-semibold text-gray-800 mb-2">ì´í•©ê³„ (ë§ˆìŠ¤í„°ë¦¬)</div>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <div class="rounded-xl border border-black/10 p-3">
                  <div class="font-semibold mb-2">í•„ìš” ì´í•©</div>
                  <div class="flex justify-between text-[13px]">
                    <span class="text-gray-600">ë§ˆìŠ¤í„°ë¦¬ì„</span><span id="ms-tot-stone" class="tabular-nums">0</span>
                  </div>
									<div class="font-semibold mb-6"></div>
                  <div class="flex justify-between text-[13px]">
                    <span class="text-gray-600">ë ˆì „ë“œì¥ë¹„</span><span id="ms-tot-leg" class="tabular-nums">0</span>
                  </div>
                </div>
                <div class="rounded-xl border border-black/10 p-3">
                  <div class="font-semibold mb-2">ë³´ìœ ëŸ‰</div>
									<div class="grid grid-cols-1 md:grid-cols-2 gap-3">
										<div>
											<label class="block text-[12px] text-gray-600 mb-1">ë§ˆìŠ¤í„°ë¦¬ì„</label>
											<input type="number" id="owned-ë§ˆìŠ¤í„°ë¦¬ì„" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="0" min="0" inputmode="numeric"/>
										</div>
										<div>
											<label class="block text-[12px] text-gray-600 mb-1">ë ˆì „ë“œì¥ë¹„</label>
											<input type="number" id="owned-ë ˆì „ë“œì¥ë¹„" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="0" min="0" inputmode="numeric"/>
										</div>
									</div>
                </div>
                <div class="rounded-xl border border-black/10 p-3">
                  <div class="font-semibold mb-2">ê³¼ë¶€ì¡±</div>
									<div class="flex justify-between text-[13px]"><span class="text-gray-600">ë§ˆìŠ¤í„°ë¦¬ì„</span><span id="ms-def-stone" class="tabular-nums">0</span></div>
									<div class="font-semibold mb-6"></div>
                  <div class="flex justify-between text-[13px]"><span class="text-gray-600">ë ˆì „ë“œì¥ë¹„</span><span id="ms-def-leg" class="tabular-nums">0</span></div>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ========== ê³µí†µ ìœ í‹¸ & í”„ë ˆì„ í†µì‹  ========== -->
  <script>
    function sendHeightToParent() {
      const height = document.body.scrollHeight + 10;
      window.parent?.postMessage?.({ type: "FRAME_CHANGE", height }, "*");
    }
    window.addEventListener("load", () => setTimeout(sendHeightToParent, 100));
  </script>

  <!-- ========== ğŸ“• ë¯¸ìŠ¤ë¦´ ë¡œì§ ========== -->
  <script>
    const slotNames = ["ê³ ê¸€", "ì¥ê°‘", "ë²¨íŠ¸", "ì‹ ë°œ"];
    const mithrilCsvUrl = "https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Hero/Mithril.csv";

    let stageList = [];
    let csvData = [];

    async function loadMithrilCSV() {
      try{
        const res = await fetch(mithrilCsvUrl, {cache:"no-store"});
        const text = await res.text();
        const lines = text.trim().split("\n").map(l => l.split(","));
        const headers = lines[0];
        csvData = lines.slice(1).map(row => {
          const obj = {};
          headers.forEach((h, i) => obj[h.trim()] = (row[i] ?? "").trim() || "0");
          return obj;
        });
        stageList = csvData.map(r => r["ë ˆë²¨"]);
      }catch(e){
        // ê°„ë‹¨í•œ í´ë°± (ë ˆë²¨ 1~5)
        csvData = [
          {ë ˆë²¨:"1", ê²½í—˜ì¹˜:"0", ë„ˆíŠ¸:"0", ë¯¸ìŠ¤ë¦´:"0", ë ˆì „ë“œì¥ë¹„:"0"},
          {ë ˆë²¨:"2", ê²½í—˜ì¹˜:"100", ë„ˆíŠ¸:"5", ë¯¸ìŠ¤ë¦´:"8", ë ˆì „ë“œì¥ë¹„:"0"},
          {ë ˆë²¨:"3", ê²½í—˜ì¹˜:"220", ë„ˆíŠ¸:"12", ë¯¸ìŠ¤ë¦´:"18", ë ˆì „ë“œì¥ë¹„:"0"},
          {ë ˆë²¨:"4", ê²½í—˜ì¹˜:"360", ë„ˆíŠ¸:"20", ë¯¸ìŠ¤ë¦´:"30", ë ˆì „ë“œì¥ë¹„:"1"},
          {ë ˆë²¨:"5", ê²½í—˜ì¹˜:"520", ë„ˆíŠ¸:"30", ë¯¸ìŠ¤ë¦´:"45", ë ˆì „ë“œì¥ë¹„:"1"},
        ];
        stageList = csvData.map(r=>r["ë ˆë²¨"]);
      }
      renderHeroEquipUI();
      sendHeightToParent();
    }

    function renderHeroEquipUI() {
      const grid = document.getElementById("heroEquipGridBody");
      grid.innerHTML = "";

      slotNames.forEach((name, i) => {
        const options = stageList.map(stage => `<option value="${stage}">${stage}</option>`).join("");
        const card = document.createElement("div");
        card.className = "exp-card";
        card.innerHTML = `
          <div class="p-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <div class="flex items-center gap-2 mb-2">
                  <h3 class="text-[15px] font-semibold text-gray-800">${name}</h3>
                </div>
                <!-- í˜„ì¬/ëª©í‘œ ì„¸ë¡œ ë°°ì¹˜ -->
                <div class="grid grid-cols-1 gap-2">
                  <div class="flex items-center justify-between gap-2">
                    <span class="text-gray-600">í˜„ì¬</span>
                    <select id="start-${i}" class="border rounded-lg px-2 py-1 text-sm min-w-[120px]">${options}</select>
                  </div>
                  <div class="flex items-center justify-between gap-2">
                    <span class="text-gray-600">ëª©í‘œ</span>
                    <select id="end-${i}" class="border rounded-lg px-2 py-1 text-sm min-w-[120px]">${options}</select>
                  </div>
                </div>
              </div>
              <div class="md:pl-4">
                <div class="font-semibold text-gray-800 mb-2">í•„ìš” í•©ê³„</div>
                <div class="grid grid-cols-[1fr_auto] gap-x-3 text-[13px]">
                  <div class="text-gray-600">ê²½í—˜ì¹˜</div><div class="text-right tabular-nums" id="m-sub-exp-${i}">0</div>
                  <div class="text-gray-600">ë„ˆíŠ¸</div><div class="text-right tabular-nums" id="m-sub-nut-${i}">0</div>
                  <div class="text-gray-600">ë¯¸ìŠ¤ë¦´</div><div class="text-right tabular-nums" id="m-sub-mith-${i}">0</div>
                  <div class="text-gray-600">ë ˆì „ë“œì¥ë¹„</div><div class="text-right tabular-nums" id="m-sub-legend-${i}">0</div>
                </div>
              </div>
            </div>
          </div>
        `;
        grid.appendChild(card);

        const curSelect = card.querySelector(`#start-${i}`);
        const tgtSelect = card.querySelector(`#end-${i}`);

        const onChange = () => { updateMithrilSubtotals(i); updateMithrilTotals(); };
        curSelect.addEventListener("change", () => { tgtSelect.value = curSelect.value; onChange(); });
        tgtSelect.addEventListener("change", onChange);

        // ì´ˆê¸° 1íšŒ ê³„ì‚°
        updateMithrilSubtotals(i);
      });

      // ë³´ìœ  ì…ë ¥ ë³€í™” ì‹œ ì´í•©ê³„ ê°±ì‹ 
      ["own-ë„ˆíŠ¸","own-ë¯¸ìŠ¤ë¦´","own-ë ˆì „ë“œì¥ë¹„"].forEach(id=>{
        document.getElementById(id)?.addEventListener("input", updateMithrilTotals);
      });

      updateMithrilTotals();
    }

    function updateMithrilSubtotals(i) {
      const cur = document.getElementById(`start-${i}`).value;
      const tgt = document.getElementById(`end-${i}`).value;
      const sIdx = stageList.indexOf(cur);
      const eIdx = stageList.indexOf(tgt);

      const sums = { exp:0, nut:0, mith:0, legend:0 };
      if (sIdx >= 0 && eIdx > sIdx) {
        for (let j = sIdx + 1; j <= eIdx; j++) {
          const r = csvData[j];
          sums.exp    += parseFloat(r["ê²½í—˜ì¹˜"] || "0");
          sums.nut    += parseFloat(r["ë„ˆíŠ¸"] || "0");
          sums.mith   += parseFloat(r["ë¯¸ìŠ¤ë¦´"] || "0");
          sums.legend += parseFloat(r["ë ˆì „ë“œì¥ë¹„"] || "0");
        }
      }
      document.getElementById(`m-sub-exp-${i}`).textContent    = sums.exp.toLocaleString();
      document.getElementById(`m-sub-nut-${i}`).textContent    = sums.nut.toLocaleString();
      document.getElementById(`m-sub-mith-${i}`).textContent   = sums.mith.toLocaleString();
      document.getElementById(`m-sub-legend-${i}`).textContent = sums.legend.toLocaleString();
    }

    function updateMithrilTotals(){
      let total = { exp:0, nut:0, mith:0, leg:0 };
      slotNames.forEach((_, i)=>{
        const cur = document.getElementById(`start-${i}`).value;
        const tgt = document.getElementById(`end-${i}`).value;
        const sIdx = stageList.indexOf(cur);
        const eIdx = stageList.indexOf(tgt);
        if (sIdx < 0 || eIdx <= sIdx) return;

        for(let j=sIdx+1;j<=eIdx;j++){
          const r = csvData[j];
          total.exp += +(r["ê²½í—˜ì¹˜"]||0);
          total.nut += +(r["ë„ˆíŠ¸"]||0);
          total.mith+= +(r["ë¯¸ìŠ¤ë¦´"]||0);
          total.leg += +(r["ë ˆì „ë“œì¥ë¹„"]||0);
        }
      });

      const own = {
        nut: +(document.getElementById("own-ë„ˆíŠ¸")?.value || 0),
        mith:+(document.getElementById("own-ë¯¸ìŠ¤ë¦´")?.value || 0),
        leg: +(document.getElementById("own-ë ˆì „ë“œì¥ë¹„")?.value || 0),
      };

      // í‘œê¸°
      document.getElementById("tot-exp").textContent  = total.exp.toLocaleString();
      document.getElementById("tot-nut").textContent  = total.nut.toLocaleString();
      document.getElementById("tot-mith").textContent = total.mith.toLocaleString();
      document.getElementById("tot-leg").textContent  = total.leg.toLocaleString();

      document.getElementById("own-ë„ˆíŠ¸").textContent  = own.nut.toLocaleString();
      document.getElementById("own-ë¯¸ìŠ¤ë¦´").textContent = own.mith.toLocaleString();
      document.getElementById("own-ë ˆì „ë“œì¥ë¹„").textContent  = own.leg.toLocaleString();

			const defA = document.getElementById("def-exp");
      const defB = document.getElementById("def-mith");
      const defC = document.getElementById("def-leg");
			
      document.getElementById("def-exp").textContent  = total.exp.toLocaleString(); // ê²½í—˜ì¹˜ëŠ” ë³´ìœ ì¹˜ ê°œë… ì—†ìŒ
      document.getElementById("def-nut").textContent  = (own.nut-total.nut).toLocaleString();
      document.getElementById("def-mith").textContent = (own.mith-total.mith).toLocaleString();
      document.getElementById("def-leg").textContent  = (own.leg-total.leg).toLocaleString();

			defA.classList.toggle("text-red-600", parseFloat(defA.textContent.replace(/,/g,'')) < 0);
      defB.classList.toggle("text-red-600", parseFloat(defB.textContent.replace(/,/g,'')) < 0);
      defC.classList.toggle("text-red-600", parseFloat(defC.textContent.replace(/,/g,'')) < 0);
    }

    // ìµœì´ˆ ë¡œë”©
    loadMithrilCSV();
  </script>

  <!-- ========== ğŸ“™ ë§ˆìŠ¤í„°ë¦¬ ë¡œì§ ========== -->
  <script>
    const masteryUrl = "https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Hero/Mastery.csv";
    const masterySlots = ["ê³ ê¸€", "ì¥ê°‘", "ë²¨íŠ¸", "ì‹ ë°œ"];
    let masteryLevels = [];
    let masteryData = [];

    async function loadMasteryCSV() {
      try{
        const res = await fetch(masteryUrl, {cache:"no-store"});
        const text = await res.text();
        const lines = text.trim().split("\n").map(row => row.split(","));
        const headers = lines[0];
        masteryData = lines.slice(1).map(row => {
          const obj = {};
          headers.forEach((h, i) => obj[h.trim()] = (row[i] ?? "").trim() || "0");
          return obj;
        });
        masteryLevels = masteryData.map(r => r["ë ˆë²¨"]);
      }catch(e){
        // ê°„ë‹¨í•œ í´ë°± (ë ˆë²¨ 1~5)
        masteryData = [
          {ë ˆë²¨:"1", ë§ˆìŠ¤í„°ë¦¬ì„:"0", ë ˆì „ë“œì¥ë¹„:"0"},
          {ë ˆë²¨:"2", ë§ˆìŠ¤í„°ë¦¬ì„:"10", ë ˆì „ë“œì¥ë¹„:"0"},
          {ë ˆë²¨:"3", ë§ˆìŠ¤í„°ë¦¬ì„:"22", ë ˆì „ë“œì¥ë¹„:"0"},
          {ë ˆë²¨:"4", ë§ˆìŠ¤í„°ë¦¬ì„:"36", ë ˆì „ë“œì¥ë¹„:"1"},
          {ë ˆë²¨:"5", ë§ˆìŠ¤í„°ë¦¬ì„:"52", ë ˆì „ë“œì¥ë¹„:"1"},
        ];
        masteryLevels = masteryData.map(r=>r["ë ˆë²¨"]);
      }
      renderMasteryUI();
      sendHeightToParent();
    }

    function renderMasteryUI() {
      const grid = document.getElementById("masteryGrid");
      grid.innerHTML = "";

      masterySlots.forEach((name, i) => {
        const options = masteryLevels.map(lv => `<option value="${lv}">${lv}</option>`).join("");
        const card = document.createElement("div");
        card.className = "exp-card";
        card.innerHTML = `
          <div class="p-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <div class="flex items-center gap-2 mb-2">
                  <h3 class="text-[15px] font-semibold text-gray-800">${name}</h3>
                </div>
                <div class="grid grid-cols-1 gap-2">
                  <div class="flex items-center justify-between gap-2">
                    <span class="text-[12px] text-gray-600">í˜„ì¬</span>
                    <select id="m-start-${i}" class="border rounded-lg px-2 py-1 text-sm min-w-[120px]">${options}</select>
                  </div>
                  <div class="flex items-center justify-between gap-2">
                    <span class="text-[12px] text-gray-600">ëª©í‘œ</span>
                    <select id="m-end-${i}" class="border rounded-lg px-2 py-1 text-sm min-w-[120px]">${options}</select>
                  </div>
                </div>
              </div>
              <div class="md:pl-4">
                <div class="font-semibold text-gray-800 mb-2">í•„ìš” í•©ê³„</div>
                <div class="grid grid-cols-[1fr_auto] gap-x-3 text-[13px]">
                  <div class="text-gray-600">ë§ˆìŠ¤í„°ë¦¬ì„</div><div class="text-right tabular-nums" id="ms-sub-stone-${i}">0</div>
                  <div class="text-gray-600">ë ˆì „ë“œì¥ë¹„</div><div class="text-right tabular-nums" id="ms-sub-legend-${i}">0</div>
                </div>
              </div>
            </div>
          </div>`;
        grid.appendChild(card);

        const curSelect = card.querySelector(`#m-start-${i}`);
        const tgtSelect = card.querySelector(`#m-end-${i}`);

        const onChange = () => { updateMasterySubtotals(i); updateMasteryTotals(); };
        curSelect.addEventListener("change", () => { tgtSelect.value = curSelect.value; onChange(); });
        tgtSelect.addEventListener("change", onChange);

        updateMasterySubtotals(i);
      });

      ["owned-ë§ˆìŠ¤í„°ë¦¬ì„","owned-ë ˆì „ë“œì¥ë¹„"].forEach(id=>{
        document.getElementById(id)?.addEventListener("input", updateMasteryTotals);
      });

      updateMasteryTotals();
    }

    function updateMasterySubtotals(i) {
      const cur = document.getElementById(`m-start-${i}`).value;
      const tgt = document.getElementById(`m-end-${i}`).value;
      const sIdx = masteryLevels.indexOf(cur);
      const eIdx = masteryLevels.indexOf(tgt);

      const sums = { stone:0, legend:0 };
      if (sIdx >= 0 && eIdx > sIdx) {
        for (let j = sIdx + 1; j <= eIdx; j++) {
          const r = masteryData[j];
          sums.stone  += parseFloat(r["ë§ˆìŠ¤í„°ë¦¬ì„"] || "0");
          sums.legend += parseFloat(r["ë ˆì „ë“œì¥ë¹„"] || "0");
        }
      }
      document.getElementById(`ms-sub-stone-${i}`).textContent  = sums.stone.toLocaleString();
      document.getElementById(`ms-sub-legend-${i}`).textContent = sums.legend.toLocaleString();
    }

    function updateMasteryTotals(){
      let total = { stone:0, leg:0 };
      masterySlots.forEach((_, i)=>{
        const cur = document.getElementById(`m-start-${i}`).value;
        const tgt = document.getElementById(`m-end-${i}`).value;
        const sIdx = masteryLevels.indexOf(cur);
        const eIdx = masteryLevels.indexOf(tgt);
        if (sIdx < 0 || eIdx <= sIdx) return;

        for(let j=sIdx+1;j<=eIdx;j++){
          const r = masteryData[j];
          total.stone += +(r["ë§ˆìŠ¤í„°ë¦¬ì„"]||0);
          total.leg   += +(r["ë ˆì „ë“œì¥ë¹„"]||0);
        }
      });

      const own = {
        stone: +(document.getElementById("owned-ë§ˆìŠ¤í„°ë¦¬ì„")?.value || 0),
        leg:   +(document.getElementById("owned-ë ˆì „ë“œì¥ë¹„")?.value || 0),
      };

      document.getElementById("ms-tot-stone").textContent = total.stone.toLocaleString();
      document.getElementById("ms-tot-leg").textContent   = total.leg.toLocaleString();
      
			document.getElementById("owned-ë§ˆìŠ¤í„°ë¦¬ì„").textContent = own.stone.toLocaleString();
      document.getElementById("owned-ë ˆì „ë“œì¥ë¹„").textContent   = own.leg.toLocaleString();
			
			const defA = document.getElementById("ms-def-ston");
      const defB = document.getElementById("ms-def-leg");
			
			document.getElementById("ms-def-stone").textContent = (own.stone-total.stone).toLocaleString();
      document.getElementById("ms-def-leg").textContent   = (own.leg-total.leg).toLocaleString();

			defA.classList.toggle("text-red-600", parseFloat(defA.textContent.replace(/,/g,'')) < 0);
      defB.classList.toggle("text-red-600", parseFloat(defB.textContent.replace(/,/g,'')) < 0);
    }

    // ìµœì´ˆ ë¡œë”©
    loadMasteryCSV();
  </script>

  <!-- ========== (ì„ íƒ) í‚¤ ì°¨ë‹¨: ì› ì½”ë“œ ìœ ì§€ ìŠµê´€ ========== -->
  <script>
    document.addEventListener("contextmenu", e => e.preventDefault());
    document.addEventListener("keydown", function (e) {
      if (e.key === "F12" || (e.ctrlKey && e.shiftKey && (e.key === "I" || e.key === "J")) ||
          (e.ctrlKey && (e.key === "U" || e.key === "S"))) {
        e.preventDefault();
      }
    });
  </script>
</body>
</html>
