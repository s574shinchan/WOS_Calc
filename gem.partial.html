<meta charset="utf-8" />

<div class="max-w-[1500px] mx-auto bg-white rounded shadow p-2 flex flex-col sm:flex-row gap-2">
  <div class="flex-1 bg-white rounded p-2 space-y-4 shadow">
    <div class="bg-gray-100 p-2 font-sans text-sm">
      <div class="bg-white p-4 rounded-xl shadow-md space-y-4">
        <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight text-gray-800">ğŸ’ ì˜ì£¼ë³´ì„ ê³„ì‚°ê¸°</h1>
        <p class="text-sm muted mt-1">ë³´ì„ ì—…ê·¸ë ˆì´ë“œì— í•„ìš”í•œ <b>ë§¤ë‰´ì–¼ / ë„ë©´ / ë¹„ì „</b> í•©ê³„ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.</p>
        <p class="text-xs muted mt-1">â€» í•­ëª©ì„ ì¶”ê°€í•œ ë’¤ <b>[ğŸ“Š ê³„ì‚°í•˜ê¸°]</b> ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œë§Œ ì´í•©ì´ ê³„ì‚°ë©ë‹ˆë‹¤.</p>
        <p class="text-xs muted mt-1">â€» ë³´ì„ë¹„ì „êµí™˜ - <span class="text-red-300"><b>ë§¤ë‰´ì–¼ 40 : ë¹„ì „1 / ë„ë©´ 40 : ë¹„ì „1</b></span><br>* ì£¼ê°„ êµí™˜ ìµœëŒ€íšŸìˆ˜ ê°ê° 50ë²ˆ</p>

        <!-- ìƒë‹¨ 3ì„¹ì…˜: ì´ë¯¸ì§€ ì„ íƒ ì¹´ë“œ -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">

          <div class="card border rounded-xl p-4" data-card data-unit="Infantry">
            <div class="flex items-center justify-between mb-3">
              <div class="text-base font-bold text-blue-400">[ë°©íŒ¨]</div>
              <div class="muted text-xs">ë ˆë²¨ ë²”ìœ„: ìµœëŒ€ Lv.16</div>
            </div>

            <div class="grid grid-cols-2 gap-3">
              <button type="button" class="group relative rounded-lg overflow-hidden border border-gray-600" data-pick-image data-slot="left">
                <img data-slot-img="left" class="hidden w-full h-28 object-contain tile-bg"/>
                <div data-empty="left" class="w-full h-28 tile-bg"></div>
                <div class="absolute inset-0 opacity-0 group-hover:opacity-100 transition bg-black/40 flex items-center justify-center">
                  <span class="text-xs px-3 py-1 rounded-full border border-white/40">í´ë¦­</span>
                </div>
              </button>
              <button type="button" class="group relative rounded-lg overflow-hidden border border-gray-600" data-pick-image data-slot="right">
                <img data-slot-img="right" class="hidden w-full h-28 object-contain tile-bg"/>
                <div data-empty="right" class="w-full h-28 tile-bg"></div>
                <div class="absolute inset-0 opacity-0 group-hover:opacity-100 transition bg-black/40 flex items-center justify-center">
                  <span class="text-xs px-3 py-1 rounded-full border border-white/40">í´ë¦­</span>
                </div>
              </button>
            </div>

            <div class="grid grid-cols-2 gap-3 mt-3">
              <div>
                <div class="muted text-xs mb-1">í˜„ì¬ ë ˆë²¨</div>
                <div data-lbl="current" class="pill px-3 py-2 rounded-lg border text-sm w-full text-center tabular-nums">-</div>
              </div>
              <div>
                <div class="muted text-xs mb-1">ëª©í‘œ ë ˆë²¨</div>
                <div data-lbl="target" class="pill px-3 py-2 rounded-lg border text-sm w-full text-center tabular-nums">-</div>
              </div>
            </div>

            <button type="button" class="w-full mt-4 bg-gray-200 text-sm px-3 py-2 rounded hover:bg-blue-300 text-black add-btn" data-add>ì¶”ê°€</button>
          </div>

          <div class="card border rounded-xl p-4" data-card data-unit="Lancer">
            <div class="flex items-center justify-between mb-3">
              <div class="text-base font-bold text-green-400">[ì°½ë³‘]</div>
              <div class="muted text-xs">ë ˆë²¨ ë²”ìœ„: ìµœëŒ€ Lv.16</div>
            </div>

            <div class="grid grid-cols-2 gap-3">
              <button type="button" class="group relative rounded-lg overflow-hidden border border-gray-600" data-pick-image data-slot="left">
                <img data-slot-img="left" class="hidden w-full h-28 object-contain tile-bg"/>
                <div data-empty="left" class="w-full h-28 tile-bg"></div>
                <div class="absolute inset-0 opacity-0 group-hover:opacity-100 transition bg-black/40 flex items-center justify-center">
                  <span class="text-xs px-3 py-1 rounded-full border border-white/40">í´ë¦­</span>
                </div>
              </button>
              <button type="button" class="group relative rounded-lg overflow-hidden border border-gray-600" data-pick-image data-slot="right">
                <img data-slot-img="right" class="hidden w-full h-28 object-contain tile-bg"/>
                <div data-empty="right" class="w-full h-28 tile-bg"></div>
                <div class="absolute inset-0 opacity-0 group-hover:opacity-100 transition bg-black/40 flex items-center justify-center">
                  <span class="text-xs px-3 py-1 rounded-full border border-white/40">í´ë¦­</span>
                </div>
              </button>
            </div>

            <div class="grid grid-cols-2 gap-3 mt-3">
              <div>
                <div class="muted text-xs mb-1">í˜„ì¬ ë ˆë²¨</div>
                <div data-lbl="current" class="pill px-3 py-2 rounded-lg border text-sm w-full text-center tabular-nums">-</div>
              </div>
              <div>
                <div class="muted text-xs mb-1">ëª©í‘œ ë ˆë²¨</div>
                <div data-lbl="target" class="pill px-3 py-2 rounded-lg border text-sm w-full text-center tabular-nums">-</div>
              </div>
            </div>
            <button type="button" class="w-full mt-4 bg-gray-200 text-sm px-3 py-2 rounded hover:bg-blue-300 text-black add-btn" data-add>ì¶”ê°€</button>
          </div>

          <div class="card border rounded-xl p-4" data-card data-unit="Marksman">
            <div class="flex items-center justify-between mb-3">
              <div class="text-base font-bold text-purple-400">[ê¶ë³‘]</div>
              <div class="muted text-xs">ë ˆë²¨ ë²”ìœ„: ìµœëŒ€ Lv.16</div>
            </div>

            <div class="grid grid-cols-2 gap-3">
              <button type="button" class="group relative rounded-lg overflow-hidden border border-gray-600" data-pick-image data-slot="left">
                <img data-slot-img="left" class="hidden w-full h-28 object-contain tile-bg"/>
                <div data-empty="left" class="w-full h-28 tile-bg"></div>
                <div class="absolute inset-0 opacity-0 group-hover:opacity-100 transition bg-black/40 flex items-center justify-center">
                  <span class="text-xs px-3 py-1 rounded-full border border-white/40">í´ë¦­</span>
                </div>
              </button>
              <button type="button" class="group relative rounded-lg overflow-hidden border border-gray-600" data-pick-image data-slot="right">
                <img data-slot-img="right" class="hidden w-full h-28 object-contain tile-bg"/>
                <div data-empty="right" class="w-full h-28 tile-bg"></div>
                <div class="absolute inset-0 opacity-0 group-hover:opacity-100 transition bg-black/40 flex items-center justify-center">
                  <span class="text-xs px-3 py-1 rounded-full border border-white/40">í´ë¦­</span>
                </div>
              </button>
            </div>

            <div class="grid grid-cols-2 gap-3 mt-3">
              <div>
                <div class="muted text-xs mb-1">í˜„ì¬ ë ˆë²¨</div>
                <div data-lbl="current" class="pill px-3 py-2 rounded-lg border text-sm w-full text-center tabular-nums">-</div>
              </div>
              <div>
                <div class="muted text-xs mb-1">ëª©í‘œ ë ˆë²¨</div>
                <div data-lbl="target" class="pill px-3 py-2 rounded-lg border text-sm w-full text-center tabular-nums">-</div>
              </div>
            </div>
            <button type="button" class="w-full mt-4 bg-gray-200 text-sm px-3 py-2 rounded hover:bg-blue-300 text-black add-btn" data-add>ì¶”ê°€</button>
          </div>

        </div>

        <!-- í•˜ë‹¨ 2íŒ¨ë„ -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
          <div class="panel border rounded-xl p-4">
            <div class="flex items-center justify-between gap-3">
              <div class="text-base font-bold">ğŸ“„ ì„ íƒëœ ëª©ë¡</div>
              <div class="flex items-center gap-3 text-sm">
                <button id="btnCalc" class="text-blue-500 text-sm hover:underline">ğŸ“Š ê³„ì‚°í•˜ê¸°</button>
                <button id="btnClearAll" class="text-sm text-red-600 hover:underline">ğŸ§¹ ëª©ë¡ ì´ˆê¸°í™”</button>
              </div>
            </div>
            <div id="listWrap" class="mt-3 space-y-2"></div>
          </div>

          <div class="panel border rounded-xl p-4">
            <div class="text-base font-bold flex items-center gap-2">
              <span>ğŸ§¾</span><span>ê³„ì‚° ê²°ê³¼</span>
            </div>
            <div id="resultHint" class="muted text-sm mt-2">
              <div class="text-sm text-gray-600">í•­ëª©ì„ ì¶”ê°€í•˜ê³  <span class="font-semibold">[ğŸ“Š ê³„ì‚°í•˜ê¸°]</span>ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
            </div>


            <div id="resultBox" class="mt-3 hidden">
              <div class="overflow-x-auto">
                <table class="w-full text-sm table-fixed">
                  <thead>
                    <tr class="bg-black/20">
                      <th class="border border-gray-700 p-2 text-center">êµ¬ë¶„</th>
                      <th class="border border-gray-700 p-2 text-center">ë ˆë²¨</th>
                      <th class="border border-gray-700 p-2 text-center">ë§¤ë‰´ì–¼</th>
                      <th class="border border-gray-700 p-2 text-center">ë„ë©´</th>
                      <th class="border border-gray-700 p-2 text-center">ë¹„ì „</th>
                    </tr>
                  </thead>
                  <tbody id="resultRows"></tbody>
                  <tfoot>
                    <tr class="bg-black/20 font-bold">
                      <td class="border border-gray-700 p-2 text-center" colspan="2">ì´í•©</td>
                      <td id="sumM" class="border border-gray-700 p-2 text-center tabular-nums">0</td>
                      <td id="sumB" class="border border-gray-700 p-2 text-center tabular-nums">0</td>
                      <td id="sumV" class="border border-gray-700 p-2 text-center tabular-nums">0</td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- ì´ë¯¸ì§€ ì„ íƒ ëª¨ë‹¬ -->
<div id="imgModal" class="fixed inset-0 hidden items-center justify-center bg-black/60 p-4 z-50">
  <div class="modal w-full max-w-4xl border rounded-xl p-4">
    <div class="flex items-center justify-between mb-3">
      <div class="font-semibold" id="modalTitle">ì´ë¯¸ì§€ ì„ íƒ</div>
      <button id="btnCloseModal" class="btn px-3 py-1 rounded-lg border hover:bg-white/10 text-sm">ë‹«ê¸°</button>
    </div>
    <div id="imgGrid" class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-6 gap-3 max-h-[80vh] overflow-auto pr-1"></div>
  </div>
</div>

<script>
(function(){
  // âœ… SPA ì¬ì§„ì…/ì¬ë¡œë“œ ì‹œ ì´ë²¤íŠ¸ ì¤‘ë³µ ë°”ì¸ë”© ë°©ì§€
  if (window.__GEM_INIT_BOUND__) {
    // ì´ë¯¸ ì´ˆê¸°í™”ëœ ìƒíƒœë©´ ê·¸ëƒ¥ ì‹¤í–‰ë§Œ(í•„ìš” ì‹œ)
    window.GemInit?.();
    return;
  }
  window.__GEM_INIT_BOUND__ = true;
    
  window.GemInit = function GemInit(){  
    console.log("[GemInit] run", !!document.getElementById("imgModal"));
  /* ====== ë°ì´í„° ì†ŒìŠ¤: gem.htmlê³¼ ë™ì¼ ====== */
  var csvUrl = "https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/chief/Gem.csv";

  /* ====== ì´ë¯¸ì§€ ì†ŒìŠ¤ ====== */
  var MAX_LV = 16;
  var UNITS = ["Infantry", "Lancer", "Marksman"];
  var UNIT_KO = { Infantry:"ë°©íŒ¨", Lancer:"ì°½ë³‘", Marksman:"ê¶ë³‘" };
  var IMAGE_BY_UNIT = Object.fromEntries(
    UNITS.map(u => [u, Array.from({length: MAX_LV}, (_,i)=> `images/${u}/${u}_${i+1}.webp`)])
  );

  function levelFromUrl(url){
    var name = (String(url||"").split("/").pop() || "");
    var m = name.match(/_(\d+)(?:\.[a-zA-Z0-9]+)?$/);
    return m ? Number(m[1]) : null;
  }
  var fmt = (n) => Number(n || 0).toLocaleString("ko-KR");
  var num = (s) => {
    var m = String(s ?? "").replace(/,/g,"").match(/-?\d+(\.\d+)?/);
    return m ? Number(m[0]) : 0;
  };
  var detectDelim = (sample) => (sample.includes("\t") ? "\t" : ",");

  /* ====== CSV ë¡œë“œ/íŒŒì‹±: gem.html ë°©ì‹(ë ˆë²¨ë³„ ë¹„ìš© ë°°ì—´) ====== */
  var stepM = [];
  var stepB = [];
  var stepV = [];
  var csvReady = false;

  async function loadCsv(){
    var res = await fetch(csvUrl, { cache:"no-store" });
    if(!res.ok) throw new Error("CSV fetch ì‹¤íŒ¨: " + res.status);
    var text = await res.text();

    var lines = text.replace(/\r/g,"").split("\n").filter(x=>x.trim().length>0);
    var delim = detectDelim(lines[0]);
    var headers = lines[0].split(delim).map(h=>h.trim());

    // gem.csvëŠ” ë³´í†µ: Level, Manual, Blueprint, Vision
    var idxLv = headers.findIndex(h => /lv|level|ë ˆë²¨/i.test(h));
    var idxM  = headers.findIndex(h => /manual|ë§¤ë‰´ì–¼/i.test(h));
    var idxB  = headers.findIndex(h => /blue|ë„ë©´/i.test(h));
    var idxV  = headers.findIndex(h => /vision|ë¹„ì „/i.test(h));

    if(idxLv === -1 || idxM === -1 || idxB === -1 || idxV === -1){
      throw new Error("CSV í—¤ë”ì—ì„œ ë ˆë²¨/ë§¤ë‰´ì–¼/ë„ë©´/ë¹„ì „ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
    }

    var maxLv = MAX_LV;
    stepM = Array(maxLv + 1).fill(0);
    stepB = Array(maxLv + 1).fill(0);
    stepV = Array(maxLv + 1).fill(0);

    for(var i=1; i<lines.length; i++){
      var cols = lines[i].split(delim);
      var lv = num(cols[idxLv]);
      if(!lv || lv<1 || lv>maxLv) continue;
      stepM[lv] = num(cols[idxM]);
      stepB[lv] = num(cols[idxB]);
      stepV[lv] = num(cols[idxV]);
    }

    csvReady = true;
  }

  function sumRange(stepArr, fromLv, toLv){
    var s = 0;
    for(var lv = fromLv + 1; lv <= toLv; lv++) s += (stepArr[lv] || 0);
    return s;
  }

  /* ====== ëª©ë¡(ì¶”ê°€ëœ í•­ëª©): item { section, from, to } ====== */
  var addedItems = [];

  /* ====== UI ìš”ì†Œ ====== */
  var listWrap = document.getElementById("listWrap");
  var btnCalc = document.getElementById("btnCalc");
  var btnClearAll = document.getElementById("btnClearAll");

  var resultHint = document.getElementById("resultHint");
  var resultBox = document.getElementById("resultBox");
  var resultRows = document.getElementById("resultRows");
  var sumM = document.getElementById("sumM");
  var sumB = document.getElementById("sumB");
  var sumV = document.getElementById("sumV");


  /* ====== ëª©ë¡ ë Œë” ====== */
  function renderList(){
    listWrap.innerHTML = "";
    if(!addedItems.length){
      var empty = document.createElement("div");
      empty.className = "muted text-sm px-3 py-3 border border-gray-700 rounded-lg bg-black/10";
      empty.textContent = "ì„ íƒëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.";
      listWrap.appendChild(empty);
      sendHeightToParent();
      return;
    }

    addedItems.forEach((item, idx)=>{
      var row = document.createElement("div");
      row.className = "flex items-center justify-between gap-3 px-3 py-2 border border-gray-700 rounded-lg bg-black/10";
      row.innerHTML = `
        <div class="text-sm tabular-nums">
          <span class="font-semibold">[${item.section}]</span>
          <span class="ml-1">Lv.${item.from} â†’ Lv.${item.to}</span>
        </div>
        <button class="text-xs text-red-500 hover:underline" data-del="${idx}">ì‚­ì œ</button>
      `;
      listWrap.appendChild(row);
    });

    listWrap.querySelectorAll("[data-del]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        var i = Number(btn.getAttribute("data-del"));
        if(Number.isFinite(i)) {
          addedItems.splice(i, 1);
          renderList();
        }
      });
    });

    sendHeightToParent();
  }

  /* ====== ê³„ì‚°: ëª©ë¡ ê¸°ì¤€ìœ¼ë¡œë§Œ ê³„ì‚°(ë²„íŠ¼ í´ë¦­) ====== */
  async function calculateFromList(){
    if(!addedItems.length) {
      alert("ê³„ì‚°í•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
    if(!csvReady) {
      try{ await loadCsv(); } catch(e){ alert("CSV ë¡œë“œ ì‹¤íŒ¨: " + (e.message||e)); return; }
    }

    var total = { m:0, b:0, v:0 };
    var rowsHtml = [];

    addedItems.forEach((item) => {
      var sM = sumRange(stepM, item.from, item.to);
      var sB = sumRange(stepB, item.from, item.to);
      var sV = sumRange(stepV, item.from, item.to);

      total.m += sM;
      total.b += sB;
      total.v += sV;

      rowsHtml.push(`
        <tr class="bg-black/10">
          <td class="border border-gray-700 p-2 font-medium text-center">${item.section}</td>
          <td class="border border-gray-700 p-2 text-center tabular-nums">Lv.${item.from} â†’ Lv.${item.to}</td>
          <td class="border border-gray-700 p-2 text-center tabular-nums">${fmt(sM)}</td>
          <td class="border border-gray-700 p-2 text-center tabular-nums">${fmt(sB)}</td>
          <td class="border border-gray-700 p-2 text-center tabular-nums">${fmt(sV)}</td>
        </tr>
      `);
      });

    // ê²°ê³¼ ë°˜ì˜
    resultRows.innerHTML = rowsHtml.join("");
    sumM.textContent = fmt(total.m);
    sumB.textContent = fmt(total.b);
    sumV.textContent = fmt(total.v);


    resultHint.classList.add("hidden");
    resultBox.classList.remove("hidden");

    sendHeightToParent();
  }

  btnCalc.addEventListener("click", calculateFromList);
  btnClearAll.addEventListener("click", ()=>{
    addedItems = [];
    renderList();
    resultBox.classList.add("hidden");
    resultHint.classList.remove("hidden");
    resultHint.innerHTML = 'í•­ëª©ì„ ì¶”ê°€í•˜ê³  <span class="link">ğŸ“Š ê³„ì‚°í•˜ê¸°</span>ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.';
    });

  /* ====== ì´ë¯¸ì§€ ì„ íƒ ëª¨ë‹¬ ====== */
  var modal = document.getElementById("imgModal");
  var imgGrid = document.getElementById("imgGrid");
  var btnCloseModal = document.getElementById("btnCloseModal");
  var modalTitle = document.getElementById("modalTitle");

  var activeCardEl = null;
  var activeSlot = "left";

  function openModal(cardEl, slot, unit){
    activeCardEl = cardEl;
    activeSlot = slot;

    modalTitle.textContent = `${UNIT_KO[unit] ?? unit} - ì´ë¯¸ì§€ ì„ íƒ`;
    renderGrid(unit);

    modal.classList.remove("hidden");
    modal.classList.add("flex");
  }
  function closeModal(){
    modal.classList.add("hidden");
    modal.classList.remove("flex");
  }
  btnCloseModal.addEventListener("click", closeModal);
  modal.addEventListener("click", (e)=>{ if(e.target === modal) closeModal(); });

  function setCardLevelLabel(cardEl, kind, lv){
    var el = cardEl.querySelector(`[data-lbl="${kind}"]`);
    el.textContent = (lv === "-" ? "-" : `Lv.${lv}`);
  }

  function applySelectedImage(url){
    if(!activeCardEl) return;

    var imgEl = activeCardEl.querySelector(`[data-slot-img="${activeSlot}"]`);
    var emptyEl = activeCardEl.querySelector(`[data-empty="${activeSlot}"]`);

    if (emptyEl) emptyEl.classList.add("hidden");
    imgEl.classList.remove("hidden");

    imgEl.src = url;
    imgEl.alt = url;

    var lv = levelFromUrl(url);
    if(lv != null){
      var clamped = Math.min(Math.max(lv, 1), MAX_LV);
      if(activeSlot === "left") setCardLevelLabel(activeCardEl, "current", clamped);
      else setCardLevelLabel(activeCardEl, "target", clamped);
    }
  }

  function clearSelectedImage(){
    if(!activeCardEl) return;

    var imgEl   = activeCardEl.querySelector(`[data-slot-img="${activeSlot}"]`);
    var emptyEl = activeCardEl.querySelector(`[data-empty="${activeSlot}"]`);

    imgEl.classList.add("hidden");
    imgEl.src = "";
    imgEl.alt = "empty";

    if (emptyEl) emptyEl.classList.remove("hidden");

    if(activeSlot === "left") setCardLevelLabel(activeCardEl, "current", "-");
    else setCardLevelLabel(activeCardEl, "target", "-");
  }

  function renderGrid(unit){
    imgGrid.innerHTML = "";

    // ì„ íƒ ì·¨ì†Œ
    {
      var btn = document.createElement("button");
      btn.type = "button";
      btn.className = "group border border-gray-600 rounded-lg overflow-hidden hover:bg-white/5";
      btn.innerHTML = `
        <div class="aspect-square tile-bg flex items-center justify-center">
          <div class="w-full h-full"></div>
        </div>
        <div class="px-2 py-2 text-[13px] muted text-center">ì„ íƒ ì·¨ì†Œ</div>
      `;
      btn.addEventListener("click", ()=>{ clearSelectedImage(); closeModal(); });
      imgGrid.appendChild(btn);
    }

    (IMAGE_BY_UNIT[unit] || []).forEach(url=>{
      var lv = levelFromUrl(url);
      var caption = (lv != null) ? `Lv.${lv}` : "Lv.?";

      var btn = document.createElement("button");
      btn.type = "button";
      btn.className = "group border border-gray-600 rounded-lg overflow-hidden hover:bg-white/5";
      btn.innerHTML = `
        <div class="aspect-square tile-bg flex items-center justify-center">
          <img src="${url}" alt="${caption}" class="max-w-full max-h-full object-contain p-2" />
        </div>
        <div class="px-2 py-2 text-[13px] muted text-center">${caption}</div>
      `;
      btn.addEventListener("click", ()=>{ applySelectedImage(url); closeModal(); });
      imgGrid.appendChild(btn);
    });
  }

  /* ====== ì¹´ë“œ ì´ë²¤íŠ¸: ì¶”ê°€ ====== */
  function getCardLevels(cardEl){
    var leftSrc = cardEl.querySelector('[data-slot-img="left"]')?.getAttribute("src") || "";
    var rightSrc = cardEl.querySelector('[data-slot-img="right"]')?.getAttribute("src") || "";
    var fromLv = levelFromUrl(leftSrc);
    var toLv = levelFromUrl(rightSrc);
    return { fromLv, toLv };
  }

  document.querySelectorAll("[data-card]").forEach(cardEl=>{
    cardEl.querySelectorAll("[data-pick-image]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        var slot = btn.getAttribute("data-slot");
        var unit = cardEl.getAttribute("data-unit");
        openModal(cardEl, slot, unit);
      });
    });

    cardEl.querySelector("[data-add]").addEventListener("click", ()=>{
      var unit = cardEl.getAttribute("data-unit");
      var section = UNIT_KO[unit] ?? unit;
      var { fromLv, toLv } = getCardLevels(cardEl);

      if(!fromLv || !toLv){
        alert("í˜„ì¬/ëª©í‘œ ì´ë¯¸ì§€ë¥¼ ëª¨ë‘ ì„ íƒí•˜ì„¸ìš”.");
        return;
      }
      if(fromLv >= toLv){
        alert("ëª©í‘œ ë ˆë²¨ì€ í˜„ì¬ ë ˆë²¨ë³´ë‹¤ ë†’ì•„ì•¼ í•©ë‹ˆë‹¤.");
        return;
      }

      addedItems.push({ section, from: fromLv, to: toLv });
      renderList();
    });

    cardEl.querySelectorAll("img[data-slot-img]").forEach(img=>{
      img.addEventListener("error", ()=>{
        var slot = img.getAttribute("data-slot-img");
        var emptyEl = cardEl.querySelector(`[data-empty="${slot}"]`);
        img.classList.add("hidden");
        if (emptyEl) emptyEl.classList.remove("hidden");
      });
    });
  });

  // ì´ˆê¸°
  renderList();
 };
 window.GemInit();
})();
</script>