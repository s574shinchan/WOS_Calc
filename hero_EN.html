<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hero</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* ========== Îã§ÌÅ¨Î™®Îìú ========== */
    body.dark-mode { background-color:#121212; color:#f0f0f0; }
    .dark-mode .border{ border-color:#444 !important; }
    .dark-mode .bg-white{ background-color:#2c2c2c !important; color:#f0f0f0 !important; }
    .dark-mode .bg-gray-100{ background-color:#1e1e1e !important; }
    .dark-mode .text-gray-800,.dark-mode .text-gray-700,.dark-mode .text-gray-600{ color:#dddddd !important; }
    .dark-mode select,.dark-mode input{ color:#000 !important; }
    .dark-mode table{ background:#2c2c2c; color:#f0f0f0; }
    .dark-mode th,.dark-mode td{ border-color:#444 !important; }

    /* ========== experts Ïπ¥Îìú Ïä§ÌÉÄÏùº ========== */
    .exp-card{
      border:1px solid rgba(0,0,0,.08);
      border-radius:16px;
      background:#fff;
      box-shadow:0 6px 18px rgba(15,23,42,.06);
      transition: box-shadow .2s ease;
    }
    .exp-card:hover{ box-shadow:0 10px 26px rgba(15,23,42,.12); }
    .muted{ font-size:12px; color:#6b7280; }

    body.dark-mode .exp-card{ background:#2c2c2c !important; border-color:#444 !important; }
    body.dark-mode .muted{ color:#b7b7b7 !important; }
    .tabular-nums{ font-variant-numeric: tabular-nums; }
  </style>

  <!-- Îã§ÌÅ¨Î™®Îìú ÏÉÅÌÉú Ïú†ÏßÄ -->
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
      }
    });
  </script>
</head>
<body class="bg-gray-100 p-2 font-sans text-sm">
  <div class="max-w-[1500px] mx-auto bg-white p-3 rounded-xl shadow-md space-y-6">
    <h1 class="text-2xl font-bold text-gray-800">üßù Hero Gear</h1>
    <!-- ===================== üìï ÎØ∏Ïä§Î¶¥ ===================== -->
    <div class="exp-card">
      <div class="p-4">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-[16px] font-semibold text-yellow-700">üìï Gear Empowerment</h2>
        </div>

        <form id="heroEquipForm" class="space-y-3">
          <div id="heroEquipGridBody" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>

          <!-- Î≥¥Ïú† ÏûêÏõê -->
          <div class="exp-card">
            <div class="p-4">
              <div class="flex items-center justify-between mb-3">
                <h3 class="text-[15px] font-semibold text-gray-800">Owned Items</h3>
              </div>
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <div>
                  <label class="block text-[15px] text-gray-600 mb-1">Owned 100 Enhancement XP Component</label>
                  <input type="number" id="own-ÎÑàÌä∏" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="0" min="0" inputmode="numeric"/>
                </div>
                <div>
                  <label class="block text-[15px] text-gray-600 mb-1">Owned Mithril</label>
                  <input type="number" id="own-ÎØ∏Ïä§Î¶¥" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="0" min="0" inputmode="numeric"/>
                </div>
                <div>
                  <label class="block text-[15px] text-gray-600 mb-1">Owned Mythic Gear</label>
                  <input type="number" id="own-Î†àÏ†ÑÎìúÏû•ÎπÑ" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="0" min="0" inputmode="numeric"/>
                </div>
              </div>
            </div>
          </div>

          <!-- üìï ÎØ∏Ïä§Î¶¥ Ï¥ùÌï©Í≥Ñ -->
          <div id="mithrilTotals" class="exp-card">
            <div class="p-4">
              <div class="font-semibold text-gray-800 mb-2">Empowerment Total</div>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <div class="rounded-xl border border-black/10 p-3">
                  <div class="font-semibold mb-2">Sub Total</div>
                  <div class="flex justify-between text-[13px]">
                    <span class="text-gray-600">Exp</span><span id="tot-exp" class="tabular-nums">0</span>
                  </div>
                  <div class="flex justify-between text-[13px]">
                    <span class="text-gray-600">100 Enhancement XP Component</span><span id="tot-nut" class="tabular-nums">0</span>
                  </div>
                  <div class="flex justify-between text-[13px]">
                    <span class="text-gray-600">Mithril</span><span id="tot-mith" class="tabular-nums">0</span>
                  </div>
                  <div class="flex justify-between text-[13px]">
                    <span class="text-gray-600">Mythic Gear</span><span id="tot-leg" class="tabular-nums">0</span>
                  </div>
                </div>
                <div class="rounded-xl border border-black/10 p-3">
                  <div class="font-semibold mb-2">Stock</div>
                  <div class="flex justify-between text-[13px]"><span class="text-gray-600">100 Enhancement XP Component</span><span id="own-nut" class="tabular-nums">0</span></div>
                  <div class="flex justify-between text-[13px]"><span class="text-gray-600">Mithril</span><span id="own-mith" class="tabular-nums">0</span></div>
                  <div class="flex justify-between text-[13px]"><span class="text-gray-600">Mythic Gear</span><span id="own-leg" class="tabular-nums">0</span></div>
                </div>
                <div class="rounded-xl border border-black/10 p-3">
                  <div class="font-semibold mb-2">Quantity required</div>
                  <div class="flex justify-between text-[13px]"><span class="text-gray-600">Exp</span><span id="def-exp" class="tabular-nums">0</span></div>
                  <div class="flex justify-between text-[13px]"><span class="text-gray-600">100 Enhancement XP Component</span><span id="def-nut" class="tabular-nums">0</span></div>
                  <div class="flex justify-between text-[13px]"><span class="text-gray-600">Mithril</span><span id="def-mith" class="tabular-nums">0</span></div>
                  <div class="flex justify-between text-[13px]"><span class="text-gray-600">Mythic Gear</span><span id="def-leg" class="tabular-nums">0</span></div>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- ===================== üìô ÎßàÏä§ÌÑ∞Î¶¨ ===================== -->
    <div class="exp-card">
      <div class="p-4">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-[16px] font-semibold text-yellow-700">üìô Mastery Forging</h2>
        </div>

        <form id="masteryForm" class="space-y-3">
          <div id="masteryGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>

          <!-- Î≥¥Ïú† ÏûêÏõê -->
          <div class="exp-card">
            <div class="p-4">
              <div class="flex items-center justify-between mb-3">
                <h3 class="text-[15px] font-semibold text-gray-800">Owned Items</h3>
              </div>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label class="block text-[15px] text-gray-600 mb-1">Owned Essence Stone</label>
                  <input type="number" id="owned-ÎßàÏä§ÌÑ∞Î¶¨ÏÑù" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="0" min="0" inputmode="numeric"/>
                </div>
                <div>
                  <label class="block text-[15px] text-gray-600 mb-1">Owned Mythic Gear</label>
                  <input type="number" id="owned-Î†àÏ†ÑÎìúÏû•ÎπÑ" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="0" min="0" inputmode="numeric"/>
                </div>
              </div>
            </div>
          </div>

          <!-- üìô ÎßàÏä§ÌÑ∞Î¶¨ Ï¥ùÌï©Í≥Ñ -->
          <div id="masteryTotals" class="exp-card">
            <div class="p-4">
              <div class="font-semibold text-gray-800 mb-2">Mastery Forging Total</div>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <div class="rounded-xl border border-black/10 p-3">
                  <div class="font-semibold mb-2">Sub Total</div>
                  <div class="flex justify-between text-[13px]">
                    <span class="text-gray-600">Essence Stone</span><span id="ms-tot-stone" class="tabular-nums">0</span>
                  </div>
                  <div class="flex justify-between text-[13px]">
                    <span class="text-gray-600">Mythic Gear</span><span id="ms-tot-leg" class="tabular-nums">0</span>
                  </div>
                </div>
                <div class="rounded-xl border border-black/10 p-3">
                  <div class="font-semibold mb-2">Stock</div>
                  <div class="flex justify-between text-[13px]">
                    <span class="text-gray-600">Essence Stone</span><span id="ms-own-stone" class="tabular-nums">0</span>
                  </div>
                  <div class="flex justify-between text-[13px]">
                    <span class="text-gray-600">Mythic Gear</span><span id="ms-own-leg" class="tabular-nums">0</span>
                  </div>
                </div>
                <div class="rounded-xl border border-black/10 p-3">
                  <div class="font-semibold mb-2">Quantity required</div>
                  <div class="flex justify-between text-[13px]">
                    <span class="text-gray-600">Essence Stone</span><span id="ms-def-stone" class="tabular-nums">0</span>
                  </div>
                  <div class="flex justify-between text-[13px]">
                    <span class="text-gray-600">Mythic Gear</span><span id="ms-def-leg" class="tabular-nums">0</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </form>
      </div>
    </div>
  </div>

  <!-- ========== Í≥µÌÜµ Ïú†Ìã∏ & ÌîÑÎ†àÏûÑ ÌÜµÏã† ========== -->
  <script>
    function sendHeightToParent() {
      const height = document.body.scrollHeight + 10;
      window.parent?.postMessage?.({ type: "FRAME_CHANGE", height }, "*");
    }
    window.addEventListener("load", () => setTimeout(sendHeightToParent, 100));
  </script>

  <!-- ========== üìï ÎØ∏Ïä§Î¶¥ Î°úÏßÅ ========== -->
  <script>
    const slotNames = ["Í≥†Í∏Ä", "Ïû•Í∞ë", "Î≤®Ìä∏", "Ïã†Î∞ú"];
    const mithrilCsvUrl = "https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Hero/Mithril.csv";
    const nameAliasMap = {
      "Í≥†Í∏Ä": "Goggles",
      "Ïû•Í∞ë": "Gauntlets",
      "Î≤®Ìä∏": "Belt",
      "Ïã†Î∞ú": "Boots"
    };
    let stageList = [];
    let csvData = [];

    async function loadMithrilCSV() {
      try{
        const res = await fetch(mithrilCsvUrl, {cache:"no-store"});
        const text = await res.text();
        const lines = text.trim().split("\n").map(l => l.split(","));
        const headers = lines[0];
        csvData = lines.slice(1).map(row => {
          const obj = {};
          headers.forEach((h, i) => obj[h.trim()] = (row[i] ?? "").trim() || "0");
          return obj;
        });
        stageList = csvData.map(r => r["Î†àÎ≤®"]);
      }catch(e){
        // Í∞ÑÎã®Ìïú Ìè¥Î∞± (Î†àÎ≤® 1~5)
        csvData = [
          {Î†àÎ≤®:"1", Í≤ΩÌóòÏπò:"0", ÎÑàÌä∏:"0", ÎØ∏Ïä§Î¶¥:"0", Î†àÏ†ÑÎìúÏû•ÎπÑ:"0"},
          {Î†àÎ≤®:"2", Í≤ΩÌóòÏπò:"100", ÎÑàÌä∏:"5", ÎØ∏Ïä§Î¶¥:"8", Î†àÏ†ÑÎìúÏû•ÎπÑ:"0"},
          {Î†àÎ≤®:"3", Í≤ΩÌóòÏπò:"220", ÎÑàÌä∏:"12", ÎØ∏Ïä§Î¶¥:"18", Î†àÏ†ÑÎìúÏû•ÎπÑ:"0"},
          {Î†àÎ≤®:"4", Í≤ΩÌóòÏπò:"360", ÎÑàÌä∏:"20", ÎØ∏Ïä§Î¶¥:"30", Î†àÏ†ÑÎìúÏû•ÎπÑ:"1"},
          {Î†àÎ≤®:"5", Í≤ΩÌóòÏπò:"520", ÎÑàÌä∏:"30", ÎØ∏Ïä§Î¶¥:"45", Î†àÏ†ÑÎìúÏû•ÎπÑ:"1"},
        ];
        stageList = csvData.map(r=>r["Î†àÎ≤®"]);
      }
      renderHeroEquipUI();
      sendHeightToParent();
    }

    function renderHeroEquipUI() {
      const grid = document.getElementById("heroEquipGridBody");
      grid.innerHTML = "";

      slotNames.forEach((name, i) => {
        const displayName = nameAliasMap[name] || name
        const options = stageList.map(stage => `<option value="${stage}">${stage}</option>`).join("");
        const card = document.createElement("div");
        card.className = "exp-card";
        card.innerHTML = `
          <div class="p-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <div class="flex items-center gap-2 mb-2">
                  <h3 class="text-[15px] font-semibold text-gray-800">${displayName}</h3>
                </div>
                <!-- ÌòÑÏû¨/Î™©Ìëú ÏÑ∏Î°ú Î∞∞Ïπò -->
                <div class="grid grid-cols-1 gap-2">
                  <div class="flex items-center justify-between gap-2">
                    <span class="text-gray-600">Current</span>
                    <select id="start-${i}" class="border rounded-lg px-2 py-1 text-sm min-w-[120px]">${options}</select>
                  </div>
                  <div class="flex items-center justify-between gap-2">
                    <span class="text-gray-600">Target</span>
                    <select id="end-${i}" class="border rounded-lg px-2 py-1 text-sm min-w-[120px]">${options}</select>
                  </div>
                </div>
              </div>
              <div class="md:pl-4">
                <div class="font-semibold text-gray-800 mb-2">Sub Total</div>
                <div class="grid grid-cols-[1fr_auto] gap-x-3 text-[13px]">
                  <div class="text-gray-600">Exp</div><div class="text-right tabular-nums" id="m-sub-exp-${i}">0</div>
                  <div class="text-gray-600">100 Enhancement XP Component</div><div class="text-right tabular-nums" id="m-sub-nut-${i}">0</div>
                  <div class="text-gray-600">Mithril</div><div class="text-right tabular-nums" id="m-sub-mith-${i}">0</div>
                  <div class="text-gray-600">Mythic Gear</div><div class="text-right tabular-nums" id="m-sub-legend-${i}">0</div>
                </div>
              </div>
            </div>
          </div>
        `;
        grid.appendChild(card);

        const curSelect = card.querySelector(`#start-${i}`);
        const tgtSelect = card.querySelector(`#end-${i}`);

        const onChange = () => { updateMithrilSubtotals(i); updateMithrilTotals(); };
        curSelect.addEventListener("change", () => { tgtSelect.value = curSelect.value; onChange(); });
        tgtSelect.addEventListener("change", onChange);

        // Ï¥àÍ∏∞ 1Ìöå Í≥ÑÏÇ∞
        updateMithrilSubtotals(i);
      });

      // Î≥¥Ïú† ÏûÖÎ†• Î≥ÄÌôî Ïãú Ï¥ùÌï©Í≥Ñ Í∞±Ïã†
      ["own-ÎÑàÌä∏","own-ÎØ∏Ïä§Î¶¥","own-Î†àÏ†ÑÎìúÏû•ÎπÑ"].forEach(id=>{
        document.getElementById(id)?.addEventListener("input", updateMithrilTotals);
      });

      updateMithrilTotals();
    }

    function updateMithrilSubtotals(i) {
      const cur = document.getElementById(`start-${i}`).value;
      const tgt = document.getElementById(`end-${i}`).value;
      const sIdx = stageList.indexOf(cur);
      const eIdx = stageList.indexOf(tgt);

      const sums = { exp:0, nut:0, mith:0, legend:0 };
      if (sIdx >= 0 && eIdx > sIdx) {
        for (let j = sIdx + 1; j <= eIdx; j++) {
          const r = csvData[j];
          sums.exp    += parseFloat(r["Í≤ΩÌóòÏπò"] || "0");
          sums.nut    += parseFloat(r["ÎÑàÌä∏"] || "0");
          sums.mith   += parseFloat(r["ÎØ∏Ïä§Î¶¥"] || "0");
          sums.legend += parseFloat(r["Î†àÏ†ÑÎìúÏû•ÎπÑ"] || "0");
        }
      }
      document.getElementById(`m-sub-exp-${i}`).textContent    = sums.exp.toLocaleString();
      document.getElementById(`m-sub-nut-${i}`).textContent    = sums.nut.toLocaleString();
      document.getElementById(`m-sub-mith-${i}`).textContent   = sums.mith.toLocaleString();
      document.getElementById(`m-sub-legend-${i}`).textContent = sums.legend.toLocaleString();
    }

    function updateMithrilTotals(){
      let total = { exp:0, nut:0, mith:0, leg:0 };
      slotNames.forEach((_, i)=>{
        const cur = document.getElementById(`start-${i}`).value;
        const tgt = document.getElementById(`end-${i}`).value;
        const sIdx = stageList.indexOf(cur);
        const eIdx = stageList.indexOf(tgt);
        if (sIdx < 0 || eIdx <= sIdx) return;

        for(let j=sIdx+1;j<=eIdx;j++){
          const r = csvData[j];
          total.exp += +(r["Í≤ΩÌóòÏπò"]||0);
          total.nut += +(r["ÎÑàÌä∏"]||0);
          total.mith+= +(r["ÎØ∏Ïä§Î¶¥"]||0);
          total.leg += +(r["Î†àÏ†ÑÎìúÏû•ÎπÑ"]||0);
        }
      });

      const own = {
        nut: +(document.getElementById("own-ÎÑàÌä∏")?.value || 0),
        mith:+(document.getElementById("own-ÎØ∏Ïä§Î¶¥")?.value || 0),
        leg: +(document.getElementById("own-Î†àÏ†ÑÎìúÏû•ÎπÑ")?.value || 0),
      };

      // ÌëúÍ∏∞
      document.getElementById("tot-exp").textContent  = total.exp.toLocaleString();
      document.getElementById("tot-nut").textContent  = total.nut.toLocaleString();
      document.getElementById("tot-mith").textContent = total.mith.toLocaleString();
      document.getElementById("tot-leg").textContent  = total.leg.toLocaleString();

      document.getElementById("own-nut").textContent  = own.nut.toLocaleString();
      document.getElementById("own-mith").textContent = own.mith.toLocaleString();
      document.getElementById("own-leg").textContent  = own.leg.toLocaleString();

      document.getElementById("def-exp").textContent  = total.exp.toLocaleString(); // Í≤ΩÌóòÏπòÎäî Î≥¥Ïú†Ïπò Í∞úÎÖê ÏóÜÏùå
      document.getElementById("def-nut").textContent  = (own.nut-total.nut).toLocaleString();
      document.getElementById("def-mith").textContent = (own.mith-total.mith).toLocaleString();
      document.getElementById("def-leg").textContent  = (own.leg-total.leg).toLocaleString();
    }

    // ÏµúÏ¥à Î°úÎî©
    loadMithrilCSV();
  </script>

  <!-- ========== üìô ÎßàÏä§ÌÑ∞Î¶¨ Î°úÏßÅ ========== -->
  <script>
    const masteryUrl = "https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Hero/Mastery.csv";
    const masterySlots = ["Í≥†Í∏Ä", "Ïû•Í∞ë", "Î≤®Ìä∏", "Ïã†Î∞ú"];
    const nameAliasMap2 = {
      "Í≥†Í∏Ä": "Goggles",
      "Ïû•Í∞ë": "Gauntlets",
      "Î≤®Ìä∏": "Belt",
      "Ïã†Î∞ú": "Boots"
    };
    let masteryLevels = [];
    let masteryData = [];

    async function loadMasteryCSV() {
      try{
        const res = await fetch(masteryUrl, {cache:"no-store"});
        const text = await res.text();
        const lines = text.trim().split("\n").map(row => row.split(","));
        const headers = lines[0];
        masteryData = lines.slice(1).map(row => {
          const obj = {};
          headers.forEach((h, i) => obj[h.trim()] = (row[i] ?? "").trim() || "0");
          return obj;
        });
        masteryLevels = masteryData.map(r => r["Î†àÎ≤®"]);
      }catch(e){
        // Í∞ÑÎã®Ìïú Ìè¥Î∞± (Î†àÎ≤® 1~5)
        masteryData = [
          {Î†àÎ≤®:"1", ÎßàÏä§ÌÑ∞Î¶¨ÏÑù:"0", Î†àÏ†ÑÎìúÏû•ÎπÑ:"0"},
          {Î†àÎ≤®:"2", ÎßàÏä§ÌÑ∞Î¶¨ÏÑù:"10", Î†àÏ†ÑÎìúÏû•ÎπÑ:"0"},
          {Î†àÎ≤®:"3", ÎßàÏä§ÌÑ∞Î¶¨ÏÑù:"22", Î†àÏ†ÑÎìúÏû•ÎπÑ:"0"},
          {Î†àÎ≤®:"4", ÎßàÏä§ÌÑ∞Î¶¨ÏÑù:"36", Î†àÏ†ÑÎìúÏû•ÎπÑ:"1"},
          {Î†àÎ≤®:"5", ÎßàÏä§ÌÑ∞Î¶¨ÏÑù:"52", Î†àÏ†ÑÎìúÏû•ÎπÑ:"1"},
        ];
        masteryLevels = masteryData.map(r=>r["Î†àÎ≤®"]);
      }
      renderMasteryUI();
      sendHeightToParent();
    }

    function renderMasteryUI() {
      const grid = document.getElementById("masteryGrid");
      grid.innerHTML = "";

      masterySlots.forEach((name, i) => {
        const displayName = nameAliasMap2[name] || name
        const options = masteryLevels.map(lv => `<option value="${lv}">${lv}</option>`).join("");
        const card = document.createElement("div");
        card.className = "exp-card";
        card.innerHTML = `
          <div class="p-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <div class="flex items-center gap-2 mb-2">
                  <h3 class="text-[15px] font-semibold text-gray-800">${displayName}</h3>
                </div>
                <div class="grid grid-cols-1 gap-2">
                  <div class="flex items-center justify-between gap-2">
                    <span class="text-[12px] text-gray-600">Current</span>
                    <select id="m-start-${i}" class="border rounded-lg px-2 py-1 text-sm min-w-[120px]">${options}</select>
                  </div>
                  <div class="flex items-center justify-between gap-2">
                    <span class="text-[12px] text-gray-600">Target</span>
                    <select id="m-end-${i}" class="border rounded-lg px-2 py-1 text-sm min-w-[120px]">${options}</select>
                  </div>
                </div>
              </div>
              <div class="md:pl-4">
                <div class="font-semibold text-gray-800 mb-2">Sub Total</div>
                <div class="grid grid-cols-[1fr_auto] gap-x-3 text-[13px]">
                  <div class="text-gray-600">Essence Stone</div><div class="text-right tabular-nums" id="ms-sub-stone-${i}">0</div>
                  <div class="text-gray-600">Mythic Gear</div><div class="text-right tabular-nums" id="ms-sub-legend-${i}">0</div>
                </div>
              </div>
            </div>
          </div>`;
        grid.appendChild(card);

        const curSelect = card.querySelector(`#m-start-${i}`);
        const tgtSelect = card.querySelector(`#m-end-${i}`);

        const onChange = () => { updateMasterySubtotals(i); updateMasteryTotals(); };
        curSelect.addEventListener("change", () => { tgtSelect.value = curSelect.value; onChange(); });
        tgtSelect.addEventListener("change", onChange);

        updateMasterySubtotals(i);
      });

      ["owned-ÎßàÏä§ÌÑ∞Î¶¨ÏÑù","owned-Î†àÏ†ÑÎìúÏû•ÎπÑ"].forEach(id=>{
        document.getElementById(id)?.addEventListener("input", updateMasteryTotals);
      });

      updateMasteryTotals();
    }

    function updateMasterySubtotals(i) {
      const cur = document.getElementById(`m-start-${i}`).value;
      const tgt = document.getElementById(`m-end-${i}`).value;
      const sIdx = masteryLevels.indexOf(cur);
      const eIdx = masteryLevels.indexOf(tgt);

      const sums = { stone:0, legend:0 };
      if (sIdx >= 0 && eIdx > sIdx) {
        for (let j = sIdx + 1; j <= eIdx; j++) {
          const r = masteryData[j];
          sums.stone  += parseFloat(r["ÎßàÏä§ÌÑ∞Î¶¨ÏÑù"] || "0");
          sums.legend += parseFloat(r["Î†àÏ†ÑÎìúÏû•ÎπÑ"] || "0");
        }
      }
      document.getElementById(`ms-sub-stone-${i}`).textContent  = sums.stone.toLocaleString();
      document.getElementById(`ms-sub-legend-${i}`).textContent = sums.legend.toLocaleString();
    }

    function updateMasteryTotals(){
      let total = { stone:0, leg:0 };
      masterySlots.forEach((_, i)=>{
        const cur = document.getElementById(`m-start-${i}`).value;
        const tgt = document.getElementById(`m-end-${i}`).value;
        const sIdx = masteryLevels.indexOf(cur);
        const eIdx = masteryLevels.indexOf(tgt);
        if (sIdx < 0 || eIdx <= sIdx) return;

        for(let j=sIdx+1;j<=eIdx;j++){
          const r = masteryData[j];
          total.stone += +(r["ÎßàÏä§ÌÑ∞Î¶¨ÏÑù"]||0);
          total.leg   += +(r["Î†àÏ†ÑÎìúÏû•ÎπÑ"]||0);
        }
      });

      const own = {
        stone: +(document.getElementById("owned-ÎßàÏä§ÌÑ∞Î¶¨ÏÑù")?.value || 0),
        leg:   +(document.getElementById("owned-Î†àÏ†ÑÎìúÏû•ÎπÑ")?.value || 0),
      };

      document.getElementById("ms-tot-stone").textContent = total.stone.toLocaleString();
      document.getElementById("ms-tot-leg").textContent   = total.leg.toLocaleString();
      document.getElementById("ms-own-stone").textContent = own.stone.toLocaleString();
      document.getElementById("ms-own-leg").textContent   = own.leg.toLocaleString();
      document.getElementById("ms-def-stone").textContent = (own.stone-total.stone).toLocaleString();
      document.getElementById("ms-def-leg").textContent   = (own.leg-total.leg).toLocaleString();
    }

    // ÏµúÏ¥à Î°úÎî©
    loadMasteryCSV();
  </script>

  <!-- ========== (ÏÑ†ÌÉù) ÌÇ§ Ï∞®Îã®: Ïõê ÏΩîÎìú Ïú†ÏßÄ ÏäµÍ¥Ä ========== -->
  <script>
    document.addEventListener("contextmenu", e => e.preventDefault());
    document.addEventListener("keydown", function (e) {
      if (e.key === "F12" || (e.ctrlKey && e.shiftKey && (e.key === "I" || e.key === "J")) ||
          (e.ctrlKey && (e.key === "U" || e.key === "S"))) {
        e.preventDefault();
      }
    });
  </script>
  <script>
    window.addEventListener('message', (e) => {
      if (e.data?.type === 'DARK_MODE') {
        document.body.classList.toggle('dark-mode', e.data.value);
      }
    });
  </script>  
</body>
</html>
