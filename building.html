<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ê±´ë¬¼ ê³„ì‚°ê¸°</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6 font-sans">
  <div class="max-w-5xl mx-auto bg-white p-6 rounded shadow">
    <h2 class="text-2xl font-bold text-blue-600 mb-4">ğŸ— ê±´ë¬¼ ê³„ì‚°ê¸°</h2>
    <form id="buildingForm" class="space-y-6">
      <div id="buildingGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div><label class="block font-semibold">ë³´ìœ  ë¶ˆìˆ˜ì •</label><input type="number" id="owned-ë¶ˆìˆ˜ì •" class="w-full border rounded p-2" /></div>
        <div><label class="block font-semibold">ë³´ìœ  ì •ì œ</label><input type="number" id="owned-ì •ì œ" class="w-full border rounded p-2" /></div>
      </div>
      <button type="button" onclick="calculateBuildings()" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">ê³„ì‚°í•˜ê¸°</button>
    </form>
    <div id="buildingResult" class="mt-6"></div>
  </div>

<script>
const sheetID = "1vtW4diWsB4OoSK70nYa6ve1nRPHrhWg-rf76NlsRM08";
const buildingList = ["ìš©ê´‘ë¡œ", "ëŒ€ì‚¬ê´€", "ì§€íœ˜ë¶€", "ì˜ë¬´ì‹¤", "ë°©íŒ¨ë³‘", "ì°½ë³‘", "ê¶ë³‘", "ì•„ì¹´ë°ë¯¸"];

async function fetchLevels(building) {
  const url = `https://opensheet.elk.sh/${sheetID}/${building}`;
  const res = await fetch(url);
  const data = await res.json();
  return data.map(d => d["ë ˆë²¨"]).filter(Boolean);
}

async function loadBuildingGrid() {
  const grid = document.getElementById("buildingGrid");
  const levels = await fetchLevels(buildingList[0]);

  buildingList.forEach((name, i) => {
    const options = levels.map(lv => `<option value="${lv}">${lv}</option>`).join("");
    grid.innerHTML += `
      <div class="border rounded bg-blue-50 p-2 col-span-1">
        <label class="flex items-center text-sm font-semibold mb-1">
          <input type="checkbox" id="building-check-${i}" class="w-5 h-5 mr-1 accent-blue-500" />
          ${name}
        </label>
        <select id="building-cur-${i}" class="w-full border rounded text-sm p-1 mb-1">${options}</select>
        <select id="building-tgt-${i}" class="w-full border rounded text-sm p-1">${options}</select>
      </div>
    `;
  });
}

function round1(value) {
   return Math.round((value + Number.EPSILON) * 10) / 10;
}

async function calculateBuildings() {
  let total = { ë¶ˆìˆ˜ì •: 0, ì •ì œ: 0, ê³ ê¸°: 0, ë‚˜ë¬´: 0, ì„íƒ„: 0, ì² ê´‘: 0 };
  let rows = "";

  for (let i = 0; i < buildingList.length; i++) {
    if (!document.getElementById(`building-check-${i}`).checked) continue;

    const name = buildingList[i];
    const cur = document.getElementById(`building-cur-${i}`).value;
    const tgt = document.getElementById(`building-tgt-${i}`).value;
    const url = `https://opensheet.elk.sh/${sheetID}/${name}`;
    const res = await fetch(url);
    const data = await res.json();
    const levels = data.map(d => d["ë ˆë²¨"]);
    const start = levels.indexOf(cur);
    const end = levels.indexOf(tgt);

    if (start === -1 || end === -1 || start >= end) {
      rows += `<tr><td colspan="4" class="border p-1 text-red-600">âš ï¸ ${name}: ì˜ëª»ëœ ë ˆë²¨</td></tr>`;
      continue;
    }

    let subtotal = { ë¶ˆìˆ˜ì •: 0, ì •ì œ: 0, ê³ ê¸°: 0, ë‚˜ë¬´: 0, ì„íƒ„: 0, ì² ê´‘: 0 };
    for (let j = start + 1; j <= end; j++) {
      subtotal.ë¶ˆìˆ˜ì • += parseFloat(data[j]["ë¶ˆìˆ˜ì •"] || 0);
      subtotal.ì •ì œ += parseFloat(data[j]["ì •ì œ"] || 0);
      subtotal.ê³ ê¸° += parseFloat(data[j]["ê³ ê¸°"] || 0);
      subtotal.ë‚˜ë¬´ += parseFloat(data[j]["ë‚˜ë¬´"] || 0);
      subtotal.ì„íƒ„ += parseFloat(data[j]["ì„íƒ„"] || 0);
      subtotal.ì² ê´‘ += parseFloat(data[j]["ì² ê´‘"] || 0);
    }

    total.ë¶ˆìˆ˜ì • += subtotal.ë¶ˆìˆ˜ì •;
    total.ì •ì œ += subtotal.ì •ì œ;

    rows += `
      <tr class="text-center">
        <td class="border p-1">${name}</td>
        <td class="border p-1">${cur} â†’ ${tgt}</td>
        <td class="border p-1">${subtotal.ë¶ˆìˆ˜ì •.toLocaleString()}</td>
        <td class="border p-1">${subtotal.ì •ì œ.toLocaleString()}</td>
        <td class="border p-1">${round1(subtotal.ê³ ê¸°).toLocaleString()}</td>
        <td class="border p-1">${round1(subtotal.ë‚˜ë¬´).toLocaleString()}</td>
        <td class="border p-1">${round1(subtotal.ì„íƒ„).toLocaleString()}</td>
        <td class="border p-1">${round1(subtotal.ì² ê´‘).toLocaleString()}</td>
      </tr>
    `;
  }

  const ownedë¶ˆìˆ˜ì • = parseFloat(document.getElementById("owned-ë¶ˆìˆ˜ì •").value) || 0;
  const ownedì •ì œ = parseFloat(document.getElementById("owned-ì •ì œ").value) || 0;

  rows += `
    <tr class="font-bold bg-blue-100 text-center">
      <td class="border p-1" colspan="2">ì´í•©</td>
      <td class="border p-1">${total.ë¶ˆìˆ˜ì •.toLocaleString()}</td>
      <td class="border p-1">${total.ì •ì œ.toLocaleString()}</td>
      <td class="border p-1">${round1(total.ê³ ê¸°).toLocaleString()}</td>
      <td class="border p-1">${round1(total.ë‚˜ë¬´).toLocaleString()}</td>
      <td class="border p-1">${round1(total.ì„íƒ„).toLocaleString()}</td>
      <td class="border p-1">${round1(total.ì² ê´‘).toLocaleString()}</td>
    </tr>
    <tr class="font-bold bg-red-50 text-center">
      <td class="border p-1" colspan="2">ê³¼ë¶€ì¡±</td>
      <td class="border p-1">${(ownedë¶ˆìˆ˜ì • - total.ë¶ˆìˆ˜ì •).toLocaleString()}</td>
      <td class="border p-1">${(ownedì •ì œ - total.ì •ì œ).toLocaleString()}</td>
      <td class="border p-1" colspan="4"></td>
    </tr>
  `;

  document.getElementById("buildingResult").innerHTML = `
    <table class="w-full table-auto border mt-4 text-sm text-center">
      <thead class="bg-gray-100">
        <tr>
          <th class="border p-1">ê±´ë¬¼</th>
          <th class="border p-1">ë ˆë²¨</th>
          <th class="border p-1">ë¶ˆìˆ˜ì •</th>
          <th class="border p-1">ì •ì œ</th>
          <th class="border p-1">ê³ ê¸°</th>
          <th class="border p-1">ë‚˜ë¬´</th>
          <th class="border p-1">ì„íƒ„</th>
          <th class="border p-1">ì² ê´‘</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

loadBuildingGrid();
</script>
  <script>
    document.addEventListener("contextmenu", event => event.preventDefault());
    document.addEventListener("keydown", function (e) {
      if (
        e.key === "F12" ||
        (e.ctrlKey && e.shiftKey && (e.key === "I" || e.key === "J")) ||
        (e.ctrlKey && (e.key === "U" || e.key === "S"))
      ) {
        e.preventDefault();
      }
    });
  </script>
</body>
</html>
