<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ê±´ë¬¼ ê³„ì‚°ê¸°</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    /* ëª¨ë°”ì¼ í˜ì´ì§€ ë¶„ê¸°(ì› ì½”ë“œ ìœ ì§€ ê°€ëŠ¥) */
    const ua = navigator.userAgent || navigator.vendor || window.opera;
    const width = window.innerWidth;
    const isMobile = /android|iphone|ipod|blackberry|windows phone/i.test(ua.toLowerCase()) && width <= 640;
    const isOnMobilePage = location.pathname.includes('building_m');
    if (isMobile && !isOnMobilePage) {
      // í•„ìš” ì‹œ ëª¨ë°”ì¼ ì „ìš© í˜ì´ì§€ê°€ ìˆë‹¤ë©´ ì‚¬ìš©
      // window.location.href = "building_m.html";
    }
  </script>
  <style>
    /* ë‹¤í¬ëª¨ë“œ */
    body.dark-mode { background:#121212; color:#f0f0f0; }
    .dark-mode .border { border-color:#444 !important; }
    .dark-mode .bg-white { background:#2c2c2c !important; color:#f0f0f0 !important; }
    .dark-mode .bg-gray-100 { background:#1e1e1e !important; }
    .dark-mode .text-gray-800, 
    .dark-mode .text-gray-700, 
    .dark-mode .text-gray-600 { color:#dddddd !important; }
    .dark-mode table { background:#2c2c2c; color:#f0f0f0; }
    .dark-mode th, 
    .dark-mode td { border-color:#444 !important; }
    .dark-mode select, 
    .dark-mode select option,     
    .dark-mode input,
    .dark-mode #chkExpertA,
    .dark-mode #chkExpertV,
    .dark-mode #buffSelect,
    .dark-mode #buffSelect option,
    .dark-mode #buffSelect:disabled {
      color:#fff !important; background:#2c2c2c !important;
    }
    
    .dark-mode .svs-score-label,
    .dark-mode .svs-score-value {
      font-weight: 700;
      color: #16AC7A !important;
    }
    /* experts ìŠ¤íƒ€ì¼ ì¹´ë“œ */
    .exp-card{
      border:1px solid rgba(0,0,0,.08);
      border-radius:16px;
      background:#fff;
      box-shadow:0 6px 18px rgba(15,23,42,.06);
      transition: box-shadow .2s ease;
    }
    .exp-card:hover{ box-shadow:0 10px 26px rgba(15,23,42,.12); }
    .muted{ font-size:12px; color:#6b7280; }
    body.dark-mode .exp-card{ background:#2c2c2c !important; border-color:#444 !important; }
    body.dark-mode .muted{ color:#b7b7b7 !important; }
  </style>
  <script>
    /* ë‹¤í¬ëª¨ë“œ ìœ ì§€ */
    window.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
      }
    });
  </script>
</head>
<body class="bg-gray-100 p-2 font-sans text-sm">
  <div class="max-w-[1500px] mx-auto bg-white p-3 rounded-xl shadow-md">
    <h1 class="text-2xl font-bold text-gray-800 mb-4">ğŸ—ï¸ ê±´ë¬¼ ê³„ì‚°ê¸°</h1>

    <!-- ì„¤ëª… -->
    <div class="text-gray-600 mb-4 text-sm">
      <div class="mb-4">
        <p>ê° ê±´ë¬¼ ì—…ê·¸ë ˆì´ë“œì— í•„ìš”í•œ ìì›(ë¶ˆìˆ˜ì •, ì •ì œ, ê³ ê¸°, ë‚˜ë¬´, ì„íƒ„, ì² ê´‘)ê³¼ ê±´ì„¤ì‹œê°„ì„ ê³„ì‚°í•©ë‹ˆë‹¤.</p>
        <p>ê±´ë¬¼ë³„ë¡œ í˜„ì¬/ëª©í‘œ ë ˆë²¨ì„ ì§€ì •í•˜ë©´ ìë™ í•©ì‚°ë©ë‹ˆë‹¤.</p>
        <p>í•˜ë‹¨ì— ì´í•©ê³„ì— ê±´ë¬¼ì˜ í•„ìš”í•©ê³„ë“¤ì„ í•©ì‚°í•˜ì—¬ í‘œì‹œí•©ë‹ˆë‹¤.</p>
      </div>
			
			<label class="inline-flex items-center gap-2 mb-2 font-semibold text-[15px] text-red-600 ">
				<input type="checkbox" id="fireCrystalToggle">ë¶ˆì˜ ìˆ˜ì • ë‹¨ê³„
			</label>

      <!-- ë²„í”„/ì†ë„
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3">
        <label class="inline-flex items-center font-semibold">
          <input type="checkbox" id="chkVP" class="mr-2 w-4 h-4"> ì¼ë°˜)ë¶€ì§‘í–‰ê´€(VP) (10%)
        </label>
        <label class="inline-flex items-center font-semibold">
          <input type="checkbox" id="chkSPVP" class="mr-2 w-4 h-4"> ìµœì§‘)ë¶€ì§‘í–‰ê´€(VP) (15%)
        </label>
        <label class="inline-flex items-center font-semibold">
          <input type="checkbox" id="chkServerBuff" class="mr-2 w-4 h-4"> ê±´ì„¤ì„œë²„ë²„í”„ (10%)
        </label>
        <div class="flex items-center">
          <span class="font-semibold">ê±´ì„¤ì†ë„ (%)</span>
          <input type="number" id="buildSpeed" min="0" class="ml-2 border rounded p-2 text-sm w-20 text-right" placeholder="0" />
        </div>
        <div class="flex items-center">
          <label class="inline-flex items-center font-semibold">
            <input type="checkbox" id="chkPetBuff" class="mr-2 w-4 h-4" /> í«ë²„í”„
          </label>
          <select id="buffSelect" class="ml-2 border rounded p-1 text-sm bg-gray-100 pointer-events-none" disabled>
            <option value="0">ì„ íƒ ì—†ìŒ</option>
            <option value="5">5%</option>
            <option value="7">7%</option>
            <option value="9">9%</option>
            <option value="12">12%</option>
            <option value="15">15%</option>
          </select>
        </div>
        <label class="inline-flex items-center font-semibold">
          <input type="checkbox" id="chkCityBuff" class="mr-2 w-4 h-4" /> ì‹œì²­ë²„í”„ (ê±´ì„¤ì‹œê°„ 20% ë‹¨ì¶•)
        </label>
      </div>
       -->
      <!-- Configuration Card -->
      <!-- ìƒë‹¨ ê·¸ë¦¬ë“œ -->
      <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-6 gap-4">
        <div>
          <label class="block text-sm mb-1">ê±´ì„¤ì†ë„(%)</label>
          <input type="number" id="buildSpeed" min="0"
                 class="border rounded p-2 text-sm w-full text-right"
                 placeholder="0" />
        </div>

        <div>
          <label class="block text-sm mb-1">í« ìŠ¤í‚¬</label>
          <select id="buffSelect" class="w-full border rounded p-1 px-3 py-2">
            <option>None</option>
            <option>Lv.1</option><option>Lv.2</option><option>Lv.3</option><option>Lv.4</option><option>Lv.5</option>
          </select>
        </div>

        <div>
          <label class="block text-sm mb-1">ì•„ê·¸ë„¤ìŠ¤</label>
          <select id="chkExpertA" class="w-full rounded-md border px-3 py-2">
            <option>None</option>
            <option>Lv.1</option><option>Lv.2</option><option>Lv.3</option><option>Lv.4</option><option>Lv.5</option>
          </select>
        </div>
        <div>
          <label class="block text-sm mb-1">ë°œë ˆë¦¬ì•„</label>
          <select id="chkExpertV" class="w-full rounded-md border px-2 py-2">
            <option>None</option>
            <option>Lv.1</option><option>Lv.2</option><option>Lv.3</option><option>Lv.4</option><option>Lv.5</option>
            <option>Lv.6</option><option>Lv.7</option><option>Lv.8</option><option>Lv.9</option><option>Lv.10</option>
          </select>
        </div>

        <!-- ë¶€ì§‘í–‰ê´€ -->
        <div>
          <div class="text-sm font-medium mb-1">ë¶€ì§‘í–‰ê´€ ê´€ì§ ë²„í”„</div>
          <div class="flex flex-wrap gap-2">
            <button type="button" data-group="vp" data-vp="10"
                    class="w-[110px] vp-btn px-4 py-2 rounded-md border">
              10%
            </button>
            <button type="button" data-group="vp" data-vp="15"
                    class="w-[110px] vp-btn px-4 py-2 rounded-md border">
              15%
            </button>
          </div>
        </div>

        <!-- ì„œë²„ë²„í”„ -->
        <div>
          <div class="text-sm font-medium mb-1">ì„œë²„ë²„í”„ (10%)</div>
          <div class="flex flex-wrap gap-2">
            <button type="button" id="chkServerBuff"
                    class="w-[110px] toggle-btn px-4 py-2 rounded-md border"
                    aria-pressed="false">
              í™œì„±í™”
            </button>
          </div>
        </div>

        <!-- ì‹œì²­ë²„í”„ -->
        <div>
          <div class="inline-flex items-center font-semibold mb-1">ì‹œì²­ë²„í”„</div>
          <div class="flex flex-wrap gap-2">
            <button type="button" id="chkCityBuff"
                    class="w-full toggle-btn px-4 py-2 rounded-md border"
                    aria-pressed="false">
              ê±´ì„¤ì‹œê°„ 20% ë‹¨ì¶•
            </button>
          </div>
        </div>       
      </div>

    </div>

    <!-- ê±´ë¬¼ ì¹´ë“œ ê·¸ë¦¬ë“œ -->    
    <div id="buildingGridBody" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 xl:grid-cols-2 gap-4"></div>

    <!-- ë³´ìœ  ìì› ì¹´ë“œ
    <div class="exp-card mt-4">
      <div class="p-4">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-[15px] font-semibold text-gray-800">ë³´ìœ  ìì›</h3>
          <span class="muted">ì…ë ¥ ì‹œ ìë™ ê³„ì‚°</span>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label for="owned-ë¶ˆìˆ˜ì •" class="block text-[15px] text-gray-600 mb-1">ë³´ìœ  ë¶ˆìˆ˜ì •</label>
            <input type="number" id="owned-ë¶ˆìˆ˜ì •" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="0" min="0" inputmode="numeric" />
          </div>
          <div>
            <label for="owned-ì •ì œ" class="block text-[15px] text-gray-600 mb-1">ë³´ìœ  ì •ì œ</label>
            <input type="number" id="owned-ì •ì œ" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="0" min="0" inputmode="numeric" />
          </div>
        </div>
      </div>
    </div> -->

    <!-- ì´í•©ê³„ íŒ¨ë„ (ì œëª© ë¬¸êµ¬ ì œê±°)
    <div id="summaryPanel" class="exp-card mt-4">
      <div class="p-4">
        <!-- ì œëª© ì œê±°
        <div id="summaryBody"></div>
      </div>
    </div>
    -->
    <!-- ì´í•©ê³„ íŒ¨ë„ (ì •ì  DOM) -->
    <div id="summaryPanel" class="exp-card mt-4">
      <div class="p-4">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
          <!-- ì´í•© -->
          <div class="rounded-xl border border-black/10 p-3">
            <div class="font-semibold mb-2">ì´í•©</div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">ë¶ˆìˆ˜ì •</span><span id="sum-ë¶ˆìˆ˜ì •">0</span></div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">ì •ì œ</span><span id="sum-ì •ì œ">0</span></div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">ê³ ê¸°</span><span id="sum-ê³ ê¸°">0</span></div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">ë‚˜ë¬´</span><span id="sum-ë‚˜ë¬´">0</span></div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">ì„íƒ„</span><span id="sum-ì„íƒ„">0</span></div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">ì² ê´‘</span><span id="sum-ì² ê´‘">0</span></div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">ê±´ì„¤ì‹œê°„</span><span id="sum-ì‹œê°„">0ë¶„</span></div>
          </div>
    
          <!-- ë³´ìœ ëŸ‰ -->
          <div class="rounded-xl border border-black/10 p-3">
            <div class="flex items-center justify-between mb-2">
              <div class="font-semibold">ë³´ìœ ëŸ‰</div>
              <span class="muted">ì…ë ¥ ì‹œ ìë™ ê³„ì‚°</span>
            </div>
            <div class="space-y-3">
              <div>
                <label for="owned-ë¶ˆìˆ˜ì •" class="block text-[13px] text-gray-600 mb-1">ë³´ìœ  ë¶ˆìˆ˜ì •</label>
                <input type="number" id="owned-ë¶ˆìˆ˜ì •" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="0" min="0" inputmode="numeric" />
              </div>
              <div>
                <label for="owned-ì •ì œ" class="block text-[13px] text-gray-600 mb-1">ë³´ìœ  ì •ì œ</label>
                <input type="number" id="owned-ì •ì œ" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="0" min="0" inputmode="numeric" />
              </div>
            </div>
          </div>
    
          <!-- ê³¼ë¶€ì¡± -->
          <div class="rounded-xl border border-black/10 p-3">
            <div class="font-semibold mb-2">ê³¼ë¶€ì¡±</div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">ë¶ˆìˆ˜ì •</span><span id="def-ë¶ˆìˆ˜ì •">0</span></div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">ì •ì œ</span><span id="def-ì •ì œ">0</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>	
  <script>
    /* ìœ í‹¸ */
    //function sendHeightToParent(){ const h=document.body.scrollHeight+10; window.parent?.postMessage({type:"FRAME_CHANGE",height:h},"*"); }
//    window.addEventListener("load", ()=> setTimeout(sendHeightToParent,100));
//
//    const buildingList = ["ìš©ê´‘ë¡œ","ëŒ€ì‚¬ê´€","ì§€íœ˜ë¶€","ì˜ë¬´ì‹¤","ë°©íŒ¨ë³‘","ì°½ë³‘","ê¶ë³‘","ì•„ì¹´ë°ë¯¸"];
//    const resources = ["ë¶ˆìˆ˜ì •","ì •ì œ","ê³ ê¸°","ë‚˜ë¬´","ì„íƒ„","ì² ê´‘","ë³€í™˜ì‹œê°„"];
//    const buildingData = {};
//    let buildingCards = []; // {name, maxIndex}
//
//    const nf1 = new Intl.NumberFormat('ko-KR', { minimumFractionDigits: 0, maximumFractionDigits: 1 });
//
//    function formatValue(value){
//      const num = Number(String(value ?? 0).replace(/,/g, ''));
//      if (isNaN(num)) return value;
//      
//      const r1 = Math.round((num + Number.EPSILON) * 10) / 10;
//      if (r1 >= 1000) return nf1.format(r1 / 1000) + "B";
//      
//      return nf1.format(r1) + "M";
//    }
//    
//    function formatHourToTime(hours){
//      if (!hours || isNaN(hours)) return "0ë¶„";
//      const totalMinutes = Math.round(hours*60);
//      const d = Math.floor(totalMinutes/1440);
//      const h = Math.floor((totalMinutes%1440)/60);
//      const m = totalMinutes%60;
//      return `${d?d+'ì¼ ':''}${h?h+'ì‹œê°„ ':''}${(m||(!d&&!h))?m+'ë¶„':''}`.trim();
//    }
//
//    function handleVPCheck(which){
//      const v=document.getElementById("chkVP");
//      const s=document.getElementById("chkSPVP");
//      if(which==="chkVP" && v.checked) s.checked=false;
//      if(which==="chkSPVP" && s.checked) v.checked=false;
//      scheduleCalc();
//    }
//    function togglePetBuffSelect(){
//      const cb=document.getElementById("chkPetBuff");
//      const sel=document.getElementById("buffSelect");
//      sel.disabled = !cb.checked;
//      sel.classList.toggle("pointer-events-none",!cb.checked);
//      sel.classList.toggle("bg-white",cb.checked);
//      sel.classList.toggle("bg-gray-100",!cb.checked);
//      scheduleCalc();
//    }
//
//    async function fetchBuildingData(){
//      for (const name of buildingList){
//        const url = `https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/building/${name}.csv`;
//        const res = await fetch(url);
//        const text = await res.text();
//        const lines = text.trim().split("\n");
//        const headers = lines[0].split(",");
//        const data = lines.slice(1).map(line=>{
//          const obj = {};
//          const values = line.split(",");
//          headers.forEach((h,i)=> obj[h.trim()] = (values[i]?.trim() || "0"));
//          return obj;
//        });
//        buildingData[name]=data;
//      }
//      renderBuildingSelectors();
//      scheduleCalc();
//    }
//
//    function renderBuildingSelectors(){
//      const container = document.getElementById("buildingGridBody");
//			
//      // âœ… ê¸°ì¡´ ì„ íƒê°’ ë³´ì¡´
//			const prev = {};
//			if (container && container.children.length) {
//				[...container.querySelectorAll('.exp-card')].forEach(card => {
//					const nameEl = card.querySelector('h3');
//					if (!nameEl) return;
//					const bname = nameEl.textContent.trim();
//					const startSel = card.querySelector(`#start-${bname}`);
//					const endSel   = card.querySelector(`#end-${bname}`);
//					if (startSel && endSel) {
//						prev[bname] = { start: startSel.value, end: endSel.value };
//					}
//				});
//			}
//													
//      container.innerHTML = "";
//      buildingCards = [];
//
//      buildingList.forEach(name=>{
//        //const levels = buildingData[name].map(d=> d["ë ˆë²¨"]);
//        //const options = levels.map((lv,i)=> `<option value="${i}">${lv}</option>`).join("");
//        //const maxIndex = levels.length-1;
//				const levelsFull = buildingData[name].map(d=> d["ë ˆë²¨"]); // ì›ë³¸ ëª¨ë“  ë¼ë²¨
//				const filtered = filterLevelsWithIndex(levelsFull, useFireCrystal); // [{idx,label}]
//
//				// âœ… ì˜µì…˜ì€ "í™”ë©´ ë¼ë²¨ì€ filtered.label" / "valueëŠ” ì›ë³¸ idx"
//				const options = filtered
//					.map(({idx, label}) => `<option value="${idx}">${label}</option>`)
//					.join("");
//
//				const maxLabel = filtered.length ? filtered[filtered.length-1].label : (levelsFull[levelsFull.length-1] || '');
//
//        const card = document.createElement("div");
//        card.className = "exp-card";
//        card.innerHTML = `
//          <div class="p-4">
//            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
//              <div>
//                <div class="flex items-center gap-2 mb-2">
//                  <h3 class="text-[15px] font-semibold text-gray-800">${name}</h3>
//                </div>
//                <p class="muted mb-3">ë ˆë²¨ ë²”ìœ„ (ìµœëŒ€ ${maxLabel})</p>
//
//                <!-- âœ… í˜„ì¬/ëª©í‘œ ì„¸ë¡œ ë°°ì¹˜ -->
//                <div class="grid grid-cols-1 gap-2">
//                  <div class="flex items-center justify-between gap-2">
//                    <span class="text-gray-600">í˜„ì¬</span>
//                    <select id="start-${name}" class="border rounded-lg px-2 py-1 text-sm min-w-[120px]">
//                      ${options}
//                    </select>
//                  </div>
//                  <div class="flex items-center justify-between gap-2">
//                    <span class="text-gray-600">ëª©í‘œ</span>
//                    <select id="end-${name}" class="border rounded-lg px-2 py-1 text-sm min-w-[120px]">
//                      ${options}
//                    </select>
//                  </div>
//                </div>
//              </div>
//
//              <div class="md:pl-4">
//                <div class="font-semibold text-gray-800 mb-2">í•„ìš” í•©ê³„</div>
//                <div class="grid grid-cols-[1fr_auto] gap-x-3 text-[13px]">
//                  <div class="text-gray-600">ë¶ˆìˆ˜ì •</div><div class="text-right tabular-nums" id="sub-ë¶ˆìˆ˜ì •-${name}">0</div>
//                  <div class="text-gray-600">ì •ì œ</div><div class="text-right tabular-nums" id="sub-ì •ì œ-${name}">0</div>
//                  <div class="text-gray-600">ê³ ê¸°</div><div class="text-right tabular-nums" id="sub-ê³ ê¸°-${name}">0</div>
//                  <div class="text-gray-600">ë‚˜ë¬´</div><div class="text-right tabular-nums" id="sub-ë‚˜ë¬´-${name}">0</div>
//                  <div class="text-gray-600">ì„íƒ„</div><div class="text-right tabular-nums" id="sub-ì„íƒ„-${name}">0</div>
//                  <div class="text-gray-600">ì² ê´‘</div><div class="text-right tabular-nums" id="sub-ì² ê´‘-${name}">0</div>
//                  <div class="text-gray-600">ê±´ì„¤ì‹œê°„</div><div class="text-right tabular-nums" id="sub-ì‹œê°„-${name}">0</div>
//                </div>
//              </div>
//            </div>
//          </div>
//        `;
//        container.appendChild(card);
//
//        // ì´ë²¤íŠ¸
//        const startSel = card.querySelector(`#start-${name}`);
//        const endSel   = card.querySelector(`#end-${name}`);
//				
//			  /*
//        startSel.addEventListener("change", ()=>{
//          endSel.value = startSel.value; // ê¸°ë³¸: ë™ì¼ë ˆë²¨ë¡œ ë§ì¶¤
//          scheduleCalc();
//        });
//        endSel.addEventListener("change", scheduleCalc);
//
//        buildingCards.push({name, maxIndex});
//				*/
//				// âœ… ì´ì „ ì„ íƒê°’ ë³µì› (ê°€ëŠ¥í•˜ë©´), ì•„ë‹ˆë©´ ê¸°ë³¸ê°’
//				const saved = prev[name];
//				if (saved) {
//					if ([...startSel.options].some(o => o.value === saved.start)) startSel.value = saved.start;
//					if ([...endSel.options].some(o => o.value === saved.end))     endSel.value   = saved.end;
//				} else {
//					// ê¸°ë³¸: ë™ì¼ ë ˆë²¨ë¡œ ë§ì¶¤
//					endSel.value = startSel.value;
//				}
//
//				startSel.addEventListener("change", ()=>{
//					endSel.value = startSel.value; // ê¸°ë³¸: ë™ì¼ë ˆë²¨ë¡œ ë§ì¶¤
//					scheduleCalc();
//				});
//				endSel.addEventListener("change", scheduleCalc);
//
//				const maxIndex = buildingData[name].length - 1; // ì›ë³¸ ê¸°ì¤€
//				buildingCards.push({name, maxIndex});
//      });
//    }
//
//    function getFactorForTime(){
//      const buildSpeed = parseFloat(document.getElementById("buildSpeed").value || 0);
//      let factor = (buildSpeed * 0.01) + 1;
//      if (document.getElementById("chkVP").checked) factor += 0.10;
//      if (document.getElementById("chkSPVP").checked) factor += 0.15;
//      if (document.getElementById("chkServerBuff").checked) factor += 0.10;
//      if (document.getElementById("chkPetBuff").checked){
//        const petBuff = parseFloat(document.getElementById("buffSelect").value || "0");
//        if (!isNaN(petBuff)) factor += (petBuff/100);
//      }
//      return factor;
//    }
//
//    function calculateAll(){
//      // í•©ê³„
//      const total = { "ë¶ˆìˆ˜ì •":0, "ì •ì œ":0, "ê³ ê¸°":0, "ë‚˜ë¬´":0, "ì„íƒ„":0, "ì² ê´‘":0 };
//      let totalHours = 0;
//
//      // ì¹´ë“œë³„ í•„ìš” í•©ê³„ ì´ˆê¸°í™”
//      buildingCards.forEach(({name})=>{
//        ["ë¶ˆìˆ˜ì •","ì •ì œ","ê³ ê¸°","ë‚˜ë¬´","ì„íƒ„","ì² ê´‘"].forEach(res=>{
//          const el = document.getElementById(`sub-${res}-${name}`);
//          if (el) el.textContent = "0";
//        });
//        const tEl = document.getElementById(`sub-ì‹œê°„-${name}`);
//        if (tEl) tEl.textContent = "0";
//      });
//
//      const factor = getFactorForTime();
//      const cityBuff = document.getElementById("chkCityBuff").checked;
//
//      buildingCards.forEach(({name})=>{
//        const start = parseInt(document.getElementById(`start-${name}`).value);
//        const end   = parseInt(document.getElementById(`end-${name}`).value);
//
//        // êµ¬ê°„ ë°ì´í„°
//        const data = buildingData[name].slice(start+1, end+1);
//        const sub = { "ë¶ˆìˆ˜ì •":0, "ì •ì œ":0, "ê³ ê¸°":0, "ë‚˜ë¬´":0, "ì„íƒ„":0, "ì² ê´‘":0 };
//        let hours = 0; // ë³€í™˜ì‹œê°„(ì‹œê°„)
//
//        data.forEach(row=>{
//          resources.forEach(res=>{
//            const v = parseFloat(row[res] || 0);
//            if (res === "ë³€í™˜ì‹œê°„") hours += (isNaN(v)?0:v);
//            else sub[res] += (isNaN(v)?0:v);
//          });
//        });
//
//        // ì¹´ë“œ ìš°ì¸¡ â€˜í•„ìš” í•©ê³„â€™ ê°±ì‹  (ì²´í¬ì™€ ë¬´ê´€ / í•­ìƒ í‘œì‹œ)
//        document.getElementById(`sub-ë¶ˆìˆ˜ì •-${name}`).textContent = sub["ë¶ˆìˆ˜ì •"].toLocaleString();
//        document.getElementById(`sub-ì •ì œ-${name}`).textContent   = sub["ì •ì œ"].toLocaleString();
//        document.getElementById(`sub-ê³ ê¸°-${name}`).textContent    = formatValue(sub["ê³ ê¸°"]);
//        document.getElementById(`sub-ë‚˜ë¬´-${name}`).textContent    = formatValue(sub["ë‚˜ë¬´"]);
//        document.getElementById(`sub-ì„íƒ„-${name}`).textContent    = formatValue(sub["ì„íƒ„"]);
//        document.getElementById(`sub-ì² ê´‘-${name}`).textContent    = formatValue(sub["ì² ê´‘"]);
//
//        let adjHours = hours / factor;
//        if (cityBuff) adjHours *= 0.8;
//        document.getElementById(`sub-ì‹œê°„-${name}`).textContent = formatHourToTime(adjHours);
//
//        // ì²´í¬ëœ ì¹´ë“œë§Œ ì´í•© í¬í•¨
//        if (start < end){
//          Object.keys(total).forEach(k=> total[k] += sub[k]);
//          totalHours += adjHours;
//        }
//      });
//
//      // ë³´ìœ (ë¶ˆìˆ˜ì •/ì •ì œ)
//      const owned = {
//        "ë¶ˆìˆ˜ì •": parseFloat(document.getElementById("owned-ë¶ˆìˆ˜ì •").value || 0),
//        "ì •ì œ": parseFloat(document.getElementById("owned-ì •ì œ").value || 0),
//      };
//
//      // í•˜ë‹¨ ìš”ì•½(ì´í•©/ë³´ìœ /ê³¼ë¶€ì¡±) - ëª¨ë“  ìì› + ì‹œê°„
//      const deficit = {
//        "ë¶ˆìˆ˜ì •": owned["ë¶ˆìˆ˜ì •"] - total["ë¶ˆìˆ˜ì •"],
//        "ì •ì œ": owned["ì •ì œ"] - total["ì •ì œ"],
//        // ë‚˜ë¨¸ì§€ ìì›ì€ ë³´ìœ ì¹˜ê°€ ì—†ìœ¼ë¯€ë¡œ ê³¼ë¶€ì¡± ë¯¸í‘œì‹œ(ì› ìš”ì²­ëŒ€ë¡œ ì´í•©/ë³´ìœ /ê³¼ë¶€ì¡±ì€ ë¶ˆìˆ˜ì •/ì •ì œ ì¤‘ì‹¬)
//      };
//
//      /*
//      const summaryBody = `
//        <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
//          <!-- ì´í•© -->
//          <div class="rounded-xl border border-black/10 p-3">
//            <div class="font-semibold mb-2">ì´í•©</div>
//            <div class="flex justify-between text-[13px]"><span class="text-gray-600">ë¶ˆìˆ˜ì •</span><span>${total["ë¶ˆìˆ˜ì •"].toLocaleString()}</span></div>
//            <div class="flex justify-between text-[13px]"><span class="text-gray-600">ì •ì œ</span><span>${total["ì •ì œ"].toLocaleString()}</span></div>
//            <div class="flex justify-between text-[13px]"><span class="text-gray-600">ê³ ê¸°</span><span>${formatValue(total["ê³ ê¸°"])}</span></div>
//            <div class="flex justify-between text-[13px]"><span class="text-gray-600">ë‚˜ë¬´</span><span>${formatValue(total["ë‚˜ë¬´"])}</span></div>
//            <div class="flex justify-between text-[13px]"><span class="text-gray-600">ì„íƒ„</span><span>${formatValue(total["ì„íƒ„"])}</span></div>
//            <div class="flex justify-between text-[13px]"><span class="text-gray-600">ì² ê´‘</span><span>${formatValue(total["ì² ê´‘"])}</span></div>
//            <div class="flex justify-between text-[13px]"><span class="text-gray-600">ê±´ì„¤ì‹œê°„</span><span>${formatHourToTime(totalHours)}</span></div>
//          </div>
//
//          <!-- ë³´ìœ ëŸ‰ -->
//          <div class="rounded-xl border border-black/10 p-3">
//            <div class="flex items-center justify-between mb-2">
//              <h3 class="text-[15px] font-semibold text-gray-800">ë³´ìœ  ìì›</h3>
//              <span class="muted">ì…ë ¥ ì‹œ ìë™ ê³„ì‚°</span>
//            </div>
//            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
//              <div>
//                <label for="owned-ë¶ˆìˆ˜ì •" class="block text-[15px] text-gray-600 mb-1">ë³´ìœ  ë¶ˆìˆ˜ì •</label>
//                <input type="number" id="owned-ë¶ˆìˆ˜ì •" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="0" min="0" inputmode="numeric" />
//              </div>
//              <div>
//                <label for="owned-ì •ì œ" class="block text-[15px] text-gray-600 mb-1">ë³´ìœ  ì •ì œ</label>
//                <input type="number" id="owned-ì •ì œ" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="0" min="0" inputmode="numeric" />
//              </div>
//            </div>
//          </div>
//
//          <!-- ê³¼ë¶€ì¡± -->
//          <div class="rounded-xl border border-black/10 p-3">
//            <div class="font-semibold mb-2">ê³¼ë¶€ì¡±</div>
//            <div class="flex justify-between text-[13px]"><span class="text-gray-600">ë¶ˆìˆ˜ì •</span><span class="${deficit["ë¶ˆìˆ˜ì •"]<0?'text-red-600':''}">${deficit["ë¶ˆìˆ˜ì •"].toLocaleString()}</span></div>
//            <div class="flex justify-between text-[13px]"><span class="text-gray-600">ì •ì œ</span><span class="${deficit["ì •ì œ"]<0?'text-red-600':''}">${deficit["ì •ì œ"].toLocaleString()}</span></div>
//          </div>
//        </div>
//      `;
//      document.getElementById("summaryBody").innerHTML = summaryBody;
//      */
//      document.getElementById("sum-ë¶ˆìˆ˜ì •").textContent = total["ë¶ˆìˆ˜ì •"].toLocaleString();
//      document.getElementById("sum-ì •ì œ").textContent   = total["ì •ì œ"].toLocaleString();
//      document.getElementById("sum-ê³ ê¸°").textContent    = formatValue(total["ê³ ê¸°"]);
//      document.getElementById("sum-ë‚˜ë¬´").textContent    = formatValue(total["ë‚˜ë¬´"]);
//      document.getElementById("sum-ì„íƒ„").textContent    = formatValue(total["ì„íƒ„"]);
//      document.getElementById("sum-ì² ê´‘").textContent    = formatValue(total["ì² ê´‘"]);
//      document.getElementById("sum-ì‹œê°„").textContent    = formatHourToTime(totalHours);
//      
//      const defA = document.getElementById("def-ë¶ˆìˆ˜ì •");
//      const defB = document.getElementById("def-ì •ì œ");
//      defA.textContent = ( (parseFloat(document.getElementById("owned-ë¶ˆìˆ˜ì •").value||0) - total["ë¶ˆìˆ˜ì •"]) ).toLocaleString();
//      defB.textContent = ( (parseFloat(document.getElementById("owned-ì •ì œ").value||0) - total["ì •ì œ"]) ).toLocaleString();
//      defA.classList.toggle("text-red-600", parseFloat(defA.textContent.replace(/,/g,'')) < 0);
//      defB.classList.toggle("text-red-600", parseFloat(defB.textContent.replace(/,/g,'')) < 0);
//      
//      sendHeightToParent();
//    }
//
//    // ìë™ ê³„ì‚°(ë””ë°”ìš´ìŠ¤)
//    let calcTimer=null;
//    function scheduleCalc(){
//      if (calcTimer) clearTimeout(calcTimer);
//      calcTimer = setTimeout(calculateAll, 120);
//    }
//
//    // ìƒë‹¨ í† ê¸€/ì…ë ¥ ì´ë²¤íŠ¸
//    document.addEventListener("change",(e)=>{
//      const id = e.target.id;
//      if (id==="chkVP") handleVPCheck("chkVP");
//      else if (id==="chkSPVP") handleVPCheck("chkSPVP");
//      else if (id==="chkServerBuff" || id==="chkCityBuff" || id==="buffSelect") scheduleCalc();
//      else if (id==="buildSpeed" || id==="owned-ë¶ˆìˆ˜ì •" || id==="owned-ì •ì œ") scheduleCalc();
//      else if (id==="chkPetBuff") togglePetBuffSelect();
//    });
//    ["buildSpeed","owned-ë¶ˆìˆ˜ì •","owned-ì •ì œ"].forEach(id=>{
//      const el=document.getElementById(id);
//      if (el) el.addEventListener("input", scheduleCalc);
//    });
//
//    // ë°ì´í„° ë¡œë“œ & ì´ˆê¸° ë Œë”
//    fetchBuildingData();
  </script>
  <script>
    // âœ… í™œì„±/ë¹„í™œì„± ìŠ¤íƒ€ì¼ í´ë˜ìŠ¤(ê¸°ë³¸ í…Œë§ˆ ìœ ì§€)
    const ACTIVE = ['bg-blue-500','text-white','border-blue-500'];
    const INACTIVE = ['bg-white','text-gray-800','border-gray-300'];

    function setActive(el, on) {
      el.setAttribute('aria-pressed', on ? 'true' : 'false');
      el.classList.remove(...(on ? INACTIVE : ACTIVE));
      el.classList.add(...(on ? ACTIVE : INACTIVE));
    }

    // ì´ˆê¸° ìƒíƒœ ì •ë¦¬ (ëª¨ë“  í† ê¸€/ë²„íŠ¼ì— ë¹„í™œì„± ìŠ¤íƒ€ì¼ ë¶€ì—¬)
    document.querySelectorAll('.vp-btn, .toggle-btn').forEach(b => setActive(b, false));

    // âœ… ë¶€ì§‘í–‰ê´€(VP): ë¼ë””ì˜¤ì²˜ëŸ¼ ë™ì‘ + ê°™ì€ ë²„íŠ¼ ì¬í´ë¦­ ì‹œ í•´ì œ
    document.querySelectorAll('.vp-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const group = btn.dataset.group || 'vp';
        const groupBtns = document.querySelectorAll(`.vp-btn[data-group="${group}"]`);
        const wasActive = btn.getAttribute('aria-pressed') === 'true';

        if (wasActive) {
          // ê°™ì€ ë²„íŠ¼ ë‹¤ì‹œ í´ë¦­ â†’ í•´ì œ
          setActive(btn, false);
        } else {
          // ë‹¤ë¥¸ ë²„íŠ¼ ì„ íƒ â†’ ë‚˜ë¨¸ì§€ í•´ì œ, ì´ ë²„íŠ¼ë§Œ í™œì„±
          groupBtns.forEach(b => setActive(b, false));
          setActive(btn, true);
        }
        // í•„ìš”í•˜ë©´ ê°’ ì‚¬ìš©: const vp = wasActive ? 0 : Number(btn.dataset.vp);
      });
    });

    // âœ… ì‹œì²­/ì„œë²„ ë²„í”„: ë‹¨ìˆœ í† ê¸€
    document.querySelectorAll('.toggle-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const nowOn = btn.getAttribute('aria-pressed') !== 'true';
        setActive(btn, nowOn);
        // nowOn === true ë©´ í™œì„±í™”, false ë©´ ë¹„í™œì„±í™”
      });
    });

    // (ì˜µì…˜) í˜„ì¬ ì„ íƒê°’ ì–»ê¸° ì˜ˆì‹œ
    window.getBuffState = () => {
      const activeVp = document.querySelector('.vp-btn[aria-pressed="true"]');
      const vp = activeVp ? Number(activeVp.dataset.vp) : 0;
      const city = document.getElementById('chkCityBuff').getAttribute('aria-pressed') === 'true';
      const server = document.getElementById('chkServerBuff').getAttribute('aria-pressed') === 'true';
      return { vp, city, server };
    };
  </script>
  <script>
    /* ìœ í‹¸ */
    function sendHeightToParent(){ const h=document.body.scrollHeight+10; window.parent?.postMessage({type:"FRAME_CHANGE",height:h},"*"); }
    window.addEventListener("load", ()=> setTimeout(sendHeightToParent,100));

    const buildingList = ["ìš©ê´‘ë¡œ","ëŒ€ì‚¬ê´€","ì§€íœ˜ë¶€","ì˜ë¬´ì‹¤","ë°©íŒ¨ë³‘","ì°½ë³‘","ê¶ë³‘","ì•„ì¹´ë°ë¯¸"];
    const resources = ["ë¶ˆìˆ˜ì •","ì •ì œ","ê³ ê¸°","ë‚˜ë¬´","ì„íƒ„","ì² ê´‘","ë³€í™˜ì‹œê°„"];
    const buildingData = {};
    let buildingCards = []; // {name, maxIndex}

    const nf1 = new Intl.NumberFormat('ko-KR', { minimumFractionDigits: 0, maximumFractionDigits: 1 });

    // âœ… SVS ì ìˆ˜ ì „ìš© í¬ë§· (M/B, ì†Œìˆ˜ 2ìë¦¬)
    function formatSVS(value){
      const num = Number(value);
      if (!Number.isFinite(num)) return "0";
      if (num >= 1000000000) return (num / 1000000000).toFixed(2).replace(/\.00$/, '') + "B";
      if (num >= 1000000) return (num / 1000000).toFixed(2).replace(/\.00$/, '') + "M";
      return num.toLocaleString();
    }
    
    function formatValue(value){
      const num = Number(String(value ?? 0).replace(/,/g, ''));
      if (isNaN(num)) return value;
      const r1 = Math.round((num + Number.EPSILON) * 10) / 10;
      if (r1 >= 1000) return nf1.format(r1 / 1000) + "B";
      return nf1.format(r1) + "M";
    }

    function formatHourToTime(hours){
      if (!hours || isNaN(hours)) return "0ë¶„";
      const totalMinutes = Math.round(hours*60);
      const d = Math.floor(totalMinutes/1440);
      const h = Math.floor((totalMinutes%1440)/60);
      const m = totalMinutes%60;
      return `${d?d+'ì¼ ':''}${h?h+'ì‹œê°„ ':''}${(m||(!d&&!h))?m+'ë¶„':''}`.trim();
    }

    function handleVPCheck(which){
      const v=document.getElementById("chkVP");
      const s=document.getElementById("chkSPVP");
      if(which==="chkVP" && v?.checked) s.checked=false;
      if(which==="chkSPVP" && s?.checked) v.checked=false;
      scheduleCalc();
    }

    // ======== ğŸ”· ì¶”ê°€: ë²„íŠ¼ í† ê¸€/í«ë²„í”„ íŒë… ìœ í‹¸ ========
    function isPressed(id){
      const el = document.getElementById(id);
      if (!el) return false;
      const pressed = el.getAttribute?.('aria-pressed');
      if (pressed === 'true') return true;
      if (pressed === 'false') return false;
      // í´ë°±: ì²´í¬ë°•ìŠ¤ í˜•íƒœì¼ ë•Œ
      return !!el.checked;
    }

    function getActiveVP(){
      const active = document.querySelector('.vp-btn[aria-pressed="true"]');
      return active ? Number(active.dataset.vp || 0) : 0; // 0 | 10 | 15
    }

    function getPetPercent(){
      const sel = document.getElementById('buffSelect');
      if (!sel) return 0;
      const v = (sel.value || '').trim();
      if (!v || /^none$/i.test(v)) return 0;
      const n1 = Number(v);
      if (!Number.isNaN(n1) && Number.isFinite(n1)) return n1;
      const m = v.match(/[-+]?\d+(\.\d+)?/);
      return m ? Number(m[0]) : 0;
    }

    // âœ… Expert(ì•„ê·¸ë„¤ìŠ¤) ê³ ì • ì°¨ê° ì‹œê°„(ì‹œê°„/ë‹¨ê³„) ë°˜í™˜
    function getExpertFlatHours(){
      const sel = document.getElementById('chkExpertA');
      if (!sel) return 0;
      const raw = (sel.value || sel.options[sel.selectedIndex]?.text || '').trim().toLowerCase();
      const asNum = Number(raw);
      const lv = (!Number.isNaN(asNum) && Number.isFinite(asNum)) ? asNum
               : (raw.includes('lv.5')||raw.includes('lv5')) ? 5
               : (raw.includes('lv.4')||raw.includes('lv4')) ? 4
               : (raw.includes('lv.3')||raw.includes('lv3')) ? 3
               : (raw.includes('lv.2')||raw.includes('lv2')) ? 2
               : (raw.includes('lv.1')||raw.includes('lv1')) ? 1 : 0;
      return lv === 1 ? 2 : lv === 2 ? 3 : lv === 3 ? 4 : lv === 4 ? 6 : lv === 5 ? 8 : 0;
    }
    // âœ… ë°œë ˆë¦¬ì•„(SVS ì ìˆ˜ ë³´ë„ˆìŠ¤)
    const EXPERT_BONUS = {
      "None":0,
      "Lv.1":0.02,"Lv.2":0.04,"Lv.3":0.06,"Lv.4":0.08,"Lv.5":0.10,
      "Lv.6":0.12,"Lv.7":0.14,"Lv.8":0.16,"Lv.9":0.18,"Lv.10":0.20
    };
    const EXPERT_DESC = {
      "Lv.1":  "+2%",
      "Lv.2":  "+4%",
      "Lv.3":  "+6%",
      "Lv.4":  "+8%",
      "Lv.5":  "+10%",
      "Lv.6":  "+12%",
      "Lv.7":  "+14%",
      "Lv.8":  "+16%",
      "Lv.9":  "+18%",
      "Lv.10": "+20%"
    };

    function getValeriaBonus(){
      const sel = document.getElementById("chkExpertV");
      if (!sel) return 0;
      const key = (sel.value || sel.options[sel.selectedIndex]?.text || "None").trim();
      return EXPERT_BONUS[key] ?? 0;
    }

    function getValeriaDesc(){
      const expertSel = document.getElementById("chkExpertV");
      const lv = expertSel.value;
      const text = EXPERT_DESC[lv]
        ? "SvS ì ìˆ˜ " + EXPERT_DESC[lv]
        : "SvS ì ìˆ˜";

      document.querySelectorAll(".svs-score-label").forEach(el => {
        el.textContent = text;
      });
    }
    // ===============================================

    async function fetchBuildingData(){
      for (const name of buildingList){
        const url = `https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/building/${name}.csv`;
        const res = await fetch(url);
        const text = await res.text();
        const lines = text.trim().split("\n");
        const headers = lines[0].split(",");
        const data = lines.slice(1).map(line=>{
          const obj = {};
          const values = line.split(",");
          headers.forEach((h,i)=> obj[h.trim()] = (values[i]?.trim() || "0"));
          return obj;
        });
        buildingData[name]=data;
      }
      renderBuildingSelectors();
      scheduleCalc();
    }

    function renderBuildingSelectors(){
      const container = document.getElementById("buildingGridBody");

      // âœ… ê¸°ì¡´ ì„ íƒê°’ ë³´ì¡´
      const prev = {};
      if (container && container.children.length) {
        [...container.querySelectorAll('.exp-card')].forEach(card => {
          const nameEl = card.querySelector('h3');
          if (!nameEl) return;
          const bname = nameEl.textContent.trim();
          const startSel = card.querySelector(`#start-${bname}`);
          const endSel   = card.querySelector(`#end-${bname}`);
          if (startSel && endSel) {
            prev[bname] = { start: startSel.value, end: endSel.value };
          }
        });
      }

      container.innerHTML = "";
      buildingCards = [];

      buildingList.forEach(name=>{
        const levelsFull = buildingData[name].map(d=> d["ë ˆë²¨"]); // ì›ë³¸ ëª¨ë“  ë¼ë²¨
        const filtered = filterLevelsWithIndex(levelsFull, useFireCrystal); // [{idx,label}] (ì™¸ë¶€ ì •ì˜ ê°€ì •)

        // âœ… ì˜µì…˜ì€ "í™”ë©´ ë¼ë²¨ì€ filtered.label" / "valueëŠ” ì›ë³¸ idx"
        const options = filtered
          .map(({idx, label}) => `<option value="${idx}">${label}</option>`)
          .join("");

        const maxLabel = filtered.length ? filtered[filtered.length-1].label : (levelsFull[levelsFull.length-1] || '');
        const card = document.createElement("div");
        card.className = "exp-card";
        card.innerHTML = `
          <div class="p-4 space-y-3">

            <!-- ìƒë‹¨: ê±´ë¬¼ì´ë¦„ + ìµœëŒ€ë ˆë²¨ + í˜„ì¬/ëª©í‘œ -->
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3">
              <!-- ì™¼ìª½: ì´ë¦„/ìµœëŒ€ë ˆë²¨ -->
              <div>
                <h3 class="text-[15px] font-semibold text-gray-800">${name}</h3>
                <p class="muted mb-3">ìµœëŒ€ ë ˆë²¨: ${maxLabel}</p>
              </div>

              <!-- ì˜¤ë¥¸ìª½: í˜„ì¬/ëª©í‘œ ë“œë¡­ë‹¤ìš´ -->
              <div class="flex flex-wrap items-center gap-2">
                <label class="text-sm text-gray-600">í˜„ì¬</label>
                <select id="start-${name}"
                        class="border rounded-lg px-2 py-1 text-sm min-w-[120px]">
                  ${options}
                </select>

                <label class="text-sm text-gray-600">ëª©í‘œ</label>
                <select id="end-${name}"
                        class="border rounded-lg px-2 py-1 text-sm min-w-[120px]">
                  ${options}
                </select>
              </div>
            </div>

            <!-- í•„ìš”ìì› í‘œ -->
            <div class="rounded-md border p-3 text-[13px] space-y-1">
              <!-- 1í–‰: ë¶ˆìˆ˜ì • / ê³ ê¸°, ë‚˜ë¬´ -->
              <div class="grid grid-cols-6 gap-x-3 items-center">
                <div class="flex items-center gap-1 text-gray-600">
                  <img src="images/icon_fc.webp" class="w-5 h-5" alt="ë¶ˆìˆ˜ì •">
                </div>
                <div id="sub-ë¶ˆìˆ˜ì •-${name}" class="tabular-nums">0</div>
                
                <div class="flex items-center gap-1 text-gray-600">
                  <img src="images/icon_Meet.webp" class="w-5 h-5" alt="ê³ ê¸°">
                </div>
                <div id="sub-ê³ ê¸°-${name}" class="tabular-nums">0</div>

                <div class="flex items-center gap-1 text-gray-600">
                  <img src="images/icon_Wood.webp" class="w-5 h-5" alt="ë‚˜ë¬´">
                </div>  
                <div id="sub-ë‚˜ë¬´-${name}" class="tabular-nums">0</div>
              </div>

              <!-- 2í–‰: ì •ì œ / ì„íƒ„ / ì² ê´‘ -->
              <div class="grid grid-cols-6 gap-x-3 items-center">                
                <div class="flex items-center gap-1 text-gray-600">
                  <img src="images/icon_RefindFC.webp" class="w-5 h-5" alt="ì •ì œë¶ˆìˆ˜">
                </div>
                <div id="sub-ì •ì œ-${name}" class="tabular-nums">0</div>
                
                <div class="flex items-center gap-1 text-gray-600">
                  <img src="images/icon_Coal.webp" class="w-5 h-5" alt="ì„íƒ„">
                </div>
                <div id="sub-ì„íƒ„-${name}" class="tabular-nums">0</div>

                <div class="flex items-center gap-1 text-gray-600">
                  <img src="images/icon_Iron.webp" class="w-5 h-5" alt="ì² ê´‘">
                </div>
                <div id="sub-ì² ê´‘-${name}" class="tabular-nums">0</div>
              </div>

              <!-- 3í–‰: ê±´ì„¤ì‹œê°„ -->
              <div class="grid grid-cols-4 gap-x-3 items-center pt-1 border-t border-gray-200 mt-1">
                <div class="text-gray-600">ê±´ì„¤ì‹œê°„</div>
                <div id="sub-ì‹œê°„-${name}" class="tabular-nums font-medium">0</div>
                <div class="svs-score-label text-gray-600">SVS ì ìˆ˜</div>
                <div id="sub-ì ìˆ˜-${name}" class="svs-score-value tabular-nums font-medium">0</div>
              </div>
            </div>
          </div>
        `;
        container.appendChild(card);

        //const card = document.createElement("div");
        //card.className = "exp-card";
        //card.innerHTML = `
        //  <div class="p-4">
        //    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        //      <div>
        //<div class="flex items-center gap-2 mb-2">
        //  <h3 class="text-[15px] font-semibold text-gray-800">${name}</h3>
        //</div>
        //<p class="muted mb-3">ë ˆë²¨ ë²”ìœ„ (ìµœëŒ€ ${maxLabel})</p>
        //
        //<!-- âœ… í˜„ì¬/ëª©í‘œ ì„¸ë¡œ ë°°ì¹˜ -->
        //<div class="grid grid-cols-1 gap-2">
        //  <div class="flex items-center justify-between gap-2">
        //    <span class="text-gray-600">í˜„ì¬</span>
        //    <select id="start-${name}" class="border rounded-lg px-2 py-1 text-sm min-w-[120px]">
        //      ${options}
        //    </select>
        //  </div>
        //  <div class="flex items-center justify-between gap-2">
        //    <span class="text-gray-600">ëª©í‘œ</span>
        //    <select id="end-${name}" class="border rounded-lg px-2 py-1 text-sm min-w-[120px]">
        //      ${options}
        //    </select>
        //  </div>
        //</div>
        //      </div>
        //
        //      <div class="md:pl-4">
        //<div class="font-semibold text-gray-800 mb-2">í•„ìš” í•©ê³„</div>
        //<div class="grid grid-cols-[1fr_auto] gap-x-3 text-[13px]">
        //  <div class="text-gray-600">ë¶ˆìˆ˜ì •</div><div class="text-right tabular-nums" id="sub-ë¶ˆìˆ˜ì •-${name}">0</div>
        //  <div class="text-gray-600">ì •ì œ</div><div class="text-right tabular-nums" id="sub-ì •ì œ-${name}">0</div>
        //  <div class="text-gray-600">ê³ ê¸°</div><div class="text-right tabular-nums" id="sub-ê³ ê¸°-${name}">0</div>
        //  <div class="text-gray-600">ë‚˜ë¬´</div><div class="text-right tabular-nums" id="sub-ë‚˜ë¬´-${name}">0</div>
        //  <div class="text-gray-600">ì„íƒ„</div><div class="text-right tabular-nums" id="sub-ì„íƒ„-${name}">0</div>
        //  <div class="text-gray-600">ì² ê´‘</div><div class="text-right tabular-nums" id="sub-ì² ê´‘-${name}">0</div>
        //  <div class="text-gray-600">ê±´ì„¤ì‹œê°„</div><div class="text-right tabular-nums" id="sub-ì‹œê°„-${name}">0</div>
        //</div>
        //      </div>
        //    </div>
        //  </div>
        //`;
        //container.appendChild(card);

        // ì´ë²¤íŠ¸
        const startSel = card.querySelector(`#start-${name}`);
        const endSel   = card.querySelector(`#end-${name}`);

        // âœ… ì´ì „ ì„ íƒê°’ ë³µì› (ê°€ëŠ¥í•˜ë©´), ì•„ë‹ˆë©´ ê¸°ë³¸ê°’
        const saved = prev[name];
        if (saved) {
          if ([...startSel.options].some(o => o.value === saved.start)) startSel.value = saved.start;
          if ([...endSel.options].some(o => o.value === saved.end))     endSel.value   = saved.end;
        } else {
          endSel.value = startSel.value;
        }

        startSel.addEventListener("change", ()=>{
          endSel.value = startSel.value; // ê¸°ë³¸: ë™ì¼ë ˆë²¨ë¡œ ë§ì¶¤
          scheduleCalc();
        });
        endSel.addEventListener("change", scheduleCalc);

        const maxIndex = buildingData[name].length - 1; // ì›ë³¸ ê¸°ì¤€
        buildingCards.push({name, maxIndex});
      });
    }

    // ======== ğŸ”· ë³€ê²½: ë²„í”„ ê³„ìˆ˜ ê³„ì‚° ========
    function getFactorForTime(){
      const buildSpeed = parseFloat(document.getElementById("buildSpeed").value || 0);
      let factor = 1 + (isNaN(buildSpeed) ? 0 : buildSpeed/100);

      // ë¶€ì§‘í–‰ê´€ ë²„íŠ¼(10/15/ì—†ìŒ)
      const vp = getActiveVP();      // 0 | 10 | 15
      factor += vp/100;

      // ì„œë²„ë²„í”„ ë²„íŠ¼ (í™œì„± ì‹œ +10%)
      if (isPressed('chkServerBuff')) factor += 0.10;

      // í«ë²„í”„ (ì²´í¬ë°•ìŠ¤ ë¬´ì‹œ, None ì•„ë‹ˆë©´ % ë°˜ì˜)
      const petPct = getPetPercent();
      if (petPct) factor += petPct/100;

      return factor;
    }
    // ======================================

    function calculateAll(){
      // í•©ê³„
      const total = { "ë¶ˆìˆ˜ì •":0, "ì •ì œ":0, "ê³ ê¸°":0, "ë‚˜ë¬´":0, "ì„íƒ„":0, "ì² ê´‘":0 };
      let totalHours = 0;

      // ì¹´ë“œë³„ í•„ìš” í•©ê³„ ì´ˆê¸°í™”
      buildingCards.forEach(({name})=>{
        ["ë¶ˆìˆ˜ì •","ì •ì œ","ê³ ê¸°","ë‚˜ë¬´","ì„íƒ„","ì² ê´‘"].forEach(res=>{
          const el = document.getElementById(`sub-${res}-${name}`);
          if (el) el.textContent = "0";
        });
        
        const tEl = document.getElementById(`sub-ì‹œê°„-${name}`);
        if (tEl) tEl.textContent = "0";
        
        const sEl = document.getElementById(`sub-ì ìˆ˜-${name}`);
        if (sEl) sEl.textContent = "0";
        
        const sAEl = document.getElementById(`sub-ì ìˆ˜A-${name}`); 
        if (sAEl) sAEl.textContent = "0";
      });

      const factor = getFactorForTime();
      // âœ… ì‹œì²­ë²„í”„ëŠ” í† ê¸€ ë²„íŠ¼ ìƒíƒœ ì‚¬ìš© (í´ë°±: ì²´í¬ë°•ìŠ¤)
      const cityBuff = isPressed('chkCityBuff');

      buildingCards.forEach(({name})=>{
        const start = parseInt(document.getElementById(`start-${name}`).value);
        const end   = parseInt(document.getElementById(`end-${name}`).value);

        // êµ¬ê°„ ë°ì´í„°
        const data = buildingData[name].slice(start+1, end+1);
        const sub = { "ë¶ˆìˆ˜ì •":0, "ì •ì œ":0, "ê³ ê¸°":0, "ë‚˜ë¬´":0, "ì„íƒ„":0, "ì² ê´‘":0 };
        let hours = 0; // ë³€í™˜ì‹œê°„(ì‹œê°„)

        data.forEach(row=>{
          resources.forEach(res=>{
            const v = parseFloat(row[res] || 0);
            if (res === "ë³€í™˜ì‹œê°„") hours += (isNaN(v)?0:v);
            else sub[res] += (isNaN(v)?0:v);
          });
        });

        // ì¹´ë“œ ìš°ì¸¡ â€˜í•„ìš” í•©ê³„â€™ ê°±ì‹ 
        document.getElementById(`sub-ë¶ˆìˆ˜ì •-${name}`).textContent = sub["ë¶ˆìˆ˜ì •"].toLocaleString();
        document.getElementById(`sub-ì •ì œ-${name}`).textContent = sub["ì •ì œ"].toLocaleString();
        document.getElementById(`sub-ê³ ê¸°-${name}`).textContent = formatValue(sub["ê³ ê¸°"]);
        document.getElementById(`sub-ë‚˜ë¬´-${name}`).textContent = formatValue(sub["ë‚˜ë¬´"]);
        document.getElementById(`sub-ì„íƒ„-${name}`).textContent = formatValue(sub["ì„íƒ„"]);
        document.getElementById(`sub-ì² ê´‘-${name}`).textContent = formatValue(sub["ì² ê´‘"]);

        let adjHours = hours / factor;
        if (cityBuff) adjHours *= 0.8;
        
        // âœ… ExpertBuff: ë‹¨ê³„ìˆ˜ì™€ ë¬´ê´€í•˜ê²Œ í•œ ë²ˆë§Œ ê³ ì • ì°¨ê° (ì˜ˆ: Lv5 â†’ 8ì‹œê°„)
        const expertFlat = getExpertFlatHours();        // 0 | 2 | 3 | 4 | 6 | 8
        adjHours = Math.max(0, adjHours - expertFlat);
        
        document.getElementById(`sub-ì‹œê°„-${name}`).textContent = formatHourToTime(adjHours);
        
        // âœ… SVS ì ìˆ˜ = (ë¶ˆìˆ˜ì •*2000) + (ì •ì œë¶ˆìˆ˜*30000) Ã— (1 + ë°œë ˆë¦¬ì•„ ë³´ë„ˆìŠ¤)
        const FireCrystal = (sub["ë¶ˆìˆ˜ì •"] * 2000);
        const Refind = (sub["ì •ì œ"] * 30000);
        const vBonus = getValeriaBonus(); // 0 ~ 0.20
        
        const fScore = Math.floor(FireCrystal * (1 + vBonus));
        const rScore = Math.floor(Refind * (1 + vBonus));
        const tScore = Math.floor(((adjHours * 60) * 30) * (1 + vBonus));        
        const finalScore = fScore+rScore+tScore;

        const scoreEl = document.getElementById(`sub-ì ìˆ˜-${name}`);
        if (scoreEl) scoreEl.textContent = formatSVS(finalScore);

        // ì²´í¬ëœ ì¹´ë“œë§Œ ì´í•© í¬í•¨ (í˜„ì¬/ëª©í‘œ ë‹¤ë¥´ë©´ í¬í•¨)
        if (start < end){
          Object.keys(total).forEach(k=> total[k] += sub[k]);
          totalHours += adjHours;
        }
      });

      // ë³´ìœ (ë¶ˆìˆ˜ì •/ì •ì œ)
      const owned = {
        "ë¶ˆìˆ˜ì •": parseFloat(document.getElementById("owned-ë¶ˆìˆ˜ì •").value || 0),
        "ì •ì œ": parseFloat(document.getElementById("owned-ì •ì œ").value || 0),
      };

      // í•˜ë‹¨ ìš”ì•½
      document.getElementById("sum-ë¶ˆìˆ˜ì •").textContent = total["ë¶ˆìˆ˜ì •"].toLocaleString();
      document.getElementById("sum-ì •ì œ").textContent = total["ì •ì œ"].toLocaleString();
      document.getElementById("sum-ê³ ê¸°").textContent = formatValue(total["ê³ ê¸°"]);
      document.getElementById("sum-ë‚˜ë¬´").textContent = formatValue(total["ë‚˜ë¬´"]);
      document.getElementById("sum-ì„íƒ„").textContent = formatValue(total["ì„íƒ„"]);
      document.getElementById("sum-ì² ê´‘").textContent = formatValue(total["ì² ê´‘"]);
      document.getElementById("sum-ì‹œê°„").textContent = formatHourToTime(totalHours);

      const defA = document.getElementById("def-ë¶ˆìˆ˜ì •");
      const defB = document.getElementById("def-ì •ì œ");
      defA.textContent = ( owned["ë¶ˆìˆ˜ì •"] - total["ë¶ˆìˆ˜ì •"] ).toLocaleString();
      defB.textContent = ( owned["ì •ì œ"] - total["ì •ì œ"] ).toLocaleString();
      defA.classList.toggle("text-red-600", parseFloat(defA.textContent.replace(/,/g,'')) < 0);
      defB.classList.toggle("text-red-600", parseFloat(defB.textContent.replace(/,/g,'')) < 0);

      sendHeightToParent();
    }

    // ìë™ ê³„ì‚°(ë””ë°”ìš´ìŠ¤)
    let calcTimer=null;
    function scheduleCalc(){
      if (calcTimer) clearTimeout(calcTimer);
      calcTimer = setTimeout(calculateAll, 120);
    }

    // ìƒë‹¨ í† ê¸€/ì…ë ¥ ì´ë²¤íŠ¸
    document.addEventListener("change",(e)=>{
      const id = e.target.id;
      
      switch(id){
        case "chkVP":
        case "chkSPVP":
          handleVPCheck(id);
          break;          
        case "chkServerBuff":
        case "chkCityBuff":
        case "buffSelect":
        case "chkExpertA":
          scheduleCalc();
          break;
        case "chkExpertV":
          getValeriaDesc();
          scheduleCalc();
          break;
        case "buildSpeed":
        case "owned-ë¶ˆìˆ˜ì •":
        case "owned-ì •ì œ":
          scheduleCalc();
          break;
        default:
          break;
      }
      /*
      if (id==="chkVP") handleVPCheck("chkVP");
      else if (id==="chkSPVP") handleVPCheck("chkSPVP");
      else if (id==="chkServerBuff" || id==="chkCityBuff" || id==="buffSelect"|| id==="chkExpertA") scheduleCalc();
      else if (id==="chkExpertV") { getValeriaDesc();  scheduleCalc(); }
      else if (id==="buildSpeed" || id==="owned-ë¶ˆìˆ˜ì •" || id==="owned-ì •ì œ") scheduleCalc();*/
    });
    ["buildSpeed","owned-ë¶ˆìˆ˜ì •","owned-ì •ì œ"].forEach(id=>{
      const el=document.getElementById(id);
      if (el) el.addEventListener("input", scheduleCalc);
    });

    // ğŸ”· ë²„íŠ¼(í† ê¸€/VP) í´ë¦­ ì‹œì—ë„ ì¦‰ì‹œ ê³„ì‚° ë°˜ì˜
    document.querySelectorAll('.toggle-btn, .vp-btn').forEach(b=>{
      b.addEventListener('click', scheduleCalc);
    });

    // ë°ì´í„° ë¡œë“œ & ì´ˆê¸° ë Œë”
    fetchBuildingData();
  </script>
	<script>
		// í† ê¸€ ìƒíƒœ ê¸°ì–µ
		let useFireCrystal = localStorage.getItem('useFireCrystal') === '1';

		// ë ˆë²¨ ë¼ë²¨ í•„í„° â†’ ì›ë³¸ ì¸ë±ìŠ¤/ë¼ë²¨ ìŒ ë°˜í™˜
		function filterLevelsWithIndex(levelLabels, useFire) {
			// CSV ë¼ë²¨ ì •ì œ
			const labels = levelLabels.map(v => String(v ?? '').trim());
			const out = [];

			// í—¬í¼: íŠ¹ì • ë¼ë²¨ì„ "ëŒ€ì†Œë¬¸ì/ê³µë°± ë¬´ì‹œ"ë¡œ ì°¾ê¸°
			const findIdx = (want) =>
				labels.findIndex(lv => lv.replace(/\s+/g, '').toUpperCase() === want.toUpperCase());

			// í—¬í¼: ì›ë³¸ ìˆœì„œë¥¼ ìœ ì§€í•œ ì±„, ì •ê·œì‹ì— ë§ëŠ” ê²ƒë§Œ ì¶”ì¶œ
			const collectBy = (regex) => {
				labels.forEach((lv, i) => {
					const norm = lv.replace(/\s+/g, '').toUpperCase();
					if (regex.test(norm)) out.push({ idx: i, label: labels[i] });
				});
				return out;
			};

			if (useFire) {
				// 1) ì´ìƒì : CSVì— 30-1 ~ FC10 ëª¨ë‘ ìˆëŠ” ê²½ìš°
				const s1 = findIdx('30');
				const e1 = findIdx('FC10');
				if (s1 !== -1 && e1 !== -1 && s1 <= e1) {
					const arr = [];
					for (let i = s1; i <= e1; i++) arr.push({ idx: i, label: labels[i] });
					return arr;
				}

				// 2) ì•„ì¹´ë°ë¯¸ ê°™ì€ ì¼€ì´ìŠ¤: FC1 ~ FC10ë§Œ ìˆëŠ” ê²½ìš°
				const s2 = labels.findIndex(lv => /^FC\s*0*1$/i.test(lv));
				const e2 = labels.findIndex(lv => /^FC\s*0*10$/i.test(lv));
				if (s2 !== -1 && e2 !== -1 && s2 <= e2) {
					const arr = [];
					for (let i = s2; i <= e2; i++) arr.push({ idx: i, label: labels[i] });
					return arr;
				}

				// 3) ë°±ì—…: 30-x ë˜ëŠ” FC1~FC10 íŒ¨í„´ë§Œ ëª¨ì•„ì„œ(ì›ë³¸ ìˆœì„œ ìœ ì§€)
				out.length = 0;
				collectBy(/^(30-\d|FC0*[1-9]|FC0*10)$/i);
				return out;
			}

			// ì¼ë°˜ ëª¨ë“œ: 1~30ì´ ìˆìœ¼ë©´ ê·¸ ë²”ìœ„, ì—†ìœ¼ë©´ FC1~FC10 ë²”ìœ„
			const numeric = [];
			labels.forEach((lv, i) => {
				const m = lv.match(/^\s*(\d+)\s*$/);
				if (m) {
					const n = parseInt(m[1], 10);
					if (n >= 1 && n <= 30) numeric.push({ idx: i, label: lv });
				}
			});
			if (numeric.length) return numeric;

			// ìˆ«ì 1~30ì´ ì—†ë‹¤ë©´ FC1~FC10 ì‹œë„
			const s3 = labels.findIndex(lv => /^FC\s*0*1$/i.test(lv));
			const e3 = labels.findIndex(lv => /^FC\s*0*10$/i.test(lv));
			if (s3 !== -1 && e3 !== -1 && s3 <= e3) {
				const arr = [];
				for (let i = s3; i <= e3; i++) arr.push({ idx: i, label: labels[i] });
				return arr;
			}

			// ìµœí›„: ì›ë³¸ ì „ì²´(ì–´ë–¤ CSVë“  ìµœì†Œí•œ ì „ë¶€ ë…¸ì¶œ)
			return labels.map((lv, i) => ({ idx: i, label: lv }));
		}

		// í† ê¸€ í•¸ë“¤ëŸ¬
		function hookFireCrystalToggle() {
			const el = document.getElementById('fireCrystalToggle');
			if (!el) return;

			// âœ… í•­ìƒ ì²´í¬ ìƒíƒœë¡œ ì‹œì‘
			useFireCrystal = true;
			el.checked = true;

			// âœ… localStorageì— ì¦‰ì‹œ ì €ì¥í•´ì„œ ìƒˆë¡œê³ ì¹¨ í›„ì—ë„ ìœ ì§€
			localStorage.setItem('useFireCrystal', '1');

			el.addEventListener('change', () => {
				useFireCrystal = el.checked;
				localStorage.setItem('useFireCrystal', useFireCrystal ? '1' : '0');
				renderBuildingSelectors();
				scheduleCalc();
			});
		}

		// í˜ì´ì§€ ë¡œë“œ ì‹œ 1ë²ˆë§Œ í˜¸ì¶œ
		document.addEventListener('DOMContentLoaded', hookFireCrystalToggle);
	</script>	
	<script>
    // F12, Ctrl+Shift+I, Ctrl+U ë“± ë°©ì§€
    document.onkeydown = function (e) {
      if (
        e.keyCode === 123 || // F12
        (e.ctrlKey && e.shiftKey && e.keyCode === 73) || // Ctrl+Shift+I
        (e.ctrlKey && e.shiftKey && e.keyCode === 74) || // Ctrl+Shift+J
        (e.ctrlKey && e.keyCode === 85) // Ctrl+U
      ) {
        e.preventDefault();
        return false;
      }
    };
  
    // ìš°í´ë¦­ ë°©ì§€
    document.addEventListener("contextmenu", (e) => e.preventDefault());
  </script>
  <script>
    window.addEventListener('message', (e) => {
      if (e.data?.type === 'DARK_MODE') {
        document.body.classList.toggle('dark-mode', e.data.value);
      }
    });
  </script>
</body>
</html>
