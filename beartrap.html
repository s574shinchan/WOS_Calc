<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>곰사냥 부대 계산기</title>
  <script>
    (function () {
      try {
        const v = localStorage.getItem('darkMode');
        if (v === 'true') document.documentElement.classList.add('dark-mode');
      } catch (e) {}
    })();
  </script>  
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .dark-mode .card { background:#1f1f1f; border-color:#2a2a2a; }
    .dark-mode input, .dark-mode select { color:#000; }
    .dark-mode .section-title{ font-weight:700; color:#ffffff }
    .dark-mode .subtle{ color:#ffffff; font-size:12px }
    .dark-mode .field-label{ font-size:12px; color:#ffffff }
    
    /* 카드 공통 */
    .card{
      background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:14px;
      box-shadow:0 6px 18px rgba(15,23,42,.06)
    }
    .section-title{ font-weight:700; color:#334155 }
    .subtle{ color:#64748b; font-size:12px }
    .field-label{ font-size:12px; color:#475569 }
    .num{ font-variant-numeric: tabular-nums }
  </style>
  <link rel="stylesheet" href="css/common.css">
  <script src="js/common.js"></script>  
</head>
<body>
  <div id="navMount"></div>
  
  <div class="max-w-[1500px] mx-auto bg-white rounded shadow p-2 flex flex-col sm:flex-row gap-2">
    <div class="flex-1 bg-white rounded p-2 space-y-4 shadow">
      <div class="bg-gray-100 p-2 font-sans text-sm">
        <div class="bg-white p-4 rounded-xl shadow-md space-y-4">
          <h1 class="text-2xl font-bold text-gray-800 mb-4">⚔ 부대출정 계산기</h1>

          <!-- 상: 사용자 입력항목--->
          <section class="card p-4 mb-2">
            <h2 class="mb-3">사용자 입력</h2>

            <!-- 윗줄: 4칸-->
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-4">
              <div>
                <label class="field-label">출정부대 수용량(기본)</label>
                <input id="baseMarch" type="text"
                       class="w-full border rounded-md p-2"
                       oninput="UI.formatNumberInput(this); Calc.updateCapacityAndTable()"/>
              </div>
              <div>
                <label class="field-label">집결부대 수용량(기본)</label>
                <input id="baseRally" type="text"
                       class="w-full border rounded-md p-2"
                       oninput="UI.formatNumberInput(this); Calc.updateCapacityAndTable()"/>
              </div>    
              <div>
                <label class="field-label">총 보유 방패병</label>
                <input id="ownInf" type="text"
                       class="w-full border rounded-md p-2"
                       oninput="UI.formatNumberInput(this); Calc.updateTableOnly()"/>
              </div>

              <div>
                <label class="field-label">총 보유 창병</label>
                <input id="ownLan" type="text"
                       class="w-full border rounded-md p-2"
                       oninput="UI.formatNumberInput(this); Calc.updateTableOnly()"/>
              </div>

              <div>
                <label class="field-label">총 보유 궁병</label>
                <input id="ownMar" type="text"
                       class="w-full border rounded-md p-2"
                       oninput="UI.formatNumberInput(this); Calc.updateTableOnly()"/>
              </div>
            </div>

            <!-- 아랫줄: 4칸 -->
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-4 mt-3">
              <div>
                <label class="field-label">총 행군 수</label>
                <input id="marchCount" type="text"
                       class="w-full border rounded-md p-2"
                       oninput="UI.formatNumberInput(this); Calc.updateTableOnly()"/>
              </div>

              <div>
                <label class="field-label">적용 비율 선택</label>
                <select id="ratioPreset" class="w-full border rounded-md p-2"
                        onchange="UI.onPresetChange()">
                  <option value="34/33/33">34 / 33 / 33</option>
                  <option value="20/40/40">20 / 40 / 40</option>
                  <option value="10/10/80">10 / 10 / 80</option>
                  <option value="60/40/0">60 / 40 / 0</option>
                  <option value="50/20/30">50 / 20 / 30</option>
                  <option value="custom">사용자 지정</option>
                </select>
              </div>

              <div>
                <label class="field-label">방패(%)</label>
                <input id="ratioInf" type="text"
                       class="w-full border rounded-md p-2"
                       oninput="UI.formatNumberInput(this); Calc.updateTableOnly()" disabled/>
              </div>

              <div>
                <label class="field-label">창(%)</label>
                <input id="ratioLan" type="text"
                       class="w-full border rounded-md p-2"
                       oninput="UI.formatNumberInput(this); Calc.updateTableOnly()" disabled/>
              </div>
              <div>
                <label class="field-label">궁(%)</label>
                <input id="ratioMar" type="text"
                       class="w-full border rounded-md p-2"
                       oninput="UI.formatNumberInput(this); Calc.updateTableOnly()" disabled/>
              </div>
            </div>
          </section>

          <!-- 중: 버프 선택-->
          <section class="card p-4  mb-2">
            <h2 class="mb-3">버프 선택</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-2">
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-2 space-y-2">
                <!-- 도시 버프 -->
                <div>
                  <div class="space-y-2"> 
                    <div class="font-semibold text-gray-800">도시 버프</div>
                    <label class="flex items-center gap-2">
                      <input type="radio" name="cityBuff" value="0" checked
                             onchange="Calc.updateCapacityAndTable()"/>
                      없음
                    </label>
                    <label class="flex items-center gap-2">
                      <input type="radio" name="cityBuff" value="10"
                             onchange="Calc.updateCapacityAndTable()"/>
                      출정 수용량 증가 2h (+10%)
                    </label>
                    <label class="flex items-center gap-2">
                      <input type="radio" name="cityBuff" value="20"
                             onchange="Calc.updateCapacityAndTable()"/>
                      출정 수용량 증가 12h (+20%)
                    </label>
                  </div>
                </div>          
                <div class="space-y-3">
                  <div class="font-semibold text-gray-800">펫 버프</div>

                  <!-- 고릴라 -->
                  <div class="flex items-center gap-3">
                    <label class="flex items-center gap-2 whitespace-nowrap">
                      <input id="chkGorilla" type="checkbox"
                             onchange="UI.togglePetSelect('gorillaLv', this.checked); Calc.updateCapacityAndTable()"/>
                      프로스타 고릴라
                    </label>

                    <select id="gorillaLv"
                            class="border rounded-md h-8 w-24 px-2 text-[12px] leading-8"
                            disabled
                            onchange="Calc.updateCapacityAndTable()">
                      <option value="0">Lv.0</option>
                      <option value="1">Lv.1</option>
                      <option value="2">Lv.2</option>
                      <option value="3">Lv.3</option>
                      <option value="4">Lv.4</option>
                      <option value="5">Lv.5</option>
                      <option value="6">Lv.6</option>
                      <option value="7">Lv.7</option>
                      <option value="8">Lv.8</option>
                      <option value="9">Lv.9</option>
                      <option value="10" selected>Lv.10</option>
                    </select>
                  </div>

                  <!-- 코뿔소 -->
                  <div class="flex items-center gap-3">
                    <label class="flex items-center gap-2 whitespace-nowrap">
                      <input id="chkRhino" type="checkbox"
                             onchange="UI.togglePetSelect('rhinoLv', this.checked); Calc.updateCapacityAndTable()"/>
                      초거대 코뿔소
                    </label>

                    <select id="rhinoLv"
                            class="border rounded-md h-8 w-24 px-2 text-[12px] leading-8"
                            disabled
                            onchange="Calc.updateCapacityAndTable()">
                      <option value="0">Lv.0</option>
                      <option value="1">Lv.1</option>
                      <option value="2">Lv.2</option>
                      <option value="3">Lv.3</option>
                      <option value="4">Lv.4</option>
                      <option value="5">Lv.5</option>
                      <option value="6">Lv.6</option>
                      <option value="7">Lv.7</option>
                      <option value="8">Lv.8</option>
                      <option value="9">Lv.9</option>
                      <option value="10" selected>Lv.10</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- 3) 전문가 버프 (로물루스 제거: 키릴/파비안/발레리아) -->
              <div class="space-y-2">
                <div class="font-semibold text-gray-800">전문가 버프</div>

                <!-- PC: 2열 / 모바일: 1열 -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">

                  <!-- ===================== 키릴 (스킬 2개) ===================== -->
                  <div class="space-y-2">
                    <label class="flex items-center gap-2 whitespace-nowrap">
                      <input id="chkExpert" type="checkbox"
                             onchange="UI.toggleSelect('expertWrapC', this.checked); Calc.updateCapacityAndTable()"/>
                      전문가(키릴)
                    </label>

                    <div id="expertWrapC" class="opacity-0 pointer-events-none">
                      <div class="flex items-center gap-3">
                        <div class="w-12 text-[12px] text-gray-500 whitespace-nowrap">사방포획</div>
                        <select id="nemLvA"
                                class="border rounded-md h-8 w-24 px-2 text-[12px] leading-8"
                                onchange="Calc.updateCapacityAndTable()">
                          <option value="0" selected>Lv.0</option>
                          <option value="1">Lv.1</option>
                          <option value="2">Lv.2</option>
                          <option value="3">Lv.3</option>
                          <option value="4">Lv.4</option>
                          <option value="5">Lv.5</option>
                          <option value="6">Lv.6</option>
                          <option value="7">Lv.7</option>
                          <option value="8">Lv.8</option>
                          <option value="9">Lv.9</option>
                          <option value="10">Lv.10</option>
                        </select>

                        <div class="w-12 text-[12px] text-gray-500 whitespace-nowrap">곰의천적</div>
                        <select id="nemLvB"
                                class="border rounded-md h-8 w-24 px-2 text-[12px] leading-8"
                                onchange="Calc.updateCapacityAndTable()">
                          <option value="0" selected>Lv.0</option>
                          <option value="1">Lv.1</option>
                          <option value="2">Lv.2</option>
                          <option value="3">Lv.3</option>
                          <option value="4">Lv.4</option>
                          <option value="5">Lv.5</option>
                          <option value="6">Lv.6</option>
                          <option value="7">Lv.7</option>
                          <option value="8">Lv.8</option>
                          <option value="9">Lv.9</option>
                          <option value="10">Lv.10</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  <!-- ===================== 파비안 (스킬 1개) ===================== -->
                  <div class="space-y-2">
                    <label class="flex items-center gap-2 whitespace-nowrap">
                      <input id="chkExpert3" type="checkbox"
                             onchange="UI.toggleSelect('expertWrapF', this.checked); Calc.updateCapacityAndTable()"/>
                      전문가(파비안)
                    </label>

                    <div id="expertWrapF" class="opacity-0 pointer-events-none">
                      <div class="flex items-center gap-3">
                        <div class="w-12 text-[12px] text-gray-500 whitespace-nowrap">군수거목</div>
                        <select id="nemLv3"
                                class="border rounded-md h-8 w-24 px-2 text-[12px] leading-8"
                                onchange="Calc.updateCapacityAndTable()">
                          <option value="0" selected>Lv.0</option>
                          <option value="1">Lv.1</option>
                          <option value="2">Lv.2</option>
                          <option value="3">Lv.3</option>
                          <option value="4">Lv.4</option>
                          <option value="5">Lv.5</option>
                          <option value="6">Lv.6</option>
                          <option value="7">Lv.7</option>
                          <option value="8">Lv.8</option>
                          <option value="9">Lv.9</option>
                          <option value="10">Lv.10</option>
                          <option value="11">Lv.11</option>
                          <option value="12">Lv.12</option>
                          <option value="13">Lv.13</option>
                          <option value="14">Lv.14</option>
                          <option value="15">Lv.15</option>
                          <option value="16">Lv.16</option>
                          <option value="17">Lv.17</option>
                          <option value="18">Lv.18</option>
                          <option value="19">Lv.19</option>
                          <option value="20">Lv.20</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  <!-- ===================== 발레리아 (스킬 1개) ===================== -->
                  <div class="space-y-2">
                    <label class="flex items-center gap-2 whitespace-nowrap">
                      <input id="chkExpert4" type="checkbox"
                             onchange="UI.toggleSelect('expertWrapV', this.checked); Calc.updateCapacityAndTable()"/>
                      전문가(발레리아)
                    </label>

                    <div id="expertWrapV" class="opacity-0 pointer-events-none">
                      <div class="flex items-center gap-3">
                        <div class="w-20 text-[12px] text-gray-500 whitespace-nowrap">압도적인 기세</div>
                        <select id="nemLv4"
                                class="border rounded-md h-8 w-24 px-2 text-[12px] leading-8"
                                onchange="Calc.updateCapacityAndTable()">
                          <option value="0" selected>Lv.0</option>
                          <option value="1">Lv.1</option>
                          <option value="2">Lv.2</option>
                          <option value="3">Lv.3</option>
                          <option value="4">Lv.4</option>
                          <option value="5">Lv.5</option>
                          <option value="6">Lv.6</option>
                          <option value="7">Lv.7</option>
                          <option value="8">Lv.8</option>
                          <option value="9">Lv.9</option>
                          <option value="10">Lv.10</option>
                          <option value="11">Lv.11</option>
                          <option value="12">Lv.12</option>
                          <option value="13">Lv.13</option>
                          <option value="14">Lv.14</option>
                          <option value="15">Lv.15</option>
                          <option value="16">Lv.16</option>
                          <option value="17">Lv.17</option>
                          <option value="18">Lv.18</option>
                          <option value="19">Lv.19</option>
                          <option value="20">Lv.20</option>
                        </select>
                      </div>
                    </div>
                  </div>

                </div>
              </div>

            </div>
          </section>

          <!-- 하: 결과 -->
          <section class="card p-4">
            <h2 class="mb-3">결과</h2>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-2">
              <div>
                <label class="field-label">출정부대 수용량 (버프 적용)</label>
                <input id="finalMarch" type="text" readonly
                       class="w-full border rounded-md p-2 bg-gray-100 num text-gray-800"/>
              </div>
              <div>
                <label class="field-label">출정 수용량 보너스</label>
                <input id="MarchBonus" type="text" readonly
                       class="w-full border rounded-md p-2 bg-gray-100 num text-gray-800" />
              </div>
              <div>
                <label class="field-label">집결부대 수용량 (버프 적용)</label>
                <input id="finalRally" type="text" readonly
                       class="w-full border rounded-md p-2 bg-gray-100 num text-gray-800"/>
              </div>        
              <div>
                <label class="field-label">집결 수용량 보너스</label>
                <input id="RallyBonus" type="text" readonly
                       class="w-full border rounded-md p-2 bg-gray-100 num text-gray-800" />
              </div>        
            </div>

            <div class="overflow-x-auto">
              <table class="w-full border border-gray-200">
                <thead class="bg-orange-100 text-gray-800">
                  <tr class="text-center">
                    <th class="border px-2 py-1">행군</th>
                    <th class="border px-2 py-1">방패병</th>
                    <th class="border px-2 py-1">창병</th>
                    <th class="border px-2 py-1">궁병</th>
                  </tr>
                </thead>
                <tbody id="resultTbody">
                  <tr><td class="border text-center p-2" colspan="4">결과 없음</td></tr>
                </tbody>
              </table>
            </div>
          </section>          
        </div>
      </div>
    </div>
  </div>
  
  <div id="footerMount"></div>

  <script>
    fetch("nav.html")
      .then(r => r.text())
      .then(html => {
        document.getElementById("navMount").innerHTML = html;
        //initNav({ mode: "iframe" });    // ✅ iframe 계속 쓸거면
        initNav({ mode: "navigate" }); // ✅ 페이지 이동으로 갈거면
      });
    
    // 2) FOOTER
    fetch("footer.html").then(r=>r.text()).then(html=>{
      document.getElementById("footerMount").innerHTML = html;
      initFooter({ mode:"navigate" }); // 또는 "iframe"
      initAdsense({ ids:["ad1"] });    // 슬롯 id들
    });
  </script>  

  <!-- ========================= 스크립트 ========================= -->
  <script>
    /* ------------------------- 상수/테이블 ------------------------- */
    const GorillaPerLevel = 1500; // 설명 텍스트용(임의 표시)
    const Rhino = { 0:0, 1:60000, 2:70000, 3:80000, 4:90000, 5:100000, 6:110000, 7:120000, 8:130000, 9:140000, 10:150000 };
    const Cyrille = { // 곰의천적(출정 수용량 +)
      0:0, 1:3000, 2:6000, 3:9000, 4:12000, 5:15000,6:18000, 7:21000, 8:24000, 9:27000, 10:30000
    };
    const Cyrille2 = { // 사방(집결 수용량 +)
      0:0, 1:30000, 2:60000, 3:90000, 4:120000, 5:150000,6:180000, 7:210000, 8:240000, 9:270000, 10:300000
    };
    const Romulus = {
      0:0, 1:5000, 2:10000, 3:15000, 4:20000, 5:25000, 6:30000, 7:35000, 8:40000, 9:45000, 10:50000,
      11:55000, 12:60000, 13:65000, 14:70000, 15:75000, 16:80000, 17:85000, 18:90000, 19:95000, 20:100000
    };
    const Fabian = {
      0:0, 1:7500, 2:15000, 3:22500, 4:30000, 5:37500, 6:45000, 7:52500, 8:60000, 9:67500, 10:75000,
      11:82500, 12:90000, 13:97500, 14:105000, 15:112500, 16:120000, 17:127500, 18:135000, 19:142500, 20:150000
    };
    const Valeria = {
      0:0, 1:7500, 2:15000, 3:22500, 4:30000, 5:37500, 6:45000, 7:52500, 8:60000, 9:67500, 10:75000,
      11:82500, 12:90000, 13:97500, 14:105000, 15:112500, 16:120000, 17:127500, 18:135000, 19:142500, 20:150000
    };    

    /* ------------------------- UI 유틸 ------------------------- */
    const UI = {
      // "1,234" 형식 입력 보정
      formatNumberInput(el){
        const raw = (el.value || '').replace(/,/g,'').replace(/[^\d]/g,'');
        if (raw === '') { el.value = ''; return; }
        el.value = Number(raw).toLocaleString();
      },
      // 보이기/숨기기
      toggle(id, show){ document.getElementById(id).classList.toggle('hidden', !show); },
      // 프리셋 변경 시 사용자 입력 활성/비활성
      onPresetChange(){
        const val = document.getElementById('ratioPreset').value;
        const custom = (val === 'custom');
        ['ratioInf','ratioLan','ratioMar'].forEach(id=>{
          const el = document.getElementById(id);
          el.disabled = !custom;
          if (!custom) el.value = '';
        });
        // 프리셋이면 바로 테이블 업데이트
        Calc.updateTableOnly();
      }
    };

    /* ------------------------- 계산 로직 ------------------------- */
    const Calc = {
      // 현재 선택된 비율(%) 반환
      getRatios(){
        const preset = document.getElementById('ratioPreset').value;
        if (preset !== 'custom'){
          const [i,l,m] = preset.split('/').map(Number);
          return { inf:i, lan:l, mar:m };
        }
        const inf = Number((document.getElementById('ratioInf').value||'').replace(/,/g,''))||0;
        const lan = Number((document.getElementById('ratioLan').value||'').replace(/,/g,''))||0;
        const mar = Number((document.getElementById('ratioMar').value||'').replace(/,/g,''))||0;
        // 100% 안전장치
        const sum = inf+lan+mar;
        return sum>0 ? {inf,lan,mar} : {inf:34,lan:33,mar:33};
      },

      // 도시 버프 배수
      cityMultiplier(){
        const sel = document.querySelector('input[name="cityBuff"]:checked');
        const pct = sel ? Number(sel.value) : 0;
        return 1 + (pct/100);
      },
      
      finalRallyCapacity(){
        const baseMarch  = Number((document.getElementById('baseMarch').value||'').replace(/,/g,''))||0;
        const baseRally  = Number((document.getElementById('baseRally').value||'').replace(/,/g,''))||0;

        // finalMarch는 input에서 읽지 말고 계산 함수로 가져오는게 안전
        const finalMarch = Calc.finalMarchCapacity();

        // ✅ 코뿔소
        const rhinoOn  = document.getElementById('chkRhino')?.checked;
        const rhinoLv  = Number(document.getElementById('rhinoLv')?.value || 0);
        const rhinoFlat = rhinoOn ? (Rhino[rhinoLv] || 0) : 0;

        // ✅ 키릴(사방포획 = nemLvA)
        const kyrilOn = document.getElementById('chkExpert')?.checked;
        const lvA = Number(document.getElementById('nemLvA')?.value || 0);
        const cyrilleBonus = kyrilOn ? (Cyrille2[lvA] || 0) : 0;

        // ✅ 파비안(nemLv3)
        const fabianOn = document.getElementById('chkExpert3')?.checked;
        const lvF = Number(document.getElementById('nemLv3')?.value || 0);
        const fabianBonus = fabianOn ? (Fabian[lvF] || 0) : 0;

        // ✅ 발레리아(nemLv4)
        const valeriaOn = document.getElementById('chkExpert4')?.checked;
        const lvV = Number(document.getElementById('nemLv4')?.value || 0);
        const valeriaBonus = valeriaOn ? (Valeria[lvV] || 0) : 0;

        const rallyBonus = cyrilleBonus + fabianBonus + valeriaBonus;

        // 
        const finalBase = (baseRally - baseMarch) + finalMarch;

        return Math.floor(finalBase + rhinoFlat + rallyBonus);
      },
      
      // 최종 '출정부대 수용량' 계산
      finalMarchCapacity(){
        const base = Number((document.getElementById('baseMarch').value||'').replace(/,/g,''))||0;
        
        // 고릴라(집결에도 적용할지: 적용하려면 유지, 아니면 0으로)
        const gorillaOn = document.getElementById('chkGorilla').checked;
        const gorillaLv = Number(document.getElementById('gorillaLv').value||0);
        
        const expertOn = document.getElementById('chkExpert').checked;
        const nemLv = Number(document.getElementById('nemLvB').value||0);
        const cyrilleBonus = expertOn ? Cyrille[nemLv] : 0;

        let MarchBonus = cyrilleBonus;
        
        const gorillaFlat = gorillaOn ? gorillaLv*GorillaPerLevel : 0;

        // 도시 버프 배수
        const mult = Calc.cityMultiplier();

        // 최종: (기본 + 전문가 보너스) * 도시배수
        // 필요 시 + gorillaFlat 추가 가능
        return Math.floor((base + gorillaFlat + MarchBonus) * mult);
      },

      // 표 렌더
      renderTable(capacity){
        const tbody = document.getElementById('resultTbody');
        const marches = Number((document.getElementById('marchCount').value||'').replace(/,/g,''))||0;
        if (!capacity || !marches){
          tbody.innerHTML = `<tr><td class="border text-center p-2" colspan="4">결과 없음</td></tr>`;
          return;
        }

        const {inf,lan,mar} = Calc.getRatios();
        let html = '', sumI=0,sumL=0,sumM=0;

        for (let i=1;i<=marches;i++){
          const vI = Math.floor(capacity * inf / 100);
          const vL = Math.floor(capacity * lan / 100);
          const vM = Math.floor(capacity * mar / 100);
          sumI+=vI; sumL+=vL; sumM+=vM;

          html+=`<tr class="text-center">
            <td class="border px-2 py-1">${i}</td>
            <td class="border px-2 py-1 num">${vI.toLocaleString()}</td>
            <td class="border px-2 py-1 num">${vL.toLocaleString()}</td>
            <td class="border px-2 py-1 num">${vM.toLocaleString()}</td>
          </tr>`;
        }

        // 합계 & 남은값
        const ownI = Number((document.getElementById('ownInf').value||'').replace(/,/g,''))||0;
        const ownL = Number((document.getElementById('ownLan').value||'').replace(/,/g,''))||0;
        const ownM = Number((document.getElementById('ownMar').value||'').replace(/,/g,''))||0;

        html+=`<tr class="bg-gray-100 font-semibold text-center">
          <td class="border px-2 py-1">합계</td>
          <td class="border px-2 py-1 num">${sumI.toLocaleString()}</td>
          <td class="border px-2 py-1 num">${sumL.toLocaleString()}</td>
          <td class="border px-2 py-1 num">${sumM.toLocaleString()}</td>
        </tr>
        <tr class="bg-amber-100 font-semibold text-center">
          <td class="border px-2 py-1">남은값</td>
          <td class="border px-2 py-1 num">${(ownI-sumI).toLocaleString()}</td>
          <td class="border px-2 py-1 num">${(ownL-sumL).toLocaleString()}</td>
          <td class="border px-2 py-1 num">${(ownM-sumM).toLocaleString()}</td>
        </tr>`;

        tbody.innerHTML = html;
      },

      // 상단/중단 변경 시 전체 갱신
      updateCapacityAndTable(){
        const cap = Calc.finalMarchCapacity();
        document.getElementById('finalMarch').value = cap.toLocaleString();

        // 보너스 표시
        const nm = document.getElementById('chkExpert').checked
          ? Cyrille[ Number(document.getElementById('nemLvB').value||0) ] : 0;
        
        document.getElementById('MarchBonus').value = nm.toLocaleString();
        Calc.renderTable(cap);
        
        // 집결량 계산
        const capRally = Calc.finalRallyCapacity();
        document.getElementById('finalRally').value = capRally.toLocaleString();

        // 집결 보너스 표시(로물루스/파비안/발레리아 합)
        const cB = document.getElementById('chkExpert').checked
          ? (Cyrille2[ Number(document.getElementById('nemLvA').value||0) ] || 0) : 0;
        
        const fB = document.getElementById('chkExpert3').checked
          ? (Fabian[ Number(document.getElementById('nemLv3').value||0) ] || 0) : 0;
        
        const vB = document.getElementById('chkExpert4').checked
          ? (Valeria[ Number(document.getElementById('nemLv4').value||0) ] || 0) : 0;
        
        document.getElementById('RallyBonus').value = (cB+fB+vB).toLocaleString();
        
        Calc.renderTable(cpaRally);
      },

      // 표만 갱신(비율/보유 변경 등)
      updateTableOnly(){
        const cap = Calc.finalMarchCapacity();
        document.getElementById('finalMarch').value = cap.toLocaleString();
        Calc.renderTable(cap);
        
        const capRally = Calc.finalRallyCapacity();
        document.getElementById('finalRally').value = capRally.toLocaleString();
        Calc.renderTable(capRally);
      }
    };

    /* ------------------------- 이벤트 바인딩 ------------------------- */
    // 초기 프리셋(34/33/33)
    document.addEventListener('DOMContentLoaded', ()=>{
      Calc.updateCapacityAndTable();

      // 입력/선택 변화 시 자동 반영
      [
        'baseMarch','marchCount','ownInf','ownLan','ownMar',
        'ratioInf','ratioLan','ratioMar','gorillaLv', 'rhinoLv',
        'nemLvA','nemLvB','nemLv3','nemLv4'
      ].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', ()=>Calc.updateCapacityAndTable());
        if (el) el.addEventListener('change', ()=>Calc.updateCapacityAndTable());
      });
    });
  </script>
  <script>
    // ✅ 레이아웃은 고정, 보이기만 토글 (움찔 없음)
    window.UI = window.UI || {};
    
    UI.toggleSelect = function(id, on){
      const sel = document.getElementById(id);
      if(!sel) return;
      
      sel.classList.toggle("opacity-0", !on);
      sel.classList.toggle("pointer-events-none", !on);
      sel.classList.toggle("opacity-100", on);

      // 선택: 부드럽게 보이게 (원하면)
      sel.classList.add("transition-opacity", "duration-150");
    };
    
    UI.togglePetSelect = function(selectId, on){
      const sel = document.getElementById(selectId);
      if(!sel) return;
      
      sel.disabled = !on;
      
      // Tailwind 클래스 생성 문제 피하려고 style로 처리(확실함)
      sel.style.opacity = on ? "1" : "0.5";
    };
  </script>  
  <script>
	  /* 유틸 */
	  function sendHeightToParent(){ 
		  const h=document.body.scrollHeight+10; 
		  window.parent?.postMessage({type:"FRAME_CHANGE",height:h},"*"); 
	  }
    
    window.addEventListener("load", ()=> setTimeout(sendHeightToParent,100));
	  
    // F12, Ctrl+Shift+I, Ctrl+U 등 방지
    document.onkeydown = function (e) {
      if (
        e.keyCode === 123 || // F12
        (e.ctrlKey && e.shiftKey && e.keyCode === 73) || // Ctrl+Shift+I
        (e.ctrlKey && e.shiftKey && e.keyCode === 74) || // Ctrl+Shift+J
        (e.ctrlKey && e.keyCode === 85) // Ctrl+U
      ) {
        e.preventDefault();
        return false;
      }
    };
  
    // 우클릭 방지
    document.addEventListener("contextmenu", (e) => e.preventDefault());
  </script>
  <script>
    window.addEventListener('message', (e) => {
      if (e.data?.type === 'DARK_MODE') {
        document.body.classList.toggle('dark-mode', e.data.value);
      }
    });
  </script>
</body>
</html>
