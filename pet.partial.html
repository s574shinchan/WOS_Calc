<meta charset="UTF-8" />
<div class="max-w-[1500px] mx-auto bg-white rounded shadow p-2 flex flex-col sm:flex-row gap-2">
  <div class="flex-1 bg-white rounded p-2 space-y-4 shadow">
    <div class="bg-gray-100 p-2 font-sans text-sm">
      <div class="bg-white p-4 rounded-xl shadow-md space-y-4">

        <h1 class="text-2xl font-bold text-gray-800">ğŸ¾ í« ê³„ì‚°ê¸°</h1>
        <p>í«(ë“±ê¸‰/ì´ë¦„)ë³„ë¡œ <b>í˜„ì¬ â†’ ëª©í‘œ</b>ë¥¼ ì§€ì •í•˜ë©´, í•„ìš”í•œ <b>í«ë¨¹ì´/ì¡°ë ¨ë§¤ë‰´ì–¼/í™œë ¥ì˜ì•½/ê°•í™”í˜ˆì²­</b>ì´ ìë™ í•©ì‚°ë©ë‹ˆë‹¤.</p>

        <!-- ë³´ìœ ëŸ‰ -->
        <div class="rounded-xl border border-black/10 p-3">
          <div class="flex items-center justify-between mb-2">
            <div class="font-semibold">ë³´ìœ ëŸ‰</div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
            <div class="flex items-center gap-2">
              <label class="text-[12px] text-gray-600 w-24">ë³´ìœ  í«ë¨¹ì´</label>
              <input type="number" id="own-í«ë¨¹ì´"
                class="flex-1 border rounded-lg px-3 py-2 text-sm"
                placeholder="0" min="0" />
            </div>

            <div class="flex items-center gap-2">
              <label class="text-[12px] text-gray-600 w-24">ë³´ìœ  ì¡°ë ¨ë§¤ë‰´ì–¼</label>
              <input type="number" id="own-ì¡°ë ¨ë§¤ë‰´ì–¼"
                class="flex-1 border rounded-lg px-3 py-2 text-sm"
                placeholder="0" min="0" />
            </div>

            <div class="flex items-center gap-2">
              <label class="text-[12px] text-gray-600 w-24">ë³´ìœ  í™œë ¥ì˜ì•½</label>
              <input type="number" id="own-í™œë ¥ì˜ì•½"
                class="flex-1 border rounded-lg px-3 py-2 text-sm"
                placeholder="0" min="0" />
            </div>

            <div class="flex items-center gap-2">
              <label class="text-[12px] text-gray-600 w-24">ë³´ìœ  ê°•í™”í˜ˆì²­</label>
              <input type="number" id="own-ê°•í™”í˜ˆì²­"
                class="flex-1 border rounded-lg px-3 py-2 text-sm"
                placeholder="0" min="0" />
            </div>
          </div>
        </div>

        <!-- ì„¹ì…˜ë³„ ì¹´ë“œ ì»¨í…Œì´ë„ˆ -->
        <div id="petSections" class="space-y-4"></div>

        <!-- í•˜ë‹¨ ì´í•© íŒ¨ë„ -->
        <div id="summaryPanel">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
            <!-- ì´í•© -->
            <div class="rounded-xl border border-black/10 p-3">
              <div class="font-semibold mb-2">ì´í•©</div>
              <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="flex justify-between text-[13px]"><span class="text-gray-600">í«ë¨¹ì´</span><span id="sum-í«ë¨¹ì´">0</span></div>
                <div class="flex justify-between text-[13px]"><span class="text-gray-600">ì¡°ë ¨ë§¤ë‰´ì–¼</span><span id="sum-ì¡°ë ¨ë§¤ë‰´ì–¼">0</span></div>
                <div class="flex justify-between text-[13px]"><span class="text-gray-600">í™œë ¥ì˜ì•½</span><span id="sum-í™œë ¥ì˜ì•½">0</span></div>
                <div class="flex justify-between text-[13px]"><span class="text-gray-600">ê°•í™”í˜ˆì²­</span><span id="sum-ê°•í™”í˜ˆì²­">0</span></div>
              </div>
            </div>
            <!-- ê³¼ë¶€ì¡± -->
            <div class="rounded-xl border border-black/10 p-3">
              <div class="font-semibold mb-2">ê³¼ë¶€ì¡±</div>
              <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="flex justify-between text-[13px]"><span class="text-gray-600">í«ë¨¹ì´</span><span id="def-í«ë¨¹ì´">0</span></div>
                <div class="flex justify-between text-[13px]"><span class="text-gray-600">ì¡°ë ¨ë§¤ë‰´ì–¼</span><span id="def-ì¡°ë ¨ë§¤ë‰´ì–¼">0</span></div>
                <div class="flex justify-between text-[13px]"><span class="text-gray-600">í™œë ¥ì˜ì•½</span><span id="def-í™œë ¥ì˜ì•½">0</span></div>
                <div class="flex justify-between text-[13px]"><span class="text-gray-600">ê°•í™”í˜ˆì²­</span><span id="def-ê°•í™”í˜ˆì²­">0</span></div>
              </div>
            </div>
          </div>
        </div>

        <div class="flex justify-end mt-2">
          <button id="btn-calc-total" class="w-full px-4 py-2 rounded-lg bg-blue-600 text-white text-sm hover:bg-blue-700">ì´í•©ê³„ì‚°</button>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- ===== ë°ì´í„° & ë¡œì§ ===== -->
<script>
(function(){  
  window.PetsInit = function PetsInit(){
  // ===============================
  // âœ… ë“±ê¸‰ë³„ ì¹´ë“œ + ì¹´ë“œ ë‚´ë¶€ ì œëª©ë°”(ìŠ¤ìƒ· ìŠ¤íƒ€ì¼)
  // âœ… ì¹´ë“œ ë‚´ë¶€ ê°„ê²© compact ì²˜ë¦¬
  // ===============================

  var pets = [
    { name: "í•˜ì´ì—ë‚˜", rarityKey: "UnKnown" },

    { name: "ë¶ê·¹ëŠ‘ëŒ€", rarityKey: "N" },
    { name: "ì‚¬í–¥ì†Œ", rarityKey: "N" },

    { name: "í…Œì´í¼", rarityKey: "R" },
    { name: "í‹°íƒ€ë‹ˆìŠ¤", rarityKey: "R" },

    { name: "í°ë¿”ì‚¬ìŠ´", rarityKey: "SR" },
    { name: "í‘í‘œë²”", rarityKey: "SR" },

    { name: "ë™êµ´ì‚¬ì", rarityKey: "SSR" },
    { name: "ê³ ë¦´ë¼", rarityKey: "SSR" },
    { name: "ì½”ë¿”ì†Œ", rarityKey: "SSR" },
    { name: "í˜¸ë‘ì´", rarityKey: "SSR" },
    { name: "ë§¤ë¨¸ë“œ", rarityKey: "SSR" },
    { name: "ê¸°ê°„í† ", rarityKey: "SSR" },
    { name: "ì¹´ë©œë ˆì˜¨", rarityKey: "SSR" },
  ];

  var PET_IMAGE = {
    "í•˜ì´ì—ë‚˜": "images/pets/Cave Hyena.webp",
    "ë¶ê·¹ëŠ‘ëŒ€": "images/pets/Arctic Wolf.webp",
    "ì‚¬í–¥ì†Œ": "images/pets/Musk Ox.webp",
    "í…Œì´í¼": "images/pets/Giant Tapir.webp",
    "í‹°íƒ€ë‹ˆìŠ¤": "images/pets/Titan Roc.webp",
    "í°ë¿”ì‚¬ìŠ´": "images/pets/Giant Elk.webp",
    "í‘í‘œë²”": "images/pets/Snow Leopard.webp",
    "ë™êµ´ì‚¬ì": "images/pets/Cave Lion.webp",
    "ê³ ë¦´ë¼": "images/pets/Snoe Ape.webp",
    "ì½”ë¿”ì†Œ": "images/pets/Iron Rhino.webp",
    "í˜¸ë‘ì´": "images/pets/Saber-tooth Tiger.webp",
    "ë§¤ë¨¸ë“œ": "images/pets/Mammoth.webp",
    "ê¸°ê°„í† ": "images/pets/Frost Gorilla.webp",
    "ì¹´ë©œë ˆì˜¨": "images/pets/Frostscale Chameleon.webp",
  };

  // âœ… DOM id ì•ˆì „í‚¤
  var petKeyByName = Object.create(null);
  pets.forEach((p, i) => { petKeyByName[p.name] = `p${i}`; });

  // í¬ê·€ë„ ì„¹ì…˜(í—¤ë” ìƒ‰ìƒ/í…ìŠ¤íŠ¸)
  var sectionMeta = {
    "UnKnown": { title: "Common",   dot: "bg-slate-400",   bar: "bg-slate-200",   text: "text-slate-700" },
    "N":       { title: "Uncommon", dot: "bg-emerald-500", bar: "bg-emerald-200", text: "text-emerald-700" },
    "R":       { title: "Rare",     dot: "bg-blue-500",    bar: "bg-blue-200",    text: "text-blue-700" },
    "SR":      { title: "Epic",     dot: "bg-purple-500",  bar: "bg-purple-200",  text: "text-purple-700" },
    "SSR":     { title: "SSR",      dot: "bg-orange-500",  bar: "bg-orange-200",  text: "text-orange-800" },
  };

  var CSV_BASE = "https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Pet/";

  var dataByRarity = {};
  var levelsByPet = {};

  var sectionsRoot = document.getElementById("petSections");

  function splitLines(t){ return t.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n"); }

  async function fetchPetCSV(gradeKey) {
    var url = `${CSV_BASE}Pet_${gradeKey}.csv`;
    var res = await fetch(url);
    if (!res.ok) throw new Error("CSV not found: " + url);

    var text = await res.text();
    var lines = splitLines(text)
      .filter(Boolean)
      .map(row => row.split(","));

    var headers = lines[0].map(h => h.trim());

    var rows = lines.slice(1).map(cols => {
      var obj = {};
      headers.forEach((h, i) => {
        obj[h] = (cols[i] ?? "").trim();
      });
      return obj;
    });

    return rows;
  }

  async function loadAll() {
    var uniqueKeys = [...new Set(pets.map(p => p.rarityKey))];
    for (var key of uniqueKeys) {
      try {
        dataByRarity[key] = await fetchPetCSV(key);
      } catch (e) {
        console.warn(key, e.message);
        dataByRarity[key] = [];
      }
    }

    pets.forEach(p => {
      var rows = dataByRarity[p.rarityKey] || [];
      var lvSet = new Set(rows.map(r => (r["ë ˆë²¨"] || "").trim()).filter(Boolean));
      var lvList = [...lvSet];
      var nums = lvList.map(v => Number(v));
      var allNum = nums.every(n => !Number.isNaN(n));
      levelsByPet[p.name] = allNum ? lvList.sort((a,b)=>Number(a)-Number(b)) : lvList;
    });

    renderSections();
    bindOwnedInputs();
  }

  // âœ… compact ì¹´ë“œ ë Œë” (ì¹´ë“œë§ˆë‹¤ ì œëª©ë°” í¬í•¨)
  function renderSections() {
    sectionsRoot.innerHTML = "";

    var rarityOrder = ["UnKnown", "N", "R", "SR", "SSR"];

    for (var rk of rarityOrder) {
      var meta = sectionMeta[rk];
      if (!meta) continue;

      var groupPets = pets.filter(p => p.rarityKey === rk);
      if (groupPets.length === 0) continue;

      // ë“±ê¸‰ë³„ë¡œ ê·¸ë¦¬ë“œ ë¸”ë¡ í•˜ë‚˜(ê°„ê²© ìœ ì§€ìš©)
      var block = document.createElement("div");
      block.className = "space-y-3";
      sectionsRoot.appendChild(block);

      var grid = document.createElement("div");
      grid.className = "grid grid-cols-1 md:grid-cols-3 gap-2";
      block.appendChild(grid);

      groupPets.forEach((p) => {
        var imgSrc = PET_IMAGE[p.name];
        var key = `pet-${petKeyByName[p.name]}`;
        var lvList = levelsByPet[p.name] || [];
        var options = lvList.map(lv => `<option value="${lv}">${lv}</option>`).join("");

        var card = document.createElement("div");
        card.className = "exp-card";

        card.innerHTML = `
          <div class="card-head ${meta.bar}">
            <span class="w-2.5 h-2.5 rounded-full ${meta.dot}"></span>
            <div class="text-[13px] font-semibold ${meta.text}">${meta.title}</div>
          </div>

          <div class="p-2">
            <div class="grid grid-cols-1 md:grid-cols-[110px_1fr_1fr] gap-4 items-start">
              <!-- ì´ë¯¸ì§€ -->
              <div class="w-28 h-28 rounded-xl overflow-hidden bg-gray-100 flex items-center justify-center">
                <img src="${imgSrc}" alt="${p.name}"
                     class="w-full h-full object-contain"
                     loading="lazy"/>
              </div>
              <!-- ì´ë¦„ + í˜„ì¬/ëª©í‘œ -->
              <div>
                <div class="flex items-baseline gap-2">
                  <h3 class="text-[15px] font-semibold text-gray-800 leading-none">${p.name}</h3>
                </div>
                <div class="grid grid-cols-1 gap-2 mt-3">
                  <div class="flex items-center justify-start gap-2">
                    <span class="text-[12px] text-gray-600">í˜„ì¬</span>
                    <select id="cur-${key}" class="border rounded-lg px-2 py-1 text-sm w-32">${options}</select>
                  </div>
                  <div class="flex items-center justify-start gap-2 mt-2">
                    <span class="text-[12px] text-gray-600">ëª©í‘œ</span>
                    <select id="tgt-${key}" class="border rounded-lg px-2 py-1 text-sm w-32">${options}</select>
                  </div>
                </div>
              </div>

              <!-- í•„ìš” í•©ê³„ -->
              <div class="md:pl-4">
                <div class="flex items-baseline gap-2">
                  <h3 class="text-[15px] font-semibold text-gray-800 leading-none">í•„ìš” í•©ê³„</h3>
                </div>
                <div class="grid grid-cols-[1fr_auto] gap-x-3 mt-3 text-[13px]">
                  <div class="text-gray-600">í«ë¨¹ì´</div><div class="text-right tabular-nums" id="sub-food-${key}">0</div>
                  <div class="text-gray-600">ì¡°ë ¨ë§¤ë‰´ì–¼</div><div class="text-right tabular-nums" id="sub-manual-${key}">0</div>
                  <div class="text-gray-600">í™œë ¥ì˜ì•½</div><div class="text-right tabular-nums" id="sub-vital-${key}">0</div>
                  <div class="text-gray-600">ê°•í™”í˜ˆì²­</div><div class="text-right tabular-nums" id="sub-serum-${key}">0</div>
                </div>
              </div>

            </div>
          </div>
          `;
        grid.appendChild(card);

        var curSel = document.getElementById(`cur-${key}`);
        var tgtSel = document.getElementById(`tgt-${key}`);

        var onAnyChange = () => {
          var lvListLocal = levelsByPet[p.name] || [];
          var ci = lvListLocal.indexOf(curSel.value);
          var ti = lvListLocal.indexOf(tgtSel.value);
          if (ci !== -1 && ti !== -1 && ti < ci) tgtSel.value = curSel.value;
          updateCardSubtotal(p, key);
        };

        curSel.addEventListener("change", onAnyChange);
        tgtSel.addEventListener("change", onAnyChange);

        if (lvList.length > 0) {
          curSel.value = lvList[0];
          tgtSel.value = lvList[0];
        }

        updateCardSubtotal(p, key);
      });
    }
  }

  function toNum(v){
    var n = Number(String(v ?? "").replace(/,/g, "").trim());
    return Number.isFinite(n) ? n : 0;
  }

  function updateCardSubtotal(pet, key) {
    var rows = (dataByRarity[pet.rarityKey] || []).slice();
    var lvList = levelsByPet[pet.name] || [];
    var cur = document.getElementById(`cur-${key}`)?.value ?? "";
    var tgt = document.getElementById(`tgt-${key}`)?.value ?? "";

    var s = lvList.indexOf(cur);
    var e = lvList.indexOf(tgt);

    var sum = { food:0, manual:0, vital:0, serum:0 };
    if (s >= 0 && e > s) {
      for (var i = s + 1; i <= e; i++) {
        var lv = lvList[i];
        var r = rows.find(x => String(x["ë ˆë²¨"]).trim() === String(lv).trim());
        if (!r) continue;
        sum.food   += toNum(r["í«ë¨¹ì´"]);
        sum.manual += toNum(r["ì¡°ë ¨ë§¤ë‰´ì–¼"]);
        sum.vital  += toNum(r["í™œë ¥ì˜ì•½"]);
        sum.serum  += toNum(r["ê°•í™”í˜ˆì²­"]);
      }
    }

    var a = document.getElementById(`sub-food-${key}`);
    var b = document.getElementById(`sub-manual-${key}`);
    var c = document.getElementById(`sub-vital-${key}`);
    var d = document.getElementById(`sub-serum-${key}`);
    if (a) a.textContent = sum.food.toLocaleString();
    if (b) b.textContent = sum.manual.toLocaleString();
    if (c) c.textContent = sum.vital.toLocaleString();
    if (d) d.textContent = sum.serum.toLocaleString();
  }

  function calculateTotals() {
    var totals = { food:0, manual:0, vital:0, serum:0 };

    pets.forEach(p => {
      var key = `pet-${petKeyByName[p.name]}`;
      var lvList = levelsByPet[p.name] || [];
      var cur = document.getElementById(`cur-${key}`)?.value ?? "";
      var tgt = document.getElementById(`tgt-${key}`)?.value ?? "";

      var s = lvList.indexOf(cur);
      var e = lvList.indexOf(tgt);
      if (s === -1 || e === -1 || s >= e) return;

      var rows = dataByRarity[p.rarityKey] || [];

      for (var i = s + 1; i <= e; i++) {
        var lv = lvList[i];
        var r = rows.find(x => String(x["ë ˆë²¨"]).trim() === String(lv).trim());
        if (!r) continue;
        totals.food   += toNum(r["í«ë¨¹ì´"]);
        totals.manual += toNum(r["ì¡°ë ¨ë§¤ë‰´ì–¼"]);
        totals.vital  += toNum(r["í™œë ¥ì˜ì•½"]);
        totals.serum  += toNum(r["ê°•í™”í˜ˆì²­"]);
      }
    });

    return totals;
  }

  function renderSummary() {
    var total = calculateTotals();

    document.getElementById("sum-í«ë¨¹ì´").textContent = total["food"].toLocaleString();
    document.getElementById("sum-ì¡°ë ¨ë§¤ë‰´ì–¼").textContent = total["manual"].toLocaleString();
    document.getElementById("sum-í™œë ¥ì˜ì•½").textContent = total["vital"].toLocaleString();
    document.getElementById("sum-ê°•í™”í˜ˆì²­").textContent = total["serum"].toLocaleString();

    var defA = document.getElementById("def-í«ë¨¹ì´");
    var defB = document.getElementById("def-ì¡°ë ¨ë§¤ë‰´ì–¼");
    var defC = document.getElementById("def-í™œë ¥ì˜ì•½");
    var defD = document.getElementById("def-ê°•í™”í˜ˆì²­");

    defA.textContent = ((parseFloat(document.getElementById("own-í«ë¨¹ì´").value||0) - total["food"])).toLocaleString();
    defB.textContent = ((parseFloat(document.getElementById("own-ì¡°ë ¨ë§¤ë‰´ì–¼").value||0) - total["manual"])).toLocaleString();
    defC.textContent = ((parseFloat(document.getElementById("own-í™œë ¥ì˜ì•½").value||0) - total["vital"])).toLocaleString();
    defD.textContent = ((parseFloat(document.getElementById("own-ê°•í™”í˜ˆì²­").value||0) - total["serum"])).toLocaleString();

    defA.classList.toggle("text-red-600", parseFloat(defA.textContent.replace(/,/g,'')) < 0);
    defB.classList.toggle("text-red-600", parseFloat(defB.textContent.replace(/,/g,'')) < 0);
    defC.classList.toggle("text-red-600", parseFloat(defC.textContent.replace(/,/g,'')) < 0);
    defD.classList.toggle("text-red-600", parseFloat(defD.textContent.replace(/,/g,'')) < 0);
  }

  // ë””ë°”ìš´ìŠ¤(ë¯¸ì‚¬ìš© ìœ ì§€)
  var calcTimer = null;
  function scheduleCalc() {
    if (calcTimer) clearTimeout(calcTimer);
    calcTimer = setTimeout(renderSummary, 120);
  }

  function bindOwnedInputs() {
    // í•„ìš”í•˜ë©´ ë³´ìœ ëŸ‰ ì…ë ¥ ì‹œ ìë™ ì—…ë°ì´íŠ¸ë¥¼ ì—¬ê¸°ì„œ ì—°ê²° ê°€ëŠ¥
  }

  // ì‹œì‘
  loadAll();

  document.getElementById("btn-calc-total")?.addEventListener("click", () => { renderSummary(); });
 };
  window.PetsInit();
})();
</script>

