<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>🐾 펫 계산기 (experts 스타일)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* ===== 다크모드 ===== */
    body.dark-mode { background:#121212; color:#f0f0f0; }
    .dark-mode .border{ border-color:#444 !important; }
    .dark-mode .bg-white{ background:#2c2c2c !important; color:#f0f0f0 !important; }
    .dark-mode .bg-gray-100{ background:#1e1e1e !important; }
    .dark-mode .text-gray-800,.dark-mode .text-gray-700,.dark-mode .text-gray-600{ color:#dddddd !important; }
    .dark-mode select,.dark-mode input{ color:#000 !important; }
    .dark-mode table{ background:#2c2c2c; color:#f0f0f0; }
    .dark-mode th,.dark-mode td{ border-color:#444 !important; }

    /* ===== experts 카드 ===== */
    .exp-card{
      border:1px solid rgba(0,0,0,.08);
      border-radius:16px;
      background:#fff;
      box-shadow:0 6px 18px rgba(15,23,42,.06);
      transition: box-shadow .2s ease;
    }
    .exp-card:hover{ box-shadow:0 10px 26px rgba(15,23,42,.12); }
    .muted{ font-size:12px; color:#6b7280; }

    body.dark-mode .exp-card{ background:#2c2c2c !important; border-color:#444 !important; }
    body.dark-mode .muted{ color:#b7b7b7 !important; }
  </style>

  <!-- 다크모드 상태 유지 -->
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
      }
    });
  </script>
</head>
<body class="bg-gray-100 p-2 font-sans text-sm">
  <div class="max-w-6xl mx-auto bg-white p-3 rounded-xl shadow-md space-y-5">
    <h1 class="text-2xl font-bold text-gray-800">🐾 펫 계산기</h1>

    <p class="text-gray-600 text-sm">
      펫(등급/이름)별로 <b>현재 → 목표</b>를 지정하면, 필요한 <b>펫먹이/조련매뉴얼/활력의약/강화혈청</b>이 자동 합산됩니다.
      카드 체크 시 하단 총합에 포함됩니다.
    </p>

    <!-- 카드 그리드 -->
    <div id="petGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>

    <!-- 보유 자원 카드 -->
    <div class="exp-card">
      <div class="p-4">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-[15px] font-semibold text-gray-800">보유 자원</h3>
          <span class="muted">입력 시 자동 반영</span>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-4 gap-4">
          <div>
            <label class="block text-[12px] text-gray-600 mb-1">보유 펫먹이</label>
            <input type="number" id="own-펫먹이" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="0" min="0" inputmode="numeric"/>
          </div>
          <div>
            <label class="block text-[12px] text-gray-600 mb-1">보유 조련매뉴얼</label>
            <input type="number" id="own-조련매뉴얼" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="0" min="0" inputmode="numeric"/>
          </div>
          <div>
            <label class="block text-[12px] text-gray-600 mb-1">보유 활력의약</label>
            <input type="number" id="own-활력의약" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="0" min="0" inputmode="numeric"/>
          </div>
          <div>
            <label class="block text-[12px] text-gray-600 mb-1">보유 강화혈청</label>
            <input type="number" id="own-강화혈청" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="0" min="0" inputmode="numeric"/>
          </div>
        </div>
      </div>
    </div>

    <!-- 하단 총합 패널 -->
    <div id="summaryPanel" class="exp-card">
      <div class="p-4">
        <div id="summaryBody"></div>
      </div>
    </div>
  </div>

  <!-- ===== 데이터 & 로직 ===== -->
  <script>
    // 등급 목록 및 CSV 맵핑
    const grades = ["기간토","매머드","호랑이","코뿔소","고릴라","동굴사자","흑표범","큰뿔사슴","티타니스","테이퍼","사향소","북극늑대","하이에나"];
    const gradeLabels = {
      "기간토":"SSR",
      "매머드":"SSR",
      "호랑이":"SSR",
      "코뿔소":"SSR",
      "고릴라":"SSR",
      "동굴사자":"SSR",
      "흑표범":"SR",
      "큰뿔사슴":"SR",
      "티타니스":"R",
      "테이퍼":"R",
      "사향소":"N",
      "북극늑대":"N",
      "하이에나":"UnKnown" // 저장소에 해당 CSV가 없으면 건너뜀
    };
    const CSV_BASE = "https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Pet/";

    // 등급별 CSV 데이터 캐시
    const petDataMap = {};  // grade -> 전체행[]
    const petNamesByGrade = {}; // grade -> 이름 목록
    const levelsByPet = {}; // `${grade}|${name}` -> 레벨 배열 (정렬 보장)

    // UI 루트
    const grid = document.getElementById("petGrid");

    // util: 안전 split 줄바꿈
    function splitLines(t){ return t.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n"); }

    async function fetchPetCSV(gradeKey) {
      const url = `${CSV_BASE}Pet_${gradeKey}.csv`;
      const res = await fetch(url);
      if (!res.ok) throw new Error("CSV not found: " + url);
      const text = await res.text();
      const lines = splitLines(text).filter(Boolean).map(row => row.split(","));
      const headers = lines[0].map(h=>h.trim());
      const rows = lines.slice(1).map(cols => {
        const obj = {};
        headers.forEach((h,i)=> obj[h] = (cols[i] ?? "").trim());
        return obj;
      });
      return rows;
    }

    async function loadAll() {
      // 등급 키(SSR/SR/R/N/UnKnown) 기준으로 한번씩만 로드
      const uniqueKeys = [...new Set(Object.values(gradeLabels))];
      for (const key of uniqueKeys) {
        try {
          const data = await fetchPetCSV(key);
          // 이 key를 쓰는 모든 등급에 데이터 공유
          grades.filter(g => gradeLabels[g] === key).forEach(g => petDataMap[g] = data);
        } catch (e) {
          // 없는 CSV는 스킵
          console.warn(key, e.message);
        }
      }

      // 등급/이름/레벨 파생 정보 세팅
      grades.forEach(g => {
        const data = petDataMap[g];
        if (!data) return;
        const names = [...new Set(data.map(d => d["이름"]))];
        petNamesByGrade[g] = names;
        names.forEach(name => {
          const lvList = data.filter(d=>d["이름"]===name).map(d=>d["레벨"]);
          // 레벨이 숫자면 숫자 정렬, 아니면 문자열 정렬
          const nums = lvList.map(v=>Number(v));
          const allNum = nums.every(n=>!Number.isNaN(n));
          levelsByPet[`${g}|${name}`] = allNum
            ? [...lvList].sort((a,b)=>Number(a)-Number(b))
            : [...lvList];
        });
      });

      renderCards();
      bindOwnedInputs();
      scheduleCalc();
    }

    function renderCards() {
      grid.innerHTML = "";
      grades.forEach(grade => {
        const data = petDataMap[grade];
        if (!data) return; // 해당 등급 CSV 없으면 스킵

        const names = petNamesByGrade[grade] || [];
        names.forEach((petName, idx) => {
          const key = `${grade}-${idx}`;
          const lvList = levelsByPet[`${grade}|${gradeLabels}`] || [];
          const options = lvList.map(lv=>`<option value="${lv}">${lv}</option>`).join("");
          const card = document.createElement("div");
          
          card.className = "exp-card";
          card.innerHTML = `
            <div class="p-4">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <div class="flex items-center gap-2 mb-2">
                    <h3 class="text-[15px] font-semibold text-gray-800">${grade} - ${gradeLabels}</h3>
                  </div>
                  <!-- 현재/목표 세로 배치 -->
                  <div class="grid grid-cols-1 gap-2">
                    <div class="flex items-center justify-between gap-2">
                      <span class="text-[12px] text-gray-600">현재</span>
                      <select id="cur-${key}" class="border rounded-lg px-2 py-1 text-sm min-w-[120px]">${options}</select>
                    </div>
                    <div class="flex items-center justify-between gap-2">
                      <span class="text-[12px] text-gray-600">목표</span>
                      <select id="tgt-${key}" class="border rounded-lg px-2 py-1 text-sm min-w-[120px]">${options}</select>
                    </div>
                  </div>
                </div>
                <div class="md:pl-4">
                  <div class="font-semibold text-gray-800 mb-2">필요 합계</div>
                  <div class="grid grid-cols-[1fr_auto] gap-x-3 text-[13px]">
                    <div class="text-gray-600">펫먹이</div><div class="text-right tabular-nums" id="sub-food-${key}">0</div>
                    <div class="text-gray-600">조련매뉴얼</div><div class="text-right tabular-nums" id="sub-manual-${key}">0</div>
                    <div class="text-gray-600">활력의약</div><div class="text-right tabular-nums" id="sub-vital-${key}">0</div>
                    <div class="text-gray-600">강화혈청</div><div class="text-right tabular-nums" id="sub-serum-${key}">0</div>
                  </div>
                </div>
              </div>
            </div>
          `;
          grid.appendChild(card);

          const curSel = card.querySelector(`#cur-${key}`);
          const tgtSel = card.querySelector(`#tgt-${key}`);

          const onChange = () => { updateCardSubtotal(grade, petName, key); scheduleCalc(); };
          curSel.addEventListener("change", () => { tgtSel.value = curSel.value; onChange(); });
          tgtSel.addEventListener("change", onChange);

          // 초기 계산
          updateCardSubtotal(grade, petName, key);
        });
      });
    }

    function updateCardSubtotal(grade, petName, key) {
      const data = petDataMap[grade] || [];
      const list = data.filter(d => d["이름"] === petName);
      const lvArr = list.map(d => d["레벨"]);
      const cur = document.getElementById(`cur-${key}`).value;
      const tgt = document.getElementById(`tgt-${key}`).value;

      const s = lvArr.indexOf(cur);
      const e = lvArr.indexOf(tgt);

      const sum = { food:0, manual:0, vital:0, serum:0 };
      if (s >= 0 && e > s) {
        for (let i = s + 1; i <= e; i++) {
          const r = list[i];
          sum.food   += parseFloat(r["펫먹이"] || "0");
          sum.manual += parseFloat(r["조련매뉴얼"] || "0");
          sum.vital  += parseFloat(r["활력의약"] || "0");
          sum.serum  += parseFloat(r["강화혈청"] || "0");
        }
      }
      document.getElementById(`sub-food-${key}`).textContent   = sum.food.toLocaleString();
      document.getElementById(`sub-manual-${key}`).textContent = sum.manual.toLocaleString();
      document.getElementById(`sub-vital-${key}`).textContent  = sum.vital.toLocaleString();
      document.getElementById(`sub-serum-${key}`).textContent  = sum.serum.toLocaleString();
    }

    function calculateTotals() {
      const totals = { food:0, manual:0, vital:0, serum:0 };

      grades.forEach(grade => {
        const names = petNamesByGrade[grade] || [];
        names.forEach((petName, idx) => {
          const key = `${grade}-${idx}`;
          
          const data = petDataMap[grade] || [];
          const list = data.filter(d => d["이름"] === petName);
          const lvArr = list.map(d => d["레벨"]);
          const cur = document.getElementById(`cur-${key}`).value;
          const tgt = document.getElementById(`tgt-${key}`).value;
          const s = lvArr.indexOf(cur);
          const e = lvArr.indexOf(tgt);
          if (s === -1 || e === -1 || s >= e) return;

          for (let i = s + 1; i <= e; i++) {
            const r = list[i];
            totals.food   += parseFloat(r["펫먹이"] || "0");
            totals.manual += parseFloat(r["조련매뉴얼"] || "0");
            totals.vital  += parseFloat(r["활력의약"] || "0");
            totals.serum  += parseFloat(r["강화혈청"] || "0");
          }
        });
      });

      return totals;
    }

    function renderSummary() {
      const t = calculateTotals();
      const owned = {
        food:   parseFloat(document.getElementById("own-펫먹이").value)||0,
        manual: parseFloat(document.getElementById("own-조련매뉴얼").value)||0,
        vital:  parseFloat(document.getElementById("own-활력의약").value)||0,
        serum:  parseFloat(document.getElementById("own-강화혈청").value)||0,
      };
      const deficit = {
        food: owned.food - t.food,
        manual: owned.manual - t.manual,
        vital: owned.vital - t.vital,
        serum: owned.serum - t.serum,
      };

      const html = `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div class="rounded-xl border border-black/10 p-3">
            <div class="font-semibold mb-2">총합</div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">펫먹이</span><span>${t.food.toLocaleString()}</span></div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">조련매뉴얼</span><span>${t.manual.toLocaleString()}</span></div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">활력의약</span><span>${t.vital.toLocaleString()}</span></div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">강화혈청</span><span>${t.serum.toLocaleString()}</span></div>
          </div>
          <div class="rounded-xl border border-black/10 p-3">
            <div class="font-semibold mb-2">보유량</div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">펫먹이</span><span>${owned.food.toLocaleString()}</span></div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">조련매뉴얼</span><span>${owned.manual.toLocaleString()}</span></div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">활력의약</span><span>${owned.vital.toLocaleString()}</span></div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">강화혈청</span><span>${owned.serum.toLocaleString()}</span></div>
          </div>
          <div class="rounded-xl border border-black/10 p-3">
            <div class="font-semibold mb-2">과부족</div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">펫먹이</span><span class="${deficit.food<0?'text-red-600':''}">${deficit.food.toLocaleString()}</span></div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">조련매뉴얼</span><span class="${deficit.manual<0?'text-red-600':''}">${deficit.manual.toLocaleString()}</span></div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">활력의약</span><span class="${deficit.vital<0?'text-red-600':''}">${deficit.vital.toLocaleString()}</span></div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">강화혈청</span><span class="${deficit.serum<0?'text-red-600':''}">${deficit.serum.toLocaleString()}</span></div>
          </div>
        </div>`;
      const el = document.getElementById("summaryBody");
      if (el) el.innerHTML = html;
    }

    // 디바운스
    let calcTimer = null;
    function scheduleCalc() {
      if (calcTimer) clearTimeout(calcTimer);
      calcTimer = setTimeout(renderSummary, 120);
    }

    function bindOwnedInputs() {
      ["own-펫먹이","own-조련매뉴얼","own-활력의약","own-강화혈청"].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.addEventListener("input", scheduleCalc);
      });
    }

    // 시작
    loadAll();

    // UX: 디버그/복사 방지(원 코드 유지)
    document.addEventListener("contextmenu", e => e.preventDefault());
    document.addEventListener("keydown", function (e) {
      if (e.key === "F12" || (e.ctrlKey && e.shiftKey && (e.key === "I" || e.key === "J")) ||
          (e.ctrlKey && (e.key === "U" || e.key === "S"))) {
        e.preventDefault();
      }
    });
  </script>
</body>
</html>
