<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ¾ í« ê³„ì‚°ê¸° (experts ìŠ¤íƒ€ì¼)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* ===== ë‹¤í¬ëª¨ë“œ ===== */
    body.dark-mode { background:#121212; color:#f0f0f0; }
    .dark-mode .border{ border-color:#444 !important; }
    .dark-mode .bg-white{ background:#2c2c2c !important; color:#f0f0f0 !important; }
    .dark-mode .bg-gray-100{ background:#1e1e1e !important; }
    .dark-mode .text-gray-800,.dark-mode .text-gray-700,.dark-mode .text-gray-600{ color:#dddddd !important; }
    .dark-mode select,.dark-mode input{ color:#000 !important; }
    .dark-mode table{ background:#2c2c2c; color:#f0f0f0; }
    .dark-mode th,.dark-mode td{ border-color:#444 !important; }

    /* ===== experts ì¹´ë“œ ===== */
    .exp-card{
      border:1px solid rgba(0,0,0,.08);
      border-radius:16px;
      background:#fff;
      box-shadow:0 6px 18px rgba(15,23,42,.06);
      transition: box-shadow .2s ease;
    }
    .exp-card:hover{ box-shadow:0 10px 26px rgba(15,23,42,.12); }
    .muted{ font-size:12px; color:#6b7280; }

    body.dark-mode .exp-card{ background:#2c2c2c !important; border-color:#444 !important; }
    body.dark-mode .muted{ color:#b7b7b7 !important; }
  </style>

  <!-- ë‹¤í¬ëª¨ë“œ ìƒíƒœ ìœ ì§€ -->
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
      }
    });
  </script>
</head>
<body class="bg-gray-100 p-2 font-sans text-sm">
  <div class="max-w-6xl mx-auto bg-white p-3 rounded-xl shadow-md space-y-5">
    <h1 class="text-2xl font-bold text-gray-800">ğŸ¾ í« ê³„ì‚°ê¸°</h1>

    <p class="text-gray-600 text-sm">
      í«(ë“±ê¸‰/ì´ë¦„)ë³„ë¡œ <b>í˜„ì¬ â†’ ëª©í‘œ</b>ë¥¼ ì§€ì •í•˜ë©´, í•„ìš”í•œ <b>í«ë¨¹ì´/ì¡°ë ¨ë§¤ë‰´ì–¼/í™œë ¥ì˜ì•½/ê°•í™”í˜ˆì²­</b>ì´ ìë™ í•©ì‚°ë©ë‹ˆë‹¤.
      ì¹´ë“œ ì²´í¬ ì‹œ í•˜ë‹¨ ì´í•©ì— í¬í•¨ë©ë‹ˆë‹¤.
    </p>

    <!-- ì¹´ë“œ ê·¸ë¦¬ë“œ -->
    <div id="petGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>

    <!-- ë³´ìœ  ìì› ì¹´ë“œ -->
    <div class="exp-card">
      <div class="p-4">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-[15px] font-semibold text-gray-800">ë³´ìœ  ìì›</h3>
          <span class="muted">ì…ë ¥ ì‹œ ìë™ ë°˜ì˜</span>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-4 gap-4">
          <div>
            <label class="block text-[12px] text-gray-600 mb-1">ë³´ìœ  í«ë¨¹ì´</label>
            <input type="number" id="own-í«ë¨¹ì´" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="0" min="0" inputmode="numeric"/>
          </div>
          <div>
            <label class="block text-[12px] text-gray-600 mb-1">ë³´ìœ  ì¡°ë ¨ë§¤ë‰´ì–¼</label>
            <input type="number" id="own-ì¡°ë ¨ë§¤ë‰´ì–¼" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="0" min="0" inputmode="numeric"/>
          </div>
          <div>
            <label class="block text-[12px] text-gray-600 mb-1">ë³´ìœ  í™œë ¥ì˜ì•½</label>
            <input type="number" id="own-í™œë ¥ì˜ì•½" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="0" min="0" inputmode="numeric"/>
          </div>
          <div>
            <label class="block text-[12px] text-gray-600 mb-1">ë³´ìœ  ê°•í™”í˜ˆì²­</label>
            <input type="number" id="own-ê°•í™”í˜ˆì²­" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="0" min="0" inputmode="numeric"/>
          </div>
        </div>
      </div>
    </div>

    <!-- í•˜ë‹¨ ì´í•© íŒ¨ë„ -->
    <div id="summaryPanel" class="exp-card">
      <div class="p-4">
        <div id="summaryBody"></div>
      </div>
    </div>
  </div>

  <!-- ===== ë°ì´í„° & ë¡œì§ ===== -->
  <script>
    // ë“±ê¸‰ ëª©ë¡ ë° CSV ë§µí•‘
    const grades = ["ê¸°ê°„í† ","ë§¤ë¨¸ë“œ","í˜¸ë‘ì´","ì½”ë¿”ì†Œ","ê³ ë¦´ë¼","ë™êµ´ì‚¬ì","í‘í‘œë²”","í°ë¿”ì‚¬ìŠ´","í‹°íƒ€ë‹ˆìŠ¤","í…Œì´í¼","ì‚¬í–¥ì†Œ","ë¶ê·¹ëŠ‘ëŒ€","í•˜ì´ì—ë‚˜"];
    const gradeLabels = {
      "ê¸°ê°„í† ":"SSR",
      "ë§¤ë¨¸ë“œ":"SSR",
      "í˜¸ë‘ì´":"SSR",
      "ì½”ë¿”ì†Œ":"SSR",
      "ê³ ë¦´ë¼":"SSR",
      "ë™êµ´ì‚¬ì":"SSR",
      "í‘í‘œë²”":"SR",
      "í°ë¿”ì‚¬ìŠ´":"SR",
      "í‹°íƒ€ë‹ˆìŠ¤":"R",
      "í…Œì´í¼":"R",
      "ì‚¬í–¥ì†Œ":"N",
      "ë¶ê·¹ëŠ‘ëŒ€":"N",
      "í•˜ì´ì—ë‚˜":"UnKnown" // ì €ì¥ì†Œì— í•´ë‹¹ CSVê°€ ì—†ìœ¼ë©´ ê±´ë„ˆëœ€
    };
    const CSV_BASE = "https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Pet/";

    // ë“±ê¸‰ë³„ CSV ë°ì´í„° ìºì‹œ
    const petDataMap = {};  // grade -> ì „ì²´í–‰[]
    const petNamesByGrade = {}; // grade -> ì´ë¦„ ëª©ë¡
    const levelsByPet = {}; // `${grade}|${name}` -> ë ˆë²¨ ë°°ì—´ (ì •ë ¬ ë³´ì¥)

    // UI ë£¨íŠ¸
    const grid = document.getElementById("petGrid");

    // util: ì•ˆì „ split ì¤„ë°”ê¿ˆ
    function splitLines(t){ return t.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n"); }

    async function fetchPetCSV(gradeKey) {
      const url = `${CSV_BASE}Pet_${gradeKey}.csv`;
      const res = await fetch(url);
      if (!res.ok) throw new Error("CSV not found: " + url);
      const text = await res.text();
      const lines = splitLines(text).filter(Boolean).map(row => row.split(","));
      const headers = lines[0].map(h=>h.trim());
      const rows = lines.slice(1).map(cols => {
        const obj = {};
        headers.forEach((h,i)=> obj[h] = (cols[i] ?? "").trim());
        return obj;
      });
      return rows;
    }

    async function loadAll() {
      // ë“±ê¸‰ í‚¤(SSR/SR/R/N/UnKnown) ê¸°ì¤€ìœ¼ë¡œ í•œë²ˆì”©ë§Œ ë¡œë“œ
      const uniqueKeys = [...new Set(Object.values(gradeLabels))];
      for (const key of uniqueKeys) {
        try {
          const data = await fetchPetCSV(key);
          // ì´ keyë¥¼ ì“°ëŠ” ëª¨ë“  ë“±ê¸‰ì— ë°ì´í„° ê³µìœ 
          grades.filter(g => gradeLabels[g] === key).forEach(g => petDataMap[g] = data);
        } catch (e) {
          // ì—†ëŠ” CSVëŠ” ìŠ¤í‚µ
          console.warn(key, e.message);
        }
      }

      // ë“±ê¸‰/ì´ë¦„/ë ˆë²¨ íŒŒìƒ ì •ë³´ ì„¸íŒ…
      grades.forEach(g => {
        const data = petDataMap[g];
        if (!data) return;
        const names = [...new Set(data.map(d => d["ì´ë¦„"]))];
        petNamesByGrade[g] = names;
        names.forEach(name => {
          const lvList = data.filter(d=>d["ì´ë¦„"]===name).map(d=>d["ë ˆë²¨"]);
          // ë ˆë²¨ì´ ìˆ«ìë©´ ìˆ«ì ì •ë ¬, ì•„ë‹ˆë©´ ë¬¸ìì—´ ì •ë ¬
          const nums = lvList.map(v=>Number(v));
          const allNum = nums.every(n=>!Number.isNaN(n));
          levelsByPet[`${g}|${name}`] = allNum
            ? [...lvList].sort((a,b)=>Number(a)-Number(b))
            : [...lvList];
        });
      });

      renderCards();
      bindOwnedInputs();
      scheduleCalc();
    }

    function renderCards() {
      grid.innerHTML = "";
      grades.forEach(grade => {
        const data = petDataMap[grade];
        if (!data) return; // í•´ë‹¹ ë“±ê¸‰ CSV ì—†ìœ¼ë©´ ìŠ¤í‚µ

        const names = petNamesByGrade[grade] || [];
        names.forEach((petName, idx) => {
          const key = `${grade}-${idx}`;
          const lvList = levelsByPet[`${grade}|${gradeLabels}`] || [];
          const options = lvList.map(lv=>`<option value="${lv}">${lv}</option>`).join("");
          const card = document.createElement("div");
          
          card.className = "exp-card";
          card.innerHTML = `
            <div class="p-4">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <div class="flex items-center gap-2 mb-2">
                    <h3 class="text-[15px] font-semibold text-gray-800">${grade} - ${gradeLabels}</h3>
                  </div>
                  <!-- í˜„ì¬/ëª©í‘œ ì„¸ë¡œ ë°°ì¹˜ -->
                  <div class="grid grid-cols-1 gap-2">
                    <div class="flex items-center justify-between gap-2">
                      <span class="text-[12px] text-gray-600">í˜„ì¬</span>
                      <select id="cur-${key}" class="border rounded-lg px-2 py-1 text-sm min-w-[120px]">${options}</select>
                    </div>
                    <div class="flex items-center justify-between gap-2">
                      <span class="text-[12px] text-gray-600">ëª©í‘œ</span>
                      <select id="tgt-${key}" class="border rounded-lg px-2 py-1 text-sm min-w-[120px]">${options}</select>
                    </div>
                  </div>
                </div>
                <div class="md:pl-4">
                  <div class="font-semibold text-gray-800 mb-2">í•„ìš” í•©ê³„</div>
                  <div class="grid grid-cols-[1fr_auto] gap-x-3 text-[13px]">
                    <div class="text-gray-600">í«ë¨¹ì´</div><div class="text-right tabular-nums" id="sub-food-${key}">0</div>
                    <div class="text-gray-600">ì¡°ë ¨ë§¤ë‰´ì–¼</div><div class="text-right tabular-nums" id="sub-manual-${key}">0</div>
                    <div class="text-gray-600">í™œë ¥ì˜ì•½</div><div class="text-right tabular-nums" id="sub-vital-${key}">0</div>
                    <div class="text-gray-600">ê°•í™”í˜ˆì²­</div><div class="text-right tabular-nums" id="sub-serum-${key}">0</div>
                  </div>
                </div>
              </div>
            </div>
          `;
          grid.appendChild(card);

          const curSel = card.querySelector(`#cur-${key}`);
          const tgtSel = card.querySelector(`#tgt-${key}`);

          const onChange = () => { updateCardSubtotal(grade, petName, key); scheduleCalc(); };
          curSel.addEventListener("change", () => { tgtSel.value = curSel.value; onChange(); });
          tgtSel.addEventListener("change", onChange);

          // ì´ˆê¸° ê³„ì‚°
          updateCardSubtotal(grade, petName, key);
        });
      });
    }

    function updateCardSubtotal(grade, petName, key) {
      const data = petDataMap[grade] || [];
      const list = data.filter(d => d["ì´ë¦„"] === petName);
      const lvArr = list.map(d => d["ë ˆë²¨"]);
      const cur = document.getElementById(`cur-${key}`).value;
      const tgt = document.getElementById(`tgt-${key}`).value;

      const s = lvArr.indexOf(cur);
      const e = lvArr.indexOf(tgt);

      const sum = { food:0, manual:0, vital:0, serum:0 };
      if (s >= 0 && e > s) {
        for (let i = s + 1; i <= e; i++) {
          const r = list[i];
          sum.food   += parseFloat(r["í«ë¨¹ì´"] || "0");
          sum.manual += parseFloat(r["ì¡°ë ¨ë§¤ë‰´ì–¼"] || "0");
          sum.vital  += parseFloat(r["í™œë ¥ì˜ì•½"] || "0");
          sum.serum  += parseFloat(r["ê°•í™”í˜ˆì²­"] || "0");
        }
      }
      document.getElementById(`sub-food-${key}`).textContent   = sum.food.toLocaleString();
      document.getElementById(`sub-manual-${key}`).textContent = sum.manual.toLocaleString();
      document.getElementById(`sub-vital-${key}`).textContent  = sum.vital.toLocaleString();
      document.getElementById(`sub-serum-${key}`).textContent  = sum.serum.toLocaleString();
    }

    function calculateTotals() {
      const totals = { food:0, manual:0, vital:0, serum:0 };

      grades.forEach(grade => {
        const names = petNamesByGrade[grade] || [];
        names.forEach((petName, idx) => {
          const key = `${grade}-${idx}`;
          
          const data = petDataMap[grade] || [];
          const list = data.filter(d => d["ì´ë¦„"] === petName);
          const lvArr = list.map(d => d["ë ˆë²¨"]);
          const cur = document.getElementById(`cur-${key}`).value;
          const tgt = document.getElementById(`tgt-${key}`).value;
          const s = lvArr.indexOf(cur);
          const e = lvArr.indexOf(tgt);
          if (s === -1 || e === -1 || s >= e) return;

          for (let i = s + 1; i <= e; i++) {
            const r = list[i];
            totals.food   += parseFloat(r["í«ë¨¹ì´"] || "0");
            totals.manual += parseFloat(r["ì¡°ë ¨ë§¤ë‰´ì–¼"] || "0");
            totals.vital  += parseFloat(r["í™œë ¥ì˜ì•½"] || "0");
            totals.serum  += parseFloat(r["ê°•í™”í˜ˆì²­"] || "0");
          }
        });
      });

      return totals;
    }

    function renderSummary() {
      const t = calculateTotals();
      const owned = {
        food:   parseFloat(document.getElementById("own-í«ë¨¹ì´").value)||0,
        manual: parseFloat(document.getElementById("own-ì¡°ë ¨ë§¤ë‰´ì–¼").value)||0,
        vital:  parseFloat(document.getElementById("own-í™œë ¥ì˜ì•½").value)||0,
        serum:  parseFloat(document.getElementById("own-ê°•í™”í˜ˆì²­").value)||0,
      };
      const deficit = {
        food: owned.food - t.food,
        manual: owned.manual - t.manual,
        vital: owned.vital - t.vital,
        serum: owned.serum - t.serum,
      };

      const html = `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div class="rounded-xl border border-black/10 p-3">
            <div class="font-semibold mb-2">ì´í•©</div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">í«ë¨¹ì´</span><span>${t.food.toLocaleString()}</span></div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">ì¡°ë ¨ë§¤ë‰´ì–¼</span><span>${t.manual.toLocaleString()}</span></div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">í™œë ¥ì˜ì•½</span><span>${t.vital.toLocaleString()}</span></div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">ê°•í™”í˜ˆì²­</span><span>${t.serum.toLocaleString()}</span></div>
          </div>
          <div class="rounded-xl border border-black/10 p-3">
            <div class="font-semibold mb-2">ë³´ìœ ëŸ‰</div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">í«ë¨¹ì´</span><span>${owned.food.toLocaleString()}</span></div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">ì¡°ë ¨ë§¤ë‰´ì–¼</span><span>${owned.manual.toLocaleString()}</span></div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">í™œë ¥ì˜ì•½</span><span>${owned.vital.toLocaleString()}</span></div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">ê°•í™”í˜ˆì²­</span><span>${owned.serum.toLocaleString()}</span></div>
          </div>
          <div class="rounded-xl border border-black/10 p-3">
            <div class="font-semibold mb-2">ê³¼ë¶€ì¡±</div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">í«ë¨¹ì´</span><span class="${deficit.food<0?'text-red-600':''}">${deficit.food.toLocaleString()}</span></div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">ì¡°ë ¨ë§¤ë‰´ì–¼</span><span class="${deficit.manual<0?'text-red-600':''}">${deficit.manual.toLocaleString()}</span></div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">í™œë ¥ì˜ì•½</span><span class="${deficit.vital<0?'text-red-600':''}">${deficit.vital.toLocaleString()}</span></div>
            <div class="flex justify-between text-[13px]"><span class="text-gray-600">ê°•í™”í˜ˆì²­</span><span class="${deficit.serum<0?'text-red-600':''}">${deficit.serum.toLocaleString()}</span></div>
          </div>
        </div>`;
      const el = document.getElementById("summaryBody");
      if (el) el.innerHTML = html;
    }

    // ë””ë°”ìš´ìŠ¤
    let calcTimer = null;
    function scheduleCalc() {
      if (calcTimer) clearTimeout(calcTimer);
      calcTimer = setTimeout(renderSummary, 120);
    }

    function bindOwnedInputs() {
      ["own-í«ë¨¹ì´","own-ì¡°ë ¨ë§¤ë‰´ì–¼","own-í™œë ¥ì˜ì•½","own-ê°•í™”í˜ˆì²­"].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.addEventListener("input", scheduleCalc);
      });
    }

    // ì‹œì‘
    loadAll();

    // UX: ë””ë²„ê·¸/ë³µì‚¬ ë°©ì§€(ì› ì½”ë“œ ìœ ì§€)
    document.addEventListener("contextmenu", e => e.preventDefault());
    document.addEventListener("keydown", function (e) {
      if (e.key === "F12" || (e.ctrlKey && e.shiftKey && (e.key === "I" || e.key === "J")) ||
          (e.ctrlKey && (e.key === "U" || e.key === "S"))) {
        e.preventDefault();
      }
    });
  </script>
</body>
</html>
