<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ§ª ì—°êµ¬ ê³„ì‚°ê¸°</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* âœ… ë‹¤í¬ëª¨ë“œ */
    body.dark-mode { background-color:#121212; color:#f0f0f0; }
    .dark-mode .border{ border-color:#444 !important; }
    .dark-mode .bg-white{ background-color:#2c2c2c !important; color:#f0f0f0 !important; }
    .dark-mode .bg-gray-100{ background-color:#1e1e1e !important; }
    .dark-mode .text-gray-800,.dark-mode .text-gray-700,.dark-mode .text-gray-600{ color:#eaeaea !important; }
    .dark-mode .text-blue-700{ color:#66b0ff !important; }
    .dark-mode .text-green-700{ color:#79e68c !important; }
    .dark-mode .text-purple-700{ color:#bfa6ff !important; }
    .dark-mode table{ background-color:#2c2c2c; color:#f0f0f0; }
    .dark-mode th,.dark-mode td{ border-color:#444 !important; }
    .dark-mode thead th{ color:#f0f0f0 !important; }
    .dark-mode .bg-blue-100,.dark-mode .bg-gray-50,.dark-mode .bg-gray-100{ background-color:#242424 !important; }
    .dark-mode input,.dark-mode select{ background:#1e1e1e; color:#f0f0f0; border-color:#444; }
    .dark-mode select option{ background:#1e1e1e; color:#f0f0f0; }

    /* í† ê¸€ ë²„íŠ¼ */
    .toggle-btn{ transition:.12s ease; user-select:none; }
    .toggle-btn:active{ transform:scale(.98); }
    .toggle-btn{
      background: transparent;
      border-color: rgba(148,163,184,.65);
      color: inherit;
    }
    .toggle-btn.is-on{
      background: #2563eb;   /* blue-600 */
      border-color: #1d4ed8; /* blue-700 */
      color: #fff;
    }
    body.dark-mode .toggle-btn{ border-color:#444; }

    /* ì˜µì…˜ ìš”ì•½ ì¹© */
    .chip{
      display:inline-flex;
      align-items:center;
      gap:.35rem;
      padding:.3rem .55rem;
      border-radius:9999px;
      border:1px solid rgba(0,0,0,.1);
      font-size:12px;
      line-height:1;
      white-space:nowrap;
    }
    body.dark-mode .chip{ border-color:#444 !important; }

    /* âœ… ê²°ê³¼ ì¹´ë“œ(ëª¨ë°”ì¼) */
    .res-card{ border-radius:16px; }
    .res-sep{ border-top:1px dashed rgba(148,163,184,.5); }
    body.dark-mode .res-sep{ border-top-color: rgba(255,255,255,.18); }
    .tabnums{ font-variant-numeric: tabular-nums; }

  </style>

  <script>
    // âœ… ë‹¤í¬ëª¨ë“œ ìœ ì§€(ë¡œì»¬ìŠ¤í† ë¦¬ì§€) + ë¶€ëª¨í”„ë ˆì„ ë©”ì‹œì§€ ì§€ì›
    window.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
      }
    });
    window.addEventListener('message', (e) => {
      if (e.data?.type === 'DARK_MODE') {
        document.body.classList.toggle('dark-mode', !!e.data.value);
        localStorage.setItem('darkMode', !!e.data.value ? 'true' : 'false');
      }
    });
  </script>
</head>

<body class="bg-gray-100 p-2 font-sans text-sm">

  <!-- âœ… ì˜µì…˜ ê°’ ì €ì¥ì†Œ (ì¤‘ë³µ ìƒì„± ê¸ˆì§€: ë”± 1ë²ˆë§Œ) -->
  <input type="checkbox" id="chkVP10" hidden>
  <input type="checkbox" id="chkVP15" hidden>
  <input type="checkbox" id="chkServerBuff" hidden>
  <input type="number" id="speedPercent" hidden value="0" min="0">
  <select id="chkExpertV" hidden>
    <option>None</option>
    <option>Lv.1</option><option>Lv.2</option><option>Lv.3</option><option>Lv.4</option><option>Lv.5</option>
    <option>Lv.6</option><option>Lv.7</option><option>Lv.8</option><option>Lv.9</option><option>Lv.10</option>
  </select>

  <div class="w-full mx-auto bg-white p-3 rounded-xl shadow-md">
    <h1 class="text-xl md:text-2xl font-bold text-gray-800">ğŸ§ª ì—°êµ¬ ê³„ì‚°ê¸°</h1>

    <div class="mb-3">
      <div class="flex items-center justify-between gap-2">
        <button onclick="goBack()"
                class="text-sm font-semibold text-gray-600 hover:text-blue-600 flex items-center gap-1">
          â† ë’¤ë¡œê°€ê¸°
        </button>
        <button id="btn-open-options"
                type="button"
                class="px-3 py-2 rounded-xl border font-semibold text-sm hover:border-slate-400">
          âš™ ì˜µì…˜
        </button>
      </div>
    </div>

    <!-- âœ… ì˜µì…˜ ìš”ì•½(ë©”ì¸) -->
    <div id="optionChips" class="mt-2 mb-2 flex flex-wrap gap-2">
      <!-- JSë¡œ ì±„ì›€ -->
    </div>

    <!-- ì „íˆ¬/ê²½ì œ/ë°œì „ ì¹´ë“œ 3ê°œ (ì²´í¬ ONì¼ë•Œë§Œ ì»¨íŠ¸ë¡¤ í‘œì‹œ) -->
    <div class="grid md:grid-cols-3 gap-3">

      <!-- ì „íˆ¬ -->
      <div class="bg-white border rounded-xl shadow-sm p-3">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-base font-bold text-blue-700">[ì „íˆ¬]</h2>
          <label class="flex items-center gap-2 cursor-pointer select-none font-semibold">
            <input id="chkBattle" type="checkbox" class="w-4 h-4"> ì‚¬ìš©
          </label>
        </div>

        <div id="battleControls" class="hidden">
          <div class="grid grid-cols-[64px_1fr] gap-x-3 gap-y-2">
            <div class="text-[15px] text-gray-600 font-semibold self-center">ì—°êµ¬í•­ëª©</div>
            <select class="border rounded p-2 text-sm w-full" id="researchType"></select>

            <div class="text-[15px] text-gray-600 font-semibold self-center">í˜„ì¬</div>
            <select class="border rounded p-2 text-sm w-full" id="currentLevel"></select>

            <div class="text-[15px] text-gray-600 font-semibold self-center">ëª©í‘œ</div>
            <select class="border rounded p-2 text-sm w-full" id="targetLevel"></select>
          </div>

          <button type="button"
            class="w-full add-btn mt-3 bg-gray-200 text-sm px-3 py-2 rounded hover:bg-blue-300 text-black"
            data-section="battle">ì¶”ê°€</button>
        </div>

        <div id="battleHint" class="text-xs text-gray-500">ì²´í¬í•˜ë©´ ì—°êµ¬ ì„ íƒì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
      </div>

      <!-- ê²½ì œ -->
      <div class="bg-white border rounded-xl shadow-sm p-3">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-base font-bold text-green-700">[ê²½ì œ]</h2>
          <label class="flex items-center gap-2 cursor-pointer select-none font-semibold">
            <input id="chkEconomy" type="checkbox" class="w-4 h-4"> ì‚¬ìš©
          </label>
        </div>

        <div id="economyControls" class="hidden">
          <div class="grid grid-cols-[64px_1fr] gap-x-3 gap-y-2">
            <div class="text-[15px] text-gray-600 font-semibold self-center">ì—°êµ¬í•­ëª©</div>
            <select class="border rounded p-2 text-sm w-full" id="economyType"></select>

            <div class="text-[15px] text-gray-600 font-semibold self-center">í˜„ì¬</div>
            <select class="border rounded p-2 text-sm w-full" id="economyCurrent"></select>

            <div class="text-[15px] text-gray-600 font-semibold self-center">ëª©í‘œ</div>
            <select class="border rounded p-2 text-sm w-full" id="economyTarget"></select>
          </div>

          <button type="button"
            class="w-full add-btn mt-3 bg-gray-200 text-sm px-3 py-2 rounded hover:bg-blue-300 text-black"
            data-section="economy">ì¶”ê°€</button>
        </div>

        <div id="economyHint" class="text-xs text-gray-500">ì²´í¬í•˜ë©´ ì—°êµ¬ ì„ íƒì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
      </div>

      <!-- ë°œì „ -->
      <div class="bg-white border rounded-xl shadow-sm p-3">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-base font-bold text-purple-700">[ë°œì „]</h2>
          <label class="flex items-center gap-2 cursor-pointer select-none font-semibold">
            <input id="chkGrowth" type="checkbox" class="w-4 h-4"> ì‚¬ìš©
          </label>
        </div>

        <div id="growthControls" class="hidden">
          <div class="grid grid-cols-[64px_1fr] gap-x-3 gap-y-2">
            <div class="text-[15px] text-gray-600 font-semibold self-center">ì—°êµ¬í•­ëª©</div>
            <select class="border rounded p-2 text-sm w-full" id="growthType"></select>

            <div class="text-[15px] text-gray-600 font-semibold self-center">í˜„ì¬</div>
            <select class="border rounded p-2 text-sm w-full" id="growthCurrent"></select>

            <div class="text-[15px] text-gray-600 font-semibold self-center">ëª©í‘œ</div>
            <select class="border rounded p-2 text-sm w-full" id="growthTarget"></select>
          </div>

          <button type="button"
            class="w-full add-btn mt-3 bg-gray-200 text-sm px-3 py-2 rounded hover:bg-blue-300 text-black"
            data-section="growth">ì¶”ê°€</button>
        </div>

        <div id="growthHint" class="text-xs text-gray-500">ì²´í¬í•˜ë©´ ì—°êµ¬ ì„ íƒì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
      </div>

    </div>

    <!-- ì¢Œ: ì„ íƒëª©ë¡ / ìš°: ê²°ê³¼ -->
    <div class="grid md:grid-cols-2 gap-3 mt-3">
      <div class="bg-white border rounded-xl shadow-sm p-3" id="addedList">
        <div class="flex justify-between items-center mb-2">
          <h2 class="text-base font-bold text-gray-700">ğŸ“‹ ì„ íƒëœ ì—°êµ¬ ëª©ë¡</h2>
          <div class="flex gap-x-3">
            <button id="calculateFromList" class="text-blue-500 text-sm hover:underline">ğŸ“Š ê³„ì‚°í•˜ê¸°</button>
            <button id="clearList" class="text-sm text-red-600 hover:underline">ğŸ§¹ ëª©ë¡ ì´ˆê¸°í™”</button>
          </div>
        </div>
        <div class="space-y-1 text-sm" id="listContainer"></div>
      </div>

      <div class="bg-white border rounded-xl shadow-sm p-3" id="resultCard">
        <div class="flex items-center justify-between">
          <h2 class="text-base font-bold text-gray-700">ğŸ“ˆ ê³„ì‚° ê²°ê³¼</h2>
        </div>
        <div id="resultContainer" class="mt-2 overflow-auto">
          <div class="text-sm text-gray-600">í•­ëª©ì„ ì¶”ê°€í•˜ê³  <span class="font-semibold">[ğŸ“Š ê³„ì‚°í•˜ê¸°]</span>ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- =========================
       âœ… ì˜µì…˜ íŒì—…
       ========================= -->
  <div id="opt-modal-backdrop" class="fixed hidden inset-0 z-[2000]">
    <div id="opt-backdrop-dim" class="absolute inset-0 bg-black/50"></div>

    <div class="absolute inset-0 flex items-end sm:items-center justify-center p-2">
      <div class="w-full sm:max-w-lg rounded-2xl bg-white shadow-xl overflow-hidden dark:bg-[#1f1f1f]">
        <div class="px-4 py-3 border-b border-black/10 flex items-center justify-between dark:border-white/10">
          <div class="text-[15px] font-semibold">âš™ ì˜µì…˜ ì„¤ì •</div>
          <div class="flex items-center gap-2">
            <button id="btn-reset-options" class="px-2 py-1 rounded-lg border text-sm">ì´ˆê¸°í™”</button>
          </div>
        </div>

        <div class="p-4 space-y-4">
          <!-- VP -->
          <div>
            <div class="text-sm font-medium mb-2">ë¶€ì§‘í–‰ê´€ ê´€ì§ ë²„í”„</div>
            <div class="flex flex-wrap gap-2">
              <button type="button"
                      class="w-[110px] px-3 py-2 rounded-xl border font-semibold text-sm toggle-btn"
                      data-toggle="chkVP10" data-group="vp">
                10%
              </button>
              <button type="button"
                      class="w-[110px] px-3 py-2 rounded-xl border font-semibold text-sm toggle-btn"
                      data-toggle="chkVP15" data-group="vp">
                15%
              </button>
            </div>
          </div>

          <!-- ì„œë²„ë²„í”„ -->
          <div>
            <div class="text-sm font-medium mb-2">ì„œë²„ë²„í”„ (10%)</div>
            <div class="flex flex-wrap gap-2">
              <button type="button"
                      class="w-full px-3 py-3 rounded-xl border font-semibold text-sm toggle-btn"
                      data-toggle="chkServerBuff" data-group="server">
                í™œì„±í™”
              </button>
            </div>
          </div>

          <!-- ì—°êµ¬ì†ë„ -->
          <div>
            <label class="block text-sm font-medium mb-2">ì—°êµ¬ì†ë„ (%)</label>
            <input type="number" id="uiSpeedPercent"
                   class="border rounded-xl px-3 py-3 text-sm w-full text-right"
                   placeholder="0" min="0" />
            <div class="mt-1 text-[12px] text-gray-500">ì‹œê°„ ê³„ì‚°ì—ë§Œ ì ìš©</div>
          </div>
        </div>

        <div class="px-4 py-3 border-t border-black/10 flex gap-2 dark:border-white/10">
          <button id="btn-cancel-options"
                  class="w-1/2 px-4 py-3 rounded-xl border font-semibold">
            ì·¨ì†Œ
          </button>
          <button id="btn-apply-options"
                  class="w-1/2 px-4 py-3 rounded-xl bg-blue-600 text-white font-semibold hover:bg-blue-700">
            ì ìš©
          </button>
        </div>
      </div>
    </div>
  </div>
<script>
    /* =========================
       âœ… iFrame ë†’ì´ ë™ê¸°í™” (1ê°œë§Œ!)
       ========================= */
    let __lastSentH = 0;
    function sendHeightToParent() {
      const height = Math.ceil(document.documentElement.scrollHeight || document.body.scrollHeight || 0) + 16;
      if (!height) return;
      if (Math.abs(height - __lastSentH) < 2) return; // ë£¨í”„ ì°¨ë‹¨
      __lastSentH = height;
      window.parent.postMessage({ type: "FRAME_CHANGE", height }, "*");
    }
    window.addEventListener("load", () => setTimeout(sendHeightToParent, 120));

    /* =========================
       âœ… í† ê¸€ ë²„íŠ¼ ë¡œì§ (hidden checkbox ì—°ë™)  [ê¸°ì–µ1 ë°©ì‹ ë°˜ì˜]
       ========================= */
    function setBtn(btn,on){
      btn.classList.toggle('is-on', !!on);
      btn.setAttribute('aria-pressed', on ? 'true' : 'false');
    }
    function syncGroup(group){
      document.querySelectorAll(`.toggle-btn[data-group="${group}"]`).forEach(b=>{
        const c = document.getElementById(b.dataset.toggle);
        if (c) setBtn(b, c.checked);
      });
    }

    function bindToggleButtons(){
      document.querySelectorAll('.toggle-btn').forEach(btn=>{
        const chk = document.getElementById(btn.dataset.toggle);
        if (chk) setBtn(btn, chk.checked);

        btn.addEventListener('click', () => {
          const group = btn.dataset.group || '';
          if (!chk) return;

          // âœ… vp: íƒ1(ë¼ë””ì˜¤ì²˜ëŸ¼) + ì¬í´ë¦­ í•´ì œ ê°€ëŠ¥
          if (group === 'vp') {
            const wasOn = chk.checked;

            document.querySelectorAll('.toggle-btn[data-group="vp"]').forEach(b=>{
              const c = document.getElementById(b.dataset.toggle);
              if (c) c.checked = false;
              setBtn(b, false);
            });

            chk.checked = !wasOn;
            setBtn(btn, chk.checked);

            renderOptionChips();
            return;
          }

          // âœ… server: ë‹¨ì¼ í† ê¸€(ì¬í´ë¦­ í•´ì œ)
          if (group === 'server') {
            chk.checked = !chk.checked;
            setBtn(btn, chk.checked);
            renderOptionChips();
            return;
          }

          // ê¸°íƒ€
          chk.checked = !chk.checked;
          setBtn(btn, chk.checked);
          renderOptionChips();
        });
      });

      syncGroup('vp');
      syncGroup('server');
    }

    /* =========================
       âœ… ì„¹ì…˜ ì²´í¬ í† ê¸€
       ========================= */
    function bindSectionToggle(chkId, panelId, hintId){
      const chk = document.getElementById(chkId);
      const panel = document.getElementById(panelId);
      const hint = document.getElementById(hintId);
      function apply(){
        const on = chk.checked;
        panel.classList.toggle('hidden', !on);
        if (hint) hint.classList.toggle('hidden', on);
        sendHeightToParent();
      }
      chk.addEventListener('change', apply);
      apply();
    }

    /* =========================
       âœ… ê³µí†µ ìœ í‹¸
       ========================= */
    function cleanInt(str) {
      return parseInt((str || "0").replace(/,/g, ""), 10) || 0;
    }
    function formatResource(value) {
      if (value >= 1_000_000_000) return (value/1_000_000_000).toFixed(2).replace(/\.00$/,'')+'B';
      if (value >= 1_000_000)     return (value/1_000_000).toFixed(2).replace(/\.00$/,'')+'M';
      if (value >= 1_000)         return value.toLocaleString();
      return value.toString();
    }
    function parseTimeToSeconds(timeStr) {
      if (!timeStr) return 0;
      const parts = timeStr.trim().split(" ");
      let d = 0, hms = "00:00:00";
      if (parts.length === 2) { d = parseInt(parts[0],10)||0; hms = parts[1]; }
      else if (parts.length === 1) { hms = parts[0]; }
      const [h, m, s] = (hms || "00:00:00").split(":").map(n=>parseInt(n,10)||0);
      return d*86400 + h*3600 + m*60 + s;
    }
    function formatTime(sec) {
      sec = Math.max(0, Math.round(sec));
      const d = Math.floor(sec/86400); sec%=86400;
      const h = Math.floor(sec/3600);  sec%=3600;
      const m = Math.floor(sec/60);
      const s = sec%60;
      return `${d}d ${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }

    /* =========================
       âœ… ì˜µì…˜ ì¹©(ìš”ì•½)  [ê¸°ì–µ1 ë°©ì‹: ê¸°ë³¸ê°’ë„ í•­ìƒ í‘œì‹œ]
       ========================= */
    function renderOptionChips(){
      const wrap = document.getElementById("optionChips");
      if (!wrap) return;

      const vp10 = document.getElementById("chkVP10")?.checked;
      const vp15 = document.getElementById("chkVP15")?.checked;
      const server = document.getElementById("chkServerBuff")?.checked;
      const speed = (parseFloat(document.getElementById("speedPercent")?.value) || 0);
      const val = document.getElementById("chkExpertV")?.value || "None";

      const vpText = vp15 ? "15%" : vp10 ? "10%" : "ì—†ìŒ";
      const serverText = server ? "ON" : "OFF";

      const chips = [];
      chips.push(`<span class="chip"><b>VP</b> ${vpText}</span>`);
      chips.push(`<span class="chip"><b>ë°œë ˆë¦¬ì•„</b> ${val || "None"}</span>`);
      chips.push(`<span class="chip"><b>ì„œë²„</b> ${serverText}</span>`);
      chips.push(`<span class="chip"><b>ì†ë„</b> ${Math.max(0, speed)}%</span>`);

      wrap.innerHTML = chips.join("");
    }

    /* =========================
       âœ… ì˜µì…˜ íŒì—… ë™ì‘  [ê¸°ì–µ1 ë°©ì‹ ë°˜ì˜: ìŠ¤ëƒ…ìƒ·/ì·¨ì†Œë³µì›/ì´ˆê¸°í™”]
       ========================= */
    let optSnapshot = null;

    function snapshotOptions(){
      return {
        vp10: document.getElementById('chkVP10').checked,
        vp15: document.getElementById('chkVP15').checked,
        server: document.getElementById('chkServerBuff').checked,
        speed: (document.getElementById('speedPercent').value || '0'),
        expert: (document.getElementById('chkExpertV').value || 'None'),
      };
    }

    function restoreSnapshot(snap){
      if (!snap) return;
      document.getElementById('chkVP10').checked = !!snap.vp10;
      document.getElementById('chkVP15').checked = !!snap.vp15;
      document.getElementById('chkServerBuff').checked = !!snap.server;
      document.getElementById('speedPercent').value = Math.max(0, parseFloat(snap.speed || '0') || 0);
      document.getElementById('chkExpertV').value = snap.expert || 'None';
      syncGroup('vp'); syncGroup('server');
      renderOptionChips();
    }

    function resetOptionsStorage(){
      document.getElementById('chkVP10').checked = false;
      document.getElementById('chkVP15').checked = false;
      document.getElementById('chkServerBuff').checked = false;
      document.getElementById('speedPercent').value = 0;
      document.getElementById('chkExpertV').value = 'None';
      syncGroup('vp'); syncGroup('server');
      renderOptionChips();
    }

    function openOptions(){
      optSnapshot = snapshotOptions();

      // UIì— ë°˜ì˜ (ì†ë„/ë°œë ˆë¦¬ì•„ëŠ” ì ìš© ë²„íŠ¼ ë°©ì‹)
      document.getElementById('uiSpeedPercent').value = optSnapshot.speed;

      // ë²„íŠ¼ í† ê¸€ì€ ì €ì¥ì†Œ ê¸°ì¤€ìœ¼ë¡œ ì¦‰ì‹œ ë™ê¸°í™”
      syncGroup('vp'); syncGroup('server');

      document.getElementById('opt-modal-backdrop').classList.remove('hidden');
      sendHeightToParent();
    }

    function closeOptionsOnly(){
      document.getElementById('opt-modal-backdrop').classList.add('hidden');
      sendHeightToParent();
    }

    function cancelOptions(){
      restoreSnapshot(optSnapshot);
      closeOptionsOnly();
    }

    function applyOptions(){
      // ì†ë„/ë°œë ˆë¦¬ì•„ëŠ” UI -> ì €ì¥ì†Œë¡œ ë°˜ì˜
      const sp = Math.max(0, parseFloat(document.getElementById('uiSpeedPercent').value || '0') || 0);
      document.getElementById('speedPercent').value = sp;

      renderOptionChips();
      closeOptionsOnly();
    }

    /* =========================
       âœ… CSV ë¡œë“œ/ë°”ì¸ë”©
       ========================= */
    function setupAutoTargetLevel(currentId, targetId) {
      document.getElementById(currentId).addEventListener("change", () => {
        const currentVal = parseInt(document.getElementById(currentId).value, 10);
        const targetSelect = document.getElementById(targetId);
        const options = Array.from(targetSelect.options).map(opt => parseInt(opt.value, 10));
        const nextVal = options.find(val => val > currentVal);
        if (nextVal !== undefined) targetSelect.value = nextVal;
      });
    }

    function fetchResearchCSV(url, typeId, currentId, targetId) {
      const map = new Map();
      const selectType = document.getElementById(typeId);
      const selectCurrent = document.getElementById(currentId);
      const selectTarget = document.getElementById(targetId);

      fetch(url)
        .then(res => res.text())
        .then(text => {
          const lines = text.split("\n").map(l => l.trim()).filter(Boolean);
          const nameIdx = lines[0].split(",").indexOf("ì—°êµ¬");
          for (let i = 1; i < lines.length; i++) {
            const cols = lines[i].split(",");
            const fullName = cols[nameIdx];
            if (!fullName || !fullName.includes("-")) continue;
            const [type, levelStr] = fullName.split("-");
            const level = parseInt(levelStr, 10);
            if (!map.has(type)) map.set(type, []);
            const levels = map.get(type);
            if (!levels.includes(level)) levels.push(level);
          }

          selectType.innerHTML = "";
          Array.from(map.keys()).forEach(type => selectType.appendChild(new Option(type, type)));

          function fillLevels() {
            const levels = (map.get(selectType.value) || []).sort((a,b)=>a-b);
            selectCurrent.innerHTML = "";
            selectTarget.innerHTML = "";
            levels.forEach(lv => {
              selectCurrent.appendChild(new Option(lv, lv));
              selectTarget.appendChild(new Option(lv, lv));
            });
          }
          selectType.addEventListener("change", fillLevels);
          selectType.dispatchEvent(new Event("change"));
          sendHeightToParent();
        });
    }

    /* =========================
       âœ… ëª©ë¡/ì¤‘ë³µë°©ì§€/ì‚­ì œ/ì´ˆê¸°í™”/ê³„ì‚°
       ========================= */
    function getSectionMeta(section){
      if (section === "battle") return { label:"ì „íˆ¬", typeId:"researchType", curId:"currentLevel", tgtId:"targetLevel", file:"Battle.csv" };
      if (section === "economy") return { label:"ê²½ì œ", typeId:"economyType", curId:"economyCurrent", tgtId:"economyTarget", file:"Economy.csv" };
      if (section === "growth") return { label:"ë°œì „", typeId:"growthType", curId:"growthCurrent", tgtId:"growthTarget", file:"Growth.csv" };
      return null;
    }

    function makeItemKey(label, type, cur, tgt){
      return `[${label}]${type}:${cur}->${tgt}`;
    }

    document.addEventListener("DOMContentLoaded", () => {
      // ì„¹ì…˜ í† ê¸€
      bindSectionToggle('chkBattle', 'battleControls', 'battleHint');
      bindSectionToggle('chkEconomy', 'economyControls', 'economyHint');
      bindSectionToggle('chkGrowth', 'growthControls', 'growthHint');

      // í† ê¸€ ë²„íŠ¼ ë°”ì¸ë”©(ì˜µì…˜ íŒì—…)
      bindToggleButtons();

      // ì˜µì…˜ ì¹© ê¸°ë³¸ í‘œì‹œ
      renderOptionChips();

      // ì˜µì…˜ íŒì—… ë²„íŠ¼
      document.getElementById('btn-open-options').addEventListener('click', openOptions);
      document.getElementById('btn-cancel-options').addEventListener('click', cancelOptions);
      document.getElementById('btn-apply-options').addEventListener('click', applyOptions);
      document.getElementById('opt-backdrop-dim').addEventListener('click', cancelOptions);

      // ì´ˆê¸°í™”(íŒì—…)
      document.getElementById('btn-reset-options').addEventListener('click', () => {
        resetOptionsStorage();
        // íŒì—… UIë„ ì¦‰ì‹œ ë°˜ì˜
        document.getElementById('uiSpeedPercent').value = 0;
        syncGroup('vp'); syncGroup('server');
      });

      // CSV ë¡œë“œ
      fetchResearchCSV(
        "https://raw.githubusercontent.com/s574shinchan/WOS_Calc/refs/heads/main/data/research/Battle.csv",
        "researchType","currentLevel","targetLevel"
      );
      setupAutoTargetLevel("currentLevel","targetLevel");

      fetchResearchCSV(
        "https://raw.githubusercontent.com/s574shinchan/WOS_Calc/refs/heads/main/data/research/Economy.csv",
        "economyType","economyCurrent","economyTarget"
      );
      setupAutoTargetLevel("economyCurrent","economyTarget");

      fetchResearchCSV(
        "https://raw.githubusercontent.com/s574shinchan/WOS_Calc/refs/heads/main/data/research/Growth.csv",
        "growthType","growthCurrent","growthTarget"
      );
      setupAutoTargetLevel("growthCurrent","growthTarget");

      // í•­ëª© ì¶”ê°€
      document.querySelectorAll(".add-btn").forEach(button => {
        button.addEventListener("click", () => {
          const section = button.dataset.section;
          const meta = getSectionMeta(section);
          if (!meta) return;

          const type = document.getElementById(meta.typeId).value;
          const current = document.getElementById(meta.curId).value;
          const target = document.getElementById(meta.tgtId).value;

          if (!type || !current || !target || parseInt(current,10) >= parseInt(target,10)) {
            alert("ìœ íš¨í•œ ì—°êµ¬ í•­ëª©ê³¼ ë ˆë²¨ì„ ì„ íƒí•˜ì„¸ìš”. (í˜„ì¬ < ëª©í‘œ)");
            return;
          }

          const key = makeItemKey(meta.label, type, current, target);

          // âœ… ì¤‘ë³µ ë°©ì§€(í‚¤ ê¸°ì¤€)
          const exists = Array.from(document.querySelectorAll("#listContainer div[data-key]"))
            .some(el => el.getAttribute("data-key") === key);
          if (exists) { alert("ì´ë¯¸ ì¶”ê°€ëœ í•­ëª©ì…ë‹ˆë‹¤."); return; }

          const row = document.createElement("div");
          row.className = "flex justify-between items-center p-2 rounded border";
          row.setAttribute("data-key", key);
          row.setAttribute("data-section", meta.label);
          row.setAttribute("data-type", type);
          row.setAttribute("data-start", current);
          row.setAttribute("data-end", target);

          row.innerHTML = `
            <span class="font-semibold">[${meta.label}] ${type} : ${current} â†’ ${target}</span>
            <button class="text-xs text-red-500 hover:underline remove-btn">ì‚­ì œ</button>
          `;
          document.getElementById("listContainer").appendChild(row);

          row.querySelector(".remove-btn").addEventListener("click", () => {
            row.remove();
            sendHeightToParent();
          });

          sendHeightToParent();
        });
      });

      // ëª©ë¡ ì´ˆê¸°í™”
      document.getElementById("clearList").addEventListener("click", () => {
        document.getElementById("listContainer").innerHTML = "";
        document.getElementById("resultContainer").innerHTML =
          `<div class="text-sm text-gray-500">í•­ëª©ì„ ì¶”ê°€í•˜ê³  <span class="font-semibold">[ğŸ“Š ê³„ì‚°í•˜ê¸°]</span>ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>`;
        sendHeightToParent();
      });

      // âœ… ê²°ê³¼: ì¹´ë“œ ë Œë”(ëª¨ë°”ì¼)
    function renderResultCard(item, factor){
      const applied = Math.round((item.sum.ì‹œê°„ || 0) / (factor || 1));
      return `
        <div class="res-card border bg-gray-50 p-3 dark:bg-white/5 dark:border-white/10">
          <div class="text-[14px] font-semibold">[${item.section}] ${item.type}</div>
          <div class="res-sep my-2"></div>

          <div class="text-[13px] text-gray-600 dark:text-gray-300">ë ˆë²¨: <span class="font-semibold tabnums">${item.start} â†’ ${item.end}</span></div>

          <div class="grid grid-cols-2 gap-x-3 gap-y-1 mt-2 text-[13px]">
            <div class="flex justify-between gap-2"><span class="text-gray-600 dark:text-gray-300">ê³ ê¸°</span><span class="font-semibold tabnums">${formatResource(item.sum.ê³ ê¸°)}</span></div>
            <div class="flex justify-between gap-2"><span class="text-gray-600 dark:text-gray-300">ëª©ì¬</span><span class="font-semibold tabnums">${formatResource(item.sum.ëª©ì¬)}</span></div>
            <div class="flex justify-between gap-2"><span class="text-gray-600 dark:text-gray-300">ì„íƒ„</span><span class="font-semibold tabnums">${formatResource(item.sum.ì„íƒ„)}</span></div>
            <div class="flex justify-between gap-2"><span class="text-gray-600 dark:text-gray-300">ì² ê´‘</span><span class="font-semibold tabnums">${formatResource(item.sum.ì² ê´‘)}</span></div>
            <div class="col-span-2 flex justify-between gap-2 pt-1">
              <span class="text-gray-600 dark:text-gray-300">ì² ê°•ì¬</span>
              <span class="font-semibold tabnums">${formatResource(item.sum.ì² ê°•ì¬)}</span>
            </div>
          </div>

          <div class="res-sep my-2"></div>
          <div class="flex justify-between text-[13px]">
            <span class="text-gray-600 dark:text-gray-300">ì—°êµ¬ì‹œê°„</span>
            <span class="font-semibold tabnums">${formatTime(applied)}</span>
          </div>
        </div>
      `;
    }

    function renderTotalCard(total, factor){
      const applied = Math.round((total.ì‹œê°„ || 0) / (factor || 1));
      return `
        <div class="res-card border bg-gray-100 p-3 font-semibold dark:bg-white/10 dark:border-white/10">
          <div class="text-[14px] mb-2">ì´í•©</div>
          <div class="grid grid-cols-2 gap-x-3 gap-y-1 text-[13px] font-normal">
            <div class="flex justify-between gap-2"><span class="text-gray-600 dark:text-gray-300">ê³ ê¸°</span><span class="font-semibold tabnums">${formatResource(total.ê³ ê¸°||0)}</span></div>
            <div class="flex justify-between gap-2"><span class="text-gray-600 dark:text-gray-300">ëª©ì¬</span><span class="font-semibold tabnums">${formatResource(total.ëª©ì¬||0)}</span></div>
            <div class="flex justify-between gap-2"><span class="text-gray-600 dark:text-gray-300">ì„íƒ„</span><span class="font-semibold tabnums">${formatResource(total.ì„íƒ„||0)}</span></div>
            <div class="flex justify-between gap-2"><span class="text-gray-600 dark:text-gray-300">ì² ê´‘</span><span class="font-semibold tabnums">${formatResource(total.ì² ê´‘||0)}</span></div>
            <div class="col-span-2 flex justify-between gap-2 pt-1">
              <span class="text-gray-600 dark:text-gray-300">ì² ê°•ì¬</span>
              <span class="font-semibold tabnums">${formatResource(total.ì² ê°•ì¬||0)}</span>
            </div>
          </div>
          <div class="res-sep my-2"></div>
          <div class="flex justify-between text-[13px] font-normal">
            <span class="text-gray-600 dark:text-gray-300">ì—°êµ¬ì‹œê°„</span>
            <span class="font-semibold tabnums">${formatTime(applied)}</span>
          </div>
        </div>
      `;
    }

      // ê³„ì‚°
      document.getElementById("calculateFromList").addEventListener("click", async () => {
        const rows = Array.from(document.querySelectorAll("#listContainer div[data-key]"));
        if (!rows.length) { alert("ê³„ì‚°í•  ì—°êµ¬ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤."); return; }

        let total = { ê³ ê¸°:0, ëª©ì¬:0, ì„íƒ„:0, ì² ê´‘:0, ì² ê°•ì¬:0, ì‹œê°„:0 };

        // âœ… ì†ë„(ì‹œê°„ ë‹¨ì¶•) ê³„ìˆ˜
        let factor = (parseFloat(document.getElementById("speedPercent").value) || 0) * 0.01 + 1;
        if (document.getElementById("chkVP10").checked) factor += 0.10;
        if (document.getElementById("chkVP15").checked) factor += 0.15;
        if (document.getElementById("chkServerBuff").checked) factor += 0.10;

        const urlMap = { "ì „íˆ¬":"Battle.csv", "ê²½ì œ":"Economy.csv", "ë°œì „":"Growth.csv" };

        // âœ… ì„¹ì…˜ë³„ CSVëŠ” í•œ ë²ˆë§Œ fetchí•´ì„œ ìºì‹œ
        const csvCache = new Map();
        async function getCsv(file){
          if (csvCache.has(file)) return csvCache.get(file);
          const url = `https://raw.githubusercontent.com/s574shinchan/WOS_Calc/refs/heads/main/data/research/${file}`;
          const text = await fetch(url).then(r=>r.text());
          const lines = text.split("\n").map(l=>l.trim()).filter(Boolean);
          const headers = (lines[0] || "").split(",");
          const payload = { headers, lines };
          csvCache.set(file, payload);
          return payload;
        }

        const items = await Promise.all(rows.map(async row => {
          const section = row.getAttribute("data-section");
          const type = row.getAttribute("data-type");
          const s = parseInt(row.getAttribute("data-start"),10);
          const e = parseInt(row.getAttribute("data-end"),10);

          const file = urlMap[section];
          const { headers, lines } = await getCsv(file);

          const idx = {
            ì—°êµ¬: headers.indexOf("ì—°êµ¬"),
            ê³ ê¸°: headers.indexOf("ê³ ê¸°"),
            ëª©ì¬: headers.indexOf("ëª©ì¬"),
            ì„íƒ„: headers.indexOf("ì„íƒ„"),
            ì² ê´‘: headers.indexOf("ì² ê´‘"),
            ì² ê°•ì¬: headers.indexOf("ì² ê°•ì¬"),
            ì‹œê°„: headers.indexOf("ì‹œê°„")
          };

          let sum = { ê³ ê¸°:0, ëª©ì¬:0, ì„íƒ„:0, ì² ê´‘:0, ì² ê°•ì¬:0, ì‹œê°„:0 };

          for (let i=1;i<lines.length;i++){
            const cols = lines[i].split(",");
            const name = cols[idx.ì—°êµ¬];
            if (!name) continue;
            const m2 = name.match(/^(.*)-(\d+)$/);
            if (!m2) continue;

            const fullType = m2[1];
            const level = parseInt(m2[2],10);
            if (fullType !== type) continue;

            if (level > s && level <= e){
              sum.ê³ ê¸° += cleanInt(cols[idx.ê³ ê¸°]);
              sum.ëª©ì¬ += cleanInt(cols[idx.ëª©ì¬]);
              sum.ì„íƒ„ += cleanInt(cols[idx.ì„íƒ„]);
              sum.ì² ê´‘ += cleanInt(cols[idx.ì² ê´‘]);
              sum.ì² ê°•ì¬ += cleanInt(cols[idx.ì² ê°•ì¬]);
              sum.ì‹œê°„ += parseTimeToSeconds(cols[idx.ì‹œê°„]);
            }
          }

          total.ê³ ê¸° += sum.ê³ ê¸°;
          total.ëª©ì¬ += sum.ëª©ì¬;
          total.ì„íƒ„ += sum.ì„íƒ„;
          total.ì² ê´‘ += sum.ì² ê´‘;
          total.ì² ê°•ì¬ += sum.ì² ê°•ì¬;
          total.ì‹œê°„ += sum.ì‹œê°„;

          return { section, type, start:s, end:e, sum };
        }));

        const cards = items.map(it => renderResultCard(it, factor)).join("");
        const html = `<div class="space-y-2">${cards}${renderTotalCard(total, factor)}</div>`;

        document.getElementById("resultContainer").innerHTML = html;
        sendHeightToParent();
      });
      sendHeightToParent();
    });

    function goBack(){
      if (window.parent && typeof window.parent.loadPage === "function"){
        window.parent.loadPage("researchchoice.html");
      } else {
        location.href = "researchchoice.html";
      }
    }
  </script>

  <!-- ìš°í´ë¦­/ë‹¨ì¶•í‚¤ ì œí•œ (ê¸°ì¡´ ìœ ì§€) -->
  <script>
    document.addEventListener("contextmenu", e => e.preventDefault());
    document.addEventListener("keydown", function (e) {
      if (e.key === "F12" ||
          (e.ctrlKey && e.shiftKey && (e.key === "I" || e.key === "J")) ||
          (e.ctrlKey && (e.key === "U" || e.key === "S"))) {
        e.preventDefault();
      }
    });
  </script>
</body>
</html>
