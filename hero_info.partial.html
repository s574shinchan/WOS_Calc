<meta charset="UTF-8" />

<div class="max-w-[1500px] mx-auto bg-white rounded shadow p-2 flex flex-col sm:flex-row gap-2">
  <div class="flex-1 bg-white rounded p-2 space-y-4 shadow">
    <div class="bg-gray-100 p-2 font-sans text-sm">
      <div class="bg-white p-4 rounded-xl shadow-md space-y-4">
        <!-- 헤더 -->
        <div class="flex items-center justify-between gap-3 mb-4">
          <div>
            <h1 class="text-xl md:text-2xl font-extrabold">세대별 영웅 정보</h1>
            <p class="text-sm">영웅 클릭 → 이미지 스타일 상세 카드</p>
          </div>
        </div>

        <div class="flex items-center gap-2 mb-4">
          <span class="text-sm">세대 선택</span>
          <select id="genSelect"
                  class="px-3 py-2 w-24 rounded-xl text-sm border shadow-sm bg-white focus:outline-none focus:ring-2 focus:ring-blue-400">
          </select>

          <div id="typeWrap" class="flex items-center gap-2">
            <span class="text-sm">병종 선택</span>
            <select id="selType"
                    class="px-3 py-2 w-24 rounded-xl text-sm border shadow-sm bg-white focus:outline-none focus:ring-2 focus:ring-blue-400">
              <option value="ALL">전체</option>
              <option value="INFANTRY">방패병</option>
              <option value="LANCER">창병</option>
              <option value="MARKSMAN">궁병</option>
            </select>
          </div>

          <div class="flex items-center gap-2 flex-1 min-w-[220px]">
            <span class="text-sm whitespace-nowrap">이름 검색</span>
            <div class="relative flex-1">
              <input id="heroSearch"
                     type="text"
                     class="w-[300px] px-3 py-2 rounded-xl text-sm border shadow-sm bg-white focus:outline-none focus:ring-2 focus:ring-blue-400" />
              <button id="heroSearchClear"
                      type="button"
                      class="px-3 py-2 rounded-xl text-sm border shadow-sm bg-white">
                지우기
              </button>
            </div>
          </div>
        </div>

        <!-- ✅ 비교 기능 바 (체크 옆으로 버튼 이동) -->
        <div class="flex items-center gap-2 mb-3 flex-wrap">
          <label class="inline-flex items-center gap-2 text-sm">
            <input id="heroCompareMode" type="checkbox" class="w-4 h-4" />
            영웅 비교
          </label>

          <button id="compareBtn"
                  type="button"
                  class="px-3 py-2 rounded-xl text-sm border shadow-sm bg-white disabled:opacity-40 disabled:cursor-not-allowed"
                  disabled>
            비교하기
          </button>

          <div id="compareHint" class="text-xs text-gray-600 hidden">
            2명을 선택한 뒤 비교하기를 누르세요. (최대 2명)
          </div>
        </div>

        <!-- 영웅 카드 그리드 -->
        <div id="heroGrid" class="grid grid-cols-1 gap-3"></div>
      </div>

      <!-- ====== 상세 모달 ====== -->
      <div id="modalBackdrop" class="fixed inset-0 z-[2000] hidden">
        <div class="absolute inset-0 bg-black/60"></div>

        <div class="absolute inset-0 overflow-auto p-3 md:p-3">
          <div class="max-w-5xl mx-auto">
            <div class="rounded-2xl overflow-hidden shadow-2xl border bg-white">
              <div id="modalHeroHeader"
                   class="relative px-4 py-2 md:px-5 md:py-3 text-white"
                   style="background: linear-gradient(135deg,#0ea5e9,#2563eb);">
                <div class="flex items-start justify-between gap-3">
                  <div class="min-w-0">
                    <div class="flex items-center gap-2 text-sm md:text-xs opacity-90">
                      <span id="hdrClass" class="inline-flex items-center gap-1">
                        <span class="w-4 h-4 rounded bg-white/20 inline-flex items-center justify-center">
                          <img id="hdrClassIcon"
                               src=""
                               class="w-3.5 h-3.5 object-contain"
                               alt="ClassIcon"/>
                        </span>
                        <span>HERO CLASS: -</span>
                      </span>
                      <span class="opacity-60">•</span>
                      <span id="hdrType" class="inline-flex items-center gap-1">
                        <span class="w-4 h-4 rounded bg-white/20 inline-flex items-center justify-center">
                          <img id="expeditionIcon"
                               src=""
                               class="w-3.5 h-3.5 object-contain"
                               alt="Skills"/>
                        </span>
                        <span>EXPEDITION TYPE: -</span>
                      </span>
                    </div>

                    <div class="mt-2">
                      <div id="hdrName" class="text-3xl md:text-4xl font-black title-grit uppercase">
                        HERO
                      </div>
                      <div id="hdrGen" class="mt-1 text-xs opacity-90">Gen -</div>
                    </div>
                  </div>

                  <div class="flex items-center gap-2">
                    <button id="closeModal"
                            class="px-3 py-2 rounded-xl bg-white/15 hover:bg-white/25 border border-white/20 text-sm">
                      닫기
                    </button>
                  </div>
                </div>
              </div>

              <div class="relative p-4 md:p-3">
                <div class="grid grid-cols-12 gap-3">

                  <div class="lg:col-span-4">
                    <div class="rounded-2xl border p-3 md:p-4 h-full">
                      <h3 class="text-base md:text-lg font-extrabold">탐험 스킬</h3>
                      <div id="exploreSkills" class="mt-3 space-y-3"></div>
                    </div>
                  </div>

                  <div class="lg:col-span-4">
                    <div class="rounded-2xl border p-3 md:p-4 h-full flex flex-col">
                      <div class="flex items-center justify-between">
                        <div id="sourceText" class="text-[11px] text-gray-500"></div>
                      </div>

                      <div class="mt-3 flex-1 flex items-center justify-center">
                        <div class="w-full max-w-[300px] aspect-[3/4] overflow-hidden flex items-center justify-center">
                          <img id="heroImg"
                               src="/images/hero/thumb/Gen1/jeronimo.webp"
                               alt="hero"
                               class="w-full h-full object-contain"
                               loading="lazy" />
                          <div id="heroImgFallback" class="hidden text-sm text-gray-500 p-4 text-center">
                            hero image not found<br/>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="lg:col-span-4">
                    <div class="rounded-2xl border p-3 md:p-4 h-full">
                      <h3 class="text-base md:text-lg font-extrabold">원정 스킬</h3>
                      <div id="expeditionSkills" class="mt-3 space-y-3"></div>
                    </div>
                  </div>

                  <div id="traitCard" class="col-span-6 rounded-2xl border p-3 md:p-4">
                    <div class="font-extrabold text-base whitespace-nowrap">특성버프</div>
                    <div id="traitBuffArea" class="mt-3 space-y-3"></div>
                  </div>

                  <div id="weapon" class="col-span-6 rounded-2xl border bg-white p-3 md:p-4">
                    <div class="font-extrabold text-base whitespace-nowrap">전용무기</div>
                    <div id="weaponSkills" class="mt-3 space-y-3"></div>
                  </div>

                  <div class="col-span-12">
                    <div class="grid grid-cols-2 gap-3">
                      <div class="rounded-2xl border bg-white p-3 md:p-4">
                        <div class="flex flex-col grid grid-cols-2">
                          <div class="font-extrabold">전용무기속성</div> 
                          <div class="text-[11px] text-right text-gray-500">+10강 기준/해당 병종에 적용</div> 
                        </div>
                        <div id="statExplore" class="mt-2 grid grid-cols-2 gap-2 text-sm"></div>
                      </div>
                      <div class="rounded-2xl border bg-white p-3 md:p-4">
                        <div class="font-extrabold">영웅 속성 (원정)</div>
                        <div id="statExpedition" class="mt-2 grid grid-cols-2 gap-2 text-sm"></div>
                      </div>
                    </div>
                  </div>

                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ====== ✅ 비교 모달 ====== -->
      <div id="compareBackdrop" class="fixed inset-0 z-[2100] hidden">
        <div class="absolute inset-0 bg-black/60"></div>

        <div class="absolute inset-0 overflow-auto p-3 md:p-3">
          <div class="max-w-6xl mx-auto">
            <div class="rounded-2xl overflow-hidden shadow-2xl border border-white/10"
                 style="background:#1f232a;">
              <div class="relative px-5 py-3 text-white"
                   style="background: linear-gradient(135deg,#7c3aed,#2563eb);">
                <div class="flex items-center justify-between gap-3">
                  <div class="font-extrabold text-lg">영웅 비교</div>
                  <button id="closeCompare"
                          class="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20 border border-white/15 text-sm">
                    닫기
                  </button>
                </div>
              </div>

              <div class="p-4 md:p-4">
                <div id="compareWrap" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
(function(){
  // SPA 재진입/재로드 시 이벤트 중복 바인딩 방지
  if (window.__HEROINFO_INIT_BOUND__) {
    window.HeroInfoInit?.();
    return;
  }
  window.__HEROINFO_INIT_BOUND__ = true;

  window.HeroInfoInit = function HeroInfoInit(){  
    // =========================
    // 데이터 (샘플)
    // =========================
    var HEROES = [];

    async function loadHeroes(){
      try{
        var url = new URL("data/heroes.json", window.location.href).toString();
        var res = await fetch(url, { cache: "no-store" });

        if(!res.ok){
          throw new Error(`heroes.json 로드 실패: ${res.status} ${res.statusText} / ${url}`);
        }

        HEROES = await res.json();

        // 렌더 순서 고정
        initTypeSelect();
        initSearch();
        renderGenTabs();
        initCompareUI();
        renderHeroGrid();

      }catch(err){
        console.error(err);

        var wrap = document.getElementById("heroGrid");
        if(wrap){
          wrap.className = "p-4 rounded-xl border bg-red-50 text-red-700 text-sm";
          wrap.innerHTML = `
            <div class="font-extrabold mb-1">영웅 데이터 로드 실패</div>
            <div>${String(err.message)}</div>
            <div class="mt-2 text-xs text-gray-600">
              heroes.json 파일이 이 페이지와 같은 폴더에 있는지 / 서버에서 열고 있는지(파일:// 아님) 확인
            </div>
          `;
        }
      }
    }

    loadHeroes();

    // =========================
    // 상태
    // =========================
    var currentGen = "ALL";
    var currentHero = null;
    var currentType = "ALL";
    var currentSearch = "";

    // =========================
    // ✅ 비교 상태
    // =========================
    var compareMode = false;
    var compareSelectedKeys = []; // hero.key 최대 2개

    // =========================
    // 유틸
    // =========================
    var $ = (id) => document.getElementById(id);
    var escapeHtml = (s) => (s ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    var fmt = (v) => typeof v === "number" ? v.toLocaleString("ko-KR") : String(v);

    // =========================
    // 렌더: 세대 드롭다운
    // =========================
    function renderGenTabs(){
      var gens = Array.from(new Set(HEROES.map(h => h.gen)))
        .sort((a, b) => a - b);

      var select = $("genSelect");
      select.innerHTML = "";

      var optAll = document.createElement("option");
      optAll.value = "ALL";
      optAll.textContent = "전체";
      select.appendChild(optAll);

      gens.forEach(g => {
        var opt = document.createElement("option");
        opt.value = g;
        opt.textContent = `${g}세대`;
        select.appendChild(opt);
      });

      select.value = currentGen ?? "ALL";

      select.onchange = () => {
        var v = select.value;
        currentGen = (v === "ALL") ? "ALL" : Number(v);
        renderHeroGrid();
      };
    }

    // =========================
    // 렌더: 영웅 리스트 카드
    // =========================
    var CLASS_ICON_MAP = {
      INFANTRY: "images/hero/icon_infantry.webp",
      LANCER: "images/hero/icon_lancer.webp",
      MARKSMAN: "images/hero/icon_marksman.webp"
    };

    function initTypeSelect(){
      var sel = $("selType");
      if(!sel) return;

      sel.value = currentType;

      sel.onchange = () => {
        if(currentGen !== "ALL"){
          currentType = "ALL";
          return;
        }

        currentType = sel.value;
        renderHeroGrid();
      };
    }

    function initSearch(){
      var input = $("heroSearch");
      var clear = $("heroSearchClear");
      if(!input) return;

      // 초기값 반영
      input.value = currentSearch || "";

      // 입력 시: 검색만 갱신
      input.oninput = () => {
        currentSearch = input.value || "";
        renderHeroGrid();
      };

      // 지우기 버튼: 항상 표시, 클릭 시 초기화
      if(clear){
        clear.onclick = () => {
          input.value = "";
          currentSearch = "";
          renderHeroGrid();
          input.focus();
        };
      }
    }

    // =========================
    // ✅ 비교 UI/로직
    // =========================
    function initCompareUI(){
      var chk = $("heroCompareMode");
      var hint = $("compareHint");
      var btn = $("compareBtn");

      if(!chk || !btn || !hint) return;

      chk.checked = false;
      compareMode = false;
      compareSelectedKeys = [];
      hint.classList.add("hidden");
      btn.disabled = true;

      chk.onchange = () => {
        compareMode = !!chk.checked;
        compareSelectedKeys = [];
        btn.disabled = true;

        if(compareMode){
          hint.classList.remove("hidden");
        }else{
          hint.classList.add("hidden");
        }

        renderHeroGrid();
      };

      btn.onclick = () => {
        if(compareSelectedKeys.length !== 2) return;
        openCompareModal(compareSelectedKeys[0], compareSelectedKeys[1]);
      };
    }

    function heroByKey(key){
      return HEROES.find(h => h.key === key) || null;
    }

    function updateCompareButton(){
      var btn = $("compareBtn");
      if(!btn) return;
      btn.disabled = compareSelectedKeys.length !== 2;
    }

    function showCompareLimitPopup(){
      var a = heroByKey(compareSelectedKeys[0]);
      var b = heroByKey(compareSelectedKeys[1]);
      var names = [a?.nameKo || a?.name || "-", b?.nameKo || b?.name || "-"].join(", ");
      alert(`이미 2명이 선택되어 있습니다.\n선택된 영웅: ${names}\n(최대 2명까지 선택 가능합니다)`);
    }

    function openCompareModal(k1, k2){
      var a = heroByKey(k1);
      var b = heroByKey(k2);
      if(!a || !b) return;

      var wrap = $("compareWrap");
      if(!wrap) return;

      wrap.innerHTML = `
        ${renderCompareCard(a, "A")}
        ${renderCompareCard(b, "B")}
      `;

      $("compareBackdrop").classList.remove("hidden");
      document.body.style.overflow = "hidden";
    }

    function closeCompareModal(){
      $("compareBackdrop").classList.add("hidden");
      document.body.style.overflow = "";
    }

    function renderCompareCard(hero, side){
      var nameText = hero.nameKo || hero.name || "-";
      var genText = `${hero.gen}세대`;
      var cls = hero.heroClass || "-";
      var clsIcon = CLASS_ICON_MAP[cls] || "";
      var portrait = renderPortrait(hero) || renderHeroThumb(hero) || "";

      var exp = Array.isArray(hero.expeditionSkills) ? hero.expeditionSkills.slice(0,3) : [];
      var ws2 = null;
      if(Array.isArray(hero.weaponSkills)){
        ws2 = hero.weaponSkills.find(s => String(s?.key || "").toLowerCase() === "ws2") || null;
      }

      var skillsHtml = `
        ${renderCompareSkillBox(hero, exp[0], "원정스킬 1")}
        ${renderCompareSkillBox(hero, exp[1], "원정스킬 2")}
        ${renderCompareSkillBox(hero, exp[2], "원정스킬 3")}
        ${renderCompareWeapon2Box(hero, ws2)}
      `;

      var header = `
        <div class="flex items-center justify-between gap-3 px-4 py-3 text-white rounded-t-2xl"
             style="background: linear-gradient(135deg,#0b1220,#1f2937);">
          <div class="flex items-center gap-3 min-w-0">
            <div class="inline-flex items-center gap-2 px-2.5 py-1 rounded-full border border-white/10 bg-white/5 text-xs font-extrabold">
              ${clsIcon ? `<img src="${escapeHtml(clsIcon)}" class="w-4 h-4 object-contain" alt="${escapeHtml(cls)}" />` : ``}
              <span>${escapeHtml(cls)}</span>
            </div>
            <div class="text-lg font-extrabold truncate">${escapeHtml(nameText)}</div>
          </div>
          <div class="text-xs opacity-80">${escapeHtml(genText)}</div>
        </div>
      `;

      // A: 이미지(좌) / 스킬(우), B: 스킬(좌) / 이미지(우)
      var gridA = `
        <div class="grid grid-cols-12 gap-3 p-4">
          <div class="col-span-4">
            <div class="rounded-2xl border border-white/10 bg-white/5 p-3 h-full flex items-center justify-center">
              <div class="w-full max-w-[260px] aspect-[3/4] flex items-center justify-center">
                <img src="${escapeHtml(portrait)}" class="w-full h-full object-contain" alt="hero" loading="lazy" />
              </div>
            </div>
          </div>
          <div class="col-span-8 grid gap-3">
            ${skillsHtml}
          </div>
        </div>
      `;

      var gridB = `
        <div class="grid grid-cols-12 gap-3 p-4">
          <div class="col-span-8 grid gap-3">
            ${skillsHtml}
          </div>
          <div class="col-span-4">
            <div class="rounded-2xl border border-white/10 bg-white/5 p-3 h-full flex items-center justify-center">
              <div class="w-full max-w-[260px] aspect-[3/4] flex items-center justify-center">
                <img src="${escapeHtml(portrait)}" class="w-full h-full object-contain" alt="hero" loading="lazy" />
              </div>
            </div>
          </div>
        </div>
      `;

      return `
        <div class="rounded-2xl overflow-hidden border border-white/10" style="background:#2a2f36;">
          ${header}
          ${side === "B" ? gridB : gridA}
        </div>
      `;
    }

    function renderCompareSkillBox(hero, sk, label){
      var iconSrc = sk ? heroSkillIcon(hero, sk.key) : "";
      var desc = sk?.desc || "";
      return `
        <div class="rounded-2xl border border-white/10 bg-white/5 p-3">
          <div class="text-xs text-white/70 mb-2">${escapeHtml(label)}</div>
          <div class="flex gap-3">
            <div class="w-12 h-12 rounded-xl flex items-center justify-center shrink-0">
              <img src="${escapeHtml(iconSrc)}" class="w-12 h-12 object-contain" alt="skill" loading="lazy" />
            </div>
            <div class="min-w-0 flex-1 text-sm leading-relaxed text-white/90">
              ${escapeHtml(desc)}
            </div>
          </div>
        </div>
      `;
    }

    function renderCompareWeapon2Box(hero, ws2){
      var iconSrc = ws2 ? heroSkillIcon(hero, ws2.key) : "";
      var desc = ws2?.desc || "";
      return `
        <div class="rounded-2xl border border-white/10 bg-white/5 p-3">
          <div class="text-xs text-white/70 mb-2">전용무기</div>
          <div class="flex gap-3">
            <div class="w-12 h-12 rounded-xl flex items-center justify-center shrink-0">
              <img src="${escapeHtml(iconSrc)}" class="w-12 h-12 object-contain" alt="weapon" loading="lazy" />
            </div>
            <div class="min-w-0 flex-1 text-sm leading-relaxed text-white/90">
              ${escapeHtml(desc)}
            </div>
          </div>
        </div>
      `;
    }

    function syncCompareChecks(){
      var checks = document.querySelectorAll(".hero-compare-check");
      checks.forEach(chk => {
        var key = chk.dataset.key || "";
        chk.checked = compareSelectedKeys.includes(key);

        chk.onchange = () => {
          var k = chk.dataset.key || "";

          // ✅ 2명 선택 상태에서 3번째 새 체크 시: 체크 자체 차단 + 팝업
          if(!compareSelectedKeys.includes(k) && compareSelectedKeys.length >= 2){
            chk.checked = false;
            showCompareLimitPopup();
            return;
          }

          var i = compareSelectedKeys.indexOf(k);
          if(chk.checked){
            if(i < 0) compareSelectedKeys.push(k);
          }else{
            if(i >= 0) compareSelectedKeys.splice(i, 1);
          }

          updateCompareButton();
        };
      });

      updateCompareButton();
    }

    function renderHeroGrid(){
      var wrap = $("heroGrid");
      var typeWrap = $("typeWrap") 
      wrap.innerHTML = "";

      if(currentGen !== "ALL"){
        typeWrap.classList.add("hidden")
      }
      else{
        typeWrap.classList.remove("hidden")
      }

      var q = (currentSearch || "").toString().trim().toLowerCase();

      // 세대 + 병종 + 이름 포함 검색
      var list = HEROES.filter(h => {
        var genOk  = (currentGen === "ALL") || (h.gen === currentGen);
        var typeOk = (currentGen !== "ALL") ? true : (currentType === "ALL") || (h.heroClass === currentType);

        var nameKo = (h.nameKo || "").toString().toLowerCase();
        var nameEn = (h.name || "").toString().toLowerCase();
        var nameOk = !q || nameKo.includes(q) || nameEn.includes(q);

        return genOk && typeOk && nameOk;
      });

      // 전체세대 + 병종 선택 시: Gen 섹션 없이 3컬럼으로 표시
      if(currentGen === "ALL" && currentType !== "ALL"){
        wrap.className = "grid grid-cols-3 gap-3";

        list.sort((a,b)=> (a.gen - b.gen) || String(a.nameKo||a.name).localeCompare(String(b.nameKo||b.name), "ko"));

        list.forEach(hero=>{
          var card = document.createElement("button");
          card.className = "text-left rounded-2xl border p-3 hover:shadow-md transition";

          card.onclick = () => {
            if(compareMode){
              var key = hero.key;
              if(!compareSelectedKeys.includes(key) && compareSelectedKeys.length >= 2){
                showCompareLimitPopup();
                return;
              }
              var checks = card.querySelector(".hero-compare-check");
              if(checks) {
                checks.checked = !checks.checked;
                checks.dispatchEvent(new Event("change", { bubbles: true }));
              }
              return;
            }
            openHeroModal(hero);
          };

          var img = renderHeroThumb(hero) || renderPortrait(hero) || "";
          var checked = compareSelectedKeys.includes(hero.key) ? "checked" : "";

          card.innerHTML = `
            ${compareMode ? `
              <div class="flex items-center justify-between mb-2">
                <label class="inline-flex items-center gap-2 text-xs text-gray-700">
                  <input type="checkbox" class="hero-compare-check w-4 h-4"
                         data-key="${escapeHtml(hero.key)}" ${checked}/>
                  비교 선택
                </label>
                <div class="text-[11px] text-gray-500">최대 2명</div>
              </div>
            ` : ``}

            <div class="flex items-center gap-3">
              <div class="w-16 h-16 rounded-2xl overflow-hidden flex items-center justify-center shrink-0">
                <img src="${escapeHtml(img)}" class="w-full h-full object-contain" />
              </div>

              <div class="min-w-0 flex-1">
                <div class="flex items-center gap-2">
                  <div class="text-lg font-extrabold truncate">${escapeHtml(hero.nameKo || hero.name)}</div>

                  <div class="shrink-0">
                    ${CLASS_ICON_MAP[hero.heroClass] ? `
                      <img src="${escapeHtml(CLASS_ICON_MAP[hero.heroClass])}"
                           class="w-5 h-5 object-contain opacity-90"
                           alt="${escapeHtml(hero.heroClass)}"
                           loading="lazy" />
                    ` : ``}
                  </div>
                </div>

                <div class="mt-0.5 text-xs truncate">
                  ${hero.gen}세대 • ${escapeHtml(hero.heroClass)} • ${escapeHtml(hero.expeditionType)}
                </div>
                <div class="mt-1 text-[11px] truncate">${escapeHtml(hero.source||"")}</div>
              </div>
            </div>
          `;
          wrap.appendChild(card);
        });

        if(list.length === 0){
          wrap.className = "grid grid-cols-1 gap-3";
          wrap.innerHTML = `<div class="text-sm">표시할 영웅이 없습니다.</div>`;
        }else{
          if(compareMode) syncCompareChecks();
        }
        return;
      }

      // 병종선택했다가 전체 병종할때 UX 깨져서 클래스네임 삭제
      if(currentGen !== "ALL"){
        wrap.classList.remove("grid-cols-3");
        wrap.classList.remove("grid-cols-2");
      } else {
        wrap.classList.remove("grid-cols-3");
        wrap.classList.add("grid-cols-2");  
      }

      // Gen 그룹핑
      var byGen = new Map();
      for(var h of list){
        if(!byGen.has(h.gen)) byGen.set(h.gen, []);
        byGen.get(h.gen).push(h);
      }

      var gens = Array.from(byGen.keys()).sort((a,b)=>a-b);
      var useAccordion = (currentGen === "ALL");

      gens.forEach(gen=>{
        var heroes = byGen.get(gen);

        var section = document.createElement(useAccordion ? "details" : "div");
        if(useAccordion){
          section.open = true;
          section.className = "rounded-2xl border overflow-hidden";
          section.innerHTML = `
            <summary class="cursor-pointer select-none px-4 py-3 font-extrabold flex items-center justify-between">
              <span>${gen}세대 (${heroes.length}명)</span>
            </summary>
            <div class="px-3 pb-3">
              <div class="gen-grid grid gap-3"></div>
            </div>
          `;

          var summary = section.querySelector("summary");
          summary.addEventListener("click", (e) => {
            e.preventDefault();
            section.open = true;
          });
        }else{
          section.className = "space-y-3";
          section.innerHTML = `
            <div class="flex items-center justify-between">
              <div class="text-lg font-extrabold">${gen}세대 영웅 (${heroes.length}명)</div>
            </div>
            <div class="gen-grid grid gap-3"></div>
          `;
        }

        var grid = section.querySelector(".gen-grid");
        var cols = (heroes.length >= 4) ? "grid-cols-2" : "grid-cols-3";
        grid.className = `gen-grid grid ${cols} gap-3`;

        heroes.forEach(hero=>{
          var card = document.createElement("button");
          card.className = "text-left rounded-2xl border p-3 hover:shadow-md transition";

          card.onclick = () => {
            if(compareMode){
              var key = hero.key;
              if(!compareSelectedKeys.includes(key) && compareSelectedKeys.length >= 2){
                showCompareLimitPopup();
                return;
              }
              var checks = card.querySelector(".hero-compare-check");
              if(checks) {
                checks.checked = !checks.checked;
                checks.dispatchEvent(new Event("change", { bubbles: true }));
              }
              return;
            }
            openHeroModal(hero);
          };

          var img = renderHeroThumb(hero) || renderPortrait(hero) || "";
          var checked = compareSelectedKeys.includes(hero.key) ? "checked" : "";

          card.innerHTML = `
            ${compareMode ? `
              <div class="flex items-center justify-between mb-2">
                <label class="inline-flex items-center gap-2 text-xs text-gray-700">
                  <input type="checkbox" class="hero-compare-check w-4 h-4"
                         data-key="${escapeHtml(hero.key)}" ${checked}/>
                  비교 선택
                </label>
                <div class="text-[11px] text-gray-500">최대 2명</div>
              </div>
            ` : ``}

            <div class="flex items-center gap-3">
              <div class="w-16 h-16 rounded-2xl overflow-hidden flex items-center justify-center shrink-0">
                <img src="${escapeHtml(img)}" class="w-full h-full object-contain" />
              </div>

              <div class="min-w-0 flex-1">
                <div class="flex items-center gap-2">
                  <div class="text-lg font-extrabold truncate">${escapeHtml(hero.nameKo || hero.name)}</div>
                  <div class="shrink-0">
                    ${CLASS_ICON_MAP[hero.heroClass] ? `
                      <img src="${escapeHtml(CLASS_ICON_MAP[hero.heroClass])}"
                           class="w-5 h-5 object-contain opacity-90"
                           alt="${escapeHtml(hero.heroClass)}"
                           loading="lazy" />
                    ` : ``}
                  </div>
                </div>

                <div class="mt-0.5 text-xs truncate">${hero.gen}세대 • ${escapeHtml(hero.heroClass)}</div>
                <div class="mt-1 text-[11px] truncate">${escapeHtml(hero.source||"")}</div>
              </div>
            </div>
          `;
          grid.appendChild(card);
        });

        wrap.appendChild(section);
      });

      if(list.length === 0){
        wrap.innerHTML = `<div class="text-sm">표시할 영웅이 없습니다.</div>`;
      }else{
        if(compareMode) syncCompareChecks();
      }
    }

    // =========================
    // 렌더: 스킬 카드
    // =========================
    function renderSkills(targetEl, hero, skills){
      var wrap = $(targetEl);
      wrap.innerHTML = "";

      (skills || []).slice(0,3).forEach(sk=>{
        var iconSrc = hero ? heroSkillIcon(hero, sk.key) : (sk.icon || "");

        var el = document.createElement("div");
        el.className = "rounded-xl border p-3";
        el.innerHTML = `
          <div class="flex gap-3">
            <div class="w-12 h-12 overflow-hidden flex items-center justify-center shrink-0">
              <img src="${escapeHtml(iconSrc)}"
                   class="w-full h-full object-contain"
                   loading="lazy" />
            </div>

            <div class="min-w-0 flex-1">
              <div class="mt-1 text-xs text-gray-700 leading-relaxed">
                ${escapeHtml(sk.desc||"")}
              </div>
            </div>
          </div>
        `;
        wrap.appendChild(el);
      });
    }

    function renderStats(){
      var s = currentHero?.stats || {};
      var ex = s.exploration || {};
      var ep = s.expedition || {};

      $("statExplore").innerHTML = Object.keys(ex).map(k => `
        <div class="rounded-xl border p-3">
          <div class="text-xs text-gray-700">${escapeHtml(k)}</div>
          <div class="text-base font-extrabold">${escapeHtml(fmt(ex[k]))}</div>
        </div>
      `).join("");

      $("statExpedition").innerHTML = Object.keys(ep).map(k => `
        <div class="rounded-xl border p-3">
          <div class="text-xs text-gray-700">${escapeHtml(k)}</div>
          <div class="text-base font-extrabold">${escapeHtml(fmt(ep[k]))}</div>
        </div>
      `).join("");
    }

    // 특성버프(= hero.exclusiveSkill) 렌더 + 12컬럼 레이아웃 토글
    function renderExclusiveSkill(hero, skills){
      var traitCard = $("traitCard");
      var body      = $("traitBuffArea");
      var weapon    = $("weapon");

      if(!traitCard || !body || !weapon) return;

      var hasTrait = Array.isArray(skills) && skills.length > 0;

      var setWeaponSpan = (span12) => {
        weapon.classList.remove("col-span-6", "col-span-12");
        weapon.classList.add(span12 ? "col-span-12" : "col-span-6");
      };

      var weaponSkills = $("weaponSkills");
      var setWeaponSkillsLayout = (twoCol) => {
        if(!weaponSkills) return;

        weaponSkills.classList.remove("space-y-3", "grid", "grid-cols-2", "gap-3");

        if(twoCol){
          weaponSkills.classList.add("grid", "grid-cols-2", "gap-3");
        }else{
          weaponSkills.classList.add("space-y-3");
        }
      };

      if(!hasTrait){
        traitCard.classList.add("hidden");
        setWeaponSpan(true);
        setWeaponSkillsLayout(true);
        body.innerHTML = "";
        return;
      }

      traitCard.classList.remove("hidden");
      traitCard.classList.remove("col-span-12");
      traitCard.classList.add("col-span-6");

      setWeaponSpan(false);
      setWeaponSkillsLayout(false);

      body.innerHTML = "";

      skills.forEach(sk => {
        var el = document.createElement("div");
        el.className = "flex items-start gap-3";

        var iconSrc = hero ? heroSkillIcon(hero, sk.key) : (sk.icon || "");

        el.innerHTML = `
          <div class="w-12 h-12 rounded-xl border overflow-hidden
                      flex items-center justify-center shrink-0">
            <img src="${escapeHtml(iconSrc)}"
                 class="w-full h-full object-contain"
                 loading="lazy" />
          </div>

          <div class="min-w-0 flex-1">
            <div class="font-bold text-sm mb-1">${escapeHtml(sk.title || "")}</div>
            <div class="text-xs leading-relaxed text-gray-700">
              ${escapeHtml(sk.desc || "")}
            </div>
          </div>
        `;
        body.appendChild(el);
      });
    }

    // 전용무기 스킬(weaponSkill) 렌더: ws1 ws2
    function renderWeaponSkills(hero, weaponSkill){
      var area = $("weaponSkills");

      area.innerHTML = "";
      var skills = Array.isArray(weaponSkill) ? weaponSkill : [];

      var order = ["ws1", "ws2"];
      var ordered = order
        .map(k => skills.find(s => (s?.key || "").toLowerCase() === k))
        .filter(Boolean);

      if(ordered.length === 0) return;

      ordered.forEach(sk => {
        var el = document.createElement("div");
        el.className = "flex items-start gap-3";

        var iconSrc = hero ? heroSkillIcon(hero, sk.key) : (sk.icon || "");

        el.innerHTML = `
          <div class="w-12 h-12 rounded-xl overflow-hidden
                      flex items-center justify-center shrink-0">
            <img src="${escapeHtml(iconSrc)}"
                 class="w-full h-full object-contain"
                 loading="lazy" />
          </div>

          <div class="min-w-0 flex-1">
            <div class="font-bold text-sm mb-1">${escapeHtml(sk.title || "")}</div>
            <div class="text-xs leading-relaxed text-gray-700">
              ${escapeHtml(sk.desc || "")}
            </div>
          </div>
        `;
        area.appendChild(el);
      });
    }

    function heroGen(hero){
      return String(hero.gen).padStart(2, "0");
    }

    function heroKey(hero){
      return hero.key;
    }

    function renderHeroThumb(hero){
      return `images/hero/Gen${heroGen(hero)}/thumb/${heroKey(hero)}.webp`;
    }

    function renderPortrait(hero){
      return `images/hero/Gen${heroGen(hero)}/body/${heroKey(hero)}.webp`;
    }

    function heroSkillIcon(hero, skillKey){
      return `images/hero/Gen${heroGen(hero)}/skills/${heroKey(hero)}/${skillKey}.webp`;
    }

    var EXPEDITION_TYPE_ICON = {
      COMBAT: "images/hero/combat.webp",
      varRUCTION: "images/hero/varruction.webp",
    };

    function renderExpeditionType(type){
      var iconEl = document.getElementById("expeditionIcon");
      var textEl = document.querySelector("#hdrType span:last-child");
      if(!iconEl || !textEl) return;

      var t = (type || "").toUpperCase();
      var icon = EXPEDITION_TYPE_ICON[t];

      if(icon){
        iconEl.src = icon;
        iconEl.style.display = "";
      }else{
        iconEl.style.display = "none";
      }

      textEl.textContent = `${t || "-"}`;
    }

    var HERO_CLASS_TYPE_ICON = {
      INFANTRY: "images/hero/icon_infantry.webp",
      LANCER: "images/hero/icon_Lancer.webp",
      MARKSMAN: "images/hero/icon_marksman.webp",
    };

    function renderHeroClassType(type){
      var iconEl = document.getElementById("hdrClassIcon");
      var textEl = document.querySelector("#hdrClass  span:last-child");
      if(!iconEl || !textEl) return;

      var t = (type || "").toUpperCase();
      var icon = HERO_CLASS_TYPE_ICON[t];

      if(icon){
        iconEl.src = icon;
        iconEl.style.display = "";
      }else{
        iconEl.style.display = "none";
      }

      textEl.textContent = `${t || "-"}`;
    }

    // =========================
    // 모달 열기/닫기
    // =========================
    function openHeroModal(hero){
      currentHero = hero;

      $("hdrName").textContent = (hero.nameKo || "").toUpperCase();
      $("hdrGen").textContent = `${hero.gen}세대 • ${hero.name || ""}`;
      $("hdrClass").lastElementChild.textContent = `${hero.heroClass || "-"}`;
      $("hdrType").lastElementChild.textContent = `${hero.expeditionType || "-"}`;
      $("sourceText").textContent = hero.source ? `획득처: ${hero.source}` : "";

      var g = hero.headerGradient || ["#0ea5e9","#2563eb"];
      $("modalHeroHeader").style.background = `linear-gradient(135deg, ${g[0]}, ${g[1]})`;

      var imgEl = $("heroImg");
      imgEl.style.display = "";
      $("heroImgFallback").classList.add("hidden");
      imgEl.src = renderPortrait(hero) || renderHeroThumb(hero) || "";

      renderHeroClassType(hero.heroClass);
      renderExpeditionType(hero.expeditionType);
      renderExclusiveSkill(hero, hero.exclusiveSkill);
      renderWeaponSkills(hero, hero.weaponSkills);

      renderSkills("exploreSkills", hero, hero.explorationSkills);
      renderSkills("expeditionSkills", hero, hero.expeditionSkills);
      renderStats();

      $("modalBackdrop").classList.remove("hidden");
      document.body.style.overflow = "hidden";
    }

    function closeHeroModal(){
      $("modalBackdrop").classList.add("hidden");
      document.body.style.overflow = "";
    }

    // =========================
    // 이벤트
    // =========================
    $("closeModal").onclick = closeHeroModal;
    $("modalBackdrop").addEventListener("click", (e)=>{
      if(e.target === $("modalBackdrop")) closeHeroModal();
    });
    window.addEventListener("keydown", (e)=>{
      if(e.key === "Escape" && !$("modalBackdrop").classList.contains("hidden")) closeHeroModal();
    });

    // ✅ 비교 모달 이벤트
    $("closeCompare").onclick = closeCompareModal;
    $("compareBackdrop").addEventListener("click", (e)=>{
      if(e.target === $("compareBackdrop")) closeCompareModal();
    });
    window.addEventListener("keydown", (e)=>{
      if(e.key === "Escape" && !$("compareBackdrop").classList.contains("hidden")) closeCompareModal();
    });
  };
  window.HeroInfoInit();
})();
</script>
