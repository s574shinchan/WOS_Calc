<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Experts</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .muted{color:#6b7280}
    .value{min-width:3rem;text-align:right}
    .pill{padding:.35rem .6rem;border:1px solid #d1d5db;border-radius:.75rem;background:#fff;color:#111827}
    @media (max-width: 900px){
      .toolbar{grid-template-columns: 1fr}
    }
    .inline-label{display:flex;align-items:center;gap:.5rem}
    select.pill{height:32px}
    .err{color:#b45309}
     /* ✅ 다크모드 전용 */
    body.dark-mode {
      background-color: #121212;
      color: #f0f0f0;
    }
    
    .dark-mode .border { border-color: #444 !important; }
    .dark-mode .bg-white { background-color: #2c2c2c !important; color: #f0f0f0 !important; }
    .dark-mode .bg-gray-100 { background-color: #1e1e1e !important; }
  
    .dark-mode .text-gray-800,
    .dark-mode .text-gray-700,
    .dark-mode .text-gray-600 { color: #dddddd !important; }
  
    .dark-mode .text-blue-700 { color: #66b0ff !important; }
    .dark-mode .text-blue-600 { color: #80caff !important; }
    .dark-mode .text-orange-500 { color: #ffa94d !important; }
    .dark-mode .text-green-600 { color: #79e68c !important; }
    .dark-mode .text-red-500 { color: #ff8080 !important; }
    .dark-mode .text-gray-500 { color: #aaa !important; }    
    
    .dark-mode .text-gray-800, 
    .dark-mode .text-gray-600 { color: #e0e0e0 !important; }
    
    .dark-mode table { background-color: #2c2c2c; color: #f0f0f0; }
    .dark-mode th, .dark-mode td { border-color: #444 !important; }
    .dark-mode thead th { color: #000 !important; }
    
    .dark-mode .bg-amber-100,    
    .dark-mode .bg-green-100,
    .dark-mode .bg-indigo-100 { background-color: #3a3a3a !important; color: #f0f0f0 !important; }
    
    .dark-mode .bg-white { background-color: #2c2c2c !important; color: #f0f0f0 !important; }
    .dark-mode .bg-gray-100 { background-color: #1e1e1e !important; }
    
    .dark-mode .bg-amber-50,
    .dark-mode .bg-indigo-50 { background-color: #2d2d2d !important; }

    .dark-mode .bg-blue-100,
    .dark-mode .bg-blue-50,
    .dark-mode .bg-orange-50,
    .dark-mode .bg-red-50 { background-color: #2e2e2e !important; }
    
    .dark-mode summary { background-color: #333 !important; color: #fff !important; }
    .dark-mode ul li { color: #ddd; }
    
    .dark-mode select option { color: #000 !important; }
    .dark-mode select { color: #000 !important; }
    .dark-mode input { color: #000 !important; }
  </style>
  <!-- ✅ 다크모드 상태 유지 스크립트 -->
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
      }
    });
  </script>
</head>
<body class="bg-gray-100 p-3 font-sans text-sm">
  <main class="max-w-[1500] mx-auto bg-white p-2 rounded-xl shadow-md">
    <header class="flex items-center justify-between">
      <div class ="p-4">
        <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight text-gray-800">Expert</h1>
        <p class="text-sm muted mt-1">Choose a level to calculate the total <b>experience points</b> and <b>books of marks and learning</b> you need.</p>
      </div>
    </header>

    <section class="mb-4 rounded-xl border border-black/10 bg-white px-4 py-3 shadow-lg">
      <div class="toolbar text-gray-800"
           style="display:grid;grid-template-columns:180px 1fr auto;gap:16px;align-items:center;">
        <div class="space-y-1">
          <div class="font-semibold">Expert Choice</div>
          <select id="selType" class="pill w-full">
            <option value="Cyrille">Cyrille</option>
            <option value="Agnes">Agnes</option>
            <option value="Holger">Holger</option>
            <option value="Romulus">Romulus</option>
          </select>
        </div>

        <div class="space-y-1">
          <div class="font-semibold">Level Range<span id="expertCap" class="muted"></span></div>
          <div class="flex flex-wrap items-center gap-6">
            <label class="inline-label"><span class="muted">Current</span>
              <select id="expertCur" class="pill w-28"></select></label>
            <label class="inline-label"><span class="muted">Target</span>
              <select id="expertTgt" class="pill w-28"></select></label>
          </div>
          <p id="expertWarn" class="text-xs err mt-1"></p>
        </div>

        <div class="text-right">
          <button id="btnReset" class="px-3 py-1.5 rounded-xl text-sm border border-slate-300 hover:border-slate-400 bg-white hover:bg-slate-50">Reset</button>
        </div>
      </div>

      <!-- 전문가 카드(section) 내부 어딘가, 계산 영역 아래에 추가 -->
      <div class="exp-divider border-t mt-4"></div>
      <div class="pt-3 text-sm">
        <div class="font-semibold mb-1">Expert Effect (Target-Based)</div>
        <div id="expertEffect" class="muted">-</div>
      </div>
    </section>

    <section class="grid md:grid-cols-2 gap-4 mb-4">
      <div class="mb-4 rounded-xl border border-black/10 bg-white px-4 py-3 shadow-lg">
        <h3 class="text-base font-bold mb-3 skill-title muted" data-index="0">Skill 1</h3>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <div class="text-sm font-semibold mb-1">Level Range<span id="s1Cap" class="muted"></span></div>
            <div class="flex items-center gap-4">
              <label class="inline-label"><span class="muted">Current</span><select id="s1Cur" class="pill w-20"></select></label>
              <label class="inline-label"><span class="muted">Target</span><select id="s1Tgt" class="pill w-20"></select></label>
            </div>
            <p id="s1Warn" class="text-xs err mt-1"></p>
          </div>
          <div>
            <div class="text-sm font-semibold mb-1">Sub Total</div>
            <div class="space-y-1 text-sm">
              <div class="flex justify-between"><span class="muted">Skill Exp</span><span id="s1Exp">0</span></div>
              <div class="flex justify-between"><span class="muted">Book of Knowledge</span><span id="s1Item">0</span></div>
            </div>
          </div>
        </div>
           <div class="exp-divider border-t mt-4"></div>
            <div class="pt-3">
              <div class="font-semibold mb-1">Expert Effect (Target-Based)</div>
              <div class="skill-effect muted" data-index="0">-</div>
            </div>
      </div>

      <div class="mb-4 rounded-xl border border-black/10 bg-white px-4 py-3 shadow-lg">
        <h3 class="text-base font-bold mb-3 skill-title muted" data-index="1">Skill 2</h3>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <div class="text-sm font-semibold mb-1">Level Range <span id="s2Cap" class="muted"></span></div>
            <div class="flex items-center gap-4">
              <label class="inline-label"><span class="muted">Current</span><select id="s2Cur" class="pill w-20"></select></label>
              <label class="inline-label"><span class="muted">Target</span><select id="s2Tgt" class="pill w-20"></select></label>
            </div>
            <p id="s2Warn" class="text-xs err mt-1"></p>
          </div>
          <div>
            <div class="text-sm font-semibold mb-1">Sub Total</div>
            <div class="space-y-1 text-sm">
              <div class="flex justify-between"><span class="muted">Skill Exp</span><span id="s2Exp">0</span></div>
              <div class="flex justify-between"><span class="muted">Book of Knowledge</span><span id="s2Item">0</span></div>
            </div>
          </div>
        </div>
           <div class="exp-divider border-t mt-4"></div>
            <div class="pt-3">
              <div class="font-semibold mb-1">Expert Effect (Target-Based)</div>
              <div class="skill-effect muted" data-index="1">-</div>
            </div>
      </div>

      <div class="mb-4 rounded-xl border border-black/10 bg-white px-4 py-3 shadow-lg">
        <h3 class="text-base font-bold mb-3 skill-title muted" data-index="2">Skill 3</h3>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <div class="text-sm font-semibold mb-1">Level Range <span id="s3Cap" class="muted"></span></div>
            <div class="flex items-center gap-4">
              <label class="inline-label"><span class="muted">Current</span><select id="s3Cur" class="pill w-20"></select></label>
              <label class="inline-label"><span class="muted">Target</span><select id="s3Tgt" class="pill w-20"></select></label>
            </div>
            <p id="s3Warn" class="text-xs err mt-1"></p>
          </div>
          <div>
            <div class="text-sm font-semibold mb-1">Sub Total</div>
            <div class="space-y-1 text-sm">
              <div class="flex justify-between"><span class="muted">Skill Exp</span><span id="s3Exp">0</span></div>
              <div class="flex justify-between"><span class="muted">Book of Knowledge</span><span id="s3Item">0</span></div>
            </div>
          </div>
        </div>
           <div class="exp-divider border-t mt-4"></div>
            <div class="pt-3">
              <div class="font-semibold mb-1">Expert Effect (Target-Based)</div>
              <div class="skill-effect muted" data-index="2">-</div>
            </div>
      </div>

      <div class="mb-4 rounded-xl border border-black/10 bg-white px-4 py-3 shadow-lg">
        <h3 class="text-base font-bold mb-3 skill-title muted" data-index="3">Skill 4</h3>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <div class="text-sm font-semibold mb-1">Level Range <span id="s4Cap" class="muted"></span></div>
            <div class="flex items-center gap-4">
              <label class="inline-label"><span class="muted">Current</span><select id="s4Cur" class="pill w-20"></select></label>
              <label class="inline-label"><span class="muted">Target</span><select id="s4Tgt" class="pill w-20"></select></label>
            </div>
            <p id="s4Warn" class="text-xs err mt-1"></p>
          </div>
          <div>
            <div class="text-sm font-semibold mb-1">Sub Total</div>
            <div class="space-y-1 text-sm">
              <div class="flex justify-between"><span class="muted">Skill Exp</span><span id="s4Exp">0</span></div>
              <div class="flex justify-between"><span class="muted">Book of Knowledge</span><span id="s4Item">0</span></div>
            </div>
          </div>
        </div>
           <div class="exp-divider border-t mt-4"></div>
            <div class="pt-3">
              <div class="font-semibold mb-1">Expert Effect (Target-Based)</div>
              <div class="skill-effect muted" data-index="3">-</div>
            </div>
      </div>
    </section>

    <div class="mb-4 rounded-xl border border-black/10 bg-white px-4 py-3 shadow-lg">
      <h2 class="text-base font-bold mb-3">Total</h2>
      <div class="grid sm:grid-cols-2 gap-4 text-sm">
        <div>
          <div class="font-semibold mb-1">Expert</div>
          <div class="flex justify-between"><span class="muted">Exp</span><span id="sumExpertExp">0</span></div>
          <div class="flex justify-between"><span class="muted">Sigil</span><span id="sumExpertMark">0</span></div>
        </div>
        <div>
          <div class="font-semibold mb-1">Skill Total</div>
          <div class="flex justify-between"><span class="muted">Skill Exp</span><span id="sumSkillExp">0</span></div>
          <div class="flex justify-between"><span class="muted">Book of Knowledge</span><span id="sumSkillItem">0</span></div>
        </div>
      </div>
    </div>
  </main>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const SETTINGS = {
      "Cyrille": {
        base: { csv: "https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Expertise/Cyrille.csv" },
        skills: [
          { csv:"https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Expertise/Cyrille_S1.csv" },
          { csv:"https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Expertise/Cyrille_S2.csv" },
          { csv:"https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Expertise/Cyrille_S3.csv" },
          { csv:"https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Expertise/Cyrille_S4.csv" },
        ]
      },
      "Agnes": {
        base: { csv: "https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Expertise/Agnes.csv" },
        skills: [
          { csv:"https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Expertise/Agnes_S1.csv" },
          { csv:"https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Expertise/Agnes_S2.csv" },
          { csv:"https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Expertise/Agnes_S3.csv" },
          { csv:"https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Expertise/Agnes_S4.csv" },
        ]
      },
      "Holger": {
        base: { csv: "https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Expertise/Holger.csv" },
        skills: [
          { csv:"https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Expertise/Holger_S1.csv" },
          { csv:"https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Expertise/Holger_S2.csv" },
          { csv:"https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Expertise/Holger_S3.csv" },
          { csv:"https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Expertise/Holger_S4.csv" },
        ]
      },
      "Romulus": {
        base: { csv: "https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Expertise/Romulus.csv" },
        skills: [
          { csv:"https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Expertise/Romulus_S1.csv" },
          { csv:"https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Expertise/Romulus_S2.csv" },
          { csv:"https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Expertise/Romulus_S3.csv" },
          { csv:"https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Expertise/Romulus_S4.csv" },
        ]
      },
    };

    // ===== STATE =====
    let expertLevels = [], expertExp = [], expertMark = [];
    const skillLevels = [[],[],[],[]];
    const skillExp  = [[],[],[],[]];
    const skillItem = [[],[],[],[]];

    // ===== DOM =====
    const $ = (id)=>document.getElementById(id);
    const selType = $("selType");
    const expertCur = $("expertCur");
    const expertTgt = $("expertTgt");
    const expertWarn = document.getElementById("expertWarn"); // 없을 수 있음
    const expertCap  = $("expertCap");
    const sumExpertExp  = $("sumExpertExp");
    const sumExpertMark = $("sumExpertMark");
    const btnReset = $("btnReset");
    const expertEffect =$("expertEffect");

    const sRef = [1,2,3,4].map(i=>({
      cur:$(`s${i}Cur`), tgt:$(`s${i}Tgt`),
      warn:$(`s${i}Warn`), cap:$(`s${i}Cap`),
      outE:$(`s${i}Exp`), outI:$(`s${i}Item`)
    }));

    const sumSkillExp = $("sumSkillExp");
    const sumSkillItem = $("sumSkillItem");

    // ===== UTIL =====
    const fmt = n => Number(n||0).toLocaleString("ko-KR");
    const isFilled = v => v !== "" && v !== null && v !== undefined && !Number.isNaN(+v);

    function detectDelim(sample){
      if (sample.includes("\t")) return "\t";
      if (sample.includes(";"))  return ";";
      return ",";
    }

    // 한 줄 CSV를 'Lv.N' 앞에서 강제 줄바꿈 (본체/Skill 공통)
    function preprocessByLevel(text){
      let s = text.replace(/\uFEFF/g,"").replace(/\r/g,"");
      if (!s.includes("\n") && /Lv\.\s*\d+/i.test(s)) {
        s = s.replace(/(Lv\.\s*\d+)/gi, "\n$1");
      }
      return s;
    }

    // 본체 CSV 파서 (정수 레벨, 누적/구간 자동)
    function parseExpertCSV(text){
      const pre = preprocessByLevel(text);
      const lines = pre.split("\n").filter(l=>l.trim()!=="");
      if (!lines.length) return { levels:[], expSteps:[], markSteps:[] };

      const delim = detectDelim(lines[0]);
      const hasHeader = /(레벨|lv|level|경험치|exp)/i.test(lines[0]);
      const start = hasHeader ? 1 : 0;

      const EXP = new Map(), MARK = new Map();
      const rawLevels = [];
      const toInt = s => { const m = String(s||"").match(/\d+/); return m ? parseInt(m[0], 10) : NaN; };
      const toNum = s => { const m = String(s||"").match(/-?\d+(\.\d+)?/); return m ? Number(m[0]) : 0; };

      for (let i=start;i<lines.length;i++){
        const c  = lines[i].split(delim);
        const lv = toInt(c[0]);
        if (!Number.isFinite(lv)) continue;
        rawLevels.push(lv);
        const ex = toNum(c[1]);
        const mk = toNum(c[2]);
        EXP.set(lv, ex);
        MARK.set(lv, mk);
      }

      const levels = [...new Set(rawLevels)].sort((a,b)=>a-b);
      if (levels.length < 2) return { levels, expSteps:[], markSteps:[] };

      const isCum = (map)=>{
        let prev=null, nondec=0, pos=0;
        for (const lv of levels){
          const v = map.get(lv) ?? 0;
          if (prev!==null){ if (v>=prev) nondec++; if (v>prev) pos++; }
          prev = v;
        }
        return nondec >= (levels.length-1) && pos>0;
      };
      const cumExp  = isCum(EXP);
      const cumMark = isCum(MARK);

      const expSteps=[], markSteps=[];
      for (let i=0;i<levels.length-1;i++){
        const a=levels[i], b=levels[i+1];
        if (cumExp) {
          expSteps[i] = Math.max(0, (EXP.get(b)||0) - (EXP.get(a)||0));
        } else {
          // 비누적 CSV: '해당(Target) 레벨 비용'을 사용 (1→2 = Lv2의 값)
          expSteps[i] = Math.max(0, (EXP.get(b)||0));
        }
        if (cumMark) {
          markSteps[i] = Math.max(0, (MARK.get(b)||0) - (MARK.get(a)||0));
        } else {
          markSteps[i] = Math.max(0, (MARK.get(b)||0));
        }
      }
      return { levels, expSteps, markSteps };
    }

    // Skill CSV (2열/3열 자동)
    function parseSkillCSV(text){
      const pre = preprocessByLevel(text);
      const rows = pre.split("\n").filter(l=>l.trim()!=="");
      if (!rows.length) return { levels:[], expSteps:[], itemSteps:[] };
      const delim = detectDelim(rows[0]);
      const headerLooks = /(레벨|lv|level|exp|item|아이템|Book of Knowledge|경험치)/i.test(rows[0]);
      const start = headerLooks ? 1 : 0;

      const exp=[], item=[], levelsFromFile=[];
      const toInt = s => { const m = String(s||"").match(/\d+/); return m ? parseInt(m[0],10) : NaN; };
      const toNum = s => { const m = String(s||"").match(/-?\d+(\.\d+)?/); return m ? Number(m[0]) : 0; };

      for (let i=start;i<rows.length;i++){
        const c = rows[i].split(delim);
        if (c.length >= 3){                 // Level,Exp,Item
          const lv = toInt(c[0]); if (Number.isFinite(lv)) levelsFromFile.push(lv);
          exp.push(toNum(c[1])); item.push(toNum(c[2]));
        }else{                              // Exp,Item
          exp.push(toNum(c[0])); item.push(toNum(c[1]));
        }
      }
      const L = Math.max(1, exp.length);
      let levels;
      if (levelsFromFile.length){
        const uniq = [...new Set(levelsFromFile)].sort((a,b)=>a-b);
        levels = uniq.length >= (L+1) ? uniq.slice(0, L+1) : Array.from({length:L+1}, (_,i)=>i);
      }else{
        levels = Array.from({length:L+1}, (_,i)=>i); // 0..L
      }
      return { levels, expSteps:exp, itemSteps:item };
    }

    // 옵션 렌더링 (Lv.포맷 지원)
    function renderOptions(selectEl, levels, useDot=false){
      const label = lv => useDot ? `Lv.${lv}` : `Lv${lv}`;
      const opts = ['<option value=""></option>']
        .concat(levels.map(lv => `<option value="${lv}">${label(lv)}</option>`))
        .join("");
      selectEl.innerHTML = opts;
    }

    function renderTargetOptions(selectEl, levels, greaterThan, useDot=false){
      const label = lv => useDot ? `Lv.${lv}` : `Lv${lv}`;
      const filtered = levels.filter(lv => lv > greaterThan);
      const opts = ['<option value=""></option>']
        .concat(filtered.map(lv => `<option value="${lv}">${label(lv)}</option>`))
        .join("");
      selectEl.innerHTML = opts;
    }

    // CORS 친화 fetch + 디버깅
    async function fetchText(url){
      try{
        const r = await fetch(url, { cache:"no-store", mode:"cors", redirect:"follow", referrerPolicy:"no-referrer" });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        return await r.text();
      }catch(err){
        console.error("네트워크/CORS 에러:", url, err);
        throw err;
      }
    }

    async function loadDataFor(type){
      const conf = SETTINGS[type];
      // 본체
      if (conf.base?.csv){
        try{
          const txt = await fetchText(conf.base.csv);
          const { levels, expSteps, markSteps } = parseExpertCSV(txt);
          expertLevels = levels;
          expertExp    = expSteps;
          expertMark   = markSteps;
          renderOptions(expertCur, levels, true);  // Current: 전체
          renderTargetOptions(expertTgt, [], 0, true); // Target: 비워두기
          if (expertWarn) expertWarn.textContent = "";
        }catch(e){
          if (expertWarn) expertWarn.textContent = "데이터를 불러오지 못했습니다. 경로/CORS 확인";
          expertLevels = []; expertExp=[]; expertMark=[];
          renderOptions(expertCur, [], true);
          renderOptions(expertTgt, [], true);
        }
      }
      // Skill 1~4
      for (let i=0;i<4;i++){
        const s = conf.skills?.[i];
        const ref = sRef[i];
        if (!ref) continue;
        if (s && s.csv){
          try{
            const txt = await fetchText(s.csv);
            const { levels, expSteps, itemSteps } = parseSkillCSV(txt);
            skillLevels[i] = levels;
            skillExp[i]    = expSteps;
            skillItem[i]   = itemSteps;
            ref.cap.textContent = levels.length ? `(Max Lv.${levels[levels.length-1]})` : "";
            renderOptions(ref.cur, levels, true);           // Current: 전체
            renderTargetOptions(ref.tgt, [], 0, true);      // Target: 비워두기
            ref.warn.textContent = "";
          }catch(e){
            console.warn("[CSV] Skill Load Error", i+1, e);
            skillLevels[i]=[]; skillExp[i]=[]; skillItem[i]=[];
            ref.cap.textContent = "";
            renderOptions(ref.cur, [], true);
            renderOptions(ref.tgt, [], true);
            ref.warn.textContent = "Skill Load Error";
          }
        }else{
          skillLevels[i]=[]; skillExp[i]=[]; skillItem[i]=[];
          ref.cap.textContent = "";
          renderOptions(ref.cur, [], true);
          renderOptions(ref.tgt, [], true);
          ref.warn.textContent = "";
        }
        ref.outE.textContent = "0";
        ref.outI.textContent = "0";
      }
      // 총합 초기화
      if (sumExpertExp)  sumExpertExp.textContent  = "0";
      if (sumExpertMark) sumExpertMark.textContent = "0";
      sumSkillExp.textContent  = "0";
      sumSkillItem.textContent = "0";

      buildFullExpertEffects(type, expertLevels);
      updateExpertEffect();

      sendHeightToParent();
    }

    function sumRangeSteps(steps, fromLv, toLv){
      let s=0; for (let lv=fromLv; lv<toLv; lv++) s += steps[lv]||0; return s;
    }

    function calc(){
      // 본체
      let eExp=0, eMark=0;
      const curLv = +expertCur.value, tgtLv = +expertTgt.value;
      if (isFilled(curLv) && isFilled(tgtLv) && expertLevels.length>1){
        const fi = expertLevels.indexOf(curLv), ti = expertLevels.indexOf(tgtLv);
        if (expertWarn) {
          expertWarn.textContent = (ti<=fi) ? "" : "";
        }
        if (fi>=0 && ti>fi){
          for (let i=fi; i<ti; i++){ eExp += (expertExp[i]||0); eMark += (expertMark[i]||0); }
        }
      } else {
        if (expertWarn) expertWarn.textContent = "";
      }
      if (sumExpertExp)  sumExpertExp.textContent  = fmt(eExp);
      if (sumExpertMark) sumExpertMark.textContent = fmt(eMark);

      // Skill
      let tExp=0, tItem=0;
      sRef.forEach((ref,i)=>{
        let sE=0, sI=0;
        const cV = ref.cur.value, tV = ref.tgt.value;
        if (isFilled(cV) && isFilled(tV) && skillLevels[i].length>1){
          const c=+cV, t=+tV;
          ref.warn.textContent = (t<=c) ? "The target level must be greater than the current level." : "";
          if (t>c){ sE = sumRangeSteps(skillExp[i], c, t); sI = sumRangeSteps(skillItem[i], c, t); }
        } else {
          ref.warn.textContent = "";
        }
        ref.outE.textContent = fmt(sE);
        ref.outI.textContent = fmt(sI);
        tExp += sE; tItem += sI;
      });
      sumSkillExp.textContent  = fmt(tExp);
      sumSkillItem.textContent = fmt(tItem);
    }

    function clearAll(){
      expertCur.value = "";
      expertTgt.innerHTML = '<option value=""></option>';
      if (expertWarn) expertWarn.textContent = "";
      if (sumExpertExp)  sumExpertExp.textContent  = "0";
      if (sumExpertMark) sumExpertMark.textContent = "0";
      sRef.forEach(ref=>{
        ref.cur.value="";
        ref.tgt.innerHTML = '<option value=""></option>';
        ref.warn.textContent=""; 
        ref.outE.textContent="0"; 
        ref.outI.textContent="0";
      });
      sumSkillExp.textContent  = "0";
      sumSkillItem.textContent = "0";
      
      document.querySelectorAll(".skill-effect").forEach(el => { el.textContent = "-"; });
      expertEffect.textContent = "-";
    }

    // ====== 자동 Target = Current+1 ======
    expertCur.addEventListener("change", () => {
      const cur = +expertCur.value;
      if (!isFilled(cur)) { expertTgt.innerHTML = '<option value=""></option>'; return; }
      renderTargetOptions(expertTgt, expertLevels, cur, true);
      // 첫 유효 옵션(=cur+1)이 있으면 자동 선택
      if (expertTgt.options.length > 1) expertTgt.selectedIndex = 1;
      calc();
      updateExpertEffect();
    });

    sRef.forEach((ref, i) => {
      ref.cur.addEventListener("change", () => {
        const cur = +ref.cur.value;
        if (!isFilled(cur)) { ref.tgt.innerHTML = '<option value=""></option>'; ref.warn.textContent=""; calc(); return; }
        renderTargetOptions(ref.tgt, skillLevels[i], cur, true);
        if (ref.tgt.options.length > 1) ref.tgt.selectedIndex = 1;
        ref.warn.textContent = "";
        calc();
      });
    });

    expertTgt.addEventListener("change", () => {
      calc();
      updateExpertEffect();
    });

    // 변동에 따른 계산
    [expertTgt].forEach(el=>{ el.addEventListener("change", calc); });
    sRef.forEach(ref=>{
      ref.tgt.addEventListener("change", calc);
    });

    selType.addEventListener("change", async ()=>{ 
      await loadDataFor(selType.value); 
      clearAll();
      buildFullExpertEffects(selType.value, expertLevels);
      updateSkillTitles();
      updateSkillEffects();
      updateExpertEffect();
    });
    btnReset.addEventListener("click", clearAll);
    
    (async function init(){ await loadDataFor(selType.value); })();
  });
  </script>
<script>
// ───────── 본체(전문가) 레벨별 효과: 오버라이드 표 ─────────
// EXPERT_EFFECTS_OVERRIDE[전문가키][레벨] = "문구"
const EXPERT_EFFECTS_OVERRIDE = {
  Cyrille: {
    1:  "Increasing Bear Hunt Damage Points by 2% (effective for self only)",
    10: "Increasing Bear Hunt Damage Points by 4% (effective for self only)",
    20: "Increasing Bear Hunt Damage Points by 6% (effective for self only)",
    30: "Increasing Bear Hunt Damage Points by 9% (effective for self only)",
    40: "Increasing Bear Hunt Damage Points by 12% (effective for self only)",
    50: "Increasing Bear Hunt Damage Points by 15% (effective for self only)",
    60: "Increasing Bear Hunt Damage Points by 18% (effective for self only)",
    70: "Increasing Bear Hunt Damage Points by 21% (effective for self only)",
    80: "Increasing Bear Hunt Damage Points by 24% (effective for self only)",
    90: "Increasing Bear Hunt Damage Points by 27% (effective for self only)",
    100: "Increasing Bear Hunt Damage Points by 30% (effective for self only)",
  },
  Agnes: {
    1: "Gives 1 Seeker Chest(s) every 120 gathering minutes (up to 10 chest(s) daily)",
    10: "Gives 1 Seeker Chest(s) every 120 gathering minutes (up to 12 chest(s) daily)",
    20: "Gives 1 Seeker Chest(s) every 120 gathering minutes (up to 14 chest(s) daily)",
    30: "Gives 2 Seeker Chest(s) every 120 gathering minutes (up to 16 chest(s) daily)",
    40: "Gives 2 Seeker Chest(s) every 120 gathering minutes (up to 18 chest(s) daily)",
    50: "Gives 3 Seeker Chest(s) every 120 gathering minutes (up to 20 chest(s) daily)",
    60: "Gives 3 Seeker Chest(s) every 120 gathering minutes (up to 22 chest(s) daily)",
    70: "Gives 4 Seeker Chest(s) every 120 gathering minutes (up to 24 chest(s) daily)",
    80: "Gives 4 Seeker Chest(s) every 120 gathering minutes (up to 26 chest(s) daily)",
    90: "Gives 5 Seeker Chest(s) every 120 gathering minutes (up to 28 chest(s) daily)",
    100: "Gives 5 Seeker Chest(s) every 120 gathering minutes (up to 30 chest(s) daily)",
  },
  Holger:  { 
    1: "After a battle in the arena, there is a 50% chance to obtain 1 treasure chest.",
    10: "After a battle in the arena, there is a 55% chance to obtain 1 treasure chest.",
    20: "After a battle in the arena, there is a 60% chance to obtain 1 treasure chest.",
    30: "After a battle in the arena, there is a 65% chance to obtain 1 treasure chest.",
    40: "After a battle in the arena, there is a 70% chance to obtain 1 treasure chest.",
    50: "After a battle in the arena, there is a 75% chance to obtain 2 treasure chest.",
    60: "After a battle in the arena, there is a 80% chance to obtain 2 treasure chest.",
    70: "After a battle in the arena, there is a 85% chance to obtain 2 treasure chest.",
    80: "After a battle in the arena, there is a 90% chance to obtain 2 treasure chest.
    90: "After a battle in the arena, there is a 95% chance to obtain 2 treasure chest.",
    100: "After a battle in the arena, there is a 100% chance to obtain 3 treasure chest.",
  },
  Romulus: { 
    1: "Increasing heroes' Expedition Army size limit by 300.",
    10: "Increasing heroes' Expedition Army size limit by 600.",
    20: "Increasing heroes' Expedition Army size limit by 1,000.",
    30: "Increasing heroes' Expedition Army size limit by 1,500.",
    40: "Increasing heroes' Expedition Army size limit by 2,000.",
    50: "Increasing heroes' Expedition Army size limit by 3,000.",
    60: "Increasing heroes' Expedition Army size limit by 4,000.",
    70: "Increasing heroes' Expedition Army size limit by 5,500.",
    80: "Increasing heroes' Expedition Army size limit by 7,000.",
    90: "Increasing heroes' Expedition Army size limit by 8,500.",
    100: "Increasing heroes' Expedition Army size limit by 10,000.",
  },
};

// 런타임 풀커버리지 보관소
const EXPERT_EFFECTS_FULL = { Cyrille:[], Agnes:[], Holger:[], Romulus:[] };

// Current 로드된 expertLevels를 기준으로 1~최대레벨까지 모두 채움
function buildFullExpertEffects(expert, expertLevels) {
  const maxLv = (expertLevels && expertLevels.length) ? expertLevels[expertLevels.length - 1] : 0;
  const arr = Array.from({length: maxLv + 1}, (_, lv) => {
    if (lv === 0) return ""; // Lv0 없음
    return "-"; // 기본 문구
  });
  // 오버라이드 병합
  const ov = EXPERT_EFFECTS_OVERRIDE[expert] || {};
  Object.keys(ov).forEach(k => {
    const lv = Number(k);
    if (Number.isFinite(lv) && lv >= 1 && lv <= maxLv) arr[lv] = ov[k];
  });
  EXPERT_EFFECTS_FULL[expert] = arr;
}

function getExpertEffect(expert, level) {
  return (EXPERT_EFFECTS_FULL[expert] || [])[level] || "";
}

function updateExpertEffect() {
  const expert = document.getElementById("selType")?.value;
  const tgtSel = document.getElementById("expertTgt");
  const lv = Number(String(tgtSel?.value || "0").replace(/[^0-9]/g, "")) || 0;
  const out = document.getElementById("expertEffect");
  if (!out) return;
  out.textContent = lv ? (getExpertEffect(expert, lv)) : "-";
}
</script>
<script>
// ================= 레벨별 효과 데이터 =================
// 구조: SKILL_EFFECTS[전문가키][Skill인덱스][레벨] = "표시문구"
//  - 전문가키: selType의 <option value="..."> 값과 일치 (Cyrille/Agnes/Holger/Romulus)
//  - Skill인덱스: 0=Skill1, 1=Skill2, 2=Skill3, 3=Skill4
//  - 레벨: 정수 (Target select의 값과 동일)
const SKILL_EFFECTS = {
  Cyrille: [
    // Skill1
    {
      1:"Increasing Bear Hunt Rally Capacity by 30,000.",
      2:"Increasing Bear Hunt Rally Capacity by 60,000.",
      3:"Increasing Bear Hunt Rally Capacity by 90,000.",
      4:"Increasing Bear Hunt Rally Capacity by 120,000.",
      5:"Increasing Bear Hunt Rally Capacity by 150,000.",
      6:"Increasing Bear Hunt Rally Capacity by 180,000.",
      7:"Increasing Bear Hunt Rally Capacity by 210,000.",
      8:"Increasing Bear Hunt Rally Capacity by 240,000.",
      9:"Increasing Bear Hunt Rally Capacity by 270,000.",
      10:"Increasing Bear Hunt Rally Capacity by 300,000.",
    },
    // Skill2
    {
      1:"100 Enhancement XP Component x 1 rewards every Bear Hunt.",
      2:"100 Enhancement XP Component x 2 rewards every Bear Hunt.",
      3:"100 Enhancement XP Component x 3 rewards every Bear Hunt.",
      4:"100 Enhancement XP Component x 4 rewards every Bear Hunt.",
      5:"100 Enhancement XP Component x 5 rewards every Bear Hunt.",
    },
    // Skill3
    {
      1:"Increasing Essence Stone rewards obtained in Bear Hunt by 1.",
      2:"Increasing Essence Stone rewards obtained in Bear Hunt by 2.",
      3:"Increasing Essence Stone rewards obtained in Bear Hunt by 3.",
      4:"Increasing Essence Stone rewards obtained in Bear Hunt by 4.",
      5:"Increasing Essence Stone rewards obtained in Bear Hunt by 5.",
    },
    // Skill4
    {
      1:"Increasing Bear Hunt Troops Deployment Capacity by 3,000.",
      2:"Increasing Bear Hunt Troops Deployment Capacity by 6,000.",
      3:"Increasing Bear Hunt Troops Deployment Capacity by 9,000.",
      4:"Increasing Bear Hunt Troops Deployment Capacity by 12,000.",
      5:"Increasing Bear Hunt Troops Deployment Capacity by 15,000.",
      6:"Increasing Bear Hunt Troops Deployment Capacity by 18,000.",
      7:"Increasing Bear Hunt Troops Deployment Capacity by 1,000.",
      8:"Increasing Bear Hunt Troops Deployment Capacity by 24,000.",
      9:"Increasing Bear Hunt Troops Deployment Capacity by 27,000.",
      10:"Increasing Bear Hunt Troops Deployment Capacity by 30,000.",
    },
  ],
  Agnes: [ 
    // Skill1
    {
      1:"Giving 2 extra Intel missions per day.",
      2:"Giving 3 extra Intel missions per day.",
      3:"Giving 4 extra Intel missions per day.",
      4:"Giving 6 extra Intel missions per day.",
      5:"Giving 8 extra Intel missions per day.",
    },
    // Skill2
    {
      1:"Chief Stamina gain by 10.",
      2:"Chief Stamina gain by 15.",
      3:"Chief Stamina gain by 20.",
      4:"Chief Stamina gain by 30.",
      5:"Chief Stamina gain by 40.",
    },
    // Skill3
    {
      1:"Construction by 2 hours on every new build.",
      2:"Construction by 3 hours on every new build.",
      3:"Construction by 4 hours on every new build.",
      4:"Construction by 6 hours on every new build.",
      5:"Construction by 8 hours on every new build.",
    },
    // Skill4
    {
      1:"Giving 20 additional Mystery Badge(s) upon daily mission completion and 1 more free refreshes at the Mystery Shop.",
      2:"Giving 30 additional Mystery Badge(s) upon daily mission completion and 1 more free refreshes at the Mystery Shop.",
      3:"Giving 40 additional Mystery Badge(s) upon daily mission completion and 1 more free refreshes at the Mystery Shop.",
      4:"Giving 50 additional Mystery Badge(s) upon daily mission completion and 2 more free refreshes at the Mystery Shop.",
      5:"Giving 60 additional Mystery Badge(s) upon daily mission completion and 2 more free refreshes at the Mystery Shop.",
      6:"Giving 70 additional Mystery Badge(s) upon daily mission completion and 3 more free refreshes at the Mystery Shop.",
      7:"Giving 80 additional Mystery Badge(s) upon daily mission completion and 3 more free refreshes at the Mystery Shop.",
      8:"Giving 90 additional Mystery Badge(s) upon daily mission completion and 3 more free refreshes at the Mystery Shop.",
      9:"Giving 100 additional Mystery Badge(s) upon daily mission completion and 3 more free refreshes at the Mystery Shop.",
      10:"Giving 120 additional Mystery Badge(s) upon daily mission completion and 4 more free refreshes at the Mystery Shop.",
    },
  ],  // 전 레벨 채워 넣기
  Holger: [ 
    // Skill1
    {
      1:"Increases Arena heroes' Attack and Health by 2%.",
      2:"Increases Arena heroes' Attack and Health by 4%.",
      3:"Increases Arena heroes' Attack and Health by 6%.",
      4:"Increases Arena heroes' Attack and Health by 8%.",
      5:"Increases Arena heroes' Attack and Health by 10%.",
      6:"Increases Arena heroes' Attack and Health by 12%.",
      7:"Increases Arena heroes' Attack and Health by 14%.",
      8:"Increases Arena heroes' Attack and Health by 16%.",
      9:"Increases Arena heroes' Attack and Health by 18%.",
      10:"Increases Arena heroes' Attack and Health by 20%.",
    },
    // Skill2
    {
      1:"Increase both daily and weekly Arena Tokens earned by 5%.",
      2:"Increase both daily and weekly Arena Tokens earned by 10%.",
      3:"Increase both daily and weekly Arena Tokens earned by 15%.",
      4:"Increase both daily and weekly Arena Tokens earned by 20%.",
      5:"Increase both daily and weekly Arena Tokens earned by 25%.",
      6:"Increase both daily and weekly Arena Tokens earned by 30%.",
      7:"Increase both daily and weekly Arena Tokens earned by 35%.",
      8:"Increase both daily and weekly Arena Tokens earned by 40%.",
      9:"Increase both daily and weekly Arena Tokens earned by 45%.",
      10:"Increase both daily and weekly Arena Tokens earned by 50%.",
    },
    // Skill3
    {
      1:"1 more items in the Arena Shop at an 5% discount.",
      2:"1 more items in the Arena Shop at an 10% discount.",
      3:"1 more items in the Arena Shop at an 15% discount.",
      4:"1 more items in the Arena Shop at an 20% discount.",
      5:"1 more items in the Arena Shop at an 25% discount.",
      6:"2 more items in the Arena Shop at an 30% discount.",
      7:"2 more items in the Arena Shop at an 35% discount.",
      8:"2 more items in the Arena Shop at an 40% discount.",
      9:"2 more items in the Arena Shop at an 45% discount.",
      10:"3 more items in the Arena Shop at an 50% discount.,
    },
    // Skill4
    {
      1:"Giving heroes 2% additional Attack and Health in the Arena.",
      2:"Giving heroes 4% additional Attack and Health in the Arena.",
      3:"Giving heroes 5% additional Attack and Health in the Arena.",
      4:"Giving heroes 8% additional Attack and Health in the Arena.",
      5:"Giving heroes 10% additional Attack and Health in the Arena.",
      6:"Giving heroes 12% additional Attack and Health in the Arena.",
      7:"Giving heroes 14% additional Attack and Health in the Arena.",
      8:"Giving heroes 16% additional Attack and Health in the Arena.",
      9:"Giving heroes 18% additional Attack and Health in the Arena.",
      10:"Giving heroes 20% additional Attack and Health in the Arena.",
    },
  ],
  Romulus: [ 
    // Skill1
    {
      1:"Free troop recruitment: 150 / 1 additional royalty tags.",
      2:"Free troop recruitment: 200 / 2 additional royalty tags.",
      3:"Free troop recruitment: 250 / 3 additional royalty tags.",
      4:"Free troop recruitment: 300 / 4 additional royalty tags.",
      5:"Free troop recruitment: 350 / 5 additional royalty tags.",
      6:"Free troop recruitment: 400 / 6 additional royalty tags.",
      7:"Free troop recruitment: 450 / 7 additional royalty tags.",
      8:"Free troop recruitment: 500 / 8 additional royalty tags.",
      9:"Free troop recruitment: 550 / 9 additional royalty tags.",
      10:"Free troop recruitment: 600 / 10 additional royalty tags.",
    },
    // Skill2
    {
      1:"Troops' Attack and Defense +0.5%.",
      2:"Troops' Attack and Defense +1.0%.",
      3:"Troops' Attack and Defense +1.5%.",
      4:"Troops' Attack and Defense +2.0%.",
      5:"Troops' Attack and Defense +2.5%.",
      6:"Troops' Attack and Defense +3.0%.",
      7:"Troops' Attack and Defense +3.5%.",
      8:"Troops' Attack and Defense +4.0%.",
      9:"Troops' Attack and Defense +4.5%.",
      10:"Troops' Attack and Defense +5.0%.",
      11:"Troops' Attack and Defense +5.5%.",
      12:"Troops' Attack and Defense +6.0%.",
      13:"Troops' Attack and Defense +6.5%.",
      14:"Troops' Attack and Defense +7.0%.",
      15:"Troops' Attack and Defense +7.5%.",
      16:"Troops' Attack and Defense +8.0%.",
      17:"Troops' Attack and Defense +8.5%.",
      18:"Troops' Attack and Defense +9.0%.",
      19:"Troops' Attack and Defense +9.5%.",
      20:"Troops' Attack and Defense +10.0%.",
    },
    // Skill3
    {
      1:"Troops' Lethality and Health +0.5%.",
      2:"Troops' Lethality and Health +1.0%.",
      3:"Troops' Lethality and Health +1.5%.",
      4:"Troops' Lethality and Health +2.0%.",
      5:"Troops' Lethality and Health +2.5%.",
      6:"Troops' Lethality and Health +3.0%.",
      7:"Troops' Lethality and Health +3.5%.",
      8:"Troops' Lethality and Health +4.0%.",
      9:"Troops' Lethality and Health +4.5%.",
      10:"Troops' Lethality and Health +5.0%.",
      11:"Troops' Lethality and Health +5.5%.",
      12:"Troops' Lethality and Health +6.0%.",
      13:"Troops' Lethality and Health +6.5%.",
      14:"Troops' Lethality and Health +7.0%.",
      15:"Troops' Lethality and Health +7.5%.",
      16:"Troops' Lethality and Health +8.0%.",
      17:"Troops' Lethality and Health +8.5%.",
      18:"Troops' Lethality and Health +9.0%.",
      19:"Troops' Lethality and Health +9.5%.",
      20:"Troops' Lethality and Health +10.0%.",
    },
    // Skill4
    {
      1:"Enhancing your Rally Capacity by 5,000.",
      2:"Enhancing your Rally Capacity by 10,000.",
      3:"Enhancing your Rally Capacity by 15,000.",
      4:"Enhancing your Rally Capacity by 20,000.",
      5:"Enhancing your Rally Capacity by 25,000.",
      6:"Enhancing your Rally Capacity by 30,000.",
      7:"Enhancing your Rally Capacity by 35,000.",
      8:"Enhancing your Rally Capacity by 40,000.",
      9:"Enhancing your Rally Capacity by 45,000.",
      10:"Enhancing your Rally Capacity by 50,000.",
      11:"Enhancing your Rally Capacity by 55,000.",
      12:"Enhancing your Rally Capacity by 60,000.",
      13:"Enhancing your Rally Capacity by 65,000.",
      14:"Enhancing your Rally Capacity by 70,000.",
      15:"Enhancing your Rally Capacity by 75,000.",
      16:"Enhancing your Rally Capacity by 80,000.",
      17:"Enhancing your Rally Capacity by 85,000.",
      18:"Enhancing your Rally Capacity by 90,000.",
      19:"Enhancing your Rally Capacity by 95,000.",
      20:"Enhancing your Rally Capacity by 100,000.",
    },
  ],
};

const SKILL_NAMES = {
  Cyrille: ["Entrapment", "Scavenging", "Weapon Master", "Ursa's Bane"],
  Agnes:   ["Efficient Recon", "Optimization", "Project Managemnet", "Convert Knowledge"],
  Holger:  ["Arena Elite", "Crowd Pleaser", "Arena Star", "Legacy"],
  Romulus: ["Call of War", "Last Line", "Spirit of Aeetes", "One Heart"],
};

// ================ 표시 함수 ================
function getEffectText(expert, skillIdx, level) {
  const table = (SKILL_EFFECTS[expert] || [])[skillIdx] || {};
  return table[level] || ""; // 없으면 빈 문자열
}

function updateSkillEffects() {
  const expert = document.getElementById("selType")?.value;
  if (!expert) return;

  // 각 카드의 Target select 값 읽어서 표시
  document.querySelectorAll(".skill-effect").forEach(el => {
    const idx = Number(el.dataset.index || 0); // 0..3
    const tgtSel = document.getElementById(`s${idx+1}Tgt`);
    const lv = Number(String(tgtSel?.value || "0").replace(/[^0-9]/g, "")) || 0;
    el.textContent = lv ? (getEffectText(expert, idx, lv) || `Lv.${lv} 효과 데이터 없음`) : "-";
  });
}

function updateSkillTitles() {
  const expert = document.getElementById("selType")?.value;
  const names = SKILL_NAMES[expert] || [];
  document.querySelectorAll(".skill-title").forEach(el => {
    const idx = Number(el.dataset.index || 0);
    el.textContent = names[idx] || `Skill ${idx+1}`;
  });
}

// ================ 이벤트 연결 ================
document.addEventListener("DOMContentLoaded", () => {
  const selType = document.getElementById("selType");

  // 전문가 변경 시: 제목/효과 동기화
  selType?.addEventListener("change", () => {
    updateSkillTitles();
    updateSkillEffects();    
  });

  // 각 Skill Target 변경 시: 효과 갱신
  [1,2,3,4].forEach(n => {
    document.getElementById(`s${n}Tgt`)?.addEventListener("change", updateSkillEffects);
  });

  // 초기 1회
  updateSkillTitles();
  updateSkillEffects();
  updateExpertEffect();
});
</script>

  <script>
    function sendHeightToParent() {
      const height = document.body.scrollHeight + 10;
      window.parent.postMessage({ type: "FRAME_CHANGE", height }, "*");
    }
    
    // 페이지 최초 로드 시
    window.addEventListener("load", () => {
      setTimeout(sendHeightToParent, 100); // 약간의 렌더링 대기
    });
    
    function loadPage(page) {
      const isMobile = window.innerWidth <= 768;
      const height = isMobile ? "550px" : "345px"
        window.location.href = page;
      window.parent.postMessage({ type: "SET_FRAME_SIZE", height: height, width: "100%"}, "*");
    }
  </script>
</body>
</html>
