<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì˜ì›…ì¥ë¹„[ë§ˆìŠ¤í„°ë¦¬]</title>
  <script>
    (function () {
      try {
        const v = localStorage.getItem('darkMode');
        if (v === 'true') document.documentElement.classList.add('dark-mode');
      } catch (e) {}
    })();
  </script>  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="css/common.css">
  <link rel="stylesheet" href="css/heroes.css">
  <script src="js/common.js"></script> 
</head>
<body>
  <div id="navMount"></div>
    
  <div class="max-w-[1500px] mx-auto bg-white rounded shadow p-2 flex flex-col sm:flex-row gap-2">
    <div class="flex-1 bg-white rounded p-2 space-y-4 shadow">
      <div class="bg-gray-100 p-2 font-sans text-sm">
        <div class="bg-white p-4 rounded-xl shadow-md space-y-4">
          <h1 class="text-2xl font-bold text-gray-800">ğŸ§ ì˜ì›…ì¥ë¹„[ë§ˆìŠ¤í„°ë¦¬]</h1>

          <div class="text-gray-600 text-sm">
            <p>í˜„ì¬ë ˆë²¨ê³¼ ëª©í‘œë ˆë²¨ì„ ì„ íƒí•˜ë©´, ì—…ê·¸ë ˆì´ë“œì— í•„ìš”í•œ ìì›(ë§ˆìŠ¤í„°ë¦¬ì„/ë ˆì „ë“œ ì¥ë¹„)ì„ ê³„ì‚°í•©ë‹ˆë‹¤.</p>
            <p>ê° í•­ëª©ì˜ â€˜í•„ìš” í•©ê³„â€™ëŠ” ë ˆë²¨ ì„ íƒ ì‹œ ìë™ ê°±ì‹ ë©ë‹ˆë‹¤. </p>
            <p>ê° í•­ëª©ë³„ë¡œ ì²´í¬ë¥¼ í•˜ë©´ ì²´í¬í•­ëª©ë³„ í•„ìš”í•©ê³„ë¥¼ ë”í•˜ì—¬ ì´í•©ê³„ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
          </div>

          <!-- ===================== ğŸ“™ ë§ˆìŠ¤í„°ë¦¬ ===================== -->
          <div class="p-4">
            <form id="masteryForm" class="space-y-3">
              <div class="mb-4 flex items-center justify-start gap-2 w-full">
                <label class="text-sm font-medium whitespace-nowrap">ë°œë ˆë¦¬ì•„</label>
                <select id="chkExpertV" class="w-[120px] border rounded-md px-2 py-1.5">
                  <option>None</option>
                  <option>Lv.1</option><option>Lv.2</option><option>Lv.3</option><option>Lv.4</option><option>Lv.5</option>
                  <option>Lv.6</option><option>Lv.7</option><option>Lv.8</option><option>Lv.9</option><option>Lv.10</option>
                </select>
                <!-- âœ… ë ˆë²¨ ì„¤ëª… í‘œì‹œ ì˜ì—­ -->
                <span id="expertDesc" class="svs-score-value text-sm font-semibold hidden px-4"></span>          
              </div>
              <div id="masteryGrid" class="grid grid-cols-1 md:grid-cols-4 gap-2"></div>

              <!-- ğŸ“™ ë§ˆìŠ¤í„°ë¦¬ ì´í•©ê³„ -->
              <div id="masteryTotals">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                  <div class="rounded-xl border border-black/10 p-3">
                    <div class="font-semibold mb-2">í•„ìš” ì´í•©</div>

                    <!-- ì‚¬ì „í˜• 4ì»¬ëŸ¼: ë¼ë²¨/ê°’ | ë¼ë²¨/ê°’ -->
                    <div class="grid items-center text-[12px]
                                gap-x-3 gap-y-1
                                grid-cols-[auto_minmax(0,1fr)_auto_minmax(0,1fr)] w-full">

                      <!-- 1í–‰ -->
                      <div class="text-gray-600">ë§ˆìŠ¤í„°ë¦¬ì„</div>
                      <div id="ms-tot-stone" class="tabular-nums font-medium text-right">0</div>
                      <div class="text-gray-600">ë ˆì „ë“œì¥ë¹„</div>
                      <div id="ms-tot-leg" class="tabular-nums font-medium text-right">0</div>

                      <!-- êµ¬ë¶„ì„ (ì „ì²´ í­) -->
                      <div class="col-span-4 border-t border-gray-200 mt-1"></div>

                      <!-- SVS ì¤„: ì™¼ìª½ 3ì¹¸(ë¼ë²¨ í­) + ë§ˆì§€ë§‰ ì¹¸ ê°’ ìš°ì¸¡ì •ë ¬ -->
                      <div class="svs-score-label pt-1">SVS ì ìˆ˜</div>                            
                      <span id="svs-long"  class="pt-1 svs-score-value text-right tabular-nums font-medium">0</span>                
                      <div></div>
                      <span id="svs-short" class="pt-1 svs-score-value text-right tabular-nums font-medium">0</span>
                    </div>
                  </div>

                  <div class="rounded-xl border border-black/10 p-3">
                    <div class="font-semibold mb-2">ë³´ìœ ëŸ‰</div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                      <div>
                        <label class="block text-[12px] text-gray-600 mb-1">ë§ˆìŠ¤í„°ë¦¬ì„</label>
                        <input type="number" id="owned-ë§ˆìŠ¤í„°ë¦¬ì„" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="0" min="0" inputmode="numeric"/>
                      </div>
                      <div>
                        <label class="block text-[12px] text-gray-600 mb-1">ë ˆì „ë“œì¥ë¹„</label>
                        <input type="number" id="owned-ë ˆì „ë“œì¥ë¹„" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="0" min="0" inputmode="numeric"/>
                      </div>
                    </div>
                  </div>
                  <div class="rounded-xl border border-black/10 p-3">
                    <div class="font-semibold mb-2">ê³¼ë¶€ì¡±</div>
                    <div class="flex justify-between text-[12px]">
                      <span class="text-gray-600">ë§ˆìŠ¤í„°ë¦¬ì„</span>
                      <span id="ms-def-stone" class="tabular-nums">0</span>
                    </div>
                    <div class="flex justify-between text-[12px]">
                      <span class="text-gray-600">ë ˆì „ë“œì¥ë¹„</span>
                      <span id="ms-def-leg" class="tabular-nums">0</span>
                    </div>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="footerMount"></div>
	
  <script>
    fetch("nav.html")
      .then(r => r.text())
      .then(html => {
        document.getElementById("navMount").innerHTML = html;
        //initNav({ mode: "iframe" });    // âœ… iframe ê³„ì† ì“¸ê±°ë©´
        initNav({ mode: "navigate" }); // âœ… í˜ì´ì§€ ì´ë™ìœ¼ë¡œ ê°ˆê±°ë©´
      });
    
    // 2) FOOTER
    fetch("footer.html").then(r=>r.text()).then(html=>{
      document.getElementById("footerMount").innerHTML = html;
      initFooter({ mode:"navigate" }); // ë˜ëŠ” "iframe"
      initAdsense({ ids:["ad1"] });    // ìŠ¬ë¡¯ idë“¤
    });
  </script>   
  <!-- ========== ê³µí†µ ìœ í‹¸ & í”„ë ˆì„ í†µì‹  ========== -->
  <script>
    function sendHeightToParent() {
      const height = document.body.scrollHeight + 10;
      window.parent?.postMessage?.({ type: "FRAME_CHANGE", height }, "*");
    }
    window.addEventListener("load", () => setTimeout(sendHeightToParent, 100));
  </script>

  <!-- ========== ğŸ“™ ë§ˆìŠ¤í„°ë¦¬ ë¡œì§ ========== -->
  <script>
    const masteryUrl = "https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Hero/Mastery.csv";
    const masterySlots = ["ê³ ê¸€", "ì¥ê°‘", "ë²¨íŠ¸", "ì‹ ë°œ"];
    let masteryLevels = [];
    let masteryData = [];
    
    // âœ… ë°œë ˆë¦¬ì•„(SVS ì ìˆ˜ ë³´ë„ˆìŠ¤)
    const EXPERT_BONUS = {
      "None":0,
      "Lv.1":0.02,"Lv.2":0.04,"Lv.3":0.06,"Lv.4":0.08,"Lv.5":0.10,
      "Lv.6":0.12,"Lv.7":0.14,"Lv.8":0.16,"Lv.9":0.18,"Lv.10":0.20
    };
    const EXPERT_DESC = {
      "Lv.1":"+2%",
      "Lv.2":"+4%",
      "Lv.3":"+6%",
      "Lv.4":"+8%",
      "Lv.5":"+10%",
      "Lv.6":"+12%",
      "Lv.7":"+14%",
      "Lv.8":"+16%",
      "Lv.9":"+18%",
      "Lv.10":"+20%"
    };

    function getValeriaBonus(){
      const sel = document.getElementById("chkExpertV");
      if (!sel) return 0;
      const key = (sel.value || sel.options[sel.selectedIndex]?.text || "None").trim();
      return EXPERT_BONUS[key] ?? 0;
    }

    const expertSel  = document.getElementById('chkExpertV');
    const expertDesc = document.getElementById('expertDesc');                   

    function getValeriaDesc(){
      const lv = expertSel?.value ?? "None";
      const bonusText = EXPERT_DESC[lv] ? ` ${EXPERT_DESC[lv]}` : "";

      // ìƒë‹¨ ì„¤ëª… ë°°ì§€
      if (EXPERT_DESC[lv]) {
        expertDesc.textContent = `SVS ì ìˆ˜ ${EXPERT_DESC[lv]}`;
        expertDesc.classList.remove('hidden');
      } else {
        expertDesc.textContent = "";
        expertDesc.classList.add('hidden');
      }
    }

    // âœ… SVS ì ìˆ˜ ì „ìš© í¬ë§· (M/B, ì†Œìˆ˜ 2ìë¦¬)
    function formatSVS(value){
      const num = Number(value);
      if (!Number.isFinite(num)) return "0";
      if (num >= 1000000000) return (num / 1000000000).toFixed(2).replace(/\.00$/, '') + "B";
      if (num >= 1000000) return (num / 1000000).toFixed(2).replace(/\.00$/, '') + "M";
      return num.toLocaleString();
    }

    async function loadMasteryCSV() {
      try{
        const res = await fetch(masteryUrl, {cache:"no-store"});
        const text = await res.text();
        const lines = text.trim().split("\n").map(row => row.split(","));
        const headers = lines[0];
        masteryData = lines.slice(1).map(row => {
          const obj = {};
          headers.forEach((h, i) => obj[h.trim()] = (row[i] ?? "").trim() || "0");
          return obj;
        });
        masteryLevels = masteryData.map(r => r["ë ˆë²¨"]);
      }catch(e){
        // ê°„ë‹¨í•œ í´ë°± (ë ˆë²¨ 1~5)
        masteryData = [
          {ë ˆë²¨:"1", ë§ˆìŠ¤í„°ë¦¬ì„:"0", ë ˆì „ë“œì¥ë¹„:"0"},
          {ë ˆë²¨:"2", ë§ˆìŠ¤í„°ë¦¬ì„:"10", ë ˆì „ë“œì¥ë¹„:"0"},
          {ë ˆë²¨:"3", ë§ˆìŠ¤í„°ë¦¬ì„:"22", ë ˆì „ë“œì¥ë¹„:"0"},
          {ë ˆë²¨:"4", ë§ˆìŠ¤í„°ë¦¬ì„:"36", ë ˆì „ë“œì¥ë¹„:"1"},
          {ë ˆë²¨:"5", ë§ˆìŠ¤í„°ë¦¬ì„:"52", ë ˆì „ë“œì¥ë¹„:"1"},
        ];
        masteryLevels = masteryData.map(r=>r["ë ˆë²¨"]);
      }
      renderMasteryUI();
      sendHeightToParent();
    }

    function renderMasteryUI() {
      const grid = document.getElementById("masteryGrid");
      grid.innerHTML = "";

      masterySlots.forEach((name, i) => {
        const options = masteryLevels.map(lv => `<option value="${lv}">${lv}</option>`).join("");
        const card = document.createElement("div");
        card.className = "exp-card";
        card.innerHTML = `
          <div class="p-4 space-y-4">
            <div class="flex items-center gap-2 mb-2">
              <h3 class="text-[15px] font-semibold text-gray-800">${name}</h3>
            </div>
            <div class="grid grid-cols-2 gap-3 max-w-[360px]">
              <div>
                <div class="text-[12px] text-gray-600 mb-1">í˜„ì¬</div>
                <select id="m-start-${i}" 
                        class="w-full border rounded-lg px-2 py-1 text-sm bg-white">${options}</select>
              </div>
              <div>
                <div class="text-[12px] text-gray-600 mb-1">ëª©í‘œ</div>
                <select id="m-end-${i}"
                        class="w-full border rounded-lg px-2 py-1 text-sm bg-white">${options}</select>
              </div>
            </div>
            <div>
              <div class="rounded-xl border border-black/10 p-3">
                <div class="font-semibold text-gray-800 dark:text-gray-100 mb-2">í•„ìš” í•©ê³„</div>
                  <div class="grid items-center text-[12px] gap-x-3 gap-y-1 grid-cols-[auto_minmax(0,1fr)_auto_minmax(0,1fr)]">

                  <!-- 1í–‰ -->
                  <div class="text-gray-600">ë§ˆìŠ¤í„°ë¦¬ì„</div>
                  <div class="text-right tabular-nums" id="ms-sub-stone-${i}">0</div>

                  <!-- 2í–‰ -->
                  <div class="text-gray-600">ë ˆì „ë“œì¥ë¹„</div>
                  <div class="text-right tabular-nums" id="ms-sub-legend-${i}">0</div>
                  
                  <!-- êµ¬ë¶„ì„  -->
                  <div class="col-span-4 border-t border-gray-200 mt-1"></div>

                  <!-- SVS ì ìˆ˜: ì™¼ìª½ì€ 3ì¹¸(ë¼ë²¨ í­), ê°’ì€ ë§ˆì§€ë§‰ ì¹¸ì— ìš°ì¸¡ì •ë ¬ -->
                  <div class="svs-score-label pt-1">SVS ì ìˆ˜</div>
                  <div id="sub-ì ìˆ˜A-${masterySlots[i]}" class="svs-score-value text-right tabular-nums font-medium pt-1">0</div>
                  <div></div>
                  <div id="sub-ì ìˆ˜-${masterySlots[i]}" class="svs-score-value text-right tabular-nums font-medium pt-1">0</div>
                </div>
              </div>
            </div>
          </div>`;
        grid.appendChild(card);

        const curSelect = card.querySelector(`#m-start-${i}`);
        const tgtSelect = card.querySelector(`#m-end-${i}`);

        const onChange = () => { updateMasterySubtotals(i); updateMasteryTotals(); };
        curSelect.addEventListener("change", () => { tgtSelect.value = curSelect.value; onChange(); });
        tgtSelect.addEventListener("change", onChange);

        updateMasterySubtotals(i);
      });
          
      document.getElementById("chkExpertV")?.addEventListener("change", () => {
        masterySlots.forEach((_, i) => updateMasterySubtotals(i)); // ê° ì¹´ë“œ SVS ê°±ì‹ 
        getValeriaDesc(); 
        updateMasteryTotals();                                   // ì´í•© íŒ¨ë„ ê°±ì‹ 
      });
      ["owned-ë§ˆìŠ¤í„°ë¦¬ì„","owned-ë ˆì „ë“œì¥ë¹„"].forEach(id=>{
        document.getElementById(id)?.addEventListener("input", updateMasteryTotals);
      });

      updateMasteryTotals();
    }

    function updateMasterySubtotals(i) {
      const cur = document.getElementById(`m-start-${i}`).value;
      const tgt = document.getElementById(`m-end-${i}`).value;
      const sIdx = masteryLevels.indexOf(cur);
      const eIdx = masteryLevels.indexOf(tgt);

      const sums = { stone:0, legend:0 };
      if (sIdx >= 0 && eIdx > sIdx) {
        for (let j = sIdx + 1; j <= eIdx; j++) {
          const r = masteryData[j];
          sums.stone  += parseFloat(r["ë§ˆìŠ¤í„°ë¦¬ì„"] || "0");
          sums.legend += parseFloat(r["ë ˆì „ë“œì¥ë¹„"] || "0");
        }
      }
      document.getElementById(`ms-sub-stone-${i}`).textContent  = sums.stone.toLocaleString();
      document.getElementById(`ms-sub-legend-${i}`).textContent = sums.legend.toLocaleString();

      // âœ… ì´ ìŠ¬ë¡¯ë§Œì˜ SVS ê³„ì‚°/í‘œì‹œ
      const valeriaBonus = getValeriaBonus();
      // ê°€ì¤‘ì¹˜ëŠ” ë„¤ê°€ ì“°ëŠ” ê·œì¹™ìœ¼ë¡œ ë§ì¶°ì¤˜ (ì˜ˆì‹œëŠ” ë¯¸ìŠ¤ë¦´*4000 + ë ˆì „ë“œ*144000)
      const baseSlot = sums.stone * 4000;
      const svsSlot  = Math.round(baseSlot * (1 + valeriaBonus));

      const id  = `sub-ì ìˆ˜-${masterySlots[i]}`;
      const idA = `sub-ì ìˆ˜A-${masterySlots[i]}`; // ìˆìœ¼ë©´ ê°™ì´ í‘œê¸°
      const el  = document.getElementById(id);
      const elA = document.getElementById(idA);
      if (el)  el.textContent  = formatSVS(svsSlot);
      if (elA) elA.textContent = svsSlot.toLocaleString();
    }

    function updateMasteryTotals(){
      let total = { stone:0, leg:0 };
      masterySlots.forEach((_, i)=>{
        const cur = document.getElementById(`m-start-${i}`).value;
        const tgt = document.getElementById(`m-end-${i}`).value;
        const sIdx = masteryLevels.indexOf(cur);
        const eIdx = masteryLevels.indexOf(tgt);
        if (sIdx < 0 || eIdx <= sIdx) return;

        for(let j=sIdx+1;j<=eIdx;j++){
          const r = masteryData[j];
          total.stone += +(r["ë§ˆìŠ¤í„°ë¦¬ì„"]||0);
          total.leg   += +(r["ë ˆì „ë“œì¥ë¹„"]||0);
        }
      });

      const own = {
        stone: +(document.getElementById("owned-ë§ˆìŠ¤í„°ë¦¬ì„")?.value || 0),
        leg:   +(document.getElementById("owned-ë ˆì „ë“œì¥ë¹„")?.value || 0),
      };

      document.getElementById("ms-tot-stone").textContent = total.stone.toLocaleString();
      document.getElementById("ms-tot-leg").textContent   = total.leg.toLocaleString();
      
			document.getElementById("owned-ë§ˆìŠ¤í„°ë¦¬ì„").textContent = own.stone.toLocaleString();
      document.getElementById("owned-ë ˆì „ë“œì¥ë¹„").textContent   = own.leg.toLocaleString();
						
			document.getElementById("ms-def-stone").textContent = (own.stone-total.stone).toLocaleString();
      document.getElementById("ms-def-leg").textContent   = (own.leg-total.leg).toLocaleString();
      
      ["ms-def-stone","ms-def-leg"].forEach(id=>{
        const el = document.getElementById(id);
        const n  = parseFloat(el.textContent.replace(/,/g,''));
        el.classList.toggle("text-red-600", n < 0);
      });

      // âœ… ì´í•© íŒ¨ë„ SVS (ì´í•© ê¸°ì¤€ìœ¼ë¡œ í•œ ë²ˆë§Œ)
      const valeriaBonus = getValeriaBonus();
      const baseTotal = total.stone * 4000; // ê·œì¹™ì— ë§ê²Œ
      const svsTotal  = Math.round(baseTotal * (1 + valeriaBonus));

      // ì´í•© íŒ¨ë„ ì•ˆì˜ svs-score-valueë§Œ ì—…ë°ì´íŠ¸ (ì¹´ë“œì˜ ê²ƒì€ ê±´ë“¤ì§€ ì•ŠìŒ)
      document.getElementById("svs-long").textContent  = svsTotal.toLocaleString();
      document.getElementById("svs-short").textContent = formatSVS(svsTotal);
    }

    // ìµœì´ˆ ë¡œë”©
    loadMasteryCSV();
  </script>

  <!-- ========== (ì„ íƒ) í‚¤ ì°¨ë‹¨: ì› ì½”ë“œ ìœ ì§€ ìŠµê´€ ========== -->
  <script>
    document.addEventListener("contextmenu", e => e.preventDefault());
    document.addEventListener("keydown", function (e) {
      if (e.key === "F12" || (e.ctrlKey && e.shiftKey && (e.key === "I" || e.key === "J")) ||
          (e.ctrlKey && (e.key === "U" || e.key === "S"))) {
        e.preventDefault();
      }
    });
  </script>
  <script>
    window.addEventListener('message', (e) => {
      if (e.data?.type === 'DARK_MODE') {
        document.body.classList.toggle('dark-mode', e.data.value);
      }
    });
  </script>
</body>
</html>